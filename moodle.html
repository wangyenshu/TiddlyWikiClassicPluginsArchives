<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script type="text/javascript">
//<![CDATA[
var version = {major: 2, minor: 1, revision: 2, date: new Date("Oct 5, 2006"), extensions: {}};
//]]>
</script>
<!--
TiddlyWiki 2.1.2 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Osmosoft Limited 2004-2006

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>
<!--}}}-->
<!--PRE-HEAD-END-->
<title> Moodle Wiki - Tiddlywiki Integration - A Ludo's DFWikiteam Site </title>
<script type="text/javascript">
//<![CDATA[
// ---------------------------------------------------------------------------------
// Configuration repository
// ---------------------------------------------------------------------------------

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animFast: 0.12, // Speed for animations (lower == slower)
	animSlow: 0.01, // Speed for EasterEgg animations
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	displayStartupTime: false // Whether to display startup time
	};

// Messages
config.messages = {
	messageClose: {},
	dates: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	txtBackupFolder: "",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30"
	};
	
// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
	];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
	};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
	wikified: {
		tag: {}
		},
	editor: {
		tagChooser: {}
		}
	};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {}
		},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	newTiddler: {},
	newJournal: {},
	sparkline: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {},
	edit: {},
	tagChooser: {},
	toolbar: {},
	br: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {}
	};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {},
	jump: {}
	};

// Browser detection... In a very few places, there's nothing else for it but to
// know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /Gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
	};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
	};
if(config.browser.isBadSafari)
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]"
		}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
												config.textPrimitives.lowerLetter + "+" +
												config.textPrimitives.upperLetter +
												config.textPrimitives.anyLetter + "*)|(?:" +
												config.textPrimitives.upperLetter + "{2,}" +
												config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" + 
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

// ---------------------------------------------------------------------------------
// Shadow tiddlers
// ---------------------------------------------------------------------------------

config.shadowTiddlers = {
	ColorPalette: "Background: #fff\n" + 
				  "Foreground: #000\n" +
				  "PrimaryPale: #8cf\n" +
				  "PrimaryLight: #18f\n" +
				  "PrimaryMid: #04b\n" +
				  "PrimaryDark: #014\n" +
				  "SecondaryPale: #ffc\n" +
				  "SecondaryLight: #fe8\n" +
				  "SecondaryMid: #db4\n" +
				  "SecondaryDark: #841\n" +
				  "TertiaryPale: #eee\n" +
				  "TertiaryLight: #ccc\n" +
				  "TertiaryMid: #999\n" +
				  "TertiaryDark: #666\n" +
				  "Error: #f88\n",
	StyleSheet: "",
	StyleSheetColors: "/*{{{*/\nbody {\n	background: [[ColorPalette::Background]];\n	color: [[ColorPalette::Foreground]];\n}\n\na{\n	color: [[ColorPalette::PrimaryMid]];\n}\n\na:hover{\n	background: [[ColorPalette::PrimaryMid]];\n	color: [[ColorPalette::Background]];\n}\n\na img{\n	border: 0;\n}\n\nh1,h2,h3,h4,h5 {\n	color: [[ColorPalette::SecondaryDark]];\n	background: [[ColorPalette::PrimaryPale]];\n}\n\n.button {\n	color: [[ColorPalette::PrimaryDark]];\n	border: 1px solid [[ColorPalette::Background]];\n}\n\n.button:hover {\n	color: [[ColorPalette::PrimaryDark]];\n	background: [[ColorPalette::SecondaryLight]];\n	border-color: [[ColorPalette::SecondaryMid]];\n}\n\n.button:active {\n	color: [[ColorPalette::Background]];\n	background: [[ColorPalette::SecondaryMid]];\n	border: 1px solid [[ColorPalette::SecondaryDark]];\n}\n\n.header {\n	background: [[ColorPalette::PrimaryMid]];\n}\n\n.headerShadow {\n	color: [[ColorPalette::Foreground]];\n}\n\n.headerShadow a {\n	font-weight: normal;\n	color: [[ColorPalette::Foreground]];\n}\n\n.headerForeground {\n	color: [[ColorPalette::Background]];\n}\n\n.headerForeground a {\n	font-weight: normal;\n	color: [[ColorPalette::PrimaryPale]];\n}\n\n.tabSelected{\n	color: [[ColorPalette::PrimaryDark]];\n	background: [[ColorPalette::TertiaryPale]];\n	border-left: 1px solid [[ColorPalette::TertiaryLight]];\n	border-top: 1px solid [[ColorPalette::TertiaryLight]];\n	border-right: 1px solid [[ColorPalette::TertiaryLight]];\n}\n\n.tabUnselected {\n	color: [[ColorPalette::Background]];\n	background: [[ColorPalette::TertiaryMid]];\n}\n\n.tabContents {\n	color: [[ColorPalette::PrimaryDark]];\n	background: [[ColorPalette::TertiaryPale]];\n	border: 1px solid [[ColorPalette::TertiaryLight]];\n}\n\n.tabContents .button {\n	 border: 0;}\n\n#sidebar {\n}\n\n#sidebarOptions input {\n	border: 1px solid [[ColorPalette::PrimaryMid]];\n}\n\n#sidebarOptions .sliderPanel {\n	background: [[ColorPalette::PrimaryPale]];\n}\n\n#sidebarOptions .sliderPanel a {\n	border: none;\n	color: [[ColorPalette::PrimaryMid]];\n}\n\n#sidebarOptions .sliderPanel a:hover {\n	color: [[ColorPalette::Background]];\n	background: [[ColorPalette::PrimaryMid]];\n}\n\n#sidebarOptions .sliderPanel a:active {\n	color: [[ColorPalette::PrimaryMid]];\n	background: [[ColorPalette::Background]];\n}\n\n.wizard {\n	background: [[ColorPalette::SecondaryLight]];\n	border-top: 1px solid [[ColorPalette::SecondaryMid]];\n	border-left: 1px solid [[ColorPalette::SecondaryMid]];\n}\n\n.wizard h1 {\n	color: [[ColorPalette::SecondaryDark]];\n}\n\n.wizard h2 {\n	color: [[ColorPalette::Foreground]];\n}\n\n.wizardStep {\n	background: [[ColorPalette::Background]];\n	border-top: 1px solid [[ColorPalette::SecondaryMid]];\n	border-bottom: 1px solid [[ColorPalette::SecondaryMid]];\n	border-left: 1px solid [[ColorPalette::SecondaryMid]];\n}\n\n.wizard .button {\n	color: [[ColorPalette::Background]];\n	background: [[ColorPalette::PrimaryMid]];\n	border-top: 1px solid [[ColorPalette::PrimaryLight]];\n	border-right: 1px solid [[ColorPalette::PrimaryDark]];\n	border-bottom: 1px solid [[ColorPalette::PrimaryDark]];\n	border-left: 1px solid [[ColorPalette::PrimaryLight]];\n}\n\n.wizard .button:hover {\n	color: [[ColorPalette::PrimaryLight]];\n	background: [[ColorPalette::PrimaryDark]];\n	border-color: [[ColorPalette::PrimaryLight]];\n}\n\n.wizard .button:active {\n	color: [[ColorPalette::Background]];\n	background: [[ColorPalette::PrimaryMid]];\n	border-top: 1px solid [[ColorPalette::PrimaryLight]];\n	border-right: 1px solid [[ColorPalette::PrimaryDark]];\n	border-bottom: 1px solid [[ColorPalette::PrimaryDark]];\n	border-left: 1px solid [[ColorPalette::PrimaryLight]];\n}\n\n#messageArea {\n	border: 1px solid [[ColorPalette::SecondaryDark]];\n	background: [[ColorPalette::SecondaryMid]];\n	color: [[ColorPalette::PrimaryDark]];\n}\n\n#messageArea .button {\n	padding: 0.2em 0.2em 0.2em 0.2em;\n	color: [[ColorPalette::PrimaryDark]];\n	background: [[ColorPalette::Background]];\n}\n\n.popup {\n	background: [[ColorPalette::PrimaryLight]];\n	border: 1px solid [[ColorPalette::PrimaryMid]];\n}\n\n.popup hr {\n	color: [[ColorPalette::PrimaryDark]];\n	background: [[ColorPalette::PrimaryDark]];\n	border-bottom: 1px;\n}\n\n.listBreak div{\n	border-bottom: 1px solid [[ColorPalette::PrimaryDark]];\n}\n\n.popup li.disabled {\n	color: [[ColorPalette::PrimaryMid]];\n}\n\n.popup li a, .popup li a:visited {\n	color: [[ColorPalette::TertiaryPale]];\n	border: none;\n}\n\n.popup li a:hover {\n	background: [[ColorPalette::PrimaryDark]];\n	color: [[ColorPalette::Background]];\n	border: none;\n}\n\n.tiddler .defaultCommand {\n font-weight: bold;\n}\n\n.shadow .title {\n	color: [[ColorPalette::TertiaryDark]];\n}\n\n.title {\n	color: [[ColorPalette::SecondaryDark]];\n}\n\n.subtitle {\n	color: [[ColorPalette::TertiaryDark]];\n}\n\n.toolbar {\n	color: [[ColorPalette::PrimaryMid]];\n}\n\n.tagging, .tagged {\n	border: 1px solid [[ColorPalette::TertiaryPale]];\n	background-color: [[ColorPalette::TertiaryPale]];\n}\n\n.selected .tagging, .selected .tagged {\n	background-color: [[ColorPalette::TertiaryLight]];\n	border: 1px solid [[ColorPalette::TertiaryMid]];\n}\n\n.tagging .listTitle, .tagged .listTitle {\n	color: [[ColorPalette::PrimaryDark]];\n}\n\n.tagging .button, .tagged .button {\n		border: none;\n}\n\n.footer {\n	color: [[ColorPalette::TertiaryLight]];\n}\n\n.selected .footer {\n	color: [[ColorPalette::TertiaryMid]];\n}\n\n.sparkline {\n	background: [[ColorPalette::PrimaryPale]];\n	border: 0;\n}\n\n.sparktick {\n	background: [[ColorPalette::PrimaryDark]];\n}\n\n.error, .errorButton {\n	color: [[ColorPalette::Foreground]];\n	background: [[ColorPalette::Error]];\n}\n\n.warning {\n	color: [[ColorPalette::Foreground]];\n	background: [[ColorPalette::SecondaryPale]];\n}\n\n.cascade {\n	background: [[ColorPalette::TertiaryPale]];\n	color: [[ColorPalette::TertiaryMid]];\n	border: 1px solid [[ColorPalette::TertiaryMid]];\n}\n\n.imageLink, #displayArea .imageLink {\n	background: transparent;\n}\n\n.viewer .listTitle {list-style-type: none; margin-left: -2em;}\n\n.viewer .button {\n	border: 1px solid [[ColorPalette::SecondaryMid]];\n}\n\n.viewer blockquote {\n	border-left: 3px solid [[ColorPalette::TertiaryDark]];\n}\n\n.viewer table {\n	border: 2px solid [[ColorPalette::TertiaryDark]];\n}\n\n.viewer th, thead td {\n	background: [[ColorPalette::SecondaryMid]];\n	border: 1px solid [[ColorPalette::TertiaryDark]];\n	color: [[ColorPalette::Background]];\n}\n\n.viewer td, .viewer tr {\n	border: 1px solid [[ColorPalette::TertiaryDark]];\n}\n\n.viewer pre {\n	border: 1px solid [[ColorPalette::SecondaryLight]];\n	background: [[ColorPalette::SecondaryPale]];\n}\n\n.viewer code {\n	color: [[ColorPalette::SecondaryDark]];\n}\n\n.viewer hr {\n	border: 0;\n	border-top: dashed 1px [[ColorPalette::TertiaryDark]];\n	color: [[ColorPalette::TertiaryDark]];\n}\n\n.highlight, .marked {\n	background: [[ColorPalette::SecondaryLight]];\n}\n\n.editor input {\n	border: 1px solid [[ColorPalette::PrimaryMid]];\n}\n\n.editor textarea {\n	border: 1px solid [[ColorPalette::PrimaryMid]];\n	width: 100%;\n}\n\n.editorFooter {\n	color: [[ColorPalette::TertiaryMid]];\n}\n\n/*}}}*/",
	StyleSheetLayout: "/*{{{*/\n* html .tiddler {\n    height: 1%;\n}\n\nbody {\n	font-size: .75em;\n	font-family: arial,helvetica;\n	margin: 0;\n	padding: 0;\n}\n\nh1,h2,h3,h4,h5 {\n	font-weight: bold;\n	text-decoration: none;\n	padding-left: 0.4em;\n}\n\nh1 {font-size: 1.35em;}\nh2 {font-size: 1.25em;}\nh3 {font-size: 1.1em;}\nh4 {font-size: 1em;}\nh5 {font-size: .9em;}\n\nhr {\n	height: 1px;\n}\n\na{\n	text-decoration: none;\n}\n\ndt {font-weight: bold;}\n\nol { list-style-type: decimal }\nol ol { list-style-type: lower-alpha }\nol ol ol { list-style-type: lower-roman }\nol ol ol ol { list-style-type: decimal }\nol ol ol ol ol { list-style-type: lower-alpha }\nol ol ol ol ol ol { list-style-type: lower-roman }\nol ol ol ol ol ol ol { list-style-type: decimal }\n\n.txtOptionInput {\n	width: 11em;\n}\n\n#contentWrapper .chkOptionInput {\n	border: 0;\n}\n\n.externalLink {\n	text-decoration: underline;\n}\n\n.indent {margin-left:3em;}\n.outdent {margin-left:3em; text-indent:-3em;}\ncode.escaped {white-space:nowrap;}\n\n.tiddlyLinkExisting {\n	font-weight: bold;\n}\n\n.tiddlyLinkNonExisting {\n	font-style: italic;\n}\n\n/* the 'a' is required for IE, otherwise it renders the whole tiddler a bold */\na.tiddlyLinkNonExisting.shadow {\n	font-weight: bold;\n}\n\n#mainMenu .tiddlyLinkExisting, \n#mainMenu .tiddlyLinkNonExisting,\n#sidebarTabs .tiddlyLinkNonExisting{\n font-weight: normal;\n font-style: normal;\n}\n\n#sidebarTabs .tiddlyLinkExisting {\n font-weight: bold;\n font-style: normal;\n}\n\n.header {\n		position: relative;\n}\n\n.header a:hover {\n	background: transparent;\n}\n\n.headerShadow {\n	position: relative;\n	padding: 4.5em 0em 1em 1em;\n	left: -1px;\n	top: -1px;\n}\n\n.headerForeground {\n	position: absolute;\n	padding: 4.5em 0em 1em 1em;\n	left: 0px;\n	top: 0px;\n}\n\n.siteTitle {\n	font-size: 3em;\n}\n\n.siteSubtitle {\n	font-size: 1.2em;\n}\n\n#mainMenu {\n	position: absolute;\n	left: 0;\n	width: 10em;\n	text-align: right;\n	line-height: 1.6em;\n	padding: 1.5em 0.5em 0.5em 0.5em;\n	font-size: 1.1em;\n}\n\n#sidebar {\n	position: absolute;\n	right: 3px;\n	width: 16em;\n	font-size: .9em;\n}\n\n#sidebarOptions {\n	padding-top: 0.3em;\n}\n\n#sidebarOptions a {\n	margin: 0em 0.2em;\n	padding: 0.2em 0.3em;\n	display: block;\n}\n\n#sidebarOptions input {\n	margin: 0.4em 0.5em;\n}\n\n#sidebarOptions .sliderPanel {\n	margin-left: 1em;\n	padding: 0.5em;\n	font-size: .85em;\n}\n\n#sidebarOptions .sliderPanel a {\n	font-weight: bold;\n	display: inline;\n	padding: 0;\n}\n\n#sidebarOptions .sliderPanel input {\n	margin: 0 0 .3em 0;\n}\n\n#sidebarTabs .tabContents {\n	width: 15em;\n	overflow: hidden;\n}\n\n.wizard {\n	padding: 0.1em 0em 0em 2em;\n}\n\n.wizard h1 {\n	font-size: 2em;\n	font-weight: bold;\n	background: none;\n	padding: 0em 0em 0em 0em;\n	margin: 0.4em 0em 0.2em 0em;\n}\n\n.wizard h2 {\n	font-size: 1.2em;\n	font-weight: bold;\n	background: none;\n	padding: 0em 0em 0em 0em;\n	margin: 0.2em 0em 0.2em 0em;\n}\n\n.wizardStep {\n	padding: 1em 1em 1em 1em;\n}\n\n.wizard .button {\n	margin: 0.5em 0em 0em 0em;\n	font-size: 1.2em;\n}\n\n#messageArea {\nposition:absolute; top:0; right:0; margin: 0.5em; padding: 0.5em;\n}\n\n*[id='messageArea'] {\nposition:fixed !important; z-index:99;}\n\n.messageToolbar {\ndisplay: block;\ntext-align: right;\n}\n\n#messageArea a{\n	text-decoration: underline;\n}\n\n.popup {\n	font-size: .9em;\n	padding: 0.2em;\n	list-style: none;\n	margin: 0;\n}\n\n.popup hr {\n	display: block;\n	height: 1px;\n	width: auto;\n	padding: 0;\n	margin: 0.2em 0em;\n}\n\n.listBreak {\n	font-size: 1px;\n	line-height: 1px;\n}\n\n.listBreak div {\n	margin: 2px 0;\n}\n\n.popup li.disabled {\n	padding: 0.2em;\n}\n\n.popup li a{\n	display: block;\n	padding: 0.2em;\n}\n\n.tabset {\n	padding: 1em 0em 0em 0.5em;\n}\n\n.tab {\n	margin: 0em 0em 0em 0.25em;\n	padding: 2px;\n}\n\n.tabContents {\n	padding: 0.5em;\n}\n\n.tabContents ul, .tabContents ol {\n	margin: 0;\n	padding: 0;\n}\n\n.txtMainTab .tabContents li {\n	list-style: none;\n}\n\n.tabContents li.listLink {\n	 margin-left: .75em;\n}\n\n#displayArea {\n	margin: 1em 17em 0em 14em;\n}\n\n\n.toolbar {\n	text-align: right;\n	font-size: .9em;\n	visibility: hidden;\n}\n\n.selected .toolbar {\n	visibility: visible;\n}\n\n.tiddler {\n	padding: 1em 1em 0em 1em;\n}\n\n.missing .viewer,.missing .title {\n	font-style: italic;\n}\n\n.title {\n	font-size: 1.6em;\n	font-weight: bold;\n}\n\n.missing .subtitle {\n display: none;\n}\n\n.subtitle {\n	font-size: 1.1em;\n}\n\n.tiddler .button {\n	padding: 0.2em 0.4em;\n}\n\n.tagging {\nmargin: 0.5em 0.5em 0.5em 0;\nfloat: left;\ndisplay: none;\n}\n\n.isTag .tagging {\ndisplay: block;\n}\n\n.tagged {\nmargin: 0.5em;\nfloat: right;\n}\n\n.tagging, .tagged {\nfont-size: 0.9em;\npadding: 0.25em;\n}\n\n.tagging ul, .tagged ul {\nlist-style: none;margin: 0.25em;\npadding: 0;\n}\n\n.tagClear {\nclear: both;\n}\n\n.footer {\n	font-size: .9em;\n}\n\n.footer li {\ndisplay: inline;\n}\n\n* html .viewer pre {\n	width: 99%;\n	padding: 0 0 1em 0;\n}\n\n.viewer {\n	line-height: 1.4em;\n	padding-top: 0.5em;\n}\n\n.viewer .button {\n	margin: 0em 0.25em;\n	padding: 0em 0.25em;\n}\n\n.viewer blockquote {\n	line-height: 1.5em;\n	padding-left: 0.8em;\n	margin-left: 2.5em;\n}\n\n.viewer ul, .viewer ol{\n	margin-left: 0.5em;\n	padding-left: 1.5em;\n}\n\n.viewer table {\n	border-collapse: collapse;\n	margin: 0.8em 1.0em;\n}\n\n.viewer th, .viewer td, .viewer tr,.viewer caption{\n	padding: 3px;\n}\n\n.viewer table.listView {\n	font-size: 0.85em;\n	margin: 0.8em 1.0em;\n}\n\n.viewer table.listView th, .viewer table.listView td, .viewer table.listView tr {\n	padding: 0px 3px 0px 3px;\n}\n\n.viewer pre {\n	padding: 0.5em;\n	margin-left: 0.5em;\n	font-size: 1.2em;\n	line-height: 1.4em;\n	overflow: auto;\n}\n\n.viewer code {\n	font-size: 1.2em;\n	line-height: 1.4em;\n}\n\n.editor {\nfont-size: 1.1em;\n}\n\n.editor input, .editor textarea {\n	display: block;\n	width: 100%;\n	font: inherit;\n}\n\n.editorFooter {\n	padding: 0.25em 0em;\n	font-size: .9em;\n}\n\n.editorFooter .button {\npadding-top: 0px; padding-bottom: 0px;}\n\n.fieldsetFix {border: 0;\npadding: 0;\nmargin: 1px 0px 1px 0px;\n}\n\n.sparkline {\n	line-height: 1em;\n}\n\n.sparktick {\n	outline: 0;\n}\n\n.zoomer {\n	font-size: 1.1em;\n	position: absolute;\n	padding: 1em;\n}\n\n.cascade {\n	font-size: 1.1em;\n	position: absolute;\n	overflow: hidden;\n}\n/*}}}*/",
	StyleSheetPrint: "/*{{{*/\n@media print {\n#mainMenu, #sidebar, #messageArea, .toolbar {display: none ! important;}\n#displayArea {margin: 1em 1em 0em 1em;}\n/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */\nnoscript {display:none;}\n}\n/*}}}*/",
	PageTemplate: "<!--{{{-->\n<div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'>\n<div class='headerShadow'>\n<span class='siteTitle' refresh='content' tiddler='SiteTitle'></span>&nbsp;\n<span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'></span>\n</div>\n<div class='headerForeground'>\n<span class='siteTitle' refresh='content' tiddler='SiteTitle'></span>&nbsp;\n<span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'></span>\n</div>\n</div>\n<div id='mainMenu' refresh='content' tiddler='MainMenu'></div>\n<div id='sidebar'>\n<div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'></div>\n<div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'></div>\n</div>\n<div id='displayArea'>\n<div id='messageArea'></div>\n<div id='tiddlerDisplay'></div>\n</div>\n<!--}}}-->",
	ViewTemplate: "<!--{{{-->\n<div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump'></div>\n<div class='title' macro='view title'></div>\n<div class='subtitle'><span macro='view modifier link'></span>, <span macro='view modified date [[DD MMM YYYY]]'></span> (<span macro='message views.wikified.createdPrompt'></span> <span macro='view created date [[DD MMM YYYY]]'></span>)</div>\n<div class='tagging' macro='tagging'></div>\n<div class='tagged' macro='tags'></div>\n<div class='viewer' macro='view text wikified'></div>\n<div class='tagClear'></div>\n<!--}}}-->",
	EditTemplate: "<!--{{{-->\n<div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'></div>\n<div class='title' macro='view title'></div>\n<div class='editor' macro='edit title'></div>\n<div class='editor' macro='edit text'></div>\n<div class='editor' macro='edit tags'></div><div class='editorFooter'><span macro='message views.editor.tagPrompt'></span><span macro='tagChooser'></span></div>\n<!--}}}-->",
	MarkupPreHead: "<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: ""
	};

// ---------------------------------------------------------------------------------
// Translateable strings
// ---------------------------------------------------------------------------------

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. This could be because your browser doesn't support saving (instead, use FireFox if you can), or because the pathname to your TiddlyWiki file contains illegal characters",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.plugins,{
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these tiddlers:\n\n%0",
	listViewTemplate : {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Title', field: 'title', tiddlerLink: 'title', title: "Title", type: 'TiddlerLink'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			],
		actions: [
			{caption: "More actions...", name: ''},
			{caption: "Remove systemConfig tag", name: 'remove'},
			{caption: "Delete these tiddlers forever", name: 'delete'}
			]}
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	defaultPath: "http://www.tiddlywiki.com/index.html",
	fetchLabel: "fetch",
	fetchPrompt: "Fetch the tiddlywiki file",
	fetchError: "There were problems fetching the tiddlywiki file",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	wizardTitle: "Import tiddlers from another TiddlyWiki file",
	step1: "Step 1: Locate the TiddlyWiki file",
	step1prompt: "Enter the URL or pathname here: ",
	step1promptFile: "...or browse for a file: ",
	step1promptFeeds: "...or select a pre-defined feed: ",
	step1feedPrompt: "Choose...",
	step2: "Step 2: Loading TiddlyWiki file",
	step2Text: "Please wait while the file is loaded from: %0",
	step3: "Step 3: Choose the tiddlers to import",
	step4: "%0 tiddler(s) imported",
	step5: "Done",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Title', field: 'title', title: "Title", type: 'String'},
			{name: 'Snippet', field: 'text', title: "Snippet", type: 'String'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			],
		actions: [
			{caption: "More actions...", name: ''},
			{caption: "Import these tiddlers", name: 'import'}
			]}
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "[[Welcome to your tiddlyspot.com site!]] GettingStarted",
	MainMenu: "GettingStarted",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://moodle.tiddlyspot.com//",
	GettingStarted: "To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:\n* SiteTitle & SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)\n* MainMenu: The menu (usually on the left)\n* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened\nYou'll also need to enter your username for signing your edits: <<option txtUserName>>",
	SideBarOptions: "<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal 'DD MMM YYYY'>><<saveChanges>><<upload http://moodle.tiddlyspot.com/store.cgi index.html . .  moodle>><html><a href='http://moodle.tiddlyspot.com/download' class='button'>download</a></html><<slider chkSliderOptionsPanel OptionsPanel 'options Â»' 'Change TiddlyWiki advanced options'>>",
	OptionsPanel: "tiddlyspot password:\n<<option pasUploadPassword>>\n\nThese InterfaceOptions for customising TiddlyWiki are saved in your browser\n\nYour username for signing your edits. Write it as a WikiWord (eg JoeBloggs)\n\n<<option txtUserName>>\n<<option chkSaveBackups>> SaveBackups\n<<option chkAutoSave>> AutoSave\n<<option chkRegExpSearch>> RegExpSearch\n<<option chkCaseSensitiveSearch>> CaseSensitiveSearch\n<<option chkAnimate>> EnableAnimations\n\n----\nAdvancedOptions\nPluginManager\nImportTiddlers",
	AdvancedOptions: "<<option chkGenerateAnRssFeed>> GenerateAnRssFeed\n<<option chkOpenInNewWindow>> OpenLinksInNewWindow\n<<option chkSaveEmptyTemplate>> SaveEmptyTemplate\n<<option chkToggleLinks>> Clicking on links to tiddlers that are already open causes them to close\n^^(override with Control or other modifier key)^^\n<<option chkHttpReadOnly>> HideEditingFeatures when viewed over HTTP\n<<option chkForceMinorUpdate>> Treat edits as MinorChanges by preserving date and time\n^^(override with Shift key when clicking 'done' or by pressing Ctrl-Shift-Enter^^\n<<option chkConfirmDelete>> ConfirmBeforeDeleting\nMaximum number of lines in a tiddler edit box: <<option txtMaxEditRows>>\nFolder name for backup files: <<option txtBackupFolder>>\n<<option chkInsertTabs>> Use tab key to insert tab characters instead of jumping to next field",
	SideBarTabs: "<<tabs txtMainTab Timeline Timeline TabTimeline All 'All tiddlers' TabAll Tags 'All tags' TabTags More 'More lists' TabMore>>",
	TabTimeline: "<<timeline>>",
	TabAll: "<<list all>>",
	TabTags: "<<allTags>>",
	TabMore: "<<tabs txtMoreTab Missing 'Missing tiddlers' TabMoreMissing Orphans 'Orphaned tiddlers' TabMoreOrphans Shadowed 'Shadowed tiddlers' TabMoreShadowed>>",
	TabMoreMissing: "<<list missing>>",
	TabMoreOrphans: "<<list orphans>>",
	TabMoreShadowed: "<<list shadowed>>",
	PluginManager: "<<plugins>>",
	ImportTiddlers: "<<importTiddlers>>"});

// ---------------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------------

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
config.parsers = {}; // Hashmap of alternative parsers for the wikifier
var anim = new Animator(); // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = config.browser.isSafari || config.browser.isOpera;

// Starting up
function main()
{
	var now, then = new Date();
	startingUp = true;
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	store.loadFromDiv("storeArea","store",true);
	invokeParamifier(params,"onload");
	var pluginProblem = loadPlugins();
	formatter = new Formatter(config.formatters);
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	invokeParamifier(params,"onconfig");
	store.notifyAll();
	restart();
	if(pluginProblem)
		{
		displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
		}
	now = new Date();
	if(config.displayStartupTime)
		displayMessage("TiddlyWiki startup in " + (now-then)/1000 + " seconds");
	startingUp = false;
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty())
		{
		var defaultParams = store.getTiddlerText("DefaultTiddlers").parseParams("open",null,false);
		invokeParamifier(defaultParams,"onstart");
		}
	window.scrollTo(0,0);
}

function saveTest()
{
	var saveTest = document.getElementById("saveTest");
	if(saveTest.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	saveTest.appendChild(document.createTextNode("savetest"));
}

function loadPlugins()
{
	if(safeMode)
		return false;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	installedPlugins = [];
	var hadProblem = false;
	for(var t=0; t<configTiddlers.length; t++)
		{
		tiddler = configTiddlers[t];
		pluginInfo = getPluginInfo(tiddler);
		if(isPluginExecutable(pluginInfo))
			{
			pluginInfo.executed = true;
			pluginInfo.error = false;
			try
				{
				if(tiddler.text && tiddler.text != "")
					window.eval(tiddler.text);
				}
			catch(e)
				{
				pluginInfo.log.push(config.messages.pluginError.format([exceptionText(e)]));
				pluginInfo.error = true;
				hadProblem = true;
				}
			}
		else
			pluginInfo.warning = true;
		installedPlugins.push(pluginInfo);
		}
	return hadProblem;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable"))
		return verifyTail(plugin,false,config.messages.pluginDisabled);
	if(plugin.tiddler.isTagged("systemConfigForce"))
		return verifyTail(plugin,true,config.messages.pluginForced);
	if(plugin["CoreVersion"])
		{
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0]) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1]) - version.minor;
		if(w == 0 && coreVersion[2])
		 	w = parseInt(coreVersion[2]) - version.revision;
		if(w > 0)
			return verifyTail(plugin,false,config.messages.pluginVersionError);
		}
	return true;
}

function verifyTail(plugin,result,message)
{
	plugin.log.push(message);
	return result;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try
		{
		var m = config.macros[macro];
		if(m && m.handler)
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		else
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	catch(ex)
		{
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
		}
}

// ---------------------------------------------------------------------------------
// Paramifiers
// ---------------------------------------------------------------------------------

function getParameters()
{
	var p = null;
	if(window.location.hash)
		{
		p = decodeURI(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
		}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var t=1; t<params.length; t++)
		{
		var p = config.paramifiers[params[t].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[t].value);
		}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
		}
};

config.paramifiers.open = {
	onstart: function(v) {
		story.displayTiddler("bottom",v,null,false,false);
		}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
		}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
		}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
		}
};

config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.getTaggedTiddlers(v,"title");
		for(var t=0; t<tagged.length; t++)
			story.displayTiddler("bottom",tagged[t].title,null,false,false);
		}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly)
			{
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
			}
		}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly)
			{
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
			}
		}
};

// ---------------------------------------------------------------------------------
// Formatter helpers
// ---------------------------------------------------------------------------------

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++)
		{
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
		}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},
	
	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch)
			{
			var s,v;
			if(lookaheadMatch[1])
				{
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
				}
			else
				{
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
				}
			if (s=="bgcolor")
				s = "backgroundColor";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
			}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++)
			{
			try
				{
				e.style[styles[t].style] = styles[t].value;
				}
			catch (ex)
				{
				}
			}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link))
			{
			//# Definitely not an external link
			return false;
			}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link))
			{
			// Definitely an external link
			return true;
			}
		if (link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1)
			{
			//# Link contains . / or \ so is probably an external link
			return true;
			}
		//# Otherwise assume it is not an external link
		return false;
	}

};

// ---------------------------------------------------------------------------------
// Standard formatters
// ---------------------------------------------------------------------------------

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},

	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch)
			{
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k")
				{
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
				}
			else
				{
				if(nextRowType != currRowType)
					{
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
					}
				if(currRowType == "c")
					{
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
					}
				else
					{
					this.rowHandler(w,createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow"),prevColumns);
					rowCount++;
					}
				}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch)
			{
			if(cellMatch[1] == "~")
				{
				// Rowspan
				var last = prevColumns[col];
				if(last)
					{
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
					}
				w.nextMatch = this.cellRegExp.lastIndex-1;
				}
			else if(cellMatch[1] == ">")
				{
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
				}
			else if(cellMatch[2])
				{
				// End of row
				if(prevCell && colSpanCount > 1)
					{
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
					}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
				}
			else
				{
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ")
					{
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
					}
				var cell;
				if(chr == "!")
					{
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
					}
				else
					cell = createTiddlyElement(e,"td");
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1, element:cell};
				if(colSpanCount > 1)
					{
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
					}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
				}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
			}
	}
},

{
	name: "heading",
	match: "^!{1,5}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:(?:(?:\\*)|(?:#)|(?:;)|(?::))+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var placeStack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch)
			{
			if(lookaheadMatch[1])
				{
				listType = "ul";
				itemType = "li";
				}
			else if(lookaheadMatch[2])
				{
				listType = "ol";
				itemType = "li";
				}
			else if(lookaheadMatch[3])
				{
				listType = "dl";
				itemType = "dt";
				}
			else if(lookaheadMatch[4])
				{
				listType = "dl";
				itemType = "dd";
				}
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			if(listLevel > currLevel)
				{
				for(var t=currLevel; t<listLevel; t++)
					placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],listType));
				}
			else if(listLevel < currLevel)
				{
				for(var t=currLevel; t>listLevel; t--)
					placeStack.pop();
				}
			else if(listLevel == currLevel && listType != currType)
				{
				placeStack.pop();
				placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],listType));
				}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(placeStack[placeStack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var placeStack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel)
				{
				for(t=currLevel; t<newLevel; t++)
					placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],this.element));
				}
			else if(newLevel < currLevel)
				{
				for(t=currLevel; t>newLevel; t--)
					placeStack.pop();
				}
			currLevel = newLevel;
			w.subWikifyTerm(placeStack[placeStack.length-1],this.termRegExp);
			createTiddlyElement(placeStack[placeStack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^\\{\\{\\{\\n",
	lookaheadRegExp: /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForCSS",
	match: "^/\\*[\\{]{3}\\*/\\n",
	lookaheadRegExp: /\/\*[\{]{3}\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*[\}]{3}\*\/$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForPlugin",
	match: "^//\\{\\{\\{\\n",
	lookaheadRegExp: /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForTemplate",
	match: "^<!--[\\{]{3}-->\\n",
	lookaheadRegExp: /<!--[\{]{3}-->\n*((?:^[^\n]*\n)+?)(\n*^<!--[\}]{3}-->$\n?)/mg, 
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "wikifyCommentForPlugin", 
	match: "^/\\*\\*\\*\\n",
	termRegExp: /(^\*\*\*\/\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "wikifyCommentForTemplate", 
	match: "^<!---\\n",
	termRegExp: /(^--->\n)/mg,
	handler: function(w) 
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1])
			{
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
			}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[([^\|\]]*?)(?:(\]\])|(\|(.*?)\]\]))/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var e;
			var text = lookaheadMatch[1];
			if (lookaheadMatch[2]) // Simple bracketted link
				{
				e = createTiddlyLink(w.output,text,false,null,w.isStatic);
				}
			else if(lookaheadMatch[3]) // Pretty bracketted link
				{
				var link = lookaheadMatch[4];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic);
				}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
	}
},

{
	name: "unWikiLink",
	match: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		w.outputText(w.output,w.matchStart+1,w.nextMatch);
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchStart > 0)
			{
			var preRegExp = new RegExp(config.textPrimitives.anyLetter,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1)
				{
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
				}
			}
		if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText))
			{
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic);
			w.outputText(link,w.matchStart,w.nextMatch);
			}
		else
			{
			w.outputText(w.output,w.matchStart,w.nextMatch);
			}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[(<?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) // Simple bracketted link
			{
			var e = w.output;
			if(lookaheadMatch[5])
				{
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic);
				addClass(e,"imageLink");
				}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3])
				img.title = lookaheadMatch[3];
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "boldByChar",
	match: "''",
	termRegExp: /('')/mg,
	element: "strong",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "italicByChar",
	match: "//",
	termRegExp: /(\/\/)/mg,
	element: "em",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "underlineByChar",
	match: "__",
	termRegExp: /(__)/mg,
	element: "u",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "strikeByChar",
	match: "--(?!\\s|$)",
	termRegExp: /((?!\s)--|(?=\n\n))/mg,
	element: "strike",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "superscriptByChar",
	match: "\\^\\^",
	termRegExp: /(\^\^)/mg,
	element: "sup",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "subscriptByChar",
	match: "~~",
	termRegExp: /(~~)/mg,
	element: "sub",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "monospacedByChar",
	match: "\\{\\{\\{",
	lookaheadRegExp: /\{\{\{((?:.|\n)*?)\}\}\}/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
	}
},

{
	name: "styleByChar",
	match: "@@",
	termRegExp: /(@@)/mg,
	handler:  function(w)
	{
		var e = createTiddlyElement(w.output,"span");
		var styles = config.formatterHelpers.inlineCssHelper(w);
		if(styles.length == 0)
			e.className = "marked";
		else
			config.formatterHelpers.applyCssHelper(e,styles);
		w.subWikifyTerm(e,this.termRegExp);
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
		{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
		}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
		{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
		}
},

{
	name: "customClasses",
	match: "\\{\\{",
	termRegExp: /(\}\}\})/mg,
	lookaheadRegExp: /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch)
			{
			var e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			w.subWikifyTerm(e,this.termRegExp);
			}
	}
}

];

// ---------------------------------------------------------------------------------
// Wikifier
// ---------------------------------------------------------------------------------

function getParser(tiddler)
{
	var f = formatter;
	if(tiddler!=null)
		{
		for(var i in config.parsers)
			{
			if(tiddler.isTagged(config.parsers[i].formatTag))
				{
				f = config.parsers[i];
				break;
				}
			}
		}
	return f;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "")
		{
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.subWikifyUnterm(output);
		}
}

function wikifyStatic(source,highlightRegExp,tiddler)
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	var html = "";
	if(source && source != "")
		{
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikifyUnterm(e);
		html = e.innerHTML;
		e.parentNode.removeChild(e);
		}
	return html;
}

// Wikify a named tiddler to plain text
function wikifyPlain(title)
{
	if(store.tiddlerExists(title) || store.isShadowTiddler(title))
		{
		var wikifier = new Wikifier(store.getTiddlerText(title),formatter,null,store.getTiddler(title));
		return wikifier.wikifyPlain();
		}
	else
		return "";
}

// Highlight plain text into an element
function highlightify(source,output,highlightRegExp)
{
	if(source && source != "")
		{
		var wikifier = new Wikifier(source,formatter,highlightRegExp);
		wikifier.outputText(output,0,source.length);
		}
}

// Construct a wikifier object
// source - source string that's going to be wikified
// formatter - Formatter() object containing the list of formatters to be used
// highlightRegExp - regular expression of the text string to highlight
// tiddler - reference to the tiddler that's taken to be the container for this wikification
function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp)
		{
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
		}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = getPlainText(e);
	e.parentNode.removeChild(e);
	return text;
}

Wikifier.prototype.subWikify = function(output,terminator)
{
	// Handle the terminated and unterminated cases separately
	if (terminator)
		this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
	else
		this.subWikifyUnterm(output);
}

Wikifier.prototype.subWikifyUnterm = function(output)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	// Get the first match
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch)
		{
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		// Figure out which formatter matched and call its handler
		for(var t=1; t<formatterMatch.length; t++)
			{
			if(formatterMatch[t])
				{
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
				}
			}
		// Get the next match
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
		}
	// Output any text after the last match
	if(this.nextMatch < this.source.length)
		{
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
		}
	// Restore the output pointer
	this.output = oldOutput;
}

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	// Get the first matches for the formatter and terminator RegExps
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch)
		{
		// Check for a terminator match  before the next formatter match
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index))
			{
			// Output any text before the match
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			// Set the match parameters
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			// Restore the output pointer
			this.output = oldOutput;
			return;
			}
		// It must be a formatter match; output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		// Figure out which formatter matched and call its handler
		for(var t=1; t<formatterMatch.length; t++)
			{
			if(formatterMatch[t])
				{
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
				}
			}
		// Get the next match
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
		}
	// Output any text after the last match
	if(this.nextMatch < this.source.length)
		{
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
		}
	// Restore the output pointer
	this.output = oldOutput;
}

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	// Check for highlights
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos))
		{
		// Deal with any plain text before the highlight
		if(this.highlightMatch.index > startPos)
			{
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
			}
		// Deal with the highlight
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		// Nudge along to the next highlight if we're done with this one
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
		}
	// Do the unhighlighted text left over
	if(startPos < endPos)
		{
		createTiddlyText(place,this.source.substring(startPos,endPos));
		}
}

// ---------------------------------------------------------------------------------
// Macro definitions
// ---------------------------------------------------------------------------------

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text;
	if(params[0])
		text = now.formatString(params[0].trim());
	else
		text = now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
}

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
}

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var theList = document.createElement("ul");
	place.appendChild(theList);
	if(this[type].prompt)
		createTiddlyElement(theList,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++)
		{
		var theListItem = document.createElement("li")
		theList.appendChild(theListItem);
		if(typeof results[t] == "string")
			createTiddlyLink(theListItem,results[t],true);
		else
			createTiddlyLink(theListItem,results[t].title,true);
		}
}

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
}

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
}

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
}

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
}

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags();
	var theDateList = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(theDateList,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++)
		{
		var theListItem =createTiddlyElement(theDateList,"li");
		var theTag = createTiddlyButton(theListItem,tags[t][0] + " (" + tags[t][1] + ")",this.tooltip.format([tags[t][0]]),onClickTag);
		theTag.setAttribute("tag",tags[t][0]);
		}
}

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] ? params[0] : "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	for(var t=tiddlers.length-1; t>=last; t--)
		{
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay)
			{
			var theDateList = document.createElement("ul");
			place.appendChild(theDateList);
			createTiddlyElement(theDateList,"li",null,"listTitle",tiddler[field].formatString(this.dateFormat));
			lastDay = theDay;
			}
		var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink");
		theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
		}
}

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);
	var txt = createTiddlyElement(place,"input",null,"txtOptionInput");
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	if(config.browser.isSafari)
		{
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
		}
	else
		txt.setAttribute("type","text");
}

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0)
		{
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
		}
}

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
}

config.macros.search.onKeyPress = function(e)
{
	if(!e) var e = window.event;
	switch(e.keyCode)
		{
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			config.macros.search.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
		}
	if(this.value.length > 2)
		{
		if(this.value != this.getAttribute("lastSearchText"))
			{
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
			var txt = this;
			config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
			}
		}
	else
		{
		if(config.macros.search.timeout)
			clearTimeout(config.macros.search.timeout);
		}
}

config.macros.search.onFocus = function(e)
{
	this.select();
}

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("name",null,true,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] ? names[1] : null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className);
	if(!args)
		{
		wrapper.setAttribute("refresh","content");
		wrapper.setAttribute("tiddler",tiddlerName);
		}
	var text = store.getTiddlerText(tiddlerName);
	if(text)
		{
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.find(tiddlerName) !== null)
			return;
		stack.push(tiddlerName);
		try
			{
			var n = args ? Math.min(args.length,9) : 0;
			for(var i=0; i<n; i++) 
				{
				var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
				text = text.replace(placeholderRE,args[i]);
				}
			config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
			}
		finally
			{
			stack.pop();
			}
		}
}

config.macros.tiddler.renderText = function(place,text,tiddlerName,params) 
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
}

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0]);
}

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++)
		{
		createTagButton(createTiddlyElement(theList,"li"),tiddler.tags[t],tiddler.title);
		if(t<tiddler.tags.length-1)
			createTiddlyText(theList,sep);
		}
}

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	theList.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++)
		{
		createTiddlyLink(createTiddlyElement(theList,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(theList,sep);
		}
}

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
}

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
}

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
}

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
}

config.macros.saveChanges.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
}

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
}

config.macros.slider.onClickSlider = function(e)
{
	if(!e) var e = window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(anim && config.options.chkAnimate)
		anim.startAnimating(new Slider(n,!isOpen,e.shiftKey || e.altKey,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
}

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var cookie = cookie ? cookie : "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",cookie);
	panel.style.display = config.options[cookie] ? "block" : "none";
	place.appendChild(panel);
	return panel;
}

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh", "content");
	panel.setAttribute("tiddler", params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
}

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute("option");
	var elementType,valueField;
	if(opt)
		{
		switch(opt.substr(0,3))
			{
			case "txt":
				elementType = "input";
				valueField = "value";
				break;
			case "chk":
				elementType = "input";
				valueField = "checked";
				break;
			}
		config.options[opt] = this[valueField];
		saveOptionCookie(opt);
		var nodes = document.getElementsByTagName(elementType);
		for(var t=0; t<nodes.length; t++)
			{
			var optNode = nodes[t].getAttribute("option");
			if(opt == optNode)
				nodes[t][valueField] = this[valueField];
			}
		}
	return(true);
}

config.macros.option.handler = function(place,macroName,params)
{
	var opt = params[0];
	if(config.options[opt] == undefined)
		return;
	var c;
	switch(opt.substr(0,3))
		{
		case "txt":
			c = document.createElement("input");
			c.onkeyup = this.onChangeOption;
			c.setAttribute("option",opt);
			c.className = "txtOptionInput";
			place.appendChild(c);
			c.value = config.options[opt];
			break;
		case "chk":
			c = document.createElement("input");
			c.setAttribute("type","checkbox");
			c.onclick = this.onChangeOption;
			c.setAttribute("option",opt);
			c.className = "chkOptionInput";
			place.appendChild(c);
			c.checked = config.options[opt];
			break;
		}
}



config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus)
{
	var tags = [];
	for(var t=1; t<params.length; t++)
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	var text = getParam(params,"text");
	if(text !== undefined) 
		btn.setAttribute("newText",text);
	return btn;
}

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	var params = this.getAttribute("params").split("|");
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	story.displayTiddler(null,title,template);
	var text = this.getAttribute("newText");
	if(typeof text == "string")
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<params.length;t++)
		story.setTiddlerTag(title,params[t],+1);
	story.focusTiddler(title,focus);
	return false;
}

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly)
		{
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title");
		}
}

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly)
		{
		params = paramString.parseParams("anon",null,true,false,false);
		var now = new Date();
		var title = params[1] && params[1].name == "anon" ? params[1].value : "";
		title = getParam(params,"title",title);
		title = now.formatString(title.trim());
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text");
		}
}

config.macros.sparkline.handler = function(place,macroName,params)
{
	var data = [];
	var min = 0;
	var max = 0;
	for(var t=0; t<params.length; t++)
		{
		var v = parseInt(params[t]);
		if(v < min)
			min = v;
		if(v > max)
			max = v;
		data.push(v);
		}
	if(data.length < 1)
		return;
	var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
	box.title = data.join(",");
	var w = box.offsetWidth;
	var h = box.offsetHeight;
	box.style.paddingRight = (data.length * 2 - w) + "px";
	box.style.position = "relative";
	for(var d=0; d<data.length; d++)
		{
		var tick = document.createElement("img");
		tick.border = 0;
		tick.className = "sparktick";
		tick.style.position = "absolute";
		tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
		tick.style.left = d*2 + "px";
		tick.style.width = "2px";
		var v = Math.floor(((data[d] - min)/(max-min)) * h);
		tick.style.top = (h-v) + "px";
		tick.style.height = v + "px";
		box.appendChild(tick);
		}
}

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++)
		{
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
		}
	if(!validTab)
		config.options[cookie] = params[1];
	this.switchTab(tabset,config.options[cookie]);
	place.appendChild(wrapper);
}

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
}

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++)
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab)
			{
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
			}
		else
			nodes[t].className = "tab tabUnselected"
	if(theTab)
		{
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			tabset.parentNode.removeChild(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie)
			{
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
			}
		}
}

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier)
{
	var terminator = ">>";
	var panel;
	if(wikifier)
		panel = createTiddlyElement(place,"div",null,"gradient");
	else
		panel = place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	var t;
	if(wikifier)
		{
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
		}
	var colours = [];
	for(t=1; t<params.length; t++)
		{
		var c = new RGB(params[t]);
		if(c)
			colours.push(c);
		}
	drawGradient(panel,params[0] != "vert",colours);
	if(wikifier)
		wikifier.subWikify(panel,terminator);
	if(document.all)
		{
		panel.style.height = "100%";
		panel.style.width = "100%";
		}
}

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0])
		{
		var m = config;
		var p = params[0].split(".");
		for(var t=0; t<p.length; t++)
			{
			if(p[t] in m)
				m = m[p[t]];
			else
				break;
			}
		createTiddlyText(place,m.toString().format(params.splice(1)));
		}
}

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0])
		{
		var value = store.getValue(tiddler,params[0]);
		if(value != undefined)
			switch(params[1])
				{
				case undefined:
					highlightify(value,place,highlightHack);
					break;
				case "link":
					createTiddlyLink(place,value,true);
					break;
				case "wikified":
					wikify(value,place,highlightHack,tiddler);
					break;
				case "date":
					value = Date.convertFromYYYYMMDDHHMM(value);
					if(params[2])
						createTiddlyText(place,value.formatString(params[2]));
					else
						createTiddlyText(place,value);
					break;
				}
		}
}

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	if((tiddler instanceof Tiddler) && field)
		{
		story.setDirty(tiddler.title,true);
		if(field != "text")
			{
				var e = createTiddlyElement(null,"input");
				if(tiddler.isReadOnly())
					e.setAttribute("readOnly","readOnly");
				e.setAttribute("edit",field);
				e.setAttribute("type","text");
				var v = store.getValue(tiddler,field);
				if(!v) 
					v = "";
				e.value = v;
				e.setAttribute("size","40");
				e.setAttribute("autocomplete","off");
				place.appendChild(e);
			}
		else
			{
				var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
				var wrapper2 = createTiddlyElement(wrapper1,"div");
				var e = createTiddlyElement(wrapper2,"textarea");
				if(tiddler.isReadOnly())
					e.setAttribute("readOnly","readOnly");
				var v = store.getValue(tiddler,field);
				if(!v) 
					v = "";
				e.value = v;
				var rows = 10;
				var lines = v.match(/\n/mg);
				var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
				if(lines != null && lines.length > rows)
					rows = lines.length + 5;
				rows = Math.min(rows,maxLines);
				e.setAttribute("rows",rows);
				e.setAttribute("edit",field);
				place.appendChild(wrapper1);
			}
		}
}

config.macros.tagChooser.onClick = function(e)
{
	if(!e) var e = window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for(var t=0; t<tags.length; t++)
		{
		var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		theTag.setAttribute("tag",tags[t][0]);
		theTag.setAttribute("tiddler", this.getAttribute("tiddler"));
		}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return(false);
}

config.macros.tagChooser.onTagClick = function(e)
{
	if(!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	var tiddler = store.getTiddler(title);
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return(false);
}

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler)
		{
		var title = tiddler.title;
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler", title);
		}
}

// Create a toolbar command button
// place - parent DOM element
// command - reference to config.commands[] member -or- name of member
// tiddler - reference to tiddler that toolbar applies to
// theClass - the class to give the button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)
{
	if(typeof commandName != "string")
		{
		var c = null;
		for(var t in config.commands)
			if(config.commands[t] == commandName)
				c = t;
		commandName = c;
		}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string"))
		{
		var title = tiddler.title;
		var command = config.commands[commandName];
		var ro = tiddler.isReadOnly();
		var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
		var text = ro && command.readOnlyText ? command.readOnlyText : command.text;
		var tooltip = ro && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
		if((!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow))

			{
			var btn = createTiddlyButton(null,text,tooltip,this.onClickCommand);
			btn.setAttribute("commandName", commandName);
			btn.setAttribute("tiddler", title);
			if(theClass)
				addClass(btn,theClass);
			place.appendChild(btn);
			}
		}
}

config.macros.toolbar.onClickCommand = function(e)
{
	if(!e) var e = window.event;
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
}

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,theClass,event)
{
	var children = place.getElementsByTagName("a")
	for(var t=0; t<children.length; t++)
		{
		var c = children[t];
		if(hasClass(c,theClass) && c.getAttribute && c.getAttribute("commandName"))
			{
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
			}
		}
}

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++)
		{
		var c = params[t];
		var theClass = "";
		switch(c.substr(0,1))
			{
			case "+":
				theClass = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				theClass = "cancelCommand";
				c = c.substr(1);
				break;
			}
		if(c in config.commands)
			this.createCommand(place,c,tiddler,theClass);
		}
}

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var e = createTiddlyElement(place,"div");
	e.setAttribute("refresh","macro");
	e.setAttribute("macroName","plugins");
	e.setAttribute("params",paramString);
	this.refresh(e,paramString);
}

config.macros.plugins.refresh = function(place,params)
{
	var selectedRows = [];
	ListView.forEachSelector(place,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(place);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++)
		{
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null)
			{
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
			}
		}
	for(t=0; t<plugins.length; t++)
		{
		var p = plugins[t];
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.find(plugins[t].title) != null;
		}
	if(plugins.length == 0)
		createTiddlyElement(place,"em",null,null,this.noPluginText);
	else
		ListView.create(place,plugins,this.listViewTemplate,this.onSelectCommand);
}

config.macros.plugins.onSelectCommand = function(command,rowNames)
{
	var t;
	switch(command)
		{
		case "remove":
			for(t=0; t<rowNames.length; t++)
				store.setTiddlerTag(rowNames[t],false,"systemConfig");
			break;
		case "delete":
			if(rowNames.length > 0 && confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")])))
				{
				for(t=0; t<rowNames.length; t++)
					{
					store.removeTiddler(rowNames[t]);
					story.closeTiddler(rowNames[t],true,false);
					}
				}
			break;
		}
	if(config.options.chkAutoSave)
		saveChanges(true);
}

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
}

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
}

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly)
		return;
	var importer = createTiddlyElement(null,"div",null,"importTiddler wizard");
	createTiddlyElement(importer,"h1",null,null,this.wizardTitle);
	createTiddlyElement(importer,"h2",null,"step1",this.step1);
	var step = createTiddlyElement(importer,"div",null,"wizardStep");
	createTiddlyText(step,this.step1prompt);
	var input = createTiddlyElement(null,"input",null,"txtOptionInput");
	input.type = "text";
	input.size = 50;
	step.appendChild(input);
	importer.inputBox = input;
	createTiddlyElement(step,"br");
	createTiddlyText(step,this.step1promptFile);
	var fileInput = createTiddlyElement(null,"input",null,"txtOptionInput");
	fileInput.type = "file";
	fileInput.size = 50;
	fileInput.onchange = this.onBrowseChange;
	fileInput.onkeyup = this.onBrowseChange;
	step.appendChild(fileInput);
	createTiddlyElement(step,"br");
	createTiddlyText(step,this.step1promptFeeds);
	var feeds = this.getFeeds([{caption: this.step1feedPrompt, name: ""}]);
	createTiddlyDropDown(step,this.onFeedChange,feeds);
	createTiddlyElement(step,"br");
	createTiddlyButton(step,this.fetchLabel,this.fetchPrompt,this.onFetch,null,null,null);
        place.appendChild(importer);
}

config.macros.importTiddlers.getFeeds = function(feeds)
{
	var tagged = store.getTaggedTiddlers("contentPublisher","title");
	for(var t=0; t<tagged.length; t++)
		feeds.push({caption: tagged[t].title, name: store.getTiddlerSlice(tagged[t].title,"URL")});
	return feeds;
}

config.macros.importTiddlers.onFeedChange = function(e)
{
	var importer = findRelated(this,"importTiddler","className","parentNode");
	importer.inputBox.value = this.value;
	this.selectedIndex = 0;
}

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var importer = findRelated(this,"importTiddler","className","parentNode");
	importer.inputBox.value = "file://" + this.value;
}

config.macros.importTiddlers.onFetch = function(e)
{
	var importer = findRelated(this,"importTiddler","className","parentNode");
	var url = importer.inputBox.value;
	var cutoff = findRelated(importer.firstChild,"step2","className","nextSibling");
	while(cutoff)
		{
		var temp = cutoff.nextSibling;
		cutoff.parentNode.removeChild(cutoff);
		cutoff = temp;
		}
	createTiddlyElement(importer,"h2",null,"step2",config.macros.importTiddlers.step2);
	var step = createTiddlyElement(importer,"div",null,"wizardStep",config.macros.importTiddlers.step2Text.format([url]));
	loadRemoteFile(url,config.macros.importTiddlers.onLoad,importer);
}

config.macros.importTiddlers.onLoad = function(status,params,responseText,url,xhr)
{
	if(!status)
		{
		displayMessage(this.fetchError);
		return;
		}
	var importer = params;
	// Check that the tiddler we're in hasn't been closed - doesn't work on IE
//	var p = importer;
//	while(p.parentNode)
//		p = p.parentNode;
//	if(!(p instanceof HTMLDocument))
//		return;
	// Crack out the content - (should be refactored)
	var posOpeningDiv = responseText.indexOf(startSaveArea);
	var limitClosingDiv = responseText.indexOf("<!--POST-BODY-START--"+">");
	var posClosingDiv = responseText.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? responseText.length : limitClosingDiv);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([url]));
		return;
		}
	var content = "<html><body>" + responseText.substring(posOpeningDiv,posClosingDiv + endSaveArea.length) + "</body></html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	importer.insertBefore(iframe,importer.firstChild);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	var importStore = new TiddlyWiki();
	importStore.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	// Extract data for the listview
	var tiddlers = [];
	importStore.forEachTiddler(function(title,tiddler)
		{
		var t = {};
		t.title = title;
		t.modified = tiddler.modified;
		t.modifier = tiddler.modifier;
		t.text = tiddler.text.substr(0,50);
		t.tags = tiddler.tags;
		tiddlers.push(t);
		});
	// Display the listview
	createTiddlyElement(importer,"h2",null,"step3",config.macros.importTiddlers.step3);
	var step = createTiddlyElement(importer,"div",null,"wizardStep");
	ListView.create(step,tiddlers,config.macros.importTiddlers.listViewTemplate,config.macros.importTiddlers.onSelectCommand);
	// Save the importer
	importer.store = importStore;
}

config.macros.importTiddlers.onSelectCommand = function(listView,command,rowNames)
{
	var importer = findRelated(listView,"importTiddler","className","parentNode");
	switch(command)
		{
		case "import":
			config.macros.importTiddlers.doImport(importer,rowNames);
			break;
		}
	if(config.options.chkAutoSave)
		saveChanges(true);
}

config.macros.importTiddlers.doImport = function(importer,rowNames)
{
	var theStore = importer.store;
	var overwrite = new Array();
	var t;
	for(t=0; t<rowNames.length; t++)
		{
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0)
		if(!confirm(this.confirmOverwriteText.format([overwrite.join(", ")])))
			return;
	for(t=0; t<rowNames.length; t++)
		{
		var inbound = theStore.fetchTiddler(rowNames[t]);
		store.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);
		store.fetchTiddler(inbound.title).created = inbound.created;
		store.notify(rowNames[t],false);
		}
	store.notifyAll();
	store.setDirty(true);
	createTiddlyElement(importer,"h2",null,"step4",this.step4.format([rowNames.length]));
	var step = createTiddlyElement(importer,"div",null,"wizardStep");
	for(t=0; t<rowNames.length; t++)
		{
		createTiddlyLink(step,rowNames[t],true);
		createTiddlyElement(step,"br");
		}
	createTiddlyElement(importer,"h2",null,"step5",this.step5);
}
// ---------------------------------------------------------------------------------
// Menu and toolbar commands
// ---------------------------------------------------------------------------------

config.commands.closeTiddler.handler = function(event,src,title)
{
	story.closeTiddler(title,true,event.shiftKey || event.altKey);
	return false;
}

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
}

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
	story.focusTiddler(title,"text");
	return false;
}

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
	   story.displayTiddler(null,newTitle);
	return false;
}

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly)
		if(!confirm(this.warning.format([title])))
			return false;
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
}

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if (config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if (deleteIt)
		{
		store.removeTiddler(title);
		story.closeTiddler(title,true,event.shiftKey || event.altKey);
		if(config.options.chkAutoSave)
			saveChanges();
		}
	return false;
}

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
}

config.commands.references.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup)
		{
		var references = store.getReferringTiddlers(title);
		var c = false;
		for(var r=0; r<references.length; r++)
			if(references[r].title != title && !references[r].isTagged("excludeLists"))
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
				c = true;
				}
		if(!c)
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
		}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	return false;
}

config.commands.jump.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup)
		{
		story.forEachTiddler(function(title,element) {
			createTiddlyLink(createTiddlyElement(popup,"li"),title,true);
			});
		}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	return false;
}

// ---------------------------------------------------------------------------------
// Tiddler() object
// ---------------------------------------------------------------------------------

function Tiddler()
{
	this.title = null;
	this.text = null;
	this.modifier = null;
	this.modified = new Date();
	this.created = new Date();
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return links;
}

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
	var s = [];
	s.push("<item>");
	s.push("<title>" + this.title.htmlEncode() + "</title>");
	s.push("<description>" + wikifyStatic(this.text,null,this).htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	s.push("</item>");
	return(s.join("\n"));
}

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
	this.assign(title,text,modifier,modified,tags,created,fields);
	this.changed();
	return this;
}

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
}

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
}

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.find(tag) != null;
}

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
}

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
}

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(this.text);
	while(formatMatch)
		{
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) // wikiWordLink
			{
			if(formatMatch.index > 0)
				{
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(this.text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
				}
			else
				this.links.pushUnique(formatMatch[1]);
			}
		else if(formatMatch[2-t] && (store.tiddlerExists(formatMatch[3-t]) || store.isShadowTiddler(formatMatch[3-t]))) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		// Do not add link if match urlPattern (formatMatch[5-t])
		formatMatch = tiddlerLinkRegExp.exec(this.text);
		}
	this.linksUpdated = true;
	return;
}

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;
	return(config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]));
}

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
}

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
}

Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
}

// ---------------------------------------------------------------------------------
// TiddlyWiki() object contains Tiddler()s
// ---------------------------------------------------------------------------------

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
		};
	this.fetchTiddler = function(title) {
		return tiddlers[title];
		};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
		};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
		};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers)
			{
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
			}
		};
}

// Set the dirty flag
TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
}

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
}

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
}

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
}

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel)
		for(var t=0; t<this.namedNotifications.length; t++)
			{
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
			}
}

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel)
		for(var t=0; t<this.namedNotifications.length; t++)
			{
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
			}
}

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for (var i=0; i<this.namedNotifications.length; i++)
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	this.namedNotifications.push({name: title, notify: fn});
	return this;
}

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		{
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
		}
}

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return (t != undefined);
}

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return typeof config.shadowTiddlers[title] == "string";
}

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
}

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		return tiddler.text;
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1)
		{
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
		}
	if(this.isShadowTiddler(title))
		return config.shadowTiddlers[title];
	if(defaultText != undefined)
		return defaultText;
	return null;
}

TiddlyWiki.prototype.slicesRE = /(?:[\'\/]*~?(\w+)[\'\/]*\:[\'\/]*\s*(.*?)\s*$)|(?:\|[\'\/]*~?(\w+)\:?[\'\/]*\|\s*(.*?)\s*\|)/gm

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title) 
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	do 
		{
			var m = this.slicesRE.exec(text);
			if (m) 
				{
					if (m[1])
						slices[m[1]] = m[2];
					else
						slices[m[3]] = m[4];
				}
		}
	while(m);
	return slices;
}

// Returns the slice of text of the given name
//#
//# A text slice is a substring in the tiddler's text that is defined
//# either like this
//#    aName:  textSlice
//# or
//#    |aName:| textSlice |
//# or
//#    |aName| textSlice |
//#
//# In the text the name (or name:) may be decorated with '' or //. I.e.
//# this would also a possible text slice:
//#
//#    |''aName:''| textSlice |
//#
//# @param name should only contain "word characters" (i.e. "a-ZA-Z_0-9")
//# @return [may be undefined] the (trimmed) text of the specified slice.
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if (!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
}

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++)
		{
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
		}
	return r;
}

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match)
			{
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1])
				{
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
				}
			lastPos = match.index + match[0].length;
			}
		else
			textOut.push(text.substr(lastPos));
	} while(match);
	return(textOut.join(""));
}

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		{
		var t = tiddler.tags.find(tag);
		if(t != null)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		this.notify(title,true);
		this.setDirty(true);
		}
}

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields)
{
	var tiddler = this.fetchTiddler(title);
	var created;
	if(tiddler)
		{
		created = tiddler.created; // Preserve created date
		this.deleteTiddler(title);
		}
	else
		{
		tiddler = new Tiddler();
		created = modified;
		}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
	this.addTiddler(tiddler);
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
}

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		{
		tiddler = new Tiddler();
		tiddler.title = title;
		this.addTiddler(tiddler);
		this.setDirty(true);
		}
	return tiddler;
}

// Load contents of a tiddlywiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate)
		{
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
		}
}

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
		});
}

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return store.getSaver().externalize(store);
}

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)
{
	var candidates = this.reverseLookup("tags",excludeTag,false);
	var results = [];
	for(var t=0; t<candidates.length; t++)
		{
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
		}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
}

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++)
			{
			var tag = tiddler.tags[g];
			var f = false;
			for(var c=0; c<results.length; c++)
				if(results[c][0] == tag)
					{
					f = true;
					results[c][1]++;
					}
			if(!f)
				results.push([tag,1]);
			}
		});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
}

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
}

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
}

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++)
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		if(f)
			results.push(tiddler);
		});
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
}

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
		});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
}

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		for(var n=0; n<tiddler.links.length;n++)
			{
			var link = tiddler.links[n];
			if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
				results.pushUnique(link);
			}
		});
	results.sort();
	return results;
}

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
		});
	results.sort();
	return results;
}

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers)
		if(typeof config.shadowTiddlers[t] == "string")
			results.push(t);
	results.sort();
	return results;
}

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler) 
{
	var t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
}

TiddlyWiki.prototype.getLoader = function() 
{
	if (!this.loader) 
		this.loader = new TW21Loader();
	return this.loader;
}
 
TiddlyWiki.prototype.getSaver = function() 
{
	if (!this.saver) 
		this.saver = new TW21Saver();
	return this.saver;
}

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by '.'
TiddlyWiki.isValidFieldName = function (name) {
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
}

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name) {
	if (!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
}

function StringFieldAccess(n, readOnly) {
	this.set = readOnly 
		? function(t,v) {if (v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);}
		: function(t,v) {if (v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n) {
	this.set = function(t,v) {
			var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v); 
			if (d != t[n]) {
				t[n] = d; return true;
			}
		};
	this.get = function(t)   {return t[n].convertToYYYYMMDDHHMM();}
}

function LinksFieldAccess(n) {
	this.set = function(t,v) {
			var s = (typeof v == "string") ? v.readBracketedList() : v; 
			if (s.toString() != t[n].toString()) {
				t[n] = s; return true;
			}
		};
	this.get = function(t)   {return String.encodeTiddlyLinkList(t[n]);}
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	
	"title":    new StringFieldAccess("title", true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title", true),
	
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name) {
	return TiddlyWiki.standardFieldAccess[name] != undefined;
}

// Sets the value of the given field of the tiddler to the value. 
// Setting an ExtendedField's value to null or undefined removes the field. 
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler, fieldName, value) {
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if (!t)
		return;
		
	fieldName = fieldName.toLowerCase();

	var isRemove = (value === undefined) || (value === null);

	if (!t.fields) 
		t.fields = {};
		
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if (accessor) {
		if (isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if (!h.set(t, value))
			return;

	} else {
		var oldValue = t.fields[fieldName];
		
		if (isRemove) {
			if (oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				
				// delete all fields in a namespace
				var re = new RegExp('^'+fieldName+'\\.');
				var dirty = false;
				for (var n in t.fields) {
					if (n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if (!dirty)
					return
			}
				
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
 			value = value instanceof Date 
				? value.convertToYYYYMMDDHHMMSSMMM() 
				: String(value);
			if (oldValue == value) 
				return;
			t.fields[fieldName] = value;
		}
	}
	
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if (!fieldName.match(/^temp\./))
		this.setDirty(true);
}

// Returns the value of the given field of the tiddler. 
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler, fieldName) {
	var t = this.resolveTiddler(tiddler);
	if (!t)
		return undefined;

	fieldName = fieldName.toLowerCase();

	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if (accessor) {
		return accessor.get(t);
	}
	
	return t.fields ? t.fields[fieldName] : undefined;
}

// Calls the callback function for every field in the tiddler.
//
// When callback function returns a non-false value the iteration stops 
// and that value is returned. 
//
// The order of the fields is not defined.
// 
// @param callback a function(tiddler, fieldName, value). 
// 
TiddlyWiki.prototype.forEachField = function(tiddler, callback, onlyExtendedFields) {
	var t = this.resolveTiddler(tiddler);
	if (!t)
		return undefined;
	
	if (t.fields) {
		for (var n in t.fields) {
			var result = callback(t, n, t.fields[n]);
			if (result)
				return result;
		}
	}
	
	if (onlyExtendedFields)
		return undefined;

	for (var n in TiddlyWiki.standardFieldAccess) {
		if (n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
			
		var result = callback(t, n, TiddlyWiki.standardFieldAccess[n].get(t));
		if (result)
			return result;
	}

	return undefined;
};
// ---------------------------------------------------------------------------------
// Story functions
// ---------------------------------------------------------------------------------

// A story is a HTML div containing a sequence of tiddlers that can be manipulated
// container - id of containing element
// idPrefix - string prefix prepended to title to make ids for tiddlers in this story
function Story(container,idPrefix)
{
	this.container = container;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
}

// Iterate through all the tiddlers in a story
// fn - callback function to be called for each tiddler. Arguments are:
//		tiddler - reference to Tiddler object
//		element - reference to tiddler display element
Story.prototype.forEachTiddler = function(fn)
{
	var place = document.getElementById(this.container);
	if(!place)
		return;
	var e = place.firstChild;
	while(e)
		{
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
		}
}

// Display several tiddlers given their titles in an array. Parameters same as displayTiddler(), except:
// titles - array of string titles
Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,slowly)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,slowly);
}

// Display a given tiddler with a given template. If the tiddler is already displayed but with a different
// template, it is switched to the specified template
// srcElement - reference to element from which this one is being opened -or-
//              special positions "top", "bottom"
// title - title of tiddler to display
// template - the name of the tiddler containing the template -or-
//			  one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE -or-
//			  null or undefined to indicate the current template if there is one, DEFAULT_VIEW_TEMPLATE if not
// animate - whether to perform animations
// slowly - whether to perform animations in slomo
Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly)
{
	var place = document.getElementById(this.container);
	var theTiddler = document.getElementById(this.idPrefix + title);
	if(theTiddler)
		this.refreshTiddler(title,template);
	else
		{
		var before = this.positionTiddler(srcElement);
		theTiddler = this.createTiddler(place,before,title,template);
		}
	if(srcElement && typeof srcElement !== "string")
		{
		if(anim && config.options.chkAnimate && (animate == undefined || animate == true))
			anim.startAnimating(new Cascade(title,srcElement,theTiddler,slowly),new Scroller(theTiddler,slowly));
		else
			window.scrollTo(0,ensureVisible(theTiddler));
		}
}

// Figure out the appropriate position for a newly opened tiddler
// srcElement - reference to the element containing the link to the tiddler -or-
//              special positions "top", "bottom"
// returns - reference to the tiddler that the new one should appear before (null for the bottom of the story)
Story.prototype.positionTiddler = function(srcElement)
{
	var place = document.getElementById(this.container);
	var before;
	if(typeof srcElement == "string")
		{
		switch(srcElement)
			{
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
			}
		}
	else
		{
		var after = this.findContainingTiddler(srcElement);
		if(after == null)
			before = place.firstChild;
		else if(after.nextSibling)
			before = after.nextSibling;
		else
			before = null;
		}
	return before;
}

// Create a tiddler frame at the appropriate place in a story column
// place - reference to parent element
// before - null, or reference to element before which to insert new tiddler
// title - title of new tiddler
// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE
Story.prototype.createTiddler = function(place,before,title,template)
{
	var theTiddler = createTiddlyElement(null,"div",this.idPrefix + title,"tiddler");
	theTiddler.setAttribute("refresh","tiddler");
	place.insertBefore(theTiddler,before);
	this.refreshTiddler(title,template);
	return theTiddler;
}

// Overridable for choosing the name of the template to apply for a tiddler
Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
}

// Overridable for extracting the text of a template from a tiddler
Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
}

// Apply a template to an existing tiddler if it is not already displayed using that template
// title - title of tiddler to update
// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE
// force - if true, forces the refresh even if the template hasn't changedd
Story.prototype.refreshTiddler = function(title,template,force)
{
	var theTiddler = document.getElementById(this.idPrefix + title);
	if(theTiddler)
		{
		if(theTiddler.getAttribute("dirty") == "true" && !force)
			return theTiddler;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = theTiddler.getAttribute("template");
		if((template != currTemplate) || force)
			{
			var tiddler = store.getTiddler(title);
			if(!tiddler)
				{
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title))
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
				else
					{
					var text = template=="EditTemplate"
								? config.views.editor.defaultText.format([title])
								: config.views.wikified.defaultText.format([title]);
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date);
					}
				}
			theTiddler.setAttribute("tags",tiddler.tags.join(" "));
			theTiddler.setAttribute("tiddler",title);
			theTiddler.setAttribute("template",template);
			var me = this;
			theTiddler.onmouseover = this.onTiddlerMouseOver;
			theTiddler.onmouseout = this.onTiddlerMouseOut;
			theTiddler.ondblclick = this.onTiddlerDblClick;
			theTiddler[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			var html = this.getTemplateForTiddler(title,template,tiddler);
			theTiddler.innerHTML = html;
			applyHtmlMacros(theTiddler,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(theTiddler,"isTag");
			else
				removeClass(theTiddler,"isTag");
			if(!store.tiddlerExists(title))
				{
				if(store.isShadowTiddler(title))
					addClass(theTiddler,"shadow");
				else
					addClass(theTiddler,"missing");
				}
			else
				{
				removeClass(theTiddler,"shadow");
				removeClass(theTiddler,"missing");
				}
			}
		}
	return theTiddler;
}

// Refresh all tiddlers in the Story
Story.prototype.refreshAllTiddlers = function() 
{
	var place = document.getElementById(this.container);
	var e = place.firstChild; 
	this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
	while((e = e.nextSibling) != null) 
		this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
}

// Default tiddler onmouseover/out event handlers
Story.prototype.onTiddlerMouseOver = function(e)
{
	if(window.addClass instanceof Function)
		addClass(this,"selected");
}

Story.prototype.onTiddlerMouseOut = function(e)
{
	if(window.removeClass instanceof Function)
		removeClass(this,"selected");
}

// Default tiddler ondblclick event handler
Story.prototype.onTiddlerDblClick = function(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea")
		{
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if (e.stopPropagation) e.stopPropagation();
		return true;
		}
	else
		return false;
}

Story.prototype.onTiddlerKeyPress = function(e)
{
	if (!e) var e = window.event;
	clearMessage();
	var consume = false; 
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode)
		{
		case 9: // Tab
			if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea")
				{
				replaceSelection(target,String.fromCharCode(9));
				consume = true; 
				}
			if(config.isOpera)
				{
				target.onblur = function()
					{
					this.focus();
					this.onblur = null;
					}
				}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey)
				{
				blurElement(this);
				config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
				consume = true;
				}
			break; 
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
			consume = true;
			break;
		}
	e.cancelBubble = consume;
	if(consume)
		{
		if (e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if (e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
		}
	return(!consume);
};

// Returns the specified field (input or textarea element) in a tiddler, otherwise the first edit field it finds
// or null if it found no edit field at all
Story.prototype.getTiddlerField = function(title,field)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	var e = null;
	if(tiddler != null)
		{
		var children = tiddler.getElementsByTagName("*");
		for (var t=0; t<children.length; t++)
			{
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea")
				{
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
				}
			}
		}
	return e;
}

// Focus a specified tiddler. Attempts to focus the specified field, otherwise the first edit field it finds
Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e)
		{
		e.focus();
		e.select();
		}
}

// Ensures that a specified tiddler does not have the focus
Story.prototype.blurTiddler = function (title)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null && tiddler.focus && tiddler.blur)
		{
		tiddler.focus();
		tiddler.blur();
		}
}

// Adds a specified value to the edit controls (if any) of a particular
// array-formatted field of a particular tiddler (eg "tags")
//  title - name of tiddler
//  tag - value of field, without any [[brackets]]
//  mode - +1 to add the tag, -1 to remove it, 0 to toggle it
//  field - name of field (eg "tags")
Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = story.getTiddlerField(title,field);

	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
}

// The same as setTiddlerField but preset to the "tags" field
Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	Story.prototype.setTiddlerField(title,tag,mode,"tags");
}

// Close a specified tiddler
// title - name of tiddler to close
// animate - whether to perform animations
// slowly - whether to perform animations in slomo
Story.prototype.closeTiddler = function(title,animate,slowly)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		clearMessage();
		this.scrubTiddler(tiddler);
		if(anim && config.options.chkAnimate && animate)
			anim.startAnimating(new Slider(tiddler,false,slowly,"all"));
		else
			tiddler.parentNode.removeChild(tiddler);
		}
}

// Scrub IDs from a tiddler. This is so that the 'ghost' of a tiddler while it is being closed
// does not interfere with things
// tiddler - reference to the tiddler element
Story.prototype.scrubTiddler = function(tiddler)
{
	tiddler.id = null;
}

// Set the 'dirty' flag of a tiddler
// tiddler - title of tiddler to change
// dirty - new boolean status of flag
Story.prototype.setDirty = function(title,dirty)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		tiddler.setAttribute("dirty",dirty ? "true" : "false");
}

// Is a particular tiddler dirty (with unsaved changes)?
Story.prototype.isDirty = function(title)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		return tiddler.getAttribute("dirty") == "true";
	return null;
}

// Close all tiddlers in the story
Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
		});
	window.scrollTo(0,0);
}

// Check if there are any tiddlers in the story
Story.prototype.isEmpty = function()
{
	var place = document.getElementById(this.container);
	return(place && place.firstChild == null);
}

// Perform a search and display the result
// text - text to search for
// useCaseSensitive - true for case sensitive matching
// useRegExp - true to interpret text as a RegExp
Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ?	 text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	var titles = [];
	for(var t=matches.length-1; t>=0; t--)
		titles.push(matches[t].title);
	this.displayTiddlers(null,titles);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
}

// Determine if the specified element is within a tiddler in this story
// e - reference to an element
// returns: reference to a tiddler element or null if none
Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return(e);
}

// Gather any saveable fields from a tiddler element
// e - reference to an element to scan recursively
// fields - object to contain gathered field values
Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute)
		{
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");;
		if(e.hasChildNodes())
			{
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields)
			}
		}
}

// Determine whether a tiddler has any edit fields, and if so if their values have been changed
// title - name of tiddler
Story.prototype.hasChanges = function(title)
{
	var e = document.getElementById(this.idPrefix + title);
	if(e != null)
		{
		var fields = {};
		this.gatherSaveFields(e,fields);
		var tiddler = store.fetchTiddler(title);
		if (!tiddler)
			return false;
		for(var n in fields)
			if (store.getValue(title,n) != fields[n])
				return true;
		}
	return false;
}

// Save any open edit fields of a tiddler and updates the display as necessary
// title - name of tiddler
// minorUpdate - true if the modified date shouldn't be updated
// returns: title of saved tiddler, or null if not saved
Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		var fields = {};
		this.gatherSaveFields(tiddler,fields);
		var newTitle = fields.title ? fields.title : title;
		if(store.tiddlerExists(newTitle) && newTitle != title)
			{
			if(confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				this.closeTiddler(newTitle,false,false);
			else
				return null;
			}
		tiddler.id = this.idPrefix + newTitle;
		tiddler.setAttribute("tiddler",newTitle);
		tiddler.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddler.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		var newDate = new Date();
		store.saveTiddler(title,newTitle,fields.text,config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags);
		for (var n in fields) 
			if (!TiddlyWiki.isStandardField(n))
				store.setValue(newTitle,n,fields[n]);
		if(config.options.chkAutoSave)
			saveChanges();
		return newTitle;
		}
	return null;
}

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
		});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
}

// ---------------------------------------------------------------------------------
// Message area
// ---------------------------------------------------------------------------------

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e)
		{
		alert(text);
		return;
		}
	if(linkText)
		{
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
		}
	else
		e.appendChild(document.createTextNode(text));
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea)
		{
		removeChildren(msgArea);
		msgArea.style.display = "none";
		}
	return false;
}

// ---------------------------------------------------------------------------------
// Refresh mechanism
// ---------------------------------------------------------------------------------

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},
	
	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && changeList.find(title) != null && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.find(title) != null)
			{
			removeChildren(e);
			wikify(store.getTiddlerText(title,title),e);
			return true;
			}
		else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++)
		{
		var e = nodes[c],type;
		if(e.getAttribute)
			type = e.getAttribute("refresh");
		else
			type = null;
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
		}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e)
		{
		var nextChild = e.nextSibling;
		if(e.getAttribute)
			{
			var macro = e.getAttribute("macro");
			if(macro)
				{
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1)
					{
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
					}
				invokeMacro(e,macro,params,null,tiddler);
				}
			}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
		}
}

function refreshPageTemplate(title)
{
	var stash = createTiddlyElement(document.body,"div");
	stash.style.display = "none";
	var display = document.getElementById("tiddlerDisplay");
	var nodes,t;
	if(display)
		{
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
		}
	var wrapper = document.getElementById("contentWrapper");
	if(!title)
		title = "PageTemplate";
	var html = store.getRecursiveTiddlerText(title,null,10);
	wrapper.innerHTML = html;
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = document.getElementById("tiddlerDisplay");
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div","tiddlerDisplay");
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	stash.parentNode.removeChild(stash);
}

function refreshDisplay(hint)
{
	var e = document.getElementById("contentWrapper");
	if(typeof hint == "string")
		hint = [hint];
	refreshElements(e,hint);
}

function refreshPageTitle()
{
	document.title = wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle");
}

function refreshStyles(title)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles("StyleSheet");
	refreshStyles("StyleSheetPrint");
}

// ---------------------------------------------------------------------------------
// Options cookie stuff
// ---------------------------------------------------------------------------------

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++)
		{
		var p = cookies[c].indexOf("=");
		if(p != -1)
			{
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			switch(name.substr(0,3))
				{
				case "txt":
					config.options[name] = unescape(value);
					break;
				case "chk":
					config.options[name] = value == "true";
					break;
				}
			}
		}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	switch(name.substr(0,3))
		{
		case "txt":
			c += escape(config.options[name].toString());
			break;
		case "chk":
			c += config.options[name] ? "true" : "false";
			break;
		}
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

// ---------------------------------------------------------------------------------
// Saving
// ---------------------------------------------------------------------------------

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if(store && store.isDirty && store.isDirty())
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false)
		{
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
		}
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + store.getRecursiveTiddlerText(tiddlerName,"") + "\n");
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	// Get the URL of the document
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if(originalPath.substr(0,5) != "file:")
		{
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	var localPath = getLocalPath(originalPath);
	// Load the original file
	var original = loadFile(localPath);
	if(original == null)
		{
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<!--POST-BODY-START--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([localPath]));
		return;
		}
	// Save the backup
	if(config.options.chkSaveBackups)
		{
		var backupPath = getBackupPath(localPath);
		var backup = saveFile(backupPath,original);
		if(backup)
			displayMessage(config.messages.backupSaved,"file://" + backupPath);
		else
			alert(config.messages.backupFailed);
		}
	// Save Rss
	if(config.options.chkGenerateAnRssFeed)
		{
		var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
		var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
		if(rssSave)
			displayMessage(config.messages.rssSaved,"file://" + rssPath);
		else
			alert(config.messages.rssFailed);
		}
	// Save empty template
	if(config.options.chkSaveEmptyTemplate)
		{
		var emptyPath,p;
		if((p = localPath.lastIndexOf("/")) != -1)
			emptyPath = localPath.substr(0,p) + "/empty.html";
		else if((p = localPath.lastIndexOf("\\")) != -1)
			emptyPath = localPath.substr(0,p) + "\\empty.html";
		else
			emptyPath = localPath + ".empty.html";
		var empty = original.substr(0,posOpeningDiv + startSaveArea.length) + original.substr(posClosingDiv);
		var emptySave = saveFile(emptyPath,empty);
		if(emptySave)
			displayMessage(config.messages.emptySaved,"file://" + emptyPath);
		else
			alert(config.messages.emptyFailed);
		}
	var save;
	try 
		{
		// Save new file
		var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + "\n" +
					convertUnicodeToUTF8(store.allTiddlersAsHtml()) + "\n" +
					original.substr(posClosingDiv);
		var newSiteTitle = convertUnicodeToUTF8((wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle")).htmlEncode());
		revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
		revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
		revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
		revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
		revised = updateMarkupBlock(revised,"POST-BODY","MarkupPostBody");
		save = saveFile(localPath,revised);
		}
	catch (e) 
		{
		showException(e);
		}
	if(save)
		{
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
		}
	else
		alert(config.messages.mainFailed);
}

function getLocalPath(originalPath)
{
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format assuming
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath)
{
	var backSlash = true;
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1)
		{
		dirPathPos = localPath.lastIndexOf("/");
		backSlash = false;
		}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? "\\" : "/") + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
	return backupPath;
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title>" + wikifyPlain("SiteTitle").htmlEncode() + "</title>");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for (var t=tiddlers.length-1; t>=n; t--)
		s.push(tiddlers[t].saveToRss(u));
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}


// UTF-8 encoding rules:
// 0x0000 - 0x007F:	0xxxxxxx
// 0x0080 - 0x07FF:	110xxxxx 10xxxxxx
// 0x0800 - 0xFFFF:	1110xxxx 10xxxxxx 10xxxxxx

function convertUTF8ToUnicode(u)
{
	if(window.netscape == undefined)
		return manualConvertUTF8ToUnicode(u);
	else
		return mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length)
		{
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80)
			dst++;
		else if(b1 < 0xE0)
			{
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
			}
		else
			{
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
			}
	}
	return(uni);
}

function mozConvertUTF8ToUnicode(u)
{
	try
		{
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
		}
	catch(e)
		{
		return manualConvertUTF8ToUnicode(u);
		} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return (fin.length > 0) ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
	if(window.netscape == undefined)
		return manualConvertUnicodeToUTF8(s);
	else
		return mozConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g ;
	return s.replace(re, function($0) {return("&#" + $0.charCodeAt(0).toString() + ";");})
}

function mozConvertUnicodeToUTF8(s)
{
	try
		{
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
		}
	catch(e)
		{
		return manualConvertUnicodeToUTF8(s);
		} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	if(fin.length > 0)
		return u + fin;
	else
		return u;
}

function saveFile(fileUrl, content)
{
	var r = null;
	if((r == null) || (r == false))
		r = mozillaSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = ieSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = javaSaveFile(fileUrl, content);
	return(r);
}

function loadFile(fileUrl)
{
	var r = null;
	if((r == null) || (r == false))
		r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return(r);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		}
	catch(e)
		{
		//alert("Exception while attempting to save\n\n" + e.toString());
		return(null);
		}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return(true);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
		}
	catch(e)
		{
		//alert("Exception while attempting to load\n\n" + e.toString());
		return(null);
		}
	return(content);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				file.create(0, 0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file, 0x20 | 0x02, 00004,null);
			out.write(content, content.length);
			out.flush();
			out.close();
			return(true);
			}
		catch(e)
			{
			//alert("Exception while attempting to save\n\n" + e);
			return(false);
			}
	return(null);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				return(null);
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file, 0x01, 00004, null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			return(sInputStream.read(sInputStream.available()));
			}
		catch(e)
			{
			//alert("Exception while attempting to load\n\n" + e);
			return(false);
			}
	return(null);
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function javaSaveFile(filePath, content)
{
	try
		{
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
		}
	catch(e)
		{
		}
	try
		{
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
		}
	catch(e)
		{
		return null;
		}
	return true;
}

function javaLoadFile(filePath)
{
	try
		{
	if(document.applets["TiddlySaver"])
		return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
		}
	catch(e)
		{
		}
	var content = [];
	try
		{
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while ((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
		}
	catch(e)
		{
		return null;
		}
	return content.join("\n");
}


// ---------------------------------------------------------------------------------
// Remote HTTP requests
// ---------------------------------------------------------------------------------

// Load a file over http
//   url - the source url
//   callback - function to call when there's a response
//   params - parameter object that gets passed to the callback for storing it's state
// Return value is the underlying XMLHttpRequest object, or 'null' if there was an error
// Callback function is called like this:
//   callback(status,params,responseText,xhr)
//     status - true if OK, false if error
//     params - the parameter object provided to loadRemoteFile()
//     responseText - the text of the file
//     xhr - the underlying XMLHttpRequest object
function loadRemoteFile(url,callback,params)
{
	// Get an xhr object
	var x;
	try
		{
		x = new XMLHttpRequest(); // Modern
		}
	catch(e)
		{
		try
			{
			x = new ActiveXObject("Msxml2.XMLHTTP"); // IE 6
			}
		catch (e)
			{
			return null;
			}
		}
	// Install callback
	x.onreadystatechange = function()
		{
		if (x.readyState == 4)
			{
			if ((x.status == 0 || x.status == 200) && callback)
				{
				callback(true,params,x.responseText,url,x);
			}
			else
				callback(false,params,null,url,x);
			}
		}
	// Send request
	if(window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	try
		{
		url = url + (url.indexOf("?") < 0 ? "?" : "&") + "nocache=" + Math.random();
		x.open("GET",url,true);
		if (x.overrideMimeType)
			x.overrideMimeType("text/html");
		x.send(null);
		}
	catch (e)
		{
		alert("Error in send " + e);
		return null;
		}
	return x;
}
// ---------------------------------------------------------------------------------
// TiddlyWiki-specific utility functions
// ---------------------------------------------------------------------------------

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
	var theButton = document.createElement("a");
	if(theAction)
		{
		theButton.onclick = theAction;
		theButton.setAttribute("href","javascript:;");
		}
	if(theTooltip)
		theButton.setAttribute("title",theTooltip);
	if(theText)
		theButton.appendChild(document.createTextNode(theText));
	if(theClass)
		theButton.className = theClass;
	else
		theButton.className = "button";
	if(theId)
		theButton.id = theId;
	if(theParent)
		theParent.appendChild(theButton);
	if(theAccessKey)
		theButton.setAttribute("accessKey",theAccessKey);
	return(theButton);
}

function createTiddlyLink(place,title,includeText,theClass,isStatic)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,theClass)
	var btn;
	if(isStatic)
		btn = createExternalLink(place,"#" + title);
	else
		btn = createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	return(btn);
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler)
		{
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
		}
	else
		{
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title))
			{
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
			}
		else
			{
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
			}
		}
	return {classes: classes.join(" "), subTitle: subTitle};
}

function createExternalLink(place,url)
{
	var theLink = document.createElement("a");
	theLink.className = "externalLink";
	theLink.href = url;
	theLink.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		theLink.target = "_blank";
	place.appendChild(theLink);
	return(theLink);
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var theLink = theTarget;
	var title = null;
	do {
		title = theLink.getAttribute("tiddlyLink");
		theLink = theLink.parentNode;
	} while(title == null && theLink != null);
	if(title)
		{
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		var opening;
		if(toggling && document.getElementById("tiddler" + title))
			story.closeTiddler(title,true,e.shiftKey || e.altKey);
		else
			story.displayTiddler(theTarget,title,null,true,e.shiftKey || e.altKey);
		}
	clearMessage();
	return(false);
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
	var theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
	theTag.setAttribute("tag",tag);
	if(excludeTiddler)
		theTag.setAttribute("tiddler",excludeTiddler);
	return(theTag);
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = Popup.create(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag)
		{
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++)
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		var lingo = config.views.wikified.tag;
		if(titles.length > 0)
			{
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++)
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
				}
			}
		else
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
		}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
	if (!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiddlers(tag);
	var titles = [];
	for(var t=0; t<tagged.length; t++)
		titles.push(tagged[t].title);
	displayTiddlers(this,titles);
	return(false);
}

function onClickError(e)
{
	if (!e) var e = window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++)
		{
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		}
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if (text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for (p in src)
		if (!preserveExisting || dst[p] === undefined)
			dst[p] = src[p];
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e, message)
{
	var s = e.description ? e.description : e.toString();
	return message ? "%0:\n%1".format([message, s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e, message)
{
	alert(exceptionText(e, message));
}

// ---------------------------------------------------------------------------------
// Animation engine
// ---------------------------------------------------------------------------------

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0)
		{
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},5);
		}
	this.running += arguments.length;
}

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length)
		{
		var animation = me.animations[a];
		if(animation.tick())
			a++;
		else
			{
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
			}
		}
}

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
}

// ---------------------------------------------------------------------------------
// Cascade animation
// ---------------------------------------------------------------------------------

function Cascade(text,startElement,targetElement,slowly)
{
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	this.elements = [];
	this.startElement = startElement;
	this.startLeft = findPosX(this.startElement);
	this.startTop = findPosY(this.startElement);
	this.startWidth = Math.min(this.startElement.offsetWidth,winWidth);
	this.startHeight = Math.min(this.startElement.offsetHeight,winHeight);
	this.targetElement = targetElement;
	targetElement.style.position = "relative";
	targetElement.style.zIndex = 2;
	this.targetLeft = findPosX(this.targetElement);
	this.targetTop = findPosY(this.targetElement);
	this.targetWidth = Math.min(this.targetElement.offsetWidth,winWidth);
	this.targetHeight = Math.min(this.targetElement.offsetHeight,winHeight);
	this.progress = -1;
	this.steps = slowly ? config.cascadeSlow : config.cascadeFast;
	this.text = text;
	this.tick();
	return this;
}

Cascade.prototype.tick = function()
{
	this.progress++;
	if(this.progress >= this.steps)
		{
		while(this.elements.length > 0)
			this.removeTail();
		this.targetElement.style.position = "static";
		this.targetElement.style.zIndex = "";
		return false;
		}
	else
		{
		if(this.elements.length > 0 && this.progress > config.cascadeDepth)
			this.removeTail();
		if(this.progress < (this.steps - config.cascadeDepth))
			{
			var f = Animator.slowInSlowOut(this.progress/(this.steps - config.cascadeDepth - 1));
			var e = createTiddlyElement(document.body,"div",null,"cascade",this.text);
			e.style.zIndex = 1;
			e.style.left = this.startLeft + (this.targetLeft-this.startLeft) * f + "px";
			e.style.top = this.startTop + (this.targetTop-this.startTop) * f + "px";
			e.style.width = this.startWidth + (this.targetWidth-this.startWidth) * f + "px";
			e.style.height = this.startHeight + (this.targetHeight-this.startHeight) * f + "px";
			e.style.display = "block";
			this.elements.push(e);
			}
		return true;
		}
}

Cascade.prototype.removeTail = function()
{
	var e = this.elements[0];
	e.parentNode.removeChild(e);
	this.elements.shift();
}

// ---------------------------------------------------------------------------------
// Scroller animation
// ---------------------------------------------------------------------------------

function Scroller(targetElement,slowly)
{
	this.targetElement = targetElement;
	this.startScroll = findScrollY();
	this.targetScroll = ensureVisible(targetElement);
	this.progress = 0;
	this.step = slowly ? config.animSlow : config.animFast;
	return this;
}

Scroller.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress > 1)
		{
		window.scrollTo(0,this.targetScroll);
		return false;
		}
	else
		{
		var f = Animator.slowInSlowOut(this.progress);
		window.scrollTo(0,this.startScroll + (this.targetScroll-this.startScroll) * f);
		return true;
		}
}

// ---------------------------------------------------------------------------------
// Slider animation
// ---------------------------------------------------------------------------------

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,slowly,deleteMode)
{
	this.element = element;
	element.style.display = "block";
	this.deleteMode = deleteMode;
	this.element.style.height = "auto";
	this.realHeight = element.offsetHeight;
	this.opening = opening;
	this.step = slowly ? config.animSlow : config.animFast;
	if(opening)
		{
		this.progress = 0;
		element.style.height = "0px";
		element.style.display = "block";
		}
	else
		{
		this.progress = 1;
		this.step = -this.step;
		}
	element.style.overflow = "hidden";
	return this;
}

Slider.prototype.stop = function()
{
	if(this.opening)
		{
		this.element.style.height = "auto";
		this.element.style.opacity = 1;
		this.element.style.filter = "alpha(opacity:100)";
		}
	else
		{
		switch(this.deleteMode)
			{
			case "none":
				this.element.style.display = "none";
				break;
			case "all":
				this.element.parentNode.removeChild(this.element);
				break;
			case "children":
				removeChildren(this.element);
				break;
			}
		}
}

Slider.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress < 0 || this.progress > 1)
		{
		this.stop();
		return false;
		}
	else
		{
		var f = Animator.slowInSlowOut(this.progress);
		var h = this.realHeight * f;
		this.element.style.height = h + "px";
		this.element.style.opacity = f;
		this.element.style.filter = "alpha(opacity:" + f * 100 +")";
		return true;
		}
}

// ---------------------------------------------------------------------------------
// Popup menu
// ---------------------------------------------------------------------------------

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root)
{
	Popup.remove();
	var popup = createTiddlyElement(document.body,"ol","popup","popup");
	Popup.stack.push({root: root, popup: popup});
	return popup;
}

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
}

Popup.show = function(unused,slowly)
{
	var curr = Popup.stack[Popup.stack.length-1];
	var rootLeft = findPosX(curr.root);
	var rootTop = findPosY(curr.root);
	var rootHeight = curr.root.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;
	var popupWidth = curr.popup.offsetWidth;
	var winWidth = findWindowWidth();
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth;
	curr.popup.style.left = popupLeft + "px";
	curr.popup.style.top = popupTop + "px";
	curr.popup.style.display = "block";
	addClass(curr.root,"highlight");
	if(anim && config.options.chkAnimate)
		anim.startAnimating(new Scroller(curr.popup,slowly));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
}

Popup.remove = function()
{
	if(Popup.stack.length > 0)
		{
		Popup.removeFrom(0);
		}
}

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--)
		{
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		p.popup.parentNode.removeChild(p.popup);
		}
	Popup.stack = Popup.stack.slice(0,from);
}

// ---------------------------------------------------------------------------------
// ListView gadget
// ---------------------------------------------------------------------------------

var ListView = {};

// Create a listview
//   place - where in the DOM tree to insert the listview
//   listObject - array of objects to be included in the listview
//   listTemplate - template for the listview
//   callback - callback for a command being selected
//   className - optional classname for the <table> element
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className ? className : "listView");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++)
		{
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader)
			colType.createHeader(c,columnTemplate,t);
		}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++)
		{
		rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(var c=0; c<listTemplate.rowClasses.length; c++)
			{
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
			}
		for(var cc=0; cc<listTemplate.columns.length; cc++)
			{
			var c = createTiddlyElement(r,"td");
			var columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			var colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem)
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
			}
		}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	return table;
}

ListView.getCommandHandler = function(callback)
{
	return function(e)
		{
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0)
			alert(config.messages.nothingSelected);
		callback(view,this.value,tiddlers);
		this.selectedIndex = 0;
		};
}

// Invoke a callback for each selector checkbox in the listview
//   view - <table> element of listView
//   callback(checkboxElement,rowName)
//     where
//       checkboxElement - DOM element of checkbox
//       rowName - name of this row as assigned by the column template
//   result: true if at least one selector was checked
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++)
		{
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox")
			{
			var rn = cb.getAttribute("rowName");
			if(rn)
				{
				callback(cb,rn);
				hadOne = true;
				}
			}
		}
	return hadOne;
}

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				{
				for(var t=0; t<v.length; t++)
					{
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
					}
				}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				{
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
				}
		}
};
// ---------------------------------------------------------------------------------
// Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
// ---------------------------------------------------------------------------------

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
}

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++)
		if(this[i] === item)
			return i;
	return -1;
}}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++)
		if(this[t][field] == value)
			return t;
	return null;
}

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.find(value);
	if(mode == 0)
		mode = (p == null) ? +1 : -1;
	if(mode == +1)
		{
		if(p == null)
			this.push(value);
		}
	else if(mode == -1)
		{
		if(p != null)
			this.splice(p,1);
		}
}

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++)
		if (this.indexOf(items[i]) != -1)
			return true;
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for (var i = 0; i<items.length; i++)
		if (this.indexOf(items[i]) == -1)
			return false;
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique != undefined && unique == false)
		this.push(item);
	else
		{
		if(this.indexOf(item) == -1)
			this.push(item);
		}
}

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	if(n < this.length)
		return this.slice(this.length-n);
	else
		return this;
}

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
}

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1)
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	return s.join("");
}

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1])
			{
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
			}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
}

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
}

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
}

// Convert "\n" to newlines, "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\s/mg,"\\").replace(/\r/mg,"");
}

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return(this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;"));
}

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return(this.replace(/&amp;/mg,"&").replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\""));
}

// Parse a space-separated string of name:value parameters where:
//   - the name or the value can be optional (in which case separate defaults are used instead)
//     - in case of ambiguity, a lone word is taken to be a value
//     - if 'cascadeDefaults' is set to true, then the defaults are modified by updated by each specified name or value
//     - name prefixes are not allowed if the 'noNames' parameter is true
//   - if both the name and value are present they must be separated by a colon
//   - the name and the value may both be quoted with single- or double-quotes, double-square brackets
//   - names or values quoted with {{double-curly braces}} are evaluated as a JavaScript expression
//     - as long as the 'allowEval' parameter is true
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p)
		{
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try
				{
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
				}
			catch(e)
				{
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(e);
				}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		return n;
		};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])*)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])*)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + ")";
	var re = noNames
		? new RegExp(token,"mg")
		: new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match)
			{
			var n = parseToken(match,1);
			if(noNames)
				r.push({name: "", value: n});
			else
				{
				var v = parseToken(match,7);
				if(v == null && defaultName)
					{
					v = n;
					n = defaultName;
					}
				else if(v == null && defaultValue)
					v = defaultValue;
				r.push({name: n, value: v});
				if(cascadeDefaults)
					{
					defaultName = n;
					defaultValue = v;
					}
				}
			}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++)
		{
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
		}
	return r;
}

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
}

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.pushUnique(p[t].value,unique);
	return n;
}

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end) 
{
	var s = this.indexOf(start);
	if(s != -1)
		{
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s, e];
		}
}

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r 
		? this.substring(0,r[0]) + sub + this.substring(r[1])
		: this;
}

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if (r)
		return this.substring(r[0],r[1]);
}


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	if(title.indexOf(" ") == -1)
		return(title);
	else
		return("[[" + title + "]]");
}

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list)
		{
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
		}
	else
		return "";
}

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return(s);
}

String.prototype.startsWith = function(prefix) 
{
	return !prefix || this.substring(0,prefix.length) == prefix;
}

// Returns the first value of the given named parameter.
//#
//# @param params
//#         as returned by parseParams or null/undefined
//# @return [may be null/undefined]
//#
function getParam(params, name, defaultValue) {
	if (!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
//#
//# @param params
//#         as returned by parseParams or null/undefined
//#
function getFlag(params, name, defaultValue) {
	return !!getParam(params, name, defaultValue);
} 
	
// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	template = template.replace(/wYYYY/g,this.getYearForWeekNo());
	template = template.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	template = template.replace(/YYYY/g,this.getFullYear());
	template = template.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	template = template.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	template = template.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	template = template.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	template = template.replace(/MM/g,this.getMonth()+1);
	template = template.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	template = template.replace(/WW/g,this.getWeek());
	template = template.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	template = template.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	template = template.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	template = template.replace(/DDth/g,this.getDate()+this.daySuffix());
	template = template.replace(/DD/g,this.getDate());
	template = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	template = template.replace(/hh12/g,this.getHours12());
	template = template.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	template = template.replace(/hh/g,this.getHours());
	template = template.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	template = template.replace(/mm/g,this.getMinutes());
	template = template.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	template = template.replace(/ss/g,this.getSeconds());
	template = template.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	template = template.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	return template;
}

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000); 
	return Math.floor(n/7)+1;
}

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
}

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
}

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? "pm" : "am";
}

Date.prototype.daySuffix = function()
{
	var num = this.getDate();
	if (num >= 11 && num <= 13) return "th";
	else if (num.toString().substr(-1)=="1") return "st";
	else if (num.toString().substr(-1)=="2") return "nd";
	else if (num.toString().substr(-1)=="3") return "rd";
	return "th";
}

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return(String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2));
}

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2));
}

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4));
}

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	var theDate = new Date(Date.UTC(parseInt(d.substr(0,4),10),
							parseInt(d.substr(4,2),10)-1,
							parseInt(d.substr(6,2),10),
							parseInt(d.substr(8,2),10),
							parseInt(d.substr(10,2),10),0,0));
	return(theDate);
}

// ---------------------------------------------------------------------------------
// Crypto functions and associated conversion routines
// ---------------------------------------------------------------------------------

// Crypto "namespace"
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	var be = Array();
	var len = Math.floor(str.length/4);
	var i, j;
	for(i=0, j=0; i<len; i++, j+=4)
		{
		be[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
		}
	while (j<str.length)
		{
		be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
		j++;
		}
	return be;
}

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	var str = "";
	for(var i=0;i<be.length*32;i+=8)
		str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
	return str;
}

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	var hex = "0123456789ABCDEF";
	var str = "";
	for(var i=0;i<be.length*4;i++)
		str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
	return str;
}

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return Crypto.be32sToHex(Crypto.sha1Str(str));
}

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return Crypto.sha1(Crypto.strToBe32s(str),str.length);
}

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	// Add 32-bit integers, wrapping at 32 bits
	//# Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
	add32 = function(a,b)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF);
		var msw = (a>>16)+(b>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Add five 32-bit integers, wrapping at 32 bits
	//# Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
	add32x5 = function(a,b,c,d,e)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
		var msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Bitwise rotate left a 32-bit integer by 1 bit
	rol32 = function(n)
	{
		return (n>>>31)|(n<<1);
	};

	var len = blen*8;
	// Append padding so length in bits is 448 mod 512
	x[len>>5] |= 0x80 << (24-len%32);
	// Append length
	x[((len+64>>9)<<4)+15] = len;
	var w = Array(80);

	var k1 = 0x5A827999;
	var k2 = 0x6ED9EBA1;
	var k3 = 0x8F1BBCDC;
	var k4 = 0xCA62C1D6;

	var h0 = 0x67452301;
	var h1 = 0xEFCDAB89;
	var h2 = 0x98BADCFE;
	var h3 = 0x10325476;
	var h4 = 0xC3D2E1F0;

	for(var i=0;i<x.length;i+=16)
		{
		var j,t;
		var a = h0;
		var b = h1;
		var c = h2;
		var d = h3;
		var e = h4;
		for(j = 0;j<16;j++)
			{
			w[j] = x[i+j];
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
			}
		for(j=16;j<20;j++)
			{
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
			}
		for(j=20;j<40;j++)
			{
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
			}
		for(j=40;j<60;j++)
			{
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
			}
		for(j=60;j<80;j++)
			{
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
			}

		h0 = add32(h0,a);
		h1 = add32(h1,b);
		h2 = add32(h2,c);
		h3 = add32(h3,d);
		h4 = add32(h4,e);
		}
	return Array(h0,h1,h2,h3,h4);
}

// ---------------------------------------------------------------------------------
// RGB colour object
// ---------------------------------------------------------------------------------

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string")
		{
		if(r.substr(0,1) == "#")
			{
			if(r.length == 7)
				{
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
				}
			else
				{
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
				}
			}
		else
			{
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/ ;
			var c = r.match(rgbPattern);
			if (c)
				{
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
				}
			}
		}
	else
		{
		this.r = r;
		this.g = g;
		this.b = b;
		}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
}

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	var r = this.r.clamp(0,1);
	var g = this.g.clamp(0,1);
	var b = this.b.clamp(0,1);
	return("#" + ("0" + Math.floor(r * 255).toString(16)).right(2) +
				 ("0" + Math.floor(g * 255).toString(16)).right(2) +
				 ("0" + Math.floor(b * 255).toString(16)).right(2));
}

// ---------------------------------------------------------------------------------
// DOM utilities - many derived from www.quirksmode.org
// ---------------------------------------------------------------------------------

function drawGradient(place,horiz,colours)
{
	for(var t=0; t<= 100; t+=2)
		{
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var f = t/100;
		var p = f*(colours.length-1);
		bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
		}
}

function createTiddlyText(theParent,theText)
{
	return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyCheckbox(theParent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	theParent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,theParent);
	return cb;
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
	var e = document.createElement(theElement);
	if(theClass != null)
		e.className = theClass;
	if(theID != null)
		e.setAttribute("id",theID);
	if(theText != null)
		e.appendChild(document.createTextNode(theText));
	if(theParent != null)
		theParent.appendChild(e);
	return(e);
}

// Add an event handler
// Thanks to John Resig, via QuirksMode
function addEvent(obj,type,fn)
{
	if(obj.attachEvent)
		{
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn](window.event);}
		obj.attachEvent('on'+type,obj[type+fn]);
		}
	else
		obj.addEventListener(type,fn,false);
}

// Remove  an event handler
// Thanks to John Resig, via QuirksMode
function removeEvent(obj,type,fn)
{
	if(obj.detachEvent)
		{
		obj.detachEvent('on'+type,obj[type+fn]);
		obj[type+fn] = null;
		}
	else
		obj.removeEventListener(type,fn,false);
}

function addClass(e,theClass)
{
	var currClass = e.className.split(" ");
	if(currClass.indexOf(theClass) == -1)
		e.className += " " + theClass;
}

function removeClass(e,theClass)
{
	var currClass = e.className.split(" ");
	var i = currClass.indexOf(theClass);
	while(i != -1)
		{
		currClass.splice(i,1);
		i = currClass.indexOf(theClass);
		}
	e.className = currClass.join(" ");
}

function hasClass(e,theClass)
{
	if(e.className)
		{
		if(e.className.split(" ").indexOf(theClass) != -1)
			return true;
		}
	return false;
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name ? name : "tagName";
	relative = relative ? relative : "parentNode";
	if(name == "className")
		{
		while(e && !hasClass(e,value))
			{
			e = e[relative];
			}
		}
	else
		{
		while(e && e[name] != value)
			{
			e = e[relative];
			}
		}
	return e;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if (e.target)
		obj = e.target;
	else if (e.srcElement)
		obj = e.srcElement;
	if (obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return(obj);
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop)
		return(posTop);
	else if(posBot > winBot)
		{
		if(e.offsetHeight < winHeight)
			return(posTop - (winHeight - e.offsetHeight));
		else
			return(posTop);
		}
	else
		return(winTop);
}

// Get the current width of the display window
function findWindowWidth()
{
	return(window.innerWidth ? window.innerWidth : document.documentElement.clientWidth);
}

// Get the current height of the display window
function findWindowHeight()
{
	return(window.innerHeight ? window.innerHeight : document.documentElement.clientHeight);
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return(window.scrollX ? window.scrollX : document.documentElement.scrollLeft);
}

// Get the current vertical page scroll position
function findScrollY()
{
	return(window.scrollY ? window.scrollY : document.documentElement.scrollTop);
}

function findPosX(obj)
{
	var curleft = 0;
	while (obj.offsetParent)
		{
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
		}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while (obj.offsetParent)
		{
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
		}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e != null && e.focus && e.blur)
		{
		e.focus();
		e.blur();
		}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e.hasChildNodes())
		e.removeChild(e.firstChild);
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id)
{
	if(!id)
		id = "customStyleSheet";
	var n = document.getElementById(id);
	if(document.createStyleSheet) // Test for IE's non-standard createStyleSheet method
		{
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
		}
	else
		{
		if(n)
			n.replaceChild(document.createTextNode(s),n.firstChild);
		else
			{
			var n = document.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(document.createTextNode(s));
			document.getElementsByTagName("head")[0].appendChild(n);
			}
		}
}

// Replace the current selection of a textarea or text input and scroll it into view

function replaceSelection(e,text)
{
	if (e.setSelectionRange)
		{
		var oldpos = e.selectionStart + 1;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionStart);
		e.setSelectionRange( oldpos, oldpos);
		var linecount = e.value.split('\n').length;
		var thisline = e.value.substr(0,e.selectionStart).split('\n').length-1;
		e.scrollTop = Math.floor((thisline-e.rows/2)*e.scrollHeight/linecount);
		}
	else if (document.selection)
		{
		var range = document.selection.createRange();
		if (range.parentElement() == e)
			{
			var isCollapsed = range.text == "";
			range.text = text;
			 if (!isCollapsed)
				{
				range.moveStart('character', -text.length);
				range.select();
				}
			}
		}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = ""; 
	while (e && e.nodeName == "#text")
		{
		t += e.nodeValue;
		e = e.nextSibling;
		}
	return t;
}
//# -------------------------
//# LoaderBase: A (abstract) storage loader that loads the tiddlers from a list of HTML elements.
//# The format of the elements is defined by subclasses of this loader through the internalizeTiddler implementation.
//# Subclasses must implement:
//# 			function getTitle(store, e)
//#
//# store must implement:
//# 			function createTiddler(title).
//#

function LoaderBase()
{
}

LoaderBase.prototype.loadTiddler = function(store,e,tiddlers)
{
	var title = this.getTitle(store, e);
	if (title)
		{
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store, tiddler, title, e);
		tiddlers.push(tiddler);
		}
}

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for (var t = 0; t < nodes.length; t++)
		{
		try
			{
			this.loadTiddler(store, nodes[t], tiddlers);
			}
		catch(e)
			{
			showException(e, config.messages.tiddlerLoadError.format([this.getTitle(store, nodes[t])]));
			}
		}
	return tiddlers;
}
	
//# -------------------------
//# SaverBase: a (abstract) storage saver that externalizes all tiddlers into a string, 
//# with every tiddler individually externalized (using this.externalizeTiddler) and joined with newlines 
//# Subclasses must implement:
//# 			function externalizeTiddler(store, tiddler)
//#
//# store must implement:
//# 			function getTiddlers(sortByFieldName)
//#

function SaverBase()
{
}

SaverBase.prototype.externalize = function(store) 
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for (var t = 0; t < tiddlers.length; t++)
		results.push(this.externalizeTiddler(store, tiddlers[t]));
	return results.join("\n");
}
//--------------------------------
// TW21Loader (inherits from LoaderBase)

function TW21Loader() {};

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store, e) {
	var title = null;
	if(e.getAttribute)
		title = e.getAttribute("tiddler");
	if(!title && e.id) {	
		var lenPrefix = store.idPrefix.length;
		if (e.id.substr(0,lenPrefix) == store.idPrefix)
			title = e.id.substr(lenPrefix);
	}
	return title;
}

TW21Loader.prototype.internalizeTiddler = function(store, tiddler, title, data) {
	var text = getNodeText(data.firstChild).unescapeLineBreaks();
	var modifier = data.getAttribute("modifier");
	var modified = Date.convertFromYYYYMMDDHHMM(data.getAttribute("modified"));
	var c = data.getAttribute("created");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : modified;
	var tags = data.getAttribute("tags");
	var fields = {};
	var attrs = data.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created, fields);
	return tiddler;
};

//--------------------------------
// TW21Saver (inherits from SaverBase)

function TW21Saver() {};

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store, tiddler) 
{
	try {
		var extendedFieldAttributes = "";
		store.forEachField(tiddler, 
			function(tiddler, fieldName, value) {
				// don't store stuff from the temp namespace
				if (!fieldName.match(/^temp\./))
					extendedFieldAttributes += ' %0="%1"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);
			}, true);
		return '<div tiddler="%0" modifier="%1" modified="%2" created="%3" tags="%4"%6>%5</div>'.format([
				tiddler.title.htmlEncode(),
				tiddler.modifier.htmlEncode(),
				tiddler.modified.convertToYYYYMMDDHHMM(),
				tiddler.created.convertToYYYYMMDDHHMM(),
				tiddler.getTags().htmlEncode(),
				tiddler.escapeLineBreaks().htmlEncode(),
				extendedFieldAttributes
			]);
	} catch (e) {
		throw exceptionText(e, config.messages.tiddlerSaveError.format([tiddler.title]));
	}
}

// ---------------------------------------------------------------------------------
// Deprecated code
// ---------------------------------------------------------------------------------

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
}

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead,"mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
		{
		var text = lookaheadMatch[1];
		if(config.browser.isIE)
			text = text.replace(/\n/g,"\r");
		createTiddlyElement(w.output,"pre",null,null,text);
		w.nextMatch = lookaheadRegExp.lastIndex;
		}
}

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
}

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
	var i = this.indexOf(item);
	return i == -1 ? null : i;
}

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	return store.getLoader().internalizeTiddler(store,this,title,divRef);
}

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store,this);
}

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly)
{
	story.displayTiddlers(srcElement,titles,template,animate,slowly);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,slowly)
{
	story.displayTiddler(srcElement,title,template,animate,slowly);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");
// ---------------------------------------------------------------------------------
// End of scripts
// ---------------------------------------------------------------------------------
//]]>
</script>
<style type="text/css">

#saveTest {
	display: none;
}

.zoomer {
	display: none;
}

#messageArea {
	display: none;
}

#copyright {
	display: none;
}

.popup {
	position: absolute;
}

#storeArea {
	display: none;
	margin: 4em 10em 3em;
}

#storeArea div {
 padding: 0.5em;
 margin: 1em 0em 0em 0em;
 border-color: #f0f0f0 #606060 #404040 #d0d0d0; 
 border-style: solid; 
 border-width: 2px;
 overflow: auto;
}

#javascriptWarning {
	width: 100%;
	text-align: center;
	font-weight: bold;
	background-color: #dd1100;
	color: #fff;
	padding:1em 0em; 
}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
	<script type="text/javascript">
//<![CDATA[
if (useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
	</script>
	<div id="copyright">
	Welcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2006 Osmosoft Limited
	</div>
	<noscript>
		<div id="javascriptWarning">This page requires JavaScript to function properly</div>
	</noscript>
	<div id="saveTest"></div>
	<div id="contentWrapper"></div>
	<div id="contentStash"></div>
	
<!--TIDDLYSPOT_INJECT-->
<div style="display:none"><img src="http://tiddlyspot.com/_ts/stats/moodle"/></div>
<!--TCEJNI_TOPSYLDDIT-->

<!--TIDDLYSPOT_INJECT-->
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">_uacct="UA-96965-3";urchinTracker();</script>

<!--TCEJNI_TOPSYLDDIT-->
<div id="storeArea"><div tiddler="AllowOnlineEdit" modifier="tiddlyspot" modified="200608150751" created="200608150751" tags="systemConfig excludeSearch tiddlyspot">config.options.chkHttpReadOnly = false;\n</div>
<div tiddler="BreakingNews" modifier="YourName" modified="200707020620" created="200612181138" tags="">!Expected this week (Jul 2007) to come up with a new implementation of the server files compatible with Moodle 1.7 and above\n!Notice: The server files work only in Moodle 1.6 due to the new moodle kernel roles feature\nWe are working on a Moodle 1.7 - 1.8 version.\nThe demo server only works with the Guest user. \nThe new [[SynchronizePlugin]] is released!!!\nThe IE6 and IE7 syntax error for the SynchronizePlugin is fixed, but it's ''strongly recommended'' that you use ''Firefox'' instead of IE.\nNew versions of the [[ExportTiddlersToDFwikiPlugin]] and the [[ImportDFwikisPlugin]] are released too.</div>
<div tiddler="DFWiki" modifier="Ludo(Marc Alier)" modified="200611090840" created="200610301135" tags="dfWikiTeam">DFWIKI is a project conceived and leaded by Ludo ( Marc Alier malier@lsi.upc.edu)\nto build a new wiki wiki module for moodle. I started on Feb 2005 and still goes on \nnow at late 2006.\n\nThis alternative Wiki module (called also new wiki) is the evolution of DFWiki to fit \nin Moodle 1.6 replacing the standard wiki module. The Moodle roadmap places n wiki \nas the oficial Wiki module for Moodle 1.8.\n \nAll the dfwiki development has been done within the frame of degree projects in\nthe Computer Science Engineering studies in the FIB school &quot;http://www.fib.upc.edu&quot; \nof the UPC University &quot;http://www.upc.edu&quot;\n\nThe main developers that have worked in this project are\n* Ferran Recio \n* David Castro \n* Jordi Piguillem Poch\n* Bernardino Todoli\n\nAnd a growing number of students that contributes to this project http://docs.moodle.org/en/Dfwikiteam\n\nDFWiki has two paralel projects :\nThe dfwiki Course . Wich alows to place a wiki in the main course page (even in the \nMoodle main course)\nThe wikiBook Module ( in development and soon released ) that allows to create a \nordered and due noted seqÃ¼ence of pages out of a chaotic wiki. It also will allow \nto place metadata, and export to formats like docBook, pdf, scorm and so on.\n\nDFWiki has the same license as moodle, whatever it is wink\nFind dfwiki news in moodle.org in &quot;using moodle&quot;-&gt; wiki forum and in the \nnew dfwiki home page. http://morfeo.upc.edu/crom\n\nLudo (Marc Alier) \nmalier@lsi.upc.edu\nhttp://www.lsi.upc.edu/~malier\n\nMore Infor and Downloads on [[DFWikiLabs|http://morfeo.upc.edu/crom]]\n\n\n</div>
<div tiddler="DFWikiTeam" modifier="Ludo(Marc Alier)" modified="200611021204" created="200610301142" tags="dfWikiTeam">All the projects inspired and related to [[DFWiki]] have been done within the frame of degree projects in the Computer Science Engineering studies in the FIB school [[http://www.fib.upc.edu]] of the UPC University [[http://www.upc.edu]]\n\nThe main developers that have worked in this project are\n* [[Ludo(Marc Alier)]] \n* Jordi Piguillem Poch - [[Pigui]]\n* [[Ferran Recio]] \n* [[David Castro]] \n* Bernardino Todoli\n* Agatha Prats \n* ups.. I'm forgeting lots of names... And a growing number of students that contributes to this project http://docs.moodle.org/en/Dfwikiteam\n\n ImportDFwikisPlugin is a DFWikiTeam Project conducted by \n*[[Oriol Nieto]]\n*[[Alejandro Moreno]]\nAnd maybe more infomration in [[our blogs]]\n</div>
<div tiddler="DefaultTiddlers" modifier="Ludo" modified="200701070809" created="200610130455" tags="">BreakingNews\n[[Syncronize Moodle NWiki with your Tiddlywiki]]\n[[License And Legal Aspects]]</div>
<div tiddler="Editor Tools" modifier="Ludo" modified="200703171005" created="200611220737" tags="">DefaultTiddlers\n[[tiddlyspotControls]]\nSideBarOptions\nMainMenu\n\n</div>
<div tiddler="ExportTiddlersToDFwikiPanel" modifier="uri" modified="200612181140" created="200612181134" tags="synchronized">&lt;&lt;exportDFwikis inline&gt;&gt;</div>
<div tiddler="ExportTiddlersToDFwikiPlugin" modifier="uri" modified="200612211125" created="200611111707" tags="systemConfig importexport includeNew editing dfwikiteam">/***\n|''Name:''|ExportTiddlersToDFwikisPlugin|\n|''Author:''|[[Oriol Nieto|http://enochrooted.blogspot.com/]] , [[Alejandro Moreno|http://vdemarvvv.blogspot.com/]], DÃ­dac Calventus &amp; [[Ludo( Marc Alier)|http://www.lsi.upc.edu/~malier/]]|\n|''Another production of:''|[[dfwikiteam|http://morfeo.upc.es/crom/]] [[Universitat PolitÃ¨cnica de Catalunya|http://www.upc.edu]]|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/ as described in the license document http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html#%5B%5BLicense%20And%20Legal%20Aspects%5D%5D]]|\n|''~CoreVersion:''|2.1.2|\n|''~PluglinVersion:''|1.3|\n|''Download latest version from''|http://moodle.tiddlyspot.com#ExportTiddlersToDFwikiPlugin|\n|''Moodle wiki server side files''|http://morfeo.upc.edu/crom|\n/***\n\nThis plugin lets you export tiddlers into dfwiki pages of a moodle 1.6.X with the nwiki module installed.\nLog-in with your moodle username and pasword and click &quot;get info&quot; to begin the interactive process of exporting tiddlers.\n\nYou need to install the Moodle wiki server side files. You can find them in http://morfeo.upc.edu/crom.\n\nIt's ''strongly recommended'' that you use ''Firefox'' (or any netscape based navigator) instead of IE in order to avoid security problems.\n\nIf anyway you want to use IE, you'll have to turn down all security parameters.\n\n!!!!!Inline interface (live)\n&lt;&lt;&lt;\n&lt;&lt;exportDFwikis inline&gt;&gt;\n&lt;&lt;&lt;\n!!!!!Credits \n&lt;&lt;&lt;\nThis plugin is a derivative of http://www.TiddlyTools.com/#ExportTiddlersPlugin, created by Eric L.Shulman and/or ELS Design Studios, and is subject to all terms and conditions as described in http://www.TiddlyTools.com/#LegalStatements as well as all other terms and conditions as described in this document.\n&lt;&lt;&lt;\n!!!!!Usage\n&lt;&lt;&lt;\nOptional &quot;special tiddlers&quot; used by this plugin:\n* MoodleSource^^\nIndicates the source of the moodle distribution that you wanna export to.\ndefault: //none//^^\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.12.09 [1.3]''\nAdded a new optional part of the panel compatible with wiki with groups.\n''2006.11.27 [1.2]''\nAJAX interaction is recieved in XML format (Solve some names problems).\n''2006.11.15 [1.1]''\nImproved and interactive interface.\n''2006.11.15 [1.0]''\nFirst release\n''2006.11.09 [0.0]''\ndevelopment started\n&lt;&lt;&lt;\n!!!!!Code\n***/\n// // +++[version]\n//{{{\nversion.extensions.exportDFwikis = {major: 2, minor: 2, revision: 3, date: new Date(2006,10,12)};\n//}}}\n// //===\n\n// // +++[macro handler]\n//{{{\nconfig.macros.exportDFwikis = {\n label: &quot;export tiddlers to moodle&quot;,\n prompt: &quot;Copy selected tiddlers to a moodle&quot;,\n datetimefmt: &quot;0MM/0DD/YYYY 0hh:0mm:0ss&quot;, // for &quot;filter date/time&quot; edit fields\n callNumber: &quot;0&quot;,\n info: &quot;&quot;,\n username: &quot;&quot;,\n transition: &quot;no&quot; , //to select if we've to call the export function or the transaction event (groups-&gt;users)\n selectedWiki: &quot;&quot; ,\n selectedWikiGroups: &quot;&quot;, //Wiki just before filling the users/groups select\n selectedGroup: &quot;&quot;,\n selectedUser: &quot;&quot;,\n selectedCourse: &quot;&quot;\n \n};\n\nconfig.macros.exportDFwikis.handler = function(place,macroName,params) {\n if (params[0]!=&quot;inline&quot;)\n { createTiddlyButton(place,this.label,this.prompt,onClickExportDFwikiMenu); return; }\n var panel=createExportDFwikiPanel(place);\n panel.style.position=&quot;static&quot;;\n panel.style.display=&quot;block&quot;;\n}\n\nfunction createExportDFwikiPanel(place) {\n var panel=document.getElementById(&quot;exportPanel&quot;);\n if (panel) { panel.parentNode.removeChild(panel); }\n setStylesheet(config.macros.exportDFwikis.css,&quot;exportDFwikis&quot;);\n panel=createTiddlyElement(place,&quot;span&quot;,&quot;exportPanel&quot;,null,null)\n panel.innerHTML=config.macros.exportDFwikis.html;\n exportInitFilter();\n refreshExportDFwikiList(0);\n var MoodleSource=store.getTiddlerText(&quot;MoodleSource&quot;); if (!MoodleSource) MoodleSource=&quot;&quot;;\n document.getElementById(&quot;exportMoodleServer&quot;).value=MoodleSource;\n return panel;\n}\n\nfunction onClickExportDFwikiMenu(e)\n{\n if (!e) var e = window.event;\n var parent=resolveTarget(e).parentNode;\n var panel = document.getElementById(&quot;exportPanel&quot;);\n if (panel==undefined || panel.parentNode!=parent)\n panel=createExportDFwikiPanel(parent);\n var isOpen = panel.style.display==&quot;block&quot;;\n if(config.options.chkAnimate)\n anim.startAnimating(new Slider(panel,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));\n else\n panel.style.display = isOpen ? &quot;none&quot; : &quot;block&quot; ;\n if (panel.style.display!=&quot;none&quot;) refreshExportDFwikiList(0); // update list when panel is made visible\n e.cancelBubble = true;\n if (e.stopPropagation) e.stopPropagation();\n return(false);\n}\n//}}}\n// //===\n\n// // +++[Hijack saveChanges] diverts 'notFileUrlError' to display export control panel instead\n//{{{\nwindow.coreSaveDFwikiChanges=window.saveDFwikiChanges;\nwindow.saveDFwikiChanges = function()\n{\n if (document.location.protocol==&quot;file:&quot;) { coreSaveDFwikiChanges(); return; }\n var e = window.event;\n var parent=e?resolveTarget(e).parentNode:document.body;\n var panel = document.getElementById(&quot;exportPanel&quot;);\n if (panel==undefined || panel.parentNode!=parent) panel=createExportDFwikiPanel(parent);\n if (parent==document.body) { panel.style.left=&quot;30%&quot;; panel.style.top=&quot;30%&quot;; }\n panel.style.display = &quot;block&quot; ;\n}\n//}}}\n// //===\n\n// // +++[IE needs explicit scoping] for functions called by browser events\n//{{{\nwindow.onClickExportDFwikiMenu=onClickExportDFwikiMenu;\nwindow.onClickExportDFwikiButton=onClickExportDFwikiButton;\nwindow.exportShowDFwikiFilterFields=exportShowDFwikiFilterFields;\nwindow.refreshExportDFwikiList=refreshExportDFwikiList;\n//}}}\n// //===\n\n// // +++[CSS] for floating export control panel\n//{{{\nconfig.macros.exportDFwikis.css = '\s\n#exportPanel {\s\n display: none; position:absolute; z-index:12; width:35em; right:105%; top:6em;\s\n background-color: #eee; color:#000; font-size: 8pt; line-height:110%;\s\n border:1px solid black; border-bottom-width: 3px; border-right-width: 3px;\s\n padding: 0.5em; margin:0em; -moz-border-radius:1em;\s\n}\s\n#exportPanel a, #exportPanel td a { color:#009; display:inline; margin:0px; padding:1px; }\s\n#exportPanel table { width:100%; border:0px; padding:0px; margin:0px; font-size:8pt; line-height:110%; background:transparent; }\s\n#exportPanel tr { border:0px;padding:0px;margin:0px; background:transparent; }\s\n#exportPanel td { color:#000; border:0px;padding:0px;margin:0px; background:transparent; }\s\n#exportPanel select { width:100%;margin:0px;font-size:8pt;line-height:110%;}\s\n#exportPanel input { width:100%;padding:0px;margin:0px;font-size:8pt;line-height:110%; }\s\n#exportPanel textarea { width:98%;padding:0px;margin:0px;overflow:auto;font-size:8pt; }\s\n#exportPanel .box { border:1px solid black; padding:3px; margin-bottom:5px; background:#f8f8f8; -moz-border-radius:5px; }\s\n#exportPanel .topline { border-top:2px solid black; padding-top:3px; margin-bottom:5px; }\s\n#exportPanel .rad { width:auto;border:0 }\s\n#exportPanel .chk { width:auto;border:0 }\s\n#exportPanel .btn { width:auto; }\s\n#exportPanel .btn1 { width:98%; }\s\n#exportPanel .btn1bis { width:90%; }\s\n#exportPanel .btn2 { width:48%; }\s\n#exportPanel .btn3 { width:32%; }\s\n#exportPanel .btn4 { width:24%; }\s\n#exportPanel .btn5 { width:19%; }\s\n#groupsPanel { display:none; margin:0.5em 0em 0em 0em; }\s\n';\n//}}}\n// //===\n\n// // +++[HTML] for export control panel interface\n//{{{\nconfig.macros.exportDFwikis.html = '\s\n&lt;!-- export to a moodle server --&gt;\s\n&lt;div id=&quot;exportDFwikiPanel&quot; style=&quot;margin-top:5px;&quot;&gt;\s\nmoodle server&lt;br&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;td width=&quot;80%&quot;&gt;\s\n &lt;input type=&quot;text&quot; id=&quot;exportMoodleServer&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;20%&quot; align=&quot;right&quot;&gt;\s\n&lt;input type=button class=&quot;btn1bis&quot; onclick=&quot;getMoodleInfo()&quot;\s\n id=&quot;getMoodleInfo&quot; value=&quot;get info!&quot;&gt;\s\n&lt;/td&gt;&lt;/table&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; width=&quot;40%&quot;&gt;&lt;td&gt;\s\n username&lt;br&gt;\s\n &lt;input type=&quot;text&quot; id=&quot;exportID&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;40%&quot;&gt;\s\n password&lt;br&gt;\s\n &lt;input type=&quot;password&quot; id=&quot;exportPW&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;20%&quot; align=&quot;right&quot;&gt;\s\n &lt;br&gt;\s\n developed by\s\n&lt;/td&gt;&lt;/table&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; width=&quot;40%&quot;&gt;&lt;td&gt;\s\n course&lt;br&gt;\s\n &lt;select id=&quot;exportDFwikiCourse&quot; onfocus=&quot;this.select()&quot; onchange=&quot;continueGettingMoodleInfo(this.value)&quot; disabled&gt;&lt;br&gt;\s\n &lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;40%&quot;&gt;\s\n wiki name&lt;br&gt;\s\n &lt;select id=&quot;exportDFwikiName&quot; onfocus=&quot;this.select()&quot; onchange=&quot;config.macros.exportDFwikis.selectedWiki=this.value&quot; disabled&gt;&lt;br&gt;\s\n &lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;20%&quot; align=&quot;right&quot;&gt;\s\n &lt;a href=&quot;http://morfeo.upc.es/crom/&quot;&gt;\s\n &lt;img src=&quot;http://img294.imageshack.us/img294/8712/dfwikiteamie8.jpg&quot;&gt;\s\n &lt;/a&gt;\s\n&lt;/td&gt;&lt;/table&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n&lt;div id=&quot;groupsPanel&quot; style=&quot;margin-top:5px;margin-bottom:5px&quot;&gt;\s\n &lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; width=&quot;40%&quot;&gt;&lt;td&gt;\s\n group&lt;br&gt;\s\n &lt;select id=&quot;groupbox&quot; onfocus=&quot;this.select()&quot; onchange=&quot;transitionInfo(this.value)&quot; disabled&gt;&lt;br&gt;\s\n &lt;/select&gt;\s\n &lt;/td&gt;&lt;td width=&quot;40%&quot;&gt;\s\n user&lt;br&gt;\s\n &lt;select id=&quot;userbox&quot; onfocus=&quot;this.select()&quot; onchange=&quot;config.macros.exportDFwikis.selectedUser=this.value&quot; disabled&gt;&lt;br&gt;\s\n &lt;/select&gt;\s\n &lt;/td&gt;&lt;td width=&quot;20%&quot; align=&quot;right&quot;&gt;\s\n &lt;font color=&quot;green&quot;&gt;\s\n Â¡Â¡ groups info !!\s\n &lt;/font&gt;\s\n&lt;/td&gt;&lt;/table&gt;\s\n&lt;/div&gt;\s\n\s\n&lt;!-- list of tiddlers --&gt;\s\n&lt;table&gt;&lt;tr align=&quot;left&quot;&gt;&lt;td&gt;\s\n select:\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportSelectChanges&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;select tiddlers changed since last save&quot;&gt;\s\n &amp;nbsp;changes&amp;nbsp;&lt;/a&gt; \s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportSelectOpened&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;select tiddlers currently being displayed&quot;&gt;\s\n &amp;nbsp;opened&amp;nbsp;&lt;/a&gt; \s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportToggleFilter&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;show/hide selection filter&quot;&gt;\s\n &amp;nbsp;filter&amp;nbsp;&lt;/a&gt; \s\n&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportListSmaller&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;reduce list size&quot;&gt;\s\n &amp;nbsp;&amp;#150;&amp;nbsp;&lt;/a&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportListLarger&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;increase list size&quot;&gt;\s\n &amp;nbsp;+&amp;nbsp;&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;select id=&quot;exportList&quot; multiple size=&quot;10&quot; style=&quot;margin-bottom:5px;&quot;\s\n onchange=&quot;refreshExportDFwikiList(this.selectedIndex)&quot;&gt;\s\n&lt;/select&gt;&lt;br&gt;\s\n&lt;/div&gt;&lt;!--box--&gt;\s\n\s\n&lt;!-- selection filter --&gt;\s\n&lt;div id=&quot;exportFilterPanel&quot; style=&quot;display:none&quot;&gt;\s\n&lt;table&gt;&lt;tr align=&quot;left&quot;&gt;&lt;td&gt;\s\n selection filter\s\n&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;exportHideFilter&quot;\s\n onclick=&quot;onClickExportDFwikiButton(this)&quot; title=&quot;hide selection filter&quot;&gt;hide&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;div class=&quot;box&quot;&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;exportFilterStart&quot; value=&quot;1&quot;\s\n onclick=&quot;exportShowDFwikiFilterFields(this)&quot;&gt; starting date/time&lt;br&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr valign=&quot;center&quot;&gt;&lt;td width=&quot;50%&quot;&gt;\s\n &lt;select size=1 id=&quot;exportFilterStartBy&quot; onchange=&quot;exportShowDFwikiFilterFields(this);&quot;&gt;\s\n &lt;option value=&quot;0&quot;&gt;today&lt;/option&gt;\s\n &lt;option value=&quot;1&quot;&gt;yesterday&lt;/option&gt;\s\n &lt;option value=&quot;7&quot;&gt;a week ago&lt;/option&gt;\s\n &lt;option value=&quot;30&quot;&gt;a month ago&lt;/option&gt;\s\n &lt;option value=&quot;site&quot;&gt;SiteDate&lt;/option&gt;\s\n &lt;option value=&quot;file&quot;&gt;file date&lt;/option&gt;\s\n &lt;option value=&quot;other&quot;&gt;other (mm/dd/yyyy hh:mm)&lt;/option&gt;\s\n &lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;50%&quot;&gt;\s\n &lt;input type=&quot;text&quot; id=&quot;exportStartDate&quot; onfocus=&quot;this.select()&quot;\s\n onchange=&quot;document.getElementById(\s'exportFilterStartBy\s').value=\s'other\s';&quot;&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;exportFilterEnd&quot; value=&quot;1&quot;\s\n onclick=&quot;exportShowDFwikiFilterFields(this)&quot;&gt; ending date/time&lt;br&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr valign=&quot;center&quot;&gt;&lt;td width=&quot;50%&quot;&gt;\s\n &lt;select size=1 id=&quot;exportFilterEndBy&quot; onchange=&quot;exportShowDFwikiFilterFields(this);&quot;&gt;\s\n &lt;option value=&quot;0&quot;&gt;today&lt;/option&gt;\s\n &lt;option value=&quot;1&quot;&gt;yesterday&lt;/option&gt;\s\n &lt;option value=&quot;7&quot;&gt;a week ago&lt;/option&gt;\s\n &lt;option value=&quot;30&quot;&gt;a month ago&lt;/option&gt;\s\n &lt;option value=&quot;site&quot;&gt;SiteDate&lt;/option&gt;\s\n &lt;option value=&quot;file&quot;&gt;file date&lt;/option&gt;\s\n &lt;option value=&quot;other&quot;&gt;other (mm/dd/yyyy hh:mm)&lt;/option&gt;\s\n &lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;50%&quot;&gt;\s\n &lt;input type=&quot;text&quot; id=&quot;exportEndDate&quot; onfocus=&quot;this.select()&quot;\s\n onchange=&quot;document.getElementById(\s'exportFilterEndBy\s').value=\s'other\s';&quot;&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=exportFilterTags value=&quot;1&quot;\s\n onclick=&quot;exportShowDFwikiFilterFields(this)&quot;&gt; match tags&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportTags&quot; onfocus=&quot;this.select()&quot;&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=exportFilterText value=&quot;1&quot;\s\n onclick=&quot;exportShowDFwikiFilterFields(this)&quot;&gt; match titles/tiddler text&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportText&quot; onfocus=&quot;this.select()&quot;&gt;\s\n&lt;/div&gt; &lt;!--box--&gt;\s\n&lt;/div&gt; &lt;!--panel--&gt;\s\n\s\n&lt;!-- action buttons --&gt;\s\n&lt;div style=&quot;text-align:center&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportDFwikiButton(this)&quot;\s\n id=&quot;exportFilter&quot; value=&quot;apply filter&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportDFwikiButton(this)&quot;\s\n id=&quot;exportStart&quot; value=&quot;export tiddlers&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportDFwikiButton(this)&quot;\s\n id=&quot;exportClose&quot; value=&quot;close&quot;&gt;\s\n&lt;/div&gt;&lt;!--center--&gt;\s\n';\n//}}}\n// //===\n\n// // +++[continueInfo()]\n//{{{\nfunction continueInfo() {\n \n if (config.macros.exportDFwikis.info==&quot;0&quot;)\n {\n displayMessage(&quot;Name or password incorrect&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true; \n removeSelect(&quot;exportDFwikiName&quot;);\n }\n else if (config.macros.exportDFwikis.info==&quot;2&quot;)\n {\n displayMessage(&quot;Guests can't export content&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n removeSelect(&quot;exportDFwikiName&quot;);\n }\n else if (config.macros.exportDFwikis.info==&quot;1&quot;)\n { \n displayMessage(&quot;Name and password correct&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=false;\n removeSelect(&quot;exportDFwikiName&quot;);\n }\n else \n {\n displayMessage(&quot;Impossible to connect&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true; \n removeSelect(&quot;exportDFwikiName&quot;);\n }\n}\n//}}}\n// //===\n\n// // +++[continueInfo()]\n//{{{\nfunction transitionInfo(group) {\n if (group!=&quot;choose a group...&quot;)\n {\n config.macros.exportDFwikis.selectedGroup=group;\n if(config.macros.exportDFwikis.transition==&quot;yes&quot;)\n {\n document.getElementById(&quot;exportStart&quot;).disabled=false;\n exportDFwikis(); \n }\n }\n else\n {\n displayMessage(&quot;Impossible to export: The user choose a group... doesn't exists&quot;);\n }\n} \n//}}}\n// //===\n\n// // +++[exportInitFilter()]\n//{{{\nfunction exportInitFilter() {\n // start date\n document.getElementById(&quot;exportFilterStart&quot;).checked=false;\n document.getElementById(&quot;exportStartDate&quot;).value=&quot;&quot;;\n // end date\n document.getElementById(&quot;exportFilterEnd&quot;).checked=false;\n document.getElementById(&quot;exportEndDate&quot;).value=&quot;&quot;;\n // tags\n document.getElementById(&quot;exportFilterTags&quot;).checked=false;\n document.getElementById(&quot;exportTags&quot;).value=&quot;&quot;;\n // text\n document.getElementById(&quot;exportFilterText&quot;).checked=false;\n document.getElementById(&quot;exportText&quot;).value=&quot;&quot;;\n // show/hide filter input fields\n exportShowDFwikiFilterFields();\n}\n//}}}\n// //===\n\n// // +++[exportShowDFwikiFilterFields(which)]\n//{{{\nfunction exportShowDFwikiFilterFields(which) {\n var show;\n\n show=document.getElementById('exportFilterStart').checked;\n document.getElementById('exportFilterStartBy').style.display=show?&quot;block&quot;:&quot;none&quot;;\n document.getElementById('exportStartDate').style.display=show?&quot;block&quot;:&quot;none&quot;;\n var val=document.getElementById('exportFilterStartBy').value;\n document.getElementById('exportStartDate').value\n =getFilterDate(val,'exportStartDate').formatString(config.macros.exportDFwikis.datetimefmt);\n if (which &amp;&amp; (which.id=='exportFilterStartBy') &amp;&amp; (val=='other'))\n document.getElementById('exportStartDate').focus();\n\n show=document.getElementById('exportFilterEnd').checked;\n document.getElementById('exportFilterEndBy').style.display=show?&quot;block&quot;:&quot;none&quot;;\n document.getElementById('exportEndDate').style.display=show?&quot;block&quot;:&quot;none&quot;;\n var val=document.getElementById('exportFilterEndBy').value;\n document.getElementById('exportEndDate').value\n =getFilterDate(val,'exportEndDate').formatString(config.macros.exportDFwikis.datetimefmt);\n if (which &amp;&amp; (which.id=='exportFilterEndBy') &amp;&amp; (val=='other'))\n document.getElementById('exportEndDate').focus();\n\n show=document.getElementById('exportFilterTags').checked;\n document.getElementById('exportTags').style.display=show?&quot;block&quot;:&quot;none&quot;;\n\n show=document.getElementById('exportFilterText').checked;\n document.getElementById('exportText').style.display=show?&quot;block&quot;:&quot;none&quot;;\n}\n//}}}\n// //===\n// //===\n\n// // +++[onClickExportDFwikiButton(which): control interactions]\n//{{{\nfunction onClickExportDFwikiButton(which)\n{\n // DEBUG alert(which.id);\n var theList=document.getElementById('exportList'); if (!theList) return;\n var count = 0;\n var total = store.getTiddlers('title').length;\n switch (which.id)\n {\n case 'exportFilter':\n count=filterExportList();\n var panel=document.getElementById('exportFilterPanel');\n if (count==-1) { panel.style.display='block'; break; }\n document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n clearMessage(); displayMessage(&quot;filtered &quot;+formatExportMessage(count,total));\n if (count==0) { alert(&quot;No tiddlers were selected&quot;); panel.style.display='block'; }\n break;\n case 'exportStart':\n exportDFwikis();\n break;\n case 'exportHideFilter':\n case 'exportToggleFilter':\n var panel=document.getElementById('exportFilterPanel')\n panel.style.display=(panel.style.display=='block')?'none':'block';\n break;\n case 'exportSelectChanges':\n var lastmod=new Date(document.lastModified);\n for (var t = 0; t &lt; theList.options.length; t++) {\n if (theList.options[t].value==&quot;&quot;) continue;\n var tiddler=store.getTiddler(theList.options[t].value); if (!tiddler) continue;\n theList.options[t].selected=(tiddler.modified&gt;lastmod);\n count += (tiddler.modified&gt;lastmod)?1:0;\n }\n document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n clearMessage(); displayMessage(formatExportMessage(count,total));\n if (count==0) alert(&quot;There are no unsaved changes&quot;);\n break;\n case 'exportSelectOpened':\n for (var t = 0; t &lt; theList.options.length; t++) theList.options[t].selected=false;\n var tiddlerDisplay = document.getElementById(&quot;tiddlerDisplay&quot;);\n for (var t=0;t&lt;tiddlerDisplay.childNodes.length;t++) {\n var tiddler=tiddlerDisplay.childNodes[t].id.substr(7);\n for (var i = 0; i &lt; theList.options.length; i++) {\n if (theList.options[i].value!=tiddler) continue;\n theList.options[i].selected=true; count++; break;\n }\n }\n document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n clearMessage(); displayMessage(formatExportMessage(count,total));\n if (count==0) alert(&quot;There are no tiddlers currently opened&quot;);\n break;\n case 'exportListSmaller': // decrease current listbox size\n var min=5;\n theList.size-=(theList.size&gt;min)?1:0;\n break;\n case 'exportListLarger': // increase current listbox size\n var max=(theList.options.length&gt;25)?theList.options.length:25;\n theList.size+=(theList.size&lt;max)?1:0;\n break;\n case 'exportClose':\n document.getElementById('exportPanel').style.display='none';\n break;\n }\n}\n//}}}\n// //===\n\n// // +++[list display]\n//{{{\n \nfunction addToSelect(optionSelect,selectbox)\n{\n var elOptNew = document.createElement('option');\n elOptNew.text = optionSelect;\n elOptNew.value = optionSelect;\n var elSel = document.getElementById(selectbox);\n\n try {\n elSel.add(elOptNew, null); // standards compliant; doesn't work in IE\n }\n catch(ex) {\n elSel.add(elOptNew); // IE only\n }\n}\n\nfunction removeSelect(selectbox)\n{\n var elSel = document.getElementById(selectbox);\n var i;\n for (i = elSel.length - 1; i&gt;=0; i--) {\n elSel.remove(i);\n }\n}\n\nfunction formatExportMessage(count,total)\n{\n var txt=total+' tiddler'+((total!=1)?'s':'')+&quot; - &quot;;\n txt += (count==0)?&quot;none&quot;:(count==total)?&quot;all&quot;:count;\n txt += &quot; selected for export&quot;;\n return txt;\n}\n\nfunction refreshExportDFwikiList(selectedIndex)\n{\n var theList = document.getElementById(&quot;exportList&quot;);\n var sort;\n if (!theList) return;\n // get the sort order\n if (!selectedIndex) selectedIndex=0;\n if (selectedIndex==0) sort='modified';\n if (selectedIndex==1) sort='title';\n if (selectedIndex==2) sort='modified';\n if (selectedIndex==3) sort='modifier';\n\n // get the alphasorted list of tiddlers\n var tiddlers = store.getTiddlers('title');\n // unselect headings and count number of tiddlers actually selected\n var count=0;\n for (var i=0; i&lt;theList.options.length; i++) {\n if (theList.options[i].value==&quot;&quot;) theList.options[i].selected=false;\n count+=theList.options[i].selected?1:0;\n }\n // disable &quot;export&quot; button if no tiddlers selected\n document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n // update listbox heading to show selection count\n if (theList.options.length) { clearMessage(); displayMessage(formatExportMessage(count,tiddlers.length)); }\n\n // if a [command] item, reload list... otherwise, no further refresh needed\n if (selectedIndex&gt;3) return;\n\n // clear current list contents\n while (theList.length &gt; 0) { theList.options[0] = null; }\n // add heading and control items to list\n var i=0;\n var indent=String.fromCharCode(160)+String.fromCharCode(160);\n theList.options[i++]=\n new Option(tiddlers.length+&quot; tiddlers in document&quot;, &quot;&quot;,false,false);\n theList.options[i++]=\n new Option(((sort==&quot;title&quot; )?&quot;&gt;&quot;:indent)+' [by title]', &quot;&quot;,false,false);\n theList.options[i++]=\n new Option(((sort==&quot;modified&quot;)?&quot;&gt;&quot;:indent)+' [by date]', &quot;&quot;,false,false);\n theList.options[i++]=\n new Option(((sort==&quot;modifier&quot;)?&quot;&gt;&quot;:indent)+' [by author]', &quot;&quot;,false,false);\n // output the tiddler list\n switch(sort)\n {\n case &quot;title&quot;:\n for(var t = 0; t &lt; tiddlers.length; t++)\n theList.options[i++] = new Option(tiddlers[t].title,tiddlers[t].title,false,false);\n break;\n case &quot;modifier&quot;:\n case &quot;modified&quot;:\n var tiddlers = store.getTiddlers(sort);\n // sort descending for newest date first\n tiddlers.sort(function (a,b) {if(a[sort] == b[sort]) return(0); else return (a[sort] &gt; b[sort]) ? -1 : +1; });\n var lastSection = &quot;&quot;;\n for(var t = 0; t &lt; tiddlers.length; t++)\n {\n var tiddler = tiddlers[t];\n var theSection = &quot;&quot;;\n if (sort==&quot;modified&quot;) theSection=tiddler.modified.toLocaleDateString();\n if (sort==&quot;modifier&quot;) theSection=tiddler.modifier;\n if (theSection != lastSection)\n {\n theList.options[i++] = new Option(theSection,&quot;&quot;,false,false);\n lastSection = theSection;\n }\n theList.options[i++] = new Option(indent+indent+tiddler.title,tiddler.title,false,false);\n }\n break;\n }\n theList.selectedIndex=selectedIndex; // select current control item\n}\n//}}}\n// //===\n\n// // +++[list filtering]\n//{{{\nfunction getFilterDate(val,id)\n{\n var result=0;\n switch (val) {\n case 'site':\n var timestamp=store.getTiddlerText(&quot;SiteDate&quot;);\n if (!timestamp) timestamp=document.lastModified;\n result=new Date(timestamp);\n break;\n case 'file':\n result=new Date(document.lastModified);\n break;\n case 'other':\n result=new Date(document.getElementById(id).value);\n break;\n default: // today=0, yesterday=1, one week=7, two weeks=14, a month=31\n var now=new Date(); var tz=now.getTimezoneOffset()*60000; now-=tz;\n var oneday=86400000;\n if (id=='exportStartDate')\n result=new Date((Math.floor(now/oneday)-val)*oneday+tz);\n else\n result=new Date((Math.floor(now/oneday)-val+1)*oneday+tz-1);\n break;\n }\n // DEBUG alert('getFilterDate('+val+','+id+')=='+result+&quot;\snnow=&quot;+now);\n return result;\n}\n\nfunction filterExportList()\n{\n var theList = document.getElementById(&quot;exportList&quot;); if (!theList) return -1;\n\n var filterStart=document.getElementById(&quot;exportFilterStart&quot;).checked;\n var val=document.getElementById(&quot;exportFilterStartBy&quot;).value;\n var startDate=getFilterDate(val,'exportStartDate');\n\n var filterEnd=document.getElementById(&quot;exportFilterEnd&quot;).checked;\n var val=document.getElementById(&quot;exportFilterEndBy&quot;).value;\n var endDate=getFilterDate(val,'exportEndDate');\n\n var filterTags=document.getElementById(&quot;exportFilterTags&quot;).checked;\n var tags=document.getElementById(&quot;exportTags&quot;).value;\n\n var filterText=document.getElementById(&quot;exportFilterText&quot;).checked;\n var text=document.getElementById(&quot;exportText&quot;).value;\n\n if (!(filterStart||filterEnd||filterTags||filterText)) {\n alert(&quot;Please set the selection filter&quot;);\n document.getElementById('exportFilterPanel').style.display=&quot;block&quot;;\n return -1;\n }\n if (filterStart&amp;&amp;filterEnd&amp;&amp;(startDate&gt;endDate)) {\n var msg=&quot;starting date/time:\sn&quot;\n msg+=startDate.toLocaleString()+&quot;\sn&quot;;\n msg+=&quot;is later than ending date/time:\sn&quot;\n msg+=endDate.toLocaleString()\n alert(msg);\n return -1;\n }\n\n // scan list and select tiddlers that match all applicable criteria\n var total=0;\n var count=0;\n for (var i=0; i&lt;theList.options.length; i++) {\n // get item, skip non-tiddler list items (section headings)\n var opt=theList.options[i]; if (opt.value==&quot;&quot;) continue;\n // get tiddler, skip missing tiddlers (this should NOT happen)\n var tiddler=store.getTiddler(opt.value); if (!tiddler) continue; \n var sel=true;\n if ( (filterStart &amp;&amp; tiddler.modified&lt;startDate)\n || (filterEnd &amp;&amp; tiddler.modified&gt;endDate)\n || (filterTags &amp;&amp; !matchTags(tiddler,tags))\n || (filterText &amp;&amp; (tiddler.text.indexOf(text)==-1) &amp;&amp; (tiddler.title.indexOf(text)==-1)))\n sel=false;\n opt.selected=sel;\n count+=sel?1:0;\n total++;\n }\n return count;\n}\n//}}}\n\n//{{{\nfunction matchTags(tiddler,cond)\n{\n if (!cond||!cond.trim().length) return false;\n\n // build a regex of all tags as a big-old regex that \n // OR's the tags together (tag1|tag2|tag3...) in length order\n var tgs = store.getTags();\n if ( tgs.length == 0 ) return results ;\n var tags = tgs.sort( function(a,b){return (a[0].length&lt;b[0].length)-(a[0].length&gt;b[0].length);});\n var exp = &quot;(&quot; + tags.join(&quot;|&quot;) + &quot;)&quot; ;\n exp = exp.replace( /(,[\sd]+)/g, &quot;&quot; ) ;\n var regex = new RegExp( exp, &quot;ig&quot; );\n\n // build a string such that an expression that looks like this: tag1 AND tag2 OR NOT tag3\n // turns into : /tag1/.test(...) &amp;&amp; /tag2/.test(...) || ! /tag2/.test(...)\n cond = cond.replace( regex, &quot;/$1\s\s|/.test(tiddlerTags)&quot; );\n cond = cond.replace( /\ssand\ss/ig, &quot; &amp;&amp; &quot; ) ;\n cond = cond.replace( /\ssor\ss/ig, &quot; || &quot; ) ;\n cond = cond.replace( /\ss?not\ss/ig, &quot; ! &quot; ) ;\n\n // if a boolean uses a tag that doesn't exist - it will get left alone \n // (we only turn existing tags into actual tests).\n // replace anything that wasn't found as a tag, AND, OR, or NOT with the string &quot;false&quot;\n // if the tag doesn't exist then /tag/.test(...) will always return false.\n cond = cond.replace( /(\ss|^)+[^\s/\s|&amp;!][^\ss]*/g, &quot;false&quot; ) ;\n\n // make a string of the tags in the tiddler and eval the 'cond' string against that string \n // if it's TRUE then the tiddler qualifies!\n var tiddlerTags = (tiddler.tags?tiddler.tags.join(&quot;|&quot;):&quot;&quot;)+&quot;|&quot; ;\n try { if ( eval( cond ) ) return true; }\n catch( e ) { displayMessage(&quot;Error in tag filter '&quot; + e + &quot;'&quot; ); }\n return false;\n}\n//}}}\n// //===\n\n// // +++[output data formatting]&gt;\n\n// // +++[exportDataToDFWiki()]\n//{{{\nfunction exportDataToDFWiki(theList)\n{\n try{\n // scan export listbox and collect DIVs or XML for selected tiddler content\n var out=[];\n for (var i=0; i&lt;theList.options.length; i++) {\n // get item, skip non-selected items and section headings\n var opt=theList.options[i]; \n if (!opt.selected||(opt.value==&quot;&quot;)) continue;\n // get tiddler, skip missing tiddlers (this should NOT happen)\n var thisTiddler=store.getTiddler(opt.value); \n if (!thisTiddler) continue; \n var tiddlerTitle=store.fetchTiddler(thisTiddler.title).title;\n var modifier=store.fetchTiddler(thisTiddler.title).modifier;\n var modified=store.fetchTiddler(thisTiddler.title).modified;\n var tiddlerContent=store.fetchTiddler(thisTiddler.title).text;\n var tags=store.fetchTiddler(thisTiddler.title).tags;\n\n out.push(convertUnicodeToUTF8(tiddlerTitle));\n out.push(convertUnicodeToUTF8(modifier));\n out.push(modified);\n out.push(convertUnicodeToUTF8(tiddlerContent));\n out.push(convertUnicodeToUTF8(tags));\n }\n return out;\n }\n catch (e) {\n displayMessage(e.description?e.description:e.toString());\n }\n}\n//}}}\n// //===\n\n// // +++[exportDFwikis(): output selected data to local or server]\n//{{{\nfunction exportDFwikis()\n{\n var theList = document.getElementById(&quot;exportList&quot;); if (!theList) return;\n\n // assemble output: \n // [0]: tiddler name\n // [1]: modifier\n // [2]: time modified\n // [3]: tiddler content\n // [4]: tags\n var theData=exportDataToDFWiki(theList);\n var count=theData.length;\n /*displayMessage(theData[0]);\n displayMessage(theData[1]);\n displayMessage(theData[2]);\n displayMessage(theData[3]);\n */\n var i;\n for (i=0; i&lt;count; i=i+5){\n var tiddlerName = theData[i+0];\n var modifier = theData[i+1];\n var modified = theData[i+2];\n var tiddlerContent = theData[i+3];\n var tag = theData[i+4];\n tiddlerContent=tiddlerContent.replace(/&amp;/g, &quot;&amp;amp;&quot;).replace(/&lt;/g,&quot;&amp;lt;&quot;).replace(/&gt;/g, &quot;&amp;gt;&quot;);\n tiddlerContent=tiddlerContent.replace(/&amp;/g, &quot;#|@&quot;);\n exportToMoodle(tiddlerName, modifier, modified, tiddlerContent,tag);\n }\n \n /*var out=[]; var txt=out.concat(&quot;&quot;,theData).join(&quot;\sn&quot;);\n var msg=&quot;&quot;;\n\n var theTarget = document.getElementById(&quot;exportFilename&quot;).value.trim();\n if (!theTarget.length) msg = &quot;A local path/filename is required\sn&quot;;\n if (!msg &amp;&amp; saveFile(theTarget,txt))\n msg=count+&quot; tiddler&quot;+((count!=1)?&quot;s&quot;:&quot;&quot;)+&quot; exported to local file&quot;;\n else if (!msg)\n msg+=&quot;An error occurred while saving to &quot;+theTarget;\n\n clearMessage(); displayMessage(msg,theTarget);*/\n}\n//}}}\n// //===\n\n// // Security functions\n//{{{\n/*****************************************************************************\n * md5.js\n *\n * A JavaScript implementation derived from the RSA Data Security, Inc. MD5\n * Message-Digest Algorithm. See http://cw.oaktree.co.uk/site/legal.html for\n * details.\n *\n * Copyright (C) Paul Johnston 1999 - 2000. Distributed under the LGPL.\n *****************************************************************************/\n\n/* to convert strings to a list of ascii values */\nvar sAscii = &quot; !\s&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;\nvar sAscii = sAscii + &quot;[\s\s]^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;;\n\n/* convert integer to hex string */\nvar sHex = &quot;0123456789ABCDEF&quot;;\nfunction hex(i)\n{\n h = &quot;&quot;;\n for(j = 0; j &lt;= 3; j++)\n {\n h += sHex.charAt((i &gt;&gt; (j * 8 + 4)) &amp; 0x0F) +\n sHex.charAt((i &gt;&gt; (j * 8)) &amp; 0x0F);\n }\n return h;\n}\n\n/* add, handling overflows correctly */\nfunction add(x, y)\n{\n return ((x&amp;0x7FFFFFFF) + (y&amp;0x7FFFFFFF)) ^ (x&amp;0x80000000) ^ (y&amp;0x80000000);\n}\n\n/* MD5 rounds functions */\nfunction R1(A, B, C, D, X, S, T)\n{\n q = add(add(A, (B &amp; C) | ((~B) &amp; D)), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R2(A, B, C, D, X, S, T)\n{\n q = add(add(A, (B &amp; D) | (C &amp; (~D))), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R3(A, B, C, D, X, S, T)\n{\n q = add(add(A, B ^ C ^ D), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R4(A, B, C, D, X, S, T)\n{\n q = add(add(A, C ^ (B | (~D))), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\n/* main entry point */\nfunction calcMD5(sInp) {\n\n /* Calculate length in machine words, including padding */\n wLen = (((sInp.length + 8) &gt;&gt; 6) + 1) &lt;&lt; 4;\n var X = new Array(wLen);\n\n /* Convert string to array of words */\n j = 4;\n for (i = 0; (i * 4) &lt; sInp.length; i++)\n {\n X[i] = 0;\n for (j = 0; (j &lt; 4) &amp;&amp; ((j + i * 4) &lt; sInp.length); j++)\n {\n X[i] += (sAscii.indexOf(sInp.charAt((i * 4) + j)) + 32) &lt;&lt; (j * 8);\n }\n }\n\n /* Append padding bits and length */\n if (j == 4)\n {\n X[i++] = 0x80;\n }\n else\n {\n X[i - 1] += 0x80 &lt;&lt; (j * 8);\n }\n for(; i &lt; wLen; i++) { X[i] = 0; }\n X[wLen - 2] = sInp.length * 8;\n\n /* hard coded initial values */\n a = 0x67452301;\n b = 0xefcdab89;\n c = 0x98badcfe;\n d = 0x10325476;\n\n /* Process each 16 word block in turn */\n for (i = 0; i &lt; wLen; i += 16) {\n aO = a;\n bO = b;\n cO = c;\n dO = d;\n\n a = R1(a, b, c, d, X[i+ 0], 7 , 0xd76aa478);\n d = R1(d, a, b, c, X[i+ 1], 12, 0xe8c7b756);\n c = R1(c, d, a, b, X[i+ 2], 17, 0x242070db);\n b = R1(b, c, d, a, X[i+ 3], 22, 0xc1bdceee);\n a = R1(a, b, c, d, X[i+ 4], 7 , 0xf57c0faf);\n d = R1(d, a, b, c, X[i+ 5], 12, 0x4787c62a);\n c = R1(c, d, a, b, X[i+ 6], 17, 0xa8304613);\n b = R1(b, c, d, a, X[i+ 7], 22, 0xfd469501);\n a = R1(a, b, c, d, X[i+ 8], 7 , 0x698098d8);\n d = R1(d, a, b, c, X[i+ 9], 12, 0x8b44f7af);\n c = R1(c, d, a, b, X[i+10], 17, 0xffff5bb1);\n b = R1(b, c, d, a, X[i+11], 22, 0x895cd7be);\n a = R1(a, b, c, d, X[i+12], 7 , 0x6b901122);\n d = R1(d, a, b, c, X[i+13], 12, 0xfd987193);\n c = R1(c, d, a, b, X[i+14], 17, 0xa679438e);\n b = R1(b, c, d, a, X[i+15], 22, 0x49b40821);\n\n a = R2(a, b, c, d, X[i+ 1], 5 , 0xf61e2562);\n d = R2(d, a, b, c, X[i+ 6], 9 , 0xc040b340);\n c = R2(c, d, a, b, X[i+11], 14, 0x265e5a51);\n b = R2(b, c, d, a, X[i+ 0], 20, 0xe9b6c7aa);\n a = R2(a, b, c, d, X[i+ 5], 5 , 0xd62f105d);\n d = R2(d, a, b, c, X[i+10], 9 , 0x2441453);\n c = R2(c, d, a, b, X[i+15], 14, 0xd8a1e681);\n b = R2(b, c, d, a, X[i+ 4], 20, 0xe7d3fbc8);\n a = R2(a, b, c, d, X[i+ 9], 5 , 0x21e1cde6);\n d = R2(d, a, b, c, X[i+14], 9 , 0xc33707d6);\n c = R2(c, d, a, b, X[i+ 3], 14, 0xf4d50d87);\n b = R2(b, c, d, a, X[i+ 8], 20, 0x455a14ed);\n a = R2(a, b, c, d, X[i+13], 5 , 0xa9e3e905);\n d = R2(d, a, b, c, X[i+ 2], 9 , 0xfcefa3f8);\n c = R2(c, d, a, b, X[i+ 7], 14, 0x676f02d9);\n b = R2(b, c, d, a, X[i+12], 20, 0x8d2a4c8a);\n\n a = R3(a, b, c, d, X[i+ 5], 4 , 0xfffa3942);\n d = R3(d, a, b, c, X[i+ 8], 11, 0x8771f681);\n c = R3(c, d, a, b, X[i+11], 16, 0x6d9d6122);\n b = R3(b, c, d, a, X[i+14], 23, 0xfde5380c);\n a = R3(a, b, c, d, X[i+ 1], 4 , 0xa4beea44);\n d = R3(d, a, b, c, X[i+ 4], 11, 0x4bdecfa9);\n c = R3(c, d, a, b, X[i+ 7], 16, 0xf6bb4b60);\n b = R3(b, c, d, a, X[i+10], 23, 0xbebfbc70);\n a = R3(a, b, c, d, X[i+13], 4 , 0x289b7ec6);\n d = R3(d, a, b, c, X[i+ 0], 11, 0xeaa127fa);\n c = R3(c, d, a, b, X[i+ 3], 16, 0xd4ef3085);\n b = R3(b, c, d, a, X[i+ 6], 23, 0x4881d05);\n a = R3(a, b, c, d, X[i+ 9], 4 , 0xd9d4d039);\n d = R3(d, a, b, c, X[i+12], 11, 0xe6db99e5);\n c = R3(c, d, a, b, X[i+15], 16, 0x1fa27cf8);\n b = R3(b, c, d, a, X[i+ 2], 23, 0xc4ac5665);\n\n a = R4(a, b, c, d, X[i+ 0], 6 , 0xf4292244);\n d = R4(d, a, b, c, X[i+ 7], 10, 0x432aff97);\n c = R4(c, d, a, b, X[i+14], 15, 0xab9423a7);\n b = R4(b, c, d, a, X[i+ 5], 21, 0xfc93a039);\n a = R4(a, b, c, d, X[i+12], 6 , 0x655b59c3);\n d = R4(d, a, b, c, X[i+ 3], 10, 0x8f0ccc92);\n c = R4(c, d, a, b, X[i+10], 15, 0xffeff47d);\n b = R4(b, c, d, a, X[i+ 1], 21, 0x85845dd1);\n a = R4(a, b, c, d, X[i+ 8], 6 , 0x6fa87e4f);\n d = R4(d, a, b, c, X[i+15], 10, 0xfe2ce6e0);\n c = R4(c, d, a, b, X[i+ 6], 15, 0xa3014314);\n b = R4(b, c, d, a, X[i+13], 21, 0x4e0811a1);\n a = R4(a, b, c, d, X[i+ 4], 6 , 0xf7537e82);\n d = R4(d, a, b, c, X[i+11], 10, 0xbd3af235);\n c = R4(c, d, a, b, X[i+ 2], 15, 0x2ad7d2bb);\n b = R4(b, c, d, a, X[i+ 9], 21, 0xeb86d391);\n\n a = add(a, aO);\n b = add(b, bO);\n c = add(c, cO);\n d = add(d, dO);\n }\n return hex(a) + hex(b) + hex(c) + hex(d);\n}\n\nfunction calculateMD5Export() \n{\n var pw = document.getElementById(&quot;exportPW&quot;).value;\n return(calcMD5(pw));\n}\n\nfunction attachMD5Export(hash) \n{\n config.macros.exportDFwikis.username=document.getElementById(&quot;exportID&quot;).value; \n var getUrl = &quot;&amp;user=&quot;+document.getElementById(&quot;exportID&quot;).value;\n getUrl += &quot;&amp;pwd=&quot;+hash.toLowerCase();\n return getUrl;\n}\n//}}}\n\n// // AJAX Functions\n// // +++[GetXmlHttpObject(handler): gets the XMLhttp object]\n//{{{\nfunction GetXmlHttpObject(handler)\n{ \n var objXMLHttp=null;\n if (window.XMLHttpRequest)\n {\n objXMLHttp=new XMLHttpRequest();\n }\n else if (window.ActiveXObject)\n {\n objXMLHttp=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);\n }\n return objXMLHttp;\n}\n\nfunction exportToMoodle(tiddlerName, modifier, modified, tiddlerContent, tag)\n{\n if (config.macros.exportDFwikis.selectedWiki!=&quot;choose a wiki...&quot;)\n {\n if(config.macros.exportDFwikis.selectedUser!=&quot;choose an user...&quot;)\n {\n if (config.macros.exportDFwikis.callNumber!=&quot;0&quot;) //This only happen if we've to call this function more than 1 time\n {\n if (config.macros.exportDFwikis.selectedWikiGroups!=document.getElementById(&quot;exportDFwikiName&quot;).value)\n {\n displayMessage(&quot;The selected wiki has changed. Please log-in.&quot;);\n removeSelect(&quot;exportDFwikiCourse&quot;);\n removeSelect(&quot;exportDFwikiName&quot;);\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n document.getElementById('groupsPanel').style.display='none';\n config.macros.exportDFwikis.callNumber=&quot;0&quot;; \n }\n else if (config.macros.exportDFwikis.selectedCourse!=document.getElementById(&quot;exportDFwikiCourse&quot;).value)\n {\n displayMessage(&quot;The selected course has changed. Please log-in.&quot;);\n removeSelect(&quot;exportDFwikiCourse&quot;);\n removeSelect(&quot;exportDFwikiName&quot;);\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n document.getElementById('groupsPanel').style.display='none';\n config.macros.exportDFwikis.callNumber=&quot;0&quot;; \n } \n }\n \n if (config.macros.exportDFwikis.username!=document.getElementById(&quot;exportID&quot;).value)\n {\n displayMessage(&quot;The user don't exists or has changed. Please log-in.&quot;);\n removeSelect(&quot;exportDFwikiCourse&quot;);\n removeSelect(&quot;exportDFwikiName&quot;);\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n document.getElementById('groupsPanel').style.display='none';\n }\n else\n {\n xmlHttp=GetXmlHttpObject();\n if (xmlHttp==null)\n {\n alert (&quot;Browser does not support HTTP Request&quot;);\n return\n }\n var url=document.getElementById(&quot;exportMoodleServer&quot;).value;\n url+= ((url.charAt(url.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php&quot;;\n var wikiName = document.getElementById(&quot;exportDFwikiName&quot;).value;\n var courseName = document.getElementById(&quot;exportDFwikiCourse&quot;).value;\n var call_number = config.macros.exportDFwikis.callNumber;\n var ownerName = config.macros.exportDFwikis.selectedUser;\n var groupName = config.macros.exportDFwikis.selectedGroup;\n xmlHttp.onreadystatechange=stateExportToMoodle;\n if (typeof(netscape)!=&quot;undefined&quot;) { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n try \n {\n xmlHttp.open(&quot;POST&quot;,url);\n xmlHttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // Needed for the POST method\n if (xmlHttp.overrideMimeType) xmlHttp.overrideMimeType('text/xml');\n xmlHttp.send(&quot;sel=importTiddlers&quot;+attachMD5Export(calculateMD5Export())+&quot;&amp;course=&quot;+courseName+&quot;&amp;wiki=&quot;+wikiName+&quot;&amp;tiddler_title=&quot;+tiddlerName+&quot;&amp;tag=&quot;+tag+&quot;&amp;tiddler_content=&quot;+tiddlerContent+&quot;&amp;call_number=&quot;+call_number+&quot;&amp;ownerName=&quot;+ownerName+&quot;&amp;groupName=&quot;+groupName);\n }\n catch (e) {\n displayMessage(e.description?e.description:e.toString());\n }\n } \n }\n else\n {\n displayMessage(&quot;Impossible to export: The user choose an user... doesn't exists&quot;); \n }\n }\n else\n {\n displayMessage(&quot;Impossible to export: The wiki choose a wiki... doesn't exists&quot;);\n }\n}\n\nfunction getMoodleInfo(sync)\n{ \n //Remove the existent valors of the selects used before\n config.macros.exportDFwikis.callNumber=&quot;0&quot;;\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n removeSelect(&quot;exportDFwikiCourse&quot;);\n removeSelect(&quot;exportDFwikiName&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n document.getElementById('groupsPanel').style.display='none';\n \n //AJAX interaction\n xmlHttp=GetXmlHttpObject();\n \n if (xmlHttp==null)\n {\n alert (&quot;Browser does not support HTTP Request&quot;);\n return\n }\n var url=document.getElementById(&quot;exportMoodleServer&quot;).value;\n url+= ((url.charAt(url.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php&quot;;\n if (sync &amp;&amp; sync==true) xmlHttp.onreadystatechange=stateGetMoodleInfoSync;\n else xmlHttp.onreadystatechange=stateGetMoodleInfo;\n if (typeof(netscape)!=&quot;undefined&quot;) \n { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n try \n {\n xmlHttp.open(&quot;POST&quot;,url);\n xmlHttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // Needed for the POST method\n if (xmlHttp.overrideMimeType) xmlHttp.overrideMimeType('text/xml');\n xmlHttp.send(&quot;sel=getMoodleInfo&quot;+attachMD5Export(calculateMD5Export()));\n }\n catch (e) \n {\n displayMessage(e.description?e.description:e.toString());\n }\n}\n\nfunction continueGettingMoodleInfo(course_short, sync)\n{\n if (course_short!=&quot;choose a course...&quot;)\n {\n if (config.macros.exportDFwikis.username!=document.getElementById(&quot;exportID&quot;).value)\n {\n displayMessage(&quot;The user has changed. Please log-in again.&quot;);\n removeSelect(&quot;exportDFwikiCourse&quot;);\n removeSelect(&quot;exportDFwikiName&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=true;\n document.getElementById(&quot;exportDFwikiCourse&quot;).disabled=true;\n }\n else\n {\n xmlHttp=GetXmlHttpObject();\n if (xmlHttp==null)\n {\n alert (&quot;Browser does not support HTTP Request&quot;);\n return\n }\n var url=document.getElementById(&quot;exportMoodleServer&quot;).value;\n url+= ((url.charAt(url.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php&quot;;\n if (sync &amp;&amp; sync==true) xmlHttp.onreadystatechange=statecontinueGettingMoodleInfoSync;\n else xmlHttp.onreadystatechange=statecontinueGettingMoodleInfo;\n if (typeof(netscape)!=&quot;undefined&quot;) \n { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n try {\n xmlHttp.open(&quot;POST&quot;,url);\n xmlHttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // Needed for the POST method\n if (xmlHttp.overrideMimeType) xmlHttp.overrideMimeType('text/xml');\n xmlHttp.send(&quot;sel=continueGettingMoodleInfo&quot;+attachMD5Export(calculateMD5Export())+&quot;&amp;course=&quot;+course_short);\n }\n catch (e) {\n displayMessage(e.description?e.description:e.toString());\n }\n } \n }\n}\n\nfunction stateExportToMoodle() \n{\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n { \n if (typeof(netscape)!=&quot;undefined&quot;) { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var info =new Array(xml.getElementsByTagName('items').length);\n for (i = 0; i &lt; xml.getElementsByTagName('items').length; i++)\n {\n var item = xml.getElementsByTagName('response')[0];\n var id = item.getElementsByTagName('items')[i].firstChild.data;\n info[i]=id;\n }\n \n //We save the current valors of selects and inputs to avoid in invalid accesses\n config.macros.exportDFwikis.username=document.getElementById(&quot;exportID&quot;).value;\n config.macros.exportDFwikis.selectedWikiGroups=document.getElementById(&quot;exportDFwikiName&quot;).value;\n config.macros.exportDFwikis.selectedCourse=document.getElementById(&quot;exportDFwikiCourse&quot;).value;\n \n var option=info[0];\n if (option==&quot;0&quot;) //error\n {\n displayMessage(info[1]);\n document.getElementById('groupsPanel').style.display='none';\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n config.macros.exportDFwikis.callNumber=&quot;0&quot;;\n config.macros.exportDFwikis.transition=&quot;no&quot;;\n }\n else if (option==&quot;1&quot;) //warning\n {\n displayMessage(info[1]);\n displayMessage(info[2]);\n document.getElementById('groupsPanel').style.display='none';\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n config.macros.exportDFwikis.callNumber=&quot;0&quot;;\n config.macros.exportDFwikis.transition=&quot;no&quot;; \n }\n else if (option==&quot;2&quot;) //correct\n {\n displayMessage(info[1]);\n document.getElementById('groupsPanel').style.display='none';\n removeSelect(&quot;groupbox&quot;);\n removeSelect(&quot;userbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=true;\n document.getElementById(&quot;userbox&quot;).disabled=true;\n config.macros.exportDFwikis.callNumber=&quot;0&quot;;\n config.macros.exportDFwikis.transition=&quot;no&quot;;\n }\n else if (option==&quot;3&quot;) //teacher gmode=0 &amp; smode=1 or smode=2\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;userbox&quot;);\n addToSelect(&quot;choose an user...&quot;,&quot;userbox&quot;);\n document.getElementById(&quot;userbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;userbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;;\n }\n else if (option==&quot;4&quot;)// teacher gmode={1,2} and smode=0\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;groupbox&quot;);\n addToSelect(&quot;choose a group...&quot;,&quot;groupbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;groupbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;; \n }\n else if (option==&quot;5&quot;)//teacher in gmode={1,2} &amp; smode={1,2}\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;groupbox&quot;);\n addToSelect(&quot;choose a group...&quot;,&quot;groupbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;groupbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;1&quot;;\n config.macros.exportDFwikis.transition=&quot;yes&quot;;\n }\n else if (option==&quot;6&quot;)//teacher continuing gmode={1,2} &amp; smode={1,2}\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;userbox&quot;);\n addToSelect(&quot;choose an user...&quot;,&quot;userbox&quot;);\n document.getElementById(&quot;userbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;userbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;;\n }\n else if (option==&quot;7&quot;)// student gmode={1,2} and smode=0\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;groupbox&quot;);\n addToSelect(&quot;choose a group...&quot;,&quot;groupbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;groupbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;; \n }\n else if (option==&quot;8&quot;)// student gmode={1,2} and smode=1\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;groupbox&quot;);\n addToSelect(&quot;choose a group...&quot;,&quot;groupbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;groupbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;; \n }\n else if (option==&quot;9&quot;)//teacher in gmode={1,2} &amp; smode=1\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;groupbox&quot;);\n addToSelect(&quot;choose a group...&quot;,&quot;groupbox&quot;);\n document.getElementById(&quot;groupbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;groupbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;1&quot;;\n config.macros.exportDFwikis.transition=&quot;yes&quot;;\n }\n else if (option==&quot;10&quot;)//teacher continuing gmode={1,2} &amp; smode=2\n {\n document.getElementById('groupsPanel').style.display='block';\n displayMessage(info[1]);\n removeSelect(&quot;userbox&quot;);\n addToSelect(&quot;choose an user...&quot;,&quot;userbox&quot;);\n document.getElementById(&quot;userbox&quot;).disabled=false;\n for (i=2;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;userbox&quot;);\n }\n config.macros.exportDFwikis.callNumber=&quot;2&quot;;\n }\n } \n}\n\nfunction stateGetMoodleInfo() \n{\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n { \n if (typeof(netscape)!=&quot;undefined&quot;) { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var info =new Array(xml.getElementsByTagName('items').length);\n for (i = 0; i &lt; xml.getElementsByTagName('items').length; i++)\n {\n var item = xml.getElementsByTagName('response')[0];\n var id = item.getElementsByTagName('items')[i].firstChild.data;\n info[i]=id;\n }\n var option=info[0];\n config.macros.exportDFwikis.info=option;\n removeSelect(&quot;exportDFwikiCourse&quot;);\n if (option==&quot;1&quot;)\n {\n addToSelect(&quot;choose a course...&quot;,&quot;exportDFwikiCourse&quot;);\n for (i=1;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;exportDFwikiCourse&quot;);\n } \n }\n continueInfo();\n } \n}\n\nfunction stateGetMoodleInfoSync() \n{\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n { \n if (typeof(netscape)!=&quot;undefined&quot;) { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var info =new Array(xml.getElementsByTagName('items').length);\n for (i = 0; i &lt; xml.getElementsByTagName('items').length; i++)\n {\n var item = xml.getElementsByTagName('response')[0];\n var id = item.getElementsByTagName('items')[i].firstChild.data;\n info[i]=id;\n }\n var option=info[0];\n config.macros.exportDFwikis.info=option;\n removeSelect(&quot;exportDFwikiCourse&quot;);\n if (option==&quot;1&quot;)\n {\n addToSelect(&quot;choose a course...&quot;,&quot;exportDFwikiCourse&quot;);\n for (i=1;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;exportDFwikiCourse&quot;);\n }\n \n }\n continueInfo();\n continueSyncCourses(1);\n } \n}\n\nfunction statecontinueGettingMoodleInfo() \n{\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n { \n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n {\n if (typeof(netscape)!=&quot;undefined&quot;) \n { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var info =new Array(xml.getElementsByTagName('items').length);\n for (i = 0; i &lt; xml.getElementsByTagName('items').length; i++)\n {\n var item = xml.getElementsByTagName('response')[0];\n var id = item.getElementsByTagName('items')[i].firstChild.data;\n info[i]=id;\n }\n var option=info[0];\n config.macros.exportDFwikis.info=option;\n removeSelect(&quot;exportDFwikiName&quot;);\n if (option==&quot;1&quot;)\n {\n addToSelect(&quot;choose a course...&quot;,&quot;exportDFwikiName&quot;);\n for (i=1;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;exportDFwikiName&quot;);\n }\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=false; \n } \n }\n } \n}\n\nfunction statecontinueGettingMoodleInfoSync() \n{\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;)\n { \n if (typeof(netscape)!=&quot;undefined&quot;) \n { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var info =new Array(xml.getElementsByTagName('items').length);\n for (i = 0; i &lt; xml.getElementsByTagName('items').length; i++)\n {\n var item = xml.getElementsByTagName('response')[0];\n var id = item.getElementsByTagName('items')[i].firstChild.data;\n info[i]=id;\n }\n var option=info[0];\n config.macros.exportDFwikis.info=option;\n removeSelect(&quot;exportDFwikiName&quot;);\n if (option==&quot;1&quot;)\n {\n addToSelect(&quot;choose a wiki...&quot;,&quot;exportDFwikiName&quot;);\n for (i=1;i&lt;info.length;i++)\n {\n addToSelect(info[i],&quot;exportDFwikiName&quot;);\n }\n document.getElementById(&quot;exportDFwikiName&quot;).disabled=false; \n } \n continueSyncWikis(1);\n } \n}\n//}}}\n// //===</div>
<div tiddler="ImportDFwikisPanel" modifier="uri" modified="200610251012" created="200512280426" tags="importexport includeNew">&lt;&lt;importDFwikis inline&gt;&gt;</div>
<div tiddler="ImportDFwikisPlugin" modifier="uri" modified="200612211125" created="200512271920" tags="systemConfig dfWikiTeam">/***\n|''Name:''|ImportDFwikisPlugin|\n|''Author:''|[[Oriol Nieto|http://enochrooted.blogspot.com/]] , [[Alejandro Moreno|http://vdemarvvv.blogspot.com/]], DÃ­dac Calventus &amp; [[Ludo( Marc Alier)|http://www.lsi.upc.edu/~malier/]]|\n|''Another production of:''|[[dfwikiteam|http://morfeo.upc.es/crom/]] [[Universitat PolitÃ¨cnica de Catalunya|http://www.upc.edu]]|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/ as described in the license document http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html#%5B%5BLicense%20And%20Legal%20Aspects%5D%5D]]|\n|''~CoreVersion:''|2.1.2|\n|''~PluglinVersion:''|1.4|\n|''Download latest version from''|http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html#ImportDFwikisPlugin|\n|''Moodle wiki server side files and docs''|http://morfeo.upc.edu/crom|\n\n&lt;&lt;importDFwikis inline&gt;&gt;\n\nThis plugin lets you import pages of dfwikis from a moodle 1.6.X with the nwiki module installed.\n\nIt's ''strongly recommended'' that you use ''Firefox'' (or any netscape based navigator) instead of IE in order to avoid security problems.\n\nIf anyway you want to use IE, you'll have to turn down all security parameters.\n\nYou can import pages using an interactive control panel, selecting the wiki and then the page to import, or typing the complete URL of the wiki page, both methods with prompting for skip, rename, merge or replace actions when importing pages that match existing tiddler titles. Generates a detailed report of import 'history' in ImportedTiddlers.\nYou can import immediately (without panel interaction) the page you want typping the complete URL that appears in your browser while viewing this page in your moodle installation (direct import use always the ImportTiddlersToDFwikisPluglin parser and ''only works with wikis without groups'').\nYou can enable or disable the use of the ImportTiddlersToDFwikisPluglin parser. If you disable that option, is recommended to have installed previously the [[MediaWikiFotmatterPluglin|http://martinswiki.com/prereleases.html#MediaWikiFormatterPlugin]] and the [[HTMLFormattingPluglin|http://www.TiddlyTools.com/#HTMLFormattingPlugin]] to visualize correctly the imported content.\n\nIMPORTANT: Don't disable/enable the ImportTiddlersToDFwikisPluglin parser after clicking &quot;open pages&quot;. Enable/Disable it at the beginning of the interactive process.\n\n! credits \nThis plugin is a derivative of http://www.TiddlyTools.com/#ImportTiddlersPlugin, created by Eric L.Shulman and/or ELS Design Studios, and is subject to all terms and conditions as described in http://www.TiddlyTools.com/#LegalStatements as well as all other terms and conditions as described in this document.\n\n!!!!! Test site\nYou can test this plugin getting wiki pages from our server http://morfeo.upc.edu/crom as Guest user\n\n!!!!!Interactive interface\n&lt;&lt;&lt;\n{{{&lt;&lt;importDFwikis&gt;&gt;}}}\ncreates &quot;import dfwikis&quot; link. click to show/hide import control panel\n\n{{{&lt;&lt;importDFwikis inline&gt;&gt;}}}\ncreates import control panel directly in tiddler content\n\n\n\nThere are two ways available in this pluglin to import dfwikis.\n\n1. Introducing the complete URL of the page wiki you're going to import.\n2. Using the interactive process.\n\nIf you want to use the first method you only have to type the complete URL of the wiki you want to import, your username and password in moodle and click ''[import now!]''\n\nIf you want to import using the second method follow the instructions written below.\nType the source of your moodle installation in you server, your username and your password and press ''[open wikis]'' to get a list of all the existent wikis in your moodles installation with the appropiate access restricctions.\nThen select the wiki that you want to import from and press ''[open pages]'' to get a list of the pages included in the wiki.\nSelect one or more pages from the listbox (hold CTRL or SHIFT while clicking to add/remove the highlight from individual list items). You can press ''[select all]'' to quickly highlight all pages titles in the list. Use the ''[-]'', ''[+]'', or ''[=]'' links to adjust the listbox size so you can view more (or less) pages titles at one time. When you have chosen the pages you want to import and entered any extra tags, press ''[import]'' to begin copying them to the current TiddlyWiki document.\n\n''select: all, new, changes, or differences''\n\nYou can click on ''all'', ''new'', ''changes'', or ''differences'' to automatically select a subset of pages from the list. This makes it very quick and easy to find and import just the updated pages you are interested in:\n&gt;''&quot;all&quot;'' selects ALL pages from the import source document, even if they have not been changed.\n&gt;''&quot;new&quot;'' selects only pages that are found in the import source wiki, but do not yet exist in the destination document\n&gt;''&quot;changes&quot;'' selects only pages that exist in both documents but that are newer in the source wiki\n&gt;''&quot;differences&quot;'' selects all new and existing pages that are different from the destination document (even if destination pages is newer)\n\n''Import Tagging:''\n\nPages that have been imported and transformed in Tiddlers can be automatically tagged, so they will be easier to find later on, after they have been added to your document. New tags are entered into the &quot;add tags&quot; input field, and then //added// to the existing tags for each tiddler as it is imported.\n\n''Skip, Rename, Merge, or Replace:''\n\nWhen importing a page whose title is identical to one that already exists, the import process pauses and the page title is displayed in an input field, along with four push buttons: ''[skip]'', ''[rename]'', ''[merge]'' and ''[replace]''.\n\nTo bypass importing this page, press ''[skip]''. To import the page with a different name (so that both the tiddlers will exist when the import is done), enter a new title in the input field and then press ''[rename]''. Press ''[merge]'' to combine the content from both pages into a single tiddler. Press ''[replace]'' to overwrite the existing page with the imported one, discarding the previous tiddler content.\n\n//Note: if both the title ''and'' modification date/////time match, the imported page is assumed to be identical to the existing one, and will be automatically skipped (i.e., not imported) without asking.//\n\n''Import Report History''\n\nWhen pages are imported, a report is generated into ImportedTiddlers, indicating when the latest import was performed, the number of pages successfully imported, from what location, and by whom. It also includes a list with the title, date and author of each tiddler that was imported.\n\nWhen the import process is completed, the ImportedTiddlers report is automatically displayed for your review. If more pages are subsequently imported, a new report is //added// to ImportedTiddlers, above the previous report (i.e., at the top of the tiddler), so that a reverse-chronological history of imports is maintained.\n\nIf a cumulative record is not desired, the ImportedTiddlers report may be deleted at any time. A new ImportedTiddlers report will be created the next time pages are imported.\n\nNote: You can prevent the ImportedTiddlers report from being generated for any given import activity by clearing the &quot;create a report&quot; checkbox before beginning the import processing.\n\n\n''label:text'' and ''prompt:text''\n&gt;defines link text and tooltip (prompt) that can be clicked to trigger the load tiddler processing. If a label is NOT provided, then no link is created and loadDFwikis() is executed whenever the containing tiddler is rendered.\n''filter'' (optional) determines which tiddlers will be automatically selected for importing. Use one of the following keywords:\n&gt;''&quot;all&quot;'' retrieves ALL tiddlers from the import source document, even if they have not been changed.\n&gt;''&quot;new&quot;'' retrieves only tiddlers that are found in the import source document, but do not yet exist in the destination document\n&gt;''&quot;changes&quot;'' retrieves only tiddlers that exist in both documents for which the import source tiddler is newer than the existing tiddler\n&gt;''&quot;updates&quot;'' retrieves both ''new'' and ''changed'' tiddlers (this is the default action when none is specified)\n&gt;''&quot;tiddler:~TiddlerName&quot;'' retrieves only the specific tiddler named in the parameter.\n&gt;''&quot;tag:text&quot;'' retrieves only the tiddlers tagged with the indicated text.\n''source'' (required) is the location of the imported document. It can be either a local document path/filename in whatever format your system requires, or a remote web location (starting with &quot;http://&quot; or &quot;https://&quot;)\n&gt;use the keyword ''ask'' to prompt for a source location whenever the macro is invoked\n''&quot;quiet&quot;'' (optional)\n&gt;supresses all status message during the import processing (e.g., &quot;opening local file...&quot;, &quot;found NN tiddlers...&quot; etc). Note that if ANY tiddlers are actualy imported, a final information message will still be displayed (along with the ImportedTiddlers report), even when 'quiet' is specified. This ensures that changes to your document cannot occur without any visible indication at all.\n''&quot;confirm&quot;'' (optional)\n&gt;adds interactive confirmation. A browser message box (OK/Cancel) is displayed for each tiddler that will be imported, so that you can manually bypass any tiddlers that you do not want to import.\n&lt;&lt;&lt;\n!!!!!Installation\n&lt;&lt;&lt;\n1. copy/paste the following tiddlers into your document:\n ''ImportDFwikisPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)\n\n2. Use ''ImportTiddlersPluglin''\n\ncreate/edit ''SideBarOptions'': (sidebar menu items) \n^^Add &quot;&lt; &lt; ImportDFwikis &gt; &gt;&quot; macro^^\n\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.12.09 [1.4]'' \n* Compatible with wiki with groups\n''2006.11.27 [1.3]'' \n* Enable/Disable the ImportDfwikisPluglin parser\n''2006.11.01 [1.2]'' \n* ISO 8859 1Wikis compatible with UTF-8 Tiddlywikis.\n* More accessible interface. Guest enable/disable. Direct import enable/disable. Tags text clarified.\n''2006.11.01 [1.1]'' \n* Import wikipage from URL \n* Access control implemented. Username and Password protection and logging into Moodle server.\n''2006.10.22 [1.0]'' \n* Demonstration release. Only imports from wikis opened to guest user in the Moodle Server\n&lt;&lt;&lt;\n\n!!!!!Code\n***/\n// // ''MACRO DEFINITION''\n//{{{\n// Version\nversion.extensions.importDFwikis = {major: 3, minor: 0, revision: 8, date: new Date(2006,10,12)};\n\n// IE needs explicit global scoping for functions/vars called from browser events\nwindow.onClickImportDFwikiButton=onClickImportDFwikiButton;\nwindow.refreshImportDFwikiList=refreshImportDFwikiList;\n\n// default cookie/option values\nif (!config.options.chkimportDFwikiReport) config.options.chkimportDFwikiReport=true;\n\nconfig.macros.importDFwikis = { };\nconfig.macros.importDFwikis = {\n label: &quot;import dfwikis&quot;,\n prompt: &quot;Copy dfwikis from another document&quot;,\n foundMsg: &quot;Found %0 items in %1&quot;,\n countMsg: &quot;%0 items selected for import&quot;,\n importedMsg: &quot;Imported %0 of %1 items from %2&quot;,\n src: &quot;&quot;, // URL of moodle to import (retrieved from MoodleSource tiddler)\n inbound: null, // hash-indexed array of items from other document\n newTags: &quot;&quot;, // text of tags added to imported items\n addTags: true, // add new tags to imported items\n listsize: 8, // # of lines to show in imported tiddler list\n importTags: true, // include tags from remote source document when importing a tiddler\n keepTags: true, // retain existing tags when replacing a tiddler\n index: -1, // current processing index in import list\n sort: &quot;&quot;, // sort order for imported tiddler listbox\n parser: 1\n};\n\nconfig.macros.importDFwikis.handler = function(place,macroName,params) {\n if (!config.macros.loadDFwikis.handler)\n return;\n if (!params[0]) // LINK TO FLOATING PANEL\n createTiddlyButton(place,this.label,this.prompt,onClickImportDFwikiMenu);\n else if (params[0]==&quot;inline&quot;) {// // INLINE TIDDLER CONTENT\n createImportDFwikiPanel(place);\n document.getElementById(&quot;dfwikiPanel&quot;).style.position=&quot;static&quot;;\n document.getElementById(&quot;dfwikiPanel&quot;).style.display=&quot;block&quot;;\n }\n else config.macros.loadDFwikis.handler(place,macroName,params); // FALLBACK: PASS TO loadDFwikis\n}\n//}}}\n\n// // ''INTERFACE DEFINITION''\n\n// // Handle link click to create/show/hide control panel\n//{{{\nfunction onClickImportDFwikiMenu(e)\n{\n if (!e) var e = window.event;\n var parent=resolveTarget(e).parentNode;\n var panel = document.getElementById(&quot;dfwikiPanel&quot;);\n if (panel==undefined || panel.parentNode!=parent)\n panel=createImportDFwikiPanel(parent);\n var isOpen = panel.style.display==&quot;block&quot;;\n if(config.options.chkAnimate)\n anim.startAnimating(new Slider(panel,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));\n else\n panel.style.display = isOpen ? &quot;none&quot; : &quot;block&quot; ;\n e.cancelBubble = true;\n if (e.stopPropagation) e.stopPropagation();\n return(false);\n}\n//}}}\n\n// // Create control panel: HTML, CSS\n//{{{\nfunction createImportDFwikiPanel(place) {\n var panel=document.getElementById(&quot;dfwikiPanel&quot;);\n if (panel) { panel.parentNode.removeChild(panel); }\n setStylesheet(config.macros.importDFwikis.css,&quot;importDFwikis&quot;);\n panel=createTiddlyElement(place,&quot;span&quot;,&quot;dfwikiPanel&quot;,null,null)\n panel.innerHTML=config.macros.importDFwikis.html;\n refreshImportDFwikiList();\n var siteURL=store.getTiddlerText(&quot;MoodleSource&quot;); if (!siteURL) siteURL=&quot;&quot;;\n document.getElementById(&quot;importSourceURL&quot;).value=siteURL;\n config.macros.importDFwikis.src=siteURL;\n return panel;\n}\n//}}}\n\n// // CSS\n//{{{\nconfig.macros.importDFwikis.css = '\s\n#dfwikiPanel {\s\n display: none; position:absolute; z-index:11; width:35em; right:105%; top:3em;\s\n background-color: #eee; color:#000; font-size: 8pt; line-height:110%;\s\n border:1px solid black; border-bottom-width: 3px; border-right-width: 3px;\s\n padding: 0.5em; margin:0em; -moz-border-radius:1em;\s\n}\s\n#dfwikiPanel a, #dfwikiPanel td a { color:#009; display:inline; margin:0px; padding:1px; }\s\n#dfwikiPanel table { width:100%; border:0px; padding:0px; margin:0px; font-size:8pt; line-height:110%; background:transparent; }\s\n#dfwikiPanel tr { border:0px;padding:0px;margin:0px; background:transparent; }\s\n#dfwikiPanel td { color:#000; border:0px;padding:0px;margin:0px; background:transparent; }\s\n#dfwikiPanel select { width:98%;margin:0px;font-size:8pt;line-height:110%;}\s\n#dfwikiPanel input { width:98%;padding:0px;margin:0px;font-size:8pt;line-height:110%}\s\n#dfwikiPanel input#importSourceURL { width:75%;padding:1px;margin:0px;font-size:8pt;line-height:110%}\s\n#dfwikiPanel input#moodleUserName { width:90%;padding:0px;margin-right:8px;font-size:8pt;line-height:110%}\s\n#dfwikiPanel input#moodlePwd { width:90%;padding:0px;margin:0px;font-size:8pt;line-height:110%}\s\n#dfwikiPanel .box { border:1px solid black; padding:3px; margin-bottom:5px; background:#f8f8f8; -moz-border-radius:5px;}\s\n#dfwikiPanel .topline { border-top:2px solid black; padding-top:3px; margin-bottom:5px; }\s\n#dfwikiPanel .rad { width:auto; }\s\n#dfwikiPanel .chk { width:auto; margin:1px;border:0; }\s\n#dfwikiPanel .btn { width:auto; }\s\n#dfwikiPanel .btn1 { width:98%; }\s\n#dfwikiPanel .btn2 { width:48%; }\s\n#dfwikiPanel .btn3 { width:32%; }\s\n#dfwikiPanel .btn4 { width:24%; }\s\n#dfwikiPanel .btn5 { width:19%; }\s\n#dfwikiPanel .ImportDFwikiButton { padding: 0em; margin: 0px; font-size:8pt; }\s\n#dfwikiPanel .importListButton { padding:0em 0.25em 0em 0.25em; color: #000000; display:inline }\s\n#importCollisionDFwikiPanel { display:none; margin:0.5em 0em 0em 0em; }\s\n#importNonDirectPanelUp { display:block; margin:0em 0em 0em 0em; }\s\n#importNonDirectPanelDown { display:block; margin:0em 0em 0em 0em; }\s\n';\n//}}}\n\n// // HTML \n//{{{\nconfig.macros.importDFwikis.html = '\s\n&lt;!-- source and report --&gt;\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n import from a moodle based web\s\n&lt;/td&gt;&lt;td align=right&gt;\s\n &lt;input type=checkbox class=&quot;chk&quot; id=&quot;chkimportDFwikiReport&quot; checked\s\n onClick=&quot;config.options[\s'chkimportDFwikiReport\s']=this.checked;&quot;&gt; create a report\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;!--panel--&gt;\s\n\s\n&lt;!-- import from http server --&gt;\s\n&lt;div id=&quot;importHTTPPanel&quot; style=&quot;display:block;margin-bottom:5px;margin-top:5px;padding-top:3px;border-top:1px solid #999;text-align: center;&quot;&gt;\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n remote moodle URL:&lt;br&gt;\s\n&lt;/td&gt;&lt;td align=right&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;importSourceURL&quot; onfocus=&quot;this.select()&quot; value=&quot;SiteUrl&quot;\s\n onKeyUp=&quot;config.macros.importDFwikis.src=this.value&quot;\s\n onChange=&quot;config.macros.importDFwikis.src=this.value;&quot;&gt;\s\n&lt;input type=button id=&quot;importImmediately&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;import now!&quot; disabled\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td width=&quot;40%&quot; align=left&gt;\s\n username&lt;br&gt;\s\n &lt;input type=&quot;text&quot; id=&quot;moodleUserName&quot; onfocus=&quot;this.select()&quot; value=&quot;&quot; size=&quot;10&quot;\s\n onKeyUp=&quot;&quot;\s\n onChange=&quot;&quot;&gt;\s\n&lt;/td&gt;&lt;td width=&quot;40%&quot; align=left&gt;\s\n password&lt;br&gt;\s\n &lt;input type=&quot;password&quot; id=&quot;moodlePwd&quot; onfocus=&quot;this.select()&quot; value=&quot;&quot; size=&quot;10&quot;\s\n onKeyUp=&quot;&quot;\s\n onChange=&quot;&quot;&gt;\s\n&lt;/td&gt;&lt;td width=&quot;20%&quot; align=center&gt;\s\n developed by\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td width=&quot;45%&quot; align=left&gt;\s\n &lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;guestLoginCheck&quot; \s\n onClick=&quot;enableGuestLogin()&quot;&gt;login as guest&lt;br&gt;\s\n &lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;useParserCheck&quot; checked \s\n onClick=&quot;useParser()&quot;&gt;use ImportDFwikis parser&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;35%&quot; align=left&gt;\s\n &lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;importImmediatelyCheck&quot; \s\n onClick=&quot;enableDisableImportImmediately()&quot;&gt; enable direct import&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;20%&quot; align=center&gt;\s\n &lt;a href=&quot;http://morfeo.upc.es/crom/&quot;&gt;\s\n &lt;img src=&quot;http://img294.imageshack.us/img294/8712/dfwikiteamie8.jpg&quot;&gt;\s\n &lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;div id=&quot;importNonDirectPanelUp&quot;&gt;\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n select:\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectAll&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;select all tiddlers&quot;&gt;\s\n &amp;nbsp;all&amp;nbsp;&lt;/a&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectNew&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;select tiddlers not already in destination document&quot;&gt;\s\n &amp;nbsp;added&amp;nbsp;&lt;/a&gt; \s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectChanges&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;select tiddlers that have been updated in source document&quot;&gt;\s\n &amp;nbsp;changes&amp;nbsp;&lt;/a&gt; \s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectDifferences&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;select tiddlers that have been added or are different from existing tiddlers&quot;&gt;\s\n &amp;nbsp;differences&amp;nbsp;&lt;/a&gt; \s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importToggleFilter&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;show/hide selection filter&quot;&gt;\s\n &amp;nbsp;filter&amp;nbsp;&lt;/a&gt; \s\n&lt;/td&gt;&lt;td align=right&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListSmaller&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;reduce list size&quot;&gt;\s\n &amp;nbsp;&amp;#150;&amp;nbsp;&lt;/a&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListLarger&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;increase list size&quot;&gt;\s\n &amp;nbsp;+&amp;nbsp;&lt;/a&gt;\s\n &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListMaximize&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot; title=&quot;maximize/restore list size&quot;&gt;\s\n &amp;nbsp;=&amp;nbsp;&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;\s\n&lt;select id=&quot;importList&quot; size=8 multiple\s\n onchange=&quot;setTimeout(\s'refreshImportDFwikiList(\s'+this.selectedIndex+\s')\s',1)&quot;&gt;\s\n &lt;!-- NOTE: delay refresh so list is updated AFTER onchange event is handled --&gt;\s\n&lt;/select&gt;\s\ntags:&lt;br&gt;\s\n&lt;input type=text id=&quot;txtNewTags&quot; size=15 onKeyUp=&quot;config.macros.importDFwikis.newTags=this.value&quot; autocomplete=off&gt;\s\n&lt;div id=&quot;importNonDirectPanelDown&quot;&gt;\s\n&lt;div align=center&gt;\s\n &lt;input type=button id=&quot;importOpenWikis&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;open wikis&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importOpenPages&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;open pages&quot; disabled=&quot;true&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importStart&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;import&quot; disabled=&quot;true&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importClose&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;close&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n&lt;/div&gt;\s\n&lt;/div&gt;\s\n&lt;div id=&quot;importCollisionDFwikiPanel&quot;&gt;\s\n tiddler already exists:\s\n &lt;input type=text id=&quot;importNewTitle&quot; size=15 autocomplete=off&quot;&gt;\s\n &lt;div align=center&gt;\s\n &lt;input type=button id=&quot;importSkip&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;skip&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importRename&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;rename&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importMerge&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;merge&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;input type=button id=&quot;importReplace&quot; class=&quot;ImportDFwikiButton&quot; style=&quot;width:23%&quot; value=&quot;replace&quot;\s\n onclick=&quot;onClickImportDFwikiButton(this)&quot;&gt;\s\n &lt;/div&gt;\s\n&lt;/div&gt;\s\n';\n//}}}\n\n// // Control interactions\n//{{{\nfunction useParser()\n{\n if (config.macros.importDFwikis.parser==1) config.macros.importDFwikis.parser=0;\n else config.macros.importDFwikis.parser=1;\n} \n\nfunction enableDisableImportImmediately() \n{\n if(!document.getElementById('importImmediatelyCheck').checked)\n {\n document.getElementById('importImmediately').disabled=true;\n document.getElementById('importNonDirectPanelUp').style.display='block';\n document.getElementById('importNonDirectPanelDown').style.display='block';\n }\n\n else\n {\n document.getElementById('importImmediately').disabled=false;\n document.getElementById('importNonDirectPanelUp').style.display='none';\n document.getElementById('importNonDirectPanelDown').style.display='none';\n }\n}\n\nfunction enableGuestLogin() \n{\n if(document.getElementById('guestLoginCheck').checked)\n {\n document.getElementById('moodleUserName').value=&quot;guest&quot;;\n document.getElementById('moodleUserName').disabled=true;\n document.getElementById('moodlePwd').value=&quot;guest&quot;;\n document.getElementById('moodlePwd').disabled=true;\n }\n\n else\n {\n document.getElementById('moodleUserName').disabled=false;\n document.getElementById('moodlePwd').disabled=false;\n }\n}\n\nfunction onClickImportDFwikiButton(which)\n{\n // DEBUG alert(which.id);\n var theList = document.getElementById('importList');\n if (!theList) return;\n var thePanel = document.getElementById('dfwikiPanel');\n var theCollisionPanel = document.getElementById('importCollisionDFwikiPanel');\n var theNewTitle = document.getElementById('importNewTitle');\n var count=0;\n switch (which.id)\n {\n case 'fileImportSource':\n case 'importImmediately':\n config.macros.importDFwikis.inbound=null; // clear the imported tiddler buffer\n refreshImportDFwikiList(); // reset/resize the listbox\n if (config.macros.importDFwikis.src==&quot;&quot;) break;\n src_backup=config.macros.importDFwikis.src; //backup of the original source\n \n // This sentences erase the group info. If you want to have the groups info just delete the sentences below.\n ///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n var erase_till=config.macros.importDFwikis.src.lastIndexOf(&quot;&amp;gid&quot;);\n if (erase_till==&quot;-1&quot;) erase_till=config.macros.importDFwikis.src.length;\n var erased_group_src=config.macros.importDFwikis.src.substr(0,erase_till);\n config.macros.importDFwikis.src=erased_group_src\n ///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n \n var src_backup_without_groups = config.macros.importDFwikis.src; //backup of the original source without groups\n var lastIndex=config.macros.importDFwikis.src.lastIndexOf(&quot;/mod/wiki/view.php?&quot;); \n var source=config.macros.importDFwikis.src.substr(0,lastIndex); //we need this source to connect with the webservice\n var restant=src_backup_without_groups.length - source.length - 19; //19 are the chars in &quot;/mod/wiki/view.php?&quot;\n var parameters=src_backup_without_groups.substr(-restant,restant);\n var number_of_parameters = 0;\n for (var i=0; i&lt;parameters.length; i++)\n {\n if (parameters.charAt(i)==&quot;=&quot;) number_of_parameters++;\n }\n if (number_of_parameters==&quot;1&quot;)\n {\n //Put the course--&gt;id in the URL as &quot;id&quot;\n lastIndex=parameters.lastIndexOf(&quot;=&quot;);\n restant=parameters.length - lastIndex;\n var id=parameters.substr(-restant+1,restant);\n config.macros.importDFwikis.src=source+&quot;/mod/wiki/webservicelib.php?sel=urlManagement&amp;id=&quot;+id;\n config.macros.importDFwikis.src += attachMD5(calculateMD5()); \n }\n else if (number_of_parameters==&quot;2&quot;)\n {\n //Put the course--&gt;id in the URL as &quot;id&quot; and the pagename as &quot;page&quot;\n lastIndex=parameters.lastIndexOf(&quot;=&quot;);\n restant=parameters.length - lastIndex;\n var page=parameters.substr(-restant+1,restant);\n lastIndex=parameters.lastIndexOf(&quot;&amp;page=&quot;);\n parameters=parameters.substr(0,lastIndex);\n lastIndex=parameters.lastIndexOf(&quot;=&quot;);\n restant=parameters.length - lastIndex;\n var id=parameters.substr(-restant+1,restant);\n config.macros.importDFwikis.src=source+&quot;/mod/wiki/webservicelib.php?sel=urlManagement&amp;id=&quot;+id+&quot;&amp;page=&quot;+page;\n config.macros.importDFwikis.src += attachMD5(calculateMD5());\n }\n else if (number_of_parameters==&quot;3&quot;)\n {\n //Put the course--&gt;id in the URL as &quot;id&quot; and the pagename as &quot;page&quot;. It's a filter for the &quot;name parameter\n //http://localhost/moodle16/mod/wiki/view.php?id=11&amp;name=dfwikipage&amp;page=Segunda+Wiki1\n lastIndex=parameters.lastIndexOf(&quot;=&quot;);\n restant=parameters.length - lastIndex;\n var page=parameters.substr(-restant+1,restant);\n lastIndex=parameters.lastIndexOf(&quot;&amp;name=&quot;);\n parameters=parameters.substr(0,lastIndex);\n lastIndex=parameters.lastIndexOf(&quot;=&quot;);\n restant=parameters.length - lastIndex;\n var id=parameters.substr(-restant+1,restant);\n config.macros.importDFwikis.src=source+&quot;/mod/wiki/webservicelib.php?sel=urlManagement&amp;id=&quot;+id+&quot;&amp;page=&quot;+page;\n config.macros.importDFwikis.src += attachMD5(calculateMD5());\n } \n loadRemoteItem(config.macros.importDFwikis.src, function(src,txt) {\n var wiki = readItemsFromHTML(txt);\n config.macros.importDFwikis.inbound=wiki;\n window.refreshImportDFwikiList();\n importDFwikiReport();\n config.macros.importDFwikis.index=0;\n config.macros.importDFwikis.index=importDFwikisImmediately(-1);\n importDFwikiStopped(); \n });\n config.macros.importDFwikis.src=src_backup\n break;\n case 'importOpenWikis': // load import source into hidden frame\n importDFwikiReport(); // if an import was in progress, generate a report\n config.macros.importDFwikis.inbound=null; // clear the imported tiddler buffer\n refreshImportDFwikiList(); // reset/resize the listbox\n if (config.macros.importDFwikis.src==&quot;&quot;) break;\n var src_backup = config.macros.importDFwikis.src;\n config.macros.importDFwikis.src=src_backup+((src_backup.charAt(src_backup.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php?sel=exportAllWikis&quot;;\n config.macros.importDFwikis.src += attachMD5(calculateMD5());\n // Load document into hidden iframe so we can read it's DOM and fill the list\n loadRemoteItem(config.macros.importDFwikis.src, function(src,txt) {\n var tiddlers = readItemsFromHTML(txt);\n var count=tiddlers?tiddlers.length:0;\n if (tiddlers.length!=0) document.getElementById('importOpenPages').disabled = false;\n displayMessage(config.macros.importDFwikis.foundMsg.format([count,src]));\n config.macros.importDFwikis.inbound=tiddlers;\n window.refreshImportDFwikiList();\n });\n config.macros.importDFwikis.src=src_backup;\n break;\n case 'importOpenPages': // load import source into hidden frame\n importDFwikiReport(); // if an import was in progress, generate a report\n //config.macros.importDFwikis.inbound=null; // clear the imported tiddler buffer\n //refreshImportDFwikiList(); // reset/resize the listbox\n if (config.macros.importDFwikis.src==&quot;&quot;) break;\n config.macros.importDFwikis.index=0;\n //config.macros.importDFwikis.index=importDFwikis(0);\n var src_backup = config.macros.importDFwikis.src;\n config.macros.importDFwikis.src=src_backup+((src_backup.charAt(src_backup.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php?sel=exportWikiPages&amp;wiki=&quot;+getWikiName(0)+&quot;&amp;parser=&quot;+config.macros.importDFwikis.parser;\n config.macros.importDFwikis.src += attachMD5(calculateMD5());\n // Load document into hidden iframe so we can read it's DOM and fill the list\n loadRemoteItem(config.macros.importDFwikis.src, function(src,txt) {\n var tiddlers = readItemsFromHTML(txt);\n var count=tiddlers?tiddlers.length:0;\n if (tiddlers.length!=0) document.getElementById('importStart').disabled = false;\n displayMessage(config.macros.importDFwikis.foundMsg.format([count,src]));\n config.macros.importDFwikis.inbound=tiddlers;\n window.refreshImportDFwikiList();\n });\n config.macros.importDFwikis.src=src_backup;\n break;\n case 'importSelectAll': // select all tiddler list items (i.e., not headings)\n importDFwikiReport(); // if an import was in progress, generate a report\n for (var t=0,count=0; t &lt; theList.options.length; t++) {\n if (theList.options[t].value==&quot;&quot;) continue;\n theList.options[t].selected=true;\n count++;\n }\n clearMessage(); displayMessage(config.macros.importDFwikis.countMsg.format([count]));\n break;\n case 'importSelectNew': // select tiddlers not in current document\n importDFwikiReport(); // if an import was in progress, generate a report\n for (var t=0,count=0; t &lt; theList.options.length; t++) {\n theList.options[t].selected=false;\n if (theList.options[t].value==&quot;&quot;) continue;\n theList.options[t].selected=!store.tiddlerExists(theList.options[t].value);\n count+=theList.options[t].selected?1:0;\n }\n clearMessage(); displayMessage(config.macros.importDFwikis.countMsg.format([count]));\n break;\n case 'importSelectChanges': // select tiddlers that are updated from existing tiddlers\n importDFwikiReport(); // if an import was in progress, generate a report\n for (var t=0,count=0; t &lt; theList.options.length; t++) {\n theList.options[t].selected=false;\n if (theList.options[t].value==&quot;&quot;||!store.tiddlerExists(theList.options[t].value)) continue;\n for (var i=0; i&lt;config.macros.importDFwikis.inbound.length; i++) // find matching inbound tiddler\n { var inbound=config.macros.importDFwikis.inbound[i]; if (inbound.title==theList.options[t].value) break; }\n theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified&gt;0); // updated tiddler\n count+=theList.options[t].selected?1:0;\n }\n clearMessage(); displayMessage(config.macros.importDFwikis.countMsg.format([count]));\n break;\n case 'importSelectDifferences': // select tiddlers that are new or different from existing tiddlers\n importDFwikiReport(); // if an import was in progress, generate a report\n for (var t=0,count=0; t &lt; theList.options.length; t++) {\n theList.options[t].selected=false;\n if (theList.options[t].value==&quot;&quot;) continue;\n if (!store.tiddlerExists(theList.options[t].value)) { theList.options[t].selected=true; count++; continue; }\n for (var i=0; i&lt;config.macros.importDFwikis.inbound.length; i++) // find matching inbound tiddler\n { var inbound=config.macros.importDFwikis.inbound[i]; if (inbound.title==theList.options[t].value) break; }\n theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified!=0); // changed tiddler\n count+=theList.options[t].selected?1:0;\n }\n clearMessage(); displayMessage(config.macros.importDFwikis.countMsg.format([count]));\n break;\n case 'importToggleFilter': // show/hide filter\n case 'importFilter': // apply filter\n alert(&quot;coming soon!&quot;);\n break;\n case 'importStart': // initiate the import processing\n importDFwikiReport(); // if an import was in progress, generate a report\n config.macros.importDFwikis.index=0;\n config.macros.importDFwikis.index=importDFwikis(-1);\n importDFwikiStopped();\n break;\n case 'importClose': // unload imported tiddlers or hide the import control panel\n // if imported tiddlers not loaded, close the import control panel\n if (!config.macros.importDFwikis.inbound) { thePanel.style.display='none'; break; }\n importDFwikiReport(); // if an import was in progress, generate a report\n config.macros.importDFwikis.inbound=null; // clear the imported tiddler buffer\n refreshImportDFwikiList(); // reset/resize the listbox\n break;\n case 'importSkip': // don't import the tiddler\n var theItem = theList.options[config.macros.importDFwikis.index];\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==theItem.value) break;\n var theImported = config.macros.importDFwikis.inbound[j];\n theImported.status='skipped after asking'; // mark item as skipped\n theCollisionPanel.style.display='none';\n config.macros.importDFwikis.index=importDFwikis(config.macros.importDFwikis.index+1); // resume with NEXT item\n importDFwikiStopped();\n break;\n case 'importRename': // change name of imported tiddler\n var theItem = theList.options[config.macros.importDFwikis.index];\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==theItem.value) break;\n var theImported = config.macros.importDFwikis.inbound[j];\n theImported.status = 'renamed from '+theImported.title; // mark item as renamed\n theImported.set(theNewTitle.value,null,null,null,null); // change the tiddler title\n theItem.value = theNewTitle.value; // change the listbox item text\n theItem.text = theNewTitle.value; // change the listbox item text\n theCollisionPanel.style.display='none';\n config.macros.importDFwikis.index=importDFwikis(config.macros.importDFwikis.index); // resume with THIS item\n importDFwikiStopped();\n break;\n case 'importMerge': // join existing and imported tiddler content\n var theItem = theList.options[config.macros.importDFwikis.index];\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==theItem.value) break;\n var theImported = config.macros.importDFwikis.inbound[j];\n var theExisting = store.getTiddler(theItem.value);\n var theText = theExisting.text+'\sn----\sn^^merged from: ';\n theText +='[['+config.macros.importDFwikis.src+'#'+theItem.value+'|'+config.macros.importDFwikis.src+'#'+theItem.value+']]^^\sn';\n theText +='^^'+theImported.modified.toLocaleString()+' by '+theImported.modifier+'^^\sn'+theImported.text;\n var theDate = new Date();\n var theTags = theExisting.getTags()+' '+theImported.getTags();\n theImported.set(null,theText,null,theDate,theTags);\n theImported.status = 'merged with '+theExisting.title; // mark item as merged\n theImported.status += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY 0hh:0mm:0ss&quot;);\n theImported.status += ' by '+theExisting.modifier;\n theCollisionPanel.style.display='none';\n config.macros.importDFwikis.index=importDFwikis(config.macros.importDFwikis.index); // resume with this item\n importDFwikiStopped();\n break;\n case 'importReplace': // substitute imported tiddler for existing tiddler\n var theItem = theList.options[config.macros.importDFwikis.index];\n for (j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==theItem.value) break;\n var theImported = config.macros.importDFwikis.inbound[j];\n var theExisting = store.getTiddler(theItem.value);\n theImported.status = 'replaces '+theExisting.title; // mark item for replace\n theImported.status += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY 0hh:0mm:0ss&quot;);\n theImported.status += ' by '+theExisting.modifier;\n theCollisionPanel.style.display='none';\n config.macros.importDFwikis.index=importDFwikis(config.macros.importDFwikis.index); // resume with THIS item\n importDFwikiStopped();\n break;\n case 'importListSmaller': // decrease current listbox size, minimum=5\n if (theList.options.length==1) break;\n theList.size-=(theList.size&gt;5)?1:0;\n config.macros.importDFwikis.listsize=theList.size;\n break;\n case 'importListLarger': // increase current listbox size, maximum=number of items in list\n if (theList.options.length==1) break;\n theList.size+=(theList.size&lt;theList.options.length)?1:0;\n config.macros.importDFwikis.listsize=theList.size;\n break;\n case 'importListMaximize': // toggle listbox size between current and maximum\n if (theList.options.length==1) break;\n theList.size=(theList.size==theList.options.length)?config.macros.importDFwikis.listsize:theList.options.length;\n break;\n }\n}\n//}}}\n\n// // refresh listbox\n//{{{\nfunction refreshImportDFwikiList(selectedIndex)\n{\n var theList = document.getElementById(&quot;importList&quot;);\n if (!theList) return;\n // if nothing to show, reset list content and size\n if (!config.macros.importDFwikis.inbound) \n {\n while (theList.length &gt; 0) { theList.options[0] = null; }\n theList.options[0]=new Option('please open moodle URL...',&quot;&quot;,false,false);\n theList.size=config.macros.importDFwikis.listsize;\n document.getElementById('importOpenPages').disabled = true;\n document.getElementById('importStart').disabled = true;\n return;\n }\n // get the sort order\n if (!selectedIndex) selectedIndex=0;\n if (selectedIndex==0) config.macros.importDFwikis.sort='title'; // hidden heading\n\n // get the alphasorted list of tiddlers (optionally, filter out unchanged tiddlers)\n var tiddlers=config.macros.importDFwikis.inbound;\n if (tiddlers[0].text == 'error'){ // If wrong user or password don't show open wiki pages button or import button\n document.getElementById('importOpenPages').disabled = true;\n document.getElementById('importStart').disabled = true;\n }\n tiddlers.sort(function (a,b) {if(a['title'] == b['title']) return(0); else return (a['title'] &lt; b['title']) ? -1 : +1; });\n // clear current list contents\n while (theList.length &gt; 0) { theList.options[0] = null; }\n // add heading and control items to list\n var i=0;\n var indent=String.fromCharCode(160)+String.fromCharCode(160);\n\n for(var t = 0; t &lt; tiddlers.length; t++)\n theList.options[i++] = new Option(tiddlers[t].title,tiddlers[t].title,false,false);\n\n theList.selectedIndex=selectedIndex; // select current control item\n if (theList.size&lt;config.macros.importDFwikis.listsize) theList.size=config.macros.importDFwikis.listsize;\n if (theList.size&gt;theList.options.length) theList.size=theList.options.length;\n}\n//}}}\n\n// // Security functions\n//{{{\n/*****************************************************************************\n * md5.js\n *\n * A JavaScript implementation derived from the RSA Data Security, Inc. MD5\n * Message-Digest Algorithm. See http://cw.oaktree.co.uk/site/legal.html for\n * details.\n *\n * Copyright (C) Paul Johnston 1999 - 2000. Distributed under the LGPL.\n *****************************************************************************/\n\n/* to convert strings to a list of ascii values */\nvar sAscii = &quot; !\s&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;\nvar sAscii = sAscii + &quot;[\s\s]^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;;\n\n/* convert integer to hex string */\nvar sHex = &quot;0123456789ABCDEF&quot;;\nfunction hex(i)\n{\n h = &quot;&quot;;\n for(j = 0; j &lt;= 3; j++)\n {\n h += sHex.charAt((i &gt;&gt; (j * 8 + 4)) &amp; 0x0F) +\n sHex.charAt((i &gt;&gt; (j * 8)) &amp; 0x0F);\n }\n return h;\n}\n\n/* add, handling overflows correctly */\nfunction add(x, y)\n{\n return ((x&amp;0x7FFFFFFF) + (y&amp;0x7FFFFFFF)) ^ (x&amp;0x80000000) ^ (y&amp;0x80000000);\n}\n\n/* MD5 rounds functions */\nfunction R1(A, B, C, D, X, S, T)\n{\n q = add(add(A, (B &amp; C) | ((~B) &amp; D)), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R2(A, B, C, D, X, S, T)\n{\n q = add(add(A, (B &amp; D) | (C &amp; (~D))), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R3(A, B, C, D, X, S, T)\n{\n q = add(add(A, B ^ C ^ D), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\nfunction R4(A, B, C, D, X, S, T)\n{\n q = add(add(A, C ^ (B | (~D))), add(X, T));\n return add((q &lt;&lt; S) | (q &gt;&gt;&gt; (32 - S)), B);\n}\n\n/* main entry point */\nfunction calcMD5(sInp) {\n\n /* Calculate length in machine words, including padding */\n wLen = (((sInp.length + 8) &gt;&gt; 6) + 1) &lt;&lt; 4;\n var X = new Array(wLen);\n\n /* Convert string to array of words */\n j = 4;\n for (i = 0; (i * 4) &lt; sInp.length; i++)\n {\n X[i] = 0;\n for (j = 0; (j &lt; 4) &amp;&amp; ((j + i * 4) &lt; sInp.length); j++)\n {\n X[i] += (sAscii.indexOf(sInp.charAt((i * 4) + j)) + 32) &lt;&lt; (j * 8);\n }\n }\n\n /* Append padding bits and length */\n if (j == 4)\n {\n X[i++] = 0x80;\n }\n else\n {\n X[i - 1] += 0x80 &lt;&lt; (j * 8);\n }\n for(; i &lt; wLen; i++) { X[i] = 0; }\n X[wLen - 2] = sInp.length * 8;\n\n /* hard coded initial values */\n a = 0x67452301;\n b = 0xefcdab89;\n c = 0x98badcfe;\n d = 0x10325476;\n\n /* Process each 16 word block in turn */\n for (i = 0; i &lt; wLen; i += 16) {\n aO = a;\n bO = b;\n cO = c;\n dO = d;\n\n a = R1(a, b, c, d, X[i+ 0], 7 , 0xd76aa478);\n d = R1(d, a, b, c, X[i+ 1], 12, 0xe8c7b756);\n c = R1(c, d, a, b, X[i+ 2], 17, 0x242070db);\n b = R1(b, c, d, a, X[i+ 3], 22, 0xc1bdceee);\n a = R1(a, b, c, d, X[i+ 4], 7 , 0xf57c0faf);\n d = R1(d, a, b, c, X[i+ 5], 12, 0x4787c62a);\n c = R1(c, d, a, b, X[i+ 6], 17, 0xa8304613);\n b = R1(b, c, d, a, X[i+ 7], 22, 0xfd469501);\n a = R1(a, b, c, d, X[i+ 8], 7 , 0x698098d8);\n d = R1(d, a, b, c, X[i+ 9], 12, 0x8b44f7af);\n c = R1(c, d, a, b, X[i+10], 17, 0xffff5bb1);\n b = R1(b, c, d, a, X[i+11], 22, 0x895cd7be);\n a = R1(a, b, c, d, X[i+12], 7 , 0x6b901122);\n d = R1(d, a, b, c, X[i+13], 12, 0xfd987193);\n c = R1(c, d, a, b, X[i+14], 17, 0xa679438e);\n b = R1(b, c, d, a, X[i+15], 22, 0x49b40821);\n\n a = R2(a, b, c, d, X[i+ 1], 5 , 0xf61e2562);\n d = R2(d, a, b, c, X[i+ 6], 9 , 0xc040b340);\n c = R2(c, d, a, b, X[i+11], 14, 0x265e5a51);\n b = R2(b, c, d, a, X[i+ 0], 20, 0xe9b6c7aa);\n a = R2(a, b, c, d, X[i+ 5], 5 , 0xd62f105d);\n d = R2(d, a, b, c, X[i+10], 9 , 0x2441453);\n c = R2(c, d, a, b, X[i+15], 14, 0xd8a1e681);\n b = R2(b, c, d, a, X[i+ 4], 20, 0xe7d3fbc8);\n a = R2(a, b, c, d, X[i+ 9], 5 , 0x21e1cde6);\n d = R2(d, a, b, c, X[i+14], 9 , 0xc33707d6);\n c = R2(c, d, a, b, X[i+ 3], 14, 0xf4d50d87);\n b = R2(b, c, d, a, X[i+ 8], 20, 0x455a14ed);\n a = R2(a, b, c, d, X[i+13], 5 , 0xa9e3e905);\n d = R2(d, a, b, c, X[i+ 2], 9 , 0xfcefa3f8);\n c = R2(c, d, a, b, X[i+ 7], 14, 0x676f02d9);\n b = R2(b, c, d, a, X[i+12], 20, 0x8d2a4c8a);\n\n a = R3(a, b, c, d, X[i+ 5], 4 , 0xfffa3942);\n d = R3(d, a, b, c, X[i+ 8], 11, 0x8771f681);\n c = R3(c, d, a, b, X[i+11], 16, 0x6d9d6122);\n b = R3(b, c, d, a, X[i+14], 23, 0xfde5380c);\n a = R3(a, b, c, d, X[i+ 1], 4 , 0xa4beea44);\n d = R3(d, a, b, c, X[i+ 4], 11, 0x4bdecfa9);\n c = R3(c, d, a, b, X[i+ 7], 16, 0xf6bb4b60);\n b = R3(b, c, d, a, X[i+10], 23, 0xbebfbc70);\n a = R3(a, b, c, d, X[i+13], 4 , 0x289b7ec6);\n d = R3(d, a, b, c, X[i+ 0], 11, 0xeaa127fa);\n c = R3(c, d, a, b, X[i+ 3], 16, 0xd4ef3085);\n b = R3(b, c, d, a, X[i+ 6], 23, 0x4881d05);\n a = R3(a, b, c, d, X[i+ 9], 4 , 0xd9d4d039);\n d = R3(d, a, b, c, X[i+12], 11, 0xe6db99e5);\n c = R3(c, d, a, b, X[i+15], 16, 0x1fa27cf8);\n b = R3(b, c, d, a, X[i+ 2], 23, 0xc4ac5665);\n\n a = R4(a, b, c, d, X[i+ 0], 6 , 0xf4292244);\n d = R4(d, a, b, c, X[i+ 7], 10, 0x432aff97);\n c = R4(c, d, a, b, X[i+14], 15, 0xab9423a7);\n b = R4(b, c, d, a, X[i+ 5], 21, 0xfc93a039);\n a = R4(a, b, c, d, X[i+12], 6 , 0x655b59c3);\n d = R4(d, a, b, c, X[i+ 3], 10, 0x8f0ccc92);\n c = R4(c, d, a, b, X[i+10], 15, 0xffeff47d);\n b = R4(b, c, d, a, X[i+ 1], 21, 0x85845dd1);\n a = R4(a, b, c, d, X[i+ 8], 6 , 0x6fa87e4f);\n d = R4(d, a, b, c, X[i+15], 10, 0xfe2ce6e0);\n c = R4(c, d, a, b, X[i+ 6], 15, 0xa3014314);\n b = R4(b, c, d, a, X[i+13], 21, 0x4e0811a1);\n a = R4(a, b, c, d, X[i+ 4], 6 , 0xf7537e82);\n d = R4(d, a, b, c, X[i+11], 10, 0xbd3af235);\n c = R4(c, d, a, b, X[i+ 2], 15, 0x2ad7d2bb);\n b = R4(b, c, d, a, X[i+ 9], 21, 0xeb86d391);\n\n a = add(a, aO);\n b = add(b, bO);\n c = add(c, cO);\n d = add(d, dO);\n }\n return hex(a) + hex(b) + hex(c) + hex(d);\n}\n\nfunction calculateMD5() \n{\n var pw = document.getElementById(&quot;moodlePwd&quot;).value;\n return(calcMD5(pw));\n}\n\nfunction attachMD5(hash) \n{\n var getUrl = &quot;&amp;user=&quot;+document.getElementById(&quot;moodleUserName&quot;).value;\n getUrl += &quot;&amp;pwd=&quot;+hash.toLowerCase();\n return getUrl;\n}\n//}}}\n\n// // re-entrant processing for handling import with interactive collision prompting\n//{{{\nfunction importDFwikis(startIndex)\n{\n if (!config.macros.importDFwikis.inbound) return -1;\n\n var theList = document.getElementById('importList');\n if (!theList) return;\n var t;\n // if starting new import, reset import status flags\n if (startIndex==-1)\n for (var t=0;t&lt;config.macros.importDFwikis.inbound.length;t++)\n config.macros.importDFwikis.inbound[t].status=&quot;&quot;;\n startIndex=0;\n for (var i=startIndex; i&lt;theList.options.length; i++)\n {\n // if list item is not selected or is a heading (i.e., has no value), skip it\n if ((!theList.options[i].selected) || ((t=theList.options[i].value)==&quot;&quot;))\n continue;\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==t) break;\n var inbound = config.macros.importDFwikis.inbound[j];\n var theExisting = store.getTiddler(inbound.title);\n // avoid redundant import for tiddlers that are listed multiple times (when 'by tags')\n if (inbound.status==&quot;added&quot;)\n continue;\n // don't import the &quot;ImportedTiddlers&quot; history from the other document...\n if (inbound.title=='ImportedTiddlers')\n continue;\n // if tiddler exists and import not marked for replace or merge, stop importing\n if (theExisting &amp;&amp; (inbound.status.substr(0,7)!=&quot;replace&quot;) &amp;&amp; (inbound.status.substr(0,5)!=&quot;merge&quot;))\n return i;\n // assemble tags (remote + existing + added)\n var newTags = &quot;&quot;;\n if (config.macros.importDFwikis.importTags)\n newTags+=inbound.getTags() // import remote tags\n if (config.macros.importDFwikis.keepTags &amp;&amp; theExisting)\n newTags+=&quot; &quot;+theExisting.getTags(); // keep existing tags\n if (config.macros.importDFwikis.addTags &amp;&amp; config.macros.importDFwikis.newTags.trim().length)\n newTags+=&quot; &quot;+config.macros.importDFwikis.newTags; // add new tags\n inbound.set(null,null,null,null,newTags.trim());\n // set the status to 'added' (if not already set by the 'ask the user' UI)\n inbound.status=(inbound.status==&quot;&quot;)?'added':inbound.status;\n inbound.modified = new Date();\n inbound.created = new Date();\n // do the import!\n // OLD: store.addTiddler(in); store.setDirty(true);\n store.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);\n store.fetchTiddler(inbound.title).created = inbound.created; // force creation date to imported value\n }\n return(-1); // signals that we really finished the entire list\n}\n\nfunction importDFwikisImmediately(startIndex, sync)\n{\n if (!config.macros.importDFwikis.inbound) return -1;\n var theList = document.getElementById('importList');\n if (!theList) return;\n var t;\n // if starting new import, reset import status flags\n if (startIndex==-1)\n for (var t=0;t&lt;config.macros.importDFwikis.inbound.length;t++)\n config.macros.importDFwikis.inbound[t].status=&quot;&quot;;\n startIndex=0;\n for (var i=startIndex; i&lt;theList.options.length; i++)\n {\n // if list item is not selected or is a heading (i.e., has no value), skip it\n /*if ((!theList.options[i].selected) || ((t=theList.options[i].value)==&quot;&quot;))\n continue;*/\n if ((t=theList.options[i].value)==&quot;&quot;) \n {\n continue;\n }\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==t) break;\n var inbound = config.macros.importDFwikis.inbound[j];\n var theExisting = store.getTiddler(inbound.title);\n // avoid redundant import for tiddlers that are listed multiple times (when 'by tags')\n if (inbound.status==&quot;added&quot;)\n continue;\n // don't import the &quot;ImportedTiddlers&quot; history from the other document...\n if (inbound.title=='ImportedTiddlers')\n continue;\n // if it's an error tiddler don't store it\n if (inbound.modifier==&quot;yes&quot;)\n break;\n // if tiddler exists and import not marked for replace or merge, stop importing\n if (!sync &amp;&amp; theExisting &amp;&amp; (inbound.status.substr(0,7)!=&quot;replace&quot;) &amp;&amp; (inbound.status.substr(0,5)!=&quot;merge&quot;))\n return i;\n // assemble tags (remote + existing + added)\n var newTags = &quot;&quot;;\n if (config.macros.importDFwikis.importTags)\n newTags+=inbound.getTags() // import remote tags\n if (config.macros.importDFwikis.keepTags &amp;&amp; theExisting)\n newTags+=&quot; &quot;+theExisting.getTags(); // keep existing tags\n if (config.macros.importDFwikis.addTags &amp;&amp; config.macros.importDFwikis.newTags.trim().length)\n newTags+=&quot; &quot;+config.macros.importDFwikis.newTags; // add new tags\n inbound.set(null,null,null,null,newTags.trim());\n // set the status to 'added' (if not already set by the 'ask the user' UI)\n inbound.status=(inbound.status==&quot;&quot;)?'added':inbound.status; \n inbound.modified = new Date();\n inbound.created = new Date();\n // do the import!\n // OLD: store.addTiddler(in); store.setDirty(true);\n store.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);\n store.fetchTiddler(inbound.title).created = inbound.created; // force creation date to imported value\n }\n return(-1); // signals that we really finished the entire list\n}\n\nfunction getWikiName(startIndex)\n{\n if (!config.macros.importDFwikis.inbound) return -1;\n\n var theList = document.getElementById('importList');\n if (!theList) return &quot;merda&quot;;\n var t;\n // if starting new import, reset import status flags\n if (startIndex==0)\n for (var t=0;t&lt;config.macros.importDFwikis.inbound.length;t++)\n config.macros.importDFwikis.inbound[t].status=&quot;&quot;;\n for (var i=startIndex; i&lt;theList.options.length; i++)\n {\n // if list item is not selected or is a heading (i.e., has no value), skip it\n if ((!theList.options[i].selected) || ((t=theList.options[i].value)==&quot;&quot;))\n continue;\n for (var j=0;j&lt;config.macros.importDFwikis.inbound.length;j++)\n if (config.macros.importDFwikis.inbound[j].title==t) break;\n var inbound = config.macros.importDFwikis.inbound[j];\n return(inbound.text);\n }\n //return(-1); // signals that we really finished the entire list\n}\n//}}}\n\n//{{{\nfunction importDFwikiStopped()\n{\n var theList = document.getElementById('importList');\n var theNewTitle = document.getElementById('importNewTitle');\n if (!theList) return;\n if (config.macros.importDFwikis.index==-1)\n importDFwikiReport(); // import finished... generate the report\n else\n {\n // DEBUG alert('import stopped at: '+config.macros.importDFwikis.index);\n // import collision... show the collision panel and set the title edit field\n document.getElementById('importCollisionDFwikiPanel').style.display='block';\n theNewTitle.value=theList.options[config.macros.importDFwikis.index].value;\n }\n}\n//}}}\n\n// // ''REPORT GENERATOR''\n//{{{\nfunction importDFwikiReport(quiet)\n{\n if (!config.macros.importDFwikis.inbound) return;\n // DEBUG alert('importDFwikiReport: start');\n\n // if import was not completed, the collision panel will still be open... close it now.\n var panel=document.getElementById('importCollisionDFwikiPanel'); if (panel) panel.style.display='none';\n\n // get the alphasorted list of tiddlers\n var tiddlers = config.macros.importDFwikis.inbound;\n // gather the statistics\n var count=0;\n for (var t=0; t&lt;tiddlers.length; t++)\n if (tiddlers[t].status &amp;&amp; tiddlers[t].status.trim().length &amp;&amp; tiddlers[t].status.substr(0,7)!=&quot;skipped&quot;) count++;\n\n // generate a report\n if (count &amp;&amp; config.options.chkimportDFwikiReport) {\n // get/create the report tiddler\n var theReport = store.getTiddler('ImportedTiddlers');\n if (!theReport) { theReport= new Tiddler(); theReport.title = 'ImportedTiddlers'; theReport.text = &quot;&quot;; }\n // format the report content\n var now = new Date();\n var newText = &quot;On &quot;+now.toLocaleString()+&quot;, &quot;+config.options.txtUserName\n newText +=&quot; imported &quot;+count+&quot; tiddler&quot;+(count==1?&quot;&quot;:&quot;s&quot;)+&quot; from\sn[[&quot;+config.macros.importDFwikis.src+&quot;|&quot;+config.macros.importDFwikis.src+&quot;]]:\sn&quot;;\n if (config.macros.importDFwikis.addTags &amp;&amp; config.macros.importDFwikis.newTags.trim().length)\n newText += &quot;imported tiddlers were tagged with: \s&quot;&quot;+config.macros.importDFwikis.newTags+&quot;\s&quot;\sn&quot;;\n newText += &quot;&lt;&lt;&lt;\sn&quot;;\n for (var t=0; t&lt;tiddlers.length; t++) if (tiddlers[t].status) newText += &quot;#[[&quot;+tiddlers[t].title+&quot;]] - &quot;+tiddlers[t].status+&quot;\sn&quot;;\n newText += &quot;&lt;&lt;&lt;\sn&quot;;\n// 20060918 ELS: DON'T ADD &quot;discard&quot; BUTTON TO REPORT\n// newText += &quot;&lt;html&gt;&lt;input type=\s&quot;button\s&quot; href=\s&quot;javascript:;\s&quot; &quot;;\n// newText += &quot;onclick=\s&quot;story.closeTiddler('&quot;+theReport.title+&quot;'); store.deleteTiddler('&quot;+theReport.title+&quot;');\s&quot; &quot;;\n// newText += &quot;value=\s&quot;discard report\s&quot;&gt;&lt;/html&gt;&quot;;\n // update the ImportedTiddlers content and show the tiddler\n theReport.text = newText+((theReport.text!=&quot;&quot;)?'\sn----\sn':&quot;&quot;)+theReport.text;\n theReport.modifier = config.options.txtUserName;\n theReport.modified = new Date();\n // OLD: store.addTiddler(theReport);\n store.saveTiddler(theReport.title, theReport.title, theReport.text, theReport.modifier, theReport.modified, theReport.tags);\n if (!quiet) { story.displayTiddler(null,theReport.title,1,null,null,false); story.refreshTiddler(theReport.title,1,true); }\n }\n\n // reset status flags\n for (var t=0; t&lt;config.macros.importDFwikis.inbound.length; t++) config.macros.importDFwikis.inbound[t].status=&quot;&quot;;\n\n // refresh display if tiddlers have been loaded\n if (count) { store.setDirty(true); store.notifyAll(); }\n\n // always show final message when tiddlers were actually loaded\n if (count) displayMessage(config.macros.importDFwikis.importedMsg.format([count,tiddlers.length,config.macros.importDFwikis.src]));\n}\n//}}}\n\n/***\n!!!!!TW 2.1beta Core Code Candidate\n//The following section is a preliminary 'code candidate' for incorporation of non-interactive 'load tiddlers' functionality into TW2.1beta. //\n***/\n//{{{\n// default cookie/option values\nif (!config.options.chkimportDFwikiReport) config.options.chkimportDFwikiReport=true;\n\nconfig.macros.loadDFwikis = {\n label: &quot;&quot;,\n prompt: &quot;add/update tiddlers from '%0'&quot;,\n askMsg: &quot;Please enter a local path/filename or a remote URL&quot;,\n openMsg: &quot;Opening %0&quot;,\n openErrMsg: &quot;Could not open %0 - error=%1&quot;,\n readMsg: &quot;Read %0 bytes from %1&quot;,\n foundMsg: &quot;Found %0 tiddlers in %1&quot;,\n nochangeMsg: &quot;'%0' is up-to-date... skipped.&quot;,\n loadedMsg: &quot;Loaded %0 of %1 tiddlers from %2&quot;\n};\n\nconfig.macros.loadDFwikis.handler = function(place,macroName,params) {\n var label=(params[0] &amp;&amp; params[0].substr(0,6)=='label:')?params.shift().substr(6):this.label;\n var prompt=(params[0] &amp;&amp; params[0].substr(0,7)=='prompt:')?params.shift().substr(7):this.prompt;\n var filter=&quot;updates&quot;;\n if (params[0] &amp;&amp; (params[0]=='all' || params[0]=='new' || params[0]=='changes' || params[0]=='updates'\n || params[0].substr(0,8)=='tiddler:' || params[0].substr(0,4)=='tag:'))\n filter=params.shift();\n var src=params.shift(); if (!src || !src.length) return; // filename is required\n var quiet=(params[0]==&quot;quiet&quot;); if (quiet) params.shift();\n var ask=(params[0]==&quot;confirm&quot;); if (ask) params.shift();\n var force=(params[0]==&quot;force&quot;); if (force) params.shift();\n if (label.trim().length) {\n // link triggers load tiddlers from another file/URL and then applies filtering rules to add/replace tiddlers in the store\n createTiddlyButton(place,label.format([src]),prompt.format([src]), function() {\n if (src==&quot;ask&quot;) src=prompt(config.macros.loadDFwikis.askMsg);\n loadRemoteItem(src,loadDFwikis,quiet,ask,filter,force);\n })\n }\n else {\n // load tiddlers from another file/URL and then apply filtering rules to add/replace tiddlers in the store\n if (src==&quot;ask&quot;) src=prompt(config.macros.loadDFwikis.askMsg);\n loadRemoteItem(src,loadDFwikis,quiet,ask,filter,force);\n }\n}\n\nfunction loadDFwikis(src,html,quiet,ask,filter,force)\n{\n var tiddlers = readItemsFromHTML(html);\n var count=tiddlers?tiddlers.length:0;\n if (!quiet) displayMessage(config.macros.loadDFwikis.foundMsg.format([count,src]));\n var count=0;\n if (tiddlers) for (var t=0;t&lt;tiddlers.length;t++) {\n var inbound = tiddlers[t];\n var theExisting = store.getTiddler(inbound.title);\n if (inbound.title=='ImportedTiddlers')\n continue; // skip &quot;ImportedTiddlers&quot; history from the other document...\n\n // apply the all/new/changes/updates filter (if any)\n if (filter &amp;&amp; filter!=&quot;all&quot;) {\n if ((filter==&quot;new&quot;) &amp;&amp; theExisting) // skip existing tiddlers\n continue;\n if ((filter==&quot;changes&quot;) &amp;&amp; !theExisting) // skip new tiddlers\n continue;\n if ((filter.substr(0,4)==&quot;tag:&quot;) &amp;&amp; inbound.tags.find(filter.substr(4))==null) // must match specific tag value\n continue;\n if ((filter.substr(0,8)==&quot;tiddler:&quot;) &amp;&amp; inbound.title!=filter.substr(8)) // must match specific tiddler name\n continue;\n if (!force &amp;&amp; store.tiddlerExists(inbound.title) &amp;&amp; ((theExisting.modified.getTime()-inbound.modified.getTime())&gt;=0))\n { if (!quiet) displayMessage(config.macros.loadDFwikis.nochangeMsg.format([inbound.title])); continue; }\n }\n // get confirmation if required\n if (ask &amp;&amp; !confirm((theExisting?&quot;Update&quot;:&quot;Add&quot;)+&quot; tiddler '&quot;+inbound.title+&quot;'\snfrom &quot;+src))\n { tiddlers[t].status=&quot;skipped - cancelled by user&quot;; continue; }\n // DO IT!\n // OLD: store.addTiddler(in);\n store.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);\n store.fetchTiddler(inbound.title).created = inbound.created; // force creation date to imported value\n tiddlers[t].status=theExisting?&quot;updated&quot;:&quot;added&quot;\n count++;\n }\n if (count) {\n // refresh display\n store.setDirty(true);\n store.notifyAll();\n // generate a report\n if (config.options.chkimportDFwikiReport) {\n // get/create the report tiddler\n var theReport = store.getTiddler('ImportedTiddlers');\n if (!theReport) { theReport= new Tiddler(); theReport.title = 'ImportedTiddlers'; theReport.text = &quot;&quot;; }\n // format the report content\n var now = new Date();\n var newText = &quot;On &quot;+now.toLocaleString()+&quot;, &quot;+config.options.txtUserName+&quot; loaded &quot;+count+&quot; tiddlers from\sn[[&quot;+src+&quot;|&quot;+src+&quot;]]:\sn&quot;;\n newText += &quot;&lt;&lt;&lt;\sn&quot;;\n for (var t=0; t&lt;tiddlers.length; t++) if (tiddlers[t].status) newText += &quot;#[[&quot;+tiddlers[t].title+&quot;]] - &quot;+tiddlers[t].status+&quot;\sn&quot;;\n newText += &quot;&lt;&lt;&lt;\sn&quot;;\n // update the ImportedTiddlers content and show the tiddler\n theReport.text = newText+((theReport.text!=&quot;&quot;)?'\sn----\sn':&quot;&quot;)+theReport.text;\n theReport.modifier = config.options.txtUserName;\n theReport.modified = new Date();\n // OLD: store.addTiddler(theReport);\n store.saveTiddler(theReport.title, theReport.title, theReport.text, theReport.modifier, theReport.modified, theReport.tags);\n if (!quiet) { story.displayTiddler(null,theReport.title,1,null,null,false); story.refreshTiddler(theReport.title,1,true); }\n }\n }\n // always show final message when tiddlers were actually loaded\n if (!quiet||count) displayMessage(config.macros.loadDFwikis.loadedMsg.format([count,tiddlers.length,src]));\n}\n\nfunction loadRemoteItem(src,callback,quiet,ask,filter,force) {\n if (src==undefined || !src.length) return null; // filename is required\n if (!quiet) clearMessage();\n if (!quiet) displayMessage(config.macros.loadDFwikis.openMsg.format([src]));\n if (src.substr(0,4)!=&quot;http&quot; &amp;&amp; src.substr(0,4)!=&quot;file&quot;) { // if not a URL, fallback to read from local filesystem\n var txt=loadFile(src);\n if ((txt==null)||(txt==false)) // file didn't load\n { if (!quiet) displayMessage(config.macros.loadDFwikis.openErrMsg.format([src,&quot;(unknown)&quot;])); }\n else {\n if (!quiet) displayMessage(config.macros.loadDFwikis.readMsg.format([txt.length,src]));\n if (callback) callback(src,convertUTF8ToUnicode(txt),quiet,ask,filter,force);\n }\n }\n else {\n var x; // get an request object\n try {x = new XMLHttpRequest()} // moz\n catch(e) {\n try {x = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)} // IE 6\n catch (e) {\n try {x = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)} // IE 5\n catch (e) { return }\n }\n }\n // setup callback function to handle server response(s)\n x.onreadystatechange = function() {\n if (x.readyState == 4) {\n if (x.status==0 || x.status == 200) {\n if (!quiet) displayMessage(config.macros.loadDFwikis.readMsg.format([x.responseText.length,src]));\n if (callback) callback(src,x.responseText,quiet,ask,filter,force);\n }\n else {\n if (!quiet) displayMessage(config.macros.loadDFwikis.openErrMsg.format([src,x.status]));\n }\n }\n }\n // get privileges to read another document's DOM via http:// or file:// (moz-only)\n if (typeof(netscape)!=&quot;undefined&quot;) {\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;); }\n catch (e) { if (!quiet) displayMessage(e.description?e.description:e.toString()); }\n }\n // send the HTTP request\n try {\n var url=src+(src.indexOf('?')&lt;0?'?':'&amp;')+'nocache='+Math.random();\n x.open(&quot;GET&quot;,src,true);\n if (x.overrideMimeType) x.overrideMimeType('text/html');\n x.send(null);\n }\n catch (e) {\n if (!quiet) {\n displayMessage(config.macros.loadDFwikis.openErrMsg.format([src,&quot;(unknown)&quot;]));\n displayMessage(e.description?e.description:e.toString());\n }\n }\n }\n}\n\nfunction readItemsFromHTML(html)\n{\n // extract store area from html \n var start=html.indexOf('&lt;div id=&quot;storeArea&quot;&gt;');\n var end=html.indexOf(&quot;&lt;!--POST-BODY-START--&quot;+&quot;&gt;&quot;,start);\n if (end==-1) var end=html.indexOf(&quot;&lt;/body&quot;+&quot;&gt;&quot;,start); // backward-compatibility for older documents\n var sa=&quot;&lt;html&gt;&lt;body&gt;&quot;+html.substring(start,end)+&quot;&lt;/body&gt;&lt;/html&gt;&quot;;\n\n // load html into iframe document\n var f=document.getElementById(&quot;loaderFrame&quot;); if (f) document.body.removeChild(f);\n f=document.createElement(&quot;iframe&quot;); f.id=&quot;loaderFrame&quot;;\n f.style.width=&quot;0px&quot;; f.style.height=&quot;0px&quot;; f.style.border=&quot;0px&quot;;\n document.body.appendChild(f);\n var d=f.document;\n if (f.contentDocument) d=f.contentDocument; // For NS6\n else if (f.contentWindow) d=f.contentWindow.document; // For IE5.5 and IE6\n d.open(); d.writeln(sa); d.close();\n\n // read tiddler DIVs from storeArea DOM element \n var sa = d.getElementById(&quot;storeArea&quot;);\n if (!sa) return null;\n sa.normalize();\n var nodes = sa.childNodes;\n if (!nodes || !nodes.length) return null;\n var tiddlers = [];\n for(var t = 0; t &lt; nodes.length; t++) {\n var title = null;\n if(nodes[t].getAttribute)\n title = nodes[t].getAttribute(&quot;tiddler&quot;);\n if(!title &amp;&amp; nodes[t].id &amp;&amp; (nodes[t].id.substr(0,5) == &quot;store&quot;))\n title = nodes[t].id.substr(5);\n if(title &amp;&amp; title != &quot;&quot;)\n tiddlers.push((new Tiddler()).loadFromDiv(nodes[t],title));\n }\n return tiddlers;\n}\n//}}}</div>
<div tiddler="InlineJavascriptPlugin" modifier="ELSDesignStudios" modified="200610162226" created="200512130544" tags="systemConfig includeNew authoring">/***\n|''Name:''|InlineJavascriptPlugin|\n|''Source:''|http://www.TiddlyTools.com/#InlineJavascriptPlugin|\n|''Author:''|Eric Shulman - ELS Design Studios|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.0.10|\n\nInsert Javascript executable code directly into your tiddler content. Lets you ''call directly into TW core utility routines, define new functions, calculate values, add dynamically-generated TiddlyWiki-formatted output'' into tiddler content, or perform any other programmatic actions each time the tiddler is rendered.\n!!!!!Usage\n&lt;&lt;&lt;\nWhen installed, this plugin adds new wiki syntax for surrounding tiddler content with {{{&lt;script&gt;}}} and {{{&lt;/script&gt;}}} markers, so that it can be treated as embedded javascript and executed each time the tiddler is rendered.\n\n''Deferred execution from an 'onClick' link''\nBy including a label=&quot;...&quot; parameter in the initial {{{&lt;script&gt;}}} marker, the plugin will create a link to an 'onclick' script that will only be executed when that specific link is clicked, rather than running the script each time the tiddler is rendered.\n\n''External script source files:''\nYou can also load javascript from an external source URL, by including a src=&quot;...&quot; parameter in the initial {{{&lt;script&gt;}}} marker (e.g., {{{&lt;script src=&quot;demo.js&quot;&gt;&lt;/script&gt;}}}). This is particularly useful when incorporating third-party javascript libraries for use in custom extensions and plugins. The 'foreign' javascript code remains isolated in a separate file that can be easily replaced whenever an updated library file becomes available.\n\n''Display script source in tiddler output''\nBy including the keyword parameter &quot;show&quot;, in the initial {{{&lt;script&gt;}}} marker, the plugin will include the script source code in the output that it displays in the tiddler.\n\n''Defining javascript functions and libraries:''\nAlthough the external javascript file is loaded while the tiddler content is being rendered, any functions it defines will not be available for use until //after// the rendering has been completed. Thus, you cannot load a library and //immediately// use it's functions within the same tiddler. However, once that tiddler has been loaded, the library functions can be freely used in any tiddler (even the one in which it was initially loaded).\n\nTo ensure that your javascript functions are always available when needed, you should load the libraries from a tiddler that will be rendered as soon as your TiddlyWiki document is opened. For example, you could put your {{{&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;}}} syntax into a tiddler called LoadScripts, and then add {{{&lt;&lt;tiddler LoadScripts&gt;&gt;}}} in your MainMenu tiddler.\n\nSince the MainMenu is always rendered immediately upon opening your document, the library will always be loaded before any other tiddlers that rely upon the functions it defines. Loading an external javascript library does not produce any direct output in the tiddler, so these definitions should have no impact on the appearance of your MainMenu.\n\n''Creating dynamic tiddler content''\nAn important difference between this implementation of embedded scripting and conventional embedded javascript techniques for web pages is the method used to produce output that is dynamically inserted into the document:\n* In a typical web document, you use the document.write() function to output text sequences (often containing HTML tags) that are then rendered when the entire document is first loaded into the browser window.\n* However, in a ~TiddlyWiki document, tiddlers (and other DOM elements) are created, deleted, and rendered &quot;on-the-fly&quot;, so writing directly to the global 'document' object does not produce the results you want (i.e., replacing the embedded script within the tiddler content), and completely replaces the entire ~TiddlyWiki document in your browser window.\n* To allow these scripts to work unmodified, the plugin automatically converts all occurences of document.write() so that the output is inserted into the tiddler content instead of replacing the entire ~TiddlyWiki document.\n\nIf your script does not use document.write() to create dynamically embedded content within a tiddler, your javascript can, as an alternative, explicitly return a text value that the plugin can then pass through the wikify() rendering engine to insert into the tiddler display. For example, using {{{return &quot;thistext&quot;}}} will produce the same output as {{{document.write(&quot;thistext&quot;)}}}.\n\n//Note: your script code is automatically 'wrapped' inside a function, {{{_out()}}}, so that any return value you provide can be correctly handled by the plugin and inserted into the tiddler. To avoid unpredictable results (and possibly fatal execution errors), this function should never be redefined or called from ''within'' your script code.//\n\n''Accessing the ~TiddlyWiki DOM''\nThe plugin provides one pre-defined variable, 'place', that is passed in to your javascript code so that it can have direct access to the containing DOM element into which the tiddler output is currently being rendered.\n\nAccess to this DOM element allows you to create scripts that can:\n* vary their actions based upon the specific location in which they are embedded\n* access 'tiddler-relative' information (use findContainingTiddler(place))\n* perform direct DOM manipulations (when returning wikified text is not enough)\n&lt;&lt;&lt;\n!!!!!Examples\n&lt;&lt;&lt;\nan &quot;alert&quot; message box:\n&gt;&lt;script show&gt;\n alert('InlineJavascriptPlugin: this is a demonstration message');\n&lt;/script&gt;\ndynamic output:\n&gt;&lt;script show&gt;\n return (new Date()).toString();\n&lt;/script&gt;\nwikified dynamic output:\n&gt;&lt;script show&gt;\n return &quot;link to current user: [[&quot;+config.options.txtUserName+&quot;]]&quot;;\n&lt;/script&gt;\ndynamic output using 'place' to get size information for current tiddler:\n&gt;&lt;script show&gt;\n if (!window.story) window.story=window;\n var title=story.findContainingTiddler(place).id.substr(7);\n return title+&quot; is using &quot;+store.getTiddlerText(title).length+&quot; bytes&quot;;\n&lt;/script&gt;\ncreating an 'onclick' button/link that runs a script:\n&gt;&lt;script label=&quot;click here&quot; show&gt;\n if (!window.story) window.story=window;\n alert(&quot;Hello World!\snlinktext='&quot;+place.firstChild.data+&quot;'\sntiddler='&quot;+story.findContainingTiddler(place).id.substr(7)+&quot;'&quot;);\n&lt;/script&gt;\nloading a script from a source url:\n&gt;http://www.TiddlyTools.com/demo.js contains:\n&gt;&gt;{{{function demo() { alert('this output is from demo(), defined in demo.js') } }}}\n&gt;&gt;{{{alert('InlineJavascriptPlugin: demo.js has been loaded'); }}}\n&gt;&lt;script src=&quot;demo.js&quot; show&gt;\n return &quot;loading demo.js...&quot;\n&lt;/script&gt;\n&gt;&lt;script label=&quot;click to execute demo() function&quot; show&gt;\n demo()\n&lt;/script&gt;\n&lt;&lt;&lt;\n!!!!!Installation\n&lt;&lt;&lt;\nimport (or copy/paste) the following tiddlers into your document:\n''InlineJavascriptPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.10.16 [1.5.2]'' add newline before closing '}' in 'function out_' wrapper. Fixes error caused when last line of script is a comment.\n''2006.06.01 [1.5.1]'' when calling wikify() on script return value, pass hightlightRegExp and tiddler params so macros that rely on these values can render properly\n''2006.04.19 [1.5.0]'' added 'show' parameter to force display of javascript source code in tiddler output\n''2006.01.05 [1.4.0]'' added support 'onclick' scripts. When label=&quot;...&quot; param is present, a button/link is created using the indicated label text, and the script is only executed when the button/link is clicked. 'place' value is set to match the clicked button/link element.\n''2005.12.13 [1.3.1]'' when catching eval error in IE, e.description contains the error text, instead of e.toString(). Fixed error reporting so IE shows the correct response text. Based on a suggestion by UdoBorkowski\n''2005.11.09 [1.3.0]'' for 'inline' scripts (i.e., not scripts loaded with src=&quot;...&quot;), automatically replace calls to 'document.write()' with 'place.innerHTML+=' so script output is directed into tiddler content. Based on a suggestion by BradleyMeck\n''2005.11.08 [1.2.0]'' handle loading of javascript from an external URL via src=&quot;...&quot; syntax\n''2005.11.08 [1.1.0]'' pass 'place' param into scripts to provide direct DOM access \n''2005.11.08 [1.0.0]'' initial release\n&lt;&lt;&lt;\n!!!!!Credits\n&lt;&lt;&lt;\nThis feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]\n&lt;&lt;&lt;\n!!!!!Code\n***/\n//{{{\nversion.extensions.inlineJavascript= {major: 1, minor: 5, revision: 2, date: new Date(2006,10,16)};\n\nconfig.formatters.push( {\n name: &quot;inlineJavascript&quot;,\n match: &quot;\s\s&lt;script&quot;,\n lookahead: &quot;\s\s&lt;script(?: src=\s\s\s&quot;((?:.|\s\sn)*?)\s\s\s&quot;)?(?: label=\s\s\s&quot;((?:.|\s\sn)*?)\s\s\s&quot;)?( show)?\s\s&gt;((?:.|\s\sn)*?)\s\s&lt;/script\s\s&gt;&quot;,\n\n handler: function(w) {\n var lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);\n lookaheadRegExp.lastIndex = w.matchStart;\n var lookaheadMatch = lookaheadRegExp.exec(w.source)\n if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n if (lookaheadMatch[1]) { // load a script library\n // make script tag, set src, add to body to execute, then remove for cleanup\n var script = document.createElement(&quot;script&quot;); script.src = lookaheadMatch[1];\n document.body.appendChild(script); document.body.removeChild(script);\n }\n if (lookaheadMatch[4]) { // there is script code\n if (lookaheadMatch[3]) // show inline script code in tiddler output\n wikify(&quot;{{{\sn&quot;+lookaheadMatch[0]+&quot;\sn}}}\sn&quot;,w.output);\n if (lookaheadMatch[2]) { // create a link to an 'onclick' script\n // add a link, define click handler, save code in link (pass 'place'), set link attributes\n var link=createTiddlyElement(w.output,&quot;a&quot;,null,&quot;tiddlyLinkExisting&quot;,lookaheadMatch[2]);\n link.onclick=function(){try{return(eval(this.code))}catch(e){alert(e.description?e.description:e.toString())}}\n link.code=&quot;function _out(place){&quot;+lookaheadMatch[4]+&quot;\sn};_out(this);&quot;\n link.setAttribute(&quot;href&quot;,&quot;javascript:;&quot;); link.setAttribute(&quot;title&quot;,&quot;&quot;); link.style.cursor=&quot;pointer&quot;;\n }\n else { // run inline script code\n var code=&quot;function _out(place){&quot;+lookaheadMatch[4]+&quot;\sn};_out(w.output);&quot;\n code=code.replace(/document.write\s(/gi,'place.innerHTML+=(');\n try { var out = eval(code); } catch(e) { out = e.description?e.description:e.toString(); }\n if (out &amp;&amp; out.length) wikify(out,w.output,w.highlightRegExp,w.tiddler);\n }\n }\n w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;\n }\n }\n} )\n//}}}\n</div>
<div tiddler="Installation Instructions" modifier="Ludo(Marc Alier)" modified="200610301220" created="200610301220" tags="">You may either read the instructions for \n* [[Installation on your Tiddywiki]]\n* [[Installation on your Moodle New Wiki]]\n\n</div>
<div tiddler="Installation on your Moodle New Wiki" modifier="Ludo(Marc Alier)" modified="200610301228" created="200610301228" tags="dfWikiTeam">You need to have installed a Nwe Wiki in your Moodle 1.6 (or above) server. Get it at [[DFwikilabs|http://morfeo.upc.es/crom/course/view.php?id=4]]\n\nIf you have it you need to copy the following files [[http://morfeo.upc.es/crom/mod/resource/view.php?id=38]] into the mod/wiki folder of your moodle installation. \n\nThis will only allow to import the wiki pages placed in wiki activities open to the Guest user in your server.</div>
<div tiddler="Installation on your Tiddywiki" modifier="Ludo(Marc Alier)" modified="200610301225" created="200610301225" tags="">* You can download a the Tiddywiki template from [[DFWikilabs|http://morfeo.upc.es/crom/course/view.php?id=4]] \n* Or you can take the ImportDFwikisPlugin, view / edit it and copy and paste all its content into a Tiddler in your own Tiddlywiki file, remeber to tag it as systemConfig \n* You can also use the ImportTiddlers plugin to get it. </div>
<div tiddler="InterfaceOptions" modifier="Ludo(Marc Alier)" modified="200611160838" created="200611160838" tags="">[[Styles SideBarOptions]]</div>
<div tiddler="LegacyStrikeThroughPlugin" modifier="MartinBudden" modified="200607210000" created="200609160342" tags="systemConfig">/***\n|''Name:''|LegacyStrikeThroughPlugin|\n|''Description:''|Support for legacy (pre 2.1) strike through formatting|\n|''Version:''|1.0.1|\n|''Date:''|Jul 21, 2006|\n|''Source:''|http://www.tiddlywiki.com/#LegacyStrikeThroughPlugin|\n|''Author:''|MartinBudden (mjbudden (at) gmail (dot) com)|\n|''License:''|[[BSD open source license]]|\n|''CoreVersion:''|2.1.0|\n|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|\n\n***/\n\n//{{{\n\n// Ensure that the LegacyStrikeThrough Plugin is only installed once.\nif(!version.extensions.LegacyStrikeThroughPlugin)\n {\n version.extensions.LegacyStrikeThroughPlugin = true;\n\nconfig.formatters.push(\n{\n name: &quot;legacyStrikeByChar&quot;,\n match: &quot;==&quot;,\n termRegExp: /(==)/mg,\n element: &quot;strike&quot;,\n handler: config.formatterHelpers.createElementAndWikify\n});\n\n} // end of &quot;install only once&quot;\n//}}}\n</div>
<div tiddler="License And Legal Aspects" modifier="Ludo(Marc Alier)" modified="200611171132" created="200611061013" tags="dfWikiTeam">&lt;&lt;&lt;\nThis work is based upon TiddlyWiki &lt;&lt;version&gt;&gt;, written by Jeremy Ruston, &amp;copy; Osmosoft Limited, which has been distributed under a BSD open source license.\n\nThis work includes one or more derivative components that have been modified from original licensed components created by Eric L. Shulman\n and/or ELS Design Studios and are subject to the terms and conditions of the Creative Commons Attribution-ShareAlike 2.5 License as well as all other terms and conditions as described in http://www.TiddlyTools.com/#LegalStatements\n\nModifications and additions to this work, including (but not limited to) original programmatic components (&quot;plugins&quot;, &quot;macros&quot;, &quot;scripts&quot;, &quot;stylesheets&quot;) have been created by [[Ludo(Marc Alier)]], Oriol Nieto and Alex Moreno. You are permitted to use, copy, and/or modify these components, subject to the terms and conditions of the [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]] as well as all other terms and conditions specifically included within the body of this work.\n\nAny and all modifications and/or additions that you make to components of this work must be clearly identified as a derivative work that is easily distinguished from the original version, and must retain appropriate licensing information and references ( i.e., ~URLs) to the official distribution source for the unaltered component.\n\nAll other original content, including (but not limited to) writings, images, sound recordings, and videos, are the property of Marc Alier and/or Oriol Nieto and or Alex Moreno, or are used under license or agreement with third parties and, except as required for normative operation and viewing of this work, may not be stored, displayed or re-transmitted in any form, nor used for any commercial purposes, without the specific prior permission of the respective rights holders.\n&lt;&lt;&lt;\n\n''Limits on Liability:''\n&lt;&lt;&lt;\nAll materials are presented on an &quot;as-is&quot; basis and are subject to change without notice. The author of this document makes no claims regarding the suitability or reliability of the information presented, and assumes no liability for any damages that may occur as a result of its use.\n&lt;&lt;&lt;\n@@display:block;text-align:center;^^//please review these statements periodically, as they are subject to change without notice//^^@@\n\n''About DFWiki and Moodle New wiki'' [[DFWiki Readme|http://morfeo.upc.es/crom/file.php/4/tiddlywiki_integration/readme.txt]]\n&lt;&lt;&lt;\nDFWIKI is a project conceived and leaded by Ludo ( Marc Alier malier@lsi.upc.edu)\nto build a new wiki wiki module for moodle. I started on Feb 2005 and still goes on \nnow at late 2006.\n\nThis alternative Wiki module (called also new wiki) is the evolution of DFWiki to fit \nin Moodle 1.6 replacing the standard wiki module. The Moodle roadmap places n wiki \nas the oficial Wiki module for Moodle 1.8.\n \nAll the dfwiki development has been done within the frame of degree projects in\nthe Computer Science Engineering studies in the FIB school &quot;http://www.fib.upc.edu&quot; \nof the UPC University &quot;http://www.upc.edu&quot;\n\nThe main developers that have worked in this project are\n* Ferran Recio \n* David Castro \n* Jordi Piguillem Poch\n* Bernardino Todoli\n\nAnd a growing number of students that contributes to this project http://docs.moodle.org/en/Dfwikiteam\n\nDFWiki has two paralel projects :\nThe dfwiki Course . Wich alows to place a wiki in the main course page (even in the \nMoodle main course)\nThe wikiBook Module ( in development and soon released ) that allows to create a \nordered and due noted seqÃ¼ence of pages out of a chaotic wiki. It also will allow \nto place metadata, and export to formats like docBook, pdf, scorm and so on.\n\nDFWiki has the same license as moodle, whatever it is wink\nFind dfwiki news in moodle.org in &quot;using moodle&quot;-&gt; wiki forum and in the \nnew dfwiki home page. http://morfeo.upc.edu/crom\n\nLudo (Marc Alier) \n\nmalier@lsi.upc.edu\nhttp://www.lsi.upc.edu/~malier\n&lt;&lt;&lt;\n\n</div>
<div tiddler="Ludo(Marc Alier)" modifier="Ludo(Marc Alier)" modified="200610301113" created="200610301107" tags="dfWikiTeam">[&gt;img[http://static.flickr.com/80/267908220_64b1725a4d_o.jpg][http://morfeo.upc.edu/crom/]]\n[&lt;img[alt_text|http://www.lsi.upc.es/~malier/ludo03.jpg]]\nContact info:\n'''Ludo / Marc Alier ''' \nFacultat d'InformÃ tica de Barcelona' http:www.fib.upc.edu -\nDepartament de Llenguatges i Sistemes InformÃ tics - http://www.lis.upc.edu\nUniversitat PolitÃ¨cnica de Catalunya http://www.upc.edu\nmaito:malier@lsi.upc.es\nEdifici OMEGA - despatx 116\nJordi Girona Salgado, 1-3 E-08034 Barcelona\nTel +34 9341 37885\n[[Home page|http://www.lsi.upc.edu/~malier]]\n[[DFwikiLabs|http://morfeo.upc.edu/crom]]\n[[Orangoodle|http://orangoodle.blogspot.com]] .\n[[Orangoodling|http://orangoodling.blogspot.com]] \n[[Moodle New Wiki|http://appserv.lsi.upc.es/palangana/moodle/course/view.php?id=15]]\n[[Moodle Internalmail |http://appserv.lsi.upc.es/palangana/moodle/course/view.php?id=18]]\n[[J2MEMicroDB.|http://morfeo.upc.es/crom/course/view.php?id=5]]\n\n</div>
<div tiddler="MainMenu" modifier="YourName" modified="200801081929" created="200610301234" tags="">[[DFwikilabs Moodle NWiki, Internalmail, and more|http://morfeo.upc.edu/crom]]\n[[Orangoodling the blog (castellano)|http://orangoodling.blogspot.com]]\n[[Osos de viaje|http://ososdeviaje.dfwikilabs.org]]\n[[Osos de viaje old blog|http://ososdeviaje.wordpress.com]]\n[[dfwikilabs|http://www.dfwikilabs.org]]\n[[blog olpc|http://blogs.dfwikilabs.org/olpc]]\n\n\n[img[http://static.flickr.com/80/267908220_64b1725a4d_o.jpg][http://morfeo.upc.edu/crom/]]\n'''[[Download this Tiddlywiki|http://moodle.tiddlyspot.com/]]'''\n----\nImportDFwikisPlugin\nExportTiddlersToDFwikiPlugin\nSynchronizePlugin\n[[Installation Instructions]]\n[[Download and Updates|http://morfeo.upc.es/crom/course/view.php?id=4]]\n[[DFWikiTeam]]\n[[RSS Feed|http://moodle.tiddlyspot.com/index.xml]]\n[[License And Legal Aspects]]\n[[Bookmark|http://del.icio.us/granludo]]\n[[Editor Tools]]\n&lt;script&gt;\nvar _uacct=&quot;&quot;; // set up the Urchin Account\nvar _userv=1; // service mode (0=local,1=remote,2=both)\n\n//-- UTM User Settings\nvar _ufsc=1; // set client info flag (1=on|0=off)\nvar _udn=&quot;auto&quot;; // (auto|none|domain) set the domain name for cookies\nvar _uhash=&quot;on&quot;; // (on|off) unique domain hash for cookies\nvar _utimeout=&quot;1800&quot;; // set the inactive session timeout in seconds\nvar _ugifpath=&quot;/__utm.gif&quot;; // set the web path to the __utm.gif file\nvar _utsp=&quot;|&quot;; // transaction field separator\nvar _uflash=1; // set flash version detect option (1=on|0=off)\nvar _utitle=1; // set the document title detect option (1=on|0=off)\nvar _ulink=0; // enable linker functionality (1=on|0=off)\nvar _uanchor=0; // enable use of anchors for campaign (1=on|0=off)\nvar _utcp=&quot;/&quot;; // the cookie path for tracking\nvar _usample=100; // The sampling % of visitors to track (1-100).\n\n//-- UTM Campaign Tracking Settings\nvar _uctm=1; // set campaign tracking module (1=on|0=off)\nvar _ucto=&quot;15768000&quot;; // set timeout in seconds (6 month default)\nvar _uccn=&quot;utm_campaign&quot;; // name\nvar _ucmd=&quot;utm_medium&quot;; // medium (cpc|cpm|link|email|organic)\nvar _ucsr=&quot;utm_source&quot;; // source\nvar _uctr=&quot;utm_term&quot;; // term/keyword\nvar _ucct=&quot;utm_content&quot;; // content\nvar _ucid=&quot;utm_id&quot;; // id number\nvar _ucno=&quot;utm_nooverride&quot;; // don't override\n\n//-- Auto/Organic Sources and Keywords\nvar _uOsr=new Array();\nvar _uOkw=new Array();\n_uOsr[0]=&quot;google&quot;; _uOkw[0]=&quot;q&quot;;\n_uOsr[1]=&quot;yahoo&quot;; _uOkw[1]=&quot;p&quot;;\n_uOsr[2]=&quot;msn&quot;; _uOkw[2]=&quot;q&quot;;\n_uOsr[3]=&quot;aol&quot;; _uOkw[3]=&quot;query&quot;;\n_uOsr[4]=&quot;aol&quot;; _uOkw[4]=&quot;encquery&quot;;\n_uOsr[5]=&quot;lycos&quot;; _uOkw[5]=&quot;query&quot;;\n_uOsr[6]=&quot;ask&quot;; _uOkw[6]=&quot;q&quot;;\n_uOsr[7]=&quot;altavista&quot;; _uOkw[7]=&quot;q&quot;;\n_uOsr[8]=&quot;search&quot;; _uOkw[8]=&quot;q&quot;;\n_uOsr[9]=&quot;netscape&quot;; _uOkw[9]=&quot;s&quot;;\n_uOsr[10]=&quot;cnn&quot;; _uOkw[10]=&quot;query&quot;;\n_uOsr[11]=&quot;looksmart&quot;; _uOkw[11]=&quot;qt&quot;;\n_uOsr[12]=&quot;about&quot;; _uOkw[12]=&quot;terms&quot;;\n_uOsr[13]=&quot;mamma&quot;; _uOkw[13]=&quot;query&quot;;\n_uOsr[14]=&quot;alltheweb&quot;; _uOkw[14]=&quot;q&quot;;\n_uOsr[15]=&quot;gigablast&quot;; _uOkw[15]=&quot;q&quot;;\n_uOsr[16]=&quot;voila&quot;; _uOkw[16]=&quot;kw&quot;;\n_uOsr[17]=&quot;virgilio&quot;; _uOkw[17]=&quot;qs&quot;;\n_uOsr[18]=&quot;live&quot;; _uOkw[18]=&quot;q&quot;;\n_uOsr[19]=&quot;baidu&quot;; _uOkw[19]=&quot;wd&quot;;\n_uOsr[20]=&quot;alice&quot;; _uOkw[20]=&quot;qs&quot;;\n_uOsr[21]=&quot;seznam&quot;; _uOkw[21]=&quot;w&quot;;\n_uOsr[22]=&quot;yandex&quot;; _uOkw[22]=&quot;text&quot;;\n_uOsr[23]=&quot;najdi&quot;; _uOkw[23]=&quot;q&quot;;\n\n//-- Auto/Organic Keywords to Ignore\nvar _uOno=new Array();\n//_uOno[0]=&quot;urchin&quot;;\n//_uOno[1]=&quot;urchin.com&quot;;\n//_uOno[2]=&quot;www.urchin.com&quot;;\n\n//-- Referral domains to Ignore\nvar _uRno=new Array();\n//_uRno[0]=&quot;.urchin.com&quot;;\n\n//-- **** Don't modify below this point ***\nvar _uff,_udh,_udt,_ubl=0,_udo=&quot;&quot;,_uu,_ufns=0,_uns=0,_ur=&quot;-&quot;,_ufno=0,_ust=0,_ubd=document,_udl=_ubd.location,_udlh=&quot;&quot;,_uwv=&quot;1&quot;;\nvar _ugifpath2=&quot;http://www.google-analytics.com/__utm.gif&quot;;\nif (_udl.hash) _udlh=_udl.href.substring(_udl.href.indexOf('#'));\nif (_udl.protocol==&quot;https:&quot;) _ugifpath2=&quot;https://ssl.google-analytics.com/__utm.gif&quot;;\nif (!_utcp || _utcp==&quot;&quot;) _utcp=&quot;/&quot;;\nfunction urchinTracker(page) {\n if (_udl.protocol==&quot;file:&quot;) return;\n if (_uff &amp;&amp; (!page || page==&quot;&quot;)) return;\n var a,b,c,xx,v,z,k,x=&quot;&quot;,s=&quot;&quot;,f=0;\n var nx=&quot; expires=Sun, 18 Jan 2038 00:00:00 GMT;&quot;;\n var dc=_ubd.cookie;\n _udh=_uDomain();\n if (!_uVG()) return;\n _uu=Math.round(Math.random()*2147483647);\n _udt=new Date();\n _ust=Math.round(_udt.getTime()/1000);\n a=dc.indexOf(&quot;__utma=&quot;+_udh);\n b=dc.indexOf(&quot;__utmb=&quot;+_udh);\n c=dc.indexOf(&quot;__utmc=&quot;+_udh);\n if (_udn &amp;&amp; _udn!=&quot;&quot;) { _udo=&quot; domain=&quot;+_udn+&quot;;&quot;; }\n if (_utimeout &amp;&amp; _utimeout!=&quot;&quot;) {\n x=new Date(_udt.getTime()+(_utimeout*1000));\n x=&quot; expires=&quot;+x.toGMTString()+&quot;;&quot;;\n }\n if (_ulink) {\n if (_uanchor &amp;&amp; _udlh &amp;&amp; _udlh!=&quot;&quot;) s=_udlh+&quot;&amp;&quot;;\n s+=_udl.search;\n if(s &amp;&amp; s!=&quot;&quot; &amp;&amp; s.indexOf(&quot;__utma=&quot;)&gt;=0) {\n if (!(_uIN(a=_uGC(s,&quot;__utma=&quot;,&quot;&amp;&quot;)))) a=&quot;-&quot;;\n if (!(_uIN(b=_uGC(s,&quot;__utmb=&quot;,&quot;&amp;&quot;)))) b=&quot;-&quot;;\n if (!(_uIN(c=_uGC(s,&quot;__utmc=&quot;,&quot;&amp;&quot;)))) c=&quot;-&quot;;\n v=_uGC(s,&quot;__utmv=&quot;,&quot;&amp;&quot;);\n z=_uGC(s,&quot;__utmz=&quot;,&quot;&amp;&quot;);\n k=_uGC(s,&quot;__utmk=&quot;,&quot;&amp;&quot;);\n xx=_uGC(s,&quot;__utmx=&quot;,&quot;&amp;&quot;);\n if ((k*1) != ((_uHash(a+b+c+xx+z+v)*1)+(_udh*1))) {_ubl=1;a=&quot;-&quot;;b=&quot;-&quot;;c=&quot;-&quot;;xx=&quot;-&quot;;z=&quot;-&quot;;v=&quot;-&quot;;}\n if (a!=&quot;-&quot; &amp;&amp; b!=&quot;-&quot; &amp;&amp; c!=&quot;-&quot;) f=1;\n else if(a!=&quot;-&quot;) f=2;\n }\n }\n if(f==1) {\n _ubd.cookie=&quot;__utma=&quot;+a+&quot;; path=&quot;+_utcp+&quot;;&quot;+nx+_udo;\n _ubd.cookie=&quot;__utmb=&quot;+b+&quot;; path=&quot;+_utcp+&quot;;&quot;+x+_udo;\n _ubd.cookie=&quot;__utmc=&quot;+c+&quot;; path=&quot;+_utcp+&quot;;&quot;+_udo;\n } else if (f==2) {\n a=_uFixA(s,&quot;&amp;&quot;,_ust);\n _ubd.cookie=&quot;__utma=&quot;+a+&quot;; path=&quot;+_utcp+&quot;;&quot;+nx+_udo;\n _ubd.cookie=&quot;__utmb=&quot;+_udh+&quot;; path=&quot;+_utcp+&quot;;&quot;+x+_udo;\n _ubd.cookie=&quot;__utmc=&quot;+_udh+&quot;; path=&quot;+_utcp+&quot;;&quot;+_udo;\n _ufns=1;\n } else if (a&gt;=0 &amp;&amp; b&gt;=0 &amp;&amp; c&gt;=0) {\n _ubd.cookie=&quot;__utmb=&quot;+_udh+&quot;; path=&quot;+_utcp+&quot;;&quot;+x+_udo;\n } else {\n if (a&gt;=0) a=_uFixA(_ubd.cookie,&quot;;&quot;,_ust);\n else a=_udh+&quot;.&quot;+_uu+&quot;.&quot;+_ust+&quot;.&quot;+_ust+&quot;.&quot;+_ust+&quot;.1&quot;;\n _ubd.cookie=&quot;__utma=&quot;+a+&quot;; path=&quot;+_utcp+&quot;;&quot;+nx+_udo;\n _ubd.cookie=&quot;__utmb=&quot;+_udh+&quot;; path=&quot;+_utcp+&quot;;&quot;+x+_udo;\n _ubd.cookie=&quot;__utmc=&quot;+_udh+&quot;; path=&quot;+_utcp+&quot;;&quot;+_udo;\n _ufns=1;\n }\n if (_ulink &amp;&amp; xx &amp;&amp; xx!=&quot;&quot; &amp;&amp; xx!=&quot;-&quot;) {\n xx=_uUES(xx);\n if (xx.indexOf(&quot;;&quot;)==-1) _ubd.cookie=&quot;__utmx=&quot;+xx+&quot;; path=&quot;+_utcp+&quot;;&quot;+nx+_udo;\n }\n if (_ulink &amp;&amp; v &amp;&amp; v!=&quot;&quot; &amp;&amp; v!=&quot;-&quot;) {\n v=_uUES(v);\n if (v.indexOf(&quot;;&quot;)==-1) _ubd.cookie=&quot;__utmv=&quot;+v+&quot;; path=&quot;+_utcp+&quot;;&quot;+nx+_udo;\n }\n _uInfo(page);\n _ufns=0;\n _ufno=0;\n _uff=1;\n}\nfunction _uInfo(page) {\n var p,s=&quot;&quot;,dm=&quot;&quot;,pg=_udl.pathname+_udl.search;\n if (page &amp;&amp; page!=&quot;&quot;) pg=_uES(page,1);\n _ur=_ubd.referrer;\n if (!_ur || _ur==&quot;&quot;) { _ur=&quot;-&quot;; }\n else {\n dm=_ubd.domain;\n if(_utcp &amp;&amp; _utcp!=&quot;/&quot;) dm+=_utcp;\n p=_ur.indexOf(dm);\n if ((p&gt;=0) &amp;&amp; (p&lt;=8)) { _ur=&quot;0&quot;; }\n if (_ur.indexOf(&quot;[&quot;)==0 &amp;&amp; _ur.lastIndexOf(&quot;]&quot;)==(_ur.length-1)) { _ur=&quot;-&quot;; }\n }\n s+=&quot;&amp;utmn=&quot;+_uu;\n if (_ufsc) s+=_uBInfo();\n if (_uctm) s+=_uCInfo();\n if (_utitle &amp;&amp; _ubd.title &amp;&amp; _ubd.title!=&quot;&quot;) s+=&quot;&amp;utmdt=&quot;+_uES(_ubd.title);\n if (_udl.hostname &amp;&amp; _udl.hostname!=&quot;&quot;) s+=&quot;&amp;utmhn=&quot;+_uES(_udl.hostname);\n s+=&quot;&amp;utmr=&quot;+_ur;\n s+=&quot;&amp;utmp=&quot;+pg;\n if ((_userv==0 || _userv==2) &amp;&amp; _uSP()) {\n var i=new Image(1,1);\n i.src=_ugifpath+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s;\n i.onload=function() {_uVoid();}\n }\n if ((_userv==1 || _userv==2) &amp;&amp; _uSP()) {\n var i2=new Image(1,1);\n i2.src=_ugifpath2+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s+&quot;&amp;utmac=&quot;+_uacct+&quot;&amp;utmcc=&quot;+_uGCS();\n i2.onload=function() { _uVoid(); }\n }\n return;\n}\nfunction _uVoid() { return; }\nfunction _uCInfo() {\n if (!_ucto || _ucto==&quot;&quot;) { _ucto=&quot;15768000&quot;; }\n if (!_uVG()) return;\n var c=&quot;&quot;,t=&quot;-&quot;,t2=&quot;-&quot;,t3=&quot;-&quot;,o=0,cs=0,cn=0,i=0,z=&quot;-&quot;,s=&quot;&quot;;\n if (_uanchor &amp;&amp; _udlh &amp;&amp; _udlh!=&quot;&quot;) s=_udlh+&quot;&amp;&quot;;\n s+=_udl.search;\n var x=new Date(_udt.getTime()+(_ucto*1000));\n var dc=_ubd.cookie;\n x=&quot; expires=&quot;+x.toGMTString()+&quot;;&quot;;\n if (_ulink &amp;&amp; !_ubl) {\n z=_uUES(_uGC(s,&quot;__utmz=&quot;,&quot;&amp;&quot;));\n if (z!=&quot;-&quot; &amp;&amp; z.indexOf(&quot;;&quot;)==-1) { _ubd.cookie=&quot;__utmz=&quot;+z+&quot;; path=&quot;+_utcp+&quot;;&quot;+x+_udo; return &quot;&quot;; }\n }\n z=dc.indexOf(&quot;__utmz=&quot;+_udh);\n if (z&gt;-1) { z=_uGC(dc,&quot;__utmz=&quot;+_udh,&quot;;&quot;); }\n else { z=&quot;-&quot;; }\n t=_uGC(s,_ucid+&quot;=&quot;,&quot;&amp;&quot;);\n t2=_uGC(s,_ucsr+&quot;=&quot;,&quot;&amp;&quot;);\n t3=_uGC(s,&quot;gclid=&quot;,&quot;&amp;&quot;);\n if ((t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) || (t2!=&quot;-&quot; &amp;&amp; t2!=&quot;&quot;) || (t3!=&quot;-&quot; &amp;&amp; t3!=&quot;&quot;)) {\n if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;utmcid=&quot;+_uEC(t);\n if (t2!=&quot;-&quot; &amp;&amp; t2!=&quot;&quot;) { if (c != &quot;&quot;) c+=&quot;|&quot;; c+=&quot;utmcsr=&quot;+_uEC(t2); }\n if (t3!=&quot;-&quot; &amp;&amp; t3!=&quot;&quot;) { if (c != &quot;&quot;) c+=&quot;|&quot;; c+=&quot;utmgclid=&quot;+_uEC(t3); }\n t=_uGC(s,_uccn+&quot;=&quot;,&quot;&amp;&quot;);\n if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;|utmccn=&quot;+_uEC(t);\n else c+=&quot;|utmccn=(not+set)&quot;;\n t=_uGC(s,_ucmd+&quot;=&quot;,&quot;&amp;&quot;);\n if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;|utmcmd=&quot;+_uEC(t);\n else c+=&quot;|utmcmd=(not+set)&quot;;\n t=_uGC(s,_uctr+&quot;=&quot;,&quot;&amp;&quot;);\n if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;|utmctr=&quot;+_uEC(t);\n else { t=_uOrg(1); if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;|utmctr=&quot;+_uEC(t); }\n t=_uGC(s,_ucct+&quot;=&quot;,&quot;&amp;&quot;);\n if (t!=&quot;-&quot; &amp;&amp; t!=&quot;&quot;) c+=&quot;|utmcct=&quot;+_uEC(t);\n t=_uGC(s,_ucno+&quot;=&quot;,&quot;&amp;&quot;);\n if (t==&quot;1&quot;) o=1;\n if (z!=&quot;-&quot; &amp;&amp; o==1) return &quot;&quot;;\n }\n if (c==&quot;-&quot; || c==&quot;&quot;) { c=_uOrg(); if (z!=&quot;-&quot; &amp;&amp; _ufno==1) return &quot;&quot;; }\n if (c==&quot;-&quot; || c==&quot;&quot;) { if (_ufns==1) c=_uRef(); if (z!=&quot;-&quot; &amp;&amp; _ufno==1) return &quot;&quot;; }\n if (c==&quot;-&quot; || c==&quot;&quot;) {\n if (z==&quot;-&quot; &amp;&amp; _ufns==1) { c=&quot;utmccn=(direct)|utmcsr=(direct)|utmcmd=(none)&quot;; }\n if (c==&quot;-&quot; || c==&quot;&quot;) return &quot;&quot;;\n }\n if (z!=&quot;-&quot;) {\n i=z.indexOf(&quot;.&quot;);\n if (i&gt;-1) i=z.indexOf(&quot;.&quot;,i+1);\n if (i&gt;-1) i=z.indexOf(&quot;.&quot;,i+1);\n if (i&gt;-1) i=z.indexOf(&quot;.&quot;,i+1);\n t=z.substring(i+1,z.length);\n if (t.toLowerCase()==c.toLowerCase()) cs=1;\n t=z.substring(0,i);\n if ((i=t.lastIndexOf(&quot;.&quot;)) &gt; -1) {\n t=t.substring(i+1,t.length);\n cn=(t*1);\n }\n }\n if (cs==0 || _ufns==1) {\n t=_uGC(dc,&quot;__utma=&quot;+_udh,&quot;;&quot;);\n if ((i=t.lastIndexOf(&quot;.&quot;)) &gt; 9) {\n _uns=t.substring(i+1,t.length);\n _uns=(_uns*1);\n }\n cn++;\n if (_uns==0) _uns=1;\n _ubd.cookie=&quot;__utmz=&quot;+_udh+&quot;.&quot;+_ust+&quot;.&quot;+_uns+&quot;.&quot;+cn+&quot;.&quot;+c+&quot;; path=&quot;+_utcp+&quot;; &quot;+x+_udo;\n }\n if (cs==0 || _ufns==1) return &quot;&amp;utmcn=1&quot;;\n else return &quot;&amp;utmcr=1&quot;;\n}\nfunction _uRef() {\n if (_ur==&quot;0&quot; || _ur==&quot;&quot; || _ur==&quot;-&quot;) return &quot;&quot;;\n var i=0,h,k,n;\n if ((i=_ur.indexOf(&quot;://&quot;))&lt;0) return &quot;&quot;;\n h=_ur.substring(i+3,_ur.length);\n if (h.indexOf(&quot;/&quot;) &gt; -1) {\n k=h.substring(h.indexOf(&quot;/&quot;),h.length);\n if (k.indexOf(&quot;?&quot;) &gt; -1) k=k.substring(0,k.indexOf(&quot;?&quot;));\n h=h.substring(0,h.indexOf(&quot;/&quot;));\n }\n h=h.toLowerCase();\n n=h;\n if ((i=n.indexOf(&quot;:&quot;)) &gt; -1) n=n.substring(0,i);\n for (var ii=0;ii&lt;_uRno.length;ii++) {\n if ((i=n.indexOf(_uRno[ii].toLowerCase())) &gt; -1 &amp;&amp; n.length==(i+_uRno[ii].length)) { _ufno=1; break; }\n }\n if (h.indexOf(&quot;www.&quot;)==0) h=h.substring(4,h.length);\n return &quot;utmccn=(referral)|utmcsr=&quot;+_uEC(h)+&quot;|&quot;+&quot;utmcct=&quot;+_uEC(k)+&quot;|utmcmd=referral&quot;;\n}\nfunction _uOrg(t) {\n if (_ur==&quot;0&quot; || _ur==&quot;&quot; || _ur==&quot;-&quot;) return &quot;&quot;;\n var i=0,h,k;\n if ((i=_ur.indexOf(&quot;://&quot;)) &lt; 0) return &quot;&quot;;\n h=_ur.substring(i+3,_ur.length);\n if (h.indexOf(&quot;/&quot;) &gt; -1) {\n h=h.substring(0,h.indexOf(&quot;/&quot;));\n }\n for (var ii=0;ii&lt;_uOsr.length;ii++) {\n if (h.toLowerCase().indexOf(_uOsr[ii].toLowerCase()) &gt; -1) {\n if ((i=_ur.indexOf(&quot;?&quot;+_uOkw[ii]+&quot;=&quot;)) &gt; -1 || (i=_ur.indexOf(&quot;&amp;&quot;+_uOkw[ii]+&quot;=&quot;)) &gt; -1) {\n k=_ur.substring(i+_uOkw[ii].length+2,_ur.length);\n if ((i=k.indexOf(&quot;&amp;&quot;)) &gt; -1) k=k.substring(0,i);\n for (var yy=0;yy&lt;_uOno.length;yy++) {\n if (_uOno[yy].toLowerCase()==k.toLowerCase()) { _ufno=1; break; }\n }\n if (t) return _uEC(k);\n else return &quot;utmccn=(organic)|utmcsr=&quot;+_uEC(_uOsr[ii])+&quot;|&quot;+&quot;utmctr=&quot;+_uEC(k)+&quot;|utmcmd=organic&quot;;\n }\n }\n }\n return &quot;&quot;;\n}\nfunction _uBInfo() {\n var sr=&quot;-&quot;,sc=&quot;-&quot;,ul=&quot;-&quot;,fl=&quot;-&quot;,cs=&quot;-&quot;,je=1;\n var n=navigator;\n if (self.screen) {\n sr=screen.width+&quot;x&quot;+screen.height;\n sc=screen.colorDepth+&quot;-bit&quot;;\n } else if (self.java) {\n var j=java.awt.Toolkit.getDefaultToolkit();\n var s=j.getScreenSize();\n sr=s.width+&quot;x&quot;+s.height;\n }\n if (n.language) { ul=n.language.toLowerCase(); }\n else if (n.browserLanguage) { ul=n.browserLanguage.toLowerCase(); }\n je=n.javaEnabled()?1:0;\n if (_uflash) fl=_uFlash();\n if (_ubd.characterSet) cs=_uES(_ubd.characterSet);\n else if (_ubd.charset) cs=_uES(_ubd.charset);\n return &quot;&amp;utmcs=&quot;+cs+&quot;&amp;utmsr=&quot;+sr+&quot;&amp;utmsc=&quot;+sc+&quot;&amp;utmul=&quot;+ul+&quot;&amp;utmje=&quot;+je+&quot;&amp;utmfl=&quot;+fl;\n}\nfunction __utmSetTrans() {\n var e;\n if (_ubd.getElementById) e=_ubd.getElementById(&quot;utmtrans&quot;);\n else if (_ubd.utmform &amp;&amp; _ubd.utmform.utmtrans) e=_ubd.utmform.utmtrans;\n if (!e) return;\n var l=e.value.split(&quot;UTM:&quot;);\n var i,i2,c;\n if (_userv==0 || _userv==2) i=new Array();\n if (_userv==1 || _userv==2) { i2=new Array(); c=_uGCS(); }\n\n for (var ii=0;ii&lt;l.length;ii++) {\n l[ii]=_uTrim(l[ii]);\n if (l[ii].charAt(0)!='T' &amp;&amp; l[ii].charAt(0)!='I') continue;\n var r=Math.round(Math.random()*2147483647);\n if (!_utsp || _utsp==&quot;&quot;) _utsp=&quot;|&quot;;\n var f=l[ii].split(_utsp),s=&quot;&quot;;\n if (f[0].charAt(0)=='T') {\n s=&quot;&amp;utmt=tran&quot;+&quot;&amp;utmn=&quot;+r;\n f[1]=_uTrim(f[1]); if(f[1]&amp;&amp;f[1]!=&quot;&quot;) s+=&quot;&amp;utmtid=&quot;+_uES(f[1]);\n f[2]=_uTrim(f[2]); if(f[2]&amp;&amp;f[2]!=&quot;&quot;) s+=&quot;&amp;utmtst=&quot;+_uES(f[2]);\n f[3]=_uTrim(f[3]); if(f[3]&amp;&amp;f[3]!=&quot;&quot;) s+=&quot;&amp;utmtto=&quot;+_uES(f[3]);\n f[4]=_uTrim(f[4]); if(f[4]&amp;&amp;f[4]!=&quot;&quot;) s+=&quot;&amp;utmttx=&quot;+_uES(f[4]);\n f[5]=_uTrim(f[5]); if(f[5]&amp;&amp;f[5]!=&quot;&quot;) s+=&quot;&amp;utmtsp=&quot;+_uES(f[5]);\n f[6]=_uTrim(f[6]); if(f[6]&amp;&amp;f[6]!=&quot;&quot;) s+=&quot;&amp;utmtci=&quot;+_uES(f[6]);\n f[7]=_uTrim(f[7]); if(f[7]&amp;&amp;f[7]!=&quot;&quot;) s+=&quot;&amp;utmtrg=&quot;+_uES(f[7]);\n f[8]=_uTrim(f[8]); if(f[8]&amp;&amp;f[8]!=&quot;&quot;) s+=&quot;&amp;utmtco=&quot;+_uES(f[8]);\n } else {\n s=&quot;&amp;utmt=item&quot;+&quot;&amp;utmn=&quot;+r;\n f[1]=_uTrim(f[1]); if(f[1]&amp;&amp;f[1]!=&quot;&quot;) s+=&quot;&amp;utmtid=&quot;+_uES(f[1]);\n f[2]=_uTrim(f[2]); if(f[2]&amp;&amp;f[2]!=&quot;&quot;) s+=&quot;&amp;utmipc=&quot;+_uES(f[2]);\n f[3]=_uTrim(f[3]); if(f[3]&amp;&amp;f[3]!=&quot;&quot;) s+=&quot;&amp;utmipn=&quot;+_uES(f[3]);\n f[4]=_uTrim(f[4]); if(f[4]&amp;&amp;f[4]!=&quot;&quot;) s+=&quot;&amp;utmiva=&quot;+_uES(f[4]);\n f[5]=_uTrim(f[5]); if(f[5]&amp;&amp;f[5]!=&quot;&quot;) s+=&quot;&amp;utmipr=&quot;+_uES(f[5]);\n f[6]=_uTrim(f[6]); if(f[6]&amp;&amp;f[6]!=&quot;&quot;) s+=&quot;&amp;utmiqt=&quot;+_uES(f[6]);\n }\n if ((_userv==0 || _userv==2) &amp;&amp; _uSP()) {\n i[ii]=new Image(1,1);\n i[ii].src=_ugifpath+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s;\n i[ii].onload=function() { _uVoid(); }\n }\n if ((_userv==1 || _userv==2) &amp;&amp; _uSP()) {\n i2[ii]=new Image(1,1);\n i2[ii].src=_ugifpath2+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s+&quot;&amp;utmac=&quot;+_uacct+&quot;&amp;utmcc=&quot;+c;\n i2[ii].onload=function() { _uVoid(); }\n }\n }\n return;\n}\nfunction _uFlash() {\n var f=&quot;-&quot;,n=navigator;\n if (n.plugins &amp;&amp; n.plugins.length) {\n for (var ii=0;ii&lt;n.plugins.length;ii++) {\n if (n.plugins[ii].name.indexOf('Shockwave Flash')!=-1) {\n f=n.plugins[ii].description.split('Shockwave Flash ')[1];\n break;\n }\n }\n } else if (window.ActiveXObject) {\n for (var ii=10;ii&gt;=2;ii--) {\n try {\n var fl=eval(&quot;new ActiveXObject('ShockwaveFlash.ShockwaveFlash.&quot;+ii+&quot;');&quot;);\n if (fl) { f=ii + '.0'; break; }\n }\n catch(e) {}\n }\n }\n return f;\n}\nfunction __utmLinker(l,h) {\n if (!_ulink) return;\n var p,k,a=&quot;-&quot;,b=&quot;-&quot;,c=&quot;-&quot;,x=&quot;-&quot;,z=&quot;-&quot;,v=&quot;-&quot;;\n var dc=_ubd.cookie;\n if (!l || l==&quot;&quot;) return;\n var iq = l.indexOf(&quot;?&quot;); \n var ih = l.indexOf(&quot;#&quot;); \n if (dc) {\n a=_uES(_uGC(dc,&quot;__utma=&quot;+_udh,&quot;;&quot;));\n b=_uES(_uGC(dc,&quot;__utmb=&quot;+_udh,&quot;;&quot;));\n c=_uES(_uGC(dc,&quot;__utmc=&quot;+_udh,&quot;;&quot;));\n x=_uES(_uGC(dc,&quot;__utmx=&quot;+_udh,&quot;;&quot;));\n z=_uES(_uGC(dc,&quot;__utmz=&quot;+_udh,&quot;;&quot;));\n v=_uES(_uGC(dc,&quot;__utmv=&quot;+_udh,&quot;;&quot;));\n k=(_uHash(a+b+c+x+z+v)*1)+(_udh*1);\n p=&quot;__utma=&quot;+a+&quot;&amp;__utmb=&quot;+b+&quot;&amp;__utmc=&quot;+c+&quot;&amp;__utmx=&quot;+x+&quot;&amp;__utmz=&quot;+z+&quot;&amp;__utmv=&quot;+v+&quot;&amp;__utmk=&quot;+k;\n }\n if (p) {\n if (h &amp;&amp; ih&gt;-1) return;\n if (h) { _udl.href=l+&quot;#&quot;+p; }\n else {\n if (iq==-1 &amp;&amp; ih==-1) _udl.href=l+&quot;?&quot;+p;\n else if (ih==-1) _udl.href=l+&quot;&amp;&quot;+p;\n else if (iq==-1) _udl.href=l.substring(0,ih-1)+&quot;?&quot;+p+l.substring(ih);\n else _udl.href=l.substring(0,ih-1)+&quot;&amp;&quot;+p+l.substring(ih);\n }\n } else { _udl.href=l; }\n}\nfunction __utmLinkPost(f,h) {\n if (!_ulink) return;\n var p,k,a=&quot;-&quot;,b=&quot;-&quot;,c=&quot;-&quot;,x=&quot;-&quot;,z=&quot;-&quot;,v=&quot;-&quot;;\n var dc=_ubd.cookie;\n if (!f || !f.action) return;\n var iq = f.action.indexOf(&quot;?&quot;); \n var ih = f.action.indexOf(&quot;#&quot;); \n if (dc) {\n a=_uES(_uGC(dc,&quot;__utma=&quot;+_udh,&quot;;&quot;));\n b=_uES(_uGC(dc,&quot;__utmb=&quot;+_udh,&quot;;&quot;));\n c=_uES(_uGC(dc,&quot;__utmc=&quot;+_udh,&quot;;&quot;));\n x=_uES(_uGC(dc,&quot;__utmx=&quot;+_udh,&quot;;&quot;));\n z=_uES(_uGC(dc,&quot;__utmz=&quot;+_udh,&quot;;&quot;));\n v=_uES(_uGC(dc,&quot;__utmv=&quot;+_udh,&quot;;&quot;));\n k=(_uHash(a+b+c+x+z+v)*1)+(_udh*1);\n p=&quot;__utma=&quot;+a+&quot;&amp;__utmb=&quot;+b+&quot;&amp;__utmc=&quot;+c+&quot;&amp;__utmx=&quot;+x+&quot;&amp;__utmz=&quot;+z+&quot;&amp;__utmv=&quot;+v+&quot;&amp;__utmk=&quot;+k;\n }\n if (p) {\n if (h &amp;&amp; ih&gt;-1) return;\n if (h) { f.action+=&quot;#&quot;+p; }\n else {\n if (iq==-1 &amp;&amp; ih==-1) f.action+=&quot;?&quot;+p;\n else if (ih==-1) f.action+=&quot;&amp;&quot;+p;\n else if (iq==-1) f.action=f.action.substring(0,ih-1)+&quot;?&quot;+p+f.action.substring(ih);\n else f.action=f.action.substring(0,ih-1)+&quot;&amp;&quot;+p+f.action.substring(ih);\n }\n }\n return;\n}\nfunction __utmSetVar(v) {\n if (!v || v==&quot;&quot;) return;\n if (!_udo || _udo == &quot;&quot;) {\n _udh=_uDomain();\n if (_udn &amp;&amp; _udn!=&quot;&quot;) { _udo=&quot; domain=&quot;+_udn+&quot;;&quot;; }\n }\n if (!_uVG()) return;\n var r=Math.round(Math.random() * 2147483647);\n _ubd.cookie=&quot;__utmv=&quot;+_udh+&quot;.&quot;+_uES(v)+&quot;; path=&quot;+_utcp+&quot;; expires=Sun, 18 Jan 2038 00:00:00 GMT;&quot;+_udo;\n var s=&quot;&amp;utmt=var&amp;utmn=&quot;+r;\n if ((_userv==0 || _userv==2) &amp;&amp; _uSP()) {\n var i=new Image(1,1);\n i.src=_ugifpath+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s;\n i.onload=function() { _uVoid(); }\n }\n if ((_userv==1 || _userv==2) &amp;&amp; _uSP()) {\n var i2=new Image(1,1);\n i2.src=_ugifpath2+&quot;?&quot;+&quot;utmwv=&quot;+_uwv+s+&quot;&amp;utmac=&quot;+_uacct+&quot;&amp;utmcc=&quot;+_uGCS();\n i2.onload=function() { _uVoid(); }\n }\n}\nfunction _uGCS() {\n var t,c=&quot;&quot;,dc=_ubd.cookie;\n if ((t=_uGC(dc,&quot;__utma=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utma=&quot;+t+&quot;;+&quot;);\n if ((t=_uGC(dc,&quot;__utmb=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utmb=&quot;+t+&quot;;+&quot;);\n if ((t=_uGC(dc,&quot;__utmc=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utmc=&quot;+t+&quot;;+&quot;);\n if ((t=_uGC(dc,&quot;__utmx=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utmx=&quot;+t+&quot;;+&quot;);\n if ((t=_uGC(dc,&quot;__utmz=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utmz=&quot;+t+&quot;;+&quot;);\n if ((t=_uGC(dc,&quot;__utmv=&quot;+_udh,&quot;;&quot;))!=&quot;-&quot;) c+=_uES(&quot;__utmv=&quot;+t+&quot;;&quot;);\n if (c.charAt(c.length-1)==&quot;+&quot;) c=c.substring(0,c.length-1);\n return c;\n}\nfunction _uGC(l,n,s) {\n if (!l || l==&quot;&quot; || !n || n==&quot;&quot; || !s || s==&quot;&quot;) return &quot;-&quot;;\n var i,i2,i3,c=&quot;-&quot;;\n i=l.indexOf(n);\n i3=n.indexOf(&quot;=&quot;)+1;\n if (i &gt; -1) {\n i2=l.indexOf(s,i); if (i2 &lt; 0) { i2=l.length; }\n c=l.substring((i+i3),i2);\n }\n return c;\n}\nfunction _uDomain() {\n if (!_udn || _udn==&quot;&quot; || _udn==&quot;none&quot;) { _udn=&quot;&quot;; return 1; }\n if (_udn==&quot;auto&quot;) {\n var d=_ubd.domain;\n if (d.substring(0,4)==&quot;www.&quot;) {\n d=d.substring(4,d.length);\n }\n _udn=d;\n }\n if (_uhash==&quot;off&quot;) return 1;\n return _uHash(_udn);\n}\nfunction _uHash(d) {\n if (!d || d==&quot;&quot;) return 1;\n var h=0,g=0;\n for (var i=d.length-1;i&gt;=0;i--) {\n var c=parseInt(d.charCodeAt(i));\n h=((h &lt;&lt; 6) &amp; 0xfffffff) + c + (c &lt;&lt; 14);\n if ((g=h &amp; 0xfe00000)!=0) h=(h ^ (g &gt;&gt; 21));\n }\n return h;\n}\nfunction _uFixA(c,s,t) {\n if (!c || c==&quot;&quot; || !s || s==&quot;&quot; || !t || t==&quot;&quot;) return &quot;-&quot;;\n var a=_uGC(c,&quot;__utma=&quot;+_udh,s);\n var lt=0,i=0;\n if ((i=a.lastIndexOf(&quot;.&quot;)) &gt; 9) {\n _uns=a.substring(i+1,a.length);\n _uns=(_uns*1)+1;\n a=a.substring(0,i);\n if ((i=a.lastIndexOf(&quot;.&quot;)) &gt; 7) {\n lt=a.substring(i+1,a.length);\n a=a.substring(0,i);\n }\n if ((i=a.lastIndexOf(&quot;.&quot;)) &gt; 5) {\n a=a.substring(0,i);\n }\n a+=&quot;.&quot;+lt+&quot;.&quot;+t+&quot;.&quot;+_uns;\n }\n return a;\n}\nfunction _uTrim(s) {\n if (!s || s==&quot;&quot;) return &quot;&quot;;\n while ((s.charAt(0)==' ') || (s.charAt(0)=='\sn') || (s.charAt(0,1)=='\sr')) s=s.substring(1,s.length);\n while ((s.charAt(s.length-1)==' ') || (s.charAt(s.length-1)=='\sn') || (s.charAt(s.length-1)=='\sr')) s=s.substring(0,s.length-1);\n return s;\n}\nfunction _uEC(s) {\n var n=&quot;&quot;;\n if (!s || s==&quot;&quot;) return &quot;&quot;;\n for (var i=0;i&lt;s.length;i++) {if (s.charAt(i)==&quot; &quot;) n+=&quot;+&quot;; else n+=s.charAt(i);}\n return n;\n}\nfunction __utmVisitorCode(f) {\n var r=0,t=0,i=0,i2=0,m=31;\n var a=_uGC(_ubd.cookie,&quot;__utma=&quot;+_udh,&quot;;&quot;);\n if ((i=a.indexOf(&quot;.&quot;,0))&lt;0) return;\n if ((i2=a.indexOf(&quot;.&quot;,i+1))&gt;0) r=a.substring(i+1,i2); else return &quot;&quot;; \n if ((i=a.indexOf(&quot;.&quot;,i2+1))&gt;0) t=a.substring(i2+1,i); else return &quot;&quot;; \n if (f) {\n return r;\n } else {\n var c=new Array('A','B','C','D','E','F','G','H','J','K','L','M','N','P','R','S','T','U','V','W','X','Y','Z','1','2','3','4','5','6','7','8','9');\n return c[r&gt;&gt;28&amp;m]+c[r&gt;&gt;23&amp;m]+c[r&gt;&gt;18&amp;m]+c[r&gt;&gt;13&amp;m]+&quot;-&quot;+c[r&gt;&gt;8&amp;m]+c[r&gt;&gt;3&amp;m]+c[((r&amp;7)&lt;&lt;2)+(t&gt;&gt;30&amp;3)]+c[t&gt;&gt;25&amp;m]+c[t&gt;&gt;20&amp;m]+&quot;-&quot;+c[t&gt;&gt;15&amp;m]+c[t&gt;&gt;10&amp;m]+c[t&gt;&gt;5&amp;m]+c[t&amp;m];\n }\n}\nfunction _uIN(n) {\n if (!n) return false;\n for (var i=0;i&lt;n.length;i++) {\n var c=n.charAt(i);\n if ((c&lt;&quot;0&quot; || c&gt;&quot;9&quot;) &amp;&amp; (c!=&quot;.&quot;)) return false;\n }\n return true;\n}\nfunction _uES(s,u) {\n if (typeof(encodeURIComponent) == 'function') {\n if (u) return encodeURI(s);\n else return encodeURIComponent(s);\n } else {\n return escape(s);\n }\n}\nfunction _uUES(s) {\n if (typeof(decodeURIComponent) == 'function') {\n return decodeURIComponent(s);\n } else {\n return unescape(s);\n }\n}\nfunction _uVG() {\n if((_udn.indexOf(&quot;www.google.&quot;) == 0 || _udn.indexOf(&quot;.google.&quot;) == 0 || _udn.indexOf(&quot;google.&quot;) == 0) &amp;&amp; _utcp=='/') {\n return false;\n }\n return true;\n}\nfunction _uSP() {\n var s=100;\n if (_usample) s=_usample;\n if(s&gt;=100 || s&lt;=0) return true;\n return ((__utmVisitorCode(1)%10000)&lt;(s*100));\n}\n\n_uacct = &quot;UA-442126-7&quot;;urchinTracker();\n&lt;/script&gt;\n\n&lt;script  src=&quot;http://embed.technorati.com/embed/vddq934kug.js&quot;&gt;\n&lt;/script&gt;</div>
<div tiddler="Moodle" modifier="Ludo" modified="200611181655" created="200611181655" tags="">[[Moodle|http://moodle.org]] is a course management system (CMS) - a free, Open Source software package designed using sound pedagogical principles, to help educators create effective online learning communities. You can download and use it on any computer you have handy (including webhosts), yet it can scale from a single-teacher site to a 50,000-student University. This site itself is created using Moodle, so check out the Moodle Demonstration Courses or read the latest Moodle Buzz.</div>
<div tiddler="Moodle N Wiki" modifier="Ludo(Marc Alier)" modified="200610301150" created="200610301134" tags="dfWikiTeam">''Moodle N Wiki'' is what we call a new [[activity Module]] developed for the [[Moodle]] comunity to replace the current wiki module. \n\n[[N Wiki]] or [[NWiki]] is a short name for New Wiki. N Wiki is based on another Wiki activity Module called [[DFWiki]]. \n\nThe N Wiki module is the evolution of DFWiki to fit in [[Moodle]] 1.6 and later replacing the standard wiki module. \nThe [[Moodle roadmap]] places N Wiki as the oficial [[Wiki]] module for Moodle 1.8.\n \nN Wiki has two paralel projects :\n*The [[Wiki Course format]] . Wich alows to place a wiki in the main course page (even in the Moodle main course)\n*The WikiBook Module ( in development and soon released ) that allows to create noted seqÃ¼ence of pages out of a wiki networked and chaotic bunch. It also will allow to place metadata, and export to formats like DocBook, Pdf, SCORM and others.\n\nTo get Moodle N Wiki : [[DFWikiLabs|http://morfeo.upc.edu/crom]]\n</div>
<div tiddler="MoodleSource" modifier="Ludo(Marc Alier)" modified="200611171124" created="200611171124" tags="">http://morfeo.upc.edu/crom</div>
<div tiddler="N Wiki" modifier="Ludo(Marc Alier)" modified="200610301207" created="200610301149" tags="">See \n*[[Moodle N Wiki]]\n*[[DFWikiTeam]]\n*[[DFWikiLabs|http://morfeo.upc.edu/crom]]\n</div>
<div tiddler="SiteSubtitle" modifier="YourName" modified="200611181536" created="200611181536" tags="">A [[Ludo|http://www.lsi.upc.edu/~malier]]'s [[DFWikiteam|http://morfeo.upc.edu/crom]] Site</div>
<div tiddler="SiteTitle" modifier="YourName" modified="200611181534" created="200611181534" tags="">Moodle Wiki - Tiddlywiki Integration</div>
<div tiddler="SiteUrl" modifier="Ludo(Marc Alier)" modified="200610301232" created="200610241141" tags="dfWikiTeam">http://morfeo.upc.edu/crom</div>
<div tiddler="SynchronizePanel" modifier="uri" modified="200612192146" created="200612181132" tags="">&lt;&lt;sync&gt;&gt;</div>
<div tiddler="SynchronizePlugin" modifier="uri" modified="200612211124" created="200611181708" tags="systemConfig">/***\n|''Name:''|SynchronizePluglin|\n|''Author:''|[[Oriol Nieto|http://enochrooted.blogspot.com/]] , [[Alejandro Moreno|http://vdemarvvv.blogspot.com/]] &amp; [[Ludo( Marc Alier)|http://www.lsi.upc.edu/~malier/]]|\n|''Another production of:''|[[dfwikiteam|http://morfeo.upc.es/crom/]] [[Universitat PolitÃ¨cnica de Catalunya|http://www.upc.edu]]|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/ as described in the license document http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html#%5B%5BLicense%20And%20Legal%20Aspects%5D%5D]]|\n|''~CoreVersion:''|2.1.2|\n|''~PluglinVersion:''|1.1|\n|''Moodle wiki server side files''|http://morfeo.upc.edu/crom|\n\nThis plugin lets you synchronize tiddlers with dfwiki pages of a moodle 1.6.X with the nwiki module installed.\nThis is, exporting or importing from a moodle server depending on the last modification date, just by pressing a button.\n\nIt's ''strongly recommended'' that you use ''Firefox'' (or any netscape based navigator) instead of IE in order to avoid security problems.\n\nIf anyway you want to use IE, you'll have to turn down all security parameters.\n\n!!!!!Installation\n&lt;&lt;&lt;\nYour [[ViewTemplate]] should have a line like this to make this plugin work (just add the word ''synchronize'' at the end of the macro string):\n\n&lt;div class='toolbar' macro='toolbar ... synchronize'&gt;&lt;/div&gt;\n\nYou also have to have the [[ImportDFwikisPlugin]] and the [[ExportTiddlersToDFwikiPlugin]] installed on this tiddlywiki.\n&lt;&lt;&lt;\n!!!!!Usage\n&lt;&lt;&lt;\nYou have to add the user and pwd information of your Moodle Server in the [[Synchronize Panel]]. \nYou also have to add your Moodle URL in the [[MoodleSource]] tiddler.\n\nOnce done, just press the &quot;synchronize&quot; button that will appear on the right-upper corner of any tiddler to synchronize the tiddler with a wiki page ''with the same name'' of you Moodle Server.\n&lt;&lt;&lt;\n!!!!!Inline interface (live)\n&lt;&lt;&lt;\nTo create the Syncrhonize Panel you can use the following Interactive Interface:\n\n{{{&lt;&lt;sync&gt;&gt;}}}\n\n&lt;&lt;sync&gt;&gt;\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.12.21 [1.1]''\nIE6 and IE7 bug fixed\n''2006.12.18 [1.0]''\nFirst release\n''2006.11.25 [0.0]''\ndevelopment started\n&lt;&lt;&lt;\n!!!!!Code\n***/\n\n//{{{\nconfig.commands.synchronize= {\n text: 'synchronize',\n tooltip: 'synchronizes this tiddler with the Moodle wiki',\n text_alt: '&lt;input type=&quot;checkbox&quot; style=&quot;padding:0;margin:0;border:0;background:transparent;&quot; checked&gt;synchronize',\n tooltip_alt: 'uncheck to reset the editor to the standard height',\n hideReadOnly: false,\n tiddler: 'not set',\n course: 'not set',\n pageFound: false,\n course_it: 0,\n courses: [],\n wikis: [],\n handler: function(event,src,title) {\n // check if export and import plugins are installed\n if(!store.tiddlerExists(&quot;ImportDFwikisPlugin&quot;)){\n displayMessage(&quot;Error: ImportDFwikisPlugin Required!&quot;);\n return;\n }\n if(!store.tiddlerExists(&quot;ExportTiddlersToDFwikiPlugin&quot;)){\n displayMessage(&quot;Error: ExportTiddlersToDFwikiPlugin Required!&quot;);\n return;\n }\n\n // Get the user and pwd parameters\n if (!document.getElementById(&quot;syncMoodleName&quot;))\n story.displayTiddler(&quot;bottom&quot;,&quot;SynchronizePanel&quot;,1,null,null,false);\n \n var user = document.getElementById(&quot;syncMoodleName&quot;).value;\n var pwd = document.getElementById(&quot;syncMoodlePwd&quot;).value;\n\n // We need to open our plugins:\n story.displayTiddler(&quot;bottom&quot;,&quot;ImportDFwikisPanel&quot;,1,null,null,false);\n story.displayTiddler(&quot;bottom&quot;,&quot;ExportTiddlersToDFwikiPanel&quot;,1,null,null,false);\n\n // For the Export Plugin:\n document.getElementById(&quot;exportID&quot;).value = user;\n document.getElementById(&quot;exportPW&quot;).value = pwd;\n // For the Import Plugin:\n document.getElementById(&quot;moodleUserName&quot;).value = user;\n document.getElementById(&quot;moodlePwd&quot;).value = pwd;\n if (user==&quot;&quot; || pwd==&quot;&quot;){\n displayMessage(&quot;You must fill the user and pwd parameters in the Syncronize Panel!&quot;);\n return;\n }\n document.getElementById(&quot;exportMoodleServer&quot;).value = store.getTiddlerText(&quot;MoodleSource&quot;);\n var sync = true;\n config.commands.synchronize.tiddler = store.getTiddler(title);\n getMoodleInfo(sync); // Get the courses\n displayMessage(&quot;Synchronizing...&quot;); \n\n var tiddler = store.getTiddler(title);\n store.setTiddlerTag(title,true,&quot;synchronized&quot;);\n setLastSyncTime(title, tiddler);\n \n document.getElementById(&quot;syncMoodleName&quot;).value = user;\n document.getElementById(&quot;syncMoodlePwd&quot;).value = pwd;\n\n return false;\n }\n};\n\nfunction setLastSyncTime(title, tiddler){\n tiddler.sync = new Date();\n store.getTiddler(title) = tiddler;\n};\n\nfunction continueSyncCourses(i){\n var IMPORT = 0;\n var EXPORT = 1;\n var courses = document.getElementById(&quot;exportDFwikiCourse&quot;).options;\n var found_courses = config.commands.synchronize.courses;\n var found_wikis = config.commands.synchronize.wikis;\n var sync = true;\n config.commands.synchronize.course_it = i;\n if (courses.length&lt;=i){\n displayMessage(&quot;courses: &quot;+config.commands.synchronize.courses.length+&quot; wikis: &quot;+ config.commands.synchronize.wikis.length);\n if (found_courses.length == 1 &amp;&amp; found_wikis.length == 1){\n displayMessage(&quot;Good: found 1 wiki page named like this, let's synchronize!&quot;);\n var it = found_wikis[0].it;\n var wiki_id = found_wikis[0].id;\n var course_id = found_courses[0].id;\n var parser = found_wikis[0].parser;\n var import_or_export = found_wikis[0].impexp;\n var wiki_name = found_wikis[0].name;\n config.commands.synchronize.course = found_courses[0].name;\n if (import_or_export == IMPORT) importTiddlerSync(it, wiki_id, course_id, parser);\n else if (import_or_export == EXPORT) exportTiddlerSync(it, wiki_name);\n }\n else if (found_courses.length &gt; 1 || found_wikis &gt; 1){\n displayMessage(&quot;Found more than 1 wiki page named like this tiddler&quot;);\n }\n else{\n displayMessage(&quot;Wiki page not found on the moodle server. Create it first!&quot;);\n }\n config.commands.synchronize.courses = [];\n config.commands.synchronize.wikis = [];\n }\n else {\n config.commands.synchronize.course = courses[i].value;\n continueGettingMoodleInfo(courses[i].value, sync);\n }\n};\n\nfunction continueSyncWikis(i){\n var wikis = document.getElementById(&quot;exportDFwikiName&quot;).options;\n var tiddler = config.commands.synchronize.tiddler;\n var course = config.commands.synchronize.course;\n var found = false;\n \n if (wikis.length&lt;=i){\n displayMessage(&quot;Tiddler not found in the course &quot;+course);\n var j = config.commands.synchronize.course_it;\n continueSyncCourses(j+1);\n return; // The tiddler is not in this course\n }\n \n getPagesFromWiki(tiddler, wikis[i].value, course, i);\n return;\n};\n\nfunction getPagesFromWiki(tiddler, wiki, course, i){\n xmlHttp=GetXmlHttpObject();\n if (xmlHttp==null)\n {\n alert (&quot;Browser does not support HTTP Request&quot;);\n return\n }\n var url=document.getElementById(&quot;exportMoodleServer&quot;).value;\n url+= ((url.charAt(url.length-1)!=&quot;/&quot;)?'/':'')+&quot;mod/wiki/webservicelib.php&quot;;\n xmlHttp.onreadystatechange=stateGetFromWiki;\n if (typeof(netscape)!=&quot;undefined&quot;) \n { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n try \n {\n xmlHttp.open(&quot;POST&quot;,url);\n xmlHttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // Needed for the POST method\n if (xmlHttp.overrideMimeType) xmlHttp.overrideMimeType('text/xml');\n //displayMessage(tiddler.modified);\n xmlHttp.send(&quot;sel=getPagesFromWiki&quot;+attachMD5Export(calculateMD5Export())+&quot;&amp;tiddlerTitle=&quot;+tiddler.title+&quot;&amp;tiddlerModified=&quot;+tiddler.modified+&quot;&amp;wiki=&quot;+wiki+&quot;&amp;course=&quot;+course+&quot;&amp;it=&quot;+i);\n//displayMessage(&quot;sel=getPagesFromWiki&quot;+attachMD5Export(calculateMD5Export())+&quot;&amp;tiddlerTitle=&quot;+tiddler.title+&quot;&amp;tiddlerModified=&quot;+tiddler.modified+&quot;&amp;wiki=&quot;+wiki+&quot;&amp;course=&quot;+course+&quot;&amp;it=&quot;+i);\n }\n catch (e) \n {\n displayMessage(e.description?e.description:e.toString());\n }\n};\n\nfunction stateGetFromWiki(){\n if (xmlHttp.readyState==4 || xmlHttp.readyState==&quot;complete&quot;){\n if (typeof(netscape)!=&quot;undefined&quot;) { // For moz-netscape, to access to a remote http:// or file://\n try { netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);}\n catch (e) { displayMessage(e.description?e.description:e.toString()); }\n }\n var xml = xmlHttp.responseXML;\n var response = xml.getElementsByTagName('response')[0];\n var msg = response.getElementsByTagName('msg')[0].firstChild.data;\n var it = parseInt(response.getElementsByTagName('it')[0].firstChild.data);\n \n displayMessage(msg);\n if (msg == &quot;found&quot;){\n config.commands.synchronize.pageFound = true;\n var wikis = document.getElementById(&quot;exportDFwikiName&quot;).options;\n var tiddler = config.commands.synchronize.tiddler;\n displayMessage(&quot;Wiki Page found!: &quot;+tiddler.title);\n var import_or_export = response.getElementsByTagName('impexp')[0].firstChild.data;\n var wiki_id = response.getElementsByTagName('wikiid')[0].firstChild.data;\n var parser = response.getElementsByTagName('parser')[0].firstChild.data;\n var course_id = response.getElementsByTagName('courseid')[0].firstChild.data;\n // Store the course where we've found the wiki page\n var course = new Object();\n course.name = config.commands.synchronize.course;\n course.id = course_id;\n config.commands.synchronize.courses.push(course);\n // Store the wiki, its parser and iterator and imp/exp where we've found the wiki page\n var wikis = document.getElementById(&quot;exportDFwikiName&quot;).options;\n var wiki = new Object();\n wiki.name = wikis[it].value;\n wiki.id = wiki_id;\n wiki.parser = parser;\n wiki.it = it;\n wiki.impexp = import_or_export;\n config.commands.synchronize.wikis.push(wiki);\n displayMessage(&quot;found in the wiki: &quot;+wikis[it].value+&quot; course id:&quot;+course_id+&quot; wikiname&quot;+wiki.name);\n // Keep searching\n continueSyncWikis(it+1); \n }\n else{\n continueSyncWikis(it+1); \n }\n }\n};\n\nfunction importTiddlerSync(it, wiki_id, course_id, parser){\n config.macros.importDFwikis.inbound=null; // clear the imported tiddler buffer\n refreshImportDFwikiList();\n var siteURL=store.getTiddlerText(&quot;MoodleSource&quot;); if (!siteURL) siteURL=&quot;&quot;;\n document.getElementById(&quot;importSourceURL&quot;).value=siteURL;\n\n var wikis = document.getElementById(&quot;exportDFwikiName&quot;).options;\n var course = config.commands.synchronize.course;\n var tiddler = config.commands.synchronize.tiddler;\n\n config.macros.importDFwikis.index=0;\n config.macros.importDFwikis.src = siteURL;\n var src_backup = config.macros.importDFwikis.src;\n \n config.macros.importDFwikis.src = src_backup+((src_backup.charAt(src_backup.length-1)!=&quot;/&quot;)?'/':'');\n config.macros.importDFwikis.src += &quot;mod/wiki/webservicelib.php?sel=urlManagement&amp;courseid=&quot;+course_id+&quot;&amp;wikiid=&quot;+wiki_id+&quot;&amp;page=&quot;+tiddler.title;\n config.macros.importDFwikis.src += attachMD5(calculateMD5());\n loadRemoteItem(config.macros.importDFwikis.src, function(src,txt) {\n var wiki = readItemsFromHTML(txt);\n config.macros.importDFwikis.inbound=wiki;\n window.refreshImportDFwikiList();\n //importDFwikiReport();\n config.macros.importDFwikis.index=0;\n config.macros.importDFwikis.index=importDFwikisImmediately(-1, &quot;true&quot;);\n //importDFwikiStopped(); \n });\n config.macros.importDFwikis.src=src_backup;\n displayMessage(&quot;Successfully Synchronized!&quot;);\n};\n\nfunction exportTiddlerSync(it, wiki_name){\n var course = config.commands.synchronize.course;\n var tiddler = config.commands.synchronize.tiddler;\n addToSelect(wiki_name, &quot;exportDFwikiName&quot;);\n document.getElementById(&quot;exportDFwikiName&quot;).value = wiki_name;\n document.getElementById(&quot;exportDFwikiCourse&quot;).value = course;\n exportToMoodle(tiddler.title, tiddler.modifier, tiddler.modified, tiddler.text, tiddler.tags);\n displayMessage(&quot;Successfully Synchronized!&quot;);\n};\n\n//}}}\n\n// // Macros Definition \n//{{{\nconfig.macros.sync = {\n notSynchronizedText: &quot;(This tiddler has not been synchronized yet)&quot;,\n noPluginText: &quot;There are no synchronized tiddlers&quot;,\n confirmDeleteText: &quot;Are you sure you want to unsynchronize these tiddlers:\sn\sn%0&quot;,\n listViewTemplate : {\n columns: [\n {name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},\n {name: 'Title', field: 'title', tiddlerLink: 'title', title: &quot;Title&quot;, type: 'TiddlerLink'}\n //{name: 'Forced', field: 'forced', title: &quot;Forced&quot;, tag: 'systemConfigForce', type: 'TagCheckbox'},\n //{name: 'Disabled', field: 'disabled', title: &quot;Disabled&quot;, tag: 'systemConfigDisable', type: 'TagCheckbox'},\n //{name: 'Executed', field: 'executed', title: &quot;Loaded&quot;, type: 'Boolean', trueText: &quot;Yes&quot;, falseText: &quot;No&quot;},\n //{name: 'Error', field: 'error', title: &quot;Status&quot;, type: 'Boolean', trueText: &quot;Error&quot;, falseText: &quot;OK&quot;},\n //{name: 'Log', field: 'log', title: &quot;Log&quot;, type: 'StringList'}\n ],\n rowClasses: [\n {className: 'error', field: 'error'},\n {className: 'warning', field: 'warning'}\n ],\n actions: [\n {caption: &quot;More actions...&quot;, name: ''},\n {caption: &quot;Remove synchronized tag&quot;, name: 'remove'},\n {caption: &quot;Delete these tiddlers forever&quot;, name: 'delete'}\n ]}\n };\n\nconfig.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n var panel=document.getElementById(&quot;syncPanel&quot;);\n if (panel) { panel.parentNode.removeChild(panel); }\n panel=createTiddlyElement(place,&quot;span&quot;,&quot;syncPanel&quot;,null,null)\n panel.innerHTML=config.macros.sync.html;\n\n var e = createTiddlyElement(place,&quot;div&quot;);\n e.setAttribute(&quot;refresh&quot;,&quot;macro&quot;);\n e.setAttribute(&quot;macroName&quot;,&quot;sync&quot;);\n e.setAttribute(&quot;params&quot;,paramString);\n this.refresh(e,paramString);\n};\n\nconfig.macros.sync.html = '\s\n&lt;b&gt;Moodle User Information&lt;/b&gt;&lt;br&gt;\s\nusername: &lt;input type=&quot;text&quot; id=&quot;syncMoodleName&quot; onfocus=&quot;this.select()&quot; value=&quot;&quot; size=&quot;10&quot;\s\n onKeyUp=&quot;&quot;\s\n onChange=&quot;&quot;&gt;&lt;br&gt;\s\npassword: &lt;input type=&quot;password&quot; id=&quot;syncMoodlePwd&quot; onfocus=&quot;this.select()&quot; value=&quot;&quot; size=&quot;10&quot;\s\n onKeyUp=&quot;&quot;\s\n onChange=&quot;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;\s\n&lt;b&gt;Synchronized Tiddlers:&lt;/b&gt;\s\n';\n\nconfig.macros.sync.refresh = function(place,params)\n{\n if(!store.tiddlerExists(&quot;ImportDFwikisPlugin&quot;)){\n displayMessage(&quot;Warning: ImportDFwikisPlugin Required for Syncrhonizing&quot;);\n }\n if(!store.tiddlerExists(&quot;ExportTiddlersToDFwikiPlugin&quot;)){\n displayMessage(&quot;Warning: ExportTiddlersToDFwikiPlugin Required for Syncrhonizing&quot;);\n }\n var selectedRows = [];\n ListView.forEachSelector(place,function(e,rowName) {\n if(e.checked)\n selectedRows.push(e.getAttribute(&quot;rowName&quot;));\n });\n removeChildren(place);\n params = params.parseParams(&quot;anon&quot;);\n //var plugins = installedPlugins.slice(0);\n var plugins = [];\n var t,tiddler,p;\n var configTiddlers = store.getTaggedTiddlers(&quot;synchronized&quot;);\n for(t=0; t&lt;configTiddlers.length; t++)\n {\n tiddler = configTiddlers[t];\n if(plugins.findByField(&quot;title&quot;,tiddler.title) == null)\n {\n p = getPluginInfo(tiddler);\n p.executed = false;\n //p.log.splice(0,0,this.notSynchronizedText);\n if (tiddler.sync) p.log.splice(0,0,tiddler.sync);\n else p.log.splice(0,0,this.notSynchronizedText);\n plugins.push(p);\n }\n }\n /*for(t=0; t&lt;plugins.length; t++)\n {\n var p = plugins[t];\n p.forced = p.tiddler.isTagged(&quot;systemConfigForce&quot;);\n p.disabled = p.tiddler.isTagged(&quot;systemConfigDisable&quot;);\n p.Selected = selectedRows.find(plugins[t].title) != null;\n }*/\n if(plugins.length == 0)\n createTiddlyElement(place,&quot;em&quot;,null,null,this.noPluginText);\n else\n ListView.create(place,plugins,this.listViewTemplate,this.onSelectCommand);\n};\n\nconfig.macros.sync.onSelectCommand = function(foo,command,rowNames)\n{\n var t;\n switch(command)\n {\n case &quot;remove&quot;:\n for(t=0; t&lt;rowNames.length; t++)\n store.setTiddlerTag(rowNames[t],false,&quot;synchronized&quot;);\n break;\n case &quot;delete&quot;:\n if(rowNames.length &gt; 0 &amp;&amp; confirm(config.macros.sync.confirmDeleteText.format([rowNames.join(&quot;, &quot;)])))\n {\n for(t=0; t&lt;rowNames.length; t++)\n {\n store.removeTiddler(rowNames[t]);\n story.closeTiddler(rowNames[t],true,false);\n }\n }\n break;\n }\n if(config.options.chkAutoSave)\n saveChanges(true);\n};\n//}}}</div>
<div tiddler="Syncronize Moodle NWiki with your Tiddlywiki" modifier="Ludo" modified="200701070818" created="200701070808" tags="">You can find here three TiddlyWiki Plugins that may help you to synchronize your TiddlyWiki files with the contents of a [[NWiki]] in a [[Moodle   ]] server.\n\nPlugins:\n*ImportDFwikisPlugin : Import pages from your [[Moodle]] [[NWiki]] to TiddlyWiki Tiddlers.\n*ExportTiddlersToDFwikiPlugin : Export TiddlyWiki Tiddlers to [[Moodle]] [[NWiki]] pages.  \n*SynchronizePlugin : Synchronize Tiddlers and pages \n\n\n*You will find News and Updates of this page in [[DFWikiLabs|http://morfeo.upc.edu/crom]].\n*[[Download this tiddlywiki to test the plugin|http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html]]\n*[[Installation Instructions|http://morfeo.upc.es/crom/mod/wiki/view.php?id=22&amp;page=Tiddlywiki+integration+with+New+Moodle+Wiki&amp;gid=0&amp;uid=0]]\n*[[Download and Updates|http://morfeo.upc.es/crom/course/view.php?id=4]]\n----\n!Demo\nImportDFwikisPlugin \n&lt;&lt;importDFwikis inline&gt;&gt;\nThis demo works only working at local, ''NOT when accesed througth http''. You may use our server [[http://morfeo.upc.edu/crom]] to try and play with it. Have fun!\n----\nExportTiddlersToDFwikiPluglin\n&lt;&lt;exportDFwikis inline&gt;&gt;\nThis demo works only working at local, ''NOT when accesed througth http''. You may use our server [[http://morfeo.upc.edu/crom]] to try and play with it. \n|''user''|dfdemo|''password''|dfdemo|\n|''course''|dfdemo|''wiki''|dfdemo|\n</div>
<div tiddler="TiddyWiki" modifier="Ludo(Marc Alier)" modified="200610301129" created="200610301129" tags="">[[Tiddywiki|http://tiddlywiki.com/]] is a free MicroContent WikiWikiWeb created by JeremyRuston and a busy Community of independent developers. It's written in HTML, CSS and JavaScript to run on any modern browser without needing any ServerSide logic. It allows anyone to create personal SelfContained hypertext documents that can be posted to a WebServer, sent by email or kept on a USB thumb drive to make a WikiOnAStick. It also makes a great GuerillaWiki. </div>
<div tiddler="UploadLog" modifier="YourName" modified="200801081930" created="200611181533" tags="">| !date | !user | !location | !storeUrl | !uploadDir | !toFilename | !backupdir | !origin |\n| 18/11/2006 16:33:23 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 18/11/2006 16:38:12 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/11/2006 16:45:12 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/11/2006 16:47:10 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/11/2006 18:1:49 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/11/2006 18:10:53 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 18/11/2006 18:17:14 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 18/11/2006 18:19:34 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/11/2006 18:19:45 | Ludo | [[moodle.html|file:///E:/Documents%20and%20Settings/Ludo/Escritorio/web%20ludo/moodle.html]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 22/11/2006 8:57:0 | Ludo(Marc Alier) | [[moodle.html|file:///C:/Documents%20and%20Settings/ASUS/Mis%20documentos/tiddlyspots/moodle.html#%5B%5BLicense%20And%20Legal%20Aspects%5D%5D]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 22/11/2006 15:24:3 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 22/11/2006 15:24:40 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 22/11/2006 15:35:18 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 13/12/2006 13:33:51 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/12/2006 11:40:42 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/12/2006 11:45:15 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/12/2006 11:50:3 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/12/2006 11:50:6 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok | Ok | Ok | Ok |\n| 18/12/2006 12:34:8 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 18/12/2006 12:44:21 | uri | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 19/12/2006 22:31:40 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 19/12/2006 22:33:58 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 19/12/2006 22:46:35 | uri | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 21/12/2006 11:29:17 | uri | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 21/12/2006 12:25:47 | uri | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 7/1/2007 9:12:18 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 7/1/2007 9:13:59 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 7/1/2007 9:15:7 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 7/1/2007 9:19:54 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |\n| 7/1/2007 9:21:18 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 9/1/2007 13:21:56 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 17/3/2007 11:1:36 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 17/3/2007 11:8:18 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 17/3/2007 11:8:28 | Ludo | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 2/5/2007 14:58:57 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 2/7/2007 8:20:47 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 2/7/2007 8:20:55 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 8/1/2008 20:29:38 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |\n| 8/1/2008 20:30:56 | YourName | [[/|http://moodle.tiddlyspot.com/]] | [[store.cgi|http://moodle.tiddlyspot.com/store.cgi]] | . | index.html | . |</div>
<div tiddler="UploadPlugin" modifier="BidiX" modified="200609302115" created="200603100902" tags="systemConfig Upload plugin">/***\n|''Name:''|UploadPlugin|\n|''Description:''|Save to web a TiddlyWiki|\n|''Version:''|3.4.4|\n|''Date:''|Sep 30, 2006|\n|''Source:''|http://tiddlywiki.bidix.info/#UploadPlugin|\n|''Documentation:''|http://tiddlywiki.bidix.info/#UploadDoc|\n|''Author:''|BidiX (BidiX (at) bidix (dot) info)|\n|''License:''|[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D ]]|\n|''~CoreVersion:''|2.0.0|\n|''Browser:''|Firefox 1.5; InternetExplorer 6.0; Safari|\n|''Include:''|config.lib.file; config.lib.log; config.lib.options; PasswordTweak|\n|''Require:''|[[UploadService|http://tiddlywiki.bidix.info/#UploadService]]|\n***/\n//{{{\nversion.extensions.UploadPlugin = {\n major: 3, minor: 4, revision: 4, \n date: new Date(2006,8,30),\n source: 'http://tiddlywiki.bidix.info/#UploadPlugin',\n documentation: 'http://tiddlywiki.bidix.info/#UploadDoc',\n author: 'BidiX (BidiX (at) bidix (dot) info',\n license: '[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D]]',\n coreVersion: '2.0.0',\n browser: 'Firefox 1.5; InternetExplorer 6.0; Safari'\n};\n//}}}\n\n////+++!![config.lib.file]\n\n//{{{\nif (!config.lib) config.lib = {};\nif (!config.lib.file) config.lib.file= {\n author: 'BidiX',\n version: {major: 0, minor: 1, revision: 0}, \n date: new Date(2006,3,9)\n};\nconfig.lib.file.dirname = function (filePath) {\n var lastpos;\n if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {\n return filePath.substring(0, lastpos);\n } else {\n return filePath.substring(0, filePath.lastIndexOf(&quot;\s\s&quot;));\n }\n};\nconfig.lib.file.basename = function (filePath) {\n var lastpos;\n if ((lastpos = filePath.lastIndexOf(&quot;#&quot;)) != -1) \n filePath = filePath.substring(0, lastpos);\n if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {\n return filePath.substring(lastpos + 1);\n } else\n return filePath.substring(filePath.lastIndexOf(&quot;\s\s&quot;)+1);\n};\nwindow.basename = function() {return &quot;@@deprecated@@&quot;;};\n//}}}\n////===\n\n////+++!![config.lib.log]\n\n//{{{\nif (!config.lib) config.lib = {};\nif (!config.lib.log) config.lib.log= {\n author: 'BidiX',\n version: {major: 0, minor: 1, revision: 1}, \n date: new Date(2006,8,19)\n};\nconfig.lib.Log = function(tiddlerTitle, logHeader) {\n if (version.major &lt; 2)\n this.tiddler = store.tiddlers[tiddlerTitle];\n else\n this.tiddler = store.getTiddler(tiddlerTitle);\n if (!this.tiddler) {\n this.tiddler = new Tiddler();\n this.tiddler.title = tiddlerTitle;\n this.tiddler.text = &quot;| !date | !user | !location |&quot; + logHeader;\n this.tiddler.created = new Date();\n this.tiddler.modifier = config.options.txtUserName;\n this.tiddler.modified = new Date();\n if (version.major &lt; 2)\n store.tiddlers[tiddlerTitle] = this.tiddler;\n else\n store.addTiddler(this.tiddler);\n }\n return this;\n};\n\nconfig.lib.Log.prototype.newLine = function (line) {\n var now = new Date();\n var newText = &quot;| &quot;;\n newText += now.getDate()+&quot;/&quot;+(now.getMonth()+1)+&quot;/&quot;+now.getFullYear() + &quot; &quot;;\n newText += now.getHours()+&quot;:&quot;+now.getMinutes()+&quot;:&quot;+now.getSeconds()+&quot; | &quot;;\n newText += config.options.txtUserName + &quot; | &quot;;\n var location = document.location.toString();\n var filename = config.lib.file.basename(location);\n if (!filename) filename = '/';\n newText += &quot;[[&quot;+filename+&quot;|&quot;+location + &quot;]] |&quot;;\n this.tiddler.text = this.tiddler.text + &quot;\sn&quot; + newText;\n this.addToLine(line);\n};\n\nconfig.lib.Log.prototype.addToLine = function (text) {\n this.tiddler.text = this.tiddler.text + text;\n this.tiddler.modifier = config.options.txtUserName;\n this.tiddler.modified = new Date();\n if (version.major &lt; 2)\n store.tiddlers[this.tiddler.tittle] = this.tiddler;\n else {\n store.addTiddler(this.tiddler);\n story.refreshTiddler(this.tiddler.title);\n store.notify(this.tiddler.title, true);\n }\n if (version.major &lt; 2)\n store.notifyAll(); \n};\n//}}}\n////===\n\n////+++!![config.lib.options]\n\n//{{{\nif (!config.lib) config.lib = {};\nif (!config.lib.options) config.lib.options = {\n author: 'BidiX',\n version: {major: 0, minor: 1, revision: 0}, \n date: new Date(2006,3,9)\n};\n\nconfig.lib.options.init = function (name, defaultValue) {\n if (!config.options[name]) {\n config.options[name] = defaultValue;\n saveOptionCookie(name);\n }\n};\n//}}}\n////===\n\n////+++!![PasswordTweak]\n\n//{{{\nversion.extensions.PasswordTweak = {\n major: 1, minor: 0, revision: 3, date: new Date(2006,8,30),\n type: 'tweak',\n source: 'http://tiddlywiki.bidix.info/#PasswordTweak'\n};\n//}}}\n/***\n!!config.macros.option\n***/\n//{{{\nconfig.macros.option.passwordCheckboxLabel = &quot;Save this password on this computer&quot;;\nconfig.macros.option.passwordType = &quot;password&quot;; // password | text\n\nconfig.macros.option.onChangeOption = function(e)\n{\n var opt = this.getAttribute(&quot;option&quot;);\n var elementType,valueField;\n if(opt) {\n switch(opt.substr(0,3)) {\n case &quot;txt&quot;:\n elementType = &quot;input&quot;;\n valueField = &quot;value&quot;;\n break;\n case &quot;pas&quot;:\n elementType = &quot;input&quot;;\n valueField = &quot;value&quot;;\n break;\n case &quot;chk&quot;:\n elementType = &quot;input&quot;;\n valueField = &quot;checked&quot;;\n break;\n }\n config.options[opt] = this[valueField];\n saveOptionCookie(opt);\n var nodes = document.getElementsByTagName(elementType);\n for(var t=0; t&lt;nodes.length; t++) \n {\n var optNode = nodes[t].getAttribute(&quot;option&quot;);\n if (opt == optNode) \n nodes[t][valueField] = this[valueField];\n }\n }\n return(true);\n};\n\nconfig.macros.option.handler = function(place,macroName,params)\n{\n var opt = params[0];\n if(config.options[opt] === undefined) {\n return;}\n var c;\n switch(opt.substr(0,3)) {\n case &quot;txt&quot;:\n c = document.createElement(&quot;input&quot;);\n c.onkeyup = this.onChangeOption;\n c.setAttribute (&quot;option&quot;,opt);\n c.className = &quot;txtOptionInput &quot;+opt;\n place.appendChild(c);\n c.value = config.options[opt];\n break;\n case &quot;pas&quot;:\n // input password\n c = document.createElement (&quot;input&quot;);\n c.setAttribute(&quot;type&quot;,config.macros.option.passwordType);\n c.onkeyup = this.onChangeOption;\n c.setAttribute(&quot;option&quot;,opt);\n c.className = &quot;pasOptionInput &quot;+opt;\n place.appendChild(c);\n c.value = config.options[opt];\n // checkbox link with this password &quot;save this password on this computer&quot;\n c = document.createElement(&quot;input&quot;);\n c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);\n c.onclick = this.onChangeOption;\n c.setAttribute(&quot;option&quot;,&quot;chk&quot;+opt);\n c.className = &quot;chkOptionInput &quot;+opt;\n place.appendChild(c);\n c.checked = config.options[&quot;chk&quot;+opt];\n // text savePasswordCheckboxLabel\n place.appendChild(document.createTextNode(config.macros.option.passwordCheckboxLabel));\n break;\n case &quot;chk&quot;:\n c = document.createElement(&quot;input&quot;);\n c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);\n c.onclick = this.onChangeOption;\n c.setAttribute(&quot;option&quot;,opt);\n c.className = &quot;chkOptionInput &quot;+opt;\n place.appendChild(c);\n c.checked = config.options[opt];\n break;\n }\n};\n//}}}\n/***\n!! Option cookie stuff\n***/\n//{{{\nwindow.loadOptionsCookie_orig_PasswordTweak = window.loadOptionsCookie;\nwindow.loadOptionsCookie = function()\n{\n var cookies = document.cookie.split(&quot;;&quot;);\n for(var c=0; c&lt;cookies.length; c++) {\n var p = cookies[c].indexOf(&quot;=&quot;);\n if(p != -1) {\n var name = cookies[c].substr(0,p).trim();\n var value = cookies[c].substr(p+1).trim();\n switch(name.substr(0,3)) {\n case &quot;txt&quot;:\n config.options[name] = unescape(value);\n break;\n case &quot;pas&quot;:\n config.options[name] = unescape(value);\n break;\n case &quot;chk&quot;:\n config.options[name] = value == &quot;true&quot;;\n break;\n }\n }\n }\n};\n\nwindow.saveOptionCookie_orig_PasswordTweak = window.saveOptionCookie;\nwindow.saveOptionCookie = function(name)\n{\n var c = name + &quot;=&quot;;\n switch(name.substr(0,3)) {\n case &quot;txt&quot;:\n c += escape(config.options[name].toString());\n break;\n case &quot;chk&quot;:\n c += config.options[name] ? &quot;true&quot; : &quot;false&quot;;\n // is there an option link with this chk ?\n if (config.options[name.substr(3)]) {\n saveOptionCookie(name.substr(3));\n }\n break;\n case &quot;pas&quot;:\n if (config.options[&quot;chk&quot;+name]) {\n c += escape(config.options[name].toString());\n } else {\n c += &quot;&quot;;\n }\n break;\n }\n c += &quot;; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/&quot;;\n document.cookie = c;\n};\n//}}}\n/***\n!! Initializations\n***/\n//{{{\n// define config.options.pasPassword\nif (!config.options.pasPassword) {\n config.options.pasPassword = 'defaultPassword';\n window.saveOptionCookie('pasPassword');\n}\n// since loadCookies is first called befor password definition\n// we need to reload cookies\nwindow.loadOptionsCookie();\n//}}}\n////===\n\n////+++!![config.macros.upload]\n\n//{{{\nconfig.macros.upload = {\n accessKey: &quot;U&quot;,\n formName: &quot;UploadPlugin&quot;,\n contentType: &quot;text/html;charset=UTF-8&quot;,\n defaultStoreScript: &quot;store.php&quot;\n};\n\n// only this two configs need to be translated\nconfig.macros.upload.messages = {\n aboutToUpload: &quot;About to upload TiddlyWiki to %0&quot;,\n backupFileStored: &quot;Previous file backuped in %0&quot;,\n crossDomain: &quot;Certainly a cross-domain isue: access to an other site isn't allowed&quot;,\n errorDownloading: &quot;Error downloading&quot;,\n errorUploadingContent: &quot;Error uploading content&quot;,\n fileLocked: &quot;Files is locked: You are not allowed to Upload&quot;,\n fileNotFound: &quot;file to upload not found&quot;,\n fileNotUploaded: &quot;File %0 NOT uploaded&quot;,\n mainFileUploaded: &quot;Main TiddlyWiki file uploaded to %0&quot;,\n passwordEmpty: &quot;Unable to upload, your password is empty&quot;,\n urlParamMissing: &quot;url param missing&quot;,\n rssFileNotUploaded: &quot;RssFile %0 NOT uploaded&quot;,\n rssFileUploaded: &quot;Rss File uploaded to %0&quot;\n};\n\nconfig.macros.upload.label = {\n promptOption: &quot;Save and Upload this TiddlyWiki with UploadOptions&quot;,\n promptParamMacro: &quot;Save and Upload this TiddlyWiki in %0&quot;,\n saveLabel: &quot;save to web&quot;, \n saveToDisk: &quot;save to disk&quot;,\n uploadLabel: &quot;upload&quot; \n};\n\nconfig.macros.upload.handler = function(place,macroName,params){\n // parameters initialization\n var storeUrl = params[0];\n var toFilename = params[1];\n var backupDir = params[2];\n var uploadDir = params[3];\n var username = params[4];\n var password; // for security reason no password as macro parameter\n var label;\n if (document.location.toString().substr(0,4) == &quot;http&quot;)\n label = this.label.saveLabel;\n else\n label = this.label.uploadLabel;\n var prompt;\n if (storeUrl) {\n prompt = this.label.promptParamMacro.toString().format([this.toDirUrl(storeUrl, uploadDir, username)]);\n }\n else {\n prompt = this.label.promptOption;\n }\n createTiddlyButton(place, label, prompt, \n function () {\n config.macros.upload.upload(storeUrl, toFilename, uploadDir, backupDir, username, password); \n return false;}, \n null, null, this.accessKey);\n};\nconfig.macros.upload.UploadLog = function() {\n return new config.lib.Log('UploadLog', &quot; !storeUrl | !uploadDir | !toFilename | !backupdir | !origin |&quot; );\n};\nconfig.macros.upload.UploadLog.prototype = config.lib.Log.prototype;\nconfig.macros.upload.UploadLog.prototype.startUpload = function(storeUrl, toFilename, uploadDir, backupDir) {\n var line = &quot; [[&quot; + config.lib.file.basename(storeUrl) + &quot;|&quot; + storeUrl + &quot;]] | &quot;;\n line += uploadDir + &quot; | &quot; + toFilename + &quot; | &quot; + backupDir + &quot; |&quot;;\n this.newLine(line);\n};\nconfig.macros.upload.UploadLog.prototype.endUpload = function() {\n this.addToLine(&quot; Ok |&quot;);\n};\nconfig.macros.upload.basename = config.lib.file.basename;\nconfig.macros.upload.dirname = config.lib.file.dirname;\nconfig.macros.upload.toRootUrl = function (storeUrl, username)\n{\n return root = (this.dirname(storeUrl)?this.dirname(storeUrl):this.dirname(document.location.toString()));\n}\nconfig.macros.upload.toDirUrl = function (storeUrl, uploadDir, username)\n{\n var root = this.toRootUrl(storeUrl, username);\n if (uploadDir &amp;&amp; uploadDir != '.')\n root = root + '/' + uploadDir;\n return root;\n}\nconfig.macros.upload.toFileUrl = function (storeUrl, toFilename, uploadDir, username)\n{\n return this.toDirUrl(storeUrl, uploadDir, username) + '/' + toFilename;\n}\nconfig.macros.upload.upload = function(storeUrl, toFilename, uploadDir, backupDir, username, password)\n{\n // parameters initialization\n storeUrl = (storeUrl ? storeUrl : config.options.txtUploadStoreUrl);\n toFilename = (toFilename ? toFilename : config.options.txtUploadFilename);\n backupDir = (backupDir ? backupDir : config.options.txtUploadBackupDir);\n uploadDir = (uploadDir ? uploadDir : config.options.txtUploadDir);\n username = (username ? username : config.options.txtUploadUserName);\n password = config.options.pasUploadPassword; // for security reason no password as macro parameter\n if (!password || password === '') {\n alert(config.macros.upload.messages.passwordEmpty);\n return;\n }\n if (storeUrl === '') {\n storeUrl = config.macros.upload.defaultStoreScript;\n }\n if (config.lib.file.dirname(storeUrl) === '') {\n storeUrl = config.lib.file.dirname(document.location.toString())+'/'+storeUrl;\n }\n if (toFilename === '') {\n toFilename = config.lib.file.basename(document.location.toString());\n }\n\n clearMessage();\n // only for forcing the message to display\n if (version.major &lt; 2)\n store.notifyAll();\n if (!storeUrl) {\n alert(config.macros.upload.messages.urlParamMissing);\n return;\n }\n // Check that file is not locked\n if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {\n if (BidiX.GroupAuthoring.lock.isLocked() &amp;&amp; !BidiX.GroupAuthoring.lock.isMyLock()) {\n alert(config.macros.upload.messages.fileLocked);\n return;\n }\n }\n \n var log = new this.UploadLog();\n log.startUpload(storeUrl, toFilename, uploadDir, backupDir);\n if (document.location.toString().substr(0,5) == &quot;file:&quot;) {\n saveChanges();\n }\n var toDir = config.macros.upload.toDirUrl(storeUrl, toFilename, uploadDir, username);\n displayMessage(config.macros.upload.messages.aboutToUpload.format([toDir]), toDir);\n this.uploadChanges(storeUrl, toFilename, uploadDir, backupDir, username, password);\n if(config.options.chkGenerateAnRssFeed) {\n //var rssContent = convertUnicodeToUTF8(generateRss());\n var rssContent = generateRss();\n var rssPath = toFilename.substr(0,toFilename.lastIndexOf(&quot;.&quot;)) + &quot;.xml&quot;;\n this.uploadContent(rssContent, storeUrl, rssPath, uploadDir, '', username, password, \n function (responseText) {\n if (responseText.substring(0,1) != '0') {\n displayMessage(config.macros.upload.messages.rssFileNotUploaded.format([rssPath]));\n }\n else {\n var toFileUrl = config.macros.upload.toFileUrl(storeUrl, rssPath, uploadDir, username);\n displayMessage(config.macros.upload.messages.rssFileUploaded.format(\n [toFileUrl]), toFileUrl);\n }\n // for debugging store.php uncomment last line\n //DEBUG alert(responseText);\n });\n }\n return;\n};\n\nconfig.macros.upload.uploadChanges = function(storeUrl, toFilename, uploadDir, backupDir, \n username, password) {\n var original;\n if (document.location.toString().substr(0,4) == &quot;http&quot;) {\n original = this.download(storeUrl, toFilename, uploadDir, backupDir, username, password);\n return;\n }\n else {\n // standard way : Local file\n \n original = loadFile(getLocalPath(document.location.toString()));\n if(window.Components) {\n // it's a mozilla browser\n try {\n netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);\n var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]\n .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);\n converter.charset = &quot;UTF-8&quot;;\n original = converter.ConvertToUnicode(original);\n }\n catch(e) {\n }\n }\n }\n //DEBUG alert(original);\n this.uploadChangesFrom(original, storeUrl, toFilename, uploadDir, backupDir, \n username, password);\n};\n\nconfig.macros.upload.uploadChangesFrom = function(original, storeUrl, toFilename, uploadDir, backupDir, \n username, password) {\n var startSaveArea = '&lt;div id=&quot;' + 'storeArea&quot;&gt;'; // Split up into two so that indexOf() of this source doesn't find it\n var endSaveArea = '&lt;/d' + 'iv&gt;';\n // Locate the storeArea div's\n var posOpeningDiv = original.indexOf(startSaveArea);\n var posClosingDiv = original.lastIndexOf(endSaveArea);\n if((posOpeningDiv == -1) || (posClosingDiv == -1))\n {\n alert(config.messages.invalidFileError.format([document.location.toString()]));\n return;\n }\n var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + \n allTiddlersAsHtml() + &quot;\sn\st\st&quot; +\n original.substr(posClosingDiv);\n var newSiteTitle;\n if(version.major &lt; 2){\n newSiteTitle = (getElementText(&quot;siteTitle&quot;) + &quot; - &quot; + getElementText(&quot;siteSubtitle&quot;)).htmlEncode();\n } else {\n newSiteTitle = (wikifyPlain (&quot;SiteTitle&quot;) + &quot; - &quot; + wikifyPlain (&quot;SiteSubtitle&quot;)).htmlEncode();\n }\n\n revised = revised.replaceChunk(&quot;&lt;title&quot;+&quot;&gt;&quot;,&quot;&lt;/title&quot;+&quot;&gt;&quot;,&quot; &quot; + newSiteTitle + &quot; &quot;);\n revised = revised.replaceChunk(&quot;&lt;!--PRE-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\sn&quot; + store.getTiddlerText(&quot;MarkupPreHead&quot;,&quot;&quot;) + &quot;\sn&quot;);\n revised = revised.replaceChunk(&quot;&lt;!--POST-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\sn&quot; + store.getTiddlerText(&quot;MarkupPostHead&quot;,&quot;&quot;) + &quot;\sn&quot;);\n revised = revised.replaceChunk(&quot;&lt;!--PRE-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\sn&quot; + store.getTiddlerText(&quot;MarkupPreBody&quot;,&quot;&quot;) + &quot;\sn&quot;);\n revised = revised.replaceChunk(&quot;&lt;!--POST-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\sn&quot; + store.getTiddlerText(&quot;MarkupPostBody&quot;,&quot;&quot;) + &quot;\sn&quot;);\n\n var response = this.uploadContent(revised, storeUrl, toFilename, uploadDir, backupDir, \n username, password, function (responseText) {\n if (responseText.substring(0,1) != '0') {\n alert(responseText);\n displayMessage(config.macros.upload.messages.fileNotUploaded.format([getLocalPath(document.location.toString())]));\n }\n else {\n if (uploadDir !== '') {\n toFilename = uploadDir + &quot;/&quot; + config.macros.upload.basename(toFilename);\n } else {\n toFilename = config.macros.upload.basename(toFilename);\n }\n var toFileUrl = config.macros.upload.toFileUrl(storeUrl, toFilename, uploadDir, username);\n if (responseText.indexOf(&quot;destfile:&quot;) &gt; 0) {\n var destfile = responseText.substring(responseText.indexOf(&quot;destfile:&quot;)+9, \n responseText.indexOf(&quot;\sn&quot;, responseText.indexOf(&quot;destfile:&quot;)));\n toFileUrl = config.macros.upload.toRootUrl(storeUrl, username) + '/' + destfile;\n }\n else {\n toFileUrl = config.macros.upload.toFileUrl(storeUrl, toFilename, uploadDir, username);\n }\n displayMessage(config.macros.upload.messages.mainFileUploaded.format(\n [toFileUrl]), toFileUrl);\n if (backupDir &amp;&amp; responseText.indexOf(&quot;backupfile:&quot;) &gt; 0) {\n var backupFile = responseText.substring(responseText.indexOf(&quot;backupfile:&quot;)+11, \n responseText.indexOf(&quot;\sn&quot;, responseText.indexOf(&quot;backupfile:&quot;)));\n toBackupUrl = config.macros.upload.toRootUrl(storeUrl, username) + '/' + backupFile;\n displayMessage(config.macros.upload.messages.backupFileStored.format(\n [toBackupUrl]), toBackupUrl);\n }\n var log = new config.macros.upload.UploadLog();\n log.endUpload();\n store.setDirty(false);\n // erase local lock\n if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {\n BidiX.GroupAuthoring.lock.eraseLock();\n // change mtime with new mtime after upload\n var mtime = responseText.substr(responseText.indexOf(&quot;mtime:&quot;)+6);\n BidiX.GroupAuthoring.lock.mtime = mtime;\n }\n \n \n }\n // for debugging store.php uncomment last line\n //DEBUG alert(responseText);\n }\n );\n};\n\nconfig.macros.upload.uploadContent = function(content, storeUrl, toFilename, uploadDir, backupDir, \n username, password, callbackFn) {\n var boundary = &quot;---------------------------&quot;+&quot;AaB03x&quot;; \n var request;\n try {\n request = new XMLHttpRequest();\n } \n catch (e) { \n request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); \n }\n if (window.netscape){\n try {\n if (document.location.toString().substr(0,4) != &quot;http&quot;) {\n netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead');}\n }\n catch (e) {}\n } \n //DEBUG alert(&quot;user[&quot;+config.options.txtUploadUserName+&quot;] password[&quot; + config.options.pasUploadPassword + &quot;]&quot;);\n // compose headers data\n var sheader = &quot;&quot;;\n sheader += &quot;--&quot; + boundary + &quot;\sr\snContent-disposition: form-data; name=\s&quot;&quot;;\n sheader += config.macros.upload.formName +&quot;\s&quot;\sr\sn\sr\sn&quot;;\n sheader += &quot;backupDir=&quot;+backupDir\n +&quot;;user=&quot; + username \n +&quot;;password=&quot; + password\n +&quot;;uploaddir=&quot; + uploadDir;\n // add lock attributes to sheader\n if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {\n var l = BidiX.GroupAuthoring.lock.myLock;\n sheader += &quot;;lockuser=&quot; + l.user\n + &quot;;mtime=&quot; + l.mtime\n + &quot;;locktime=&quot; + l.locktime;\n }\n sheader += &quot;;;\sr\sn&quot;; \n sheader += &quot;\sr\sn&quot; + &quot;--&quot; + boundary + &quot;\sr\sn&quot;;\n sheader += &quot;Content-disposition: form-data; name=\s&quot;userfile\s&quot;; filename=\s&quot;&quot;+toFilename+&quot;\s&quot;\sr\sn&quot;;\n sheader += &quot;Content-Type: &quot; + config.macros.upload.contentType + &quot;\sr\sn&quot;;\n sheader += &quot;Content-Length: &quot; + content.length + &quot;\sr\sn\sr\sn&quot;;\n // compose trailer data\n var strailer = new String();\n strailer = &quot;\sr\sn--&quot; + boundary + &quot;--\sr\sn&quot;;\n //strailer = &quot;--&quot; + boundary + &quot;--\sr\sn&quot;;\n var data;\n data = sheader + content + strailer;\n //request.open(&quot;POST&quot;, storeUrl, true, username, password);\n try {\n request.open(&quot;POST&quot;, storeUrl, true); \n }\n catch(e) {\n alert(config.macros.upload.messages.crossDomain + &quot;\snError:&quot; +e);\n exit;\n }\n request.onreadystatechange = function () {\n if (request.readyState == 4) {\n if (request.status == 200)\n callbackFn(request.responseText);\n else\n alert(config.macros.upload.messages.errorUploadingContent + &quot;\snStatus: &quot;+request.status.statusText);\n }\n };\n request.setRequestHeader(&quot;Content-Length&quot;,data.length);\n request.setRequestHeader(&quot;Content-Type&quot;,&quot;multipart/form-data; boundary=&quot;+boundary);\n request.send(data); \n};\n\n\nconfig.macros.upload.download = function(uploadUrl, uploadToFilename, uploadDir, uploadBackupDir, \n username, password) {\n var request;\n try {\n request = new XMLHttpRequest();\n } \n catch (e) { \n request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); \n }\n try {\n if (uploadUrl.substr(0,4) == &quot;http&quot;) {\n netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);\n }\n else {\n netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);\n }\n } catch (e) { }\n //request.open(&quot;GET&quot;, document.location.toString(), true, username, password);\n try {\n request.open(&quot;GET&quot;, document.location.toString(), true);\n }\n catch(e) {\n alert(config.macros.upload.messages.crossDomain + &quot;\snError:&quot; +e);\n exit;\n }\n \n request.onreadystatechange = function () {\n if (request.readyState == 4) {\n if(request.status == 200) {\n config.macros.upload.uploadChangesFrom(request.responseText, uploadUrl, \n uploadToFilename, uploadDir, uploadBackupDir, username, password);\n }\n else\n alert(config.macros.upload.messages.errorDownloading.format(\n [document.location.toString()]) + &quot;\snStatus: &quot;+request.status.statusText);\n }\n };\n request.send(null);\n};\n\n//}}}\n////===\n\n////+++!![Initializations]\n\n//{{{\nconfig.lib.options.init('txtUploadStoreUrl','store.php');\nconfig.lib.options.init('txtUploadFilename','');\nconfig.lib.options.init('txtUploadDir','');\nconfig.lib.options.init('txtUploadBackupDir','');\nconfig.lib.options.init('txtUploadUserName',config.options.txtUserName);\nconfig.lib.options.init('pasUploadPassword','');\nsetStylesheet(\n &quot;.pasOptionInput {width: 11em;}\sn&quot;+\n &quot;.txtOptionInput.txtUploadStoreUrl {width: 25em;}\sn&quot;+\n &quot;.txtOptionInput.txtUploadFilename {width: 25em;}\sn&quot;+\n &quot;.txtOptionInput.txtUploadDir {width: 25em;}\sn&quot;+\n &quot;.txtOptionInput.txtUploadBackupDir {width: 25em;}\sn&quot;+\n &quot;&quot;,\n &quot;UploadOptionsStyles&quot;);\nconfig.shadowTiddlers.UploadDoc = &quot;[[Full Documentation|http://tiddlywiki.bidix.info/l#UploadDoc ]]\sn&quot;; \nconfig.options.chkAutoSave = false; saveOptionCookie('chkAutoSave');\n\n//}}}\n////===\n\n////+++!![Core Hijacking]\n\n//{{{\nconfig.macros.saveChanges.label_orig_UploadPlugin = config.macros.saveChanges.label;\nconfig.macros.saveChanges.label = config.macros.upload.label.saveToDisk;\n\nconfig.macros.saveChanges.handler_orig_UploadPlugin = config.macros.saveChanges.handler;\n\nconfig.macros.saveChanges.handler = function(place)\n{\n if ((!readOnly) &amp;&amp; (document.location.toString().substr(0,4) != &quot;http&quot;))\n createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);\n};\n\n//}}}\n////===\n</div>
<div tiddler="ViewTemplate" modifier="YourName" modified="200612181132" created="200612181132" tags="">&lt;!--{{{--&gt;\n&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump synchronize'&gt;&lt;/div&gt;\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\n&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date [[DD MMM YYYY]]'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date [[DD MMM YYYY]]'&gt;&lt;/span&gt;)&lt;/div&gt;\n&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;\n&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;\n&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;\n&lt;div class='tagClear'&gt;&lt;/div&gt;\n&lt;!--}}}--&gt;</div>
<div tiddler="Welcome to your tiddlyspot.com site!" modifier="tiddlyspot" modified="200609180323" created="200609180323" tags="tiddlyspot">This document is a ~TiddlyWiki from tiddlyspot.com. A ~TiddlyWiki is an electronic notebook that is great for managing todo lists, personal information, and all sorts of things.\n\n@@font-weight:bold;font-size:1.3em;color:#444; //What now?// &amp;nbsp;&amp;nbsp;@@ Before you can save any changes, you need to enter your password in the form below. Then configure privacy and other site settings at your [[control panel|http://moodle.tiddlyspot.com/controlpanel]] (your control panel username is //moodle//).\n&lt;&lt;tiddler tiddlyspotControls&gt;&gt;\n@@font-weight:bold;font-size:1.3em;color:#444; //Working online// &amp;nbsp;&amp;nbsp;@@ You can edit this ~TiddlyWiki right now, and save your changes using the &quot;save to web&quot; button in the column on the right.\n\n@@font-weight:bold;font-size:1.3em;color:#444; //Working offline// &amp;nbsp;&amp;nbsp;@@ A fully functioning copy of this ~TiddlyWiki can be saved onto your hard drive or USB stick. You can make changes and save them locally without being connected to the Internet. When you're ready to sync up again, just click &quot;upload&quot; and your ~TiddlyWiki will be saved back to tiddlyspot.com.\n\n@@font-weight:bold;font-size:1.3em;color:#444; //Help!// &amp;nbsp;&amp;nbsp;@@ Find out more about ~TiddlyWiki at [[TiddlyWiki.com|http://tiddlywiki.com]]. Also visit [[TiddlyWiki Guides|http://tiddlywikiguides.org]] for documentation on learning and using ~TiddlyWiki. New users are especially welcome on the [[TiddlyWiki mailing list|http://groups.google.com/group/TiddlyWiki]], which is an excellent place to ask questions and get help. If you have a tiddlyspot related problem email [[tiddlyspot support|mailto:support@tiddlyspot.com]].\n\n@@font-weight:bold;font-size:1.3em;color:#444; //Enjoy :)// &amp;nbsp;&amp;nbsp;@@ We hope you like using your tiddlyspot.com site. Please email [[feedback@tiddlyspot.com|mailto:feedback@tiddlyspot.com]] with any comments or suggestions.</div>
<div tiddler="YourName" modifier="uri" modified="200612181139" created="200612181131" tags=""></div>
<div tiddler="Z Import N Wiki Pages in your Tiddlywiki" modifier="Ludo" modified="200611181719" created="200610301127" tags="dfWikiTeam">This TiddyWiki page contains the ImportDFwikisPlugin that will allow you to Import Wiki pages from a [[Moodle N Wiki]] into your Tiddywiki [[tiddlers]]. \n[[We|DFWikiTeam]] are developing another plugin to do exactly the oposite, to export tiddywiki tiddlers into [[Moodle N Wiki]] pages, so stay tunned. \n*You will find News and Updates of this page in [[DFWikiLabs|http://morfeo.upc.edu/crom]].\n*[[Download this tiddlywiki to test the plugin|http://www.lsi.upc.edu/~malier/tidlywikimoodledfwikimport.html]]\n*[[Installation Instructions|http://morfeo.upc.es/crom/mod/wiki/view.php?id=22&amp;page=Tiddlywiki+integration+with+New+Moodle+Wiki&amp;gid=0&amp;uid=0]]\n*[[Download and Updates|http://morfeo.upc.es/crom/course/view.php?id=4]]\n----\nImportDFwikisPlugin \n&lt;&lt;importDFwikis inline&gt;&gt;\nThis demo works only working at local, ''NOT when accesed througth http''. You may use our server [[http://morfeo.upc.edu/crom]] to try and play with it. Have fun!\n----\nExportTiddlersToDFwikiPluglin\n&lt;&lt;exportDFwikis inline&gt;&gt;\nThis demo works only working at local, ''NOT when accesed througth http''. You may use our server [[http://morfeo.upc.edu/crom]] to try and play with it. \n|''user''|dfdemo|''password''|dfdemo|\n|''course''|dfdemo|''wiki''|dfdemo|\n\n\n</div>
<div tiddler="our blogs" modifier="Ludo(Marc Alier)" modified="200611021203" created="200611021203" tags="">[[DFWikiteam]] Blogs:\n!Blogs in english\n[[Ludo's Blog in Moodle.org|http://moodle.org/blog/index.php?userid=22420&amp;courseid=1]]\n!Blogs in Spanish \n[[Orangoodling Ludo's blog|http://orangoodling.blogspot.com/]]\n[[De percebes y tortugas|http://enochrooted.blogspot.com/]]\n[[Alex Moreno's blog|http://vdemarvvv.blogspot.com/]]\n!Blogs in catalan\n[[Orangoodle Ludo's blog|http://orangoodle.blogspot.com/]]\n[[El Pigui i la wiki|http://elpigui-i-lawiki.blogspot.com/index.html]] Jordi Piguillem's Blog </div>
<div tiddler="tiddlyspotControls" modifier="tiddlyspot" modified="200609180323" created="200609180323" tags="tiddlyspot">| tiddlyspot password:|&lt;&lt;option pasUploadPassword&gt;&gt;|\n| site management:|&lt;&lt;upload http://moodle.tiddlyspot.com/store.cgi index.html . . moodle&gt;&gt;//(requires tiddlyspot password)//&lt;&lt;br&gt;&gt;[[control panel|http://moodle.tiddlyspot.com/controlpanel]], [[download (go offline)|http://moodle.tiddlyspot.com/download]]|\n| links:|[[tiddlyspot.com|http://tiddlyspot.com/]], [[FAQs|http://faq.tiddlyspot.com/]], [[announcements|http://announce.tiddlyspot.com/]], [[blog|http://tiddlyspot.com/blog/]], email [[support|mailto:support@tiddlyspot.com]] &amp; [[feedback|mailto:feedback@tiddlyspot.com]], [[donate|http://tiddlyspot.com/?page=donate]]|</div>
		</div>
<!--POST-BODY-START-->

<!--POST-BODY-END-->
	</body>
</html>
