<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 10, revision: 2, date: new Date("December 15, 2024"), extensions: {}};

//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2012

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.

" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> My TiddlyWiki - a reusable non-linear personal web notebook </title>
<style id="styleArea" type="text/css">
#saveTest, #messageArea, #copyright, #storeArea, #shadowArea {
	display: none;
}
#javascriptWarning {
	text-align: center;
	padding: 1em;
	font-weight: bold;
	background-color: #dd1100;
	color: #fff;
}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>

</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="GettingStarted">
<pre>When getting started, you may want to:
* Set your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;
* Change the page [[title|SiteTitle]] (now "&lt;&lt;tiddler SiteTitle&gt;&gt;") and [[subtitle|SiteSubtitle]] (now "&lt;&lt;tiddler SiteSubtitle&gt;&gt;"); they also set the browser tab title
* Create a tiddler where your content "starts"
** Use the button on the sidebar or [[link|My first tiddler]] it here, follow the link, edit, and click "done"
** It will be shown in the Timeline (usually on the right), but you may want to link it in the MainMenu (usually on the left)
** and/or make it open when the ~TiddlyWiki is opened by editing the list of [[DefaultTiddlers]] (separate links with spaces or linebreaks)
* Save your ~TiddlyWiki
** Although "download saving" works in any browser, it may be not that convenient, so you'll probably want to use [[a dedicated saver|https://classic.tiddlywiki.com/#%5B%5BSetting up saving%5D%5D]]
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' role='banner'&gt;
  &lt;div class='headerShadow'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class='headerForeground'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' role='navigation' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
  &lt;div id='sidebarOptions' role='navigation' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
  &lt;div id='sidebarTabs' role='complementary' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea' role='main'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1, h2, h3, h4, h5, h6 { color: [[ColorPalette::SecondaryDark]]; }
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.txtOptionInput {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {
	background: -moz-linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
	background: linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
}
.header a:hover {background:transparent;}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected {
	color:[[ColorPalette::Foreground]];
	background:[[ColorPalette::Background]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard { background:[[ColorPalette::PrimaryPale]]; }
.wizard__title    { color:[[ColorPalette::PrimaryDark]]; border:none; }
.wizard__subtitle { color:[[ColorPalette::Foreground]]; border:none; }
.wizardStep { background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]]; }
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizardFooter .status a { color: [[ColorPalette::PrimaryPale]]; }
.wizard .button {
	color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryDark]];
}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {
	color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];
}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]]; }
.messageToolbar__button { color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none; }
.messageToolbar__button_withIcon { background:inherit; }
.messageToolbar__button_withIcon:active { background:inherit; border:none; }
.tw-icon line { stroke: [[ColorPalette::TertiaryDark]]; }
.messageToolbar__button:hover .tw-icon line { stroke: [[ColorPalette::Foreground]]; }

.popup {
	background: [[ColorPalette::Background]];
	color: [[ColorPalette::TertiaryDark]];
	box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]];
}
.popup li a, .popup li a:visited, .popup li a:hover, .popup li a:active {
	color:[[ColorPalette::Foreground]]; border: none;
}
.popup li a:hover { background:[[ColorPalette::SecondaryLight]]; }
.popup li a:active { background:[[ColorPalette::SecondaryPale]]; }
.popup li.disabled { color:[[ColorPalette::TertiaryMid]]; }
.popupHighlight {color:[[ColorPalette::Foreground]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged { background: [[ColorPalette::Background]]; border: 2px solid [[ColorPalette::TertiaryPale]]; }
.selected .tagging, .selected .tagged { border: 2px solid [[ColorPalette::TertiaryLight]]; }
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button { border:none; }

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.twtable { background: [[ColorPalette::Background]]; }
.viewer th, .viewer thead td, .twtable th, .twtable thead td { background: [[ColorPalette::SecondaryMid]]; color: [[ColorPalette::Background]]; }
.viewer td, .viewer tr, .twtable td, .twtable tr { border: 1px solid [[ColorPalette::TertiaryLight]]; }
.twtable caption { color: [[ColorPalette::TertiaryMid]]; }

.viewer pre {background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:alpha(opacity=60);}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
body { font-size:.75em; font-family:arial,helvetica,sans-serif; margin:0; padding:0; }

* html .tiddler {height:1%;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em; border-width: 1px; }

#contentWrapper .chkOptionInput {border:0;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}


a {text-decoration:none;}

.externalLink {text-decoration:underline;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
#mainMenu .tiddlyLinkNonExisting,
#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}


.header {position:relative;}
.headerShadow {position:relative; padding:3em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:3em 0 1em 1em; left:0; top:0;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}
#sidebarTabs li:not(:last-child) { margin-bottom: 0.3em; }
#sidebarTabs ul:not(:last-child) { margin-bottom: 0.5em; }

.wizard { padding:0.1em 2em 0; }
.wizard__title    { font-size:2em; }
.wizard__subtitle { font-size:1.2em; }
.wizard__title, .wizard__subtitle { font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em; }
.wizardStep { padding:1em; }
.wizardFooter { padding: 0.8em 0; }
.wizardFooter .status { display: inline-block; line-height: 1.5; padding: 0.3em 1em; }
.wizardFooter .button { margin:0.5em 0 0; font-size:1.2em; padding:0.2em 0.5em; }

#messageArea { position:fixed; top:2em; right:0; margin:0.5em; padding:0.7em 1em; z-index:2000; }
.messageToolbar { text-align:right; padding:0.2em 0; }
.messageToolbar__button { text-decoration:underline; }
.messageToolbar__button_withIcon { display: inline-block; }
.tw-icon { height: 1em; width: 1em; } /* width for IE */
.tw-icon line { stroke-width: 1; stroke-linecap: round; }
.messageArea__text:not(:last-child) { margin-bottom: 0.3em; }
.messageArea__text a { text-decoration:underline; }

.popup {position:absolute; z-index:300; font-size:.9em; padding:0.3em 0; list-style:none; margin:0;}
.popup .popupMessage, .popup li.disabled, .popup li a { padding: 0.3em 0.7em; }
.popup li a {display:block; font-weight:normal; cursor:pointer;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {display: inline-block; white-space: nowrap; position: relative; bottom: -0.7px; margin: 0 0.25em 0 0; padding:0.2em;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler { padding: 1em; }

.title { font-size: 1.6em; font-weight: bold; }
.subtitle { font-size: 1.1em; }

.missing .viewer, .missing .title { font-style: italic; }
.missing .subtitle { display: none; }

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagged li, .tagging li { margin: 0.3em 0; }
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation { padding: 0.5em 0.8em; margin: 0.5em 1px; }

.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable { border-collapse: collapse; margin: 0.8em 0; }
.viewer th, .viewer td, .viewer tr, .viewer caption, .twtable th, .twtable td, .twtable tr, .twtable caption { padding: 0.2em 0.4em; }
.twtable caption { font-size: 0.9em; }
table.listView { margin: 0.8em 1.0em; }
table.listView th, table.listView td, table.listView tr { text-align: left; }
.listView &gt; thead { position: sticky; top: 0; }

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer pre {padding:0.5em; overflow:auto;}
pre, code { font-family: monospace, monospace; font-size: 1em; }
.viewer pre, .viewer code { line-height: 1.4em; }

.editor {font-size:1.1em; line-height:1.4em;}
.editor input, .editor textarea { display: block; width: 100%; box-sizing: border-box; font: inherit; padding: 0.1em 0.4em; }
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0; padding-bottom:0;}

.fieldsetFix {border:0; padding:0; margin:1px 0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding: 0.3em 0.5em; display: inline-block;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel { display:none; z-index:100; position:absolute; width:90%; margin:0 5%; }
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
  #mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea { display: none !important; }
  #displayArea { margin: 1em 1em 0em; }
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>

</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="(a). Layout Changes" modifier="SimonBaird" created="200603060359" modified="200605040226" tags="[[2. What's different about TagglyTagging?]]" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605040226">
<pre>* A tiddler's tags are show ''above'' the tiddlers title (instead of in a right-floated box).
* A tiddler's tagging list is shown ''below'' the tiddlers content (instead of in a left-floated box).
* When editing a tiddler the tags edit box is above the tiddler content (instead of below).
These layout changes are done with small changes to ViewTemplate (See TagglyTaggingViewTempplate) and EditTemplate (see TagglyTaggingEditTemplate) and with some CSS from TagglyTaggingStyles.
</pre>
</div>
<div title="(b). Enhanced &quot;tagging&quot; list" modifier="SimonBaird" created="200603060400" modified="200603060400" tags="[[2. What's different about TagglyTagging?]]" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060400">
<pre>The default TW tagging macro is called &quot;tagging&quot;. TagglyTagging provides an enhanced version of this called &quot;tagglyTagging&quot;. So in the TagglyTaggingViewTemplate, macro=&quot;tagging&quot; is replaced by &quot;macro=&quot;tagglyTagging&quot;. The tagglyTagging macro lets you do things like:
* Sort the tagged list ascending or descending by title, modified date or created date
* Format the list in columns
* Hide the tagged list
It also remembers your preference on a per-tiddler basis. 
</pre>
</div>
<div title="(c). The &quot;new here&quot; button" modifier="SimonBaird" created="200603060400" modified="200603060400" tags="[[2. What's different about TagglyTagging?]]" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060400">
<pre>The &quot;New Here&quot; button is optional but very useful. It lets you quickly create a new tiddler that is automatically tagged with the tag you're looking at. Eg if you are looking at Addresses, clicking &quot;new here&quot; creates a new Address.
</pre>
</div>
<div title="(d). The QuickOpenTagsPlugin" modifier="SimonBaird" created="200603060405" modified="200603060405" tags="[[2. What's different about TagglyTagging?]]" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060405">
<pre>This is also optional. Because we often want to view a tag as a tiddler this makes the default action when you click on a tag. You can access to other tag functions by clicking the drop down icon to the right of the tag.
</pre>
</div>
<div title="1. What is TagglyTagging?" modifier="SimonBaird" created="200603060358" modified="200603060358" tags="TagglyTaggingFAQ" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060358">
<pre>TagglyTagging (also known as &quot;TagglyWiki Style Tagging&quot;) is set of plugins, templates and styles you can install in your TiddlyWiki that let you use tagging in powerful and useful ways.
</pre>
</div>
<div title="2. What's different about TagglyTagging?" modifier="SimonBaird" created="200603060359" modified="200603060359" tags="TagglyTaggingFAQ" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060359">
<pre>Actually a lot less than there used to be since TiddlyWiki version 2.0! (TagglyTagging introduced the concept that a tag was a tiddler and vice-versa. Since version 2.0 this concept central to tagging in TiddlyWiki. See &quot;Where did it come from?&quot; below for more information).
</pre>
</div>
<div title="3. Why use TagglyTagging?" modifier="SimonBaird" created="200603060406" modified="200603060407" tags="TagglyTaggingFAQ" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060407">
<pre>TagglyTagging lets you better utilise the power of tagging your TiddlyWiki data. 
A brief list of what you can do with TagglyTagging:
* Dynamically define the structure of your data.
* Avoid hand maintaining &quot;index&quot; pages of your tiddlers.
* Make all your data easily locatable via your tag heirachy.

Other reasons you should give TagglyTagging a try:
* You find you aren't getting a lot of value from tagging your tiddlers in TiddlyWiki.
* You are sometimes annoyed by tag popup menus especially when they are longer than your page.

Sounds good but I'm not feelin' it...
* It is hard to explain without a demonstration. Try the TagglyTaggingTutorial.
</pre>
</div>
<div title="4. How do I install it?" modifier="SimonBaird" created="200603060407" modified="200603060407" tags="TagglyTaggingFAQ" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060407">
<pre>The easiest way is to download an empty file from [[Download]]. You can of course install each component listed at TagglyTagging.</pre>
</div>
<div title="5. Where did it come from?" modifier="SimonBaird" created="200603060408" modified="200603060408" tags="TagglyTaggingFAQ" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060408">
<pre>See TagglyTaggingHistory.
</pre>
</div>
<div title="About" modifier="SimonBaird" created="200603091433" modified="200603091433" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091433">
<pre></pre>
</div>
<div title="Add version numbers to plugins" modifier="SimonBaird" created="200603011026" modified="200603060438" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060438">
<pre>Do this:
&lt;&lt;&lt;
When you are creating the plugin/macro and you provide version meta data about the plugin via version.extensions.ForEachTiddlerPlugin = {major: 1, minor: 0, revision: 5, date: new Date(2006,2,5), source: &quot;http://tiddlywiki.abego-software.de/#ForEachTiddlergPlugin &quot;}; would it be too bold to ask that you name the extension the same as the actual containing Tiddler - like Udo has done with the forEachTiddlerPlugin?
&lt;&lt;&lt;

!6/3/06
Done some...</pre>
</div>
<div title="AmPmTimeFormat" modifier="Simon" created="200605070745" modified="200607170232" tags="systemConfig Plugins WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607170232">
<pre>/***
This functionality is already in upcoming 2.1 beta, see http://trac.tiddlywiki.org/tiddlywiki/changeset/205
***/

//{{{

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return (h &gt; 12 ? h-12 : ( h &gt; 0 ? h : 12 ));
}

Date.prototype.getAmPm = function()
{
	return (this.getHours() &gt;= 12 ? &quot;pm&quot; : &quot;am&quot;);
}

// Substitute date components into a string
// should be a hijack but hopefull this or something like it will go into core...
Date.prototype.formatString = function(template)
{
	template = template.replace(/YYYY/g,this.getFullYear());
	template = template.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	template = template.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	template = template.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	template = template.replace(/MM/g,this.getMonth()+1);
	template = template.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	template = template.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	template = template.replace(/DDth/g,this.getDate()+this.daySuffix());
	template = template.replace(/DD/g,this.getDate());
	template = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));   // &lt;--------- new
	template = template.replace(/hh12/g,this.getHours12());                      // &lt;--------- new
	template = template.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	template = template.replace(/hh/g,this.getHours());
	template = template.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	template = template.replace(/mm/g,this.getMinutes());
	template = template.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	template = template.replace(/ss/g,this.getSeconds());
	template = template.replace(/[ap]m/g,this.getAmPm().toLowerCase());   // &lt;--------- new
	template = template.replace(/[AP]M/g,this.getAmPm().toUpperCase());   // &lt;--------- new
	return template;
}

//}}}

</pre>
</div>
<div title="Apples" modifier="SimonBaird" created="200601101237" modified="200603060040" tags="Groceries" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060040">
<pre>sdfdfg</pre>
</div>
<div title="Array Contains" modifier="SimonBaird" created="200603060052" modified="200603060059" tags="Snippets" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060059">
<pre>//{{{

// uses code originally written by Udo

if (!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(item) {
		for (var i=0;i&lt;this.length;i++)
			if (this[i] == item)
				return i;
		return -1;
	};
}

if (!Array.prototype.contains) {
	Array.prototype.contains = function(item) {
		return (this.indexOf(item) &gt;= 0);
	};
}

//}}}
</pre>
</div>
<div title="AutoCorrectPlugin" modifier="SimonBaird" created="200604061250" modified="200604061447" tags="Plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604061447">
<pre>/***
| Name:|AutoCorrectPlugin|
| Created by:|SimonBaird|
| Location:|http://simonbaird.com/mptw/#AutoCorrectPlugin|
| Version:|1.0.0 (06-Apr-2006)|
| Requires:|~TW2.x|
!Description
Auto-corrects a list of mistyped or misspelled words. The list of words can be in any tiddler tagged with autoCorrectWords
!History
* 06-Apr-06, version 1.0.0
** split off from InstantTimestamp
** read translations from a tiddler instead of javascript array
!Notes
* See also InstantTimestamp, BigListForAutoCorrect, MyAutoCorrectWords
!Code
***/
//{{{

version.extensions.AutoCorrectPlugin = { major: 1, minor: 0, revision: 0, date: new Date(2006,4,6),
	source: &quot;http://simonbaird.com/mptw/#AutoCorrectPlugin&quot;
};

config.AutoCorrectPlugin = {
	wordListTag: &quot;autoCorrectWords&quot;,
	excludeTags: [
		&quot;noAutoCorrect&quot;,
		&quot;CSS&quot;,
		&quot;css&quot;,
		&quot;systemConfig&quot;,
		&quot;zsystemConfig&quot;,
		&quot;Plugins&quot;,
		&quot;Plugin&quot;,
		&quot;plugins&quot;,
		&quot;plugin&quot;,
		&quot;javascript&quot;,
		&quot;code&quot;
	],
	excludeTiddlers: [
		&quot;StyleSheet&quot;,
		&quot;StyleSheetLayout&quot;,
		&quot;StyleSheetColors&quot;,
		&quot;StyleSheetPrint&quot;
	]
}; 

if (!Array.prototype.contains)
	Array.prototype.contains = function(item) {
		return (this.find(item) != null);
	};

if (!Array.prototype.containsAny)
	Array.prototype.containsAny = function(items) {
		for (var i=0;i&lt;items.length;i++)
			if (this.contains(items[i]))
				return true;
		return false;
	};

String.prototype.upperCaseFirst = function() {
	return this.substr(0,1).toUpperCase() + this.substr(1);
}

TiddlyWiki.prototype.saveTiddler_mptw_autocorrect = TiddlyWiki.prototype.saveTiddler;
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags) {

	tags = (typeof(tags) == &quot;string&quot;) ? tags.readBracketedList() : tags;
	var conf = config.AutoCorrectPlugin;

	if ( !tags.containsAny(conf.excludeTags) 
			&amp;&amp; !tags.contains(conf.wordListTag)
					&amp;&amp; !conf.excludeTiddlers.contains(newTitle) ) {

		var wordListTiddlers = store.getTaggedTiddlers(conf.wordListTag);
		for (var i=0;i&lt;wordListTiddlers.length;i++) {
			var lines = wordListTiddlers[i].text.split(/$/m);
			for (var j=0;j&lt;lines.length;j++) {
				if (lines[j].indexOf(&quot;-&gt;&quot;) &gt; 0) {
					var replacer = lines[j].trim().split(&quot;-&gt;&quot;);
					newBody = newBody.replace(new RegExp(
						&quot;\\b&quot;+replacer[0]+&quot;\\b&quot;,&quot;g&quot;),replacer[1]);
					newBody = newBody.replace(new RegExp(
						&quot;\\b&quot;+replacer[0].upperCaseFirst()+&quot;\\b&quot;,&quot;g&quot;),replacer[1].upperCaseFirst());
				}
			}
		}
	}

	return this.saveTiddler_mptw_autocorrect(title,newTitle,newBody,modifier,modified,tags);
}

//}}}
</pre>
</div>
<div title="Beer" modifier="SimonBaird" created="200601101234" modified="200603060110" tags="Groceries Buy" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060110">
<pre>Mmm... beer
[img[XXXX|../images/xxxxbitter.jpg]]</pre>
</div>
<div title="BigClock" modifier="YourName" created="200608032227" modified="200608032228" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608032228">
<pre>&lt;&lt;clock2 350&gt;&gt;</pre>
</div>
<div title="BigListForAutoCorrect" modifier="SimonBaird" created="200604061228" modified="200604061346" tags="autoCorrectWords noAutoCorrect" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604061346">
<pre>Designed for use with AutoCorrectPlugin. Tag with autoCorrectWords to enable these translations. Sourced from http://www.actwin.com/rwmack/spelling.htm
{{{
absense-&gt;absence
acceptible-&gt;acceptable
accessable-&gt;accessible
accidently-&gt;accidentally
accomadate-&gt;accommodate
accompanyed-&gt;accompanied
accross-&gt;across
acheivement-&gt;achievement
achievment-&gt;achievement
acomplish-&gt;accomplish
acquiantence-&gt;acquaintance
acquited-&gt;acquitted
actualy-&gt;actually
acuracy-&gt;accuracy
addmission-&gt;admission
adolecent-&gt;adolescent
adress-&gt;address
adviced-&gt;advised
agian-&gt;again
agina-&gt;again
agravate-&gt;aggravate
agressive-&gt;aggressive
ahev-&gt;have
ahppen-&gt;happen
ahve-&gt;have
alomst-&gt;almost
almsot-&gt;almost
alotted-&gt;allotted
alreayd-&gt;already
alusion-&gt;allusion
alwasy-&gt;always
alwyas-&gt;always
amature-&gt;amateur
amke-&gt;make
amking-&gt;making
anbd-&gt;and
anual-&gt;annual
anytying-&gt;anything
aquiantance-&gt;acquaintance
aquire-&gt;acquire
aquitted-&gt;acquitted
arangement-&gt;arrangement
arguement-&gt;argument
athat-&gt;that
audeince-&gt;audience
aveh-&gt;have
avhe-&gt;have
awya-&gt;away
bakc-&gt;back
baout-&gt;about
barin-&gt;brain
bcak-&gt;back
becasue-&gt;because
becuase-&gt;because
befoer-&gt;before
begining-&gt;beginning
beleive-&gt;believe
bera-&gt;bear
boaut-&gt;about
busness-&gt;business
casion-&gt;casino
ceratin-&gt;certain
chari-&gt;chair
chasr-&gt;characters
claer-&gt;clear
claerer-&gt;clearer
claerly-&gt;clearly
clera-&gt;clear
comittee-&gt;committee
comming-&gt;coming
commitee-&gt;committee
constatn-&gt;constant
coudl-&gt;could
coudln-&gt;couldn
cpoy-&gt;copy
cxan-&gt;can
dael-&gt;deal
definit-&gt;definite
deram-&gt;dream
deside-&gt;decide
devide-&gt;divide
diea-&gt;idea
doens-&gt;doesn
doign-&gt;doing
donig-&gt;doing
dreasm-&gt;dreams
drnik-&gt;drink
dyas-&gt;days
efel-&gt;feel
eles-&gt;else
embarass-&gt;embarrass
embarassing-&gt;embarrassing
embarras-&gt;embarrass
embarrasing-&gt;embarrassing
ened-&gt;need
enxt-&gt;next
erally-&gt;really
esle-&gt;else
ethose-&gt;ethos
eveyr-&gt;every
exagerate-&gt;exaggerate
exagerated-&gt;exaggerated
exagerating-&gt;exaggerating
existance-&gt;existence
eyar-&gt;year
eyars-&gt;years
eyasr-&gt;years
fianlly-&gt;finally
fidn-&gt;find
fiel-&gt;file
fiels-&gt;files
financialy-&gt;financially
firends-&gt;friends
firts-&gt;first
fomr-&gt;from
forfiet-&gt;forfeit
forhead-&gt;forehead
foriegn-&gt;foreign
foudn-&gt;found
fourty-&gt;forty
freind-&gt;friend
frist-&gt;first
fulfilment-&gt;fulfillment
garanteed-&gt;guaranteed
gaurd-&gt;guard
generaly-&gt;generally
gerat-&gt;great
godo-&gt;good
gogin-&gt;going
gonig-&gt;going
goign-&gt;going
goverment-&gt;government
governer-&gt;governor
grammaticaly-&gt;grammatically
grammer-&gt;grammar
greif-&gt;grief
grwo-&gt;grow
graet-&gt;great
grat-&gt;great
greta-&gt;great
guage-&gt;gauge
guidence-&gt;guidance
hace-&gt;have
haev-&gt;have
hapened-&gt;happened
harras-&gt;harass
herad-&gt;heard
hera-&gt;hear
herat-&gt;heart
heroe-&gt;hero
heros-&gt;heroes
hieght-&gt;height
hismelf-&gt;himself
horus-&gt;hours
housr-&gt;hours
hten-&gt;then
htere-&gt;there
htey-&gt;they
hting-&gt;thing
htikn-&gt;think
htink-&gt;think
htis-&gt;this
humer-&gt;humor
hvae-&gt;have
hvea-&gt;have
hvaing-&gt;having
hwihc-&gt;which
hwile-&gt;while
hwole-&gt;whole
hypocracy-&gt;hypocrisy
hypocrasy-&gt;hypocrisy
hypocrit-&gt;hypocrite
idae-&gt;idea
idaes-&gt;ideas
idesa-&gt;ideas
ilogical-&gt;illogical
imagenary-&gt;imaginary
imagin-&gt;imagine
imediately-&gt;immediately
imense-&gt;immense
immitate-&gt;imitate
incidently-&gt;incidentally
incredable-&gt;incredible
independant-&gt;independent
indispensible-&gt;indispensable
inevatible-&gt;inevitable
inevitible-&gt;inevitable
infinit-&gt;infinite
inocence-&gt;innocence
intelectual-&gt;intellectual
inteligence-&gt;intelligence
inteligent-&gt;intelligent
interpet-&gt;interpret
interupt-&gt;interrupt
intrest-&gt;interest
irelevent-&gt;irrelevant
iresistable-&gt;irresistible
iresistible-&gt;irresistible
iritable-&gt;irritable
iritated-&gt;irritated
irresistable-&gt;irresistible
inot-&gt;into
iwll-&gt;will
iwth-&gt;with
jeapardy-&gt;jeopardy
jstu-&gt;just
jsut-&gt;just
knowlege-&gt;knowledge
konw-&gt;know
konws-&gt;knows
knwo-&gt;know
knwos-&gt;knows
kwno-&gt;know
labatory-&gt;laboratory
labratory-&gt;laboratory
leanr-&gt;learn
legitamate-&gt;legitimate
leran-&gt;learn
lerans-&gt;learns
levle-&gt;level
liason-&gt;liaison
libary-&gt;library
lible-&gt;liable
lief-&gt;life
lieing-&gt;lying
liek-&gt;like
liekd-&gt;liked
liesure-&gt;leisure
lightening-&gt;lightning
litature-&gt;literature
literture-&gt;literature
littel-&gt;little
liuke-&gt;like
liev-&gt;live
livley-&gt;lively
loev-&gt;love
lonelyness-&gt;loneliness
lonley-&gt;lonely
lonly-&gt;lonely
lsat-&gt;last
lveo-&gt;love
lvoe-&gt;love
maintainance-&gt;maintenance
maintainence-&gt;maintenance
maintenence-&gt;maintenance
makse-&gt;makes
manuever-&gt;maneuver
mariage-&gt;marriage
marrage-&gt;marriage
mathamatics-&gt;mathematics
mear-&gt;mere
medacine-&gt;medicine
mena-&gt;mean
menas-&gt;means
messanger-&gt;messenger
minature-&gt;miniature
mischeivous-&gt;mischievous
misile-&gt;missile
mkae-&gt;make
mkaes-&gt;makes
mkaing-&gt;making
mkea-&gt;make
moent-&gt;moment
moeny-&gt;money
moer-&gt;more
morgage-&gt;mortgage
movei-&gt;movie
mroe-&gt;more
muscels-&gt;muscles
mysefl-&gt;myself
mysterous-&gt;mysterious
naturaly-&gt;naturally
naturely-&gt;naturally
neccessary-&gt;necessary
necesary-&gt;necessary
neice-&gt;niece
nickle-&gt;nickel
nineth-&gt;ninth
ninty-&gt;ninety
nkow-&gt;know
nkwo-&gt;know
noticable-&gt;noticeable
noticeing-&gt;noticing
nuculear-&gt;nuclear
nuisanse-&gt;nuisance
nusance-&gt;nuisance
oaky-&gt;okay
obstacal-&gt;obstacle
ocasionally-&gt;occasionally
occassionally-&gt;occasionally
occurance-&gt;occurrence
occured-&gt;occurred
occurence-&gt;occurrence
occurr-&gt;occur
occurrance-&gt;occurrence
ocurr-&gt;occur
ocurrance-&gt;occurrence
ocurred-&gt;occurred
ocurrence-&gt;occurrence
oging-&gt;going
omision-&gt;omission
omited-&gt;omitted
omre-&gt;more
onot-&gt;onto
onyl-&gt;only
oponent-&gt;opponent
oportunity-&gt;opportunity
oposite-&gt;opposite
oppinion-&gt;opinion
optomism-&gt;optimism
orgin-&gt;origin
orginal-&gt;original
orginize-&gt;organize
otehr-&gt;other
owrk-&gt;work
owudl-&gt;would
paide-&gt;paid
palce-&gt;place
pamplet-&gt;pamphlet
paralel-&gt;parallel (500)
parrallel-&gt;parallel (700)
pasttime-&gt;pastime
payed-&gt;paid
peculure-&gt;peculiar
peice-&gt;piece
peom-&gt;poem
peoms-&gt;poems
peopel-&gt;people
peotry-&gt;poetry
performence-&gt;performance
perhpas-&gt;perhaps
perhasp-&gt;perhaps
permanent-&gt;permanent
permissable-&gt;permissible
perphas-&gt;perhaps
personel-&gt;personal
planed-&gt;planned
plesant-&gt;pleasant
poisin-&gt;poison
posess-&gt;possess
posession-&gt;possession
possable-&gt;possible
possably-&gt;possibly
possesion-&gt;possession
practicaly-&gt;practically
practicly-&gt;practically
prairy-&gt;prairie
preceed-&gt;precede
prefered-&gt;preferred
prepair-&gt;prepare
prepartion-&gt;preparation
presense-&gt;presence
prevelant-&gt;prevalent
priviledge-&gt;privilege
probablly-&gt;probably
probelm-&gt;problem
proceed-&gt;proceed
proceedure-&gt;procedure
profesion-&gt;profession
profesor-&gt;professor
proffesion-&gt;profession
proffesor-&gt;professor
prominant-&gt;prominent
prophacy-&gt;prophecy
propoganda-&gt;propaganda
psycology-&gt;psychology
publically-&gt;publicly
pumkin-&gt;pumpkin
pwoer-&gt;power
qtuie-&gt;quite
quantaty-&gt;quantity
quizes-&gt;quizzes
qutie-&gt;quite
raelly-&gt;really
reacll-&gt;recall
realy-&gt;really
realyl-&gt;really
reciept-&gt;receipt
recieve-&gt;receive
recieving-&gt;receiving
recomend-&gt;recommend
recrod-&gt;record
rediculous-&gt;ridiculous
refered-&gt;referred
refering-&gt;referring
referrence-&gt;reference
regluar-&gt;regular
rela-&gt;real
relaly-&gt;really
releive-&gt;relieve
rememberance-&gt;remembrance
repatition-&gt;repetition
representive-&gt;representative
restraunt-&gt;restaurant
rewriet-&gt;rewrite
roomate-&gt;roommate
russina-&gt;russian
rwite-&gt;write
rythm-&gt;rhythm
rythem-&gt;rhythm
sacrafice-&gt;sacrifice
saftey-&gt;safety
salery-&gt;salary
sargant-&gt;sergeant
sasy-&gt;says
schedual-&gt;schedule
scirpt-&gt;script
scripot-&gt;script
secretery-&gt;secretary
seperate-&gt;separate
severley-&gt;severely
sherif-&gt;sheriff
shineing-&gt;shining
shoudl-&gt;should
shoudln-&gt;shouldn
sieze-&gt;seize
simpley-&gt;simply
sincerley-&gt;sincerely
sinse-&gt;since
smae-&gt;same
smoe-&gt;some
snese-&gt;sense
soem-&gt;some
sohw-&gt;show
sophmore-&gt;sophomore
soudn-&gt;sound
soudns-&gt;sounds
sotry-&gt;story
sotyr-&gt;story
sould-&gt;soul
soulds-&gt;souls
speach-&gt;speech
sponser-&gt;sponsor
stroy-&gt;story
stoyr-&gt;story
stopry-&gt;story
storeis-&gt;stories
storise-&gt;stories
stnad-&gt;stand
stpo-&gt;stop
strat-&gt;start
stubborness-&gt;stubbornness
successfull-&gt;successful
suceed-&gt;succeed
suer-&gt;sure
sumary-&gt;summary
supercede-&gt;supersede
superintendant-&gt;superintendent
supose-&gt;suppose
supress-&gt;suppress
surley-&gt;surely
suround-&gt;surround
suseptible-&gt;susceptible
swiming-&gt;swimming
syas-&gt;says
taeks-&gt;takes
tahn-&gt;than
taht-&gt;that
tath-&gt;that
talek-&gt;talk
talekd-&gt;talked
tehy-&gt;they
temperment-&gt;temperament
temperture-&gt;temperature
tendancy-&gt;tendency
thgat-&gt;that
tghe-&gt;the
ther-&gt;there
theri-&gt;their
thge-&gt;the
thier-&gt;their
thign-&gt;thing
thigns-&gt;things
thigsn-&gt;things
thikn-&gt;think
thikns-&gt;thinks
thikning-&gt;thinking
thiunk-&gt;think
thna-&gt;than
thne-&gt;then
thnig-&gt;thing
thnigs-&gt;things
thsi-&gt;this
thsoe-&gt;those
thta-&gt;that
tiem-&gt;time
tih-&gt;with
tihkn-&gt;think
tihs-&gt;this
timne-&gt;time
tiome-&gt;time
tje-&gt;the
tjhe-&gt;the
tkae-&gt;take
tkaes-&gt;takes
tkaing-&gt;taking
tlaking-&gt;talking
tobbaco-&gt;tobacco
todya-&gt;today
tommorrow-&gt;tomorrow
tongiht-&gt;tonight
towrad-&gt;toward
trafficed-&gt;trafficked
trafic-&gt;traffic
transfered-&gt;transferred
truely-&gt;truly
turnk-&gt;trunk
twon-&gt;town
tyhat-&gt;that
tyhe-&gt;the
tyrany-&gt;tyranny
unconcious-&gt;unconscious
unecessary-&gt;unnecessary
unmistakeably-&gt;unmistakably
untill-&gt;until
useage-&gt;usage
usefull-&gt;useful
useing-&gt;using
usualy-&gt;usually
vaccum-&gt;vacuum
valuble-&gt;valuable
vegtable-&gt;vegetable
venemous-&gt;venomous
vengance-&gt;vengeance
veyr-&gt;very
vigilence-&gt;vigilance
villin-&gt;villain
visable-&gt;visible
vrey-&gt;very
vyer-&gt;very
vyre-&gt;very
waht-&gt;what
warrent-&gt;warrant
watn-&gt;want
wehn-&gt;when
weild-&gt;wield
wendsay-&gt;Wednesday
wensday-&gt;Wednesday
whcih-&gt;which
whereever-&gt;wherever
whic-&gt;which
whihc-&gt;which
wholy-&gt;wholly
whta-&gt;what
wief-&gt;wife
wierd-&gt;weird
wiht-&gt;with
wintery-&gt;wintry
wirting-&gt;writing
withdrawl-&gt;withdrawal
wiull-&gt;will
wnat-&gt;want
wnats-&gt;wants
wnated-&gt;wanted
wohle-&gt;whole
wokr-&gt;work
worshipped-&gt;worshiped
woudl-&gt;would
wriet-&gt;write
wrok-&gt;work
wroking-&gt;working
wroet-&gt;wrote
wtih-&gt;with
yeild-&gt;yield
ytou-&gt;you
yera-&gt;year
yeras-&gt;years
yersa-&gt;years
yeasr-&gt;years
}}}</pre>
</div>
<div title="BigThemePack" modifier="SimonBaird" created="200604241837" modified="200605120523" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605120523">
<pre>/***
|Name|BigThemePack|
|Created by|SimonBaird &amp; SaqImtiaz|
|Location|http://simonbaird.com/mptw/#BigThemePack|
|Version|0.1.1|
|Requires|SelectThemePlugin|
!Uninstallation Notes:
*Make sure that you set your theme as default or none, before deleting the theme pack.

!Usage:
&lt;&lt;themeSelect style 'Select Theme'&gt;&gt;

***/
//{{{
if (!config.themes) config.themes = [];
//}}}
/***
!!~MonkyMind themes
The following themes were created by Robert Lindsay from http://www.monkymind.org/
***/
//{{{

config.shadowTiddlers.Berry2StyleSheet = &quot;&lt;!--- [[Berry 2|StyleSheet]] with ideas shamesslessly taken from (and suggested by) Simon Baird, Clint Checketts and Christine Hodges ---&gt;\n\n/*{{{*/\n.headerForeground { display: none;}\n#sidebar {width: 170px; background: #efefef;border-left: solid 2px #b8b9c7;border-top: solid 2px #d7d8e8;}\n#sidebarTabs .tabContents {width: 158px; background: #eae9ee;font-weight: bold; color: #333 ;}\n#sidebarOptions input { border: solid 2px #b8b9c7; }\n#sidebarOptions .sliderPanel { background: #eee;}\n#sidebarOptions a {;border: none;}\n#sidebarOptions .sliderPanel a {border: none;color: #5c4894;}\n#displayArea {background: #fff;margin: 1em 15.7em 0em 1em;border-left: solid 2px #b8b9c7;}\n.viewer {line-height: 1.4em;padding-bottom: 1em;border-bottom:solid 1px #b8b9c7;}\n.viewer th, thead td {background: #5d4b97;border: 1px solid #666;color: #fff;}\n.title {color: #000}\nh1,h2,h3,h4,h5 {color: #fff;background: #6b69ad;}\na{ color: #700126;}\na:hover{ background: #6b69ad; color: #fff;font-weight: bold;}\n.externalLink { text-decoration: underline; color: #000083;}\nbody { background: #d7d8e8;}\n.popup { background: #6b69ad; border: 1px solid #04b;}\n.popup li a:hover {background: #d7d8e8;color: #000;border: none;}\n.popup li.disabled {color: #000;}\n.button:hover {color: #fff;background: #6b69ad;\n border: 1px solid #d7d8e8;}\n#topMenu { background: transparent; padding: 6px;margin-left: -5px;border-bottom: solid 3px #5c4894;}\n#topMenu .button, #topMenu .tiddlyLink, tiddlyLinkExisting, #topMenu .externalLink\n{\n color: #fff;\n text-align: center;\n font-weight: bold;\n font-size: 1.1em;\n text-decoration: none;\n letter-spacing: 1.5px;\n background: transparent;\n border-right: solid 1px #fff;\n padding: 5px 15px 8px 15px;\n}\n#topMenu a:hover {\n color: #700126;\n background: #d7d8e8;\n}\n#topMenu br {display: none; padding-right: 1em;}\n\n\n/*}}}*/&quot;;

config.shadowTiddlers.Berry2PageTemplate = &quot;&lt;!--- More ideas shamesslessly begged, borrowed or stolen from..... Simon Baird, Clint Checketts and Christine Hodges :)) ---&gt;\n&lt;!--{{{--&gt;\n&lt;div class='header' macro=\&quot;gradient vert #5c4894 #6b69ad\&quot;&gt;\n &lt;div id='topMenu'&gt;\n &lt;span refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&lt;span refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;&lt;/div&gt;\n &lt;/div&gt;\n&lt;/div&gt; \n&lt;div id='sidebar'&gt;\n &lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n &lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n &lt;div id='messageArea'&gt;&lt;/div&gt;\n &lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;\n&quot;;

config.themes.push(&quot;Berry2&quot;);


config.shadowTiddlers.Blueberry2StyleSheet = &quot;&lt;!--- [[Blueberry 2|StyleSheet]] with ideas shamesslessly taken from (and suggested by) Simon Baird, Clint Checketts and Christine Hodges ---&gt;\n\n/*{{{*/\n.headerForeground { display: none;}\n#sidebar {width: 171px; background: #e7ecee;border-left: solid 2px #8895bb;border-top: solid 2px #97a8d2;}\n#sidebarTabs .tabContents {width: 158px; background: #dce1e3;font-weight: bold; color: #333 ;}\n#sidebarOptions input { border: solid 2px #8895bb; }\n#sidebarOptions .sliderPanel { background: #eee;}\n#sidebarOptions a {;border: none;}\n#sidebarOptions .sliderPanel a {border: none;color: #00005a;}\n#displayArea {background: #fff;margin: 1em 15.7em 0em 1em;border-left: solid 2px #8895bb;}\n.viewer {line-height: 1.4em;padding-bottom: 1em;border-bottom:solid 1px #dedede;}\n.viewer th, thead td {background: #00009d;border: 1px solid #666;color: #fff;}\n.title {color: #000}\nh1,h2,h3,h4,h5 {color: #fff;background: #00009d;}\na{ color: #00005a;}\na:hover{ background: #00009d; color: #fff;font-weight: bold;}\n.externalLink { text-decoration: underline; color: #000083;}\nbody { background: #97a8d2;}\n.popup { background: #04b; border: 1px solid #04b;}\n.popup li a:hover {background: #dedede;color: #000083;border: none;}\n.popup li.disabled {color: #000;}\n.button:hover {color: #fff;background: #00009d;\n border: 1px solid #dedede;}\n#topMenu { background: transparent; padding: 6px;margin-left: -5px;border-bottom: solid 3px #00005a}\n#topMenu .button, #topMenu .tiddlyLink, tiddlyLinkExisting, #topMenu .externalLink\n{\n color: #fff;\n text-align: center;\n font-weight: bold;\n font-size: 1.1em;\n text-decoration: none;\n letter-spacing: 1.5px;\n background: transparent;\n border-right: solid 1px #fff;\n padding: 5px 15px 6px 15px;\n}\n#topMenu a:hover {\n color: #fff;\n background: #00009d;\n border: solid 1px #db4;\n}\n#topMenu br {display: none; padding-right: 1em;}\n\n\n/*}}}*/&quot;;

config.shadowTiddlers.Blueberry2PageTemplate = &quot;&lt;!--- More ideas shamesslessly begged, borrowed or stolen from..... Simon Baird, Clint Checketts and Christine Hodges :)) ---&gt;\n&lt;!--{{{--&gt;\n&lt;div class='header' macro=\&quot;gradient vert #00005a #0000ad\&quot;&gt;\n &lt;div id='topMenu'&gt;\n &lt;span refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&lt;span refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;&lt;/div&gt;\n &lt;/div&gt;\n&lt;/div&gt; \n&lt;div id='sidebar'&gt;\n &lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n &lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n &lt;div id='messageArea'&gt;&lt;/div&gt;\n &lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;\n&quot;;

config.themes.push(&quot;Blueberry2&quot;);


config.shadowTiddlers.iJobsStyleSheet = &quot;&lt;!--- [[iJobs 2|StyleSheet]] with ideas shamesslessly taken from (and suggested by) Simon Baird, Clint Checketts and Christine Hodges. Colours inspired by http://www.solucija.com/templates/demo/Internet_Jobs/ ---&gt;\n/*{{{*/\n.headerForeground { display: none;}\n#sidebar {width: 171px; background: #808080;border-bottom: solid 1.5em #3c6491;border-top: solid 2px #fff;}\n#sidebarTabs .tabContents {width: 158px; background: #eee;font-weight: bold; color: #333 ;}\n.tabSelected{color: #fff;background: #963112; border: solid 1px #fff;}\n.tabUnselected {color: #fff;background: #999;}\n#sidebarOptions .sliderPanel { background: #eee;}\n#sidebarOptions a {;border: none;}\n#sidebarOptions .sliderPanel a {border: none;color: #333;background: #eee;}\n#displayArea {background: #fff;margin: 1em 15.7em 0em 1em;border-top: solid 3px #ddd;border-bottom: solid 1.5em #3c6491;}\n.viewer {line-height: 1.4em;padding-bottom: 1em;border-bottom:solid 1px #dedede;}\n.viewer th, thead td {background: #963112;border: 1px solid #666;color: #fff;}\n.title {color: #000}\nh1,h2,h3,h4,h5 {color: #fff;background: #963112;}\na{ color:#c01903 ;}\na:hover{ background: #c01903; color: #fff;font-weight: bold;}\n.externalLink { text-decoration: underline; color: #c01903;}\nbody { background: #fff;}\n.popup { background: #3c6491; border: 1px solid #3c6491;}\n.popup li a:hover {background: #dedede;color: #963112;border: none;}\n.popup li.disabled {color: #000;}\n.button {color: #fff;background: #808080;border: 1px solid #fff;}\n.button:hover {color: #fff;background: #c01903;\n border: 1px solid #dedede;}\n#topMenu { background: transparent;border-bottom: solid 3px #bcbcbc; padding: 5px;margin-left: -5px;}\n#topMenu .button, #topMenu .tiddlyLink, tiddlyLinkExisting, #topMenu .externalLink\n{\n color: #333;\n text-align: center;\n font-weight: bold;\n font-size: 1em;\n text-decoration: none;\n letter-spacing: 1.5px;\n background: transparent;\n border-right: solid 1px #fff;\n padding: 5px 15px 8px 15px;\n}\n#topMenu a:hover {\n color: #fff;\n background: #3c6491;\n}\n#topMenu br {display: none; padding-right: 1em;}\n\n\n/*}}}*/\n&quot;;

config.shadowTiddlers.iJobsPageTemplate = &quot;&lt;!--- More ideas shamesslessly begged, borrowed or stolen from..... Simon Baird, Clint Checketts and Christine Hodges :)) ---&gt;\n&lt;!--{{{--&gt;\n&lt;div class='header' macro=\&quot;gradient vert #aaa #ccc\&quot;&gt;\n &lt;div id='topMenu'&gt;\n &lt;span refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&lt;span refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;&lt;/div&gt;\n &lt;/div&gt;\n&lt;/div&gt; \n&lt;div id='sidebar'&gt;\n &lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n &lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n &lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div class='viewer' macro=\&quot;gradient vert #f5f5f5 #fff\&quot;&gt;\n &lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;\n&quot;;

config.themes.push(&quot;iJobs&quot;);


config.shadowTiddlers.NoBerry2StyleSheet = &quot;&lt;!--- The default TW colours with modified layout. Ideas shamesslessly taken from (and suggested by) Simon Baird, Clint Checketts and Christine Hodges ---&gt;\n\n/*{{{*/\n.headerForeground { display: none;}\n#sidebar {width: 170px; }\n#sidebarTabs .tabContents {width: 158px; }\n#displayArea {background: #fff;margin: 1em 15.7em 0em 1em;}\n#topMenu { background: transparent; padding: 6px;margin-left: -5px; border-bottom: solid 3px #0457ce;}\n#topMenu .button, #topMenu .tiddlyLink, tiddlyLinkExisting, #topMenu .externalLink\n{\n color: #fff;\n text-align: center;\n font-weight: bold;\n font-size: 1.1em;\n text-decoration: none;\n letter-spacing: 1.5px;\n background: transparent;\n border-right: solid 1px #fff;\n padding: 5px 15px 8px 15px;\n}\n#topMenu a:hover {\n color: #fff;\n background: #18f;\n}\n#topMenu br {display: none; padding-right: 1em;}\n\n\n/*}}}*/&quot;;

config.shadowTiddlers.NoBerry2PageTemplate = &quot;&lt;!--- More ideas shamesslessly begged, borrowed or stolen from..... Simon Baird, Clint Checketts and Christine Hodges :)) ---&gt;\n&lt;!--{{{--&gt;\n&lt;div class='header' macro=\&quot;gradient vert #04b #18f\&quot;&gt;\n &lt;div id='topMenu'&gt;\n &lt;span refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&lt;span refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;&lt;/div&gt;\n &lt;/div&gt;\n&lt;/div&gt; \n&lt;div id='sidebar'&gt;\n &lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n &lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n &lt;div id='messageArea'&gt;&lt;/div&gt;\n &lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;\n&quot;;

config.themes.push(&quot;NoBerry2&quot;);

//}}}
/***
!!Clint's Themes
The themes were created by Clint Checketts from http://www.checkettsweb.com/
The original GTD theme was created by Nathan Bowers from http://snapgrid.com/
***/
//{{{


config.shadowTiddlers.GTDStyleSheet = &quot;/***\n!Calendar CSS\n***/\n/*{{{*/\n.calendar{\n    border-bottom: 1px solid #550000;\n}\n\n.viewer .calendar{\n    width: 220px;\n}\n\n#mainMenu .calendar{\n       font-size: 8px;\n       cursor: pointer;\n width: 100%;\n border: 0;\n border-collapse: collapse;\n}\n\n#mainMenu .calendar .button{\n border: 0;\n}\n\n#mainMenu .calendar td{\n      font-size: 8pt;\n padding: 0;\n background: #fff;\n border: 0;\n}\n\n#mainMenu .calendar a{\n margin: 0;\n color: #000;\n background: transparent;\n}\n\n#mainMenu .calendar a:hover{\n color: #000;\n background: transparent;\n}\n\n#mainMenu .calendarMonthname,\n#mainMenu .calendar .calendarMonthTitle td a{\n color: #fff;\n}\n\n#mainMenu .calendarDaysOfWeek td{\n background: #500;\n color: #fff;\n}\n\n/*}}}*/\n\n/***\n!GTD Style\n\n!Generic rules /%==================================================================== %/\n***/\n/*{{{*/\nbody {\n    background: #464646 url('http://shared.snapgrid.com/images/tiddlywiki/bodygradient.png') repeat-x top fixed;\n	color: #000;\n    font: .82em/1.25em  'Bitstream Vera Sans', Verdana, Helvetica, Arial, sans-serif;\n/*'Lucida Sans Unicode', 'Lucida Grande','Trebuchet MS', */\n}\n/*}}}*/\n/***\n!Header rules /%====================================================================== %/\n***/\n/*{{{*/\n#contentWrapper\n{\n	margin: 0 auto;\nwidth: 59em;\nposition: relative;\n}\n\n#header\n{\n	color: #fff;\n	padding: 1.5em 1em .6em 0;\n}\n\n#siteTitle {\n\n	font-size: 2.3em;\n margin: 0;\n}\n\n#siteSubtitle {\n	font-size: 1em;\n	padding-left: .8em;;\n}\n\n#titleLine{\n background: transparent;\n padding: 0;\n}\n\n#titleLine a {\n    color: #cf6;\n background: transparent;\n}\n/*}}}*/\n\n\n\n\n\n\n\n\n\n/***\n!Sidebar rules /%====================================================================== %/\n***/\n/*{{{*/\n#sidebar{\n left: 0;\nwidth: 18em;\n	margin: .9em .9em 0 0;\n    color: #000;\n background: transparent;\n}\n/*}}}*/\n/***\n!Main menu rules /%=================================================================== %/\n***/\n/*{{{*/\n#mainMenu{\n position: static;\n width: auto;\n\n	background: #600;\n	border-right: 3px solid #500;\npadding: 0;\n text-align: left;\n font-size: 1em;\n}\n\n#mainMenu h1{\n padding: 0;\n margin: 0;\n font-size: 1em;\n font-weight: normal;\n}\n\n#mainMenu ul{\n padding: 0;\n margin: 0;\n list-style: none;\n}\n\n#mainMenu h1 a,\n#mainMenu li a,\n#mainMenu li a.button{\n	display: block;\n	padding: 0 5px 0 10px;\nborder: 0;\n	border-bottom: 1px solid #500;\n	border-top: 1px solid #900;\nmargin: 0;\n}\n\n#mainMenu a,\n#mainMenu a.button{\n	height: 22px;\nheight: 1.83em;\n	line-height: 22px;\n    color: #fff;\n	background: #700;\nmargin-left: 1em;\n}\n\n#mainMenu a:hover,\n#mainMenu a.button:hover {\n    background: #b00;\n color: #fff;\n}\n/*}}}*/\n/***\n!Sidebar options rules /%============================================================ %/\n***/\n/*{{{*/\n#sidebarOptions {\n    background: #eeb;\n	border-right: 3px solid #bb8;\n    color: #B4C675;\n	padding: .5em 0;\n}\n\n#sidebarOptions a {\n    color: #700;\n	margin: .2em .8em;\n padding: 0;\n border: 0;\n}\n\n#sidebarOptions a:hover, #sidebarOptions a:active {\n    color: #fff;\n    background: #700;\n border: 0;\n}\n\n#sidebarOptions input{\n     margin: 2px 10px;\n    border: 1px inset #333;\npadding: 0;\n}\n\n#sidebarOptions .sliderPanel {\n    background: #fff;\n    color: #000;\n	padding: 5px 10px;\n	font-size: .9em;\n}\n\n#sidebarOptions .sliderPanel a{\n font-weight: normal;\n margin: 0;\n}\n\n#sidebarOptions .sliderPanel a:link,#sidebarOptions .sliderPanel a:visited {\n    color: #700;\n}\n\n#sidebarOptions .sliderPanel a:hover,#sidebarOptions  .sliderPanel a:active  {\n    color: #fff;\n    background: #700;\n}\n/*}}}*/\n/***\n!Sidebar tabs rules /%===================================================================== %/\n***/\n/*{{{*/\n#sidebarTabs {\n    background: transparent;\n	border-right: 3px solid #740;\n	border-bottom: 3px solid #520;\n border: 0;\n    padding: 0;\n}\n\n#contentWrapper #sidebarTabs a,\n#contentWrapper #displayArea .tabContents a{\n    color: #fff;\n}\n\n#contentWrapper #sidebarTabs a:hover,\n#contentWrapper #displayArea .tabContents a:hover {\n    background: #000;\n    color: #fff;\n}\n\n#contentWrapper #sidebarTabs a:active,\n#contentWrapper #displayArea .tabContents a:active{\n    color: #000;\n}\n\n\n\n#contentWrapper  .tabSelected {\n	background: #960;\n}\n\n#contentWrapper  .tabUnselected{\n 	background: #660;\n}\n\n#contentWrapper #sidebar .tabset{\n background: #eeb;\n 	border-right: 3px solid #bb8;\n padding: 0 0 0 .75em;\n}\n\n#contentWrapper  .tabContents{\nfont-size: .95em;\nbackground: #960;\nborder:0;\n	border-right: 3px solid #740;\n	border-bottom: 3px solid #520;\n    padding: .75em;\n}\n\n#contentWrapper  .tabContents{\n width: auto;\n}\n\n#contentWrapper #sidebarTabs .tabContents .tabset,\n#contentWrapper .tabContents .tabset{\n border: 0;\n padding: 0;\n background: transparent;\n}\n\n#contentWrapper .tabContents .tabSelected,\n#contentWrapper .tabContents .tabContents {\n	background: #700;\n border: 0;\n}\n\n#contentWrapper .tabContents .tabUnselected {\n	background: #440;\n}\n\n#contentWrapper .tabset a {\n    color: #fff;\n	padding: .2em .7em;\n	margin: 0 .17em 0 0;\n	height: 2em;\nposition: static;\n}\n\n#contentWrapper .tabset a:hover {\n    background: #000;\n    color: #fff;\n}\n\n#contentWrapper .tabset a:active {\n    color: #000;\n}\n\n#contentWrapper .tabContents ul{\n    margin: 0;\n	padding: 0;\n	list-style: none;\n}\n\n#contentWrapper .tabContents .tabContents ul{\n    color: #eeb;\n}\n\n.tabContents ul a,\n.tabContents ul .button{\n    color: #fff;\n	display: block;\n	padding: .1em 0 .1em .7em;\n background: transparent;\n border: 0;\n}\n\n.tabContents ul a:hover {\n    color: #fff;\n    background: #000;\n}\n/*}}}*/\n/***\n!License panel rules /%==================================================================== %/\n***/\n/*{{{*/\n#licensePanel {\n    padding: 0px 1em;\n	font-size: .9em;\n}\n\n#licensePanel a {\n    color: #960;\n	display: block;\n	margin-top: .9em;\n}\n\n#licensePanel a:hover {\n    color: #fff;\n background: transparent;\n}\n/*}}}*/\n/***\n!Popup rules /%================================================================= %/\n***/\n/*{{{*/\n.popup {\n	font-size: .8em;\n	padding: 0em;\n	background: #333;\n	border: 1px solid #000;\n}\n\n.popup hr {\n margin: 1px 0 0 0;\n visibility: hidden;\n}\n\n.popup li.disabled {\n	color: #666;\n}\n\n.popup li a,\n.popup li a:visited{\n color: #000;\n	border: .1em outset #cf6;\n	background: #cf6;\n}\n\n.popup li a:hover {\nborder: .1em outset #cf6;\n    background: #ef9;\n    color: #000;\n}\n/*}}}*/\n/***\n!Message area rules /%================================================================= %/\n***/\n/*{{{*/\n#messageArea{\n	font-size: .9em;\n	padding: .4em;\n	background: #FFE72F;\n	border-right: .25em solid #da1;\n	border-bottom: .25em solid #a80;\n\nposition: fixed;\n	top: 10px;\n	right: 10px;\n color: #000;\n}\n\n#contentWrapper #messageArea a{\n color: #00e;\n text-decoration: none;\n}\n\n#contentWrapper #messageArea a:hover{\n color: #00e;\n text-decoration: underline;\n background: transparent;\n}\n\n#contentWrapper #messageArea .messageToolbar a.button{\n border: 1px solid #da1;\n}\n\n#contentWrapper #messageArea .messageToolbar a.button:hover{\n color: #00e;\n text-decoration: none;\n border: 1px solid #000;\n  background: #fff;\n}\n\n\n\n/*}}}*/\n/***\n!Tiddler display rules /%================================================================== %/\n***/\n/*{{{*/\n#displayArea {\n	width: 39.75em;\n margin: 0 0 0 17em;\n}\n\n.tiddler {\n	margin: 0 0 .9em 0;\n	padding: 0 1em;\n	border-right: .25em solid #aaa;\n	border-bottom: .25em solid #555;\n	background: #fff;\n}\n\n.title {\n    font-size: 1.5em;\n    font-weight: bold;\n color: #900;\n}\n\n.toolbar {\n font-size: .8em;\n	padding: .5em 0;\n}\n\n.toolbar .button{\n    padding: .1em .3em;\n    color: #000;\n\n	border: .1em outset #cf6;\n	background: #cf6;\nmargin: .1em;\n}\n\n.toolbar .button:hover {\n    background: #ef9;\n    color: #000;\n}\n\n.toolbar .button:active {\n    background: #ff0;\n}\n\n/*}}}*/\n/***\n!Viewer rules /% ------------------------------------------------------------------------------------------ %/\n***/\n/*{{{*/\n.viewer {\n line-height: 1.4em;\n  font-size: 1em;\n}\n\n.viewer a:link, .viewer a:visited {\n    color: #15b;\n}\n\n.viewer a:hover {\n    color: #fff;\n    background: #000;\n}\n\n.viewer .button{\n background: transparent;\n border-top: 1px solid #eee;\n border-left: 1px solid #eee;\n border-bottom: 1px solid #000;\n border-right: 1px solid #000;\n}\n\n.viewer .button:hover{\n background: #eee;\n color: #000;\n}\n\n.viewer .button:active{\n background: #ccc;\n border-bottom: 1px solid #eee;\n border-right: 1px solid #eee;\n border-top: 1px solid #111;\n border-left: 1px solid #111;\n}\n\n\n.viewer blockquote {\n    border-left: 3px solid #777;\n	margin: .3em;\n	padding: .3em;\n}\n\n.viewer pre{\n background: #fefefe;\n border: 1px solid #f1f1f1;\n}\n\n.viewer pre, .viewer code{\n color: #000;\n}\n\n.viewer ul {\n	padding-left: 30px;\n}\n\n.viewer ol {\n    padding-left: 30px;\n}\nul{\nlist-style-type: asquare;\n}\nol{ \n	list-style-type: decimal;\n}\n\nol ol{ \n	list-style-type: lower-alpha;\n}\n\nol ol ol{ \n	list-style-type: lower-roman;\n}\n\n.viewer ul, .viewer ol, .viewer p {\n    margin: .0;\n}\n\n.viewer li {\n    margin: .2em 0;\n}\n\nh1,h2,h3,h4,h5,h6 {\n color: #000;\n    font-weight: bold;\n    background: #eee;\n    padding: 2px 10px;\n	margin: 5px 0;\n}\n\n.viewer h1 {font-size: 1.3em;}\n.viewer h2 {font-size: 1.2em;}\n.viewer h3 {font-size: 1.1em;}\n.viewer h4 {font-size: 1em;}\n.viewer h5 { font-size: .9em;}\n.viewer h6 { font-size: .8em;}\n\n.viewer table {\n    border: 2px solid #303030;\n	font-size: 11px;\n	margin: 10px 0;\n}\n\n.viewer th, .viewer thead td{\n color: #000;\n    background: #eee;\n    border: 1px solid #aaa;\n    padding: 0 3px;\n}\n\n.viewer td {\n    border: 1px solid #aaa;\n    padding: 0 3px;\n}\n\n.viewer caption {\n    padding: 3px;\n}\n\n.viewer hr {\n    border: none;\n    border-top: dotted 1px #777;\n    height: 1px;\n    color: #777;\n	margin: 7px 0;\n}\n\n.viewer\n{\n margin: .5em 0 0 0;\n padding: .5em 0;\n border-top: 1px solid #ccc;\n}\n\n.highlight {\n    color: #000;\n    background: #ffe72f;\n}\n/*}}}*/\n/***\n!Editor rules /% ----------------------------------------------------------------------------------------- %/\n***/\n/*{{{*/\n.editor {\n    font-size: .8em;\n    color: #402C74;\n	padding: .3em 0;\n}\n\n.editor input, .editor textarea {\n	font: 1.1em/130% 'Andale Mono', 'Monaco', 'Lucida Console', 'Courier New', monospace;\n	margin: 0;\n    border: 1px inset #333;\n	padding: 2px 0;\n}\n\n.editor textarea {\n	height: 42em;\n	width: 100%;\n}\n\ninput:focus, textarea:focus\n{\n	background: #ffe;\n	border: 1px solid #000;\n}\n.footer\n{\n	padding: .5em 0;\n	margin: .5em 0;\n	border-top: 1px solid #ddd;\n	color: #555;\n	text-align: center;	\n}\n/*}}}*/\n/***\n!IE Display hacks /% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~%/\n***/\n/*{{{*/\nbody{\n	_text-align: center;\n}\n\n#contentWrapper\n{\n/*	_width: 770px;  CSS UNDERSCORE HACK FOR PROPER WIN/IE DISPLAY */\n	_text-align: left; /* CSS UNDERSCORE HACK FOR PROPER WIN/IE DISPLAY */	\n}\n\n#messageArea{\n	_position: absolute;\n}\n/*}}}*/&quot;;

config.shadowTiddlers.GTDPageTemplate = &quot;&lt;!---\n| Name:|GTDTWPlusPageTemplate|\n| Source:|http://www.checkettsweb.com/tw/gtd_tiddlywiki.htm#StyleSheet|\n| Author:|ClintChecketts|\n---&gt;\n&lt;!--{{{--&gt;\n&lt;div id='header'&gt;\n&lt;div id='titleLine'&gt;\n&lt;span id='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;\n&lt;span id='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;&lt;div id=\&quot;licensePanel\&quot;&gt;\n&lt;a rel=\&quot;license\&quot; href=\&quot;http://shared.snapgrid.com/gtd_tiddlywiki.html#RevisionHistory\&quot; target=\&quot;_new\&quot;&gt;GTDTW Version &lt;span macro=\&quot;version\&quot;&gt;&lt;/span&gt;&lt;/a&gt;\n&lt;a rel=\&quot;license\&quot; href=\&quot;http://www.tiddlywiki.com\&quot; target=\&quot;_new\&quot;&gt;\nTiddlyWiki is published by Jeremy Ruston at Osmosoft under a BSD open source license&lt;/a&gt;\n&lt;a rel=\&quot;license\&quot; href=\&quot;http://snapgrid.com\&quot; target=\&quot;_new\&quot;&gt;GTD TiddlyWiki is a modification by Nathan Bowers at Snapgrid under the same license terms.&lt;/a&gt;\n&lt;a rel=\&quot;license\&quot; href=\&quot;http://davidco.com\&quot; target=\&quot;_new\&quot;&gt;\&quot;Getting Things Done\&quot; is &amp;#169; David Allen at Davidco. Davidco has no affiliation with TiddlyWiki or GTD TiddlyWiki.&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;!--}}}--&gt;&quot;;

config.themes.push(&quot;GTD&quot;);


config.shadowTiddlers.DevFireStyleSheet = &quot;/***\n!Devfire\nStyle by Clint Checketts (http://www.checkettsweb.com) for TiddlyWiki 2.0\nInspired by the GLP'd Darkfire Wordpress skin.\n\n!Sections in this Tiddler:\n*Generic rules\n*Links styles\n*Header\n*Main menu\n*Sidebar\n**Sidebar options\n**Sidebar tabs\n*Message area\n*Popup\n*Tabs\n*Tiddler display\n**Viewer\n**Editor\n*Misc. rules\n!Generic rules /% ============================================================= %/\n***/\n/*{{{*/\nbody {\nbackground-color: #000;\n}\n/*}}}*/\n/***\n!Link styles /% ============================================================= %/\n***/\n/*{{{*/\na,\na.button,\n#mainMenu a.button,\n#sidebarOptions .sliderPanel a{\n color: #ffbf00;\n border: 0;\n}\n\na:hover,\na.button:hover,\n#mainMenu a.button:hover,\n#sidebarOptions .sliderPanel a:hover\n#sidebarOptions .sliderPanel a:active{\n color: #ff7f00;\n border: 0;\n border-bottom: #ff7f00 1px dashed;\n background: transparent;\n text-decoration: none;\n}\n\n#displayArea .button.highlight{\n color: #ffbf00;\n background: #4c4c4c;\n}\n/*}}}*/\n/***\n!Header styles /% ============================================================= %/\n***/\n/*{{{*/\n.header{\n border-bottom: 2px solid #ffbf00;\n color: #fff;\n}\n\n.headerForeground a {\n color: #fff;\n}\n\n.header a:hover {\n border-bottom: 1px dashed #fff;\n}\n/*}}}*/\n/***\n!Main menu styles /% ============================================================= %/\n***/\n/*{{{*/\n#mainMenu {color: #fff;}\n#mainMenu h1{\n font-size: 1.1em;\n}\n#mainMenu li,#mainMenu ul{\n	list-style: none;\n	margin: 0;\n	padding: 0;\n}\n/*}}}*/\n/***\n!Sidebar styles /% ============================================================= %/\n***/\n/*{{{*/\n#sidebar {\n right: 0;\n color: #fff;\n border: 2px solid #ffbf00;\n border-width: 0 0 2px 2px;\n}\n#sidebarOptions {\n background-color: #4c4c4c;\n padding: 0;\n}\n\n#sidebarOptions a{\n margin: 0;\n color: #ffbf00;\n border: 0;\n}\n#sidebarOptions a:hover {\n color: #4c4c4c;\n background-color: #ffbf00;\n\n}\n\n#sidebarOptions a:active {\n color: #ffbf00;\n background-color: transparent;\n}\n\n#sidebarOptions .sliderPanel {\n background-color: #333;\n margin: 0;\n}\n\n#sidebarTabs {background-color: #4c4c4c;}\n#sidebarTabs .tabSelected {\n padding: 3px 3px;\n cursor: default;\n color: #ffbf00;\n background-color: #666;\n}\n#sidebarTabs .tabUnselected {\n color: #ffbf00;\n background-color: #5f5f5f;\n padding: 0 4px;\n}\n\n#sidebarTabs .tabUnselected:hover,\n#sidebarTabs .tabContents  {\n background-color: #666;\n}\n\n.listTitle{color: #FFF;}\n#sidebarTabs .tabContents a{\n color: #ffbf00;\n}\n\n#sidebarTabs .tabContents a:hover{\n color: #ff7f00;\n background: transparent;\n}\n\n#sidebarTabs .txtMoreTab .tabSelected,\n#sidebarTabs .txtMoreTab .tab:hover,\n#sidebarTabs .txtMoreTab .tabContents{\n color: #ffbf00;\n background: #4c4c4c;\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected {\n color: #ffbf00;\n background: #5f5f5f;\n}\n\n.tab.tabSelected, .tab.tabSelected:hover{color: #ffbf00; border: 0; background-color: #4c4c4c;cursor:default;}\n.tab.tabUnselected {background-color: #666;}\n.tab.tabUnselected:hover{color:#ffbf00; border: 0;background-color: #4c4c4c;}\n.tabContents {\n background-color: #4c4c4c;\n border: 0;\n}\n.tabContents .tabContents{background: #666;}\n.tabContents .tabSelected{background: #666;}\n.tabContents .tabUnselected{background: #5f5f5f;}\n.tabContents .tab:hover{background: #666;}\n/*}}}*/\n/***\n!Message area styles /% ============================================================= %/\n***/\n/*{{{*/\n#messageArea {background-color: #666; color: #fff; border: 2px solid #ffbf00;}\n#messageArea a:link, #messageArea a:visited {color: #ffbf00; text-decoration:none;}\n#messageArea a:hover {color: #ff7f00;}\n#messageArea a:active {color: #ff7f00;}\n#messageArea .messageToolbar a{\n border: 1px solid #ffbf00;\n background: #4c4c4c;\n}\n/*}}}*/\n/***\n!Popup styles /% ============================================================= %/\n***/\n/*{{{*/\n#popup {color: #fff; background-color: #4c4c4c; border: 1px solid #ffbf00;}\n#popup a {color: #ffbf00; }\n#popup a:hover { background: transparent; color: #ff7f00; border: 0;}\n#popup hr {color: #ffbf00; background: #ffbf00;}\n/*}}}*/\n/***\n!Tiddler Display styles /% ============================================================= %/\n***/\n/*{{{*/\n.title{color: #fff;}\nh1, h2, h3, h4, h5 {\n color: #fff;\n background-color: transparent;\n border-bottom: 1px solid #333;\n}\n\n.subtitle{\n color: #666;\n}\n\n.viewer {color: #fff; }\n\n.viewer table{background: #666; color: #fff;}\n\n.viewer th {background-color: #996; color: #fff;}\n\n.viewer pre, .viewer code {color: #ddd; background-color: #4c4c4c; border: 1px solid #ffbf00;}\n\n.viewer hr {color: #666;}\n\n.tiddler .button {color: #4c4c4c;}\n.tiddler .button:hover { color: #ffbf00;  background-color: #4c4c4c;}\n.tiddler .button:active {color: #ffbf00; background-color: #4c4c4c;}\n\n.toolbar {\n color: #4c4c4c;\n}\n\n.toolbar a.button,\n.editorFooter a{\n border: 0;\n}\n\n.footer {\n color: #ddd;\n}\n\n.selectedTiddler .footer {\n color: #888;\n}\n\n.highlight, .marked {\n color: #000;\n background-color: #ffe72f;\n}\n.editorFooter {\n color: #aaa;\n}\n\n.tab{\n-moz-border-radius-topleft: 3px;\n-moz-border-radius-topright: 3px;\n}\n\n.tagging,\n.tagged{\n background: #4c4c4c;\n border: 1px solid #4c4c4c; \n}\n\n.selected .tagging,\n.selected .tagged{\n background: #000;\n border: 1px solid #ffbf00;\n}\n\n.tagging .listTitle,\n.tagged .listTitle{\n  color: #fff;\n}\n\n.tagging .button,\n.tagged .button{\n color: #ffbf00;\n border: 0;\n padding: 0;\n}\n\n.tagging .button:hover,\n.tagged .button:hover{\nbackground: transparent;\n}\n/*}}}*//***\n!Devfire\nStyle by Clint Checketts (http://www.checkettsweb.com) for TiddlyWiki 2.0\nInspired by the GLP'd Darkfire Wordpress skin.\n\n!Sections in this Tiddler:\n*Generic rules\n*Links styles\n*Header\n*Main menu\n*Sidebar\n**Sidebar options\n**Sidebar tabs\n*Message area\n*Popup\n*Tabs\n*Tiddler display\n**Viewer\n**Editor\n*Misc. rules\n!Generic rules /% ============================================================= %/\n***/\n/*{{{*/\nbody {\nbackground-color: #000;\n}\n/*}}}*/\n/***\n!Link styles /% ============================================================= %/\n***/\n/*{{{*/\na,\na.button,\n#mainMenu a.button,\n#sidebarOptions .sliderPanel a{\n color: #ffbf00;\n border: 0;\n}\n\na:hover,\na.button:hover,\n#mainMenu a.button:hover,\n#sidebarOptions .sliderPanel a:hover\n#sidebarOptions .sliderPanel a:active{\n color: #ff7f00;\n border: 0;\n border-bottom: #ff7f00 1px dashed;\n background: transparent;\n text-decoration: none;\n}\n\n#displayArea .button.highlight{\n color: #ffbf00;\n background: #4c4c4c;\n}\n/*}}}*/\n/***\n!Header styles /% ============================================================= %/\n***/\n/*{{{*/\n.header{\n border-bottom: 2px solid #ffbf00;\n color: #fff;\n}\n\n.headerForeground a {\n color: #fff;\n}\n\n.header a:hover {\n border-bottom: 1px dashed #fff;\n}\n/*}}}*/\n/***\n!Main menu styles /% ============================================================= %/\n***/\n/*{{{*/\n#mainMenu {color: #fff;}\n#mainMenu h1{\n font-size: 1.1em;\n}\n#mainMenu li,#mainMenu ul{\n	list-style: none;\n	margin: 0;\n	padding: 0;\n}\n/*}}}*/\n/***\n!Sidebar styles /% ============================================================= %/\n***/\n/*{{{*/\n#sidebar {\n right: 0;\n color: #fff;\n border: 2px solid #ffbf00;\n border-width: 0 0 2px 2px;\n}\n#sidebarOptions {\n background-color: #4c4c4c;\n padding: 0;\n}\n\n#sidebarOptions a{\n margin: 0;\n color: #ffbf00;\n border: 0;\n}\n#sidebarOptions a:hover {\n color: #4c4c4c;\n background-color: #ffbf00;\n\n}\n\n#sidebarOptions a:active {\n color: #ffbf00;\n background-color: transparent;\n}\n\n#sidebarOptions .sliderPanel {\n background-color: #333;\n margin: 0;\n}\n\n#sidebarTabs {background-color: #4c4c4c;}\n#sidebarTabs .tabSelected {\n padding: 3px 3px;\n cursor: default;\n color: #ffbf00;\n background-color: #666;\n}\n#sidebarTabs .tabUnselected {\n color: #ffbf00;\n background-color: #5f5f5f;\n padding: 0 4px;\n}\n\n#sidebarTabs .tabUnselected:hover,\n#sidebarTabs .tabContents  {\n background-color: #666;\n}\n\n.listTitle{color: #FFF;}\n#sidebarTabs .tabContents a{\n color: #ffbf00;\n}\n\n#sidebarTabs .tabContents a:hover{\n color: #ff7f00;\n background: transparent;\n}\n\n#sidebarTabs .txtMoreTab .tabSelected,\n#sidebarTabs .txtMoreTab .tab:hover,\n#sidebarTabs .txtMoreTab .tabContents{\n color: #ffbf00;\n background: #4c4c4c;\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected {\n color: #ffbf00;\n background: #5f5f5f;\n}\n\n.tab.tabSelected, .tab.tabSelected:hover{color: #ffbf00; border: 0; background-color: #4c4c4c;cursor:default;}\n.tab.tabUnselected {background-color: #666;}\n.tab.tabUnselected:hover{color:#ffbf00; border: 0;background-color: #4c4c4c;}\n.tabContents {\n background-color: #4c4c4c;\n border: 0;\n}\n.tabContents .tabContents{background: #666;}\n.tabContents .tabSelected{background: #666;}\n.tabContents .tabUnselected{background: #5f5f5f;}\n.tabContents .tab:hover{background: #666;}\n/*}}}*/\n/***\n!Message area styles /% ============================================================= %/\n***/\n/*{{{*/\n#messageArea {background-color: #666; color: #fff; border: 2px solid #ffbf00;}\n#messageArea a:link, #messageArea a:visited {color: #ffbf00; text-decoration:none;}\n#messageArea a:hover {color: #ff7f00;}\n#messageArea a:active {color: #ff7f00;}\n#messageArea .messageToolbar a{\n border: 1px solid #ffbf00;\n background: #4c4c4c;\n}\n/*}}}*/\n/***\n!Popup styles /% ============================================================= %/\n***/\n/*{{{*/\n#popup {color: #fff; background-color: #4c4c4c; border: 1px solid #ffbf00;}\n#popup li.disabled{color: #ffbf00;}\n\n#popup a {color: #ffbf00; }\n#popup a:hover { background: transparent; color: #ff7f00; border: 0;}\n#popup hr {color: #ffbf00; background: #ffbf00;}\n/*}}}*/\n/***\n!Tiddler Display styles /% ============================================================= %/\n***/\n/*{{{*/\n.title{color: #fff;}\nh1, h2, h3, h4, h5 {\n color: #fff;\n background-color: transparent;\n border-bottom: 1px solid #333;\n}\n\n.subtitle{\n color: #666;\n}\n\n.viewer {color: #fff; }\n\n.viewer table{background: #666; color: #fff;}\n\n.viewer th {background-color: #996; color: #fff;}\n\n.viewer pre, .viewer code {color: #ddd; background-color: #4c4c4c; border: 1px solid #ffbf00}\n\n.viewer hr {color: #666;}\n\n.tiddler .button {color: #4c4c4c;}\n.tiddler .button:hover { color: #ffbf00;  background-color: #4c4c4c;}\n.tiddler .button:active {color: #ffbf00; background-color: #4c4c4c;}\n\n.toolbar {\n color: #4c4c4c;\n}\n\n.toolbar a.button,\n.editorFooter a{\n border: 0;\n}\n\n.footer {\n color: #ddd;\n}\n\n.selectedTiddler .footer {\n color: #888;\n}\n\n.highlight, .marked {\n color: #000;\n background-color: #ffe72f;\n}\n.editorFooter {\n color: #aaa;\n}\n\n.tab{\n-moz-border-radius-topleft: 3px;\n-moz-border-radius-topright: 3px;\n}\n\n.tagging,\n.tagged{\n background: #4c4c4c;\n border: 1px solid #4c4c4c; \n}\n\n.selected .tagging,\n.selected .tagged{\n background: #000;\n border: 1px solid #ffbf00;\n}\n\n.tagging .listTitle,\n.tagged .listTitle{\n  color: #fff;\n}\n\n.tagging .button,\n.tagged .button{\n color: #ffbf00;\n border: 0;\n padding: 0;\n}\n\n.tagging .button:hover,\n.tagged .button:hover{\nbackground: transparent;\n}\n\n.cascade {\n	background: #4c4c4c;\n	color: #ddd;\n	border: 1px solid #ffbf00;\n}\n/*}}}*/&quot;;

config.shadowTiddlers.DevFirePageTemplate = &quot;&lt;div class='header' macro='gradient vert #390108 #900'&gt;\n&lt;div class='headerShadow'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div class='headerForeground'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;&quot;;

config.themes.push(&quot;DevFire&quot;);


config.shadowTiddlers.ClassicBrownStyleSheet = &quot;[[TagglyTaggingStyles]]\n\n/***\n!TiddlyWiki Classic Color Scheme\nDesigned by Jeremy Ruston\n\nTo use this color scheme copy the [[ClassicTiddlyWiki]] contents into a tiddler and name it 'StyleSheet' also grab the [[ClassicTemplate]] and copy its contents into a tiddler named 'PageTemplate'.\n\n!Colors Used\n*@@bgcolor(#630):color(#fff): #630@@\n*@@bgcolor(#930): #930@@\n*@@bgcolor(#996633): #963@@\n*@@bgcolor(#c90): #c90@@\n*@@bgcolor(#cf6): #cf6@@\n*@@bgcolor(#cc9): #cc9@@\n*@@bgcolor(#ba9): #ba9@@\n*@@bgcolor(#996): #996@@\n*@@bgcolor(#300):color(#fff): #300@@\n*@@bgcolor(#000000):color(#fff): #000@@\n*@@bgcolor(#666): #666@@\n*@@bgcolor(#888): #888@@\n*@@bgcolor(#aaa): #aaa@@\n*@@bgcolor(#ddd): #ddd@@\n*@@bgcolor(#eee): #eee@@\n*@@bgcolor(#ffffff): #fff@@\n*@@bgcolor(#f00): #f00@@\n*@@bgcolor(#ff3): #ff3@@\n!Generic Rules /%==============================================%/\n***/\n/*{{{*/\nbody {\n background: #fff;\n color: #000;\n}\n\na{\n color: #963;\n}\n\na:hover{\n background: #963;\n color: #fff;\n}\n\na img{\n border: 0;\n}\n\nh1,h2,h3,h4,h5 {\n background: #cc9;\n}\n/*}}}*/\n/***\n!Header /%==================================================%/\n***/\n/*{{{*/\n.header{\n background: #300;\n}\n\n.titleLine {\n color: #fff;\n padding: 5em 0em 1em .5em;\n}\n\n.titleLine a {\n color: #cf6;\n}\n\n.titleLine a:hover {\n background: transparent;\n}\n/*}}}*/\n/***\n!Main Menu /%=================================================%/\n***/\n/*{{{*/\n#mainMenu .button {\n color: #930;\n}\n\n#mainMenu .button:hover {\n color: #cf6;\n background: #930;\n}\n\n#mainMenu li{\n list-style: none;\n}\n/*}}}*/\n/***\n!Sidebar options /%=================================================%/\n~TiddlyLinks and buttons are treated identically in the sidebar and slider panel\n***/\n/*{{{*/\n#sidebar {\n background: #c90;\n right: 0;\n}\n\n#sidebarOptions a{\n color: #930;\n border: 0;\n margin: 0;\n padding: .25em .5em;\n}\n\n#sidebarOptions a:hover {\n color: #cf6;\n background: #930;\n}\n\n#sidebarOptions a:active {\n color: #930;\n background: #cf6;\n}\n\n#sidebarOptions .sliderPanel {\n background: #eea;\n margin: 0;\n}\n\n#sidebarOptions .sliderPanel a {\n color: #930;\n}\n\n#sidebarOptions .sliderPanel a:hover {\n color: #cf6;\n background: #930;\n}\n\n#sidebarOptions .sliderPanel a:active {\n color: #930;\n background: #cf6;\n}\n/*}}}*/\n/***\n!Sidebar tabs /%=================================================%/\n***/\n/*{{{*/\n.tabSelected,.tabContents {\n background: #eea;\n border: 0;\n}\n\n.tabUnselected {\n background: #c90;\n}\n\n#sidebarTabs {\n background: #c90;\n}\n\n#sidebarTabs .tabSelected{\n color: #cf6;\n background: #963;\n}\n\n#sidebarTabs .tabUnselected {\n color: #cf6;\n background: #930;\n}\n\n#sidebarTabs .tabContents{\n background: #963;\n}\n\n#sidebarTabs .txtMoreTab .tabSelected,\n#sidebarTabs .txtMoreTab .tabSelected:hover{\n background: #930;\n color: #cf6;\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected,\n#sidebarTabs .txtMoreTab .tabUnselected:hover{\n background: #300;\n color: #cf6;\n}\n\n#sidebarTabs .txtMoreTab .tabContents {\n background: #930;\n}\n\n#sidebarTabs .tabContents a {\n color: #cf6;\n border: 0;\n}\n\n#sidebarTabs .button.highlight,\n#sidebarTabs .tabContents a:hover {\n background: #cf6;\n color: #300;\n}\n/*}}}*/\n/***\n!Message Area /%=================================================%/\n***/\n/*{{{*/\n#messageArea {\n background: #930;\n color: #fff;\n}\n\n#messageArea a:link, #messageArea a:visited {\n color: #c90;\n}\n\n#messageArea a:hover {\n color: #963;\n background: transparent;\n}\n\n#messageArea a:active {\n color: #fff;\n}\n/*}}}*/\n/***\n!Popup /%=================================================%/\n***/\n/*{{{*/\n.popup {\n background: #eea;\n border: 1px solid #930;\n}\n\n.popup hr {\n color: #963;\n background: #963;\n border-bottom: 1px;\n}\n\n.popup li.disabled {\n color: #ba9;\n}\n\n.popup li a, .popup li a:visited {\n color: #300;\n}\n\n.popup li a:hover {\n background: #930;\n color: #eea;\n}\n/*}}}*/\n/***\n!Tiddler Display /%=================================================%/\n***/\n/*{{{*/\n.tiddler .button {\n color: #930;\n}\n\n.tiddler .button:hover {\n color: #cf6;\n background: #930;\n}\n\n.tiddler .button:active {\n color: #fff;\n background: #c90;\n}\n\n.shadow .title {\n color: #888;\n}\n\n.title {\n color: #422;\n}\n\n.subtitle {\n color: #866;\n}\n\n.toolbar {\n color: #aaa;\n}\n\n.toolbar a,\n.toolbar a:hover{\n border: 0;\n}\n\n.tagging, .tagged {\n border: 1px solid #fff;\n background-color: #ffc;\n}\n\n.selected .tagging, .selected .tagged {\n border: 1px solid #aa6;\n background-color: #ffc;\n}\n\n.tagging .listTitle, .tagged .listTitle {\ncolor: #999999;\n}\n\n.footer {\n color: #ddd;\n}\n\n.selected .footer {\n color: #888;\n}\n\n.sparkline {\n background: #eea;\n border: 0;\n}\n\n.sparktick {\n background: #930;\n}\n\n.errorButton {\n color: #ff0;\n background: #f00;\n}\n\n.zoomer {\n color: #963;\n border: 1px solid #963;\n}\n/*}}}*/\n/***\n''The viewer is where the tiddler content is displayed'' /%------------------------------------------------%/\n***/\n/*{{{*/\n.viewer .button {\n background: #c90;\n color: #300;\n border-right: 1px solid #300;\n border-bottom: 1px solid #300;\n}\n\n.viewer .button:hover {\n background: #eea;\n color: #c90;\n}\n\n.viewer .imageLink{\n background: transparent;\n}\n\n.viewer blockquote {\n border-left: 3px solid #666;\n}\n\n.viewer table {\n border: 2px solid #303030;\n}\n\n.viewer th, thead td {\n background: #996;\n border: 1px solid #606060;\n color: #fff;\n}\n\n.viewer td, .viewer tr {\n border: 1px solid #606060;\n}\n\n.viewer pre {\n border: 1px solid #963;\n background: #eea;\n}\n\n.viewer code {\n color: #630;\n}\n\n.viewer hr {\n border: 0;\n border-top: dashed 1px #606060;\n color: #666;\n}\n\n.highlight, .marked {\n background: #ff3;\n}\n/*}}}*/\n/***\n''The editor replaces the viewer in the tiddler'' /%------------------------------------------------%/\n***/\n/*{{{*/\n.editor input {\n border: 1px solid #000;\n}\n\n.editor textarea {\n border: 1px solid #000;\n width: 100%;\n}\n\n.editorFooter {\n color: #aaa;\n}\n\n.editorFooter a {\n color: #930;\n}\n\n.editorFooter a:hover {\n color: #cf6;\n background: #930;\n}\n\n.editorFooter a:active {\n color: #fff;\n background: #c90;\n}\n/*}}}*/&quot;;

config.shadowTiddlers.ClassicBrownPageTemplate = &quot;&lt;div class='header'&gt;\n&lt;div class='titleLine'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div macro='gradient vert #ffffff #cc9900'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;&quot;;

config.themes.push(&quot;ClassicBrown&quot;);
//}}}
/***
!~MonkeyPirateTiddlyWiki Themes
Created by Simon Baird from http://simonbaird.com/mptw/
***/
//{{{

// couple of extra bits
config.shadowTiddlers.HorizontalMainMenuStyles = &quot;/***\nTo use, add {{{[[HorizontalMainMenuStyles]]}}} to your StyleSheet tiddler, or you can just paste the CSS in directly. See also HorizontalMainMenu and PageTemplate.\n***/\n/*{{{*/\n\n#topMenu br {display:none; }\n#topMenu { background: #39a; }\n#topMenu { padding:2px; }\n#topMenu .button, #topMenu .tiddlyLink {\n margin-left:0.5em; margin-right:0.5em;\n padding-left:3px; padding-right:3px;\n color:white; font-size:115%;\n}\n#topMenu .button:hover, #topMenu .tiddlyLink:hover { background:#178;}\n\n#displayArea { margin: 1em 15.7em 0em 1em; } /* so we use the freed up space */\n\n/* just in case want some QuickOpenTags in your topMenu */\n#topMenu .quickopentag { padding:0px; margin:0px; border:0px; }\n#topMenu .quickopentag .tiddlyLink { padding-right:1px; margin-right:0px; }\n#topMenu .quickopentag .button { padding-left:1px; margin-left:0px; border:0px; }\n\n\n/*}}}*/&quot;;

config.shadowTiddlers.SideBarWhiteAndGrey = &quot;/***\nThis CSS by DaveBirss.\n***/\n/*{{{*/\n\n.tabSelected {\n background: #fff;\n}\n\n.tabUnselected {\n background: #eee;\n}\n\n#sidebar {\n color: #000;\n background: transparent; \n}\n\n#sidebarOptions {\n background: #fff;\n}\n\n#sidebarOptions .button {\n color: #999;\n}\n\n#sidebarOptions .button:hover {\n color: #000;\n background: #fff;\n border-color:white;\n}\n\n#sidebarOptions .button:active {\n color: #000;\n background: #fff;\n}\n\n#sidebarOptions .sliderPanel {\n background: transparent;\n}\n\n#sidebarOptions .sliderPanel A {\n color: #999;\n}\n\n#sidebarOptions .sliderPanel A:hover {\n color: #000;\n background: #fff;\n}\n\n#sidebarOptions .sliderPanel A:active {\n color: #000;\n background: #fff;\n}\n\n.sidebarSubHeading {\n color: #000;\n}\n\n#sidebarTabs {`\n background: #fff\n}\n\n#sidebarTabs .tabSelected {\n color: #000;\n background: #fff;\n border-top: solid 1px #ccc;\n border-left: solid 1px #ccc;\n border-right: solid 1px #ccc;\n border-bottom: none;\n}\n\n#sidebarTabs .tabUnselected {\n color: #999;\n background: #eee;\n border-top: solid 1px #ccc;\n border-left: solid 1px #ccc;\n border-right: solid 1px #ccc;\n border-bottom: none;\n}\n\n#sidebarTabs .tabContents {\n background: #fff;\n}\n\n\n#sidebarTabs .txtMoreTab .tabSelected {\n background: #fff;\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected {\n background: #eee;\n}\n\n#sidebarTabs .txtMoreTab .tabContents {\n background: #fff;\n}\n\n#sidebarTabs .tabContents .tiddlyLink {\n color: #999;\n}\n\n#sidebarTabs .tabContents .tiddlyLink:hover {\n background: #fff;\n color: #000;\n}\n\n#sidebarTabs .tabContents {\n color: #000;\n}\n\n#sidebarTabs .button {\n color: #666;\n}\n\n#sidebarTabs .tabContents .button:hover {\n color: #000;\n background: #fff;\n}\n\n\n/*}}}*/&quot;;


config.shadowTiddlers.MPTWStyleSheet = &quot;/***\nCosmetic fixes that probably should be included in a future TW...\n***/\n/*{{{*/\n.viewer .listTitle { list-style-type:none; margin-left:-2em; }\n.editorFooter .button { padding-top: 0px; padding-bottom:0px; }\n/*}}}*/\n/***\nImportant stuff. See TagglyTaggingStyles and HorizontalMainMenuStyles\n***/\n/*{{{*/\n[[TagglyTaggingStyles]]\n[[HorizontalMainMenuStyles]]\n/*}}}*/\n/***\nClint's fix for weird IE behaviours\n***/\n/*{{{*/\nbody {position:static;}\n.tagClear{margin-top:1em;clear:both;}\n/*}}}*/\n/***\nJust colours, fonts, tweaks etc. See SideBarWhiteAndGrey\n***/\n/*{{{*/\nbody {background:#eee; /* font-size:103%; */}\na{ color: #069; }\na:hover{ background: #069; color: #fff; }\n.popup { background: #178; border: 1px solid #069; }\n.headerForeground a { color: #6fc;}\n.headerShadow { left: 2px; top: 2px; }\n.title { padding:0px; margin:0px; }\n.siteSubtitle { padding:0px; margin:0px; padding-left:1.5em; }\n.subtitle { font-size:90%; color:#ccc; padding-left:0.25em; }\nh1,h2,h3,h4,h5 { color: #000; background: transparent; }\n.title {color:black; font-size:2em;}\n.shadow .title {color:#999; }\n.viewer pre { background-color:#f8f8ff; border-color:#ddf; }\n.viewer { padding-top:0px; }\n.editor textarea { font-family:monospace; }\n#sidebarOptions { border:1px #ccc solid; }\n.tiddler {\n border-bottom:1px solid #ccc; border-right:1px solid #ccc; padding-bottom:1em; margin-bottom:1em; \n background:#fff; padding-right:1.5em; }\n#messageArea { background-color:#bde; border-color:#8ab; border-width:4px; border-style:dotted; font-size:90%; }\n#messageArea .button { text-decoration:none; font-weight:bold; background:transparent; border:0px; }\n#messageArea .button:hover {background: #acd; }\n[[SideBarWhiteAndGrey]]\n\n.viewer td {vertical-align:top;}\n\n.viewer table.noBorder {border-style:none;}\n.viewer table.noBorder td {border-style:none;}\n.viewer table.threeCol td {width:33%;}\n\n#adsense {\n margin: 1em 15.7em 0em 1em; border:1px solid #ddd;\n background:#f8f8f8; text-align:center;margin-bottom:1em;overflow:hidden;padding:0.5em;} \n\n.sliderPanel { margin-left: 2em; }\n\n.viewer th { background:#ddd; color:black; }\n/*}}}*/\n/*{{{*/\n/* for testing clint's new formatter. eg {{red{asdfaf}}} */\n.red { color:white; background:red; display:block; padding:1em; } \n\n/* FF doesn't need this. but IE seems to want to make first one white */\n.txtMainTab .tabset { background:#eee; }\n.txtMoreTab .tabset { background:transparent; }\n\n.faq ol li { padding-top:1em; font-size:120%; }\n.faq ol ul li { padding-top:0px; font-size:100%; }\n\n/*}}}*/\n&quot;;

config.shadowTiddlers.MPTWPageTemplate = &quot;&lt;!---\nI've just tweaked my gradient colours and the topMenu bit. See HorizontalMainMenu.\n---&gt;\n&lt;!--{{{--&gt;\n&lt;div class='header' macro='gradient vert #000 #069'&gt;\n&lt;div class='headerShadow'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div class='headerForeground'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;\n&quot;;

config.themes.push(&quot;MPTW&quot;);


config.shadowTiddlers.MPTWCurvesStyleSheet = &quot;/*{{{*/\n[[MPTWStyleSheet]]\n.tiddler { -moz-border-radius: 2em;}\n.button { -moz-border-radius: 1em;}\n#sidebarOptions { -moz-border-radius: 0 0 1em 1em;}\n.tab { -moz-border-radius: 1em 1em 0 0;}\n.tabContents { -moz-border-radius: 1em 1em 0 0;}\n/*}}}*/&quot;;

config.shadowTiddlers.MPTWCurvesPageTemplate = config.shadowTiddlers.MPTWPageTemplate;

config.themes.push(&quot;MPTWCurves&quot;);

//}}}
/***
!~GTDd3
Created by Tomo (Tom Otvos) from http://www.dcubed.ca
(Based on the original GTD theme by Nathan Bowers at http://snapgrid.com)
***/
//{{{
config.shadowTiddlers.GTDd3PageTemplate = &quot;&lt;div class='header'&gt;\n&lt;div class='headerShadow'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div class='headerForeground'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu' force='true'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;&quot;;

config.shadowTiddlers.GTDd3StyleSheet = &quot;/***\n!GTD specific styles\n***/\n\n/*{{{*/\n\n/* the tagging popup really gets in the way so push it off to the side */\n.tagging { float: right; }\n\n/* this unbullets actions in the actionList macro */\nul.gtdActionList { list-style-type: none; }\nli.gtdActionListProject, li.gtdActionListContext { margin-top: 1.0em; }\n\n.gtdCompletedActionItem { text-decoration: line-through; }\n.gtdNextActionItem { border-bottom: 1px solid red; }\n\n/*}}}*/\n\n/***\n!Imported 3x5 printing styles\n//adapted from the work of Clint Checketts, http://www.checkettsweb.com/tw/gtd_tiddlywiki.htm //\n***/\n\n/*{{{*/\n\n@media print {\n#mainMenu, #sidebar, #messageArea {display: none !important;}\n#displayArea {margin: 1em 1em 0em 1em;}\n\n\n/* LAYOUT ELEMENTS ========================================================== */\n*\n{\n margin: 0;\n padding: 0;\n}\n\n#contentWrapper\n{\n margin: 0;\n width: 100%;\n position: static;\n}\n\nbody {\n background: #fff;\n color: #000;\n font-size: 6.2pt;\n font-family: \&quot;Lucida Grande\&quot;, \&quot;Bitstream Vera Sans\&quot;, Helvetica, Verdana, Arial, sans-serif;\n}\n\nimg {\n max-width: 2.2in;\n max-height: 4.3in;\n}\n\n#header, #side_container, #storeArea, #copyright, #floater, #messageArea, .save_accesskey, .site_description, #saveTest, .toolbar, .header, .footer, .tagging, .tagged\n{\n display: none;\n}\n\n#tiddlerDisplay, #displayArea\n{\n display: inline;\n}\n\n.tiddler {\n margin: 0 0 2em 0;\n border-top: 1px solid #000;\n page-break-before: always;\n}\n\n.tiddler:first-child {\n page-break-before: ;\n}\n\n.title {\n font-size: 1.6em;\n font-weight: bold;\n margin-bottom: .3em;\n padding: .2em 0;\n border-bottom: 1px dotted #000;\n}\n\np, blockquote, ul, li, ol, dt, dd, dl, table\n{\n margin: 0 0 .3em 0;\n}\n\nh1, h2, h3, h4, h5, h6\n{\n margin: .2em 0;\n} \n\nh1\n{\n font-size: 1.5em;\n}\n\nh2\n{\n font-size: 1.3em;\n}\n\nh3\n{\n font-size: 1.25em;\n}\n\nh4\n{\n font-size: 1.15em;\n}\n\nh5\n{\n font-size: 1.1em;\n}\n\nblockquote\n{\n margin: .6em;\n padding-left: .6em;\n border-left: 1px solid #ccc;\n}\n\nul\n{\n list-style-type: circle;\n}\n\nli\n{\n margin: .1em 0 .1em 2em;\n line-height: 1.4em; \n}\n\ntable\n{\n border-collapse: collapse;\n font-size: 1em;\n}\n\ntd, th\n{\n border: 1px solid #999;\n padding: .2em;\n}\n\nhr {\n border: none;\n border-top: dotted 1px #777;\n height: 1px;\n color: #777;\n margin: .6em 0;\n}\n}\n/*}}}*/\n\n/***\n!Imported styles for calendar plugin\n***/\n\n/*{{{*/\n.calendar{\n border-bottom: 1px solid #550000;\n}\n\n.viewer .calendar{\n width: 220px;\n}\n\n#mainMenu .calendar{\n font-size: 8px;\n cursor: pointer;\n width: 100%;\n border: 0;\n border-collapse: collapse;\n}\n\n#mainMenu .calendar .button{\n border: 0;\n}\n\n#mainMenu .calendar td{\n font-size: 8pt;\n padding: 0;\n background: #fff;\n border: 0;\n}\n\n#mainMenu .calendar a{\n margin: 0;\n color: #000;\n background: transparent;\n}\n\n#mainMenu .calendar a:hover{\n color: #000;\n background: transparent;\n}\n\n#mainMenu .calendarMonthname,\n#mainMenu .calendar .calendarMonthTitle td a{\n color: #fff;\n}\n\n#mainMenu .calendarDaysOfWeek td{\n background: #500;\n color: #fff;\n}\n/*}}}*/\n\n\n/***\n!Layout Rules /%==============================================%/\n***/\n/*{{{*/\n\nbody { position: static; }\n\n.headerForeground, .headerShadow {\n padding-top: 1em;\n}\n\n.tiddler {\n margin: 0 0 0.9em 0;\n padding-bottom: 1em;\n}\n\n#mainMenu {\n width: 16em;\n font-size: 1em;\n text-align: left;\n}\n\n#mainMenu * {\n font-size: 1em;\n font-weight: normal;\n padding: 0; margin: 0; border: 0;\n}\n\n#mainMenu ul {\n list-style: none;\n margin-bottom: 10px;\n}\n\n#mainMenu li {\n text-indent: 1em;\n}\n\n#mainMenu a.button, #mainMenu a.tiddlyLink, #mainMenu a.externalLink {\n display: block; margin: 0;\n}\n\n#displayArea {\n margin-left: 19em;\n}\n\n/*}}}*/\n\n/***\n!Colors Used\n*@@bgcolor(#8cf): #8cf - Background blue@@\n*@@bgcolor(#18f): #18f - Top blue@@\n*@@bgcolor(#04b): #04b - Mid blue@@\n*@@bgcolor(#014):color(#fff): #014 - Bottom blue@@\n*@@bgcolor(#ffc): #ffc - Bright yellow@@\n*@@bgcolor(#fe8): #fe8 - Highlight yellow@@\n*@@bgcolor(#db4): #db4 - Background yellow@@\n*@@bgcolor(#841): #841 - Border yellow@@\n*@@bgcolor(#703):color(#fff): #703 - Title red@@\n*@@bgcolor(#866): #866 - Subtitle grey@@\n!Generic Rules /%==============================================%/\n***/\n/*{{{*/\nbody {\n background: #464646;\n color: #000;\n}\n\na{\n color: #04b;\n}\n\na:hover{\n background: #04b;\n color: #fff;\n}\n\na img{\n border: 0;\n}\n\nh1,h2,h3,h4,h5 {\n color: #000;\n background: #eee;\n}\n\n.button {\n color: #014;\n border: 1px solid #fff;\n}\n\n.button:hover {\n color: #014;\n background: #fe8;\n border-color: #db4;\n}\n\n.button:active {\n color: #fff;\n background: #db4;\n border: 1px solid #841;\n}\n\n/*}}}*/\n/***\n!Header /%==================================================%/\n***/\n/*{{{*/\n.header {\n background: #000;\n}\n\n.headerShadow {\n color: #000;\n}\n\n.headerShadow a {\n font-weight: normal;\n color: #000;\n}\n\n.headerForeground {\n color: #cf6;\n}\n\n.headerForeground a {\n font-weight: normal;\n color: #cf6;\n}\n\n/* ??? what is up when you specify a site title colour in IE ??? */\n/* .siteTitle { color: red; } */\n\n/*}}}*/\n/***\n!General tabs /%=================================================%/\n***/\n/*{{{*/\n\n.tabSelected {\n color: #fff;\n background: #960;\n border: none;\n}\n\n.tabUnselected {\n color: #fff;\n background: #660;\n}\n\n.tabContents {\n color: #004;\n background: #960;\n border: none;\n}\n\n.tabContents .button, .tabContents a {\n border: none;\n color: #fff;\n}\n\n.tabContents a:hover, .tabset a:hover {\n background: #000;\n}\n\n/* make nested tab areas look different */\n.tabContents .tabSelected, .tabContents .tabContents {\n background: #700;\n color: #fff;\n}\n\n.tabContents .tabContents {\n color: #eeb;\n}\n\n/*}}}*/\n/***\n!Main Menu /%=================================================%/\n***/\n/*{{{*/\n#mainMenu {\n background: #700;\n color: #fff;\n border-right: 3px solid #500;\n}\n\n#mainMenu * {\n color: #fff;\n}\n\n#mainMenu a.button, #mainMenu a.tiddlyLink, #mainMenu a.externalLink {\n border: none;\n border-bottom: 1px solid #500;\n border-top: 1px solid #900;\n}\n\n#mainMenu a:hover,\n#mainMenu a.button:hover {\n background-color: #b00;\n color: #fff;\n}\n\n/*}}}*/\n/***\n!Sidebar options /%=================================================%/\n~TiddlyLinks and buttons are treated identically in the sidebar and slider panel\n***/\n/*{{{*/\n#sidebar {\n color: #000;\n background: #eeb;\n border-right: 3px solid #bb8;\n border-bottom: 3px solid #520;\n}\n\n#sidebarOptions input {\n border: 1px solid #04b;\n}\n\n#sidebarOptions .sliderPanel {\n background: #fff;\n}\n\n#sidebarOptions .sliderPanel a {\n border: none;\n color: #700;\n}\n\n#sidebarOptions .sliderPanel a:hover {\n color: #fff;\n background: #700;\n}\n\n#sidebarOptions .sliderPanel a:active {\n color: #700;\n background: #fff;\n}\n\n#sidebarOptions a {\n color: #700;\n border: none;\n}\n\n#sidebarOptions a:hover, #sidebarOptions a:active {\n color: #fff;\n background: #700;\n}\n\n/*}}}*/\n/***\n!Message Area /%=================================================%/\n***/\n/*{{{*/\n#messageArea {\n border-right: 3px solid #da1;\n border-bottom: 3px solid #a80;\n background: #ffe72f;\n color: #014;\n}\n\n#messageArea .button {\n padding: 0.2em 0.2em 0.2em 0.2em;\n color: #014;\n background: #fff;\n}\n\n/*}}}*/\n/***\n!Popup /%=================================================%/\n***/\n/*{{{*/\n.popup {\n background: #333;\n border: none;\n}\n\n.popup hr {\n color: #000;\n}\n\n.popup li.disabled {\n color: #666;\n background: #cf6;\n}\n\n.popup li a, .popup li a:visited {\n color: #000;\n border: 1px outset #cf6;\n background: #cf6;\n}\n\n.popup li a:hover {\n color: #000;\n border: 1px outset #cf6;\n background: #ef9;\n}\n/*}}}*/\n/***\n!Tiddler Display /%=================================================%/\n***/\n/*{{{*/\n.tiddler {\n background: #fff;\n border-right: 3px solid #aaa;\n border-bottom: 3px solid #555;\n}\n\n.tiddler .defaultCommand {\n font-weight: bold;\n}\n\n.shadow .title {\n color: #866;\n}\n\n.title {\n color: #900;\n}\n\n.subtitle {\n color: #866;\n}\n\n.toolbar {\n color: #000;\n}\n\n.toolbar .button {\n background: #cf6;\n border: 1px outset #cf6;\n}\n\n.toolbar .button:hover {\n background: #ef9;\n}\n\n.tagging, .tagged {\n border: 1px solid #eee;\n background-color: #eee;\n}\n\n.selected .tagging, .selected .tagged {\n background-color: #ddd;\n border: 1px solid #bbb;\n}\n\n.tagging .listTitle, .tagged .listTitle {\n color: #014;\n}\n\n.tagging .button, .tagged .button {\n border: none;\n}\n\n.footer {\n color: #ddd;\n}\n\n.selected .footer {\n color: #888;\n}\n\n.sparkline {\n background: #8cf;\n border: 0;\n}\n\n.sparktick {\n background: #014;\n}\n\n.errorButton {\n color: #ff0;\n background: #f00;\n}\n\n.cascade {\n background: #eef;\n color: #aac;\n border: 1px solid #aac;\n}\n\n.imageLink, #displayArea .imageLink {\n background: transparent;\n}\n\n/*}}}*/\n/***\n''The viewer is where the tiddler content is displayed'' /%------------------------------------------------%/\n***/\n/*{{{*/\n\n.viewer .listTitle {list-style-type: none; margin-left: -2em;}\n\n.viewer .button {\n border: 1px solid #db4;\n}\n\n.viewer blockquote {\n border-left: 3px solid #666;\n}\n\n.viewer table {\n border: 2px solid #333;\n}\n\n.viewer th, thead td {\n background: #db4;\n border: 1px solid #666;\n color: #fff;\n}\n\n.viewer td, .viewer tr {\n border: 1px solid #666;\n}\n\n.viewer pre {\n border: 1px solid #fe8;\n background: #ffc;\n}\n\n.viewer code {\n color: #703;\n}\n\n.viewer hr {\n border: 0;\n border-top: dashed 1px #666;\n color: #666;\n}\n\n.highlight, .marked {\n background: #fe8;\n}\n/*}}}*/\n/***\n''The editor replaces the viewer in the tiddler'' /%------------------------------------------------%/\n***/\n/*{{{*/\n.editor input {\n border: 1px solid #04b;\n}\n\n.editor textarea {\n border: 1px solid #04b;\n width: 100%;\n}\n\n.editorFooter {\n color: #aaa;\n}\n\n/*}}}*/\n/***\n!Personal preferences\n***/\n\n/*{{{*/\n/* not required, but the menu looks a whole lot nicer flushed left */\n#mainMenu { text-align: left; }\n/* make input fields in viewer (options) show up in correct size */\n.viewer input { font-size: 0.9em; }\n/*}}}*/\n&quot;;

config.themes.push(&quot;GTDd3&quot;);


//}}}

</pre>
</div>
<div title="Blank" modifier="SimonBaird" created="200602161123" modified="200602161123" tags="TiddlerTemplates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161123">
<pre></pre>
</div>
<div title="Borrowed" modifier="SimonBaird" created="200601091045" modified="200601101251" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601101251">
<pre>Plugins used on this site that were created by other TiddlyWiki developers.</pre>
</div>
<div title="Buy" modifier="SimonBaird" created="200601101238" modified="200601121526" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601121526">
<pre>Shopping List. Print this out and take to shop.. See ShoppingListMaker</pre>
</div>
<div title="Character Charts (US)" modifier="PaulDickson" created="200601310845" modified="200601311135" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601311135">
<pre>These are some symbols that might be commonly use by US keyboard users.&amp;nbsp; These may be used by either copy-n-pasting the characters or their ampersand encodings.
|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;| !Character Encodings |
| &amp;amp;nbsp; | &amp;nbsp; | no-break space | &amp;nbsp;&amp;nbsp; | &amp;amp;apos; | &amp;apos; | single quote, apostrophe |
| &amp;amp;ndash; | &amp;ndash; | en dash |~| &amp;amp;quot; | &amp;quot; | quotation mark |
| &amp;amp;mdash; | &amp;mdash; | em dash |~| &amp;amp;prime; | &amp;prime; | prime; minutes; feet |
| &amp;amp;hellip; | &amp;hellip; | horizontal ellipsis |~| &amp;amp;Prime; | &amp;Prime; | double prime; seconds; inches |
| &amp;amp;copy; | &amp;copy; | Copyright symbol |~| &amp;amp;lsquo; | &amp;lsquo; | left single quote |
| &amp;amp;reg; | &amp;reg; | Registered symbol |~| &amp;amp;rsquo; | &amp;rsquo; | right single quote |
| &amp;amp;trade; | &amp;trade; | Trademark symbol |~| &amp;amp;ldquo; | &amp;ldquo; | left double quote |
| &amp;amp;dagger; | &amp;dagger; | dagger |~| &amp;amp;rdquo; | &amp;rdquo; | right double quote |
| &amp;amp;Dagger; | &amp;Dagger; | double dagger |~| &amp;amp;laquo; | &amp;laquo; | left angle quote |
| &amp;amp;ccedil; | &amp;ccedil; | //fa&amp;ccedil;ade// |~| &amp;amp;raquo; | &amp;raquo; | right angle quote |
| &amp;amp;eacute; | &amp;eacute; | //resum&amp;eacute;// ; //fianc&amp;eacute;// |~| &amp;amp;times; | &amp;times; | multiplication symbol |
| &amp;amp;deg; | &amp;deg; | degrees symbol |~| &amp;amp;divide; | &amp;divide; | division symbol |</pre>
</div>
<div title="Cheese" modifier="SimonBaird" created="200601101237" modified="200601121443" tags="Groceries" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601121443">
<pre></pre>
</div>
<div title="Clock2" modifier="Simon" created="200608021528" modified="200608040252" tags="systemConfig Plugins WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608040252">
<pre>/***
| Name:|Clock2|
| Author:|Simon Baird|
| Description:|A skinnable, sizeable analog clock|
| Source:|http://tiddlyspot.com/mptw/#Clock2|
| Requires:|Firefox 1.5.x or maybe Safari|
| Version:|1.0.6|
| Date:|8-Jul-2008|
!!Note
* Does not work in IE or Opera due to lack of canvas support.
* If you make a nice skin send it to me and I will include it here.
*I'm not actively maintaining this plugin
* See also http://randomibis.com/coolclock/
!!Ideas
* Can we support IE with this? http://sourceforge.net/projects/excanvas
* Skin should specify order of drawing so things can be on top of other things
* Fix it so we can have filled and/or stroked elements
* Skin should allow any number of moving and static elements
* Make download and example for non-TW use
* Make floating draggable?
!!Examples
{{{
&lt;&lt;clock2 fancy&gt;&gt;&lt;&lt;clock2 120&gt;&gt;
&lt;&lt;clock2 chunkySwiss&gt;&gt; &lt;&lt;clock2 60 chunkySwiss noSeconds&gt;&gt;&lt;&lt;clock2 '{
	outerBorder: { lineWidth: 60, radius:55, color: &quot;#dd8877&quot;, alpha: 1 },
	smallIndicator: { lineWidth: 4, startAt: 80, endAt: 95, color: &quot;white&quot;, alpha: 1 },
	largeIndicator: { lineWidth: 12, startAt: 77, endAt: 89, color: &quot;#dd8877&quot;, alpha: 1 },
	hourHand: { lineWidth: 15, startAt: -15, endAt: 50, color: &quot;white&quot;, alpha: 1 },
	minuteHand: { lineWidth: 10, startAt: 24, endAt: 200, color: &quot;#771100&quot;, alpha: 0.6 },
	secondHand: { lineWidth: 3, startAt: 22, endAt: 83, color: &quot;green&quot;, alpha: 0 },
	secondDecoration: { lineWidth: 1, startAt: 52, radius: 26, fillColor: &quot;white&quot;, color: &quot;red&quot;, alpha: 0.2 }
}'&gt;&gt;

}}}
&lt;&lt;clock2 fancy&gt;&gt;&lt;&lt;clock2 120&gt;&gt;
&lt;&lt;clock2 chunkySwiss&gt;&gt; &lt;&lt;clock2 60 chunkySwiss noSeconds&gt;&gt;&lt;&lt;clock2 '{
	outerBorder: { lineWidth: 60, radius:55, color: &quot;#dd8877&quot;, alpha: 1 },
	smallIndicator: { lineWidth: 4, startAt: 80, endAt: 95, color: &quot;white&quot;, alpha: 1 },
	largeIndicator: { lineWidth: 12, startAt: 77, endAt: 89, color: &quot;#dd8877&quot;, alpha: 1 },
	hourHand: { lineWidth: 15, startAt: -15, endAt: 50, color: &quot;white&quot;, alpha: 1 },
	minuteHand: { lineWidth: 10, startAt: 24, endAt: 200, color: &quot;#771100&quot;, alpha: 0.6 },
	secondHand: { lineWidth: 3, startAt: 22, endAt: 83, color: &quot;green&quot;, alpha: 0 },
	secondDecoration: { lineWidth: 1, startAt: 52, radius: 26, fillColor: &quot;white&quot;, color: &quot;red&quot;, alpha: 0.2 }
}'&gt;&gt;

See also BigClock.
!!Code
***/
//{{{

window.CoolClock = function(canvasId,displayRadius,skinId,showSecondHand) {
	return this.init(canvasId,displayRadius,skinId,showSecondHand);
}

CoolClock.config = {
	clockTracker: {},
	tickDelay: 1000,
	longTickDelay: 15000,
	defaultRadius: 85,
	renderRadius: 100,
	defaultSkin: &quot;swissRail&quot;,
	skins:	{
		// try making your own...
		swissRail: {
			outerBorder: { lineWidth: 1, radius:95, color: &quot;black&quot;, alpha: 1 },
			smallIndicator: { lineWidth: 2, startAt: 89, endAt: 93, color: &quot;black&quot;, alpha: 1 },
			largeIndicator: { lineWidth: 4, startAt: 80, endAt: 93, color: &quot;black&quot;, alpha: 1 },
			hourHand: { lineWidth: 8, startAt: -15, endAt: 50, color: &quot;black&quot;, alpha: 1 },
			minuteHand: { lineWidth: 7, startAt: -15, endAt: 75, color: &quot;black&quot;, alpha: 1 },
			secondHand: { lineWidth: 1, startAt: -20, endAt: 85, color: &quot;red&quot;, alpha: 1 },
			secondDecoration: { lineWidth: 1, startAt: 70, radius: 4, fillColor: &quot;red&quot;, color: &quot;red&quot;, alpha: 1 }
		},
		chunkySwiss: {
			outerBorder: { lineWidth: 5, radius:97, color: &quot;black&quot;, alpha: 1 },
			smallIndicator: { lineWidth: 4, startAt: 89, endAt: 93, color: &quot;black&quot;, alpha: 1 },
			largeIndicator: { lineWidth: 8, startAt: 80, endAt: 93, color: &quot;black&quot;, alpha: 1 },
			hourHand: { lineWidth: 12, startAt: -15, endAt: 60, color: &quot;black&quot;, alpha: 1 },
			minuteHand: { lineWidth: 10, startAt: -15, endAt: 85, color: &quot;black&quot;, alpha: 1 },
			secondHand: { lineWidth: 4, startAt: -20, endAt: 85, color: &quot;red&quot;, alpha: 1 },
			secondDecoration: { lineWidth: 2, startAt: 70, radius: 8, fillColor: &quot;red&quot;, color: &quot;red&quot;, alpha: 1 }
		},
		fancy: {
			outerBorder: { lineWidth: 5, radius:95, color: &quot;green&quot;, alpha: 0.7 },
			smallIndicator: { lineWidth: 1, startAt: 80, endAt: 93, color: &quot;black&quot;, alpha: 0.4 },
			largeIndicator: { lineWidth: 1, startAt: 30, endAt: 93, color: &quot;black&quot;, alpha: 0.5 },
			hourHand: { lineWidth: 8, startAt: -15, endAt: 50, color: &quot;blue&quot;, alpha: 0.7 },
			minuteHand: { lineWidth: 7, startAt: -15, endAt: 92, color: &quot;red&quot;, alpha: 0.7 },
			secondHand: { lineWidth: 10, startAt: 80, endAt: 85, color: &quot;blue&quot;, alpha: 0.3 },
			secondDecoration: { lineWidth: 1, startAt: 30, radius: 50, fillColor: &quot;blue&quot;, color: &quot;red&quot;, alpha: 0.15 }
		}
	}
};

CoolClock.prototype = {
	init: function(canvasId,displayRadius,skinId,showSecondHand) {
		this.canvasId = canvasId;
		this.displayRadius = displayRadius || CoolClock.config.defaultRadius;
		this.skinId = skinId || CoolClock.config.defaultSkin;
		this.showSecondHand = typeof showSecondHand == &quot;boolean&quot; ? showSecondHand : true;
		this.tickDelay = CoolClock.config[ this.showSecondHand ? &quot;tickDelay&quot; : &quot;longTickDelay&quot;];

		this.canvas = document.getElementById(canvasId);
		this.canvas.setAttribute(&quot;width&quot;,this.displayRadius*2);
		this.canvas.setAttribute(&quot;height&quot;,this.displayRadius*2);

		this.renderRadius = CoolClock.config.renderRadius; 

		var scale = this.displayRadius / this.renderRadius;
		this.ctx = this.canvas.getContext(&quot;2d&quot;);
		this.ctx.scale(scale,scale);

		CoolClock.config.clockTracker[canvasId] = this;
		this.tick();
		return this;
	},

	fullCircle: function(skin) {
		this.fullCircleAt(this.renderRadius,this.renderRadius,skin);
	},

	fullCircleAt: function(x,y,skin) {
		with (this.ctx) {
			save();
			globalAlpha = skin.alpha;
			lineWidth = skin.lineWidth;
			if (!document.all)
				beginPath();
			arc(x, y, skin.radius, 0, 2*Math.PI, false);
			if (skin.fillColor) {
				fillStyle = skin.fillColor
				fill();
			}
			else {
				// XXX why not stroke and fill
				strokeStyle = skin.color;
				stroke();
			}
			restore();
		}
	},

	radialLineAtAngle: function(angleFraction,skin) {
		with (this.ctx) {
			save();
			translate(this.renderRadius,this.renderRadius);
			rotate(Math.PI * (2 * angleFraction - 0.5));
			globalAlpha = skin.alpha;
			strokeStyle = skin.color;
			lineWidth = skin.lineWidth;
			if (skin.radius) {
				this.fullCircleAt(skin.startAt,0,skin)
			}
			else {
				beginPath();
				moveTo(skin.startAt,0)
				lineTo(skin.endAt,0);
				stroke();
			}
			restore();
		}
	},

	render: function(hour,min,sec) {
		var skin = CoolClock.config.skins[this.skinId];
		this.ctx.clearRect(0,0,this.renderRadius*2,this.renderRadius*2);

		this.fullCircle(skin.outerBorder);

		for (var i=0;i&lt;60;i++)
			this.radialLineAtAngle(i/60,skin[ i%5 ? &quot;smallIndicator&quot; : &quot;largeIndicator&quot;]);
				
		this.radialLineAtAngle((hour+min/60)/12,skin.hourHand);
		this.radialLineAtAngle((min+sec/60)/60,skin.minuteHand);
		if (this.showSecondHand) {
			this.radialLineAtAngle(sec/60,skin.secondHand);
			this.radialLineAtAngle(sec/60,skin.secondDecoration);
		}
	},


	nextTick: function() {
		setTimeout(&quot;CoolClock.config.clockTracker['&quot;+this.canvasId+&quot;'].tick()&quot;,this.tickDelay);
	},

	stillHere: function() {
		return document.getElementById(this.canvasId) != null;
	},

	refreshDisplay: function() {
		var now = new Date();
		this.render(now.getHours(),now.getMinutes(),now.getSeconds());
	},

	tick: function() {
		if (this.stillHere()) {
			this.refreshDisplay()
			this.nextTick();
		}
	}
}



config.macros.clock2 = {
	counter: 0,
	handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		var size,skin,seconds,skinData;
		for (var i=0;i&lt;params.length;i++)
			if (/^\d+$/.exec(params[i]))
				size = params[i];
			else if (params[i] == &quot;noSeconds&quot;)
				seconds = false;
			else if (/^\{/.exec(params[i]))
				eval(&quot;skinData = &quot; + params[i]);
			else
				skin = params[i];
		if (skinData) {
			CoolClock.config.skins.customSkin = skinData;
			skin = &quot;customSkin&quot;;
		}
		var canvas = createTiddlyElement(place,&quot;canvas&quot;,&quot;clockcanvas&quot;+this.counter);
		var clock = new CoolClock(&quot;clockcanvas&quot;+this.counter,size,skin,seconds);
		this.counter++;
	}
}

//}}}
</pre>
</div>
<div title="CloseUnsavedOnCancel" modifier="SimonBaird" created="200604221207" modified="200604221207" tags="systemConfig Plugins Borrowed" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604221207">
<pre>/***
|''Name:''|CloseUnsavedOnCancel|
|''Sourse''|http://jackparke.googlepages.com/jtw.html#CloseUnsavedOnCancel|
|''Version:''|2.0.8 (16-Apr-2006)|
|''Author:''|SimonBaird|
|''Adapted By:''|[[Jack]]|
|''Type:''|Plugin|
!Description
When you click new tiddler then click cancel I think the new tiddler should close automatically. This plugin implements that behavious.

!Revision History
* 1.0.1 (11-Oct-2005) by SimonBaird
* 2.0.8 Made 2.0.x compatible by Jack on 16-Apr-2006

!Code
***/
//{{{

config.commands.cancelTiddler.handler =  function(event,src,title) {
 if(story.hasChanges(title) &amp;&amp; !readOnly)
  if(!confirm(this.warning.format([title])))
   return false;
 story.setDirty(title,false);
 if (!store.tiddlerExists(title) || store.fetchTiddler(title).modifier==config.views.wikified.defaultModifier) {
  story.closeTiddler(title,false);
  store.removeTiddler(title)
 } else {
  story.displayTiddler(null,title);
 }
 return false;
}

//}}}</pre>
</div>
<div title="CodeHighlightMacro" modifier="SimonBaird" created="200606150038" modified="200606150146" tags="systemConfig WhatsNew Borrowed" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200606150146">
<pre>/***
|Name|CodeHighlightMacro|
|Created by|ChrisNilsson|
|Location|http://www.slort.org/otherchirps/tiddlywiki/CodeHighlightMacro|
|Version|0.0.1|
|Requires|~TW2.x,dp.SourceHighlight|
!Description


!History

!Examples
//(A bit cramped, since I'm squeezing the example into one table cell...)//
|!Source|!Output|h
|{{{&lt;&lt;codehighlight python def helloWorld(): print &quot;hello world!&quot;&gt;&gt;}}}|&lt;&lt;codehighlight python def helloWorld(): print &quot;hello world!&quot;&gt;&gt;|

!Notes
Relies on the dp.SyntaxHighlighter library: http://www.dreamprojections.com/SyntaxHighlighter/

Put its files wherever you like, but assuming everything is in the same directory,
add the following to the Markup tiddlers:

MarkupPostHead
&gt; &lt;!-- Code highlighter engine css --&gt;
&gt; &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;SyntaxHighlighter.css&quot;&gt;&lt;/link&gt;

MarkupPostBody
&gt; &lt;!-- Syntax highligher engine code --&gt;
&gt; &lt;script language=&quot;javascript&quot; src=&quot;shCore.js&quot;&gt;&lt;/script&gt;
&gt; &lt;script language=&quot;javascript&quot; src=&quot;shBrushDelphi.js&quot;&gt;&lt;/script&gt;
&gt; &lt;script language=&quot;javascript&quot; src=&quot;shBrushPython.js&quot;&gt;&lt;/script&gt;
&gt; &lt;script language=&quot;javascript&quot; src=&quot;shBrushXml.js&quot;&gt;&lt;/script&gt;

The dp.SyntaxHighlighter comes with a few of these &quot;brush&quot; libraries, for different
languages. Add the ones you're interested in using.

!Code
***/
//{{{

// this part is not actually required but useful to other people using your plugin
version.extensions.CodeHighlightMacro = { major: 1, minor: 0, revision: 0, date: new Date(2006,06,12),
	source: &quot;http://www.slort.org/otherchirps/tiddlywiki/CodeHighlightMacro&quot;
};


config.macros.codehighlight = {};

// A global to keep track of how many code chunks we've done.
/*** 
  The examples for dp.SyntaxHighlighter show one big &quot;HighlightAll&quot; call
  at the end of the html document. Then if all code areas have the same name, they
  get converted at once.
  
  But as our &quot;real&quot; html doesn't seem to exist until the tiddler is visible (I think...),
  that doesn't seem to work. Alternatively, calling HighlightAll every time this
  macro is invoked will give odd looking results if all the code chunks have the same name.
  (eg. If you have 5 of these macros displayed, the first area will have 5 copies,
    the next 4, the next will have 3 copies... etc.)
    
  So, here we try to enforce a unique name for each chunk. I figure the tiddler title plus 
  a autoincrement id should be unique enough across the entire wiki.
***/
var codeChunkId = 0;

config.macros.codehighlight.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
  var lang = params[0]; // need at least the language
  var payload = paramString.substr(lang.length+1)
  var codeChunkName = &quot;code_&quot; + tiddler.title + &quot;_&quot; + codeChunkId;
  codeChunkId = codeChunkId + 1;

  var contents = createTiddlyElement(place,&quot;textarea&quot;,null,lang,paramString.substr(lang.length+1)) // +1 to eat the newline/seperating space
  contents.setAttribute(&quot;name&quot;, codeChunkName)
  contents.setAttribute(&quot;cols&quot;, &quot;60&quot;)
 
  dp.SyntaxHighlighter.HighlightAll(codeChunkName);
}

// Convenience shortcuts...
config.macros.delphi = {}
config.macros.python = {}

config.macros.delphi.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
  params.unshift(&quot;delphi&quot;);
  paramString = &quot;delphi\n&quot; + paramString;
  config.macros.codehighlight.handler(place,macroName,params,wikifier,paramString,tiddler);
}

config.macros.delphi.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
  params.unshift(&quot;python&quot;);
  paramString = &quot;python\n&quot; + paramString;
  config.macros.codehighlight.handler(place,macroName,params,wikifier,paramString,tiddler);
}

// so TW table styles don't get in the way
// can't get the specificity right... :(
// ie stronger than TW styles weaker than dp styles.
// hence redo a couple of dp styles here...
setStylesheet(
 &quot;.viewer .dp-highlighter table { border-collapse:separate; border-style:none; }\n&quot; +
 &quot;.viewer .dp-highlighter td { border-style:none; padding-left:10px; }\n&quot; +
 &quot;.viewer .dp-highlighter .gutter { border-right:1px solid grey; }\n&quot; +
 &quot;.viewer .dp-highlighter tbody .tools-corner { border-right:1px solid grey; }\n&quot; +
 &quot;.viewer .dp-highlighter .tools { border-bottom:1px solid grey; }\n&quot; +
 &quot;&quot;,&quot;codeHighlight&quot;);


//}}}

/***

!Another example
&lt;&lt;codehighlight python

import feedparser
d = feedparser.parse('http://feedparser.org/docs/examples/atom10.xml')
print d.feed.title          # u'Sample feed'
print d.feed.link           # u'http://example.org/'
print d.feed.subtitle       # u'For documentation &lt;em&gt;only&lt;/em&gt;'
print d.feed.updated        # u'2005-11-09T11:56:34Z'
print d.feed.updated_parsed # (2005, 11, 9, 11, 56, 34, 2, 313, 0)
print d.feed.id             # u'tag:feedparser.org,2005-11-09:/docs/examples/atom10.xml'

&gt;&gt;

!or the shortcuts...

&lt;&lt;delphi
procedure HelloWorld;
begin
  ShowMessage('Hello world!');
end;
&gt;&gt;


***/
</pre>
</div>
<div title="CommaSeparatedTags" modifier="SimonBaird" created="200605040113" modified="200605040240" tags="Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605040240">
<pre>/***
| Title:|CommaSeparatedTags|
| Source:|http://simonbaird.com/mptw/#CommaSeparatedTags|

!Notes
* Probably works badly if you have tags containing commas.
* If you have a non-shadow EditTemplate you need replace {{{macro=&quot;edit tags&quot;}}} with {{{macro=&quot;editCommaTags&quot;}}} in EditTemplate.

***/
//{{{

// copied mostly from config.macros.edit.handler
config.macros.editCommaTags = {handler: function(place,macroName,params,wikifier,paramString,tiddler) {
	if (tiddler instanceof Tiddler) {
		story.setDirty(tiddler.title,true);
		var e = createTiddlyElement(place,&quot;input&quot;);
		if(tiddler.isReadOnly())
			e.setAttribute(&quot;readOnly&quot;,&quot;readOnly&quot;);
		e.setAttribute(&quot;edit&quot;,&quot;tags&quot;);
		e.setAttribute(&quot;type&quot;,&quot;text&quot;);
		e.value = tiddler.getTags().readBracketedList().join(&quot;, &quot;);   // &lt;---- this is the tweak
		e.setAttribute(&quot;size&quot;,&quot;40&quot;);
		e.setAttribute(&quot;autocomplete&quot;,&quot;off&quot;);
	}
}};

// install in EditTemplate (won't work if you have a real EditTemplate. Then you must modify EditTemplate yourself)
config.shadowTiddlers.EditTemplate = config.shadowTiddlers.EditTemplate.replace(/macro='edit tags'/,&quot;macro='editCommaTags'&quot;); 

String.prototype.readCommaList = function(unique) {
	var n = [];
	var split = this.split(&quot;,&quot;);
	for (var i=0;i&lt;split.length;i++)
		n.pushUnique(split[i].trim(),unique);
	return n;
};


TiddlyWiki.prototype.saveTiddler_orig_commasep = TiddlyWiki.prototype.saveTiddler;
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags) {
	if (typeof tags == &quot;string&quot;) {
		tags = tags.readCommaList(); // I don't think it every gets here..
	}
	else {
		tags = tags.join(&quot; &quot;).readCommaList();  // seems strange because the commas are already in the array
	}

	return this.saveTiddler_orig_commasep(title,newTitle,newBody,modifier,modified,tags);
};

//}}}
</pre>
</div>
<div title="ConfigTweaks" modifier="SimonBaird" created="200601131549" modified="200604050401" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604050401">
<pre>/***
Just some bits and pieces
***/
//{{{
config.views.wikified.defaultText = &quot;&quot;;
config.views.editor.defaultText = &quot;&quot;; 
config.messages.messageClose.text = &quot;X&quot;; // default is &quot;close&quot;
config.options.chkHttpReadOnly = false; // Enable editing so that visitors can experiment with it
//}}}</pre>
</div>
<div title="Contact" modifier="SimonBaird" created="200601101201" modified="200603091454" tags="More..." server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091454">
<pre>Email me your comments, suggestions, bugfixes, etc.
[[simon.baird@gmail.com|mailto:simon.baird@gmail.com]]</pre>
</div>
<div title="Context" modifier="SimonBaird" created="200602161103" modified="200602161103" tags="TiddlerTemplates Contexts" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161103">
<pre></pre>
</div>
<div title="CornChips" modifier="SimonBaird" created="200601101237" modified="200601101246" tags="Groceries Buy" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601101246">
<pre></pre>
</div>
<div title="CreateThemePack" modifier="SimonBaird" created="200604260436" modified="200604260511" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604260511">
<pre>The basics:
{{{
if (!config.themes) config.themes = [];

config.shadowTiddlers.ExampleStyleSheet = &quot;....&quot;;
config.shadowTiddlers.ExamplePageTemplate = &quot;....&quot;;
config.themes.push(&quot;Example&quot;);

config.shadowTiddlers.Example2StyleSheet = &quot;....&quot;;
config.shadowTiddlers.Example2PageTemplate = &quot;....&quot;;
config.themes.push(&quot;Example2&quot;);

}}}

To easily get the content to paste into the above install the ViewHtml plugin and add the following somewhere in your ViewTemplate
{{{
&lt;div macro=&quot;viewAsJs&quot;&gt;&lt;/div&gt;
}}}
Then click on the button where it appears in your StyleSheet or PageTemplate, copy and paste into your ~ThemePack.

See BigThemePack for an example.
</pre>
</div>
<div title="CustomisingTiddlyWiki" modifier="SimonBaird" created="200601112333" modified="200604062331" tags="FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604062331">
<pre>...is lots of fun. :) To help you get started take a look at my HelloWorldMacro and, for more advanced customisations, see the HijackingHowto. Also you can do a lot of cool stuff by (carefully) playing around with your ShadowTiddlers, especially the template ones.</pre>
</div>
<div title="DefaultViewTemplate" modifier="SimonBaird" created="200601061817" modified="200601061817" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601061817">
<pre>&lt;div class='toolbar' macro='toolbar -closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date [[DD MMM YYYY]]'&gt;&lt;/span&gt; (created &lt;span macro='view created date [[DD MMM YYYY]]'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;</pre>
</div>
<div title="Donate" modifier="SimonBaird" created="200602270930" modified="200604201610" tags="More..." server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604201610">
<pre>Well I don't really expect anyone to send me money but if you want to then click the button below. It would be a good story to tell my girlfriend... Or you could contribute by clizzicking some of the you-know-whats at the bottom of the page. 
&lt;html&gt;&lt;form action=&quot;https://www.paypal.com/cgi-bin/webscr&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;_s-xclick&quot;&gt;
&lt;input type=&quot;image&quot; src=&quot;https://www.paypal.com/en_US/i/btn/x-click-but04.gif&quot; border=&quot;0&quot; name=&quot;submit&quot; alt=&quot;Make payments with PayPal - it's fast, free and secure!&quot;&gt;
&lt;img alt=&quot;&quot; border=&quot;0&quot; src=&quot;https://www.paypal.com/en_AU/i/scr/pixel.gif&quot; width=&quot;1&quot; height=&quot;1&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;encrypted&quot; value=&quot;-----BEGIN PKCS7-----MIIHFgYJKoZIhvcNAQcEoIIHBzCCBwMCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYA96IeZGK/4wdV1/ZUgjXRBCwHd70A5D2EhV7pV+V3+7KDokAlu58UnIFv0pY+9pqpxbLzY4nQD8byTzcai16OkJTl2BjNhJPnjxd5tiixiY2jeV8fq5k38Z72t5mR67snkWNaOnSiZ0sy1i4uLEwdwYmQcRwTFkrE6ZKJAlm8fSDELMAkGBSsOAwIaBQAwgZMGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIoAQafN2/jJqAcPPKNYBflRBAkd5YSbLiAk/mUaGoUfwcobKeBCkpFIrgCBXrnKvllPGhzztP0VE1jjcC+NThWANGLwFvkEAa+GLqXrdmGPOBb6VOyRq+wUabxmLHav3UhWkhBMlsWBBvjJwDNVW3V+gcrO6q/hek1ESgggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEzMTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALScsTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNpJeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgeswHQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaffLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK//Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiSojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIBmjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0wNjA0MjAxNjA0MTBaMCMGCSqGSIb3DQEJBDEWBBRzSfthO3tPpm82bNvEhK/w7KeCBjANBgkqhkiG9w0BAQEFAASBgHfmjcg4sSFJuM3zOt8JlzFBWKHGpckcb6jGKaTG6ppTe/t/E7XOxVk11v9msOpc27CCC7InqArPTK3LiT4Z7N5c13sJLigj5EsMPznMTGkpvXPlbHWmEQcODm3YlClpGuQacRkS/MpHDXA1eWFoM7D9vgzKwsOUy2kNbp2mezK5-----END PKCS7-----
&quot;&gt;
&lt;/form&gt;&lt;/html&gt;</pre>
</div>
<div title="Done" modifier="SimonBaird" created="200604041732" modified="200604041732" tags="Status" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041732">
<pre></pre>
</div>
<div title="Download" modifier="Simon" created="200601191212" modified="200607142216" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607142216">
<pre>You can have your own personal, self-contained wiki exactly* like this site in just a few seconds. Here's how to do it.
# Right click on [[empty_mptw.html|empty_mptw.html]]
# Click 'Save link as...' and save the file somewhere locally. Name it whatever you want.
# When the download is finished, double click the file to open it in your browser
That's it! You're now ready configure your page's title, menus etc, and add your own content by following the instructions in your new TiddlyWiki file.

~~* Actually the &quot;empty&quot; file contains the TagglyTagging stuff plus Eric Shulman's ImportTiddlersPlugin. I've removed the more experimental plugins used on this site. See [[here|empty_mptw.html#systemConfig]] for a full list of what comes with the empty file.~~</pre>
</div>
<div title="DropDownTagChooser" modifier="SimonBaird" created="200604041723" modified="200604041753" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041753">
<pre>/***
DropDownTagChooser
http://simonbaird.com/mptw/#DropDownTagChooser
Requires TagUtils
Example:
{{{&lt;&lt;selectUniqueTag Priority&gt;&gt;}}}
&lt;&lt;selectUniqueTag Priority&gt;&gt;
See also ExampleTask (uses ViewTemplate to put a couple of these in the toolbar).
***/
//{{{
var selectUniqueTagOnChange = function(tiddler,newTag,tagGroup) {

	// can I do this a better way, ie not have to use store.getTiddler???
	// just use macro handler scope ???

	var t = store.getTiddler(tiddler);
	t.setUniqueTagFromGroup(newTag,tagGroup);

	// refresh visible tiddlers
	story.forEachTiddler(function(title,element) {
		if (element.getAttribute(&quot;dirty&quot;) != &quot;true&quot;) 
			story.refreshTiddler(title,false,true);
	});

	return false;
}

config.macros.selectUniqueTag = {};
config.macros.selectUniqueTag.handler =
 function(place,macroName,params,wikifier,paramString,tiddler) {

	var tagGroup = params[0];
	var label = params[1]?params[1]:params[0]+&quot;:&quot;;

	var tagsInGroup = getTitles(store.getTaggedTiddlers(params[0]));

	var select = document.createElement(&quot;select&quot;);

	/*
	// dont know how to make this work..
	var update = function(e) {
		if (!e) var e = window.event;
		alert(&quot;here&quot;);
		return false;
	};
	select.onchange = update;
	*/

	select.setAttribute(&quot;onchange&quot;,&quot;selectUniqueTagOnChange('&quot;+
			tiddler.title+&quot;',this.options[this.selectedIndex].text,'&quot;+tagGroup+&quot;');&quot;);

	select.setAttribute(&quot;style&quot;,&quot;font-size:90%;&quot;); // evil. should use a class!

	// in case there is currently none of them
	if (!tiddler.hasAnyTag(tagsInGroup)) {
		var opt = document.createElement(&quot;option&quot;);
		opt.text = &quot;-&quot;;
		opt.selected = true;
		try {
			// for IE
			select.add(opt);
		}
		catch(e) {
			select.appendChild(opt)
		};
	}

	for (var i=0;i&lt;tagsInGroup.length;i++) {
		var opt = document.createElement(&quot;option&quot;);
		opt.text = tagsInGroup[i];
		if (tiddler.hasTag(tagsInGroup[i]))
			opt.selected = true;
		try {
			// for IE
			select.add(opt);
		}
		catch(e) {
			select.appendChild(opt)
		};
	}

	wikify(label,place,null,tiddler);
	place.appendChild(select);
}

//}}}

</pre>
</div>
<div title="EditTemplates" modifier="SimonBaird" created="200601160549" modified="200601160549" tags="Templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601160549">
<pre></pre>
</div>
<div title="ExampleTask" modifier="SimonBaird" created="200602161038" modified="200604041734" tags="Tasks Next Low" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041734">
<pre>Do something.
</pre>
</div>
<div title="ExportAllPlugins" creator="YourName" modifier="YourName" created="202507091948" changecount="1">
<pre>&lt;&lt;exportByTag &quot;systemConfig&quot; file:&quot;./plugins/&quot; format:js&gt;&gt;</pre>
</div>
<div title="Fix IE mangled indenting" modifier="SimonBaird" created="200603021612" modified="200603021612" tags="Todo Urgent" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603021612">
<pre>GAH!!! Roll back to an old version, then add in new bits??</pre>
</div>
<div title="FlickrGreetingMacro" modifier="SimonBaird" created="200603241521" modified="200603241539" tags="Plugins Borrowed FunStuff systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603241539">
<pre>/***
|Name|FlickrGreetingMacro|
|Created by|PeterKirkland|
|Version|1.0.1|
|Requires|~TW2.x|
!Description
It replicates the random greeting messages from
[[Flickr|http://www.flickr.com/]] in a TiddlyWiki macro.

!History
* 25-Mar-06, version 1.0.1, couple of tweaks by SimonBaird
** added flickrGreetingCookie
** made WelcomeMessage into array literal
** removed ! since I wanted &quot;Hola and welcome to...&quot;
* 24-Mar-06, version 1.0.0, first version

!Examples
|!Source|!Output|h
|{{{&lt;&lt;flickrGreeting&gt;&gt;}}}|&lt;&lt;flickrGreeting&gt;&gt;|
|{{{&lt;&lt;flickrGreetingCookie&gt;&gt;}}}|&lt;&lt;flickrGreetingCookie&gt;&gt;|
|{{{&lt;&lt;flickrGreeting Peter&gt;&gt;}}}|&lt;&lt;flickrGreeting Peter&gt;&gt;|
|{{{&lt;&lt;flickrGreeting 'Peter Kirkland'&gt;&gt;}}}|&lt;&lt;flickrGreeting 'Peter Kirkland'&gt;&gt;|
(You can use (single or double) quotes or double square brackets for
params with spaces)

!Notes
*I created this to re-create the international greetings that Flickr uses.
*I use it in a tiddler linked to my DefaultTiddlers to get a pleasant welcome message!
*To make the macro work you have to give this tiddler a tag of systemConfig then save and reload.
*Thanks to Simon Baird for his HelloWorldMacro which taught me how to use macros, and also for his [[MonkeyPirateTiddlyWiki|http://simonbaird.com/mptw/]]!

!Code
***/
//{{{

// this part is not actually required but useful to other people using your plugin
version.extensions.FlickrGreetingMacro = { major: 1, minor: 0, revision: 1, date: new Date(2006,3,24) };

config.macros.flickrGreetingCookie = {};
config.macros.flickrGreetingCookie.handler = function (place,name,params) {
    wikify(&quot;&lt;&lt;flickrGreeting &quot; + config.options.txtUserName + &quot;&gt;&gt;&quot;, place);
}

config.macros.flickrGreeting = {};
config.macros.flickrGreeting.handler = function (place,name,params) {
       //List of greetings:
       var WelcomeMessage = [
              &quot;Hola&quot;,
              &quot;Hala&quot;,
              &quot;Shalom&quot;,
              &quot;Ni hao&quot;,
              &quot;Kumusta&quot;,
              &quot;'Allo&quot;,
              &quot;G'day&quot;,
              &quot;Hoi&quot;,
              &quot;Giorno&quot;,
              &quot;Hi&quot;,
              &quot;Hej&quot;,
              &quot;Ol&quot;,
              &quot;Ahoy&quot;,
              &quot;Salut&quot;,
              &quot;Hello&quot;,
              &quot;Hoi&quot;,
              &quot;Oi&quot;,
              &quot;Hoi&quot;,
              &quot;Aloha&quot;,
              &quot;Bonjour&quot;,
              &quot;Guten Tag&quot;,
              &quot;Yo&quot;,
              &quot;Shalom&quot;,
              &quot;Namaste&quot;,
              &quot;Ciao&quot;
       ];
       //randomness:
       var index = Math.floor(Math.random() * WelcomeMessage.length);
       //output:
       var who = params.length &gt; 0 ? (&quot; &quot;+params[0]) : &quot;&quot;;
       wikify(WelcomeMessage[index] + who /* + &quot;!&quot; */, place);
}

//}}}
</pre>
</div>
<div title="FlipMeOver" modifier="SimonBaird" created="200601120557" modified="200601120559" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601120559">
<pre>Oops... exclamation point not good in urls in mail readers... click below to continue...
* [[FlipMeOver!]]</pre>
</div>
<div title="FlipMeOver!" modifier="SimonBaird" created="200601120407" modified="200603080031" tags="Flippable FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603080031">
<pre>!!Welcome to the world's first acrobatic tiddler...
This is a test of my new TagBasedTemplates plugin. Click the checkbox next to [[UpsideDown]] in the toolbar and the tiddler will flip upside-down! You can tag any tiddler on this site as [[Flippable]]. And then you can flip it. 

Okay this is a fairly useless example but I believe tag based templates combined with toggleTag and runMacroIfTagged open up endless possibilities for new and powerful TiddlyWiki applications. I have ideas for a few myself... 

See also:
* UpsideDownViewTemplate
* ViewTemplate
* TagBasedTemplates
* RunMacroIfTagged
* ToggleTagMacro
* [[Flippable]]
* UpsideDown


</pre>
</div>
<div title="Flippable" modifier="SimonBaird" created="200601120537" modified="200601120537" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601120537">
<pre>Tiddlers that can be flipped...</pre>
</div>
<div title="ForEachHelper" modifier="SimonBaird" created="200601160438" modified="200603060652" tags="Snippets" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060652">
<pre>/***
Not using this for anything at the moment but it's too good to throw out..
***/
//{{{

function feEsc(expr) {
 return '&quot;'+expr.replace(/&quot;/,'\\&quot;').replace(/\n/,'\\n')+'&quot;';

}

function feHelper(where,sortBy,sortOrder,write,place,debug) {
 markup = &quot;&lt;&lt;forEachTiddler\n\twhere\n\t\t%0\n\tsortBy\n\t\t%1\n\t\t\t%2\n\twrite\n\t\t%3\n&gt;&gt;&quot;.format([
 feEsc(where),
 feEsc(sortBy),
 (sortOrder == &quot;asc&quot; ? &quot;ascending&quot; : (sortOrder == &quot;desc&quot; ? &quot;descending&quot; : sortOrder)),
 feEsc(write)
 ]);

 if (debug)
 wikify('\n{{{\n'+markup+'\n}}}\n', place);

 wikify(markup, place);
}


// example usage:
 feHelper(
 &quot;tiddler.tags.contains('&quot; + tiddler.title + &quot;')&quot;,
 &quot;tiddler.&quot;+sortBy,
 sortOrder,
 &quot;'*[['+tiddler.title+']]\n'&quot;,
 place
 );


//}}}
</pre>
</div>
<div title="ForEachTiddlerPlugin" creator="YourName" modifier="YourName" created="202507091947" tags="systemConfig" changecount="1">
<pre>/***
|''Name:''|ForEachTiddlerPlugin|
|''Version:''|1.0.8 (2007-04-12)|
|''Source:''|http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2007 [[abego Software|http://www.abego-software.de]]|
|''TiddlyWiki:''|1.2.38+, 2.0|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|
!Description

Create customizable lists, tables etc. for your selections of tiddlers. Specify the tiddlers to include and their order through a powerful language.

''Syntax:''
|&gt;|{{{&lt;&lt;}}}''forEachTiddler'' [''in'' //tiddlyWikiPath//] [''where'' //whereCondition//] [''sortBy'' //sortExpression// [''ascending'' //or// ''descending'']] [''script'' //scriptText//] [//action// [//actionParameters//]]{{{&gt;&gt;}}}|
|//tiddlyWikiPath//|The filepath to the TiddlyWiki the macro should work on. When missing the current TiddlyWiki is used.|
|//whereCondition//|(quoted) JavaScript boolean expression. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//sortExpression//|(quoted) JavaScript expression returning &quot;comparable&quot; objects (using '{{{&lt;}}}','{{{&gt;}}}','{{{==}}}'. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//scriptText//|(quoted) JavaScript text. Typically defines JavaScript functions that are called by the various JavaScript expressions (whereClause, sortClause, action arguments,...)|
|//action//|The action that should be performed on every selected tiddler, in the given order. By default the actions [[addToList|AddToListAction]] and [[write|WriteAction]] are supported. When no action is specified [[addToList|AddToListAction]]  is used.|
|//actionParameters//|(action specific) parameters the action may refer while processing the tiddlers (see action descriptions for details). &lt;&lt;tiddler [[JavaScript in actionParameters]]&gt;&gt;|
|&gt;|~~Syntax formatting: Keywords in ''bold'', optional parts in [...]. 'or' means that exactly one of the two alternatives must exist.~~|

See details see [[ForEachTiddlerMacro]] and [[ForEachTiddlerExamples]].

!Revision history
* v1.0.8 (2007-04-12)
** Adapted to latest TiddlyWiki 2.2 Beta importTiddlyWiki API (introduced with changeset 2004). TiddlyWiki 2.2 Beta builds prior to changeset 2004 are no longer supported (but TiddlyWiki 2.1 and earlier, of cause)
* v1.0.7 (2007-03-28)
** Also support &quot;pre&quot; formatted TiddlyWikis (introduced with TW 2.2) (when using &quot;in&quot; clause to work on external tiddlers)
* v1.0.6 (2006-09-16)
** Context provides &quot;viewerTiddler&quot;, i.e. the tiddler used to view the macro. Most times this is equal to the &quot;inTiddler&quot;, but when using the &quot;tiddler&quot; macro both may be different.
** Support &quot;begin&quot;, &quot;end&quot; and &quot;none&quot; expressions in &quot;write&quot; action
* v1.0.5 (2006-02-05)
** Pass tiddler containing the macro with wikify, context object also holds reference to tiddler containing the macro (&quot;inTiddler&quot;). Thanks to SimonBaird.
** Support Firefox 1.5.0.1
** Internal
*** Make &quot;JSLint&quot; conform
*** &quot;Only install once&quot;
* v1.0.4 (2006-01-06)
** Support TiddlyWiki 2.0
* v1.0.3 (2005-12-22)
** Features:
*** Write output to a file supports multi-byte environments (Thanks to Bram Chen)
*** Provide API to access the forEachTiddler functionality directly through JavaScript (see getTiddlers and performMacro)
** Enhancements:
*** Improved error messages on InternetExplorer.
* v1.0.2 (2005-12-10)
** Features:
*** context object also holds reference to store (TiddlyWiki)
** Fixed Bugs:
*** ForEachTiddler 1.0.1 has broken support on win32 Opera 8.51 (Thanks to BrunoSabin for reporting)
* v1.0.1 (2005-12-08)
** Features:
*** Access tiddlers stored in separated TiddlyWikis through the &quot;in&quot; option. I.e. you are no longer limited to only work on the &quot;current TiddlyWiki&quot;.
*** Write output to an external file using the &quot;toFile&quot; option of the &quot;write&quot; action. With this option you may write your customized tiddler exports.
*** Use the &quot;script&quot; section to define &quot;helper&quot; JavaScript functions etc. to be used in the various JavaScript expressions (whereClause, sortClause, action arguments,...).
*** Access and store context information for the current forEachTiddler invocation (through the build-in &quot;context&quot; object) .
*** Improved script evaluation (for where/sort clause and write scripts).
* v1.0.0 (2005-11-20)
** initial version

!Code
***/
//{{{


//============================================================================
//============================================================================
//		   ForEachTiddlerPlugin
//============================================================================
//============================================================================

// Only install once
if (!version.extensions.ForEachTiddlerPlugin) {

if (!window.abego) window.abego = {};

version.extensions.ForEachTiddlerPlugin = {
	major: 1, minor: 0, revision: 8,
	date: new Date(2007,3,12),
	source: &quot;http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin&quot;,
	licence: &quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,
	copyright: &quot;Copyright (c) abego Software GmbH, 2005-2007 (www.abego-software.de)&quot;
};

// For backward compatibility with TW 1.2.x
//
if (!TiddlyWiki.prototype.forEachTiddler) {
	TiddlyWiki.prototype.forEachTiddler = function(callback) {
		for(var t in this.tiddlers) {
			callback.call(this,t,this.tiddlers[t]);
		}
	};
}

//============================================================================
// forEachTiddler Macro
//============================================================================

version.extensions.forEachTiddler = {
	major: 1, minor: 0, revision: 8, date: new Date(2007,3,12), provider: &quot;http://tiddlywiki.abego-software.de&quot;};

// ---------------------------------------------------------------------------
// Configurations and constants
// ---------------------------------------------------------------------------

config.macros.forEachTiddler = {
	 // Standard Properties
	 label: &quot;forEachTiddler&quot;,
	 prompt: &quot;Perform actions on a (sorted) selection of tiddlers&quot;,

	 // actions
	 actions: {
		 addToList: {},
		 write: {}
	 }
};

// ---------------------------------------------------------------------------
//  The forEachTiddler Macro Handler
// ---------------------------------------------------------------------------

config.macros.forEachTiddler.getContainingTiddler = function(e) {
	while(e &amp;&amp; !hasClass(e,&quot;tiddler&quot;))
		e = e.parentNode;
	var title = e ? e.getAttribute(&quot;tiddler&quot;) : null;
	return title ? store.getTiddler(title) : null;
};

config.macros.forEachTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	// config.macros.forEachTiddler.traceMacroCall(place,macroName,params,wikifier,paramString,tiddler);

	if (!tiddler) tiddler = config.macros.forEachTiddler.getContainingTiddler(place);
	// --- Parsing ------------------------------------------

	var i = 0; // index running over the params
	// Parse the &quot;in&quot; clause
	var tiddlyWikiPath = undefined;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;in&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;TiddlyWiki path expected behind 'in'.&quot;);
			return;
		}
		tiddlyWikiPath = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the where clause
	var whereClause =&quot;true&quot;;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;where&quot;) {
		i++;
		whereClause = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the sort stuff
	var sortClause = null;
	var sortAscending = true;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;sortBy&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;sortClause missing behind 'sortBy'.&quot;);
			return;
		}
		sortClause = this.paramEncode(params[i]);
		i++;

		if ((i &lt; params.length) &amp;&amp; (params[i] == &quot;ascending&quot; || params[i] == &quot;descending&quot;)) {
			 sortAscending = params[i] == &quot;ascending&quot;;
			 i++;
		}
	}

	// Parse the script
	var scriptText = null;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;script&quot;) {
		i++;
		scriptText = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the action.
	// When we are already at the end use the default action
	var actionName = &quot;addToList&quot;;
	if (i &lt; params.length) {
	   if (!config.macros.forEachTiddler.actions[params[i]]) {
			this.handleError(place, &quot;Unknown action '&quot;+params[i]+&quot;'.&quot;);
			return;
		} else {
			actionName = params[i];
			i++;
		}
	}

	// Get the action parameter
	// (the parsing is done inside the individual action implementation.)
	var actionParameter = params.slice(i);


	// --- Processing ------------------------------------------
	try {
		this.performMacro({
				place: place,
				inTiddler: tiddler,
				whereClause: whereClause,
				sortClause: sortClause,
				sortAscending: sortAscending,
				actionName: actionName,
				actionParameter: actionParameter,
				scriptText: scriptText,
				tiddlyWikiPath: tiddlyWikiPath});

	} catch (e) {
		this.handleError(place, e);
	}
};

// Returns an object with properties &quot;tiddlers&quot; and &quot;context&quot;.
// tiddlers holds the (sorted) tiddlers selected by the parameter,
// context the context of the execution of the macro.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlersAndContext = function(parameter) {

	var context = config.macros.forEachTiddler.createContext(parameter.place, parameter.whereClause, parameter.sortClause, parameter.sortAscending, parameter.actionName, parameter.actionParameter, parameter.scriptText, parameter.tiddlyWikiPath, parameter.inTiddler);

	var tiddlyWiki = parameter.tiddlyWikiPath ? this.loadTiddlyWiki(parameter.tiddlyWikiPath) : store;
	context[&quot;tiddlyWiki&quot;] = tiddlyWiki;

	// Get the tiddlers, as defined by the whereClause
	var tiddlers = this.findTiddlers(parameter.whereClause, context, tiddlyWiki);
	context[&quot;tiddlers&quot;] = tiddlers;

	// Sort the tiddlers, when sorting is required.
	if (parameter.sortClause) {
		this.sortTiddlers(tiddlers, parameter.sortClause, parameter.sortAscending, context);
	}

	return {tiddlers: tiddlers, context: context};
};

// Returns the (sorted) tiddlers selected by the parameter.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlers = function(parameter) {
	return this.getTiddlersAndContext(parameter).tiddlers;
};

// Performs the macros with the given parameter.
//
// @param parameter holds the parameter of the macro as separate properties.
//				  The following properties are supported:
//
//						place
//						whereClause
//						sortClause
//						sortAscending
//						actionName
//						actionParameter
//						scriptText
//						tiddlyWikiPath
//
//					All properties are optional.
//					For most actions the place property must be defined.
//
config.macros.forEachTiddler.performMacro = function(parameter) {
	var tiddlersAndContext = this.getTiddlersAndContext(parameter);

	// Perform the action
	var actionName = parameter.actionName ? parameter.actionName : &quot;addToList&quot;;
	var action = config.macros.forEachTiddler.actions[actionName];
	if (!action) {
		this.handleError(parameter.place, &quot;Unknown action '&quot;+actionName+&quot;'.&quot;);
		return;
	}

	var actionHandler = action.handler;
	actionHandler(parameter.place, tiddlersAndContext.tiddlers, parameter.actionParameter, tiddlersAndContext.context);
};

// ---------------------------------------------------------------------------
//  The actions
// ---------------------------------------------------------------------------

// Internal.
//
// --- The addToList Action -----------------------------------------------
//
config.macros.forEachTiddler.actions.addToList.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;addToList&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var list = document.createElement(&quot;ul&quot;);
	place.appendChild(list);
	for (var i = 0; i &lt; tiddlers.length; i++) {
		var tiddler = tiddlers[i];
		var listItem = document.createElement(&quot;li&quot;);
		list.appendChild(listItem);
		createTiddlyLink(listItem, tiddler.title, true);
	}
};

abego.parseNamedParameter = function(name, parameter, i) {
	var beginExpression = null;
	if ((i &lt; parameter.length) &amp;&amp; parameter[i] == name) {
		i++;
		if (i &gt;= parameter.length) {
			throw &quot;Missing text behind '%0'&quot;.format([name]);
		}

		return config.macros.forEachTiddler.paramEncode(parameter[i]);
	}
	return null;
}

// Internal.
//
// --- The write Action ---------------------------------------------------
//
config.macros.forEachTiddler.actions.write.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;
	if (p &gt;= parameter.length) {
		this.handleError(place, &quot;Missing expression behind 'write'.&quot;);
		return;
	}

	var textExpression = config.macros.forEachTiddler.paramEncode(parameter[p]);
	p++;

	// Parse the &quot;begin&quot; option
	var beginExpression = abego.parseNamedParameter(&quot;begin&quot;, parameter, p);
	if (beginExpression !== null)
		p += 2;
	var endExpression = abego.parseNamedParameter(&quot;end&quot;, parameter, p);
	if (endExpression !== null)
		p += 2;
	var noneExpression = abego.parseNamedParameter(&quot;none&quot;, parameter, p);
	if (noneExpression !== null)
		p += 2;

	// Parse the &quot;toFile&quot; option
	var filename = null;
	var lineSeparator = undefined;
	if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;toFile&quot;) {
		p++;
		if (p &gt;= parameter.length) {
			this.handleError(place, &quot;Filename expected behind 'toFile' of 'write' action.&quot;);
			return;
		}

		filename = config.macros.forEachTiddler.getLocalPath(config.macros.forEachTiddler.paramEncode(parameter[p]));
		p++;
		if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;withLineSeparator&quot;) {
			p++;
			if (p &gt;= parameter.length) {
				this.handleError(place, &quot;Line separator text expected behind 'withLineSeparator' of 'write' action.&quot;);
				return;
			}
			lineSeparator = config.macros.forEachTiddler.paramEncode(parameter[p]);
			p++;
		}
	}

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;write&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(textExpression, context);
	var count = tiddlers.length;
	var text = &quot;&quot;;
	if (count &gt; 0 &amp;&amp; beginExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(beginExpression, context)(undefined, context, count, undefined);

	for (var i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		text += func(tiddler, context, count, i);
	}

	if (count &gt; 0 &amp;&amp; endExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(endExpression, context)(undefined, context, count, undefined);

	if (count == 0 &amp;&amp; noneExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(noneExpression, context)(undefined, context, count, undefined);


	if (filename) {
		if (lineSeparator !== undefined) {
			lineSeparator = lineSeparator.replace(/\\n/mg, &quot;\n&quot;).replace(/\\r/mg, &quot;\r&quot;);
			text = text.replace(/\n/mg,lineSeparator);
		}
		saveFile(filename, convertUnicodeToUTF8(text));
	} else {
		var wrapper = createTiddlyElement(place, &quot;span&quot;);
		wikify(text, wrapper, null/* highlightRegExp */, context.inTiddler);
	}
};


// ---------------------------------------------------------------------------
//  Helpers
// ---------------------------------------------------------------------------

// Internal.
//
config.macros.forEachTiddler.createContext = function(placeParam, whereClauseParam, sortClauseParam, sortAscendingParam, actionNameParam, actionParameterParam, scriptText, tiddlyWikiPathParam, inTiddlerParam) {
	return {
		place : placeParam,
		whereClause : whereClauseParam,
		sortClause : sortClauseParam,
		sortAscending : sortAscendingParam,
		script : scriptText,
		actionName : actionNameParam,
		actionParameter : actionParameterParam,
		tiddlyWikiPath : tiddlyWikiPathParam,
		inTiddler : inTiddlerParam, // the tiddler containing the &lt;&lt;forEachTiddler ...&gt;&gt; macro call.
		viewerTiddler : config.macros.forEachTiddler.getContainingTiddler(placeParam) // the tiddler showing the forEachTiddler result
	};
};

// Internal.
//
// Returns a TiddlyWiki with the tiddlers loaded from the TiddlyWiki of
// the given path.
//
config.macros.forEachTiddler.loadTiddlyWiki = function(path, idPrefix) {
	if (!idPrefix) {
		idPrefix = &quot;store&quot;;
	}
	var lenPrefix = idPrefix.length;

	// Read the content of the given file
	var content = loadFile(this.getLocalPath(path));
	if(content === null) {
		throw &quot;TiddlyWiki '&quot;+path+&quot;' not found.&quot;;
	}

	var tiddlyWiki = new TiddlyWiki();

	// Starting with TW 2.2 there is a helper function to import the tiddlers
	if (tiddlyWiki.importTiddlyWiki) {
		if (!tiddlyWiki.importTiddlyWiki(content))
			throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
		tiddlyWiki.dirty = false;
		return tiddlyWiki;
	}

	// The legacy code, for TW &lt; 2.2

	// Locate the storeArea div's
	var posOpeningDiv = content.indexOf(startSaveArea);
	var posClosingDiv = content.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1)) {
		throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
	}
	var storageText = content.substr(posOpeningDiv + startSaveArea.length, posClosingDiv);

	// Create a &quot;div&quot; element that contains the storage text
	var myStorageDiv = document.createElement(&quot;div&quot;);
	myStorageDiv.innerHTML = storageText;
	myStorageDiv.normalize();

	// Create all tiddlers in a new TiddlyWiki
	// (following code is modified copy of TiddlyWiki.prototype.loadFromDiv)
	var store = myStorageDiv.childNodes;
	for(var t = 0; t &lt; store.length; t++) {
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute(&quot;tiddler&quot;);
		if(!title &amp;&amp; e.id &amp;&amp; e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title &amp;&amp; title !== &quot;&quot;) {
			var tiddler = tiddlyWiki.createTiddler(title);
			tiddler.loadFromDiv(e,title);
		}
	}
	tiddlyWiki.dirty = false;

	return tiddlyWiki;
};



// Internal.
//
// Returns a function that has a function body returning the given javaScriptExpression.
// The function has the parameters:
//
//	 (tiddler, context, count, index)
//
config.macros.forEachTiddler.getEvalTiddlerFunction = function (javaScriptExpression, context) {
	var script = context[&quot;script&quot;];
	var functionText = &quot;var theFunction = function(tiddler, context, count, index) { return &quot;+javaScriptExpression+&quot;}&quot;;
	var fullText = (script ? script+&quot;;&quot; : &quot;&quot;)+functionText+&quot;;theFunction;&quot;;
	return eval(fullText);
};

// Internal.
//
config.macros.forEachTiddler.findTiddlers = function(whereClause, context, tiddlyWiki) {
	var result = [];
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(whereClause, context);
	tiddlyWiki.forEachTiddler(function(title,tiddler) {
		if (func(tiddler, context, undefined, undefined)) {
			result.push(tiddler);
		}
	});
	return result;
};

// Internal.
//
config.macros.forEachTiddler.createExtraParameterErrorElement = function(place, actionName, parameter, firstUnusedIndex) {
	var message = &quot;Extra parameter behind '&quot;+actionName+&quot;':&quot;;
	for (var i = firstUnusedIndex; i &lt; parameter.length; i++) {
		message += &quot; &quot;+parameter[i];
	}
	this.handleError(place, message);
};

// Internal.
//
config.macros.forEachTiddler.sortAscending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? -1
			   : +1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortDescending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? +1
			   : -1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortTiddlers = function(tiddlers, sortClause, ascending, context) {
	// To avoid evaluating the sortClause whenever two items are compared
	// we pre-calculate the sortValue for every item in the array and store it in a
	// temporary property (&quot;forEachTiddlerSortValue&quot;) of the tiddlers.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(sortClause, context);
	var count = tiddlers.length;
	var i;
	for (i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		tiddler.forEachTiddlerSortValue = func(tiddler,context, undefined, undefined);
	}

	// Do the sorting
	tiddlers.sort(ascending ? this.sortAscending : this.sortDescending);

	// Delete the temporary property that holds the sortValue.
	for (i = 0; i &lt; tiddlers.length; i++) {
		delete tiddlers[i].forEachTiddlerSortValue;
	}
};


// Internal.
//
config.macros.forEachTiddler.trace = function(message) {
	displayMessage(message);
};

// Internal.
//
config.macros.forEachTiddler.traceMacroCall = function(place,macroName,params) {
	var message =&quot;&lt;&lt;&quot;+macroName;
	for (var i = 0; i &lt; params.length; i++) {
		message += &quot; &quot;+params[i];
	}
	message += &quot;&gt;&gt;&quot;;
	displayMessage(message);
};


// Internal.
//
// Creates an element that holds an error message
//
config.macros.forEachTiddler.createErrorElement = function(place, exception) {
	var message = (exception.description) ? exception.description : exception.toString();
	return createTiddlyElement(place,&quot;span&quot;,null,&quot;forEachTiddlerError&quot;,&quot;&lt;&lt;forEachTiddler ...&gt;&gt;: &quot;+message);
};

// Internal.
//
// @param place [may be null]
//
config.macros.forEachTiddler.handleError = function(place, exception) {
	if (place) {
		this.createErrorElement(place, exception);
	} else {
		throw exception;
	}
};

// Internal.
//
// Encodes the given string.
//
// Replaces
//	 &quot;$))&quot; to &quot;&gt;&gt;&quot;
//	 &quot;$)&quot; to &quot;&gt;&quot;
//
config.macros.forEachTiddler.paramEncode = function(s) {
	var reGTGT = new RegExp(&quot;\\$\\)\\)&quot;,&quot;mg&quot;);
	var reGT = new RegExp(&quot;\\$\\)&quot;,&quot;mg&quot;);
	return s.replace(reGTGT, &quot;&gt;&gt;&quot;).replace(reGT, &quot;&gt;&quot;);
};

// Internal.
//
// Returns the given original path (that is a file path, starting with &quot;file:&quot;)
// as a path to a local file, in the systems native file format.
//
// Location information in the originalPath (i.e. the &quot;#&quot; and stuff following)
// is stripped.
//
config.macros.forEachTiddler.getLocalPath = function(originalPath) {
	// Remove any location part of the URL
	var hashPos = originalPath.indexOf(&quot;#&quot;);
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert to a native file format assuming
	// &quot;file:///x:/path/path/path...&quot; - pc local file --&gt; &quot;x:\path\path\path...&quot;
	// &quot;file://///server/share/path/path/path...&quot; - FireFox pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	// &quot;file:///path/path/path...&quot; - mac/unix local file --&gt; &quot;/path/path/path...&quot;
	// &quot;file://server/share/path/path/path...&quot; - pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	var localPath;
	if(originalPath.charAt(9) == &quot;:&quot;) // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file://///&quot;) === 0) // FireFox pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(10)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file:///&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf(&quot;file:/&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(7)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	return localPath;
};

// ---------------------------------------------------------------------------
// Stylesheet Extensions (may be overridden by local StyleSheet)
// ---------------------------------------------------------------------------
//
setStylesheet(
	&quot;.forEachTiddlerError{color: #ffffff;background-color: #880000;}&quot;,
	&quot;forEachTiddler&quot;);

//============================================================================
// End of forEachTiddler Macro
//============================================================================


//============================================================================
// String.startsWith Function
//============================================================================
//
// Returns true if the string starts with the given prefix, false otherwise.
//
version.extensions[&quot;String.startsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.startsWith = function(prefix) {
	var n =  prefix.length;
	return (this.length &gt;= n) &amp;&amp; (this.slice(0, n) == prefix);
};



//============================================================================
// String.endsWith Function
//============================================================================
//
// Returns true if the string ends with the given suffix, false otherwise.
//
version.extensions[&quot;String.endsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.endsWith = function(suffix) {
	var n = suffix.length;
	return (this.length &gt;= n) &amp;&amp; (this.right(n) == suffix);
};


//============================================================================
// String.contains Function
//============================================================================
//
// Returns true when the string contains the given substring, false otherwise.
//
version.extensions[&quot;String.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.contains = function(substring) {
	return this.indexOf(substring) &gt;= 0;
};

//============================================================================
// Array.indexOf Function
//============================================================================
//
// Returns the index of the first occurance of the given item in the array or
// -1 when no such item exists.
//
// @param item [may be null]
//
version.extensions[&quot;Array.indexOf&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.indexOf = function(item) {
	for (var i = 0; i &lt; this.length; i++) {
		if (this[i] == item) {
			return i;
		}
	}
	return -1;
};

//============================================================================
// Array.contains Function
//============================================================================
//
// Returns true when the array contains the given item, otherwise false.
//
// @param item [may be null]
//
version.extensions[&quot;Array.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.contains = function(item) {
	return (this.indexOf(item) &gt;= 0);
};

//============================================================================
// Array.containsAny Function
//============================================================================
//
// Returns true when the array contains at least one of the elements
// of the item. Otherwise (or when items contains no elements) false is returned.
//
version.extensions[&quot;Array.containsAny&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAny = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (this.contains(items[i])) {
			return true;
		}
	}
	return false;
};


//============================================================================
// Array.containsAll Function
//============================================================================
//
// Returns true when the array contains all the items, otherwise false.
//
// When items is null false is returned (even if the array contains a null).
//
// @param items [may be null]
//
version.extensions[&quot;Array.containsAll&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAll = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (!this.contains(items[i])) {
			return false;
		}
	}
	return true;
};


} // of &quot;install only once&quot;

// Used Globals (for JSLint) ==============
// ... DOM
/*global 	document */
// ... TiddlyWiki Core
/*global 	convertUnicodeToUTF8, createTiddlyElement, createTiddlyLink,
			displayMessage, endSaveArea, hasClass, loadFile, saveFile,
			startSaveArea, store, wikify */
//}}}


/***
!Licence and Copyright
Copyright (c) abego Software ~GmbH, 2005 ([[www.abego-software.de|http://www.abego-software.de]])

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of abego Software nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
***/

</pre>
</div>
<div title="FunStuff" modifier="SimonBaird" created="200601101230" modified="200601101230" tags="list1Cols" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601101230">
<pre></pre>
</div>
<div title="Groceries" modifier="SimonBaird" created="200601121444" modified="200601121444" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601121444">
<pre>All grocery items</pre>
</div>
<div title="Guacamole" modifier="SimonBaird" created="200601101237" modified="200601121442" tags="Groceries" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601121442">
<pre></pre>
</div>
<div title="HelloWorldMacro" modifier="SimonBaird" created="200601112303" modified="200604062323" tags="systemConfig Plugins CustomisingTiddlyWiki" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604062323">
<pre>/***
|Name|HelloWorldMacro|
|Created by|SimonBaird|
|Location|http://simonbaird.com/mptw/#HelloWorldMacro|
|Version|1.0.3|
|Requires|~TW2.x|
!Description
It's a Hello World TiddlyWiki macro.

!History
* 03-Mar-06, version 1.0.3, added version.extensions data
* 13-Jan-06, version 1.0.2, added shout macro example
* 11-Jan-06, version 1.0.1, updated for ~TW2.0

!Examples
|!Source|!Output|h
|{{{&lt;&lt;helloWorld dude&gt;&gt;}}}|&lt;&lt;helloWorld dude&gt;&gt;|
|{{{&lt;&lt;helloWorld 'to everyone'&gt;&gt;}}}|&lt;&lt;helloWorld 'to everyone'&gt;&gt;|
(You can use (single or double) quotes or double square brackets for params with spaces)

!Notes
This is intended to help you get started with customising your TW. To make the macro work you have to give this tiddler a tag of systemConfig then save and reload. To learn more about customising Tiddlywiki you can look at other people's plugins or click View, Source in your browser and start reading. :)

!Code
***/
//{{{

// this part is not actually required but useful to other people using your plugin
version.extensions.HelloWorldMacro = { major: 1, minor: 0, revision: 3, date: new Date(2006,3,3),
	source: &quot;http://simonbaird.com/mptw/#HelloWorldMacro&quot;
};

config.macros.helloWorld = {};
config.macros.helloWorld.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
	var who = params.length &gt; 0 ? params[0] : &quot;world&quot;;
	wikify(&quot;Hello //&quot; + who + &quot;// from the '&quot; + macroName + &quot;' macro in tiddler [[&quot; + tiddler.title + &quot;]].&quot;, place);
}

// a one liner...
config.macros.shout = { handler: function(place,name,params) { wikify(&quot;//''@@font-size:5em;color:#696;&quot;+ params[0] + &quot;!@@''//&quot;, place); } };


//}}}

/***

!Another example
{{{&lt;&lt;shout Yeah&gt;&gt;}}}

&lt;&lt;shout Yeah&gt;&gt;

***/
</pre>
</div>
<div title="HideSomeTagsMacro" modifier="YourName" created="200608280258" modified="200608280258" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608280258">
<pre>/***
Use in ViewTemplate as a replacment for tags macro
***/
//{{{

config.macros.hideSomeTags = {};

// note: should match config.macros.tagglyListControl.tags
config.macros.hideSomeTags.tagsToHide = [
 &quot;sortByTitle&quot;,
 &quot;sortByCreated&quot;,
 &quot;sortByModified&quot;,
 &quot;sortDesc&quot;,
 &quot;sortAsc&quot;,
 &quot;hideTagged&quot;,
 &quot;showTagged&quot;,
 &quot;noGroupByTag&quot;,
 &quot;groupByTag&quot;,
 &quot;list1Cols&quot;,
 &quot;list2Cols&quot;,
 &quot;list3Cols&quot;,
 &quot;list4Cols&quot;,
 &quot;list5Cols&quot;,
 &quot;list6Cols&quot;,
 &quot;list7Cols&quot;,
 &quot;list8Cols&quot;,
 &quot;list9Cols&quot;
];

// based on tags.handler
config.macros.hideSomeTags.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
 var theList = createTiddlyElement(place,&quot;ul&quot;);
 if(params[0] &amp;&amp; store.tiddlerExists[params[0]])
 tiddler = store.getTiddler(params[0]);
 var lingo = config.views.wikified.tag;
 var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
 createTiddlyElement(theList,&quot;li&quot;,null,&quot;listTitle&quot;,prompt.format([tiddler.title]));
 for(var t=0; t&lt;tiddler.tags.length; t++)
   if (!this.tagsToHide.contains(tiddler.tags[t])) // this is the only difference from tags.handler...
     createTagButton(createTiddlyElement(theList,&quot;li&quot;),tiddler.tags[t],tiddler.title);
}

//}}}
</pre>
</div>
<div title="HideWhen" modifier="SimonBaird" created="200601140320" modified="200603060418" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060418">
<pre>/***
For use in ViewTemplate 
***/
//{{{

config.macros.hideWhen = {};
config.macros.hideWhen.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
 if (eval(params[0]))
 place.style[&quot;display&quot;] = 'none';
}

config.macros.hideUnless = {};
config.macros.hideUnless.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
 if (!eval(params[0]))
 place.style[&quot;display&quot;] = 'none';
}


//}}}</pre>
</div>
<div title="HijackingHowto" modifier="SimonBaird" created="200604062316" modified="200604062342" tags="CustomisingTiddlyWiki" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604062342">
<pre>!Hijacking Functions
This is a trick which lets you write plugins that modify TiddlyWiki's behaviour without replacing entire functions from the standard TiddlyWiki code. This is good because your plugin is less likely to break when Jeremy releases a new version than if you had replaced the entire function. 

The idea comes from TimMorgan who wrote a message about it on TiddlyWikiDev on 6/7/05.  Here's how it works:

First we take a copy of the original out-of-the-box TiddlyWiki function. You can do this in Javascript since functions are objects.
{{{
window.someFunction_original_myplugin = window.someFunction;
}}}
Then we replace the original function with our own function and call the original function. Of course you should have the same number of arguments and (usually) you would pass the arguments through to the original function.
{{{
window.someFunction_original_myplugin = window.someFunction;
window.someFunction = function(title) {
    someFunction_original_myplugin(title);
}
}}}
Now we have effectively &quot;hijacked&quot; the TiddlyWiki function and we can do whatever we want before and/or after the call to the original function. Any bit of code that calls someTiddlerFunction now will not know the difference, ie it will //think// it's calling the normal function but actually it's going to run our new function. So now just do whatever you wanna do, ie:
{{{
window.someFunction_original_myplugin = window.someFunction;
window.someFunction = function(title) {
    // do anything you want here
    title = title.substr(2) + title.substr(1,1) + &quot;ay&quot;; // PigLatinTiddlyWiki?
    // call the original function
    someFunction_original_myplugin(title);
    // do anything you want here
}
}}}
Note that if the function returns something you need to remember to return something (that the caller was expecting). For example:
{{{
window.someFunction_original_myplugin = window.someFunction;
window.someFunction = function(title) {
    // do anything here
    var result = someFunction_original_myplugin(title);
    // do anything here
    return result;
}
}}}
If you had more than one plugin hijacking someFunction they would have to use a different name for storing the original, otherwise they would interfere with each other. So that's why you should use a unique-ish name like someFunction_original_myplugin for each plugin. With unique names many plugins can override the same function, ie, chained hijacking.
{{{
// in plugin 1
window.someFunction_original_myplugin = window.someFunction;
window.someFunction = function(title) {
    // do plugin 1 stuff
    someFunction_original_myplugin(title);
}

// in plugin 2
window.someFunction_original_myotherplugin = window.someFunction;
window.someFunction = function(title) {
    // do plugin 2 stuff
    someFunction_original_myotherplugin(title);
}
}}}
Plugin 2 doesn't actually //know// that it's hijacking an already hijacked function. And as far as I can tell the order that the plugins are loaded doesn't matter (unless the two plugins depend on each other's actions in some way, which you should probably avoid!).

!Hijacking Prototype Methods
(this section by UdoBorkwoski)

Here is an example:
{{{
function Animal(name) {
    this.name = name;
}

Animal.prototype.makeSomeNoise = function() {
    alert(this.name+&quot; says: Bark, Bark&quot;);
}

//------
var scoobyDoo = new Animal(&quot;Scooby Doo&quot;);

scoobyDoo.makeSomeNoise = function() {
    if (confirm(&quot;Must I?&quot;))
        Animal.prototype.makeSomeNoise.apply(this,arguments);
}

scoobyDoo.makeSomeNoise();
}}}
But notice that this solution only &quot;overloads&quot; the function for that one object (scoobyDoo). Any other Animal will still say &quot;Bark, Bark&quot;, without asking.

If one wants to change a prototype function for all objects of a class you need to do this:
{{{
function Animal(name) {
    this.name = name;
}

Animal.prototype.makeSomeNoise = function() {
    alert(this.name+&quot; says: Bark, Bark&quot;);
}

//-------
Animal.prototype.old_makeSomeNoise = Animal.prototype.makeSomeNoise;
Animal.prototype.makeSomeNoise = function() {
    if (confirm(&quot;Must I?&quot;))
        Animal.prototype.old_makeSomeNoise.apply(this,arguments);
}
 
var scoobyDoo = new Animal(&quot;Scooby Doo&quot;);
scoobyDoo.makeSomeNoise();

var pluto = new Animal(&quot;Pluto&quot;);
pluto.makeSomeNoise();
}}}

!Alternative - Hijacking With Closures
This example contributed by Paul Petterson. I've never used this technique but the benefit is that you don't need to worry about using unique names. 

NB, Udo reported this as being a little buggy. Anyone want to send me a tested example?.
{{{
var Hijacker = new Object();
Hijacker.hijack = function(orig,new) {
  var originalMethod = orig;
  return new;
}
originalMethod = Hijacker.hijack(originalMethod, function() {
  // do what you want
  this.originalMethod.apply( this, arguments );
  // do more
});
}}}
It's safe for multiple hijacking because it stores the original function pointer in a local variable so there are never any name collisions. The local variable is kept around because of javascript's wonderful support of closures.

</pre>
</div>
<div title="HorizontalMainMenu" modifier="SimonBaird" created="200601101241" modified="200601101241" tags="FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601101241">
<pre>To make your horizontal main menu like mine:
* Copy my PageTemplate
* Grab the styles in HorizontalMainMenuStyles</pre>
</div>
<div title="HorizontalMainMenuStyles" modifier="Simon" created="200601101028" modified="200607142221" tags="CSS" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607142221">
<pre>/***
To use, add {{{[[HorizontalMainMenuStyles]]}}} to your StyleSheet tiddler, or you can just paste the CSS in directly. See also HorizontalMainMenu and PageTemplate.
***/
/*{{{*/

#topMenu br {display:none; }
#topMenu { background: #069; }
#topMenu { padding:2px; }
#topMenu .button, #topMenu .tiddlyLink {
 margin-left:0.5em; margin-right:0.5em;
 padding-left:3px; padding-right:3px;
 color:white; font-size:115%;
}
#topMenu .button:hover, #topMenu .tiddlyLink:hover { background:#17a;}

#displayArea { margin: 1em 15.7em 0em 1em; } /* so we use the freed up space */

/* just in case want some QuickOpenTags in your topMenu */
#topMenu .quickopentag { padding:0px; margin:0px; border:0px; }
#topMenu .quickopentag .tiddlyLink { padding-right:1px; margin-right:0px; }
#topMenu .quickopentag .button { padding-left:1px; margin-left:0px; border:0px; }

@media print { #topMenu {display: none ! important;} }

/*}}}*/</pre>
</div>
<div title="ImportTiddlersPlugin" modifier="SimonBaird" created="200602140941" modified="200602211529" tags="Borrowed systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602211529">
<pre>/***
''Import Tiddlers Plugin for TiddlyWiki version 1.2.x and 2.0''
^^author: Eric Shulman - ELS Design Studios
source: http://www.TiddlyTools.com/#ImportTiddlersPlugin
license: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^

When many people share and edit copies of the same TiddlyWiki document, the ability to quickly collect all these changes back into a single, updated document that can then be redistributed to the entire group is very important. This plugin lets you selectively combine tiddlers from any two TiddlyWiki documents. It can also be very useful when moving your own tiddlers from document to document (e.g., when upgrading to the latest version of TiddlyWiki, or 'pre-loading' your favorite stylesheets into a new 'empty' TiddlyWiki document.)

!!!!!Inline interface (live)
&lt;&lt;&lt;
&lt;&lt;importTiddlers inline&gt;&gt;
&lt;&lt;&lt;
!!!!!Macro Syntax
&lt;&lt;&lt;
{{{&lt;&lt;importTiddlers&gt;&gt;}}}
creates &quot;import tiddlers&quot; link. click to show/hide import control panel

{{{&lt;&lt;importTiddlers inline&gt;&gt;}}}
creates import control panel directly in tiddler content

{{{&lt;&lt;importTiddlers filter source quiet ask&gt;&gt;}}}
non-interactive 'automatic' import.
''filter'' determines which tiddlers will be automatically selected for importing. Use one of the following keywords:
&gt;''&quot;new&quot;'' retrieves only tiddlers that are found in the import source document, but do not yet exist in the destination document
&gt;''&quot;changes&quot;'' retrieves only tiddlers that exist in both documents for which the import source tiddler is newer than the existing tiddler
&gt;''&quot;updates&quot;'' retrieves both ''new'' and ''changed'' tiddlers (this is the default action when none is specified)
&gt;''&quot;all&quot;'' retrieves ALL tiddlers from the import source document, even if they have not been changed.
''source'' is the location of the imported document. It can be either a local document or an URL:
&gt;filename is any local path/file, in whatever format your system requires
&gt;URL is any remote web location that starts with &quot;http://&quot; or &quot;https://&quot;
''&quot;quiet&quot;'' (optional)
&gt;supresses all status message during the import processing (e.g., &quot;opening local file...&quot;, &quot;found NN tiddlers...&quot; etc). Note that if ANY tiddlers are actualy imported, a final information message will still be displayed (along with the ImportedTiddlers report), even when 'quiet' is specified. This ensures that changes to your document cannot occur without any visible indication at all.
''&quot;ask&quot;'' (optional)
&gt;adds interactive confirmation. A browser message box (OK/Cancel) is displayed for each tiddler that will be imported, so that you can manually bypass any tiddlers that you do not want to import.

''Special tag values: importReplace and importPublic''

By adding these special tags to an existing tiddler, you can precisely control whether or not to allow updates to that tiddler as well as decide which tiddlers in your document can be automatically imported by others.
*''For maximum safety, the default action is to prevent existing tiddlers from being unintentionally overwritten by incoming tiddlers.'' To allow an existing tiddler to be overwritten by an imported tiddler, you must tag the existing tiddler with ''&lt;&lt;tag importReplace&gt;&gt;''
*''For maximum privacy, the default action for //outgoing// tiddlers is to NOT automatically share your tiddlers with others.'' To allow a tiddler in your document to be shared via auto-import actions by others, you must tag it with ''&lt;&lt;tag importPublic&gt;&gt;''
//Note: these tags are only applied when using the auto-import processing. When using the interactive control panel, all tiddlers in the imported document are available in the listbox, regardless of their tag values.//
&lt;&lt;&lt;
!!!!!Interactive Usage
&lt;&lt;&lt;
When used interactively, a control panel is displayed consisting of an &quot;import source document&quot; filename input (text field plus a ''[Browse...]'' button), a listbox of available tiddlers, a &quot;differences only&quot; checkbox, an &quot;add tags&quot; input field and four push buttons: ''[open]'', ''[select all]'', ''[import]'' and ''[close]''.

Press ''[browse]'' to select a TiddlyWiki document file to import. You can also type in the path/filename or a remote document URL (starting with http://)and press ''[open]''. //Note: There may be some delay to permit the browser time to access and load the document before updating the listbox with the titles of all tiddlers that are available to be imported.//

Select one or more titles from the listbox (hold CTRL or SHIFT while clicking to add/remove the highlight from individual list items). You can press ''[select all]'' to quickly highlight all tiddler titles in the list. Use the ''[-]'', ''[+]'', or ''[=]'' links to adjust the listbox size so you can view more (or less) tiddler titles at one time. When you have chosen the tiddlers you want to import and entered any extra tags, press ''[import]'' to begin copying them to the current TiddlyWiki document.

''select: all, new, changes, or differences''

You can click on ''all'', ''new'', ''changes'', or ''differences'' to automatically select a subset of tiddlers from the list. This makes it very quick and easy to find and import just the updated tiddlers you are interested in:
&gt;''&quot;all&quot;'' selects ALL tiddlers from the import source document, even if they have not been changed.
&gt;''&quot;new&quot;'' selects only tiddlers that are found in the import source document, but do not yet exist in the destination document
&gt;''&quot;changes&quot;'' selects only tiddlers that exist in both documents but that are newer in the source document
&gt;''&quot;differences&quot;'' selects all new and existing tiddlers that are different from the destination document (even if destination tiddler is newer)

''Import Tagging:''

Tiddlers that have been imported can be automatically tagged, so they will be easier to find later on, after they have been added to your document. New tags are entered into the &quot;add tags&quot; input field, and then //added// to the existing tags for each tiddler as it is imported.

''Skip, Rename, Merge, or Replace:''

When importing a tiddler whose title is identical to one that already exists, the import process pauses and the tiddler title is displayed in an input field, along with four push buttons: ''[skip]'', ''[rename]'', ''[merge]'' and ''[replace]''.

To bypass importing this tiddler, press ''[skip]''. To import the tiddler with a different name (so that both the tiddlers will exist when the import is done), enter a new title in the input field and then press ''[rename]''. Press ''[merge]'' to combine the content from both tiddlers into a single tiddler. Press ''[replace]'' to overwrite the existing tiddler with the imported one, discarding the previous tiddler content.

//Note: if both the title ''and'' modification date/////time match, the imported tiddler is assumed to be identical to the existing one, and will be automatically skipped (i.e., not imported) without asking.//

''Import Report History''

When tiddlers are imported, a report is generated into ImportedTiddlers, indicating when the latest import was performed, the number of tiddlers successfully imported, from what location, and by whom. It also includes a list with the title, date and author of each tiddler that was imported.

When the import process is completed, the ImportedTiddlers report is automatically displayed for your review. If more tiddlers are subsequently imported, a new report is //added// to ImportedTiddlers, above the previous report (i.e., at the top of the tiddler), so that a reverse-chronological history of imports is maintained.

If a cumulative record is not desired, the ImportedTiddlers report may be deleted at any time. A new ImportedTiddlers report will be created the next time tiddlers are imported.

Note: You can prevent the ImportedTiddlers report from being generated for any given import activity by clearing the &quot;create a report&quot; checkbox before beginning the import processing.

&lt;&lt;&lt;
!!!!!Installation
&lt;&lt;&lt;
copy/paste the following tiddlers into your document:
''ImportTiddlersPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)

create/edit ''SideBarOptions'': (sidebar menu items) 
^^Add &quot;&lt; &lt; ImportTiddlers &gt; &gt;&quot; macro^^

''Quick Installation Tip #1:''
If you are using an unmodified version of TiddlyWiki (core release version &lt;&lt;version&gt;&gt;), you can get a new, empty TiddlyWiki with the Import Tiddlers plugin pre-installed (''[[download from here|TW+ImportExport.html]]''), and then simply import all your content from your old document into this new, empty document.
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2006.02.17 [2.6.0]''
Removed &quot;differences only&quot; listbox display mode, replaced with selection filter 'presets': all/new/changes/differences. Also fixed initialization handling for &quot;add new tags&quot; so that checkbox state is correctly tracked when panel is first displayed.
''2006.02.16 [2.5.4]''
added checkbox options to control &quot;import remote tags&quot; and &quot;keep existing tags&quot; behavior, in addition to existing &quot;add new tags&quot; functionality.
''2006.02.14 [2.5.3]''
FF1501 corrected unintended global 't' (loop index) in importReport() and autoImportTiddlers()
''2006.02.10 [2.5.2]''
corrected unintended global variable in importReport().
''2006.02.05 [2.5.1]''
moved globals from window.* to config.macros.importTiddlers.* to avoid FireFox 1.5.0.1 crash bug when referencing globals
''2006.01.18 [2.5.0]''
added checkbox for &quot;create a report&quot;. Default is to create/update the ImportedTiddlers report. Clear the checkbox to skip this step.
''2006.01.15 [2.4.1]''
added &quot;importPublic&quot; tag and inverted default so that auto sharing is NOT done unless tagged with importPublic
''2006.01.15 [2.4.0]''
Added support for tagging individual tiddlers with importSkip, importReplace, and/or importPrivate to control which tiddlers can be overwritten or shared with others when using auto-import macro syntax. Defaults are to SKIP overwriting existing tiddlers with imported tiddlers, and ALLOW your tiddlers to be auto-imported by others.
''2006.01.15 [2.3.2]''
Added &quot;ask&quot; parameter to confirm each tiddler before importing (for use with auto-importing)
''2006.01.15 [2.3.1]''
Strip TW core scripts from import source content and load just the storeArea into the hidden IFRAME. Makes loading more efficient by reducing the document size and by preventing the import document from executing its TW initialization (including plugins). Seems to resolve the &quot;Found 0 tiddlers&quot; problem. Also, when importing local documents, use convertUTF8ToUnicode() to convert the file contents so support international characters sets.
''2006.01.12 [2.3.0]''
Reorganized code to use callback function for loading import files to support event-driven I/O via an ASYNCHRONOUS XMLHttpRequest. Let's processing continue while waiting for remote hosts to respond to URL requests. Added non-interactive 'batch' macro mode, using parameters to specify which tiddlers to import, and from what document source. Improved error messages and diagnostics, plus an optional 'quiet' switch for batch mode to eliminate //most// feedback.
''2006.01.11 [2.2.0]''
Added &quot;[by tags]&quot; to list of tiddlers, based on code submitted by BradleyMeck
''2006.01.09 [2.1.1]''
When a URL is typed in, and then the &quot;open&quot; button is pressed, it generates both an onChange event for the file input and a click event for open button. This results in multiple XMLHttpRequest()'s which seem to jam things up quite a bit. I removed the onChange handling for file input field. To open a file (local or URL), you must now explicitly press the &quot;open&quot; button in the control panel.
''2006.01.08 [2.1.0]''
IMPORT FROM ANYWHERE!!! re-write getImportedTiddlers() logic to either read a local file (using local I/O), OR... read a remote file, using a combination of XML and an iframe to permit cross-domain reading of DOM elements. Adapted from example code and techniques courtesy of Jonny LeRoy.
''2006.01.06 [2.0.2]''
When refreshing list contents, fixed check for tiddlerExists() when &quot;show differences only&quot; is selected, so that imported tiddlers that don't exist in the current file will be recognized as differences and included in the list.
''2006.01.04 [2.0.1]''
When &quot;show differences only&quot; is NOT checked, import all tiddlers that have been selected even when they have a matching title and date.
''2005.12.27 [2.0.0]''
Update for TW2.0
Defer initial panel creation and only register a notification function when panel first is created
''2005.12.22 [1.3.1]''
tweak formatting in importReport() and add 'discard report' link to output
''2005.12.03 [1.3.0]''
Dynamically create/remove importPanel as needed to ensure only one instance of interface elements exists, even if there are multiple instances of macro embedding. Also, dynamically create/recreate importFrame each time an external TW document is loaded for importation (reduces DOM overhead and ensures a 'fresh' frame for each document)
''2005.11.29 [1.2.1]''
fixed formatting of 'detail info' in importReport()
''2005.11.11 [1.2.0]''
added 'inline' param to embed controls in a tiddler
''2005.11.09 [1.1.0]''
only load HTML and CSS the first time the macro handler is called. Allows for redundant placement of the macro without creating multiple instances of controls with the same ID's.
''2005.10.25 [1.0.5]''
fixed typo in importReport() that prevented reports from being generated
''2005.10.09 [1.0.4]''
combined documentation with plugin code instead of using separate tiddlers
''2005.08.05 [1.0.3]''
moved CSS and HTML definitions into plugin code instead of using separate tiddlers
''2005.07.27 [1.0.2]''
core update 1.2.29: custom overlayStyleSheet() replaced with new core setStylesheet()
''2005.07.23 [1.0.1]''
added parameter checks and corrected addNotification() usage
''2005.07.20 [1.0.0]''
Initial Release
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]
&lt;&lt;&lt;
!!!!!Code
***/

// // Version
//{{{
version.extensions.importTiddlers = {major: 2, minor: 6, revision: 0, date: new Date(2006,2,17)};
//}}}

// // 1.2.x compatibility
//{{{
if (!window.story) window.story=window;
if (!store.getTiddler) store.getTiddler=function(title){return store.tiddlers[title]}
if (!store.addTiddler) store.addTiddler=function(tiddler){store.tiddlers[tiddler.title]=tiddler}
if (!store.deleteTiddler) store.deleteTiddler=function(title){delete store.tiddlers[title]}
//}}}

// // IE needs explicit global scoping for functions/vars called from browser events
//{{{
window.onClickImportButton=onClickImportButton;
window.loadImportFile=loadImportFile;
window.refreshImportList=refreshImportList;
//}}}

// // default cookie/option values
//{{{
if (!config.options.chkImportReport) config.options.chkImportReport=true;
//}}}


// // ''MACRO DEFINITION''

//{{{
config.macros.importTiddlers = { };
config.macros.importTiddlers = {
 label: &quot;import tiddlers&quot;,
 prompt: &quot;Copy tiddlers from another document&quot;,
 countMsg: &quot;%0 tiddlers selected for import&quot;,
 src: &quot;&quot;, // path/filename or URL of document to import
 inbound: null, // hash-indexed array of tiddlers from other document
 newTags: &quot;&quot;, // text of tags added to imported tiddlers
 addTags: true, // add new tags to imported tiddlers
 listsize: 8, // # of lines to show in imported tiddler list
 importTags: true, // include tags from remote source document when importing a tiddler
 keepTags: true, // retain existing tags when replacing a tiddler
 index: 0, // current processing index in import list
 sort: &quot;&quot; // sort order for imported tiddler listbox
};

config.macros.importTiddlers.handler = function(place,macroName,params) {
 // LINK WITH FLOATING PANEL
 if (!params[0]) {
 createTiddlyButton(place,this.label,this.prompt,onClickImportMenu);
 return;
 }
 // INLINE TIDDLER CONTENT
 if (params[0]==&quot;inline&quot;) {
 createImportPanel(place);
 document.getElementById(&quot;importPanel&quot;).style.position=&quot;static&quot;;
 document.getElementById(&quot;importPanel&quot;).style.display=&quot;block&quot;;
 return;
 }
 // NON-INTERACTIVE BATCH MODE
 switch (params[0]) {
 case 'all':
 case 'new':
 case 'changes':
 case 'updates':
 var filter=params.shift();
 break;
 default:
 var filter=&quot;updates&quot;;
 break;
 } 
 if (!params[0]||!params[0].length) return; // filename is required
 config.macros.importTiddlers.src=params.shift();
 var quiet=(params[0]==&quot;quiet&quot;); if (quiet) params.shift();
 var ask=(params[0]==&quot;ask&quot;); if (ask) params.shift();
 config.macros.importTiddlers.inbound=null; // clear the imported tiddler buffer
 // load storeArea from a hidden IFRAME, then apply import rules and add/replace tiddlers
 loadImportFile(config.macros.importTiddlers.src,filter,quiet,ask,autoImportTiddlers);
}
//}}}

// // ''READ TIDDLERS FROM ANOTHER DOCUMENT''

//{{{
function loadImportFile(src,filter,quiet,ask,callback) {
 if (!quiet) clearMessage();
 // LOCAL FILE
 if ((src.substr(0,7)!=&quot;http://&quot;)&amp;&amp;(src.substr(0,8)!=&quot;https://&quot;)) {
 if (!quiet) displayMessage(&quot;Opening local document: &quot;+ src);
 var txt=loadFile(src);
 if(!txt) { if (!quiet) displayMessage(&quot;Could not open local document: &quot;+src); }
 else {
 var s=&quot;&lt;html&gt;&lt;body&gt;&quot;+txt.substr(txt.indexOf('&lt;div id=&quot;storeArea&quot;&gt;'));
 if (!quiet) displayMessage(txt.length+&quot; bytes in document. (&quot;+s.length+&quot; bytes used for tiddler storage)&quot;);
 config.macros.importTiddlers.inbound = readImportedTiddlers(convertUTF8ToUnicode(s));
 var count=config.macros.importTiddlers.inbound?config.macros.importTiddlers.inbound.length:0;
 if (!quiet) displayMessage(&quot;Found &quot;+count+&quot; tiddlers in &quot;+src);
 if (callback) callback(src,filter,quiet,ask);
 }
 return;
 }
 // REMOTE FILE
 var x; // XML object
 try {x = new XMLHttpRequest()}
 catch(e) {
 try {x = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)}
 catch (e) {
 try {x = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)}
 catch (e) { return }
 }
 }
 x.onreadystatechange = function() {
 if (x.readyState == 4) {
 if (x.status == 200) {
 var sa=&quot;&lt;html&gt;&lt;body&gt;&quot;+x.responseText.substr(x.responseText.indexOf('&lt;div id=&quot;storeArea&quot;&gt;'));
 if (!quiet) displayMessage(x.responseText.length+&quot; bytes in document. (&quot;+sa.length+&quot; bytes used for tiddler storage)&quot;);
 config.macros.importTiddlers.inbound = readImportedTiddlers(sa);
 var count=config.macros.importTiddlers.inbound?config.macros.importTiddlers.inbound.length:0;
 if (!quiet) displayMessage(&quot;Found &quot;+count+&quot; tiddlers in &quot;+src);
 if (callback) callback(src,filter,quiet,ask);
 }
 else
 if (!quiet) displayMessage(&quot;Could not open remote document:&quot;+ src+&quot; (error=&quot;+x.status+&quot;)&quot;);
 }
 }
 if (document.location.protocol==&quot;file:&quot;) { // UniversalBrowserRead only works from a local file context
 try {netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead')}
 catch (e) { if (!quiet) displayMessage(e.description?e.description:e.toString()); }
 }
 if (!quiet) displayMessage(&quot;Opening remote document: &quot;+ src);
 try {
 var url=src+(src.indexOf('?')&lt;0?'?':'&amp;')+'nocache='+Math.random();
 x.open(&quot;GET&quot;,url,true);
 x.overrideMimeType('text/html');
 x.send(null);
 }
 catch (e) {
 if (!quiet) {
 displayMessage(&quot;Could not open remote document: &quot;+src);
 displayMessage(e.description?e.description:e.toString());
 }
 }
}

function readImportedTiddlers(txt)
{
 var importedTiddlers = [];
 // create frame
 var f=document.getElementById(&quot;importFrame&quot;);
 if (f) document.body.removeChild(f);
 f=document.createElement(&quot;iframe&quot;);
 f.id=&quot;importFrame&quot;;
 f.style.width=&quot;0px&quot;; f.style.height=&quot;0px&quot;; f.style.border=&quot;0px&quot;;
 document.body.appendChild(f);
 // get document
 var d=f.document;
 if (f.contentDocument) d=f.contentDocument; // For NS6
 else if (f.contentWindow) d=f.contentWindow.document; // For IE5.5 and IE6
 // load source into document
 d.open(); d.writeln(txt); d.close();
 // read tiddler DIVs from storeArea DOM element 
 var importStore = [];
 var importStoreArea = d.getElementById(&quot;storeArea&quot;);
 if (!importStoreArea || !(importStore=importStoreArea.childNodes) || (importStore.length==0)) { return null; }
 importStoreArea.normalize();
 for(var t = 0; t &lt; importStore.length; t++) {
 var e = importStore[t];
 var title = null;
 if(e.getAttribute)
 title = e.getAttribute(&quot;tiddler&quot;);
 if(!title &amp;&amp; e.id &amp;&amp; (e.id.substr(0,5) == &quot;store&quot;))
 title = e.id.substr(5);
 if(title &amp;&amp; title != &quot;&quot;) {
 var theImported = new Tiddler();
 theImported.loadFromDiv(e,title);
 importedTiddlers.push(theImported);
 }
 }
 return importedTiddlers;
}
//}}}

// // ''NON-INTERACTIVE IMPORT''

// // import all/new/changed tiddlers into store, replacing or adding tiddlers as needed
//{{{
function autoImportTiddlers(src,filter,quiet,ask)
{
 var count=0;
 if (config.macros.importTiddlers.inbound) for (var t=0;t&lt;config.macros.importTiddlers.inbound.length;t++) {
 var theImported = config.macros.importTiddlers.inbound[t];
 var theExisting = store.getTiddler(theImported.title);

 // only import tiddlers if tagged with &quot;importPublic&quot;
 if (theImported.tags &amp;&amp; theImported.tags.find(&quot;importPublic&quot;)==null)
 { config.macros.importTiddlers.inbound[t].status=&quot;&quot;; continue; } // status==&quot;&quot; means don't show in report

 // never import the &quot;ImportedTiddlers&quot; history from the other document...
 if (theImported.title=='ImportedTiddlers')
 { config.macros.importTiddlers.inbound[t].status=&quot;&quot;; continue; } // status==&quot;&quot; means don't show in report

 // check existing tiddler for importReplace, or systemConfig tags
 config.macros.importTiddlers.inbound[t].status=&quot;added&quot;; // default - add any tiddlers not filtered out
 if (store.tiddlerExists(theImported.title)) {
 config.macros.importTiddlers.inbound[t].status=&quot;replaced&quot;;
 if (!theExisting.tags||(theExisting.tags.find(&quot;importReplace&quot;)==null))
 { config.macros.importTiddlers.inbound[t].status=&quot;not imported - tiddler already exists (use importReplace to allow changes)&quot;; continue; }
 if ((theExisting.tags.find(&quot;systemConfig&quot;)!=null)||(theImported.tags.find(&quot;systemConfig&quot;)!=null))
 config.macros.importTiddlers.inbound[t].status+=&quot; - WARNING: an active systemConfig plugin has been added or updated&quot;;
 }

 // apply the all/new/changes/updates filter 
 if (filter!=&quot;all&quot;) {
 if ((filter==&quot;new&quot;) &amp;&amp; store.tiddlerExists(theImported.title))
 { config.macros.importTiddlers.inbound[t].status=&quot;not imported - tiddler already exists&quot;; continue; }
 if ((filter==&quot;changes&quot;) &amp;&amp; !store.tiddlerExists(theImported.title))
 { config.macros.importTiddlers.inbound[t].status=&quot;not imported - new tiddler&quot;; continue; }
 if (store.tiddlerExists(theImported.title) &amp;&amp; ((theExisting.modified.getTime()-theImported.modified.getTime())&gt;=0))
 { config.macros.importTiddlers.inbound[t].status=&quot;not imported - tiddler is unchanged&quot;; continue; }
 }

 // get confirmation if required
 if (ask &amp;&amp; !confirm(&quot;Import &quot;+(theExisting?&quot;updated&quot;:&quot;new&quot;)+&quot; tiddler '&quot;+theImported.title+&quot;'\nfrom &quot;+src))
 { config.macros.importTiddlers.inbound[t].status=&quot;skipped - cancelled by user&quot;; continue; }

 // DO THE IMPORT!!
 store.addTiddler(theImported); count++;
 }
 importReport(quiet); // generate a report (as needed) and display it if not 'quiet'
 if (count) store.setDirty(true); 
 // always show final message when tiddlers were actually imported
 if (!quiet||count) displayMessage(&quot;Imported &quot;+count+&quot; tiddler&quot;+(count!=1?&quot;s&quot;:&quot;&quot;)+&quot; from &quot;+src);
}
//}}}

// // ''REPORT GENERATOR''

//{{{
function importReport(quiet)
{
 if (!config.macros.importTiddlers.inbound) return;
 // DEBUG alert('importReport: start');

 // if import was not completed, the Ask panel will still be open... close it now.
 var askpanel=document.getElementById('importAskPanel'); if (askpanel) askpanel.style.display='none'; 
 // get the alphasorted list of tiddlers
 var tiddlers = config.macros.importTiddlers.inbound;
 tiddlers.sort(function (a,b) {if(a['title'] == b['title']) return(0); else return (a['title'] &lt; b['title']) ? -1 : +1; });
 // gather the statistics
 var count=tiddlers.length;
 var added=0; var replaced=0; var renamed=0; var skipped=0; var merged=0;
 for (var t=0; t&lt;count; t++)
 if (tiddlers[t].status)
 {
 if (tiddlers[t].status=='added') added++;
 if (tiddlers[t].status.substr(0,7)=='skipped') skipped++;
 if (tiddlers[t].status.substr(0,6)=='rename') renamed++;
 if (tiddlers[t].status.substr(0,7)=='replace') replaced++;
 if (tiddlers[t].status.substr(0,6)=='merged') merged++;
 }
 var omitted=count-(added+replaced+renamed+skipped+merged);
 // DEBUG alert('stats done: '+count+' total, '+added+' added, '+skipped+' skipped, '+renamed+' renamed, '+replaced+' replaced, '+merged+' merged');
 // skip the report if nothing was imported
 if (added+replaced+renamed+merged==0) return;
 // skip the report if not desired by user
 if (!config.options.chkImportReport) {
 // reset status flags
 for (var t=0; t&lt;count; t++) config.macros.importTiddlers.inbound[t].status=&quot;&quot;;
 // refresh display since tiddlers have been imported
 store.notifyAll();
 // quick message area summary report
 var msg=(added+replaced+renamed+merged)+' of '+count+' tiddler'+((count!=1)?'s':&quot;&quot;);
 msg+=' imported from '+config.macros.importTiddlers.src.replace(/\\/g,'/')
 displayMessage(msg);
 return;
 }
 // create the report tiddler (if not already present)
 var tiddler = store.getTiddler('ImportedTiddlers');
 if (!tiddler) // create new report tiddler if it doesn't exist
 {
 tiddler = new Tiddler();
 tiddler.title = 'ImportedTiddlers';
 tiddler.text = &quot;&quot;;
 }
 // format the report header
 var now = new Date();
 var newText = &quot;&quot;;
 newText += &quot;On &quot;+now.toLocaleString()+&quot;, &quot;+config.options.txtUserName+&quot; imported tiddlers from\n&quot;;
 newText += &quot;[[&quot;+config.macros.importTiddlers.src+&quot;|&quot;+config.macros.importTiddlers.src+&quot;]]:\n&quot;;
 newText += &quot;&lt;&quot;+&quot;&lt;&quot;+&quot;&lt;\n&quot;;
 newText += &quot;Out of &quot;+count+&quot; tiddler&quot;+((count!=1)?&quot;s &quot;:&quot; &quot;)+&quot; in {{{&quot;+config.macros.importTiddlers.src.replace(/\\/g,'/')+&quot;}}}:\n&quot;;
 if (added+renamed&gt;0)
 newText += (added+renamed)+&quot; new tiddler&quot;+(((added+renamed)!=1)?&quot;s were&quot;:&quot; was&quot;)+&quot; added to your document.\n&quot;;
 if (merged&gt;0)
 newText += merged+&quot; tiddler&quot;+((merged!=1)?&quot;s were&quot;:&quot; was&quot;)+&quot; merged with &quot;+((merged!=1)?&quot;&quot;:&quot;an &quot;)+&quot;existing tiddler&quot;+((merged!=1)?&quot;s&quot;:&quot;&quot;)+&quot;.\n&quot;; 
 if (replaced&gt;0)
 newText += replaced+&quot; existing tiddler&quot;+((replaced!=1)?&quot;s were&quot;:&quot; was&quot;)+&quot; replaced.\n&quot;; 
 if (skipped&gt;0)
 newText += skipped+&quot; tiddler&quot;+((skipped!=1)?&quot;s were&quot;:&quot; was&quot;)+&quot; skipped after asking.\n&quot;; 
 if (omitted&gt;0)
 newText += omitted+&quot; tiddler&quot;+((omitted!=1)?&quot;s&quot;:&quot;&quot;)+((omitted!=1)?&quot; were&quot;:&quot; was&quot;)+&quot; not imported.\n&quot;;
 if (config.macros.importTiddlers.addTags &amp;&amp; config.macros.importTiddlers.newTags.trim().length)
 newText += &quot;imported tiddlers were tagged with: \&quot;&quot;+config.macros.importTiddlers.newTags+&quot;\&quot;\n&quot;;
 // output the tiddler detail and reset status flags
 for (var t=0; t&lt;count; t++)
 if (tiddlers[t].status!=&quot;&quot;)
 {
 newText += &quot;#[&quot;+&quot;[&quot;+tiddlers[t].title+&quot;]&quot;+&quot;]&quot;;
 newText += ((tiddlers[t].status!=&quot;added&quot;)?(&quot;^^\n&quot;+tiddlers[t].status+&quot;^^&quot;):&quot;&quot;)+&quot;\n&quot;;
 config.macros.importTiddlers.inbound[t].status=&quot;&quot;;
 }
 newText += &quot;&lt;&quot;+&quot;&lt;&quot;+&quot;&lt;\n&quot;;
 // output 'discard report' link
 newText += &quot;&lt;html&gt;&lt;input type=\&quot;button\&quot; href=\&quot;javascript:;\&quot; &quot;;
 newText += &quot;onclick=\&quot;story.closeTiddler('&quot;+tiddler.title+&quot;'); store.deleteTiddler('&quot;+tiddler.title+&quot;');\&quot; &quot;;
 newText += &quot;value=\&quot;discard report\&quot;&gt;&lt;/html&gt;&quot;;
 // update the ImportedTiddlers content and show the tiddler
 tiddler.text = newText+((tiddler.text!=&quot;&quot;)?'\n----\n':&quot;&quot;)+tiddler.text;
 tiddler.modifier = config.options.txtUserName;
 tiddler.modified = new Date();
 store.addTiddler(tiddler);
 if (!quiet) story.displayTiddler(null,&quot;ImportedTiddlers&quot;,1,null,null,false);
 story.refreshTiddler(&quot;ImportedTiddlers&quot;,1,true);
 // refresh the display
 store.notifyAll();
}
//}}}

// // ''INTERFACE DEFINITION''

// // Handle link click to create/show/hide control panel
//{{{
function onClickImportMenu(e)
{
 if (!e) var e = window.event;
 var parent=resolveTarget(e).parentNode;
 var panel = document.getElementById(&quot;importPanel&quot;);
 if (panel==undefined || panel.parentNode!=parent)
 panel=createImportPanel(parent);
 var isOpen = panel.style.display==&quot;block&quot;;
 if(config.options.chkAnimate)
 anim.startAnimating(new Slider(panel,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));
 else
 panel.style.display = isOpen ? &quot;none&quot; : &quot;block&quot; ;
 e.cancelBubble = true;
 if (e.stopPropagation) e.stopPropagation();
 return(false);
}
//}}}

// // Create control panel: HTML, CSS, register for notification
//{{{
function createImportPanel(place) {
 var panel=document.getElementById(&quot;importPanel&quot;);
 if (panel) { panel.parentNode.removeChild(panel); }
 setStylesheet(config.macros.importTiddlers.css,&quot;importTiddlers&quot;);
 panel=createTiddlyElement(place,&quot;span&quot;,&quot;importPanel&quot;,null,null)
 panel.innerHTML=config.macros.importTiddlers.html;
 store.addNotification(null,refreshImportList); // refresh listbox after every tiddler change
 refreshImportList();
 return panel;
}
//}}}

// // CSS
//{{{
config.macros.importTiddlers.css = '\
#importPanel {\
 display: none; position:absolute; z-index:11; width:35em; right:105%; top:3em;\
 padding: 0.5em; margin:0em; text-align:left; font-size: 8pt;\
 background-color: #eee; color:#000000; \
 border:1px solid black; border-bottom-width: 3px; border-right-width: 3px; -moz-border-radius:1em;\
}\
#importPanel a { color:#009; }\
#importPanel input { width: 98%; margin: 1px; font-size:8pt; }\
#importPanel select { width: 98%; margin: 1px; font-size:8pt; }\
#importPanel .importButton { padding: 0em; margin: 0px; font-size:8pt; }\
#importPanel .importListButton { padding:0em 0.25em 0em 0.25em; color: #000000; display:inline }\
#importAskPanel { display:none; margin:0.5em 0em 0em 0em; }\
';
//}}}

// // HTML
//{{{
config.macros.importTiddlers.html = '\
&lt;span style=&quot;float:left; padding:1px; white-space:nowrap&quot;&gt;\
 import from source document\
&lt;/span&gt;\
&lt;span style=&quot;float:right; padding:1px; white-space:nowrap&quot;&gt;\
 &lt;input type=checkbox id=&quot;chkImportReport&quot; checked style=&quot;height:1em; width:auto&quot;\
 onClick=&quot;config.options[\'chkImportReport\']=this.checked;&quot;&gt;create a report\
&lt;/span&gt;\
&lt;input type=&quot;file&quot; id=&quot;fileImportSource&quot; size=56\
 onKeyUp=&quot;config.macros.importTiddlers.src=this.value&quot;\
 onChange=&quot;config.macros.importTiddlers.src=this.value;&quot;&gt;\
&lt;span style=&quot;float:left; padding:1px; white-space:nowrap&quot;&gt;\
 select:\
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectAll&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;select all tiddlers&quot;&gt;\
 &amp;nbsp;all&amp;nbsp;&lt;/a&gt;\
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectNew&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers not already in destination document&quot;&gt;\
 &amp;nbsp;added&amp;nbsp;&lt;/a&gt; \
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectChanges&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers that have been updated in source document&quot;&gt;\
 &amp;nbsp;changes&amp;nbsp;&lt;/a&gt; \
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectDifferences&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers that have been added or are different from existing tiddlers&quot;&gt;\
 &amp;nbsp;differences&amp;nbsp;&lt;/a&gt; \
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importToggleFilter&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;show/hide selection filter&quot;&gt;\
 &amp;nbsp;filter&amp;nbsp;&lt;/a&gt; \
&lt;/span&gt;\
&lt;span style=&quot;float:right; padding:1px; white-space:nowrap&quot;&gt;\
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListSmaller&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;reduce list size&quot;&gt;\
 &amp;nbsp;&amp;#150;&amp;nbsp;&lt;/a&gt;\
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListLarger&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;increase list size&quot;&gt;\
 &amp;nbsp;+&amp;nbsp;&lt;/a&gt;\
 &lt;a href=&quot;JavaScript:;&quot; id=&quot;importListMaximize&quot;\
 onclick=&quot;onClickImportButton(this)&quot; title=&quot;maximize/restore list size&quot;&gt;\
 &amp;nbsp;=&amp;nbsp;&lt;/a&gt;\
&lt;/span&gt;\
&lt;select id=&quot;importList&quot; size=8 multiple\
 onchange=&quot;setTimeout(\'refreshImportList(\'+this.selectedIndex+\')\',1)&quot;&gt;\
 &lt;!-- NOTE: delay refresh so list is updated AFTER onchange event is handled --&gt;\
&lt;/select&gt;\
&lt;input type=checkbox id=&quot;chkAddTags&quot; checked style=&quot;height:1em; width:auto&quot;\
 onClick=&quot;config.macros.importTiddlers.addTags=this.checked;&quot;&gt;add new tags &amp;nbsp;\
&lt;input type=checkbox id=&quot;chkImportTags&quot; checked style=&quot;height:1em; width:auto&quot;\
 onClick=&quot;config.macros.importTiddlers.importTags=this.checked;&quot;&gt;import source tags &amp;nbsp;\
&lt;input type=checkbox id=&quot;chkKeepTags&quot; checked style=&quot;height:1em; width:auto&quot;\
 onClick=&quot;config.macros.importTiddlers.keepTags=this.checked;&quot;&gt;keep existing tags\
&lt;input type=text id=&quot;txtNewTags&quot; size=15 onKeyUp=&quot;config.macros.importTiddlers.newTags=this.value&quot; autocomplete=off&gt;\
&lt;div align=center&gt;\
 &lt;input type=button id=&quot;importOpen&quot; class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;open&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;input type=button id=&quot;importStart&quot; class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;import&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;input type=button id=&quot;importClose&quot; class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;close&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
&lt;/div&gt;\
&lt;div id=&quot;importAskPanel&quot;&gt;\
 tiddler already exists:\
 &lt;input type=text id=&quot;importNewTitle&quot; size=15 autocomplete=off&quot;&gt;\
 &lt;div align=center&gt;\
 &lt;input type=button id=&quot;importSkip&quot; class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;skip&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;input type=button id=&quot;importRename&quot; class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;rename&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;input type=button id=&quot;importMerge&quot; class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;merge&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;input type=button id=&quot;importReplace&quot; class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;replace&quot;\
 onclick=&quot;onClickImportButton(this)&quot;&gt;\
 &lt;/div&gt;\
&lt;/div&gt;\
';
//}}}

// // refresh listbox
//{{{
function refreshImportList(selectedIndex)
{
 var theList = document.getElementById(&quot;importList&quot;);
 if (!theList) return;
 // if nothing to show, reset list content and size
 if (!config.macros.importTiddlers.inbound) 
 {
 while (theList.length &gt; 0) { theList.options[0] = null; }
 theList.options[0]=new Option('please open a document...',&quot;&quot;,false,false);
 theList.size=config.macros.importTiddlers.listsize;
 return;
 }
 // get the sort order
 if (!selectedIndex) selectedIndex=0;
 if (selectedIndex==0) config.macros.importTiddlers.sort='title'; // heading
 if (selectedIndex==1) config.macros.importTiddlers.sort='title';
 if (selectedIndex==2) config.macros.importTiddlers.sort='modified';
 if (selectedIndex==3) config.macros.importTiddlers.sort='tags';
 if (selectedIndex&gt;3) {
 // display selected tiddler count
 for (var t=0,count=0; t &lt; theList.options.length; t++) count+=(theList.options[t].selected&amp;&amp;theList.options[t].value!=&quot;&quot;)?1:0;
 clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));
 return; // no refresh needed
 }

 // get the alphasorted list of tiddlers (optionally, filter out unchanged tiddlers)
 var tiddlers=config.macros.importTiddlers.inbound;
 tiddlers.sort(function (a,b) {if(a['title'] == b['title']) return(0); else return (a['title'] &lt; b['title']) ? -1 : +1; });
 // clear current list contents
 while (theList.length &gt; 0) { theList.options[0] = null; }
 // add heading and control items to list
 var i=0;
 var indent=String.fromCharCode(160)+String.fromCharCode(160);
 theList.options[i++]=new Option(tiddlers.length+' tiddler'+((tiddlers.length!=1)?'s are':' is')+' in the document',&quot;&quot;,false,false);
 theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;title&quot; )?&quot;&gt;&quot;:indent)+' [by title]',&quot;&quot;,false,false);
 theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;modified&quot;)?&quot;&gt;&quot;:indent)+' [by date]',&quot;&quot;,false,false);
 theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;tags&quot;)?&quot;&gt;&quot;:indent)+' [by tags]',&quot;&quot;,false,false);
 // output the tiddler list
 switch(config.macros.importTiddlers.sort)
 {
 case &quot;title&quot;:
 for(var t = 0; t &lt; tiddlers.length; t++)
 theList.options[i++] = new Option(tiddlers[t].title,tiddlers[t].title,false,false);
 break;
 case &quot;modified&quot;:
 // sort descending for newest date first
 tiddlers.sort(function (a,b) {if(a['modified'] == b['modified']) return(0); else return (a['modified'] &gt; b['modified']) ? -1 : +1; });
 var lastSection = &quot;&quot;;
 for(var t = 0; t &lt; tiddlers.length; t++) {
 var tiddler = tiddlers[t];
 var theSection = tiddler.modified.toLocaleDateString();
 if (theSection != lastSection) {
 theList.options[i++] = new Option(theSection,&quot;&quot;,false,false);
 lastSection = theSection;
 }
 theList.options[i++] = new Option(indent+indent+tiddler.title,tiddler.title,false,false);
 }
 break;
 case &quot;tags&quot;:
 var theTitles = {}; // all tiddler titles, hash indexed by tag value
 var theTags = new Array();
 for(var t=0; t&lt;tiddlers.length; t++) {
 var title=tiddlers[t].title;
 var tags=tiddlers[t].tags;
 for(var s=0; s&lt;tags.length; s++) {
 if (theTitles[tags[s]]==undefined) { theTags.push(tags[s]); theTitles[tags[s]]=new Array(); }
 theTitles[tags[s]].push(title);
 }
 }
 theTags.sort();
 for(var tagindex=0; tagindex&lt;theTags.length; tagindex++) {
 var theTag=theTags[tagindex];
 theList.options[i++]=new Option(theTag,&quot;&quot;,false,false);
 for(var t=0; t&lt;theTitles[theTag].length; t++)
 theList.options[i++]=new Option(indent+indent+theTitles[theTag][t],theTitles[theTag][t],false,false);
 }
 break;
 }
 theList.selectedIndex=selectedIndex; // select current control item
 if (theList.size&lt;config.macros.importTiddlers.listsize) theList.size=config.macros.importTiddlers.listsize;
 if (theList.size&gt;theList.options.length) theList.size=theList.options.length;
}
//}}}

// // Control interactions
//{{{
function onClickImportButton(which)
{
 // DEBUG alert(which.id);
 var theList = document.getElementById('importList');
 if (!theList) return;
 var thePanel = document.getElementById('importPanel');
 var theAskPanel = document.getElementById('importAskPanel');
 var theNewTitle = document.getElementById('importNewTitle');
 var count=0;
 switch (which.id)
 {
 case 'fileImportSource':
 case 'importOpen': // load import source into hidden frame
 importReport(); // if an import was in progress, generate a report
 config.macros.importTiddlers.inbound=null; // clear the imported tiddler buffer
 refreshImportList(); // reset/resize the listbox
 if (config.macros.importTiddlers.src==&quot;&quot;) break;
 // Load document into hidden iframe so we can read it's DOM and fill the list
 loadImportFile(config.macros.importTiddlers.src,&quot;all&quot;,null,null,function(src,filter,quiet,ask){window.refreshImportList(0);});
 break;
 case 'importSelectAll': // select all tiddler list items (i.e., not headings)
 importReport(); // if an import was in progress, generate a report
 for (var t=0,count=0; t &lt; theList.options.length; t++) {
 if (theList.options[t].value==&quot;&quot;) continue;
 theList.options[t].selected=true;
 count++;
 }
 clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));
 break;
 case 'importSelectNew': // select tiddlers not in current document
 importReport(); // if an import was in progress, generate a report
 for (var t=0,count=0; t &lt; theList.options.length; t++) {
 theList.options[t].selected=false;
 if (theList.options[t].value==&quot;&quot;) continue;
 theList.options[t].selected=!store.tiddlerExists(theList.options[t].value);
 count+=theList.options[t].selected?1:0;
 }
 clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));
 break;
 case 'importSelectChanges': // select tiddlers that are updated from existing tiddlers
 importReport(); // if an import was in progress, generate a report
 for (var t=0,count=0; t &lt; theList.options.length; t++) {
 theList.options[t].selected=false;
 if (theList.options[t].value==&quot;&quot;||!store.tiddlerExists(theList.options[t].value)) continue;
 for (var i=0; i&lt;config.macros.importTiddlers.inbound.length; i++) // find matching inbound tiddler
 { var inbound=config.macros.importTiddlers.inbound[i]; if (inbound.title==theList.options[t].value) break; }
 theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified&gt;0); // updated tiddler
 count+=theList.options[t].selected?1:0;
 }
 clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));
 break;
 case 'importSelectDifferences': // select tiddlers that are new or different from existing tiddlers
 importReport(); // if an import was in progress, generate a report
 for (var t=0,count=0; t &lt; theList.options.length; t++) {
 theList.options[t].selected=false;
 if (theList.options[t].value==&quot;&quot;) continue;
 if (!store.tiddlerExists(theList.options[t].value)) { theList.options[t].selected=true; count++; continue; }
 for (var i=0; i&lt;config.macros.importTiddlers.inbound.length; i++) // find matching inbound tiddler
 { var inbound=config.macros.importTiddlers.inbound[i]; if (inbound.title==theList.options[t].value) break; }
 theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified!=0); // changed tiddler
 count+=theList.options[t].selected?1:0;
 }
 clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));
 break;
 case 'importToggleFilter': // show/hide filter
 case 'importFilter': // apply filter
 alert(&quot;coming soon!&quot;);
 break;
 case 'importStart': // initiate the import processing
 importReport(); // if an import was in progress, generate a report
 config.macros.importTiddlers.index=0;
 config.macros.importTiddlers.index=importTiddlers(0);
 importStopped();
 break;
 case 'importClose': // unload imported tiddlers or hide the import control panel
 // if imported tiddlers not loaded, close the import control panel
 if (!config.macros.importTiddlers.inbound) { thePanel.style.display='none'; break; }
 importReport(); // if an import was in progress, generate a report
 config.macros.importTiddlers.inbound=null; // clear the imported tiddler buffer
 refreshImportList(); // reset/resize the listbox
 break;
 case 'importSkip': // don't import the tiddler
 var theItem = theList.options[config.macros.importTiddlers.index];
 for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)
 if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;
 var theImported = config.macros.importTiddlers.inbound[j];
 theImported.status='skipped after asking'; // mark item as skipped
 theAskPanel.style.display='none';
 config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index+1); // resume with NEXT item
 importStopped();
 break;
 case 'importRename': // change name of imported tiddler
 var theItem = theList.options[config.macros.importTiddlers.index];
 for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)
 if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;
 var theImported = config.macros.importTiddlers.inbound[j];
 theImported.status = 'renamed from '+theImported.title; // mark item as renamed
 theImported.set(theNewTitle.value,null,null,null,null); // change the tiddler title
 theItem.value = theNewTitle.value; // change the listbox item text
 theItem.text = theNewTitle.value; // change the listbox item text
 theAskPanel.style.display='none';
 config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index); // resume with THIS item
 importStopped();
 break;
 case 'importMerge': // join existing and imported tiddler content
 var theItem = theList.options[config.macros.importTiddlers.index];
 for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)
 if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;
 var theImported = config.macros.importTiddlers.inbound[j];
 var theExisting = store.getTiddler(theItem.value);
 var theText = theExisting.text+'\n----\n^^merged from: [['+config.macros.importTiddlers.src+'#'+theItem.value+'|'+config.macros.importTiddlers.src+'#'+theItem.value+']]^^\n^^'+theImported.modified.toLocaleString()+' by '+theImported.modifier+'^^\n'+theImported.text;
 var theDate = new Date();
 var theTags = theExisting.getTags()+' '+theImported.getTags();
 theImported.set(null,theText,null,theDate,theTags);
 theImported.status = 'merged with '+theExisting.title; // mark item as merged
 theImported.status += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY hh:mm:ss&quot;);
 theImported.status += ' by '+theExisting.modifier;
 theAskPanel.style.display='none';
 config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index); // resume with this item
 importStopped();
 break;
 case 'importReplace': // substitute imported tiddler for existing tiddler
 var theItem = theList.options[config.macros.importTiddlers.index];
 for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)
 if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;
 var theImported = config.macros.importTiddlers.inbound[j];
 var theExisting = store.getTiddler(theItem.value);
 theImported.status = 'replaces '+theExisting.title; // mark item for replace
 theImported.status += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY hh:mm:ss&quot;);
 theImported.status += ' by '+theExisting.modifier;
 theAskPanel.style.display='none';
 config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index); // resume with THIS item
 importStopped();
 break;
 case 'importListSmaller': // decrease current listbox size, minimum=5
 if (theList.options.length==1) break;
 theList.size-=(theList.size&gt;5)?1:0;
 config.macros.importTiddlers.listsize=theList.size;
 break;
 case 'importListLarger': // increase current listbox size, maximum=number of items in list
 if (theList.options.length==1) break;
 theList.size+=(theList.size&lt;theList.options.length)?1:0;
 config.macros.importTiddlers.listsize=theList.size;
 break;
 case 'importListMaximize': // toggle listbox size between current and maximum
 if (theList.options.length==1) break;
 theList.size=(theList.size==theList.options.length)?config.macros.importTiddlers.listsize:theList.options.length;
 break;
 }
}
//}}}

// // re-entrant processing for handling import with interactive collision prompting
//{{{
function importTiddlers(startIndex)
{
 if (!config.macros.importTiddlers.inbound) return -1;

 var theList = document.getElementById('importList');
 if (!theList) return;
 var t;
 // if starting new import, reset import status flags
 if (startIndex==0)
 for (var t=0;t&lt;config.macros.importTiddlers.inbound.length;t++)
 config.macros.importTiddlers.inbound[t].status=&quot;&quot;;
 for (var i=startIndex; i&lt;theList.options.length; i++)
 {
 // if list item is not selected or is a heading (i.e., has no value), skip it
 if ((!theList.options[i].selected) || ((t=theList.options[i].value)==&quot;&quot;))
 continue;
 for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)
 if (config.macros.importTiddlers.inbound[j].title==t) break;
 var theImported = config.macros.importTiddlers.inbound[j];
 var theExisting = store.getTiddler(theImported.title);
 // avoid redundant import for tiddlers that are listed multiple times (when 'by tags')
 if (theImported.status==&quot;added&quot;)
 continue;
 // don't import the &quot;ImportedTiddlers&quot; history from the other document...
 if (theImported.title=='ImportedTiddlers')
 continue;
 // if tiddler exists and import not marked for replace or merge, stop importing
 if (theExisting &amp;&amp; (theImported.status.substr(0,7)!=&quot;replace&quot;) &amp;&amp; (theImported.status.substr(0,5)!=&quot;merge&quot;))
 return i;
 // assemble tags (remote + existing + added)
 var newTags = &quot;&quot;;
 if (config.macros.importTiddlers.importTags)
 newTags+=theImported.getTags() // import remote tags
 if (config.macros.importTiddlers.keepTags &amp;&amp; theExisting)
 newTags+=&quot; &quot;+theExisting.getTags(); // keep existing tags
 if (config.macros.importTiddlers.addTags &amp;&amp; config.macros.importTiddlers.newTags.trim().length)
 newTags+=&quot; &quot;+config.macros.importTiddlers.newTags; // add new tags
 theImported.set(null,null,null,null,newTags.trim());
 // set the status to 'added' (if not already set by the 'ask the user' UI)
 theImported.status=(theImported.status==&quot;&quot;)?'added':theImported.status;
 // do the import!
 store.addTiddler(theImported);
 store.setDirty(true);
 }
 return(-1); // signals that we really finished the entire list
}
//}}}

//{{{
function importStopped()
{
 var theList = document.getElementById('importList');
 var theNewTitle = document.getElementById('importNewTitle');
 if (!theList) return;
 if (config.macros.importTiddlers.index==-1)
 importReport(); // import finished... generate the report
 else
 {
 // DEBUG alert('import stopped at: '+config.macros.importTiddlers.index);
 // import collision... show the ask panel and set the title edit field
 document.getElementById('importAskPanel').style.display='block';
 theNewTitle.value=theList.options[config.macros.importTiddlers.index].value;
 }
}
//}}}
</pre>
</div>
<div title="Installed_Plugins" creator="YourName" modifier="YourName" created="202507091947" modified="202507121540" changecount="2">
<pre>[
&lt;&lt;forEachTiddler 
where 
'tiddler.tags.contains(&quot;systemConfig&quot;)'
sortBy
'tiddler.title'
write 
'&quot;{&quot;
+&quot;\n&quot;
+&quot;\&quot;url\&quot;: \&quot;https://github.com/wangyenshu/TiddlyWikiClassicPluginsArchives/blob/main/MartinsPlugins/&quot;
+tiddler.title
+&quot;.js&quot;
+&quot;\&quot;,&quot;
+&quot;\n&quot;
+&quot;\&quot;description\&quot;: \&quot;&quot;
+tiddler.title
+&quot;\&quot;&quot;
+&quot;\n&quot;
+&quot;},&quot;
+&quot;\n&quot;'
&gt;&gt;]</pre>
</div>
<div title="InstantTimestamp" modifier="SimonBaird" created="200604041457" modified="200604070239" tags="Plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604070239">
<pre>/***
| Name:|InstantTimestamp|
| Created by:|SimonBaird|
| Location:|http://simonbaird.com/mptw/#InstantTimestamp|
| Version:|1.0.4 (06-Apr-2006)|
| Requires:|~TW2.x|
!Description
If you enter {ts} in your tiddler content (without the spaces) it will be replaced with a timestamp when you save the tiddler. Full list:
* {ts} or {t} -&gt; timestamp
* {ds} or {d} -&gt; datestamp
* !ts or !t at start of line -&gt; !!timestamp
* !ds or !d at start of line -&gt; !!datestamp
(I added the extra ! since that's how I like it. Remove it from translations below if required)
!Notes
* Change the timeFormat and dateFormat below to suit your preference.
* See also AutoCorrectPlugin
!History
* 06-Apr-06, version 1.0.4
** removed the AutoCorrect stuff and put it in AutoCorrectPlugin
* 05-Apr-06, version 1.0.3
** now have exclusion by tag and tiddler name, probably less important here than in AutoCorrectPlugin
* 05-Apr-06, version 1.0.2
** put matches into array to and eval them to allow generic substitutions
* 05-Apr-06, version 1.0.1
** added ds for datestamp as suggested by DanielBaird
** made case insensitive
** Added translation for !t at start of line
* 05-Apr-06, version 1.0.0
** written after suggestion by Achim Wessling 
!Code
***/
//{{{

version.extensions.InstantTimestamp = { major: 1, minor: 0, revision: 4, date: new Date(2006,4,6),
	source: &quot;http://simonbaird.com/mptw/#InstantTimestamp&quot;
};

config.InstantTimestamp = {

	timeFormat: 'DD/0MM/YY 0hh:0mm',
	dateFormat: 'DD/0MM/YY',

	translations: [
		[/^!ts?$/img,  &quot;'!!'+now.formatString(config.InstantTimestamp.timeFormat)&quot;],
		[/^!ds?$/img,  &quot;'!!'+now.formatString(config.InstantTimestamp.dateFormat)&quot;],
		[/\{ts?\}/ig, &quot;now.formatString(config.InstantTimestamp.timeFormat)&quot;],
		[/\{ds?\}/ig, &quot;now.formatString(config.InstantTimestamp.dateFormat)&quot;]
	],
	excludeTags: [
		&quot;noAutoCorrect&quot;,
		&quot;CSS&quot;,
		&quot;css&quot;,
		&quot;systemConfig&quot;,
		&quot;zsystemConfig&quot;,
		&quot;Plugins&quot;,
		&quot;Plugin&quot;,
		&quot;plugins&quot;,
		&quot;plugin&quot;,
		&quot;javascript&quot;,
		&quot;code&quot;
	],
	excludeTiddlers: [
		&quot;StyleSheet&quot;,
		&quot;StyleSheetLayout&quot;,
		&quot;StyleSheetColors&quot;,
		&quot;StyleSheetPrint&quot;
	]
}; 

if (!Array.prototype.contains)
	Array.prototype.contains = function(item) {
		return (this.find(item) != null);
	};

if (!Array.prototype.containsAny)
	Array.prototype.containsAny = function(items) {
		for (var i=0;i&lt;items.length;i++)
			if (this.contains(items[i]))
				return true;
		return false;
	};

TiddlyWiki.prototype.saveTiddler_mptw_instanttimestamp = TiddlyWiki.prototype.saveTiddler;
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags) {

	tags = (typeof(tags) == &quot;string&quot;) ? tags.readBracketedList() : tags;
	var conf = config.InstantTimestamp;

	if ( !tags.containsAny(conf.excludeTags) 
			&amp;&amp; !conf.excludeTiddlers.contains(newTitle) ) {

		var now = new Date();
		var trans = config.InstantTimestamp.translations;
		for (var i=0;i&lt;trans.length;i++) {
			newBody = newBody.replace(trans[i][0], eval(trans[i][1]));
		}
	}

	return this.saveTiddler_mptw_instanttimestamp(title,newTitle,newBody,modifier,modified,tags);
}

//}}}
</pre>
</div>
<div title="KubrickTheme" modifier="SimonBaird" created="200604260521" modified="200604271318" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604271318">
<pre>/***
[img[preview|http://simonbaird.com/images/kubrickpreview.gif]]
&lt;&lt;applyTheme Kubrick 'Apply this theme now'&gt;&gt;

By ClintChecketts, based on the famous ~WordPress theme. Requires these in your current directory:
*[[kubrickheader.jpg|kubrickheader.jpg]]
*[[kubrickfooter.jpg|kubrickfooter.jpg]]
*[[kubrickbg.jpg|kubrickbg.jpg]]
Install like a plugin, ie tag with systemConfig then save and reload.
Requires SelectThemePlugin.
***/
//{{{
if (!config.themes) config.themes = [];

config.shadowTiddlers.KubrickPageTemplate = &quot;&lt;div class='header'&gt;\n&lt;div class='titleLine'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt; \n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='sidebar'&gt;&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;div id='sidebarCopyright' refresh='content' tiddler='Copyright'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='contentFooter'&gt;&lt;p&gt;TiddlyWiki was created by &lt;a href='http://tiddlywiki.com'&gt;Jeremy Ruston&lt;/a&gt; and TiddlyKubrick was created by &lt;a href='http://checkettsweb.com'&gt;Clint Checketts&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&quot;;

config.shadowTiddlers.KubrickStyleSheet = &quot;/***\nStyleSheet General Rules\n***/\n/*{{{*/\na,\n.button{\n color: #06c;\n text-decoration: none;\n background: transparent;\n}\n\na:hover,\n.button:hover{\n background: transparent;\n text-decoration: none;\n color: #147;\n}\n\nbody {\n font-size: 15px; /* Resets 1em to 10px */\n font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;\n background-color: #d5d6d7;\n color: #666;\n  margin: 0 auto;\n}\n\n#contentWrapper{\n background: transparent url(\&quot;kubrickbg.jpg\&quot;) repeat-y 0px 0px;\n border: 0;\n margin: 0 auto;\n width: 760px;\n}\n/*}}}*/\n\n/***\nHeader Rules\n***/\n/*{{{*/\n.titleLine{\n margin: 80px auto 0em;\n padding: 0;\n width: 745px;\n text-align: center;\n color: #fff;\n}\n\n.siteTitle{\n font-size: 30px;\n}\n\n.siteTitle a, .siteSubtitle a{\n color: #fff;\n}\n\n.siteTitle a:hover, .siteSubtitle a:hover{\n text-decoration: none;\n font-weight: normal;\n}\n\n.siteSubtitle{\n display: block;\n margin: 58px 0 0 0;\n font-size: 15px;\n}\n\n.header {\n background: url(\&quot;kubrickheader.jpg\&quot;) no-repeat bottom center; \n margin: 0;\n padding: 1px;\n height: 198px;\n width: 758px;\n\n}\n/*}}}*/\n\n/***\nFooter Styles\n***/\n/*{{{*/\n#contentFooter {\n text-align: center;\n clear: both;\n background: url(\&quot;kubrickfooter.jpg\&quot;) no-repeat bottom;\n border: none;\n padding: 2em;\n height: 3em;\n}\n/*}}}*/\n\n/***\nSidebar styles\n***/\n/*{{{*/\n#sidebar{\n margin: 1em 2em 0 0;\n position: static;\n float: right;\n}\n\n#sidebar a,\n#sidebar a:hover{\n border: 0;\n}\n\n#sidebar h1{\n font-size: 1.4em;\n font-weight: bold;\n margin: 0;\n background: transparent;\n color: #000;\n}\n\n#sidebar ul{\n padding: 0;\n margin: 0 0 0 1em;\n}\n\n#sidebar li{\n list-style: none;\n}\n\n#sidebar li:before{\n color: #000;\n content: \&quot;\s00BB \s0020\&quot;;\n}\n\n#sidebar, #mainMenu, #sideBarOptions{\n width: 200px;\n text-align: left;\n}\n\n#mainMenu{\n position: static;\n}\n/*}}}*/\n\n/***\nSidebar search styles\n***/\n/*{{{*/\n#sidebarSearch{\n margin: 20px 0 0 10px;\n width: 155px;\n}\n\n#sidebarSearch input{\n font-size: 15px;\n width: 120px;\n}\n\n#sidebarSearch .button{\n margin-top: 1px;\n}\n/*}}}*/\n\n/***\nSidebar option styles\n***/\n/*{{{*/\n#sidebarOptions{\n margin-left: .75em;\n}\n\n#sidebarOptions h1{\n font-size: 1.3em;\n}\n\n#sidebarOptions a{\n display: block; // was inline \n border: 0;\n}\n\n#sidebarOptions .sliderPanel{\n background-color: transparent;\n font-size: 1em;\n margin: 0;\n}\n\n#sidebarOptions .sliderPanel a:before,\n#sidebarTabs li:before{\n content: \&quot;\&quot;;\n}\n/*}}}*/\n/***\nSidebar tab styles\n***/\n/*{{{*/\n#sidebarTabs .tab,\n#sidebarTabs .tab:hover{\n border: 1px solid #ccc;\n text-decoration: none;\n}\n\n#sidebarTabs .tabSelected{\n background: #ccc;\n color: #333;\n}\n\n#sidebarTabs .tabUnselected{\n background: #e6e6e6;\n color: #333;\n}\n\n#sidebarTabs .tabContents{\n background: #ccc;\n color: #333;\n border: 1px solid #ccc;\n width: 95%;\n}\n\n#sidebarTabs .tabContents a{\n color: #06c;\n}\n\n#sidebarTabs .tabContents a:hover{\n color: #147;\n\n}\n\n#sidebarTabs a.tabSelected:hover{\n cursor: default;\n}\n\n#sidebarTabs .txtMoreTab .tab{\n border: 1px solid #aaa;\n color: #333;\n}\n\n#sidebarTabs .txtMoreTab .tabSelected{\n background: #aaa;\n color: #333;\n}\n\n#sidebarTabs .txtMoreTab .tabSelected:hover{\n background: #aaa;\n color: #333\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected{\n background: #ccc;\n color: #333;\n}\n\n#contentWrapper #sidebar .txtMoreTab .tabUnselected:hover,#contentWrapper #displayArea .txtMoreTab .tabUnselected:hover{\n color: #333;\n}\n\n#contentWrapper .txtMoreTab .tabContents{\n background: #aaa;\n color: #333;\n border: 1px solid #aaa;\n}\n/*}}}*/\n/***\nMessage area styles\n***/\n/*{{{*/\n#messageArea {\nbackground-color: #eee;\n border: 1px solid #ccc;\n color: #bbb;\n margin: 0 1em;\n font-size: .8em;\n}\n\n#messageArea a:link{\n color: #aaa;\n}\n#messageArea a:hover{\n color: #06c;\n}\n\n#messageArea .messageToolbar .button{\n border: 1px solid #ccc;\n color: #aaa;\n text-decoration: none;\n}\n#messageArea .messageToolbar .button:hover{\n border: 1px solid #777;\n color: #777;\n}\n/*}}}*/\n/***\nPopup styles\n***/\n/*{{{*/\n#popup{\n padding: 0;\n background: #eee;\n border: 1px solid #ccc;\n color: #333;\n}\n\n#popup a{\n color: #06c;\n font-weight: normal;\n}\n\n#popup a:hover{\n color: #fff;\n background: #aaa;\n text-decoration: none;\n}\n/*}}}*/\n/***\nTiddler display styles\n***/\n/*{{{*/\n#displayArea{\n margin: 10px 245px 1em 30px;\n text-align: left;\n font-size: 15px;\n color: #000;\n}\n\nh1, h2, h3, h4, h5, .title{\n font-family: 'Trebuchet MS', 'Lucida Grande', Verdana, Arial, Sans-Serif;\ncolor: #333;\npadding: 0;\n}\n\n.viewer h1,.viewer h2,.viewer h3,.viewer h4,.viewer h5,.viewer h6{\n background: transparent;\n border-bottom: 1px dotted #ccc;\n}\n\n.title{\n font-size: 20px; \n}\n\n.subtitle{\n color: #999;\n font-size: 12px;\n}\n\n.toolbar{\n font-size: 11px;\n}\n\n.toolbar a:link,.toolbar a:visited{\n background: #e6e6e6;\n border: 1px solid #ccc;\n color: #aaa;\n padding: 1px 3px;\n margin: 0 .5em 0 0;\n}\n\n.toolbar a.button:hover{\n background: #eee;\n border-color: #ddd;\n color: #ccc;\n text-decoration: none;\n}\n\n.viewer a.tiddlyLinkNonExisting:link{\n color: #b85b5a;\n font-style: normal;\n}\n\n.viewer a.tiddlyLinkNonExisting:hover{\n text-decoration: none; \n}\n\n.viewer a.tiddlyLinkExisting:link,#displayArea .viewer a.externalLink{\n font-weight: normal;\n color: #06c;\n}\n\n.viewer a.tiddlyLinkExisting:hover,.viewer a.externalLink:hover{\n color: #147;\n text-decoration: none; \n}\n\n.viewer {\n font-size: 15px;\n line-height: 160%;\n padding-top: 0.5em;\n}\n\n.viewer code {\n font-size: 12px;\n}\n\n.viewer .button{\n \n font-size: 15px;\n}\n\n.editor {\n font-size: 15px;\n color: #ooo;\n line-height: 160%;\n}\n\n.editor input, .editor textarea {\n display: block;\n width: 100%;\n font: inherit;\n}\n\n.footer, .footer a.button,.editorFooter, .footer a.button{\n color: #aaa;\n}\n\n.selectedTiddler .footer,.selectedTiddler .footer a{\n color: #777;\n}\n\n.selectedTiddler .footer a.button,.selectedTiddler .editorFooter a.button{\n color: #06c;\n}\n\n.footer a.button:hover,.editorFooter a.button:hover{\n color: #147;\n background: transparent;\n} \n\n.tagClear{\n clear: none; \n}\n/*}}}*/&quot;;

config.themes.push(&quot;Kubrick&quot;);
//}}}

</pre>
</div>
<div title="Licence" modifier="SimonBaird" created="200603091447" modified="200603091453" tags="More..." server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091453">
<pre>My plugins are published under the same license as TiddlyWiki. See http://www.tiddlywiki.com/#OpenSourceLicense for more info.</pre>
</div>
<div title="Low" modifier="SimonBaird" created="200604041725" modified="200604041725" tags="Priority" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041725">
<pre></pre>
</div>
<div title="Make SiteMap tree display a Taggly list option" modifier="SimonBaird" created="200603100057" modified="200603100058" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603100058">
<pre>And be able to increase/decrease the depth as suggested by Daniel.</pre>
</div>
<div title="Meeting" modifier="SimonBaird" created="200602161132" modified="200602161134" tags="Meetings TiddlerTemplates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161134">
<pre>| When:| insert |
| Where:| insert |
| Who:| insert |
!Notes

/% how about a &lt;&lt;reminder day: month: &gt;&gt; %/
</pre>
</div>
<div title="MonkeyGTD" modifier="SimonBaird" created="200603091428" modified="200603092307" tags="FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603092307">
<pre>MonkeyGTD is a brand new GTD inspired tag based task manager for TiddlyWiki that uses most of the plugins on this site. It's in the very early stages of development but check it out at http://simonbaird.com/monkeygtd/</pre>
</div>
<div title="MonkeyPirateTiddlyWiki" modifier="Simon" created="200602270934" modified="200607120418" tags="sortByCreated" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607120418">
<pre>&lt;html&gt;&lt;img src=&quot;http://simonbaird.com/images/mptwlogosml.gif&quot; alt=&quot;logo&quot; align=&quot;right&quot;&gt;&lt;/html&gt;&lt;&lt;flickrGreeting&gt;&gt; and welcome to MonkeyPirateTiddlyWiki, the home of TagglyTagging. This site was created by SimonBaird to share his TiddlyWiki plugins and tweaks with TiddlyWiki users and developers. For new stuff visit WhatsNew.

!!Welcome to the new tiddlyspot url.
MonkeyPirateTiddlyWiki now lives at http://tiddlyspot.com/mptw/
Check out http://tiddlyspot.com/ if you want a painless solution for creating, publishing your TiddlyWiki. Work online and save directly to web. Work offline and upload with a single click when you're ready to publish.

!!PLEASE NOTE: None of the plugins here work with TiddlyWiki 1.2.x. TiddlyWiki 1.2.x users please visit OldMonkeyPirateTiddlyWiki!
&lt;html&gt;&lt;a style=&quot;margin:1em;padding:0px;&quot; href=&quot;http://www.digitalpoint.com/tools/geovisitors/&quot;&gt;&lt;img src=&quot;http://geo.digitalpoint.com/a.png&quot; alt=&quot;Geo Visitors Map&quot; style=&quot;border:0&quot;&gt;&lt;/a&gt;&lt;/html&gt;</pre>
</div>
<div title="More Character Charts" modifier="PaulDickson" created="200601311006" modified="200601311135" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601311135">
<pre>|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;| !Character Encodings |
| grave accent | &amp;amp;_grave; | &amp;Agrave; | &amp;agrave; | &amp;Egrave; | &amp;egrave; | &amp;Igrave; | &amp;igrave; | &amp;Ograve; | &amp;ograve; | &amp;Ugrave; | &amp;ugrave; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; |
| acute accent | &amp;amp;_acute; | &amp;Aacute; | &amp;aacute; | &amp;Eacute; | &amp;eacute; | &amp;Iacute; | &amp;iacute; | &amp;Oacute; | &amp;oacute; | &amp;Uacute; | &amp;uacute; | &amp;nbsp; | &amp;nbsp; | &amp;Yacute; | &amp;yacute; |
| circumflex accent | &amp;amp;_circ; | &amp;Acirc; | &amp;acirc; | &amp;Ecirc; | &amp;ecirc; | &amp;Icirc; | &amp;icirc; | &amp;Ocirc; | &amp;ocirc; | &amp;Ucirc; | &amp;ucirc; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; |
| umlaut mark | &amp;amp;_uml; | &amp;Auml; | &amp;auml; | &amp;Euml; | &amp;euml; | &amp;Iuml; | &amp;iuml; | &amp;Ouml; | &amp;ouml; | &amp;Uuml; | &amp;uuml; | &amp;nbsp; | &amp;nbsp; | &amp;Yuml; | &amp;yuml; |
| tilde | &amp;amp;_tilde; | &amp;Atilde; | &amp;atilde; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;Otilde; | &amp;otilde; | &amp;nbsp; | &amp;nbsp; | &amp;Ntilde; | &amp;ntilde; | &amp;nbsp; | &amp;nbsp; |
| ring | &amp;amp;_ring; | &amp;Aring; | &amp;aring; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; |
| slash | &amp;amp;_slash; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;Oslash; | &amp;oslash; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; | &amp;nbsp; |</pre>
</div>
<div title="More..." modifier="SimonBaird" created="200603091447" modified="200603091447" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091447">
<pre></pre>
</div>
<div title="MyAutoCorrectWords" modifier="SimonBaird" created="200604061336" modified="200604061446" tags="autoCorrectWords" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604061446">
<pre>{{{
mplogo-&gt;[img[Logo|../images/mptwlogosml.gif]]
teh-&gt;the
}}}</pre>
</div>
<div title="NestedSlidersPlugin" modifier="YourName" created="200603092327" modified="200605251521" tags="systemConfig Plugins Borrowed" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605251521">
<pre>/***
''NestedSlidersPlugin for TiddlyWiki version 1.2.x and 2.0''
^^author: Eric Shulman
source: http://www.TiddlyTools.com/#NestedSlidersPlugin
license: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^

Quickly make any tiddler content into an expandable 'slider' panel, without needing to create a separate tiddler to contain the slider content.  Optional syntax allows ''default to open'', ''custom button label/tooltip'' and ''automatic blockquote formatting.''

You can also 'nest' these sliders as deep as you like (see complex nesting example below), so that expandable 'tree-like' hierarchical displays can be created.  This is most useful when converting existing in-line text content to create in-line annotations, footnotes, context-sensitive help, or other subordinate information displays.

For more details, please click on a section headline below:
++++!!!!![Configuration]&gt;
Debugging messages for 'lazy sliders' deferred rendering:
&lt;&lt;option chkDebugLazySliderDefer&gt;&gt; show debugging alert when deferring slider rendering
&lt;&lt;option chkDebugLazySliderRender&gt;&gt; show debugging alert when deferred slider is actually rendered
===
++++!!!!![Usage]&gt;
When installed, this plugin adds new wiki syntax for embedding 'slider' panels directly into tiddler content.  Use {{{+++}}} and {{{===}}} to delimit the slider content.  Additional optional syntax elements let you specify
*default to open
*cookiename
*heading level
*floater (with optional CSS width value)
*mouse auto rollover
*custom label/tooltip/accesskey
*automatic blockquote
*deferred rendering
The complete syntax, using all options, is:
//{{{
++++(cookiename)!!!!!^width^*[label=key|tooltip]&gt;...
content goes here
===
//}}}
where:
* {{{+++}}} (or {{{++++}}}) and {{{===}}}^^
marks the start and end of the slider definition, respectively.  When the extra {{{+}}} is used, the slider will be open when initially displayed.^^
* {{{(cookiename)}}}^^
saves the slider opened/closed state, and restores this state whenever the slider is re-rendered.^^
* {{{!}}} through {{{!!!!!}}}^^
displays the slider label using a formatted headline (Hn) style instead of a button/link style^^
* {{{^width^}}} (or just {{{^}}})^^
makes the slider 'float' on top of other content rather than shifting that content downward.  'width' must be a valid CSS value (e.g., &quot;30em&quot;, &quot;180px&quot;, &quot;50%&quot;, etc.).  If omitted, the default width is &quot;auto&quot; (i.e., fit to content)^^
* {{{*}}}^^
automatically opens/closes slider on &quot;rollover&quot; as well as when clicked^^
* {{{[label=key|tooltip]}}}^^
uses custom label/tooltip/accesskey.  {{{=key}}} and {{{|tooltip}}} are optional.  'key' is must be a ''single letter only''.  Default labels/tootips are: &quot;&gt;&quot; (more) and &quot;&lt;&quot; (less), with no default access key assignment.^^
* {{{&quot;&gt;&quot;}}} //(without the quotes)//^^
automatically adds blockquote formatting to slider content^^
* {{{&quot;...&quot;}}} //(without the quotes)//^^
defers rendering of closed sliders until the first time they are opened.  //Note: deferred rendering may produce unexpected results in some cases.  Use with care.//^^

//Note: to make slider definitions easier to read and recognize when editing a tiddler, newlines immediately following the {{{+++}}} 'start slider' or preceding the {{{===}}} 'end slider' sequence are automatically supressed so that excess whitespace is eliminated from the output.//
===
++++!!!!![Examples]&gt;
simple in-line slider: 
{{{
+++
   content
===
}}}
+++
   content
===
----
use a custom label and tooltip: 
{{{
+++[label|tooltip]
   content
===
}}}
+++[label|tooltip]
   content
===
----
content automatically blockquoted: 
{{{
+++&gt;
   content
===
}}}
+++&gt;
   content
===
----
all options combined //(default open, cookie, heading, sized floater, rollover, label/tooltip/key, blockquoted, deferred)//
{{{
++++(testcookie)!!!^30em^*[label=Z|click or press Alt-Z to open]&gt;...
   content
===
}}}
++++(testcookie)!!!^30em^*[label=Z|click or press Alt-Z to open]&gt;...
   content
===
----
complex nesting example:
{{{
+++^[get info...=I|click for information or press Alt-I]
   put some general information here, plus a floating slider with more specific info:
   +++^10em^[view details...|click for details]
      put some detail here, which could include a rollover with a +++^25em^*[glossary definition]explaining technical terms===
   ===
===
}}}
+++^[get info...=I|click for information or press Alt-I]
   put some general information here, plus a floating slider with more specific info:
   +++^10em^[view details...|click for details]
      put some detail here, which could include a rollover with a +++^25em^*[glossary definition]explaining technical terms===
   ===
===
----
nested floaters
&gt;menu: &lt;&lt;tiddler NestedSlidersExample&gt;&gt;
(see [[NestedSlidersExample]] for definition)
----
===
!!!!!Installation
&lt;&lt;&lt;
import (or copy/paste) the following tiddlers into your document:
''NestedSlidersPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2006.05.11 - 1.9.0'' added optional '^width^' syntax for floating sliders and '=key' syntax for setting an access key on a slider label
''2006.05.09 - 1.8.0'' in onClickNestedSlider(), when showing panel, set focus to first child input/textarea/select element
''2006.04.24 - 1.7.8'' in adjustSliderPos(), if floating panel is contained inside another floating panel, subtract offset of containing panel to find correct position
''2006.02.16 - 1.7.7'' corrected deferred rendering to account for use-case where show/hide state is tracked in a cookie
''2006.02.15 - 1.7.6'' in adjustSliderPos(), ensure that floating panel is positioned completely within the browser window (i.e., does not go beyond the right edge of the browser window)
''2006.02.04 - 1.7.5'' add 'var' to unintended global variable declarations to avoid FireFox 1.5.0.1 crash bug when assigning to globals
''2006.01.18 - 1.7.4'' only define adjustSliderPos() function if it has not already been provided by another plugin.  This lets other plugins 'hijack' the function even when they are loaded first.
''2006.01.16 - 1.7.3'' added adjustSliderPos(place,btn,panel,panelClass) function to permit specialized logic for placement of floating panels.  While it provides improved placement for many uses of floating panels, it exhibits a relative offset positioning error when used within *nested* floating panels.  Short-term workaround is to only adjust the position for 'top-level' floaters.
''2006.01.16 - 1.7.2'' added button property to slider panel elements so that slider panel can tell which button it belongs to.  Also, re-activated and corrected animation handling so that nested sliders aren't clipped by hijacking Slider.prototype.stop so that &quot;overflow:hidden&quot; can be reset to &quot;overflow:visible&quot; after animation ends
''2006.01.14 - 1.7.1'' added optional &quot;^&quot; syntax for floating panels.  Defines new CSS class, &quot;.floatingPanel&quot;, as an alternative for standard in-line &quot;.sliderPanel&quot; styles.
''2006.01.14 - 1.7.0'' added optional &quot;*&quot; syntax for rollover handling to show/hide slider without requiring a click (Based on a suggestion by tw4efl)
''2006.01.03 - 1.6.2'' When using optional &quot;!&quot; heading style, instead of creating a clickable &quot;Hn&quot; element, create an &quot;A&quot; element inside the &quot;Hn&quot; element.  (allows click-through in SlideShowPlugin, which captures nearly all click events, except for hyperlinks)
''2005.12.15 - 1.6.1'' added optional &quot;...&quot; syntax to invoke deferred ('lazy') rendering for initially hidden sliders
removed checkbox option for 'global' application of lazy sliders
''2005.11.25 - 1.6.0'' added optional handling for 'lazy sliders' (deferred rendering for initially hidden sliders)
''2005.11.21 - 1.5.1'' revised regular expressions: if present, a single newline //preceding// and/or //following// a slider definition will be suppressed so start/end syntax can be place on separate lines in the tiddler 'source' for improved readability.  Similarly, any whitespace (newlines, tabs, spaces, etc.) trailing the 'start slider' syntax or preceding the 'end slider' syntax is also suppressed.
''2005.11.20 - 1.5.0'' added (cookiename) syntax for optional tracking and restoring of slider open/close state
''2005.11.11 - 1.4.0'' added !!!!! syntax to render slider label as a header (Hn) style instead of a button/link style
''2005.11.07 - 1.3.0'' removed alternative syntax {{{(((}}} and {{{)))}}} (so they can be used by other
formatting extensions) and simplified/improved regular expressions to trim multiple excess newlines
''2005.11.05 - 1.2.1'' changed name to NestedSlidersPlugin
more documentation
''2005.11.04 - 1.2.0'' added alternative character-mode syntax {{{(((}}} and {{{)))}}}
tweaked &quot;eat newlines&quot; logic for line-mode {{{+++}}} and {{{===}}} syntax
''2005.11.03 - 1.1.1'' fixed toggling of default tooltips (&quot;more...&quot; and &quot;less...&quot;) when a non-default button label is used
code cleanup, added documentation
''2005.11.03 - 1.1.0'' changed delimiter syntax from {{{(((}}} and {{{)))}}} to {{{+++}}} and {{{===}}}
changed name to EasySlidersPlugin
''2005.11.03 - 1.0.0'' initial public release
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was implemented by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]] with initial research and suggestions from RodneyGomes, GeoffSlocock, and PaulPetterson.
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.nestedSliders = {major: 1, minor: 9, revision: 0, date: new Date(2006,5,11)};
//}}}

//{{{
// options for deferred rendering of sliders that are not initially displayed
if (config.options.chkDebugLazySliderDefer==undefined) config.options.chkDebugLazySliderDefer=false;
if (config.options.chkDebugLazySliderRender==undefined) config.options.chkDebugLazySliderRender=false;

// default styles for 'floating' class
setStylesheet(&quot;.floatingPanel { position:absolute; z-index:10; padding:0.5em; margin:0em; \
	background-color:#eee; color:#000; border:1px solid #000; text-align:left; }&quot;,&quot;floatingPanelStylesheet&quot;);
//}}}

//{{{
config.formatters.push( {
	name: &quot;nestedSliders&quot;,
	match: &quot;\\n?\\+{3}&quot;,
	terminator: &quot;\\s*\\={3}\\n?&quot;,
	lookahead: &quot;\\n?\\+{3}(\\+)?(\\([^\\)]*\\))?(\\!*)?(\\^(?:[^\\^\\*\\[\\&gt;]*\\^)?)?(\\*)?(\\[[^\\]]*\\])?(\\&gt;)?(\\.\\.\\.)?\\s*&quot;,
	handler: function(w)
		{
			var lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source)
			if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart)
			{
				// location for rendering button and panel
				var place=w.output;

				// default to closed, no cookie, no accesskey
				var show=&quot;none&quot;; var title=&quot;&gt;&quot;; var tooltip=&quot;show&quot;; var cookie=&quot;&quot;; var key=&quot;&quot;;

				// extra &quot;+&quot;, default to open
				if (lookaheadMatch[1])
					{ show=&quot;block&quot;; title=&quot;&lt;&quot;; tooltip=&quot;hide&quot;; }

				// cookie, use saved open/closed state
				if (lookaheadMatch[2]) {
					cookie=lookaheadMatch[2].trim().slice(1,-1);
					cookie=&quot;chkSlider&quot;+cookie;
					if (config.options[cookie]==undefined)
						{ config.options[cookie] = (show==&quot;block&quot;) }
					if (config.options[cookie])
						{ show=&quot;block&quot;; title=&quot;&lt;&quot;; tooltip=&quot;hide&quot;; }
					else
						{ show=&quot;none&quot;; title=&quot;&gt;&quot;; tooltip=&quot;show&quot;; }
				}

				// parse custom label/tooltip/accesskey: [label=X|tooltip]
				if (lookaheadMatch[6]) {
					title = lookaheadMatch[6].trim().slice(1,-1);
					var pos=title.indexOf(&quot;|&quot;);
					if (pos!=-1) { tooltip = title.substr(pos+1,title.length); title=title.substr(0,pos); }
					if (title.substr(title.length-2,1)==&quot;=&quot;) { key=title.substr(title.length-1,1); title=title.slice(0,-2); }
					if (pos==-1) tooltip += &quot; &quot;+title; // default tooltip: &quot;show/hide &lt;title&gt;&quot;
				}

				// create the button
				if (lookaheadMatch[3]) { // use &quot;Hn&quot; header format instead of button/link
					var lvl=(lookaheadMatch[3].length&gt;6)?6:lookaheadMatch[3].length;
					var btn = createTiddlyElement(createTiddlyElement(place,&quot;h&quot;+lvl,null,null,null),&quot;a&quot;,null,null,title);
					btn.onclick=onClickNestedSlider;
					btn.setAttribute(&quot;href&quot;,&quot;javascript:;&quot;);
					btn.setAttribute(&quot;title&quot;,tooltip);
				}
				else
					var btn = createTiddlyButton(place,title,tooltip,onClickNestedSlider);
				btn.sliderCookie = cookie; // save the cookiename (if any) in the button object
				btn.keyparam=key; // save the access key letter (&quot;&quot; if none)
				if (key.length) {
					btn.setAttribute(&quot;accessKey&quot;,key); // init access key
					btn.onfocus=function(){this.setAttribute(&quot;accessKey&quot;,this.keyparam);}; // **reclaim** access key on focus
				}

				// &quot;non-click&quot; MouseOver open/close slider
				if (lookaheadMatch[5]) btn.onmouseover=onClickNestedSlider;

				// create slider panel
				var panelClass=lookaheadMatch[4]?&quot;floatingPanel&quot;:&quot;sliderPanel&quot;;
				var panel=createTiddlyElement(place,&quot;div&quot;,null,panelClass,null);
				panel.style.display = show;
				if (lookaheadMatch[4] &amp;&amp; lookaheadMatch[4].length&gt;2) panel.style.width=lookaheadMatch[4].slice(1,-1); // custom width
				panel.button = btn; // so the slider panel know which button it belongs to
				btn.sliderPanel=panel;

				// render slider (or defer until shown) 
				w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
				if ((show==&quot;block&quot;)||!lookaheadMatch[8]) {
					// render now if panel is supposed to be shown or NOT deferred rendering
					w.subWikify(lookaheadMatch[7]?createTiddlyElement(panel,&quot;blockquote&quot;):panel,this.terminator);
					// align slider/floater position with button
					adjustSliderPos(place,btn,panel,panelClass);
				}
				else {
					var src = w.source.substr(w.nextMatch);
					var endpos=findMatchingDelimiter(src,&quot;+++&quot;,&quot;===&quot;);
					panel.setAttribute(&quot;raw&quot;,src.substr(0,endpos));
					panel.setAttribute(&quot;blockquote&quot;,lookaheadMatch[7]?&quot;true&quot;:&quot;false&quot;);
					panel.setAttribute(&quot;rendered&quot;,&quot;false&quot;);
					w.nextMatch += endpos+3;
					if (w.source.substr(w.nextMatch,1)==&quot;\n&quot;) w.nextMatch++;
					if (config.options.chkDebugLazySliderDefer) alert(&quot;deferred '&quot;+title+&quot;':\n\n&quot;+panel.getAttribute(&quot;raw&quot;));
				}
			}
		}
	}
)

// TBD: ignore 'quoted' delimiters (e.g., &quot;{{{+++foo===}}}&quot; isn't really a slider)
function findMatchingDelimiter(src,starttext,endtext) {
	var startpos = 0;
	var endpos = src.indexOf(endtext);
	// check for nested delimiters
	while (src.substring(startpos,endpos-1).indexOf(starttext)!=-1) {
		// count number of nested 'starts'
		var startcount=0;
		var temp = src.substring(startpos,endpos-1);
		var pos=temp.indexOf(starttext);
		while (pos!=-1)  { startcount++; pos=temp.indexOf(starttext,pos+starttext.length); }
		// set up to check for additional 'starts' after adjusting endpos
		startpos=endpos+endtext.length;
		// find endpos for corresponding number of matching 'ends'
		while (startcount &amp;&amp; endpos!=-1) {
			endpos = src.indexOf(endtext,endpos+endtext.length);
			startcount--;
		}
	}
	return (endpos==-1)?src.length:endpos;
}
//}}}

//{{{
window.onClickNestedSlider=function(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var theLabel = theTarget.firstChild.data;
	var theSlider = theTarget.sliderPanel
	var isOpen = theSlider.style.display!=&quot;none&quot;;
	// if using default button labels, toggle labels
	if (theLabel==&quot;&gt;&quot;) theTarget.firstChild.data = &quot;&lt;&quot;;
	else if (theLabel==&quot;&lt;&quot;) theTarget.firstChild.data = &quot;&gt;&quot;;
	// if using default tooltips, toggle tooltips
	if (theTarget.getAttribute(&quot;title&quot;)==&quot;show&quot;)
		theTarget.setAttribute(&quot;title&quot;,&quot;hide&quot;);
	else if (theTarget.getAttribute(&quot;title&quot;)==&quot;hide&quot;)
		theTarget.setAttribute(&quot;title&quot;,&quot;show&quot;);
	if (theTarget.getAttribute(&quot;title&quot;)==&quot;show &quot;+theLabel)
		theTarget.setAttribute(&quot;title&quot;,&quot;hide &quot;+theLabel);
	else if (theTarget.getAttribute(&quot;title&quot;)==&quot;hide &quot;+theLabel)
		theTarget.setAttribute(&quot;title&quot;,&quot;show &quot;+theLabel);
	// deferred rendering (if needed)
	if (theSlider.getAttribute(&quot;rendered&quot;)==&quot;false&quot;) {
		if (config.options.chkDebugLazySliderRender)
			alert(&quot;rendering '&quot;+theLabel+&quot;':\n\n&quot;+theSlider.getAttribute(&quot;raw&quot;));
		var place=theSlider;
		if (theSlider.getAttribute(&quot;blockquote&quot;)==&quot;true&quot;)
			place=createTiddlyElement(place,&quot;blockquote&quot;);
		wikify(theSlider.getAttribute(&quot;raw&quot;),place);
		theSlider.setAttribute(&quot;rendered&quot;,&quot;true&quot;);
	}
	// show/hide the slider
	if(config.options.chkAnimate)
		anim.startAnimating(new Slider(theSlider,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));
	else
		theSlider.style.display = isOpen ? &quot;none&quot; : &quot;block&quot;;
	// if showing panel, set focus to first 'focus-able' element in panel
	if (theSlider.style.display!=&quot;none&quot;) {
		var ctrls=theSlider.getElementsByTagName(&quot;*&quot;);
		for (var c=0; c&lt;ctrls.length; c++) {
			var t=ctrls[c].tagName.toLowerCase();
			if (t==&quot;input&quot; || t==&quot;textarea&quot; || t==&quot;select&quot;)
				{ ctrls[c].focus(); break; }
		}
	}
	if (this.sliderCookie &amp;&amp; this.sliderCookie.length)
		{ config.options[this.sliderCookie]=!isOpen; saveOptionCookie(this.sliderCookie); }
	// align slider/floater position with target button
	adjustSliderPos(theSlider.parentNode,theTarget,theSlider,theSlider.className);
	return false;
}

// hijack animation handler 'stop' handler so overflow is visible after animation has completed
Slider.prototype.coreStop = Slider.prototype.stop;
Slider.prototype.stop = function() { this.coreStop(); this.element.style.overflow = &quot;visible&quot;; }

// adjust panel position based on button position
if (window.adjustSliderPos==undefined) window.adjustSliderPos=function(place,btn,panel,panelClass) {
	if (panelClass==&quot;floatingPanel&quot;) {
		var left=0;
		var top=btn.offsetHeight; 
		if (place.style.position!=&quot;relative&quot;) {
			var left=findPosX(btn);
			var top=findPosY(btn)+btn.offsetHeight;
			var p=place; while (p &amp;&amp; p.className!='floatingPanel') p=p.parentNode;
			if (p) { left-=findPosX(p); top-=findPosY(p); }
		}
		if (left+panel.offsetWidth &gt; getWindowWidth()) left=getWindowWidth()-panel.offsetWidth-10;
		panel.style.left=left+&quot;px&quot;; panel.style.top=top+&quot;px&quot;;
	}
}

function getWindowWidth() {
	if(document.width!=undefined)
		return document.width; // moz (FF)
	if(document.documentElement &amp;&amp; ( document.documentElement.clientWidth || document.documentElement.clientHeight ) )
		return document.documentElement.clientWidth; // IE6
	if(document.body &amp;&amp; ( document.body.clientWidth || document.body.clientHeight ) )
		return document.body.clientWidth; // IE4
	if(window.innerWidth!=undefined)
		return window.innerWidth; // IE - general
	return 0; // unknown
}
//}}}</pre>
</div>
<div title="NewDocumentPlugin" modifier="SimonBaird" created="200605250638" modified="200605250638" tags="systemConfig Borrowed ELS Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605250638">
<pre>/***
''NewDocumentPlugin for TiddlyWiki version 2.0''
^^author: Eric Shulman - ELS Design Studios
source: http://www.TiddlyTools.com/#NewDocumentPlugin
license: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^

Quickly create new TiddlyWiki documents from your existing document, with just one click!  Use the {{{&lt;&lt;newDocument&gt;&gt;}}} macro to place a &quot;new document&quot; link into your sidebar/mainmenu/any tiddler (wherever you like).  Select this command to automatically create a &quot;new.html&quot; document containing a specific set of tagged tiddlers.  Optional parameters let you specify an alternate path/filename for the new file, or different tags to match.  You can also indicate &quot;ask&quot; for either parameter, which will  trigger a prompt for input when the command is selected.

!!!!!Usage
&lt;&lt;&lt;
{{{&lt;&lt;newDocument label:text filename tag tag tag...&gt;&gt;}}}
{{{&lt;&lt;newDocument label:text filename all&gt;&gt;}}}
{{{&lt;&lt;newDocument label:text filename snap&gt;&gt;}}}
 where:
* ''label:text'' defines //optional// alternative link text (replaces default &quot;new document&quot; display)
* ''filename'' is any local path-and-filename.  If no parameters are provided, the default is to create the file &quot;new.htm&quot; in the current directory.  If a filename is provided without a path (i.e., there is no &quot;/&quot; in the input), then the current directory is also assumed.  Otherwise, this parameter is expected to contain the complete path and filename needed to write the file to your local hard disk.  If ''ask'' is used in place of the filename parameter then, when the command link is selected, a message box will be automatically displayed so you can select/enter the path and filename.
* ''tag tag tag...'' is a list of one or more space-separated tags (use quotes or {{{[[]]}}} around tags that contain spaces).  The new document will include all tiddlers that match at least one of the tags in the list.  The default is to include tiddlers tagged with &lt;&lt;tag includeNew&gt;&gt;or&lt;&lt;tag systemTiddlers&gt;&gt;.    The special value ''all'' may be used to match every tiddler (even those without tags).   If ''ask'' is used in place of the tags then, when the command link is selected, a message box will be automatically displayed so you can enter the desired tags at that time.
* When the keyword ''snap'' is used in place of tags to match, the plugin generates a file containing the //rendered// CSS-and-HTML for all tiddlers currently displayed in the document.

Note: as of version 1.4.0 of this plugin, support for selecting tiddlers by using tag *expressions* has been replaced with simpler, more efficient &quot;containsAny()&quot; logic.  To create new ~TiddlyWiki documents that contain only those tiddlers selected with advanced AND/OR/NOT Boolean expressions, you can use the filtering features provided by the ExportTiddlersPlugin (see www.TiddlyTools.com/#ExportTiddlersPlugin).
&lt;&lt;&lt;
!!!!!Examples:
&lt;&lt;&lt;
{{{&lt;&lt;newDocument&gt;&gt;}}}
equivalent to {{{&lt;&lt;newDocument new.htm includeNew systemTiddlers&gt;&gt;}}}
creates default &quot;new.htm&quot; containing tiddlers tagged with either&lt;&lt;tag includeNew&gt;&gt;or&lt;&lt;tag systemTiddlers&gt;&gt;
try it: &lt;&lt;newDocument&gt;&gt;

{{{&lt;&lt;newDocument empty.html systemTiddlers&gt;&gt;}}}
creates &quot;empty.html&quot; containing only tiddlers tagged with&lt;&lt;tag systemTiddlers&gt;&gt;
//(reproduces old-style (pre 2.0.2) empty file)//
try it: &lt;&lt;newDocument empty.html systemTiddlers&gt;&gt;

{{{&lt;&lt;newDocument &quot;label:create Import/Export starter&quot; ask importexport&gt;&gt;}}}
save importexport tiddlers to a new file, prompts for path/file
try it: &lt;&lt;newDocument &quot;label:create Import/Export starter&quot; ask importexport&gt;&gt;

{{{&lt;&lt;newDocument ask ask&gt;&gt;}}}
prompts for path/file, prompts for tags to match
try it: &lt;&lt;newDocument ask ask&gt;&gt;

{{{&lt;&lt;newDocument ask all&gt;&gt;}}}
save all current TiddlyWiki contents to a new file, prompts for path/file
try it: &lt;&lt;newDocument ask all&gt;&gt;

{{{&lt;&lt;newDocument ask snap&gt;&gt;}}}
generates snapshot of currently displayed document, prompts for path/file
try it: &lt;&lt;newDocument ask snap&gt;&gt;

&lt;&lt;&lt;
!!!!!Installation
&lt;&lt;&lt;
Import (or copy/paste) the following tiddlers into your document:
''NewDocumentPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2006.05.23 [1.4.0]'' due to very poor performance, support for tag *expressions* has been removed, in favor of a simpler &quot;containsAny()&quot; scan for tags.
''2006.04.09 [1.3.6]'' in onClickNewDocument, added call to convertUnicodeToUTF8() to better handle international characters.
''2006.03.15 [1.3.5]'' added nsIFilePicker() handler for selecting filename in moz-based browsers.  IE and other non-moz browsers still use simple prompt() dialog
''2006.03.15 [1.3.0]'' added &quot;label:text&quot; param for custom link text.  added special &quot;all&quot; filter parameter for &quot;save as...&quot; handling (writes all tiddlers to output file)
''2006.03.09 [1.2.0]'' added special &quot;snap&quot; filter parameter to generate and write &quot;snapshot&quot; files containing static HTML+CSS for currently rendered document.
''2006.02.24 [1.1.2]'' Fix incompatiblity with TW 2.0.5 by removing custom definition of getLocalPath() (which is now part of TW core)
''2006.02.03 [1.1.1]'' concatentate 'extra' params so that tag expressions don't have to be quoted.   moved all text to 'formatted' string definitions for easier translation.
''2006.02.03 [1.1.0]'' added support for tag EXPRESSIONS.  plus improved documentation and code cleanup
''2006.02.03 [1.0.0]'' Created.
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.newDocument = {major: 1, minor: 3, revision: 6, date: new Date(2006,4,9)};

config.macros.newDocument = {
	newlabel: &quot;new document&quot;,
	newprompt: &quot;Create a new TiddlyWiki 'starter' document&quot;,
	newdefault: &quot;new.htm&quot;,
	allparam: &quot;all&quot;,
	saveaslabel: &quot;save as...&quot;,
	saveasprompt: &quot;Save current TiddlyWiki to a different file&quot;,
	snapparam: &quot;snap&quot;,
	snaplabel: &quot;create a snapshot&quot;,
	snapprompt: &quot;Create a 'snapshot' of the current TiddlyWiki display&quot;,
	snapdefault: &quot;snapshot.htm&quot;,
	askparam: &quot;ask&quot;,
	labelparam: &quot;label:&quot;,
	fileprompt: &quot;Please enter a filename&quot;,
	filter: &quot;includeNew OR systemTiddlers&quot;,
	filterprompt: &quot;Enter tag(s) to match (use AND, OR, NOT)&quot;,
	filtererrmsg: &quot;Error in tag filter '%0'&quot;,
	snapmsg: &quot;Document snapshot written to %0&quot;,
	okmsg: &quot;%0 tiddlers written to %1&quot;,
	failmsg: &quot;An error occurred while creating '%0'&quot;
};

config.macros.newDocument.handler = function(place,macroName,params) {

	var path=getLocalPath(document.location.toString());
	var slashpos=path.lastIndexOf(&quot;/&quot;); if (slashpos==-1) slashpos=path.lastIndexOf(&quot;\\&quot;); 
	if (slashpos!=-1) path = path.substr(0,slashpos+1); // remove filename from path, leave the trailing slash

	if (params[0] &amp;&amp; params[0].substr(0,config.macros.newDocument.labelparam.length)==config.macros.newDocument.labelparam)
		var label=params.shift().substr(config.macros.newDocument.labelparam.length)
	var filename=params.shift(); if (!filename) filename=config.macros.newDocument.newdefault;
	if (params[0]==config.macros.newDocument.snapparam) {
		if (!label) var label=config.macros.newDocument.snaplabel;
		var prompt=config.macros.newDocument.snapprompt;
		var defaultfile=config.macros.newDocument.snapdefault;
	}
	if (params[0]==config.macros.newDocument.allparam) {
		if (!label) var label=config.macros.newDocument.saveaslabel;
		var prompt=config.macros.newDocument.saveasprompt;
		var defaultfile=getLocalPath(document.location.toString());
		var slashpos=defaultfile.lastIndexOf(&quot;/&quot;); if (slashpos==-1) slashpos=defaultfile.lastIndexOf(&quot;\\&quot;);
		if (slashpos!=-1) defaultfile=defaultfile.substr(slashpos+1); // get filename only
	}
	if (!prompt) var prompt=config.macros.newDocument.newprompt;
	if (!label) var label=config.macros.newDocument.newlabel;
	if (!defaultfile) var defaultfile=config.macros.newDocument.newdefault;

	var btn=createTiddlyButton(place,label,prompt,onClickNewDocument);
	btn.path=path;
	btn.file=filename;
	btn.defaultfile=defaultfile;
	btn.filter=params.length?params:[config.macros.newDocument.filter]; 
}

// IE needs explicit global scoping for functions called by browser events
window.onClickNewDocument=function(e)
{
	if (!e) var e = window.event; var btn=resolveTarget(e);

	// get output path/filename
	var filename=btn.file;
	if (filename==config.macros.newDocument.askparam)
		filename=promptForFilename(config.macros.newDocument.fileprompt,btn.path,btn.defaultfile);
	if (!filename) return; // cancelled by user
	// if specified file does not include a path, assemble fully qualified path and filename
	var slashpos=filename.lastIndexOf(&quot;/&quot;); if (slashpos==-1) slashpos=filename.lastIndexOf(&quot;\\&quot;);
	if (slashpos==-1) filename=btn.path+filename;
	// assemble document content, write file, report result
	if (btn.filter[0]==config.macros.newDocument.snapparam) { // HTML+CSS snapshot
		var styles=document.getElementsByTagName(&quot;style&quot;);
		var out=&quot;&lt;html&gt;\n&lt;head&gt;\n&lt;style&gt;\n&quot;;
		for(var i=0; i &lt; styles.length; i++) out +=&quot;/* stylesheet from tiddler:&quot;+styles[i].getAttribute(&quot;id&quot;)+&quot; */\n&quot;+styles[i].innerHTML+&quot;\n\n&quot;;
		out += &quot;&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\n&quot;+document.getElementById(&quot;contentWrapper&quot;).innerHTML+&quot;\n\n&lt;/body&gt;\n&lt;/html&gt;&quot;;
		var msg=saveFile(filename,out)
			?config.macros.newDocument.snapmsg.format([filename])
			:config.macros.newDocument.failmsg.format([filename]);
	} else { // TW starter document
		// get the TiddlyWiki core code source
		var sourcefile=getLocalPath(document.location.toString());
		var source=loadFile(sourcefile);
		if(source==null) { alert(config.messages.cantSaveError); return null; }
		var posOpeningDiv=source.indexOf(startSaveArea);
		var posClosingDiv=source.lastIndexOf(endSaveArea);
		if((posOpeningDiv==-1)||(posClosingDiv==-1)) { alert(config.messages.invalidFileError.format([sourcefile])); return; }
		// get the matching tiddler divs
		var match=btn.filter;
		if (match[0]==config.macros.newDocument.askparam)
			match=prompt(config.macros.newDocument.filterprompt,config.macros.newDocument.filter).readMacroParams();
		if (!match[0]) return; // cancelled by user
		var storeAreaDivs=[];
		var tiddlers=store.getTiddlers('title');
		for (var i=0; i&lt;tiddlers.length; i++)
			if (match[0]==config.macros.newDocument.allparam || (tiddlers[i].tags &amp;&amp; tiddlers[i].tags.containsAny(match)) )
				storeAreaDivs.push(tiddlers[i].saveToDiv());
		var out=source.substr(0,posOpeningDiv+startSaveArea.length)+convertUnicodeToUTF8(storeAreaDivs.join(&quot;\n&quot;))+&quot;\n\t\t&quot;+source.substr(posClosingDiv);
		var msg=saveFile(filename,out)
			?config.macros.newDocument.okmsg.format([storeAreaDivs.length,filename])
			:config.macros.newDocument.failmsg.format([filename]);
	}
	clearMessage(); displayMessage(msg);
	e.cancelBubble = true; if (e.stopPropagation) e.stopPropagation(); return(false);
}
//}}}

//{{{
function promptForFilename(msg,path,file)
{
	if(!window.Components)
		return prompt(msg,path+file); // fallback for IE and other non-moz browsers
	try {
		netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
		var nsIFilePicker = window.Components.interfaces.nsIFilePicker;
		var picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);
		picker.init(window, msg, nsIFilePicker.modeSave);
		var thispath = Components.classes[&quot;@mozilla.org/file/local;1&quot;].createInstance(Components.interfaces.nsILocalFile);
		thispath.initWithPath(path);
		picker.displayDirectory=thispath;
		picker.defaultExtension=&quot;html&quot;;
		picker.defaultString=file;
		picker.appendFilters(nsIFilePicker.filterAll|nsIFilePicker.filterText|nsIFilePicker.filterHTML);
		var result = picker.show();
		if (result == nsIFilePicker.returnOK) return picker.file.persistentDescriptor;
	}
	catch(e) { alert('error during local file access: '+e.toString()) }
}
//}}}</pre>
</div>
<div title="NewHereCommand" modifier="YourName" created="200601061833" modified="200609010431" tags="systemConfig TagglyTagging Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200609010431">
<pre>/***
|Name|NewHereCommand|
|Source|http://simonbaird.com/mptw/#NewHereCommand|
|Version|1.0|

Code originally by ArphenLin. Small tweak by SimonBaird
http://aiddlywiki.sourceforge.net/NewHere_demo.html#NewHereCommand
To use this you must edit your ViewTemplate and add newHere to the toolbar div, eg
{{{&lt;div class='toolbar' macro='toolbar ... newHere'&gt;&lt;/div&gt;}}}
***/
//{{{

config.commands.newHere = {
	text: 'new here',
	tooltip: 'Create a new tiddler tagged as this tiddler',
	hideReadOnly: true,
	handler: function(e,src,title) {
		if (!readOnly) {
			clearMessage();
			var t=document.getElementById('tiddler'+title);
			story.displayTiddler(t,config.macros.newTiddler.title,DEFAULT_EDIT_TEMPLATE);
			story.setTiddlerTag(config.macros.newTiddler.title, title, 0);
			story.focusTiddler(config.macros.newTiddler.title,&quot;title&quot;);
			return false;
		}
	}
};

config.commands.newJournalHere = {
	//text: 'new journal here',  // too long
	text: 'new journal',
	hideReadOnly: true,
	dataFormat: 'YYYY-0MM-0DD 0hh:0mm', // adjust to your preference
	tooltip: 'Create a new journal tiddler tagged as this tiddler',
	handler: function(e,src,title) {
		if (!readOnly) {
			clearMessage();
			var now = new Date();
			var t=document.getElementById('tiddler'+title);
			var newtitle = now.formatString(this.dataFormat)
			story.displayTiddler(t,newtitle,DEFAULT_EDIT_TEMPLATE);
			story.setTiddlerTag(newtitle, title, 0);
			story.focusTiddler(newtitle,&quot;title&quot;);
			return false;
		}
	}
};


//}}}</pre>
</div>
<div title="Next" modifier="SimonBaird" created="200604041732" modified="200604041732" tags="Status" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041732">
<pre></pre>
</div>
<div title="Normal" modifier="SimonBaird" created="200604041724" modified="200604041724" tags="Priority" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041724">
<pre>Type the text for 'New Tiddler'</pre>
</div>
<div title="OldMonkeyPirateTiddlyWiki" modifier="Simon" created="200601101211" modified="200608080532" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608080532">
<pre>The [[Old (Pre TW 2.0) MonkeyPirateTiddlyWiki|http://simonbaird.com/mptw1/]] (which I may refer to as ~MonkeyPirateTiddlyWiki1...) is where you can get my plugins for TiddlyWiki 1.2.x. The url is http://simonbaird.com/mptw1/.
</pre>
</div>
<div title="PageTemplates" modifier="SimonBaird" created="200601160550" modified="200601160550" tags="Templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601160550">
<pre></pre>
</div>
<div title="Pending" modifier="SimonBaird" created="200604041732" modified="200604041733" tags="Status" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041733">
<pre></pre>
</div>
<div title="Plugins" modifier="SimonBaird" created="200601071025" modified="200603091347" tags="list3Cols" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091347">
<pre>These are the plugins available on this site. Some are [[Borrowed]]. Most are [[MPTW]] originals.</pre>
</div>
<div title="PositionAdsense" modifier="YourName" created="200606211547" modified="200609041450" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200609041450">
<pre>//{{{

window.applyPageTemplate_orig_ads = window.applyPageTemplate;

window.applyPageTemplate = function(title) {

  applyPageTemplate_orig_ads(title);

  var box = document.getElementById('adsenseBox');
  var bar = document.getElementById('adsenseBar');

  var sidebar = document.getElementById('sidebar');
  var sidebarOptions = document.getElementById('sidebarOptions');
  var displayArea = document.getElementById('displayArea');
  var tiddlerDisplay = document.getElementById('tiddlerDisplay');

  if (false &amp;&amp; sidebar &amp;&amp; sidebarOptions &amp;&amp; box) {
    sidebar.insertBefore(box,sidebarOptions.nextSibling);
    box.style.display = 'block';
  }
  else if (sidebar &amp;&amp; box) {
    sidebar.insertBefore(box,sidebar.childNodes[0]);
    box.style.display = 'block';
  }

  if (displayArea &amp;&amp; bar) {
    //displayArea.insertBefore(bar,displayArea.childNodes[0]);
    displayArea.appendChild(bar);
    bar.style.display = 'block';
  }

};
setStylesheet(
'#adsenseBox { background:#fff; }\n'+
'#adsenseBar { background:#fff; padding-left:1em; }\n'+
'',
'adsenseStyles');

//}}}</pre>
</div>
<div title="Priority" modifier="SimonBaird" created="200604041724" modified="200604041724" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041724">
<pre></pre>
</div>
<div title="Project" modifier="SimonBaird" created="200602161102" modified="200602161102" tags="TiddlerTemplates Project" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161102">
<pre></pre>
</div>
<div title="Put all strings in config.macros for translators" modifier="SimonBaird" created="200603011027" modified="200603011032" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603011032">
<pre>Ie &quot;lingoify&quot; my plugins</pre>
</div>
<div title="QuickOpenTagPlugin" modifier="SimonBaird" created="200601091642" modified="200605190002" tags="systemConfig TagglyTagging Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605190002">
<pre>/***
| Name:|QuickOpenTagPlugin|
| Purpose:|Makes tag links into a Taggly style open tag plus a normal style drop down menu|
| Creator:|SimonBaird|
| Source:|http://simonbaird.com/mptw/#QuickOpenTagPlugin|
| Requires:|TW 2.x|
| Version|1.1.1 (19-May-06)|

!History
* Version 1.1.1 (19/05/2006)
** Added a little more CSS so the tags look good in standard main menus and normal tiddlers
* Version 1.1 (07/02/2006)
** Fix Firefox 1.5.0.1 crashes
** Updated by ~BidiX[at]~BidiX.info
* Version 1.0 (?/01/2006)
** First release

***/
//{{{

//    

window.createTagButton_orig_mptw = createTagButton;
window.createTagButton = function(place,tag,excludeTiddler) {
 var sp = createTiddlyElement(place,&quot;span&quot;,null,&quot;quickopentag&quot;);
 createTiddlyLink(sp,tag,true,&quot;button&quot;);
 var theTag = createTiddlyButton(sp,config.macros.miniTag.dropdownchar,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
 theTag.setAttribute(&quot;tag&quot;,tag);
 if(excludeTiddler)
 theTag.setAttribute(&quot;tiddler&quot;,excludeTiddler);
 return(theTag);
};

config.macros.miniTag = {handler:function(place,macroName,params,wikifier,paramString,tiddler) {
 var tagged = store.getTaggedTiddlers(tiddler.title);
 if (tagged.length &gt; 0) {
 var theTag = createTiddlyButton(place,config.macros.miniTag.dropdownchar,config.views.wikified.tag.tooltip.format([tiddler.title]),onClickTag);
 theTag.setAttribute(&quot;tag&quot;,tiddler.title);
 theTag.className = &quot;miniTag&quot;;
 }
}};

config.macros.miniTag.dropdownchar = (document.all?&quot;&quot;:&quot;&quot;); // the fat one is the only one that works in IE

config.macros.allTags.handler = function(place,macroName,params)
{
 var tags = store.getTags();
 var theDateList = createTiddlyElement(place,&quot;ul&quot;,null,null,null);
 if(tags.length === 0)
 createTiddlyElement(theDateList,&quot;li&quot;,null,&quot;listTitle&quot;,this.noTags);
 for (var t=0; t&lt;tags.length; t++)
 {
 var theListItem =createTiddlyElement(theDateList,&quot;li&quot;,null,null,null);
 var theLink = createTiddlyLink(theListItem,tags[t][0],true);
 var theCount = &quot; (&quot; + tags[t][1] + &quot;)&quot;;
 theLink.appendChild(document.createTextNode(theCount));

 var theDropDownBtn = createTiddlyButton(theListItem,&quot; &quot;+config.macros.miniTag.dropdownchar,this.tooltip.format([tags[t][0]]),onClickTag);
 theDropDownBtn.setAttribute(&quot;tag&quot;,tags[t][0]);
 }
};


// probably could redo these styles a bit cleaner..
setStylesheet(
 &quot;.tagglyTagged .quickopentag, .tagged .quickopentag \n&quot;+
 &quot;     { margin-right:1.2em; border:1px solid #eee; padding:2px; padding-right:0px; padding-left:1px; }\n&quot;+
 &quot;.quickopentag .tiddlyLink { padding:2px; padding-left:3px; }\n&quot;+
 &quot;.quickopentag a.button { padding:1px; padding-left:2px; padding-right:2px;}\n&quot;+
// extra specificity to make it work?
 &quot;#displayArea .viewer .quickopentag a.button, \n&quot;+
 &quot;#displayArea .viewer .quickopentag a.tiddyLink, \n&quot;+
 &quot;#mainMenu .quickopentag a.tiddyLink, \n&quot;+
 &quot;#mainMenu .quickopentag a.tiddyLink \n&quot;+
         &quot; { border:0px solid black; }\n&quot;+
 &quot;#displayArea .viewer .quickopentag a.button, \n&quot;+
 &quot;#mainMenu .quickopentag a.button \n&quot;+
    &quot;{ margin-left:0px; padding-left:2px; }\n&quot;+
 &quot;#displayArea .viewer .quickopentag a.tiddlyLink, \n&quot;+
 &quot;#mainMenu .quickopentag a.tiddlyLink \n&quot;+
   &quot; { margin-right:0px; padding-right:0px; padding-left:0px; margin-left:0px; }\n&quot;+
 &quot;a.miniTag {font-size:150%;} \n&quot;+
 &quot;#mainMenu .quickopentag a.button \n&quot;+
    &quot;{ margin-left:0px; padding-left:2px; margin-right:0px; padding-right:0px; }\n&quot;+ // looks better in right justified main menus
 &quot;&quot;,
&quot;QuickOpenTagStyles&quot;);

//}}}

/***
&lt;html&gt;&amp;#x22bb; &amp;#x22bd; &amp;#x22c1; &amp;#x25bc; &amp;#x25be;&lt;/html&gt;
***/
</pre>
</div>
<div title="RearrangeTiddlersPlugin" modifier="YourName" created="200608071232" modified="200608071554" tags="systemConfig Plugins Borrowed" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608071554">
<pre>//{{{

// adapted from: http://www.cs.utexas.edu/~joeraii/dragn/#Draggable
// changes by ELS:
// * hijack refreshTiddler() instead of overridding createTiddler()
// * find title element by className instead of elementID
// * set cursor style via code instead of stylesheet
// * set tooltip help text
// * set tiddler &quot;position:relative&quot; when starting drag event, restore saved value when drag ends

// * update 2006.08.07: use getElementsByTagName(&quot;*&quot;) to find title element, even when it is 'buried' deep in tiddler DOM elements (due to custom template usage)

Story.prototype.rearrangeTiddlersHijack_refreshTiddler = Story.prototype.refreshTiddler;
Story.prototype.refreshTiddler = function(title,template,unused1,unused2,unused3,unused4,unused5)
{
	this.rearrangeTiddlersHijack_refreshTiddler(title,template,unused1,unused2,unused3,unused4,unused5);
	var theTiddler = document.getElementById(this.idPrefix + title); if (!theTiddler) return;
	var theHandle;
	var children=theTiddler.getElementsByTagName(&quot;*&quot;);
	for (var i=0; i&lt;children.length; i++) if (hasClass(children[i],&quot;title&quot;)) { theHandle=children[i]; break; }
	if (!theHandle) return theTiddler;

	Drag.init(theHandle, theTiddler, 0, 0, null, null);
	theHandle.style.cursor=&quot;move&quot;;
	theHandle.title=&quot;drag title to re-arrange tiddlers&quot;
	theTiddler.onDrag = function(x,y,myElem) {
		if (this.style.position!=&quot;relative&quot;)
			{ this.savedstyle=this.style.position; this.style.position=&quot;relative&quot;; }
		y = myElem.offsetTop;
		var next = myElem.nextSibling;
		var prev = myElem.previousSibling;
		if (next &amp;&amp; y + myElem.offsetHeight &gt; next.offsetTop + next.offsetHeight/2) { 
			myElem.parentNode.removeChild(myElem);
			next.parentNode.insertBefore(myElem, next.nextSibling);//elems[pos+1]);
			myElem.style[&quot;top&quot;] = -next.offsetHeight/2+&quot;px&quot;;
		}
		if (prev &amp;&amp; y &lt; prev.offsetTop + prev.offsetHeight/2) { 
			myElem.parentNode.removeChild(myElem);
			prev.parentNode.insertBefore(myElem, prev);
			myElem.style[&quot;top&quot;] = prev.offsetHeight/2+&quot;px&quot;;
		}
	};
	theTiddler.onDragEnd = function(x,y,myElem) {
		myElem.style[&quot;top&quot;] = &quot;0px&quot;;
		if (this.savedstyle!=undefined)
			this.style.position=this.savedstyle;
	}
	return theTiddler;
}

/**************************************************
 * dom-drag.js
 * 09.25.2001
 * www.youngpup.net
 **************************************************
 * 10.28.2001 - fixed minor bug where events
 * sometimes fired off the handle, not the root.
 **************************************************/

var Drag = {
	obj:null,

	init:
	function(o, oRoot, minX, maxX, minY, maxY) {
		o.onmousedown = Drag.start;
		o.root = oRoot &amp;&amp; oRoot != null ? oRoot : o ;
		if (isNaN(parseInt(o.root.style.left))) o.root.style.left=&quot;0px&quot;;
		if (isNaN(parseInt(o.root.style.top))) o.root.style.top=&quot;0px&quot;;
		o.minX = typeof minX != 'undefined' ? minX : null;
		o.minY = typeof minY != 'undefined' ? minY : null;
		o.maxX = typeof maxX != 'undefined' ? maxX : null;
		o.maxY = typeof maxY != 'undefined' ? maxY : null;
		o.root.onDragStart = new Function();
		o.root.onDragEnd = new Function();
		o.root.onDrag = new Function();
	},

	start:
	function(e) {
		var o = Drag.obj = this;
		e = Drag.fixE(e);
		var y = parseInt(o.root.style.top);
		var x = parseInt(o.root.style.left);
		o.root.onDragStart(x, y, Drag.obj.root);
		o.lastMouseX = e.clientX;
		o.lastMouseY = e.clientY;
		if (o.minX != null) o.minMouseX = e.clientX - x + o.minX;
		if (o.maxX != null) o.maxMouseX = o.minMouseX + o.maxX - o.minX;
		if (o.minY != null) o.minMouseY = e.clientY - y + o.minY;
		if (o.maxY != null) o.maxMouseY = o.minMouseY + o.maxY - o.minY;
		document.onmousemove = Drag.drag;
		document.onmouseup = Drag.end;
		Drag.obj.root.style[&quot;z-index&quot;] = &quot;10&quot;;
		return false;
	},

	drag:
	function(e) {
		e = Drag.fixE(e);
		var o = Drag.obj;
		var ey = e.clientY;
		var ex = e.clientX;
		var y = parseInt(o.root.style.top);
		var x = parseInt(o.root.style.left);
		var nx, ny;
		if (o.minX != null) ex = Math.max(ex, o.minMouseX);
		if (o.maxX != null) ex = Math.min(ex, o.maxMouseX);
		if (o.minY != null) ey = Math.max(ey, o.minMouseY);
		if (o.maxY != null) ey = Math.min(ey, o.maxMouseY);
		nx = x + (ex - o.lastMouseX);
		ny = y + (ey - o.lastMouseY);
		Drag.obj.root.style[&quot;left&quot;] = nx + &quot;px&quot;;
		Drag.obj.root.style[&quot;top&quot;] = ny + &quot;px&quot;;
		Drag.obj.lastMouseX = ex;
		Drag.obj.lastMouseY = ey;
		Drag.obj.root.onDrag(nx, ny, Drag.obj.root);
		return false;
	},

	end:
	function() {
		document.onmousemove = null;
		document.onmouseup = null;
		Drag.obj.root.style[&quot;z-index&quot;] = &quot;0&quot;;
		Drag.obj.root.onDragEnd(parseInt(Drag.obj.root.style[&quot;left&quot;]), parseInt(Drag.obj.root.style[&quot;top&quot;]), Drag.obj.root);
		Drag.obj = null;
	},

	fixE:
	function(e) {
		if (typeof e == 'undefined') e = window.event;
		if (typeof e.layerX == 'undefined') e.layerX = e.offsetX;
		if (typeof e.layerY == 'undefined') e.layerY = e.offsetY;
		return e;
	}
};
//}}}
</pre>
</div>
<div title="RefreshCommand" modifier="Simon" created="200601160255" modified="200607122217" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607122217">
<pre>/***
***/

//{{{

config.commands.refresh = {
 text: 'refresh',
 tooltip: 'Refresh this tiddler',
 handler: function(e,src,title) {
  clearMessage();
  story.refreshTiddler(title,false,true); // force=true
  return false;
 }
};

//}}}</pre>
</div>
<div title="RefreshVisible" modifier="SimonBaird" created="200603071633" modified="200603071633" tags="Snippets" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603071633">
<pre>//{{{
if (!story.refreshVisible())
	story.refreshVisible = function() {
		this.forEachTiddler(function(title,element) {
			if (element.getAttribute(&quot;dirty&quot;) != &quot;true&quot;) 
				story.refreshTiddler(title,false,true);
		});
	}
}
//}}}</pre>
</div>
<div title="RenameTagsPlugin" modifier="SimonBaird" created="200603051724" modified="200604041736" tags="systemConfig Plugins TagglyTagging" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041736">
<pre>/***
| Name:|RenameTagsPlugin|
| Purpose:|Allows you to easily rename tags|
| Creator:|SimonBaird|
| Source:|http://simonbaird.com/mptw/#RenameTagsPlugin|
| Version:|1.0.1 (5-Mar-06)|

!Description
If you rename a tiddler/tag that is tagging other tiddlers this plugin will ask you if you want to rename the tag in each tiddler where it is used. This is essential if you use tags and ever want to rename them. To use it, open the tag you want to rename as a tiddler (it's the last option in the tag popup menu), edit it, rename it and click done. You will asked if you want to rename the tag. Click OK to rename the tag in the tiddlers that use it. Click Cancel to not rename the tag.

!Example
Try renaming [[Plugins]] or [[CSS]] on this site.

!History
* 1.0.1 (5-Mar-06) - Added feature to allow renaming of tags without side-effect of creating a tiddler
* 1.0.0 (5-Mar-06) - First working version

!Code
***/
//{{{

version.extensions.RenameTagsPlugin = {
	major: 1, minor: 0, revision: 0,
	date: new Date(2006,3,5),
	source: &quot;http://simonbaird.com/mptw/#RenameTagsPlugin&quot;
};

config.macros.RenameTagsPlugin = {};
config.macros.RenameTagsPlugin.prompt = &quot;Rename the tag '%0' to '%1' in %2 tidder%3?&quot;;

// these are very useful, perhaps they should be in the core
if (!store.addTag) {
	store.addTag = function(title,tag) {
		var t=this.getTiddler(title); if (!t || !t.tags) return;
		t.tags.push(tag);
	};
};

if (!store.removeTag) {
	store.removeTag = function(title,tag) {
		var t=this.getTiddler(title); if (!t || !t.tags) return;
		if (t.tags.find(tag)!=null) t.tags.splice(t.tags.find(tag),1);
	};
};

store.saveTiddler_orig_tagrename = store.saveTiddler;
store.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags) {
	if (title != newTitle &amp;&amp; this.getTaggedTiddlers(title).length &gt; 0) {
		// then we are renaming a tag
		var tagged = this.getTaggedTiddlers(title);
		if (confirm(config.macros.RenameTagsPlugin.prompt.format([title,newTitle,tagged.length,tagged.length&gt;1?&quot;s&quot;:&quot;&quot;]))) {
			for (var i=0;i&lt;tagged.length;i++) {
				store.removeTag(tagged[i].title,title);
				store.addTag(tagged[i].title,newTitle);
				// if tiddler is visible refresh it to show updated tag
				story.refreshTiddler(tagged[i].title,false,true);
			}
		}
		if (!this.tiddlerExists(title) &amp;&amp; newBody == &quot;&quot;) {
			// dont create unwanted tiddler
			return null;
		}
	}
	return this.saveTiddler_orig_tagrename(title,newTitle,newBody,modifier,modified,tags);
}

//}}}

</pre>
</div>
<div title="RunMacroIfTagged" modifier="SimonBaird" created="200601111402" modified="200603060419" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060419">
<pre>/***
Intended for use in ViewTemplate
!Examples
|{{{&lt;&lt;runMacroIfTagged [[Groceries]] toggleTag Buy&gt;&gt;}}}|&lt;&lt;runMacroIfTagged [[Groceries]] toggleTag Buy&gt;&gt;|
|{{{&lt;&lt;runMacroIfTagged Plugins toggleTag systemConfig&gt;&gt;}}}|&lt;&lt;runMacroIfTagged Plugins toggleTag systemConfig&gt;&gt;|
***/
//{{{

// This function contributed by Eric Shulman
function toggleTag(title,tag) {
 var t=store.getTiddler(title); if (!t || !t.tags) return;
 if (t.tags.find(tag)==null) t.tags.push(tag)
 else t.tags.splice(t.tags.find(tag),1)
}

// This function contributed by Eric Shulman
function isTagged(title,tag) {
 var t=store.getTiddler(title); if (!t) return false;
 return (t.tags.find(tag)!=null);
}

config.macros.runMacroIfTagged = {};
config.macros.runMacroIfTagged.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
 if (isTagged(tiddler.title,params[0]))
 config.macros[params[1]].handler(place,params[1],params.slice(2),wikifier,paramString/*fixme*/,tiddler);
}

//}}}
/***
!Todo
* paramString needs to have the first word removed from the front of it at fixme above


***/

</pre>
</div>
<div title="Salsa" modifier="SimonBaird" created="200601101237" modified="200601121442" tags="Groceries" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601121442">
<pre></pre>
</div>
<div title="SelectThemePlugin" modifier="SimonBaird" created="200604201329" modified="200605150456" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605150456">
<pre>/***

''This plugin was previously called StyleChooser.''

|Name|SelectThemePlugin|
|Created by|SimonBaird and SaqImtiaz|
|Location|http://lewcid.googlepages.com/lewcid.html#SelectThemePlugin|
|Version|1.2.3|
|Requires|~TW2.x|
!Description
*An alternative style switcher, can be used to switch just stylesheets and/or pagetemplates, or a combination of both (a theme)
*you can add your own stylesheets and pagetemplates, or use a ThemePack, like BigThemePack.

!Usage
* You have to have fetch or create some styleSheets and pageTemplates to use this plugin.
**You can either get a ThemePack like BigThemePack which automatically adds themes to ThemeSelect.
**or create tiddlers with styleSheets and pageTemplates and tag them styleSheets and pageTemplates respectively.
* Put {{{&lt;&lt;themeSelect style 'Select theme'&gt;&gt;}}} in your SideBarOptions.

!Creating Theme Packs
*You can create your own theme pack if you like. Instructions can be found [[here.|CreateThemePack]]

!History
* 15-May-06, v1.2.3, added paramifier so you can put theme on url, eg http://www.somewhere.com/twfile.html#theme:Berry2, thanks Clint (Simon).
* 28-Apr-o6, v1.2.2, fixed bug with opening TW after deleting themepacks. (Saq)
* 26-Apr-06, v1.2.1, more code optimization, dropdowns now updated on the fly. (Saq)
* 25-Apr-06, v1.2.0, added 3rd party ThemePack support, and made various other improvements.(Simon &amp; Saq)
* 24-Apr-06, v1.1.0, added: no styles and default styles options,&lt;&lt;br&gt;&gt;support for ThemePack, support for tag variations(Saq)
* 21-Apr-06, v1.0.0, Reworked dropdowns to include option for pagetemplates (Saq)
* 21-Apr-06, v0.9.0, Rewrote and added Saq's lovely dropdown select (Simon)
* 20-Apr-06, v0.0.1, Basic switcher working (Simon)

!Examples
|!Source|!Output|h
|{{{&lt;&lt;themeSelect style&gt;&gt;}}} for a dropdown with StyleSheets|&lt;&lt;themeSelect style&gt;&gt;|
|{{{&lt;&lt;themeSelect pagetemplate&gt;&gt;}}} for a dropdown with PageTemplates|&lt;&lt;themeSelect pagetemplate&gt;&gt;|
|{{{&lt;&lt;themeSelect style customlabel&gt;&gt;}}} to use a customlabel|&lt;&lt;themeSelect style customlabel&gt;&gt;|
* When applying a stylesheet or template, it also looks for a template or stylesheet respectively based on naming convention, eg MyFunkyStyleSheet and MyFunkyPageTemplate.

!Notes
* See also http://www.tiddlytools.com/#SelectStyleSheetPlugin for a more feature-rich style sheet switcher

! Ideas
* do ViewTemplate also?
* Pretty up the [x] bit

!Code
***/
//{{{
// for compatibility with TW &lt;2.0.9
if (!Array.prototype.contains)
   Array.prototype.contains = function(item)
   {
    return this.find(item) != null;
    };

// for compatibility with TW &lt;2.0.9
if (!Array.prototype.containsAny)
   Array.prototype.containsAny = function(items)
   {
    for(var i=0; i&lt;items.length; i++)
        if (this.contains(items[i]))
            return true;
    return false;
    };
//}}}

//{{{
version.extensions.SelectTheme = { major: 1, minor: 2, revision: 3, date: new Date(2006,5,15),
	source: &quot;http://lewcid.googlepages.com/lewcid.html#SelectTheme&quot;
};

config.SelectTheme = {
	things: {
		style: {
			tag:        [&quot;StyleSheets&quot;,&quot;StyleSheet&quot;,&quot;styleSheet&quot;,&quot;styleSheets&quot;,&quot;stylesheet&quot;,&quot;stylesheets&quot;],
			theDefault: &quot;StyleSheet&quot;,
			suffix:     &quot;StyleSheet&quot;,
			notify:     refreshStyles,
			cookie:     &quot;txtStyleSheet&quot;,
			otherThing: &quot;pagetemplate&quot;,
			label:      &quot;Choose StyleSheet: &quot;,
			tooltip:     &quot;Choose a StyleSheet&quot;,
			caseNone: { text:&quot;None&quot;, title:&quot;NoStyleSheet&quot;},
                        caseDefault: { text:&quot;Default&quot;, title:&quot;StyleSheet&quot; }

		},
		pagetemplate: {
			tag:        [&quot;PageTemplates&quot;,&quot;PageTemplate&quot;,&quot;pageTemplates&quot;,&quot;pageTemplate&quot;,&quot;pagetemplate&quot;,&quot;pagetemplates&quot;],
			theDefault: &quot;PageTemplate&quot;,
			suffix:     &quot;PageTemplate&quot;,
			notify:     refreshPageTemplate,
			cookie:     &quot;txtPageTemplate&quot;,
			otherThing: &quot;style&quot;,
			label: &quot;Choose PageTemplate: &quot;,
			tooltip:    &quot;Choose a PageTemplate&quot;,
			caseNone: { text:&quot;None&quot;, title:&quot;NoPageTemplate&quot;},
                        caseDefault: { text:&quot;Default&quot;, title:&quot;PageTemplate&quot; }
		}

	},

                         specialCases: [&quot;caseNone&quot;,&quot;caseDefault&quot;]

};

TiddlyWiki.prototype.removeNotification = function(title,fn) {
	for (var i=0;i&lt;this.namedNotifications.length;i++)
		if((this.namedNotifications[i].name == title) &amp;&amp; (this.namedNotifications[i].notify == fn))
			this.namedNotifications.splice(i,1); // counting on it only being there once
}


var things = config.SelectTheme.things;
var specialCases=config.SelectTheme.specialCases;

for (var t in things) {
	// make sure we have a value
	if (!config.options[things[t].cookie])
		config.options[things[t].cookie] = things[t].theDefault;

	// remove core notify
	store.removeNotification(things[t].theDefault,things[t].notify);

	// and add our one
	store.addNotification(config.options[things[t].cookie],things[t].notify);

}

//checks to see if a tiddler exists in store or as a shadow.
TiddlyWiki.prototype.isTiddler= function (title)
        {return store.tiddlerExists(title) || store.isShadowTiddler(title)}

//hijack core function &amp; make sure template exists
window.applyPageTemplate_themeSelect=window.applyPageTemplate;
window.applyPageTemplate=function(title){
           if(!store.isTiddler(title))
                       {title = things.pagetemplate.theDefault;}
           applyPageTemplate_themeSelect(title);
 }

TiddlyWiki.prototype.makeActiveTheme = function(what,title,alsoCheckOtherThing) {

	var thing = things[what];
        if (!store.isTiddler(title))
		title = thing.theDefault;

	var oldTitle = config.options[thing.cookie];

	if (what == &quot;style&quot;) {
		// remove old style element from DOM
		var oldStyleElement = document.getElementById(oldTitle);
		oldStyleElement.parentNode.removeChild(oldStyleElement);
	}

	store.removeNotification(oldTitle,thing.notify);
	store.addNotification(title,thing.notify);
	store.notify(title);

	config.options[thing.cookie] = title;
	saveOptionCookie(thing.cookie);
	if (alsoCheckOtherThing)
		this.makeActiveTheme(thing.otherThing,
				title.replace(new RegExp(thing.suffix+&quot;$&quot;),&quot;&quot;) + things[thing.otherThing].suffix,
						false);
};


config.shadowTiddlers.NoStyleSheet = &quot;&quot;;
config.shadowTiddlers.NoPageTemplate = config.shadowTiddlers.PageTemplate;


function switchTheme(e){
         if (!e) var e = window.event;
         var theTarget = resolveTarget(e);
         var theLink = theTarget;
         var switchTo= theLink.getAttribute(&quot;switchTo&quot;);
         var mode = theLink.getAttribute(&quot;mode&quot;);
         if ((config.options[things[mode].cookie])!=switchTo)
               {store.makeActiveTheme(mode,switchTo,true);};
         return(false);
}


config.macros.themeSelect={};
config.macros.themeSelect.dropdownchar = (document.all?&quot;&quot;:&quot;&quot;);
config.macros.themeSelect.handler = function(place,macroName,params,wikifier,paramString,tiddler){
         var arrow = config.macros.themeSelect.dropdownchar;
         var mode = params[0];
         var label = (params[1]?params[1]:things[mode].label) + arrow;
         var cookie = (config.options[things[mode].cookie]);

         var onclick = function(e)
             { if (!e) var e = window.event;
             var popup = Popup.create(this);

             var tagged=[];

	     store.forEachTiddler(function(title,tiddler) {
                  if ((tiddler.tags).containsAny(things[mode].tag)){
					tagged.push(tiddler.title);}
	     });

             //integrate ThemePacks
	     if (config.themes) {
		     // see what themes have been loaded...
		     for (var i=0;i&lt;config.themes.length;i++) {
			    // see if there is one
			    var lookForThis = config.themes[i] + things[mode].suffix;
			    if (store.isShadowTiddler(lookForThis)) {
				   tagged.pushUnique(lookForThis);
			    }
		    }
		     tagged = tagged.sort();
             }

             //this function used later to create buttons
             var createThemeButton = function(switchTo){
                        var theButton = createTiddlyButton(createTiddlyElement(popup,&quot;li&quot;),text,null,switchTheme,useClass);
                        theButton.setAttribute(&quot;switchTo&quot;,switchTo);
                        theButton.setAttribute(&quot;mode&quot;,mode);};

            //create Buttons for None(shadow styles) &amp; Default (StyleSheet)
                     // Default button is not created if StyleSheet doesnt exist.
             for(var t=0; t&lt;specialCases.length; t++){
             var special = specialCases[t];
             var text = things[mode][special].text;
             var useClass = &quot;tiddlyLinkExisting&quot;;   //redundant, optimize!
             if ((things[mode][special].title==cookie)||(special==&quot;caseNone&quot;&amp;&amp;!store.isTiddler(cookie)))
                      {text+= &quot; [x]&quot;;
                      useClass = &quot;currentlySelected&quot;;}
             if (!((special==&quot;caseDefault&quot;)&amp;&amp;(!store.getTiddler(things[mode][special].title))))
             createThemeButton(things[mode][special].title);     }

             //insert horizontal rule
             createTiddlyElement(createTiddlyElement(popup,&quot;li&quot;),&quot;hr&quot;);

             //create buttons for all other stylesheet tiddlers
             for(var t=0; t&lt;tagged.length; t++)
                     { var useClass = &quot;tiddlyLinkExisting&quot;;
                       var text = (tagged[t]).replace((things[mode].suffix),&quot;&quot;);
                     if (tagged[t]==(cookie) )
                           {text+=&quot; [x]&quot;; useClass=&quot;currentlySelected&quot;;}
                     if ((tagged[t]!= (things[mode].theDefault))&amp;&amp;tagged[t]!= (things[mode].none))
                        {createThemeButton(tagged[t]);}}
             Popup.show(popup,false);
             e.cancelBubble = true;
             if (e.stopPropagation)
                e.stopPropagation();
             return(false);
             };

        var createdropperButton = function(place){
           var sp = createTiddlyElement(place,&quot;span&quot;,null,&quot;ThemeChooserButton&quot;);
           var theDropDownBtn = createTiddlyButton(sp,label,things[mode].tooltip,onclick);
        };

        createdropperButton(place);
};


setStylesheet(&quot;.popup li a.currentlySelected {background:#ccc;color:black;font-weight:bold;}&quot;,&quot;currentlySelectedStyle&quot;); // could do better probably...

config.macros.layoutChooser=config.macros.themeSelect;

//shadow tiddler to hold instructions for creating ThemePacks
config.shadowTiddlers.ThemePack='See http://simonbaird.com/mptw/#CreateThemePack'; 

config.macros.applyTheme = {handler: function (place,macroName,params,wikifier,paramString,tiddler) {
	var theme = params[0];
	var label = params[1]?params[1]:'Apply theme &quot;' + theme + '&quot;';
        var tooltip = 'Apply the &quot;'+theme+'&quot; theme to this TiddlyWiki';
	createTiddlyButton(place,label,tooltip,function() {
		store.makeActiveTheme(&quot;style&quot;,theme+things.style.suffix,true);
	});
}};


// this means you can put #theme:ThemeName in url. suggested by Clint
config.paramifiers.theme = {
	onstart: function(themeName) {
		store.makeActiveTheme(&quot;style&quot;,themeName+config.SelectTheme.things.style.suffix,true);
	}
};

//}}}

</pre>
</div>
<div title="Separate hideSomeTags into separate plugin" modifier="SimonBaird" created="200603091314" modified="200603091314" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091314">
<pre></pre>
</div>
<div title="ShadowTiddlers" modifier="SimonBaird" created="200601061741" modified="200601190933" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601190933">
<pre>&lt;&lt;list shadowed&gt;&gt;</pre>
</div>
<div title="ShoppingListMaker" modifier="SimonBaird" created="200601101230" modified="200603060110" tags="FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060110">
<pre>Click close others. Then click [[Buy]] and select items below to see and update your current shopping list. Also open [[Beer]] and click the Buy checkbox in the toolbar.
Note: forEachTiddler now working!! Thanks Udo.
Source: {{{&lt;&lt;forEachTiddler where tiddler.tags.contains('Groceries') write '&quot;&lt;&lt;toggleTag Buy &quot;+tiddler.title+&quot;$))\n&quot;'&gt;&gt;}}}:
&lt;&lt;forEachTiddler where tiddler.tags.contains('Groceries') sortBy 'tiddler.title' write '&quot;&lt;&lt;toggleTag Buy &quot;+tiddler.title+&quot;$))\n&quot;'&gt;&gt;
See also [[Groceries]], [[Buy]], [[ToggleTagMacro]], ViewTemplate</pre>
</div>
<div title="ShowClockMacro" modifier="YourName" created="200607120128" modified="200608021529" tags="systemConfig Plugins WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608021529">
<pre>/***
!Example Usage
&lt;&lt;eg
| Local|&lt;&lt;showClock\&gt;\&gt;|
| Queensland|&lt;&lt;showClock +10\&gt;\&gt;|
| England (DST)|&lt;&lt;showClock +1\&gt;\&gt;|
| California (DST)|&lt;&lt;showClock -7\&gt;\&gt;|
&gt;&gt;
***/
//{{{
version.extensions.ShowClockMacro = { major: 0, minor: 0, revision: 1, date: new Date(2006,7,12),
	source: &quot;http://tiddlyspot.com/mptw/#ShowClockMacro&quot;
};

config.macros.showClock = {

	defaultClass: 'clock',
	tickDelay: 1000, 
	format: &quot;0hh:0mm:0ss&quot;,

	styles: 
		&quot;.clock {\n&quot;+
		&quot;  padding:0 0.5em;\n&quot;+
		&quot;}\n&quot; +
		&quot;.clock .dow    { color:#000; }\n&quot; +
		&quot;.clock .time   { color:#000; }\n&quot; +
		&quot;.clock .offset { color:#999; }\n&quot; +
		&quot;&quot;,

	count: 0,

	handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		var offset = params[0] || '';
		var useClass = params[1] || this.defaultClass;
		var c = this.count++;
		var clockElement = createTiddlyElement(place, &quot;span&quot;, &quot;clock&quot; + c, useClass);
		clockElement.setAttribute(&quot;offset&quot;,offset);
		this.refreshDisplay(c);
		this.waitForTick(c);
	},

	waitForTick: function(c) {
		setTimeout(&quot;config.macros.showClock.tick(&quot; + c + &quot;)&quot;, this.tickDelay);
	},

	tick: function(c) {
		if (this.stillHere(c)) {
			this.refreshDisplay(c)
			this.waitForTick(c);
		}
	},

	getClock: function(c) {
		return document.getElementById(&quot;clock&quot; + c);
	},

	stillHere: function(c) {
		return this.getClock(c) != null;
	},

	refreshDisplay: function(c) {
		var clock = this.getClock(c);
		var offset = clock.getAttribute(&quot;offset&quot;)
		var now = new Date();
		//var label = &quot;local&quot;;
		var label = &quot;&quot;;
		if (offset &amp;&amp; offset != '') {
			var offsetInt = parseInt(offset);
			now.setHours(now.getHours() + (now.getTimezoneOffset() / 60) + offsetInt);
			label = &quot;GMT &quot; + (offsetInt == 0 ? &quot;&quot; : offsetInt &gt; 0 ? &quot;+&quot;+offsetInt : offsetInt);
		}
		clock.innerHTML =
			'&lt;span class=&quot;dow&quot;&gt;' + now.formatString(&quot;DDD&quot;).substr(0,3) + ' &lt;/span&gt;' +
			'&lt;span class=&quot;time&quot;&gt;' + now.formatString(this.format) + '&lt;/span&gt;' + 
			'&lt;span class=&quot;offset&quot;&gt; ' + label + '&lt;/span&gt;'
	}

};

setStylesheet(config.macros.showClock.styles,&quot;showClockStyles&quot;);

//}}}
</pre>
</div>
<div title="ShowExampleMacro" modifier="SimonBaird" created="200607120336" modified="200607120407" tags="systemConfig Plugins WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607120407">
<pre>/***
This is a little utility useful for demonstrating markup and macro usage. There are two versions, one puts the example code and the wikified output in two columns of a table. The other puts the example code above the wikified output. Use \ to escape &gt; for closing macros. See ShowClockMacro for another example.

Example usage of the inline version, eg:
{{{
&lt;&lt;eg
Version &lt;&lt;version\&gt;\&gt;
&gt;&gt;
}}}
Does this:
&lt;&lt;eg
Version &lt;&lt;version\&gt;\&gt;
&gt;&gt;
Example usage of the tabular version, egt:
{{{&lt;&lt;egt Version &lt;&lt;version\&gt;\&gt; &gt;&gt;}}}
Shows this:
&lt;&lt;egt Version &lt;&lt;version\&gt;\&gt; &gt;&gt;



***/
//{{{
version.extensions.ExampleMacro = { major: 0, minor: 0, revision: 1, date: new Date(2006,7,12),
	source: &quot;http://tiddlyspot.com/timezones/#ExampleMacro&quot;
};

config.macros.eg = { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		var p = paramString.replace(/\\&gt;/g,'&gt;');
		wikify(&quot;''Markup''\n{{{\n&quot;+p+&quot;\n}}}\n''Result''\n&quot;+p+&quot;\n&quot;,place,null,tiddler);
}}

config.macros.egt = { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		var p = paramString.replace(/\\&gt;/g,'&gt;');
		wikify(&quot;|Markup|Result|h\n|{{{&quot;+p+&quot;}}}|&quot;+p+&quot;|\n&quot;, place,null,tiddler);
}}


//}}}
</pre>
</div>
<div title="SideBarWhiteAndGrey" modifier="SimonBaird" created="200601072255" modified="200603021620" tags="CSS" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603021620">
<pre>/***
This CSS by DaveBirss.
***/
/*{{{*/

.tabSelected {
 background: #fff;
}

.tabUnselected {
 background: #eee;
}

#sidebar {
 color: #000;
 background: transparent; 
}

#sidebarOptions {
 background: #fff;
}

#sidebarOptions .button {
 color: #999;
}

#sidebarOptions .button:hover {
 color: #000;
 background: #fff;
 border-color:white;
}

#sidebarOptions .button:active {
 color: #000;
 background: #fff;
}

#sidebarOptions .sliderPanel {
 background: transparent;
}

#sidebarOptions .sliderPanel A {
 color: #999;
}

#sidebarOptions .sliderPanel A:hover {
 color: #000;
 background: #fff;
}

#sidebarOptions .sliderPanel A:active {
 color: #000;
 background: #fff;
}

.sidebarSubHeading {
 color: #000;
}

#sidebarTabs {`
 background: #fff
}

#sidebarTabs .tabSelected {
 color: #000;
 background: #fff;
 border-top: solid 1px #ccc;
 border-left: solid 1px #ccc;
 border-right: solid 1px #ccc;
 border-bottom: none;
}

#sidebarTabs .tabUnselected {
 color: #999;
 background: #eee;
 border-top: solid 1px #ccc;
 border-left: solid 1px #ccc;
 border-right: solid 1px #ccc;
 border-bottom: none;
}

#sidebarTabs .tabContents {
 background: #fff;
}


#sidebarTabs .txtMoreTab .tabSelected {
 background: #fff;
}

#sidebarTabs .txtMoreTab .tabUnselected {
 background: #eee;
}

#sidebarTabs .txtMoreTab .tabContents {
 background: #fff;
}

#sidebarTabs .tabContents .tiddlyLink {
 color: #999;
}

#sidebarTabs .tabContents .tiddlyLink:hover {
 background: #fff;
 color: #000;
}

#sidebarTabs .tabContents {
 color: #000;
}

#sidebarTabs .button {
 color: #666;
}

#sidebarTabs .tabContents .button:hover {
 color: #000;
 background: #fff;
}


/*}}}*/</pre>
</div>
<div title="SimonBaird" modifier="SimonBaird" created="200603241540" modified="200603241540" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603241540">
<pre>&lt;&lt;tiddler Contact&gt;&gt;</pre>
</div>
<div title="SiteMap" modifier="SimonBaird" created="200603091318" modified="200604041238" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041238">
<pre>(See also SliderSiteMap)
|&lt;&lt;siteMap WhatsNew&gt;&gt;&lt;&lt;siteMap FunStuff&gt;&gt;&lt;&lt;siteMap Todo . . . . Done&gt;&gt;|&lt;&lt;siteMap TagglyTagging&gt;&gt;&lt;&lt;siteMap More... 2&gt;&gt;|&lt;&lt;siteMap Plugins 2&gt;&gt;|
|noBorder threeCol|k
</pre>
</div>
<div title="SiteMapMacro" modifier="Simon" created="200603090651" modified="200607170024" tags="Plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607170024">
<pre>/***
| Name:|SiteMapMacro|
| Author:|Simon Baird|
| Location:|http://simonbaird.com/mptw/#SiteMapMacro|
| Version:|1.0.3, 15-Mar-06|

!!Examples
See SiteMap and SliderSiteMap for example usage.

!!Parameters
* Name of tiddler to start at
* Max depth (a number) 
* Format (eg, nested, see formats below)
* Don't show root flag (anything other than null turns it on)
* Tags - a string containing a bracketed list of tags that we are interested in

!!History
* 1.0.3 (15-Mar-06)
** added tag filtering
* 1.0.2 (15-Mar-06)
** Added json format and dontshowroot option
* 1.0.1 (9-Mar-06)
** Added selectable formats and fixed nested slider format
* 1.0.0 (8-Mar-06)
** first release

***/
//{{{

version.extensions.SiteMapMacro = {
	major: 1,
	minor: 0,
	revision: 3,
	date: new Date(2006,3,15),
	source: &quot;http://simonbaird.com/mptw/#SiteMapMacro&quot;
};

config.macros.siteMap = {

	formats: {
		bullets: {
			formatString: &quot;%0[[%1]]\n%2&quot;,
			indentString: &quot;*&quot;
		},

		// put this in your StyleSheet to make it look good.
		// .sliderPanel { margin-left: 2em; }

		sliders: {
			formatString: &quot;[[%1]]+++\n%2===\n\n&quot;,
			formatStringLeaf: &quot;[[%1]]\n&quot;
		},

		openSliders: {
			formatString: &quot;[[%1]]++++\n%2===\n\n&quot;,
			formatStringLeaf: &quot;[[%1]]\n&quot;
		},

		popups: {
			formatString: &quot;[[%1]]+++^\n%2===\n\n&quot;,
			formatStringLeaf: &quot;[[%1]]\n&quot;
		},

		// these don't work too well
		openPopups: {
			formatString: &quot;[[%1]]++++^\n%2===\n\n&quot;,
			formatStringLeaf: &quot;[[%1]]\n&quot;
		},
		
		// this is a little nuts but it works
		json: {
			formatString: '\n%0{&quot;%1&quot;:[%2\n%0]}',
			formatStringLeaf: '\n%0&quot;%1&quot;',
			indentString: &quot;  &quot;,
			separatorString: &quot;,&quot;
		}


	},

	defaultFormat: &quot;bullets&quot;,

	treeTraverse: function(title,depth,maxdepth,format,dontshowroot,tags,excludetags) {

		var tiddler = store.getTiddler(title);
		var tagging = store.getTaggedTiddlers(title);

		if (dontshowroot)
			depth = 0;

		var indent = &quot;&quot;;
		if (this.formats[format].indentString)
			for (var j=0;j&lt;depth;j++)
				indent += this.formats[format].indentString;

		var childOutput = &quot;&quot;;
		if (!maxdepth || depth &lt; parseInt(maxdepth)) 
			for (var i=0;i&lt;tagging.length;i++)
				if (tagging[i].title != title) {
					if (this.formats[format].separatorString &amp;&amp; i != 0)
						childOutput += this.formats[format].separatorString;
					childOutput += this.treeTraverse(tagging[i].title,depth+1,maxdepth,format,null,tags,excludetags);
				}

		if (childOutput == &quot;&quot; &amp;&amp; (
				(tags &amp;&amp; tags != &quot;&quot; &amp;&amp; !tiddler.tags.containsAll(tags.readBracketedList())) ||
				(excludetags &amp;&amp; excludetags != &quot;&quot; &amp;&amp; tiddler.tags.containsAny(excludetags.readBracketedList()))
				)
			) {
			// so prune it cos it doesn't have the right tags and neither do any of it's children
			return &quot;&quot;;
		}

		if (dontshowroot)
			return childOutput;

		if (this.formats[format].formatStringLeaf &amp;&amp; childOutput == &quot;&quot;) {
			// required for nestedSliders
			return this.formats[format].formatStringLeaf.format([indent,title,childOutput]);
		}

		return this.formats[format].formatString.format([indent,title,childOutput]);
	},

	handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		wikify(this.treeTraverse(
			params[0] &amp;&amp; params[0] != '.' ? params[0] : tiddler.title, 1, 
			params[1] &amp;&amp; params[1] != '.' ? params[1] : null, // maxdepth
			params[2] &amp;&amp; params[2] != '.' ? params[2] : this.defaultFormat, // format
			params[3] &amp;&amp; params[3] != '.' ? params[3] : null, // dontshowroot
			params[4] &amp;&amp; params[4] != '.' ? params[4] : null, // tags
			params[5] &amp;&amp; params[5] != '.' ? params[5] : null // excludetags
			),place);
	}

}

//}}}
</pre>
</div>
<div title="SliderSiteMap" modifier="Simon" created="200603092325" modified="200607170024" tags="FunStuff" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607170024">
<pre>Demo of slider formatting in SiteMapMacro
|!sliders|!openSliders|!popups|
|{{{&lt;&lt;siteMap TagglyTagging . sliders&gt;&gt;}}}|{{{&lt;&lt;siteMap TagglyTagging . openSliders&gt;&gt;}}}|{{{&lt;&lt;siteMap TagglyTagging . popups&gt;&gt;}}}|
|&lt;&lt;siteMap TagglyTagging . sliders&gt;&gt;|&lt;&lt;siteMap TagglyTagging . openSliders&gt;&gt;|&lt;&lt;siteMap TagglyTagging . popups&gt;&gt;|</pre>
</div>
<div title="Something about refreshing all visible tiddlers on any update" modifier="SimonBaird" created="200603011030" modified="200603011046" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603011046">
<pre>As Eric points out you don't always want that.</pre>
</div>
<div title="Status" modifier="SimonBaird" created="200604041732" modified="200604041732" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041732">
<pre></pre>
</div>
<div title="StepWiseNavigation" modifier="SimonBaird" created="200603021233" modified="200604271312" tags="Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604271312">
<pre>/***
Keep just two tiddlers open a time, the one you clicked on and the one containing the link you just clicked.
As suggested by Elise Springer.
***/
//{{{
version.extensions.StepWiseNavigation = { major: 1, minor: 0, revision: 1,
	date: new Date(2006,4,27),
	source: &quot;http://simonbaird.com/mptw/#StepWiseNavigation&quot;
};

if (config.options.chkStepWiseNavigationOn == undefined)
	config.options.chkStepWiseNavigationOn = true;

config.shadowTiddlers.AdvancedOptions +=
		&quot;\n&lt;&lt;option chkStepWiseNavigationOn&gt;&gt; StepWiseNavigation&quot;;

Story.prototype.displayTiddler_orig_stepwise=Story.prototype.displayTiddler;
Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly) {
	if (config.options.chkStepWiseNavigationOn &amp;&amp; srcElement &amp;&amp; this.findContainingTiddler(srcElement))
		this.closeAllTiddlers(this.findContainingTiddler(srcElement).getAttribute(&quot;tiddler&quot;));
	this.displayTiddler_orig_stepwise(srcElement,title,template,animate,slowly)
}

//}}}
</pre>
</div>
<div title="StyleSheets" modifier="SimonBaird" created="200604201657" modified="200604201657" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604201657">
<pre>Used by StyleChooser</pre>
</div>
<div title="TWUpdate" modifier="SimonBaird" created="200604221342" modified="200604221342" tags="systemConfig Borrowed Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604221342">
<pre>/***
''Name:'' TWUpdate
''Author:'' Tom Otvos
''Version:'' 0.2
&lt;&lt;twupdate&gt;&gt;
***/
//{{{

version.extensions.twupdate = {major: 0, minor: 2, revision: 0, date: new Date(2006,3,13,0,0,0,0), source: &quot;&quot;};

config.macros.twupdate = { 
	label: &quot;update&quot;,
	sourceUrl: &quot;http://www.tiddlywiki.com/empty.html&quot;, 
	lingo: {
		prompt: &quot;Update this TiddlyWiki from TiddlyWiki.com&quot;, 
		warning: &quot;Are you sure you want to update this document with the latest version of TiddlyWiki?\n\nIf you want to continue, your document will first be saved with a backup.&quot;,
		success: &quot;Update was successful. Click on 'OK' to reload the document&quot;,
		errNoHttp: &quot;Unable to allocate an HTTP request object for the update&quot;,
		progressLoading: &quot;Getting update from TiddlyWiki.com...&quot;,
		progressLoadSuccess: &quot;File successfully loaded&quot;,
		progressLoadFailure: &quot;File was not loaded successfully (%0)&quot;,
		progressMerging: &quot;Merging with existing document...&quot;
	}
}

config.macros.twupdate.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place, this.label, this.prompt, this.onClick, null, null, null);
}

config.macros.twupdate.onClick = function(e)
{
	if (!confirm(config.macros.twupdate.lingo.warning)) return;

	try {
		// force a save with backup
		var saveBackups = config.options.chkSaveBackups;
		config.options.chkSaveBackups = true;
		saveChanges();
		config.options.chkSaveBackups = saveBackups;
		
		var ajax = new AjaxHelper();
		displayMessage(config.macros.twupdate.lingo.progressLoading);
		ajax.getText(config.macros.twupdate.sourceUrl, config.macros.twupdate.performUpdate);		
	}
	catch (e) {
		alert(e);
	}

	return false;
}

config.macros.twupdate.performUpdate = function(emptyHtml, status, statusText)
{
	// note that this is begin called from a callback from an event handler, so
	// &quot;this&quot; is most definitely not defined!
	
	if (status == 200)
		displayMessage(config.macros.twupdate.lingo.progressLoadSuccess);
	else {
		displayMessage(config.macros.twupdate.lingo.progressLoadFailure.format([statusText]));
		return;
	}
	displayMessage(config.macros.twupdate.lingo.progressMerging);
	
	// the bulk of this is cribbed from saveChanges()...
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if (originalPath.substr(0,5) != &quot;file:&quot;) {
		alert(config.messages.notFileUrlError);
		if (store.tiddlerExists(config.messages.saveInstructions))
			displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);

	// Locate the storeArea div's
	var posOpeningDiv = emptyHtml.indexOf(startSaveArea);
	var posClosingDiv = emptyHtml.lastIndexOf(endSaveArea);
	if ((posOpeningDiv == -1) || (posClosingDiv == -1)) {
		alert(config.messages.invalidFileError.format(['empty.html']));
		return;
	}

	// Save new file
	var revised = emptyHtml.substr(0,posOpeningDiv + startSaveArea.length) + 
				convertUnicodeToUTF8(allTiddlersAsHtml()) + &quot;\n\t\t&quot; +
				emptyHtml.substr(posClosingDiv);
	var newSiteTitle = convertUnicodeToUTF8((wikifyPlain(&quot;SiteTitle&quot;) + &quot; - &quot; + wikifyPlain(&quot;SiteSubtitle&quot;)).htmlEncode());
	revised = revised.replaceChunk(&quot;&lt;title&quot;+&quot;&gt;&quot;,&quot;&lt;/title&quot;+&quot;&gt;&quot;,&quot; &quot; + newSiteTitle + &quot; &quot;);
	revised = revised.replaceChunk(&quot;&lt;!--PRE-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPreHead&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--POST-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPostHead&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--PRE-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPreBody&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--POST-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPostBody&quot;,&quot;&quot;) + &quot;\n&quot;);
	var save = saveFile(localPath, revised);
	if (save) {
		displayMessage(config.messages.mainSaved, &quot;file://&quot; + localPath);
		store.setDirty(false);
		alert(config.macros.twupdate.lingo.success);
		document.location.reload();
	}
	else
		alert(config.messages.mainFailed);
}

function AjaxHelper()
{
	this.http = null;
	
	try
	{
		this.http = new XMLHttpRequest()
	}
	
	catch(e)
	{
		// if we don't get an internal object, try allocating it using ActiveX, with successive
		// fallbacks to earlier MSXML versions as necessary
		try
		{
			this.http = new ActiveXObject(&quot;Msxml2.XMLHTTP.4.0&quot;)
		} 
		catch(e) 
		{
			try
			{
				this.http = new ActiveXObject(&quot;MSXML2.XMLHTTP&quot;)
			} 
			catch(e) 
			{
				try
				{
					this.http = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)
				} 
				catch(e) 
				{
					this.http = null
				}
			}
		}
	}
		
	if (!this.http) throw 'Unable to allocate an HTTP request object';
}

AjaxHelper.prototype.getText = function(url, callback, async, force)
{
	if (!this.http) return;
	if (async == undefined) async = true;
	if (force == undefined) force = false;
	// ??? right now, we are not handling &quot;forced&quot; requests
	this._request(&quot;GET&quot;, url, callback, async, true, false);
}

AjaxHelper.prototype.getXML = function(url, callback, async, force)
{
	if (!this.http) return;
	if (async == undefined) async = true;
	if (force == undefined) force = false;
	// ??? right now, we are not handling &quot;forced&quot; requests
	this._request(&quot;GET&quot;, url, callback, async, true, true);
}

AjaxHelper.prototype.getHead = function(url, callback, async, force)
{
	if (!this.http) return;
	if (async == undefined) async = true;
	if (force == undefined) force = false;
	// ??? right now, we are not handling &quot;forced&quot; requests
	this._request(&quot;HEAD&quot;, url, callback, async, false, false);
}

AjaxHelper.prototype.abort = function()
{
	if (this.http) this.http.abort();
}

AjaxHelper.prototype.setRequestHeader = function(name, value)
{
	if (this.http) this.http.setRequestHeader(name, value);
}

AjaxHelper.prototype._request = function(method, url, callback, async, hasResponse, hasResponseXML)
{
	if (!this.http) return;
	
	// get reference to request object so we can use it in closure
	var xmlHttp = this.http, helper = this;
	xmlHttp.onreadystatechange = function()
	{
		if (!async) return;
		if (xmlHttp.readyState == 4)
			callback((hasResponse ? (hasResponseXML ? xmlHttp.responseXML : xmlHttp.responseText) : null), xmlHttp.status, xmlHttp.statusText, helper._parsedResponseHeaders());
	}
	
	try {
		// need some cross-domain privileges for Firefox
		try {
			netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);
		} 
		catch (e) 
		{
		}
		
		xmlHttp.open(method, url, async);
		xmlHttp.send(null);
		if (!async) callback((hasResponse ? (hasResponseXML ? xmlHttp.responseXML : xmlHttp.responseText) : null), xmlHttp.status, xmlHttp.statusText, this._parsedResponseHeaders());
	}
	
	catch (e)
	{
		alert(e);
	}
}

AjaxHelper.prototype._parsedResponseHeaders = function()
{
	if (this.http) {
		var headersArray = new Array();
		var headers = this.http.getAllResponseHeaders().split(&quot;\n&quot;);
		for (var i = 0; i &lt; headers.length; i++) {
			var h = headers[i].trim();
			if (h.length == 0) continue;
			// value can have ':' so do not use split here!
			var sep = h.indexOf(':');
			headersArray[h.substring(0, sep).trim()] = h.substr(sep + 1).trim();
		}
		return headersArray;
	}
	else
		return null;
}

//}}}
</pre>
</div>
<div title="TagBasedTemplates" modifier="SimonBaird" created="200601120431" modified="200603080031" tags="Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603080031">
<pre>/***
| Name:|TagBasedTemplates|
| Source:|http://simonbaird.com/mptw/#TagBasedTemplates|
| Version:|1.0.1 (8-Mar-2006)|
| Usage:|See [[FlipMeOver!]] for an example|

!Notes
If there is more than one match the first one wins...

!History
* 1.0.1 (8-Mar-2006)
** added format string
* 1.0.0 (8-Mar-2006)
** simplified to just look for existence of &quot;~TagNameViewTemplate&quot; as suggested by tomo on TiddlyWikiDev
* Prototype (12-Jan-2006)

***/
//{{{

version.extensions.TagBasedTemplates = { major: 1, minor: 0, revision: 1, date: new Date(2006,3,8),
	source: &quot;http://simonbaird.com/mptw/#TagBasedTemplates&quot;
};

config.TagBasedTemplates = { templateFormat: &quot;%0ViewTemplate&quot; }; // in case you want to tweak it

story.chooseTemplateForTiddler = function(title,template) {
	if (!template) {
		var tiddler = store.getTiddler(title);
		if (tiddler)
			for (var j=0; j&lt;tiddler.tags.length; j++) {
				var lookFor = config.TagBasedTemplates.templateFormat.format([tiddler.tags[j]]);
				if (store.tiddlerExists(lookFor))
					return lookFor;
		}
		return config.tiddlerTemplates[DEFAULT_VIEW_TEMPLATE];
	}
	return config.tiddlerTemplates[template];
};

//}}}
</pre>
</div>
<div title="TagUtils" modifier="YourName" created="200604041720" modified="200609062338" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200609062338">
<pre>/***
TagUtils
http://simonbaird.com/mptw/#TagUtils
Doesn't do anything except provide functions for use in other plugins
Sorry no documentation! RTFC  :)

!Update
Added some macros. See Examples.

!Todo
Sorting is next

!Example
Note: you must have spaces between every element including brackets and logical operators
{{{&lt;&lt;listByTagExpr '( Todo || Tasks ) &amp;&amp; ! Done'&gt;&gt;}}}
&lt;&lt;listByTagExpr '( Todo || Tasks ) &amp;&amp; ! Done'&gt;&gt;

{{{&lt;&lt;listByTagExprWithExcerpt '( Todo || Tasks ) &amp;&amp; Urgent &amp;&amp; ! Done'&gt;&gt;}}}
&lt;&lt;listByTagExprWithExcerpt '( Todo || Tasks ) &amp;&amp; ! Done'&gt;&gt;

***/
//{{{

// Array methods originally written by Udo

if (!Array.prototype.indexOf)
	Array.prototype.indexOf = function(item) {
		for (var i=0;i&lt;this.length;i++)
			if (this[i] == item)
				return i;
		return -1;
	};

if (!Array.prototype.contains)
	Array.prototype.contains = function(item) {
		return (this.indexOf(item) &gt;= 0);
	};

if (!Array.prototype.containsAny)
	Array.prototype.containsAny = function(items) {
		for (var i=0;i&lt;items.length;i++)
			if (this.contains(items[i]))
				return true;
		return false;
	};

if (!Array.prototype.containsAll)
	Array.prototype.containsAll = function(items) {
		for (var i = 0; i &lt; items.length; i++)
			if (!this.contains(items[i]))
				return false;
		return true;
	};


var allowBracketedList = function(tags) {
	return (typeof(tags) == &quot;string&quot;) ? tags.readBracketedList() : tags;
}

var getTitles = function(tiddlers) {
	var titles = [];
	for (var i=0;i&lt;tiddlers.length;i++)
		titles[i] = tiddlers[i].title;
	return titles;
}

Tiddler.prototype.hasTag = function(tag) {
	return this.tags.contains(tag)
}

Tiddler.prototype.hasAnyTag = function(tags) {
	return this.tags.containsAny(allowBracketedList(tags));
}

Tiddler.prototype.hasAllTags = function(tags) {
	return this.tags.containsAll(allowBracketedList(tags));
}

Tiddler.prototype.addTag = function(tag) {
	if (!this.hasTag(tag))
		this.tags.push(tag);
}

Tiddler.prototype.addTags = function(tags) {
	var newTags = allowBracketedList(tags);
	for (var i=0;i&lt;newTags.length;i++)
		this.addTag(newTags[i]);
}

Tiddler.prototype.removeTag = function(tag) {
	if (this.hasTag(tag))
		this.tags.splice(this.tags.indexOf(tag),1);
}

Tiddler.prototype.removeTags = function(tags) {
	var deadTags = allowBracketedList(tags);
	for (var i=0;i&lt;deadTags.length;i++)
		this.removeTag(deadTags[i]);
}

Tiddler.prototype.removeTagsFromGroup = function(tagGroup) {
	// the tags are tagged with tagGroup, taggly style
	var tagsInGroup = getTitles(store.getTaggedTiddlers(tagGroup));
	for (var i=0;i&lt;tagsInGroup.length;i++)
		this.removeTag(tagsInGroup[i]);
}

Tiddler.prototype.setUniqueTagFromGroup = function(tag,tagGroup) {
	// used for a single value dropdown
	this.removeTagsFromGroup(tagGroup);
	this.addTag(tag);
}

Tiddler.prototype.setUniqueTagFromList = function(tag,tagList) {
	// will probably never use this since I like setUniqueTagFromGroup
	this.removeTags(tagList);
	this.addTag(tag);
}

TiddlyWiki.prototype.getTiddlersByTag = function(includeTags,excludeTags,includeMode,excludeMode) {
	includeTags = allowBracketedList(includeTags);
	excludeTags = allowBracketedList(excludeTags);
	if (!includeMode) includeMode = 'all';
	if (!excludeMode) excludeMode = 'any';
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var included = (includeMode == 'any') ?
				tiddler.hasAnyTag(includeTags) :
				tiddler.hasAllTags(includeTags);
		var excluded = (excludeMode == 'any') ?
				tiddler.hasAnyTag(excludeTags):
				tiddler.hasAllTags(excludeTags);
		if (included &amp;&amp; !excluded)
			results.push(tiddler);
	});
	return results;
}

TiddlyWiki.prototype.getTiddlersByTagExpression = function(expression) {
	// example expression
	// &quot;( [[A Tag]] || Tag2 ) &amp;&amp; ! Tag3&quot;
	// must have spaces between everything
	var splitExpression = expression.readBracketedList(false); // false means not unique. thanks Jeremy!!
	var asIs = ['(',')','||','&amp;&amp;','!']; // better not have any tags called those!
	var translatedExpression = &quot;&quot;;
	for (var i=0;i&lt;splitExpression.length;i++)
		if (asIs.contains(splitExpression[i]))
			translatedExpression += splitExpression[i];
		else
			translatedExpression += &quot;tiddler.hasTag('&quot;+splitExpression[i]+&quot;')&quot;;
	// alert(translatedExpression);
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if (eval('('+translatedExpression+')'))
			results.push(tiddler);
	});
	return results;
}

Array.prototype.tiddlerList = function(listFormat) {
	var output = &quot;&quot;;
	if (!listFormat) listFormat = &quot;'*[['+tiddler.title+']]\\n'&quot;;
	if (this.length &gt; 0 &amp;&amp; this[0] instanceof Tiddler) {
		for (var i=0;i&lt;this.length;i++) {
			var tiddler = this[i];
			output += eval(listFormat);
		}
	}
	return output;
}
	
Array.prototype.tiddlerListWithExcerpt = function(listFormat) {
	return this.tiddlerList(&quot;'*[['+tiddler.title+']] tiddler.text.trim().substr(20)...\\n'&quot;);
}

String.prototype.prettyTrim = function(len,prefix,postfix) {
	var result = this.trim().replace(/\r\n/g,' ').replace(/[\n|\t]/g,' ');
	if (result.length &gt; len - 3)
		return result.trim().substr(0,len) + '...';
	else
		return result;
}

String.prototype.prettyTrim2 = function(len,prefix,postfix) {
	if (!prefix) prefix = '';
	if (!postfix) postfix = '';
	return prefix + this.prettyTrim(len) + postfix;
}

	
Array.prototype.tiddlerListWithExcerpt = function(listFormat) {
	return this.tiddlerList(&quot;'*[['+tiddler.title+']] ' + tiddler.text.prettyTrim2(60,' - ') + '\\n'&quot;);
}

config.macros.listByTag = {};
config.macros.listByTag.handler =
 function(place,macroName,params,wikifier,paramString,tiddler) {
	wikify(store.getTiddlersByTag(params[0],params[1],params[2],params[3]).tiddlerList(),place,null,tiddler);
};

config.macros.listByTagWithExcerpt = {};
config.macros.listByTagWithExcerpt.handler =
 function(place,macroName,params,wikifier,paramString,tiddler) {
	wikify(store.getTiddlersByTag(params[0],params[1],params[2],params[3]).tiddlerListWithExcerpt(),place,null,tiddler);
};

config.macros.listByTagExpr = {};
config.macros.listByTagExpr.handler =
 function(place,macroName,params,wikifier,paramString,tiddler) {
	wikify(store.getTiddlersByTagExpression(params[0]).tiddlerList(),place,null,tiddler);
};

config.macros.listByTagExprWithExcerpt = {};
config.macros.listByTagExprWithExcerpt.handler =
 function(place,macroName,params,wikifier,paramString,tiddler) {
	wikify(store.getTiddlersByTagExpression(params[0]).tiddlerListWithExcerpt(),place,null,tiddler);
};



//}}}
</pre>
</div>
<div title="Tagging Utils" modifier="SimonBaird" created="200603060045" modified="200603060055" tags="Snippets" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060055">
<pre>//{{{
// uses code originally written by Eric Shulman

if (!store.addTag) {
	store.addTag = function(title,tag) {
		var t=this.getTiddler(title); if (!t || !t.tags) return;
		t.tags.push(tag);
	};
};

if (!store.removeTag) {
	store.removeTag = function(title,tag) {
		var t=this.getTiddler(title); if (!t || !t.tags) return;
		if (t.tags.find(tag)!=null) t.tags.splice(t.tags.find(tag),1);
	};
};

if (!store.toggleTag) {
	store.toggleTag = function(title,tag) {
		var t=this.getTiddler(title); if (!t || !t.tags) return;
		if (t.tags.find(tag)==null) t.tags.push(tag);
		else t.tags.splice(t.tags.find(tag),1);
	};
};

if (!store.isTagged) {
	store.isTagged = function(title,tag) {
		var t=this.getTiddler(title); if (!t) return false;
		return (t.tags.find(tag)!=null);
	};
};

//}}}
</pre>
</div>
<div title="TagglyListPlugin" modifier="SimonBaird" created="200601140102" modified="200604250714" tags="TagglyTagging systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604250714">
<pre>/***
|Name|TagglyListPlugin|
|Created by|SimonBaird|
|Location|http://simonbaird.com/mptw/#TagglyListPlugin|
|Version|1.1.2 25-Apr-06|
|Requires|See TagglyTagging|

!History
* 1.1.2 (25-Apr-2006) embedded TagglyTaggingStyles. No longer need separated tiddler for styles.
* 1.1.1 (6-Mar-2006) fixed bug with refreshAllVisible closing tiddlers being edited. Thanks Luke Blanshard.

***/

/***
!Setup and config
***/
//{{{

version.extensions.TagglyListPlugin = {
	major: 1, minor: 1, revision: 2,
	date: new Date(2006,4,25),
	source: &quot;http://simonbaird.com/mptw/#TagglyListPlugin&quot;
};

config.macros.tagglyList = {};
config.macros.tagglyListByTag = {};
config.macros.tagglyListControl = {};
config.macros.tagglyListWithSort = {};
config.macros.hideSomeTags = {};

// change this to your preference
config.macros.tagglyListWithSort.maxCols = 6;

config.macros.tagglyList.label = &quot;Tagged as %0:&quot;;

// the default sort options. set these to your preference
config.macros.tagglyListWithSort.defaults = {
 sortBy:&quot;title&quot;, // title|created|modified
 sortOrder: &quot;asc&quot;, // asc|desc
 hideState: &quot;show&quot;, // show|hide
 groupState: &quot;nogroup&quot;, // nogroup|group
 numCols: 1
};

// these tags will be ignored by the grouped view
config.macros.tagglyListByTag.excludeTheseTags = [
 &quot;systemConfig&quot;,
 &quot;TiddlerTemplates&quot;
];

config.macros.tagglyListControl.tags = {
 title:&quot;sortByTitle&quot;, 
 modified: &quot;sortByModified&quot;, 
 created: &quot;sortByCreated&quot;,
 asc:&quot;sortAsc&quot;, 
 desc:&quot;sortDesc&quot;,
 hide:&quot;hideTagged&quot;, 
 show:&quot;showTagged&quot;,
 nogroup:&quot;noGroupByTag&quot;,
 group:&quot;groupByTag&quot;,
 cols1:&quot;list1Cols&quot;,
 cols2:&quot;list2Cols&quot;,
 cols3:&quot;list3Cols&quot;,
 cols4:&quot;list4Cols&quot;,
 cols5:&quot;list5Cols&quot;,
 cols6:&quot;list6Cols&quot;,
 cols7:&quot;list7Cols&quot;,
 cols8:&quot;list8Cols&quot;,
 cols9:&quot;list9Cols&quot; 
}

// note: should match config.macros.tagglyListControl.tags
config.macros.hideSomeTags.tagsToHide = [
 &quot;sortByTitle&quot;,
 &quot;sortByCreated&quot;,
 &quot;sortByModified&quot;,
 &quot;sortDesc&quot;,
 &quot;sortAsc&quot;,
 &quot;hideTagged&quot;,
 &quot;showTagged&quot;,
 &quot;noGroupByTag&quot;,
 &quot;groupByTag&quot;,
 &quot;list1Cols&quot;,
 &quot;list2Cols&quot;,
 &quot;list3Cols&quot;,
 &quot;list4Cols&quot;,
 &quot;list5Cols&quot;,
 &quot;list6Cols&quot;,
 &quot;list7Cols&quot;,
 &quot;list8Cols&quot;,
 &quot;list9Cols&quot;
];


//}}}
/***

!Utils
***/
//{{{
// from Eric
function isTagged(title,tag) {
 var t=store.getTiddler(title); if (!t) return false;
 return (t.tags.find(tag)!=null);
}

// from Eric
function toggleTag(title,tag) {
 var t=store.getTiddler(title); if (!t || !t.tags) return;
 if (t.tags.find(tag)==null) t.tags.push(tag);
 else t.tags.splice(t.tags.find(tag),1);
}

function addTag(title,tag) {
 var t=store.getTiddler(title); if (!t || !t.tags) return;
 t.tags.push(tag);
}

function removeTag(title,tag) {
 var t=store.getTiddler(title); if (!t || !t.tags) return;
 if (t.tags.find(tag)!=null) t.tags.splice(t.tags.find(tag),1);
}

// from Udo
Array.prototype.indexOf = function(item) {
 for (var i = 0; i &lt; this.length; i++) {
 if (this[i] == item) {
 return i;
 }
 }
 return -1;
};
Array.prototype.contains = function(item) {
 return (this.indexOf(item) &gt;= 0);
}
//}}}
/***

!tagglyList
displays a list of tagged tiddlers. 
parameters are sortField and sortOrder
***/
//{{{

// not used at the moment...
function sortedListOfOtherTags(tiddler,thisTag) {
 var list = tiddler.tags.concat(); // so we are working on a clone..
 for (var i=0;i&lt;config.macros.hideSomeTags.tagsToHide.length;i++) {
 if (list.find(config.macros.hideSomeTags.tagsToHide[i]) != null)
 list.splice(list.find(config.macros.hideSomeTags.tagsToHide[i]),1); // remove hidden ones
 }
 for (var i=0;i&lt;config.macros.tagglyListByTag.excludeTheseTags.length;i++) {
 if (list.find(config.macros.tagglyListByTag.excludeTheseTags[i]) != null)
 list.splice(list.find(config.macros.tagglyListByTag.excludeTheseTags[i]),1); // remove excluded ones
 }
 list.splice(list.find(thisTag),1); // remove thisTag
 return '[[' + list.sort().join(&quot;]] [[&quot;) + ']]';
}

function sortHelper(a,b) {
 if (a == b) return 0;
 else if (a &lt; b) return -1;
 else return +1;
}

config.macros.tagglyListByTag.handler = function (place,macroName,params,wikifier,paramString,tiddler) {

 var sortBy = params[0] ? params[0] : &quot;title&quot;; 
 var sortOrder = params[1] ? params[1] : &quot;asc&quot;;

 var result = store.getTaggedTiddlers(tiddler.title,sortBy);

 if (sortOrder == &quot;desc&quot;)
 result = result.reverse();

 var leftOvers = []
 for (var i=0;i&lt;result.length;i++) {
 leftOvers.push(result[i].title);
 }

 var allTagsHolder = {};
 for (var i=0;i&lt;result.length;i++) {
 for (var j=0;j&lt;result[i].tags.length;j++) {

 if ( 
 result[i].tags[j] != tiddler.title // not this tiddler
 &amp;&amp; config.macros.hideSomeTags.tagsToHide.find(result[i].tags[j]) == null // not a hidden one
 &amp;&amp; config.macros.tagglyListByTag.excludeTheseTags.find(result[i].tags[j]) == null // not excluded
 ) {
 if (!allTagsHolder[result[i].tags[j]])
 allTagsHolder[result[i].tags[j]] = &quot;&quot;;
 allTagsHolder[result[i].tags[j]] += &quot;**[[&quot;+result[i].title+&quot;]]\n&quot;;

 if (leftOvers.find(result[i].title) != null)
 leftOvers.splice(leftOvers.find(result[i].title),1); // remove from leftovers. at the end it will contain the leftovers...
 }
 }
 }


 var allTags = [];
 for (var t in allTagsHolder)
 allTags.push(t);

 allTags.sort(function(a,b) {
 var tidA = store.getTiddler(a);
 var tidB = store.getTiddler(b);
 if (sortBy == &quot;title&quot;) return sortHelper(a,b);
 else if (!tidA &amp;&amp; !tidB) return 0;
 else if (!tidA) return -1;
 else if (!tidB) return +1;
 else return sortHelper(tidA[sortBy],tidB[sortBy]);
 });

 var markup = &quot;&quot;;

 if (sortOrder == &quot;desc&quot;) {
 allTags.reverse();
 }
 else {
 // leftovers first...
 for (var i=0;i&lt;leftOvers.length;i++)
 markup += &quot;*[[&quot;+leftOvers[i]+&quot;]]\n&quot;;
 } 

 for (var i=0;i&lt;allTags.length;i++)
 markup += &quot;*[[&quot;+allTags[i]+&quot;]]\n&quot; + allTagsHolder[allTags[i]];

 if (sortOrder == &quot;desc&quot;) {
 // leftovers last...
 for (var i=0;i&lt;leftOvers.length;i++)
 markup += &quot;*[[&quot;+leftOvers[i]+&quot;]]\n&quot;;
 }

 wikify(markup,place);
}

config.macros.tagglyList.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
 var sortBy = params[0] ? params[0] : &quot;title&quot;; 
 var sortOrder = params[1] ? params[1] : &quot;asc&quot;;
 var numCols = params[2] ? params[2] : 1;

 var result = store.getTaggedTiddlers(tiddler.title,sortBy);
 if (sortOrder == &quot;desc&quot;)
 result = result.reverse();

 var listSize = result.length;
 var colSize = listSize/numCols;
 var remainder = listSize % numCols;

 var upperColsize;
 var lowerColsize;
 if (colSize != Math.floor(colSize)) {
 // it's not an exact fit so..
 lowerColsize = Math.floor(colSize);
 upperColsize = Math.floor(colSize) + 1;
 }
 else {
 lowerColsize = colSize;
 upperColsize = colSize;
 }

 var markup = &quot;&quot;;
 var c=0;

 var newTaggedTable = createTiddlyElement(place,&quot;table&quot;);
 var newTaggedBody = createTiddlyElement(newTaggedTable,&quot;tbody&quot;);
 var newTaggedTr = createTiddlyElement(newTaggedBody,&quot;tr&quot;);

 for (var j=0;j&lt;numCols;j++) {
 var foo = &quot;&quot;;
 var thisSize;

 if (j&lt;remainder)
 thisSize = upperColsize;
 else
 thisSize = lowerColsize;

 for (var i=0;i&lt;thisSize;i++) 
 foo += ( &quot;*[[&quot; + result[c++].title + &quot;]]\n&quot;); // was using splitList.shift() but didn't work in IE;

 var newTd = createTiddlyElement(newTaggedTr,&quot;td&quot;,null,&quot;tagglyTagging&quot;);
 wikify(foo,newTd);

 }

};

/* snip for later.....
 //var groupBy = params[3] ? params[3] : &quot;t.title.substr(0,1)&quot;;
 //var groupBy = params[3] ? params[3] : &quot;sortedListOfOtherTags(t,tiddler.title)&quot;;
 //var groupBy = params[3] ? params[3] : &quot;t.modified&quot;;
 var groupBy = null; // for now. groupBy here is working but disabled for now.

 var prevGroup = &quot;&quot;;
 var thisGroup = &quot;&quot;;

 if (groupBy) {
 result.sort(function(a,b) {
 var t = a; var aSortVal = eval(groupBy); var aSortVal2 = eval(&quot;t&quot;.sortBy);
 var t = b; var bSortVal = eval(groupBy); var bSortVal2 = eval(&quot;t&quot;.sortBy);
 var t = b; var bSortVal2 = eval(groupBy);
 return (aSortVal == bSortVal ?
 (aSortVal2 == bSortVal2 ? 0 : (aSortVal2 &lt; bSortVal2 ? -1 : +1)) // yuck
 : (aSortVal &lt; bSortVal ? -1 : +1));
 });
 }

 if (groupBy) {
 thisGroup = eval(groupBy);
 if (thisGroup != prevGroup)
 markup += &quot;*[[&quot;+thisGroup+']]\n';
 markup += &quot;**[[&quot;+t.title+']]\n';
 prevGroup = thisGroup;
 }



*/


//}}}

/***

!tagglyListControl
Use to make the sort control buttons
***/
//{{{

function getSortBy(title) {
 var tiddler = store.getTiddler(title);
 var defaultVal = config.macros.tagglyListWithSort.defaults.sortBy;
 if (!tiddler) return defaultVal;
 var usetags = config.macros.tagglyListControl.tags;
 if (tiddler.tags.contains(usetags[&quot;title&quot;])) return &quot;title&quot;;
 else if (tiddler.tags.contains(usetags[&quot;modified&quot;])) return &quot;modified&quot;;
 else if (tiddler.tags.contains(usetags[&quot;created&quot;])) return &quot;created&quot;;
 else return defaultVal;
}

function getSortOrder(title) {
 var tiddler = store.getTiddler(title);
 var defaultVal = config.macros.tagglyListWithSort.defaults.sortOrder;
 if (!tiddler) return defaultVal;
 var usetags = config.macros.tagglyListControl.tags;
 if (tiddler.tags.contains(usetags[&quot;asc&quot;])) return &quot;asc&quot;;
 else if (tiddler.tags.contains(usetags[&quot;desc&quot;])) return &quot;desc&quot;;
 else return defaultVal;
}

function getHideState(title) {
 var tiddler = store.getTiddler(title);
 var defaultVal = config.macros.tagglyListWithSort.defaults.hideState;
 if (!tiddler) return defaultVal;
 var usetags = config.macros.tagglyListControl.tags;
 if (tiddler.tags.contains(usetags[&quot;hide&quot;])) return &quot;hide&quot;;
 else if (tiddler.tags.contains(usetags[&quot;show&quot;])) return &quot;show&quot;;
 else return defaultVal;
}

function getGroupState(title) {
 var tiddler = store.getTiddler(title);
 var defaultVal = config.macros.tagglyListWithSort.defaults.groupState;
 if (!tiddler) return defaultVal;
 var usetags = config.macros.tagglyListControl.tags;
 if (tiddler.tags.contains(usetags[&quot;group&quot;])) return &quot;group&quot;;
 else if (tiddler.tags.contains(usetags[&quot;nogroup&quot;])) return &quot;nogroup&quot;;
 else return defaultVal;
}

function getNumCols(title) {
 var tiddler = store.getTiddler(title);
 var defaultVal = config.macros.tagglyListWithSort.defaults.numCols; // an int
 if (!tiddler) return defaultVal;
 var usetags = config.macros.tagglyListControl.tags;
 for (var i=1;i&lt;=config.macros.tagglyListWithSort.maxCols;i++)
 if (tiddler.tags.contains(usetags[&quot;cols&quot;+i])) return i;
 return defaultVal;
}


function getSortLabel(title,which) {
 // TODO. the strings here should be definable in config
 var by = getSortBy(title);
 var order = getSortOrder(title);
 var hide = getHideState(title);
 var group = getGroupState(title);
 if (which == &quot;hide&quot;) return (hide == &quot;show&quot; ? &quot;&quot; : &quot;+&quot;); // 0x25b8;
 else if (which == &quot;group&quot;) return (group == &quot;group&quot; ? &quot;normal&quot; : &quot;grouped&quot;);
 else if (which == &quot;cols&quot;) return &quot;cols&quot;; // &amp;plusmn;
 else if (by == which) return which + (order == &quot;asc&quot; ? &quot;&quot; : &quot;&quot;); // &amp;uarr; &amp;darr;
 else return which;
}

function handleSortClick(title,which) {
 var currentSortBy = getSortBy(title);
 var currentSortOrder = getSortOrder(title);
 var currentHideState = getHideState(title);
 var currentGroupState = getGroupState(title);
 var currentNumCols = getNumCols(title);

 var tags = config.macros.tagglyListControl.tags;

 // if it doesn't exist, lets create it..
 if (!store.getTiddler(title))
 store.saveTiddler(title,title,&quot;&quot;,config.options.txtUserName,new Date(),null);

 if (which == &quot;hide&quot;) {
 // toggle hide state
 var newHideState = (currentHideState == &quot;hide&quot; ? &quot;show&quot; : &quot;hide&quot;);
 removeTag(title,tags[currentHideState]);
 if (newHideState != config.macros.tagglyListWithSort.defaults.hideState)
 toggleTag(title,tags[newHideState]);
 }
 else if (which == &quot;group&quot;) {
 // toggle hide state
 var newGroupState = (currentGroupState == &quot;group&quot; ? &quot;nogroup&quot; : &quot;group&quot;);
 removeTag(title,tags[currentGroupState]);
 if (newGroupState != config.macros.tagglyListWithSort.defaults.groupState)
 toggleTag(title,tags[newGroupState]);
 }
 else if (which == &quot;cols&quot;) {
 // toggle num cols
 var newNumCols = currentNumCols + 1; // confusing. currentNumCols is an int
 if (newNumCols &gt; config.macros.tagglyListWithSort.maxCols || newNumCols &gt; store.getTaggedTiddlers(title).length)
 newNumCols = 1;
 removeTag(title,tags[&quot;cols&quot;+currentNumCols]);
 if ((&quot;cols&quot;+newNumCols) != config.macros.tagglyListWithSort.defaults.groupState)
 toggleTag(title,tags[&quot;cols&quot;+newNumCols]);
 }
 else if (currentSortBy == which) {
 // toggle sort order
 var newSortOrder = (currentSortOrder == &quot;asc&quot; ? &quot;desc&quot; : &quot;asc&quot;);
 removeTag(title,tags[currentSortOrder]);
 if (newSortOrder != config.macros.tagglyListWithSort.defaults.sortOrder)
 toggleTag(title,tags[newSortOrder]);
 }
 else {
 // change sortBy only
 removeTag(title,tags[&quot;title&quot;]);
 removeTag(title,tags[&quot;created&quot;]);
 removeTag(title,tags[&quot;modified&quot;]);

 if (which != config.macros.tagglyListWithSort.defaults.sortBy)
 toggleTag(title,tags[which]);
 }

 store.setDirty(true); // save is required now.
 story.refreshTiddler(title,false,true); // force=true
}

config.macros.tagglyListControl.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
 var onclick = function(e) {
 if (!e) var e = window.event;
 handleSortClick(tiddler.title,params[0]);
 e.cancelBubble = true;
 if (e.stopPropagation) e.stopPropagation();
 return false;
 };
 createTiddlyButton(place,getSortLabel(tiddler.title,params[0]),&quot;Click to change sort options&quot;,onclick,params[0]==&quot;hide&quot;?&quot;hidebutton&quot;:&quot;button&quot;);
}
//}}}
/***

!tagglyListWithSort
put it all together..
***/
//{{{
config.macros.tagglyListWithSort.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
 if (tiddler &amp;&amp; store.getTaggedTiddlers(tiddler.title).length &gt; 0)
  // todo make this readable
 wikify(
 &quot;&lt;&lt;tagglyListControl hide&gt;&gt;&quot;+
 (getHideState(tiddler.title) != &quot;hide&quot; ? 
 '&lt;html&gt;&lt;span class=&quot;tagglyLabel&quot;&gt;'+config.macros.tagglyList.label.format([tiddler.title])+' &lt;/span&gt;&lt;/html&gt;'+
 &quot;&lt;&lt;tagglyListControl title&gt;&gt;&lt;&lt;tagglyListControl modified&gt;&gt;&lt;&lt;tagglyListControl created&gt;&gt;&lt;&lt;tagglyListControl group&gt;&gt;&quot;+(getGroupState(tiddler.title)==&quot;group&quot;?&quot;&quot;:&quot;&lt;&lt;tagglyListControl cols&gt;&gt;&quot;)+&quot;\n&quot; + 
 &quot;&lt;&lt;tagglyList&quot; + (getGroupState(tiddler.title)==&quot;group&quot;?&quot;ByTag &quot;:&quot; &quot;) + getSortBy(tiddler.title)+&quot; &quot;+getSortOrder(tiddler.title)+&quot; &quot;+getNumCols(tiddler.title)+&quot;&gt;&gt;&quot; // hacky
 // + \n----\n&quot; +
 //&quot;&lt;&lt;tagglyList &quot;+getSortBy(tiddler.title)+&quot; &quot;+getSortOrder(tiddler.title)+&quot;&gt;&gt;&quot;
 : &quot;&quot;),
 place,null,tiddler);
}

config.macros.tagglyTagging = { handler: config.macros.tagglyListWithSort.handler };


//}}}
/***

!hideSomeTags
So we don't see the sort tags.
(note, they are still there when you edit. Will that be too annoying?
***/
//{{{

// based on tags.handler
config.macros.hideSomeTags.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
 var theList = createTiddlyElement(place,&quot;ul&quot;);
 if(params[0] &amp;&amp; store.tiddlerExists[params[0]])
 tiddler = store.getTiddler(params[0]);
 var lingo = config.views.wikified.tag;
 var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
 createTiddlyElement(theList,&quot;li&quot;,null,&quot;listTitle&quot;,prompt.format([tiddler.title]));
 for(var t=0; t&lt;tiddler.tags.length; t++)
 if (!this.tagsToHide.contains(tiddler.tags[t])) // this is the only difference from tags.handler...
 createTagButton(createTiddlyElement(theList,&quot;li&quot;),tiddler.tags[t],tiddler.title);

}

//}}}
/***

!Refresh everything when we save a tiddler. So the tagged lists never get stale. Is this too slow???
***/
//{{{

function refreshAllVisible() {
 story.forEachTiddler(function(title,element) {
   if (element.getAttribute(&quot;dirty&quot;) != &quot;true&quot;) 
     story.refreshTiddler(title,false,true);
 });
}

story.saveTiddler_orig_mptw = story.saveTiddler;
story.saveTiddler = function(title,minorUpdate) {
 var result = this.saveTiddler_orig_mptw(title,minorUpdate);
 refreshAllVisible();
 return result;
}

store.removeTiddler_orig_mptw = store.removeTiddler;
store.removeTiddler = function(title) {
 this.removeTiddler_orig_mptw(title);
 refreshAllVisible();
}

config.shadowTiddlers.TagglyTaggingStyles = &quot;/***\nTo use, add {{{[[TagglyTaggingStyles]]}}} to your StyleSheet tiddler, or you can just paste the CSS in directly. See also ViewTemplate, EditTemplate and TagglyTagging.\n***/\n/*{{{*/\n.tagglyTagged li.listTitle { display:none;}\n.tagglyTagged li { display: inline; font-size:90%; }\n.tagglyTagged ul { margin:0px; padding:0px; }\n.tagglyTagging { padding-top:0.5em; }\n.tagglyTagging li.listTitle { display:none;}\n.tagglyTagging ul { margin-top:0px; padding-top:0.5em; padding-left:2em; margin-bottom:0px; padding-bottom:0px; }\n\n/* .tagglyTagging .tghide { display:inline; } */\n\n.tagglyTagging { vertical-align: top; margin:0px; padding:0px; }\n.tagglyTagging table { margin:0px; padding:0px; }\n\n\n.tagglyTagging .button { display:none; margin-left:3px; margin-right:3px; }\n.tagglyTagging .button, .tagglyTagging .hidebutton { color:#aaa; font-size:90%; border:0px; padding-left:0.3em;padding-right:0.3em;}\n.tagglyTagging .button:hover, .hidebutton:hover { background:#eee; color:#888; }\n.selected .tagglyTagging .button { display:inline; }\n\n.tagglyTagging .hidebutton { color:white; } /* has to be there so it takes up space. tweak if you're not using a white tiddler bg */\n.selected .tagglyTagging .hidebutton { color:#aaa }\n\n.tagglyLabel { color:#aaa; font-size:90%; }\n\n.tagglyTagging ul {padding-top:0px; padding-bottom:0.5em; margin-left:1em; }\n.tagglyTagging ul ul {list-style-type:disc; margin-left:-1em;}\n.tagglyTagging ul ul li {margin-left:0.5em; }\n\n.editLabel { font-size:90%; padding-top:0.5em; }\n/*}}}*/\n&quot;;

refreshStyles(&quot;TagglyTaggingStyles&quot;);


//}}}

// // &lt;html&gt;&amp;#x25b8;&amp;#x25be;&amp;minus;&amp;plusmn;&lt;/html&gt;</pre>
</div>
<div title="TagglyTagging" modifier="SimonBaird" created="200601101210" modified="200604250715" tags="Plugins groupByTag hideTagged" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604250715">
<pre>TagglyTagging is currently broken up into several components. To install TagglyTagging you should
#Install the plugins TagglyListPlugin, QuickOpenTagPlugin, RenameTagsPlugin and NewHereCommand
# Copy the contents of TagglyTaggingViewTemplate and TagglyTaggingEditTemplate to your ViewTemplate and EditTemplate tiddlers respectively
Or you could just [[Download]] a fresh empty file with TagglyTagging pre-installed and start with that.
!What is TagglyTagging?
For more info about TagglyTagging try the TagglyTaggingFAQ and the TagglyTaggingTutorial.</pre>
</div>
<div title="TagglyTaggingEditTemplate" modifier="SimonBaird" created="200601131226" modified="200601190941" tags="EditTemplates TagglyTagging" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601190941">
<pre>&lt;!---
| Name:|~TagglyTaggingEditTemplate |
| Version:|1.1 (12-Jan-2006)|
| Source:|http://simonbaird.com/mptw/#TagglyTaggingEditTemplate|
| Purpose:|See TagglyTagging for more info|
| Requires:|You need the CSS in TagglyTaggingStyles to make it look right|
---&gt;
&lt;!--{{{--&gt;
&lt;div class=&quot;toolbar&quot; macro=&quot;toolbar +saveTiddler closeOthers -cancelTiddler deleteTiddler&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;title&quot; macro=&quot;view title&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editLabel&quot;&gt;Title&lt;/div&gt;&lt;div class=&quot;editor&quot; macro=&quot;edit title&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editLabel&quot;&gt;Tags&lt;/div&gt;&lt;div class=&quot;editor&quot; macro=&quot;edit tags&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editorFooter&quot;&gt;&lt;span macro=&quot;message views.editor.tagPrompt&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;tagChooser&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;editor&quot; macro=&quot;edit text&quot;&gt;&lt;/div&gt;
&lt;br/&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="TagglyTaggingFAQ" modifier="SimonBaird" created="200603060133" modified="200603060414" tags="TagglyTagging" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060414">
<pre></pre>
</div>
<div title="TagglyTaggingHistory" modifier="SimonBaird" created="200603060250" modified="200603060300" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060300">
<pre>!Chapter 1
Early versions of TiddlyWiki didn't have tagging. A couple of smart TiddlyHackers realised that being able to tag your data in TiddlyWiki would be really good and (as is often the case with TiddlyWiki) they were inspired to have a go at adding it themselves. The result was two TiddlyWiki adaptations that implemented tagging, one called TagglyWiki created by Jody Foo, and one called TiddlyTagWiki by Johnny ~LeRoy. 

TiddlyTagWiki used a 'tags as separate things' philosophy, space separated tags and popup menus when you click on a tag. TagglyWiki (and there was also a GTDTagglyWiki) had a 'tiddler is a tag is a tiddler' philosophy, had comma separated tags and introduced the concept of tiddlers displaying a list of their tagged tiddlers.

When Jeremy added tagging to the official TiddlyWiki version he considered both approaches and decided on the TiddlyTagWiki implementation. Jody Foo stopped maintaining TagglyWiki at around that time so TagglyWiki fans like me were forced to stick with their aging [[TagglyWiki]]s, missing out on numerous upgrades and cool new features as each revision of TiddlyWiki came out, until eventually they couldn't take it any more and started wondering what they could do to get hold of an up-to-date TiddlyWiki with TagglyWiki style tagging. (Okay, maybe that last part was just me!)

So when TiddlyWiki began to support enhancements via systemConfig plugins I decided to try to write a version of TagglyWiki style tagging as a plugin. It turned out to be easier than I thought. I managed to get it working and created MonkeyPirateTiddlyWiki to share it (and my other plugins). Since then there have been a few enhancements like dynamic updating of tagged lists and the new sort controls.

TiddlyTagWiki has continued to be maintained by Johnny and now contains some interesting new plugins.

!Chapter 2
Seeing the wisdom of the TagglyTagging way ;), Jeremy incorporated the &quot;tiddler is a tag is a tiddler&quot; concept into TiddlyWiki version 2.0 and introduced the &quot;tagging&quot; list, the other central component of TagglyTagging. Most of the reason for TagglyTagging's existence had vanished! Rather than dissappear entirely TagglyTagging became the set of tools it is now, an enhanced tagging list with sort controls, layout changes and a few other simple tools (NewHereCommand, QuickOpenTagPlugin and RenameTagsPlugin) that facilitate using the full power of tags in the TagglyTagging way.
</pre>
</div>
<div title="TagglyTaggingTutorial" modifier="YourName" created="200603060249" modified="200608310911" tags="TagglyTagging" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608310911">
<pre>You can do this right here and now. Maybe you should print this out so it's easy to follow while working on screen. I presume you have some familiarity with TiddlyWiki basics. If you are having trouble following this then try this [[excellent tutorial|http://www.blogjones.com/TiddlyWikiTutorial.html]] first.

!Getting started: Create some content
* First hit &quot;close others&quot; to clear up your screen
* Click &quot;new tiddler&quot; from the main menu.
* Name the tiddler &quot;~MyStuff&quot; by typing into the title box.
* Add some contents to the contents box, for example &quot;This is my stuff&quot;
* Click the Done button to save the new tiddler. (We will return to this one later).
* Let's say you just returned from a meeting and want to enter a couple of notes about it
** Click &quot;new tiddler&quot;
** Enter tiddler title as &quot;Meeting with Leo - 12 Oct&quot;
** Add some meeting notes in the content box
** Don't click Done just yet...

!Tagging your content
* Before you save the &quot;Meeting with Leo...&quot; tiddler let's add some tags
** It's a meeting so let's give it a tag called &quot;Meetings&quot;. Type Meetings in the tags box.
** The meeting was with Leo so let's give it a tag called Leo. Type Leo in the tags box.
** Let's say the meeting was about budget planning for example. Type Budget in the tags box.
** So your tags box should look like this: {{{Meetings Leo Budget}}}
*Now save the tiddler by clicking the Done button.

!Using the tags
*No big deal so far, right? Now we start to get into TagglyTagging territory.
*Notice the tags appear above the title. They are italicised to indicate they don't exist yet (just like any other tiddler that doesn't exist yet).
*Click on the Leo tag. You will open an empty tiddler called Leo.
**Give it some content like &quot;Leo Runcible, ext 1234. Likes cats&quot;. Or whatever.
**Leo's a person so give him a tag of &quot;People&quot; by typing People in the tags box.
**Save it by clicking Done.

!Lets pick up the pace
*Go back to your &quot;Meeting with Leo...&quot; tiddler.
** Click on Meetings. Give Meetings a tag of ~MyStuff and save it.
** Click on People. Give People a tag of ~MyStuff and save it.
** Click on Budget. Give Budget a tag of Projects. Type something about the Budget project in the tiddler contents if you want. Save it.
** Now above the Budget title click on the Projects tag. Give Projects a tag of ~MyStuff. Save that.
* Now find your ~MyStuff tiddler. Look at the tagged tiddler list which appears at the bottom of the tiddler. It should be a list containing Meetings, People and Projects.
* Close a few tiddlers and try navigating to your meeting tiddler from ~MyStuff using the tagged tiddler lists.

That's a quick look at the basics of TagglyTagging. Hopefully by now you have some idea about what TagglyTagging can do. Play around with it a little more if you like. Then continue to...

!The New Here Button
* Click on People.
* Do you know any other people?
* If so click, &quot;new here&quot; in the People tiddler
** Notice that the tags box already contains the tag People. (This is what the new here button does. It creates a new tiddler with the tag already filled in).
** Type someone's name and some notes on that person. Click Done to Save.
* Add a couple more people for fun
** Notice what happens to the &quot;tagged tiddler&quot; list at the bottom of the People tiddler.

!Changing the structure of your data
Let's look at how easy it is to change your structure. Suppose you decide that you want to have different types of Projects: Ongoing, Current and Future
* Go to your Budget tiddler. Edit it and change the Projects tag to Ongoing Projects. Save.
* Click the Ongoing Projects tag. Give that a tag of &quot;Projects&quot;.
* That's it. You're done. Well actually you haven't added the Ongoing and Future Projects but you can see that's not hard. Maybe click &quot;new here&quot; at the Projects tiddler. Or maybe just tag a project as Future Projects and do it from the bottom up.

!Another example
* Suppose your original meeting had an action item for you. Type it into the meeting notes as a wiki word or {{{[[}}}Do Something{{{]]}}}.
* Now click on it and give it a tag of Todo. Type any extra information about how you're going to do it when it's due by etc into the contents. Put a reminder in there if you have ReminderPlugin installed.
* Now make sure you can get to your Todos by tagging Todo tiddler as MyStuff.
* For convenience let's put a link to MyStuff in your MainMenu. This will put all your new organised information at your fingertips at all times.

!Sort Controls and Columns
* If you mouse over a tagged tiddler list you should see some buttons. Try them out. Note that if you save it remembers your choice.

!Wrapup
Hopefully you can see that TagglyTagging gives you a powerful way to organise and structure your information. Don't forget that you can still use conventional wiki links to navigate around your tiddlers. TagglyTagging just gives you another way to do cool stuff with your TiddlyWiki.


~~This tutorial is a draft. Feedback is welcome. Please [[contact|Contact]] me with comments and suggestions.~~
</pre>
</div>
<div title="TagglyTaggingViewTemplate" modifier="SimonBaird" created="200601131226" modified="200603060218" tags="ViewTemplates TagglyTagging" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603060218">
<pre>&lt;!---
| Name:|~TagglyTaggingViewTemplate |
| Version:|1.2 (16-Jan-2006)|
| Source:|http://simonbaird.com/mptw/#TagglyTaggingViewTemplate|
| Purpose:|See TagglyTagging for more info|
| Requires:|You need the CSS in TagglyTaggingStyles to make it look right|
!History
* 16-Jan-06, version 1.2, added tagglyListWithSort
* 12-Jan-06, version 1.1, first version
!Notes
Remove the miniTag if you don't like it or you don't use QuickOpenTagPlugin
---&gt;
&lt;!--{{{--&gt;
&lt;div class=&quot;toolbar&quot; macro=&quot;toolbar -closeTiddler closeOthers +editTiddler permalink references jump newHere&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;tagglyTagged&quot; macro=&quot;hideSomeTags&quot;&gt;&lt;/div&gt;
&lt;div&gt;&lt;span class=&quot;title&quot; macro=&quot;view title&quot;&gt;&lt;/span&gt;&lt;span class=&quot;miniTag&quot; macro=&quot;miniTag&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;Updated &lt;span macro='view modified date [[DD-MMM-YY]]'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;viewer&quot; macro=&quot;view text wikified&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;tagglyTagging&quot; macro=&quot;tagglyTagging&quot;&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="TakeOffline" modifier="Simon" created="200607120533" modified="200607120533" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607120533">
<pre>http://tiddlyspot.com/download/mptw</pre>
</div>
<div title="Tasks" modifier="SimonBaird" created="200602161153" modified="200602161153" tags="groupByTag" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161153">
<pre></pre>
</div>
<div title="TestStuff" modifier="SimonBaird" created="200606150100" modified="200606150109" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200606150109">
<pre>{{noTableBorder{
&lt;&lt;codehighlight xml &lt;?xml version=&quot;1.0&quot;?&gt;
&lt;this that=&quot;123&quot;&gt;
&lt;thing&gt;asdf&lt;/thing&gt;
&lt;/this&gt;
&gt;&gt;
}}}</pre>
</div>
<div title="Testing" modifier="SimonBaird" created="200601091059" modified="200601091102" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601091102">
<pre>&lt;&lt;forEachTiddler
 where 'tiddler.tags.contains(&quot;Plugins&quot;) &amp;&amp; tiddler.tags.contains(&quot;MPTW&quot;)'&gt;&gt;</pre>
</div>
<div title="TiddlerExcerptToolTip" modifier="SimonBaird" created="200605080002" modified="200605080002" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605080002">
<pre>See TiddlerExcerptTooltip</pre>
</div>
<div title="TiddlerExcerptTooltip" modifier="SimonBaird" created="200605071006" modified="200605072359" tags="Plugins Borrowed systemConfig WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605072359">
<pre>/***
| Name:|TiddlerExcerptTooltip|
| Source:|http://simonbaird.com/mptw/#TiddlerExcerptTooltip|
| Author:|Simon Baird, adapted from original version posted to mailing list by Udo Borkowski|
| Version:|1.0.0|
| Description:|Make tooltip of tiddler links the first line or excerpt of the tiddler content|
***/
//{{{

// adjust the following to your preference
config.TiddlerExcerptTooltip = {
	trimLength: 60,
	dateFormat:&quot;DD-MM-YY&quot;
}

// %0 is title
// %1 is modifier
// %2 is modified date
// %3 is first line
// %4 is first so many characters
// %5 is short modified date
// %6 is short created date

// firefox seems to trim the tooltip if it gets too long...
config.messages.tiddlerLinkTooltip = &quot;%1/%5: %4&quot;;

config.messages.tiddlerEmpty = &quot;(empty)&quot;;

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;

	var m = this.text.match(/\s*(.*)/);
	var firstLine = (m != null &amp;&amp; m.length &gt;= 1) ? m[1] : &quot;&quot;;

	var contentExcerpt = this.text.prettyTrim(config.TiddlerExcerptTooltip.trimLength);
	if (contentExcerpt == &quot;&quot;)
		contentExcerpt = config.messages.tiddlerEmpty;

	var shortModified = this.modified.formatString(config.TiddlerExcerptTooltip.dateFormat);
	var shortCreated = this.created.formatString(config.TiddlerExcerptTooltip.dateFormat);


	return config.messages.tiddlerLinkTooltip.format(
		[this.title,theModifier,theModified,firstLine,contentExcerpt,shortModified,shortCreated]);  
}

// this lifted from TagUtils
String.prototype.prettyTrim = function(len,prefix,postfix) {
	var result = this.trim().replace(/\r\n/g,' ').replace(/[\n|\t]/g,' ');
	if (result.length &gt; len - 3)
		return result.trim().substr(0,len) + '...';
	else
		return result;
}

//}}}
</pre>
</div>
<div title="TiddlerInFilePlugin-ByTagFork" creator="YourName" modifier="YourName" created="202507091948" tags="systemConfig" changecount="1">
<pre>/***
|Description |Allows to store any number of tiddlers as external files and more|
|Source      |https://github.com/YakovL/TiddlyWiki_TiddlerInFilePlugin/blob/master/TiddlerInFilePlugin.js|
|Author      |Yakov Litvin, Modified by Yanshu Wang|
|Version     |1.1.4|
|License     |[[MIT|https://github.com/YakovL/TiddlyWiki_YL_ExtensionsCollection/blob/master/Common%20License%20(MIT)]]|
!!!Requirements
Since the plugin loads and saves files, it needs that the browser and/or saver supports these operations. Here are some options:
* Loading files:
** Works when TW is opened (and external files are attempted to be loaded) via http (or https) protocol (but not, by default, via file:// url);
** Firefox allows loading local files when the {{{security.fileuri.strict_origin_policy}}} setting is set to {{{false}}} (type {{{about:config}}} in address bar to open the configuration UI). If Firefox is your primary browser, i.e. you use it not just for TW and some trusted sites, it is recommended to [[create|https://groups.google.com/g/tiddlywikiclassic/c/T1q0q9uF2aI/m/f2SVb8CYAAAJ]] a separate profile for using ~TWs and change the setting there to ensure better security.
** Some savers may provide full file loading functionality. Those yet to be tested: [[TiddlyDesktop|https://github.com/Jermolene/TiddlyDesktop]], [[tiddly-node-saver|https://github.com/fallwest/tiddly-node-saver]], [[nwTWcSaver|https://github.com/nwOkido/nwTWcSaver]], ..;
* Saving files:
** suitable savers include: [[Timimi|https://github.com/ibnishak/Timimi]]; the savers yet to be tested: [[TiddlyDesktop|https://github.com/Jermolene/TiddlyDesktop]], ..;

!!!Usage
Once the plugin is installed (copy, tag with {{{systemConfig}}}, reload) storing tiddlers in files is done via 2 steps:
# list (describe) those in [[ExternalTiddlersList]] by writing {{{&lt;&lt;external&gt;&gt;}}} macros there
# if the file exists and the tiddler doesn't, reload TW (external tiddler will be loaded on startup);&lt;br&gt;if the tiddler exists and the file doesn't, just save your TW
Note: external tiddler is always the main &quot;source of truth&quot;: if {{{keepInternal:true}}} is used, it is saved in TW as well, but loading external content will overwrite what is saved in TW.

Here's how the macro is used:
{{{
&lt;&lt;external [[MyTestTiddler]]&gt;&gt;
}}}
will store the tiddler's text in {{{MyTestTiddler.txt}}} in the same folder as TW. There's a number of other options:
{{{
&lt;&lt;external [[tiddler name]]
  [file:&lt;relative path with or without filename and extension&gt;]
  [format:{externalized | text}]
  [keepInternal:true]
  [plugin:true]
&gt;&gt;
}}}
Examples of the {{{file}}} param usage:
* {{{&lt;&lt;external [[MyTestTiddler]] file:&quot;other name&quot;&gt;&gt;}}} makes file name different from tiddler name
* {{{&lt;&lt;external [[MyPlugin]] file:&quot;MyPlugin.js&quot; plugin:true&gt;&gt;}}} sets a custom file extension (see also the {{{plugin}}} option below)
* {{{&lt;&lt;external [[MyLog]] file:&quot;../logs/&quot;&gt;&gt;}}} will store the file in another folder (note that omitted filename after {{{/}}} means &quot;use tiddler name as filename and default extension&quot;)
* the plugin doesn't take care of forbidden characters yet ({{{*}}}, {{{?}}}, {{{&quot;}}} etc), so be careful about those

Supported formats are
* {{{text}}} (default)  only tiddler text is stored in the file with {{{.txt}}} extension; and
* {{{externalized}}}  whole tiddler is stored in the same format as in TW store, file has {{{.tid.html}}} extension and is displayed is monospace tiddler text when opened in browser
Formats can be added by extending {{{config.macros.external.fileFormats}}}.

The {{{keepInternal}}} option makes TW save the tiddler in both external file and TW itself. This, for instance, affects tiddlers stored in {{{text}}} format: without it, all fields like creator, modified etc are destroyed on reload (since are not saved), but with it they are preserved.

The {{{plugin}}} option makes TW evaluate the tiddler like it does with plugins. Note that it doesn't handle plugin dependencies yet. @@color:red;Warning@@: TIFP doesn't currently take care of installing only once, so use {{{plugin}}} with {{{keepInternal}}} ''only'' if you understand the outcome (for instance, some plugins may create infinite loops; also remember that internal version will be always installed first).
***/
//{{{
config.macros.external = {
	fileFormats: {
		text: {
			extension: 'txt',
			externalize: function(tiddler) { return tiddler.text },
			// changes tiddler as a side-effect not to remove existing fields
			internalize: function(tiddler, source) {
				tiddler.text = source
			}
		},
		externalized: {
			extension: 'tid.html',
			externalize: function(tiddler) {
				return store.getSaver().externalizeTiddler(store, tiddler)
			},
			// like for 'text', extends tiddler, doesn't create from scratch
			internalize: function(tiddler, source) {
				const div = createTiddlyElement(document.body, 'div')
				div.setAttribute('style','display:none;')
				div.innerHTML = source
				store.getLoader().internalizeTiddler(store, tiddler,
					tiddler.title, div.firstChild)
				div.remove()
			}
		},
                js: {
			extension: 'js',
			externalize: function(tiddler) { return tiddler.text },
			// changes tiddler as a side-effect not to remove existing fields
			internalize: function(tiddler, source) {
				tiddler.text = source
			}
		}/*,
		tid: { extension: 'tid' },
		json: { extension: 'tid.json' }
		externalizedWithFormatter? sane to implement?
		*/
	},
	// here and below &quot;meta&quot; means &quot;info about registered external tiddler,
	// be it loaded or not&quot;
	getExtension: function(meta) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		return format.extension
	},
	externalizeTiddler: function(meta) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		return format.externalize(meta.tiddler)
	},
	internalizeTiddler: function(meta, source) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		
		const tiddler = store.fetchTiddler(meta.tiddlerName) ||
			new Tiddler(meta.tiddlerName)
		format.internalize(tiddler, source) //# pass meta to tiddler?
		// a patch for Windows: don't get linebreaks duplicated
		tiddler.text = tiddler.text.replace(/\r\n/g, '\n')
		tiddler.doNotSave = function() { return !meta.keepInTW }
		meta.tiddler = tiddler
		
		return tiddler
	},

	listName: &quot;ExternalTiddlersList&quot;,
	// read files list, load
	init: function() {
		const listTiddler = store.fetchTiddler(this.listName)
		if(!listTiddler || !listTiddler.text) return
		wikify(listTiddler.text, createTiddlyElement(null, 'div'))

		for(let meta of this.tiddlersMeta) this.loadExternal(meta)
	},
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		// parse params, register
		const defaultParam = 'tiddler'
		const pParams = paramString.parseParams(defaultParam, null, true)
		const meta = {}
		meta.tiddlerName = getParam(pParams, defaultParam)
		if(!meta.tiddlerName) return

		// although called .fileName, it actually can contain relative part of a path
		// fallback to meta.tiddlerName is set when calculating the full path
		meta.fileName = getParam(pParams, 'file', '')
		//# check if contains &quot;bad&quot; characters (like &quot; or * ..for local paths only)
		meta.fileFormat = getParam(pParams, 'format', 'text')
		meta.isPlugin = getFlag(pParams, 'plugin') //# allow just &quot;plugin&quot; instead of &quot;plugin:true&quot;?
		const keepInternal = getParam(pParams, 'keepInternal')
		meta.keepInTW = !!keepInternal &amp;&amp; keepInternal !== 'false' //# ~
		this.registerExternal(meta)

		// visual feedback
		const macroText = wikifier.source.substring(wikifier.matchStart, wikifier.nextMatch)
		createTiddlyText(place, 'external ')
		createTiddlyLink(place, meta.tiddlerName, true)
		createTiddlyText(place, ' (')
		createTiddlyElement(place, 'code', '', '', macroText.slice(2 + macroName.length + 1, -2))
		createTiddlyText(place, ')')
	},
	// describes tiddlers registered as external, not necessarily loaded
	tiddlersMeta: [],
	registerExternal: function(meta) {
		//# check if already registered, don't register twice
		this.tiddlersMeta.push(meta)
	},
	getMetaFor: function(tiddlerOrTitle) {
		const isTitle = typeof tiddlerOrTitle == &quot;string&quot;
		for(meta of this.tiddlersMeta)
			if(isTitle &amp;&amp; meta.tiddlerName == tiddlerOrTitle ||
			  !isTitle &amp;&amp; meta.tiddler == tiddlerOrTitle)
				return meta
	},
	loadExternal: function(meta) {
		// sync loading fails on startup because TF injects new mozillaLoadFile too late
//		const tiddlerText = loadFile(getLocalPath(getFullPath(meta.fileName)));
//		onExternalTiddlerLoad(tiddlerText !== null, meta, tiddlerText);
		// so we use async instead:

		const callback = this.onExternalTiddlerLoad
		const path = getFullPath(meta.fileName, meta.tiddlerName, this.getExtension(meta))
		// httpReq(&quot;GET&quot;, path, callback, meta) uses default dataType,
		// which causes js to get evaluated on load. To avoid this, we customize the ajax call:
		jQuery.ajax({
			type: &quot;GET&quot;,
			url: path,
			dataType: &quot;text&quot;,
			processData: false,
			cache: false,
			complete: function(xhr, textStatus) {
				if((!xhr.status &amp;&amp; location.protocol === &quot;file:&quot;) || (xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status === 304)
					callback(true, meta, xhr.responseText, path, xhr)
				else
					callback(false, meta, null, path, xhr)
			}
		})
		//# rename onExternalTiddlerLoad into internalizeAndRegister?
	},
	onExternalTiddlerLoad: function(success, meta, responseText) {
		if(!success) return //# notify somehow? may fail because file is not created yet or ...
		const tiddler = config.macros.external.internalizeTiddler(meta, responseText)
		store.addTiddler(tiddler)
		//# what if tiddler already exists?
		if(meta.isPlugin) {
			// make it look normally
			tiddler.tags.pushUnique('systemConfig')
			const author = store.getTiddlerText(tiddler.title + &quot;::Author&quot;)
			if(author) {
				tiddler.creator = tiddler.creator || author
				tiddler.modifier = tiddler.modifier || tiddler.creator
			}

			eval(tiddler.text)
			// for plugins introducing macros, formatters etc (may be adjusted in the future)
			refreshAll()
		}
		//meta.lastLoaded = responseText
	},
	saveExternal: function(meta, callback) {
		const fullPath = getFullPath(meta.fileName, meta.tiddlerName, this.getExtension(meta))
		// we don't try to save remote files (yet)
		if(!isLocalAbsolutePath(fullPath)) {
			//# if(callback) callback(.., '[saving remote is not supported]')
			return
		}
		const localPath = getLocalPath(fullPath)

		const contentToSave = this.externalizeTiddler(meta)
		// save only if have something to save
		//if(contentToSave != meta.lastLoaded) {
			saveFile(localPath, contentToSave)
			//# get result of saving, return it
			//# or move externalizing into a separate helper?
		//	meta.lastLoaded = contentToSave
			//# this assumes saving didn't fail, which may be wrong
		//}

		//# if(callback) callback(.., '[...]')
	},
	saveAll: function() {
		let overallSuccess = true
		for(let meta of this.tiddlersMeta) {
			// a tiddler may got created after registration
			if(!meta.tiddler) {
				let tiddlerInStore = store.fetchTiddler(meta.tiddlerName)
				if(tiddlerInStore) {
					meta.tiddler = tiddlerInStore
				} else
					// tiddler doesn't exist and we do nothing
					continue
					//# based on config, we can show a warning instead
			}
			//# if(meta.tiddler.title != meta.tiddlerName)
			//  means tiddler got renamed  change meta.tiddlerName &amp;
			//  update this.listName . If store contains another tiddler
			//  with that name, still keep the registered one?
			overallSuccess = this.saveExternal(meta) &amp;&amp; overallSuccess
			//# if saving failed, do something! (.oO dirty, notifying)
		}
		return overallSuccess
	}
}

config.macros.exportByTag = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        const pParams = paramString.parseParams(&quot;tag&quot;, null, true)
        const tag = getParam(pParams, &quot;tag&quot;)
        if (!tag) {
            createTiddlyElement(place, &quot;span&quot;, null, &quot;error&quot;, &quot;&lt;&lt;exportByTag&gt;&gt; macro requires a 'tag' parameter.&quot;)
            return
        }

        const fileFormat = getParam(pParams, 'format', 'text')
        const filePathPrefix = getParam(pParams, 'file', '')

        const tiddlersToExport = store.getTaggedTiddlers(tag);
        
        createTiddlyElement(place, &quot;span&quot;, null, null, &quot;Exporting tiddlers with tag '&quot;)
        createTiddlyElement(place, &quot;b&quot;, null, null, tag)
        createTiddlyElement(place, &quot;span&quot;, null, null, &quot;':&quot;)
        const ul = createTiddlyElement(place, &quot;ul&quot;)

        let exportCount = 0;
        for (let i = 0; i &lt; tiddlersToExport.length; i++) {
            const currentTiddler = tiddlersToExport[i];
            const meta = {
                tiddlerName: currentTiddler.title,
                tiddler: currentTiddler,
                fileFormat: fileFormat,
                fileName: filePathPrefix, // Will be combined with tiddler name and extension
                keepInTW: true // Always keep in TW for this export function
            };

            const li = createTiddlyElement(ul, &quot;li&quot;)
            createTiddlyLink(li, currentTiddler.title, true)
            
            try {
                config.macros.external.saveExternal(meta);
                createTiddlyText(li, &quot; - Exported successfully.&quot;)
                exportCount++;
            } catch (e) {
                createTiddlyText(li, &quot; - Export failed: &quot; + e.message)
                displayMessage(&quot;Error exporting tiddler &quot; + currentTiddler.title + &quot;: &quot; + e.message);
            }
        }
        createTiddlyElement(place, &quot;p&quot;, null, null, &quot;Total exported: &quot; + exportCount + &quot; of &quot; + tiddlersToExport.length);
    }
};

//# see implementations in STP (share to the core?)
function isAbsolutePath(path) {
	// covers http:, https:, file:, other schemas, windows paths (D:\...)
	if(/^\w+\:/.exec(path)) return true
	// unix absolute paths, starting with /
	if(/^\//.exec(path)) return true
	return false
}
function isLocalAbsolutePath(path) {
	//# rename? we're going to check whether an absolute path is local, not path is absolute local
	return /^\w\:/.exec(path) || /^\//.exec(path) || /^file\:/.exec(path)
}
function getFullPath(subPath, nameFallback, extension) {
	const fileNamePosition = subPath.lastIndexOf('/') + 1
	const fileName = subPath.substr(fileNamePosition)
	if(fileName &amp;&amp; fileName.indexOf('.') == -1)
		subPath += '.' + extension
	if(!fileName)
		subPath += nameFallback + '.' + extension

	if(isAbsolutePath(subPath)) return subPath

	const url = window.location.toString()
	const base = url.substr(0, url.lastIndexOf('/') + 1)
	return base + subPath
}

//# ideally, don't save main store if it were not changed
if(!config.macros.external.orig_saveChanges) {
	config.macros.external.orig_saveChanges = saveChanges
	saveChanges = function(onlyIfDirty, tiddlers) {
		config.macros.external.saveAll()
		//# should we do smth about setDirty (if saving of a tiddler failed)?

		return config.macros.external.orig_saveChanges.apply(this, arguments)
	}
}

// hijack method of store (since not present in TiddlyWiki.prototype)
if(!config.macros.external.orig_deleteTiddler) {
	config.macros.external.orig_deleteTiddler = store.deleteTiddler
	store.deleteTiddler = function(title) {
		const registeredMeta = config.macros.external.getMetaFor(title)
		if(registeredMeta) registeredMeta.tiddler = null

		return config.macros.external.orig_deleteTiddler.apply(this, arguments)
	}
}
//}}}</pre>
</div>
<div title="TiddlerListMacro" modifier="YourName" created="200605100624" modified="200608041702" tags="Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608041702">
<pre>/***
|''Name:''|TiddlerListMacro|
|''Version:''|2.0.10 (01-May-2006)|
|''Source''|http://jackparke.googlepages.com/jtw.html#TiddlerListMacro ([[del.icio.us|http://del.icio.us/post?url=http://jackparke.googlepages.com/jtw.html%23TiddlerListMacro]])|
|''Author:''|[[Jack]]|
|''Type:''|Macro|
|''Documentation:''|TiddlerListMacroDocumentation|
!Usage
{{{&lt;&lt;tiddlerList parameter1:&quot;value1&quot; parameter2:&quot;value2&quot; ...&gt;&gt;}}}
See TiddlerListMacroDocumentation and TiddlerListMacroExamples
!Code
***/
//{{{




version.extensions.tiddlerList = {major: 2, minor: 0, revision: 10, date: new Date(&quot;May 2, 2006&quot;)};
// template = [header, item, seperator, group, footer]
config.macros.tiddlerList={
 formats : {list:true, nlist:true, span:true, stack:true, csv:true, table:true},
 templates : {
              list  : [   &quot;%0\n&quot;, &quot;* %0\n&quot;,   &quot;&quot;,    &quot;%group\n&quot;,   &quot;%0\n&quot;],
              nlist : [     &quot;%0&quot;, &quot;# %0\n&quot;,   &quot;&quot;,    &quot;%group\n&quot;,   &quot;%0\n&quot;],
              span  : [     &quot;%0&quot;,     &quot;%0&quot;,  &quot; &quot;,      &quot;%group&quot;,     &quot;%0&quot;],
              stack : [     &quot;%0&quot;,     &quot;%0&quot;, &quot;\n&quot;,      &quot;%group&quot;,     &quot;%0&quot;],
              csv   : [     &quot;%0&quot;,     &quot;%0&quot;, &quot;, &quot;,          &quot;%0&quot;,   &quot;%0\n&quot;],
              table : [&quot;|!%0|\n&quot;,  &quot;|%0|\n&quot;,  &quot;&quot;,  &quot;|%group|\n&quot;, &quot;|%0|\n&quot;]
             },
 dateFormat : &quot;DD MMM YYYY&quot;
}

// XXX this is a error in safari:
if (!gCurrentTiddler)
 var gCurrentTiddler;

config.macros.tiddlerList.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
 // Some globals
 var count=0, groupCount=0, theGroup=&quot;&quot;, lastGroup=&quot;&quot;;
 var currentTiddler = tiddler;
 gCurrentTiddler = tiddler;
 var listWikiText=&quot;&quot;;
 var formats = this.formats;
 
 // SQL-Like parameters
 var parameters = paramString.parseParams(&quot;name&quot;,null,true);
 var pTags = parameters[0][&quot;tags&quot;]?parameters[0][&quot;tags&quot;][0].split(&quot;,&quot;):[];
 var pTags2 = parameters[0][&quot;tags2&quot;]?parameters[0][&quot;tags2&quot;][0].readBracketedList():[];    // mptw
 var pOrder = parameters[0][&quot;order&quot;]?parameters[0][&quot;order&quot;][0]:&quot;title&quot;;
 var pTop = parameters[0][&quot;top&quot;]?parameters[0][&quot;top&quot;][0]:-1;
 var pText = parameters[0][&quot;text&quot;]?parameters[0][&quot;text&quot;][0]:&quot;&quot;;
 var pTitle = parameters[0][&quot;title&quot;]?parameters[0][&quot;title&quot;][0]:&quot;&quot;;
 var pSearch = parameters[0][&quot;search&quot;]?parameters[0][&quot;search&quot;][0]:&quot;&quot;;
 var pFilter = parameters[0][&quot;filter&quot;]?parameters[0][&quot;filter&quot;][0]:&quot;&quot;;
 var pHeader = parameters[0][&quot;header&quot;]?paramFormat(parameters[0][&quot;header&quot;][0]):&quot;&quot;;
 var pFooter = parameters[0][&quot;footer&quot;]?paramFormat(parameters[0][&quot;footer&quot;][0]):&quot;&quot;;
 var pGroup = parameters[0][&quot;group&quot;]?parameters[0][&quot;group&quot;][0]:&quot;&quot;;
 var pDateFormat = parameters[0][&quot;dateFormat&quot;]?parameters[0][&quot;dateFormat&quot;][0]:this.dateFormat;
 var pCustomParameter = parameters[0][&quot;customParameter&quot;]?parameters[0][&quot;customParameter&quot;][0]:&quot;&quot;;
 var pFormat = parameters[0][&quot;format&quot;]?parameters[0][&quot;format&quot;][0]:&quot;list&quot;;
 var pTagsMode = parameters[0][&quot;tagsmode&quot;]?parameters[0][&quot;tagsmode&quot;]:&quot;all&quot;;         // mptw
 var pTagsLogic = parameters[0][&quot;tagslogic&quot;]?parameters[0][&quot;tagslogic&quot;][0]:&quot;&quot;;           // mptw
 pFormat = formats[pFormat]?pFormat:&quot;list&quot;
 
 // Seperator
 var pSeperator = parameters[0][&quot;seperator&quot;]?paramFormat(parameters[0][&quot;seperator&quot;][0]):this.templates[pFormat][2]

 // Template for group
 var pGroupTemplate = this.templates[pFormat][3];
 if (parameters[0][&quot;groupTemplate&quot;])
  pGroupTemplate = paramFormat(parameters[0][&quot;groupTemplate&quot;][0])
 pGroupTemplate = pGroupTemplate.replace(&quot;$))&quot;, &quot;&gt;&gt;&quot;)
 
 // Template for group footer
 var pGroupFooterTemplate = &quot;&quot;;
 if (parameters[0][&quot;groupFooterTemplate&quot;])
  pGroupFooterTemplate = paramFormat(parameters[0][&quot;groupFooterTemplate&quot;][0])
 pGroupFooterTemplate = pGroupFooterTemplate.replace(&quot;$))&quot;, &quot;&gt;&gt;&quot;)
 
 // Template for item
 var pItemTemplate = this.templates[pFormat][1];
 if (parameters[0][&quot;itemTemplate&quot;])
  pItemTemplate = paramFormat(parameters[0][&quot;itemTemplate&quot;][0])
 pItemTemplate = pItemTemplate.replace(&quot;$))&quot;, &quot;&gt;&gt;&quot;).replace(&quot;%link&quot;, &quot;%0&quot;).replace(&quot;%item&quot;, &quot;%1&quot;).replace(&quot;%abstract&quot;, &quot;%2&quot;).replace(&quot;%text&quot;, &quot;%3&quot;).replace(&quot;%created&quot;, &quot;%4&quot;).replace(&quot;%modified&quot;, &quot;%5&quot;).replace(&quot;%modifier&quot;, &quot;%6&quot;).replace(&quot;%group&quot;, &quot;%7&quot;).replace(&quot;%title&quot;, &quot;%8&quot;).replace(&quot;%tags&quot;, &quot;%9&quot;).replace(&quot;%nolink&quot;, &quot;%10&quot;).replace(&quot;%custom&quot;, &quot;%11&quot;)
 // Template for footer
 var pFooterTemplate = this.templates[pFormat][4].replace(&quot;%count&quot;, &quot;%1&quot;)

 // Get all tiddlers
 var tiddlers = store.reverseLookup(&quot;tags&quot;,&quot;excludeLists&quot;,false);

 // Sorting
 if(!pOrder)
  pOrder = &quot;title&quot;;
 if (pOrder.match(/^\-/i)) {
  pOrder = pOrder.substr(1)
  var sortDesc = true;
 }
 if (sortDesc)
  tiddlers.sort(function (a,b) {if(a[pOrder] == b[pOrder]) return(0); else return (a[pOrder] &gt; b[pOrder]) ? -1 : +1; });
 else
  tiddlers.sort(function (a,b) {if(a[pOrder] == b[pOrder]) return(0); else return (a[pOrder] &lt; b[pOrder]) ? -1 : +1; });

 // Header
 if (pHeader)
  listWikiText += formatItem(this.templates[pFormat][0], [pHeader], pFormat)
  
 for(var t=0; t&lt;tiddlers.length; t++) {
  tiddler = tiddlers[t];
  if (pTop==-1 || count&lt;pTop) {
   if (pText==&quot;&quot; || tiddler.text.match(pText)) {
    if (pTitle==&quot;&quot; || tiddler.title.match(pTitle)) {
     if (pSearch==&quot;&quot; || (tiddler.title.match(pSearch) || tiddler.text.match(pSearch))) {
      if (pFilter==&quot;&quot; || eval(pFilter)) {
       if (pTags.length==0 || compareArrays(tiddler.tags, pTags, pTagsMode)) {     // mptw
        if (pTags2.length==0 || compareArrays(tiddler.tags, pTags2, pTagsMode)) {  // mptw
        if (pTagsLogic==&quot;&quot; || eval(pTagsLogic.interpretTagsLogic())) {                                  // mptw
        count++;
     	  // Grouping
     	  if (pGroup) {
      	theGroup = eval(pGroup);
      	if(theGroup != lastGroup) {
      	 groupCount++;
   	    if (pGroupFooterTemplate &amp;&amp; groupCount&gt;1)
      	  listWikiText += pGroupFooterTemplate.replace(&quot;%group&quot;, theGroup)
      	 listWikiText += pGroupTemplate.replace(&quot;%group&quot;, theGroup)
      	 lastGroup = theGroup;
     	   }
     	  }
        // Seperators
        if (count&gt;1) listWikiText += pSeperator;
        //Plaintext title
        var noLink = tiddler.title.match(config.textPrimitives.wikiLink)?&quot;~&quot; + tiddler.title:tiddler.title;
        // Custom parameter
        if (pCustomParameter)
         var custom=&quot;&quot;;
         try {
          custom = eval(pCustomParameter)
         } catch (e) {}
        // List individual tiddler
        listWikiText += formatItem(pItemTemplate,[&quot;[[&quot; + tiddler.title + &quot;]]&quot;,count,tiddler.text.substr(0,100),tiddler.text,tiddler.created.formatString(pDateFormat),tiddler.modified.formatString(pDateFormat),tiddler.modifier,theGroup,tiddler.title,tiddler.tags.join(&quot; &quot;),noLink,custom], pFormat)
         } // mptw
        } // mptw
       }
      }
     }
    }
   }
  }
 }
 
 // Last group footer
 if (pGroup &amp;&amp; pGroupFooterTemplate &amp;&amp; count&gt;0)
  listWikiText += pGroupFooterTemplate.replace(&quot;%group&quot;, theGroup)

 // Footer
 if (pFooter) {
  pFooter = pFooter.replace(&quot;%count&quot;, count)
  listWikiText += formatItem(pFooterTemplate, [pFooter], pFormat)
 }
 
 // Render result
 if (!parameters[0][&quot;debug&quot;])
  wikify(listWikiText,place, null, currentTiddler)
 else
  place.innerHTML = &quot;&lt;textarea style=\&quot;width:100%;\&quot; rows=30&gt;&quot; + listWikiText + &quot;&lt;/textarea&gt;&quot;
 
 
 // Local functions
 
 function paramFormat(param) {
 // Allow &quot;\n&quot; in non evalled parameters
   return param.replace(/\\n/g, &quot;\n&quot;);
 }
 
 function formatItem(template, values, format) {
 // Fill template with values (depending on list format)
   if (format.match(/table/) &amp;&amp; values[0].match(/\|/))
     return (&quot;%0\n&quot;).format(values)
   else
    return template.format(values)
 }
 
 function compareArrays(array, values, logic) {
 // Compare items in array with AND(&quot;all&quot;) or OR(&quot;any&quot;) logic
   var matches=0;
    for(var v=0; v&lt;values.length; v++)
     if(values[v].trim().match(/^\-/) &amp;&amp; !array.contains(values[v].trim().substr(1)))   // mptw
      matches++;
     else if (array.contains(values[v].trim()))  // mptw
      matches++;
   return ((logic==&quot;all&quot; &amp;&amp; matches==values.length) || (logic!=&quot;all&quot; &amp;&amp; matches&gt;0))
 }
 
}

String.prototype.prettyTrim = function(len,prefix,postfix) {
	var result = this.trim().replace(/\r\n/g,' ').replace(/\n/g,' ');
	if (!prefix) prefix = '';
	if (!postfix) postfix = '';
	if (result.length &gt; len - 3)
		return prefix + result.substr(0,len) + '...' + postfix;
	else if (result.length &gt; 0)
		return prefix + result + postfix;
	else
		return result;
}


String.prototype.interpretTagsLogic = function() {
	// example expression
	// &quot;( [[A Tag]] || Tag2 ) &amp;&amp; ! Tag3&quot;
	// must have spaces between everything
	var splitExpression = this.readBracketedList(false); // false means not unique. thanks Jeremy!!
	var asIs = ['(',')','||','&amp;&amp;','!']; // better not have any tags called those!
	var translatedExpression = &quot;&quot;;
	for (var i=0;i&lt;splitExpression.length;i++)
		if (asIs.contains(splitExpression[i]))
			translatedExpression += splitExpression[i];
		else
			translatedExpression += &quot;tiddler.hasTag('&quot;+splitExpression[i]+&quot;')&quot;;
	 //alert(translatedExpression);
	return translatedExpression;
}


//}}}</pre>
</div>
<div title="TiddlerTemplates" modifier="SimonBaird" created="200602161034" modified="200602161035" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161035">
<pre>These are used by NewFromTemplateMacro</pre>
</div>
<div title="TiddlyWiki" modifier="SimonBaird" created="200601101150" modified="200603101325" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603101325">
<pre>The original, revolutionary, super cool, 100% javascript, microcontent, self-contained wiki in a web page, created and maintained by JeremyRuston. For more information visit http://www.tiddlywiki.com/. MonkeyPirateTiddlyWiki is running TiddlyWiki &lt;&lt;version&gt;&gt;.

So what is TiddlyWiki? In short it's a wiki implemented in javascript and stored in a single html file. But you can think of it as an ''electronic notepad from the future''. Try these links for more information:
*[[TiddlyWiki Explanation (euicho.com)|http://euicho.com/index.php?p=123]]
*[[TiddlyWiki Tutorial (blogjones.com)|http://www.blogjones.com/TiddlyWikiTutorial.html]]
*[[Wikipedia Entry|http://en.wikipedia.org/wiki/Tiddlywiki]]

Or try my new TiddlyWikiFAQ.</pre>
</div>
<div title="TiddlyWikiFAQ" modifier="Simon" created="200603101325" modified="200607170025" tags="WhatsNew" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607170025">
<pre>Still under construction but it's grown a little:
http://tiddlyspot.com/twfaq/</pre>
</div>
<div title="Todo" modifier="SimonBaird" created="200603011026" modified="200603091446" tags="groupByTag sortDesc sortByModified More..." server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091446">
<pre></pre>
</div>
<div title="ToggleTagMacro" modifier="SimonBaird" created="200601091103" modified="200604201349" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604201349">
<pre>/***
Examples:

|Code|Description|Example|h
|{{{&lt;&lt;toggleTag&gt;&gt;}}}|Toggles the default tag (checked) in this tiddler|&lt;&lt;toggleTag&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName&gt;&gt;}}}|Toggles the TagName tag in this tiddler|&lt;&lt;toggleTag TagName&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName TiddlerName&gt;&gt;}}}|Toggles the TagName tag in the TiddlerName tiddler|&lt;&lt;toggleTag TagName TiddlerName&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName TiddlerName nolabel&gt;&gt;Click me}}}|Same but hide the label|&lt;&lt;toggleTag TagName TiddlerName nolabel&gt;&gt;Click me|
(Note if TiddlerName doesn't exist it will be silently created)

!Known issues
* Doesn't smoothly handle the case where you toggle a tag in a tiddler that is current open for editing. Should it stick the tag in the edit box?

!Code
***/
//{{{


// This function contributed by Eric Shulman
function toggleTag(title,tag) {
 var t=store.getTiddler(title); if (!t || !t.tags) return;
 if (t.tags.find(tag)==null) t.tags.push(tag)
 else t.tags.splice(t.tags.find(tag),1)
}

// This function contributed by Eric Shulman
function isTagged(title,tag) {
 var t=store.getTiddler(title); if (!t) return false;
 return (t.tags.find(tag)!=null);
}

config.macros.toggleTag = {};
config.views.wikified.toggleTag = {fulllabel: &quot;[[%0]] [[%1]]&quot;, shortlabel: &quot;[[%0]]&quot;, nolabel: &quot;&quot; };

config.macros.toggleTag.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
 if(tiddler instanceof Tiddler) {
 var tag = (params[0] &amp;&amp; params[0] != '.') ? params[0] : &quot;checked&quot;;
 var title = (params[1] &amp;&amp; params[1] != '.') ? params[1] : tiddler.title;
 var hidelabel = (params[2] &amp;&amp; params[2] != '.') ? true : false;
 var alsoRefreshStyles = (params[3] &amp;&amp; params[3] != '.') ? true : false;

 var onclick = function(e) {
 if (!e) var e = window.event;
 if (!store.getTiddler(title))
 store.saveTiddler(title,title,&quot;&quot;,config.options.txtUserName,new Date(),null);
 toggleTag(title,tag);

 store.setDirty(true); // so TW knows it has to save now

 story.forEachTiddler(function(title,element) {
   if (element.getAttribute(&quot;dirty&quot;) != &quot;true&quot;) 
     story.refreshTiddler(title,false,true);
 });

 if (alsoRefreshStyles)
   store.notifyAll();

 return false;
 };

 var lingo = config.views.wikified.toggleTag;

 // this part also contributed by Eric Shulman
 var c = document.createElement(&quot;input&quot;);
 c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);
 c.onclick=onclick;
 place.appendChild(c);
 c.checked=isTagged(title,tag);

 if (!hidelabel) {
 var label = (title!=tiddler.title)?lingo.fulllabel:lingo.shortlabel;
 wikify(label.format([tag,title]),place);
 }
 }
}

//}}}
</pre>
</div>
<div title="Update NewFromTemplate" modifier="SimonBaird" created="200603011106" modified="200603011106" tags="Todo" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603011106">
<pre></pre>
</div>
<div title="Upgrade to 2.0.6" modifier="SimonBaird" created="200603011035" modified="200603011035" tags="Todo Done" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603011035">
<pre></pre>
</div>
<div title="UploadLog" modifier="YourName" created="200607090054" modified="200609062338" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200609062338">
<pre>| !date | !user | !location | !storeUrl | !uploadDir | !toFilename | !backupdir | !origin |
| 9/7/2006 10:54:21 | YourName | [[index.html|file:///C:/User/Docs/Simon/remotesite/simonbaird.com/mptw/index.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | mptw | . | . |
| 9/7/2006 10:56:1 | YourName | [[index.html|file:///C:/User/Docs/Simon/remotesite/simonbaird.com/mptw/index.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | mptw | . | . |
| 9/7/2006 10:56:56 | YourName | [[index.html|file:///C:/User/Docs/Simon/remotesite/simonbaird.com/mptw/index.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | mptw | . | . |
| 9/7/2006 10:57:53 | YourName | [[index.html|file:///C:/User/Docs/Simon/remotesite/simonbaird.com/mptw/index.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | mptw | . | . |
| 9/7/2006 10:59:51 | YourName | [[index.html|file:///C:/User/Docs/Simon/remotesite/simonbaird.com/mptw/index.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 14:14:7 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 12/7/2006 14:18:45 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 14:24:44 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 14:25:30 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 15:0:10 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowExampleMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 15:29:10 | Simon | [[/|http://tiddlyspot.com/mptw/#HelloWorldMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 15:33:35 | Simon | [[/|http://tiddlyspot.com/mptw/#HelloWorldMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 16:54:2 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 16:56:16 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 16:56:59 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 16:59:4 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 17:0:42 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 17:1:42 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 12/7/2006 17:3:38 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 13/7/2006 8:17:41 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 15/7/2006 8:18:7 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 15/7/2006 8:21:23 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 15/7/2006 8:36:11 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 17/7/2006 10:25:28 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 17/7/2006 12:32:27 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 26/7/2006 16:49:57 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 26/7/2006 16:50:11 | Simon | [[/|http://tiddlyspot.com/mptw/#ShowClockMacro]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 1:28:30 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 1:29:32 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 1:30:31 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 1:39:3 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 1:40:45 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 10:36:37 | Daniel Baird | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 10:38:45 | Daniel Baird | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 3/8/2006 15:50:46 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 8:7:14 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 8:17:16 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2%20MonkeyPirateTiddlyWiki%20Download]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 8:29:4 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 8:37:51 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 8:40:53 | YourName | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:20:57 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:21:15 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:45:4 | YourName | [[mptw.html|file:///C:/Documents%20and%20Settings/ccscb/Desktop/mptw.html#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 9:47:17 | YourName | [[mptw.html|file:///C:/Documents%20and%20Settings/ccscb/Desktop/mptw.html#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:49:54 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 9:55:44 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:56:19 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 9:58:8 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:0:38 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:6:22 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:7:42 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 10:8:30 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:9:58 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:10:59 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 10:12:10 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 11:55:1 | YourName | [[mptw.html|file:///C:/Documents%20and%20Settings/ccscb/Desktop/mptw.html#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:20:11 | YourName | [[mptw.html|file:///C:/Documents%20and%20Settings/ccscb/Desktop/mptw.html#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 12:22:40 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:25:13 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:28:24 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:29:51 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 12:43:27 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:45:48 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 12:49:28 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 4/8/2006 12:51:16 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 4/8/2006 12:52:18 | Simon | [[/|http://tiddlyspot.com/mptw/#Clock2]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 5/8/2006 3:0:57 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . | Ok |
| 5/8/2006 3:2:20 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 7/8/2006 22:44:33 | YourName | [[mptw.html|file:///D:/Documents%20and%20Settings/User/Desktop/mptw.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 7/8/2006 22:46:29 | YourName | [[mptw.html|file:///D:/Documents%20and%20Settings/User/Desktop/mptw.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 7/8/2006 22:47:42 | YourName | [[mptw.html|file:///D:/Documents%20and%20Settings/User/Desktop/mptw.html]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 7/8/2006 22:52:19 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 8/8/2006 1:54:51 | YourName | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 8/8/2006 15:20:35 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 8/8/2006 15:27:53 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 8/8/2006 15:33:13 | Simon | [[/|http://tiddlyspot.com/mptw/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 28/8/2006 12:58:21 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 28/8/2006 12:59:3 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://tiddlyspot.com/mptw/store.cgi]] | . | index.html | . |
| 28/8/2006 13:0:11 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 31/8/2006 19:15:20 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 31/8/2006 19:16:24 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 31/8/2006 19:17:26 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 1/9/2006 14:31:21 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 5/9/2006 0:14:29 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 5/9/2006 0:20:41 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 5/9/2006 0:50:44 | YourName | [[/|http://mptw.tiddlyspot.com/#PositionAdsense]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 5/9/2006 0:52:38 | YourName | [[/|http://mptw.tiddlyspot.com/#PositionAdsense]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 7/9/2006 9:38:40 | YourName | [[/|http://mptw.tiddlyspot.com/]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 7/9/2006 9:38:53 | YourName | [[/|http://mptw.tiddlyspot.com/#TagUtils]] | [[store.cgi|http://mptw.tiddlyspot.com/store.cgi]] | . | index.html | . |</pre>
</div>
<div title="UploadPlugin" modifier="YourName" created="200607090052" modified="200607090052" tags="systemConfig Plugins Borrowed" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200607090052">
<pre>/***
&lt;&lt;tiddler UploadPluginDoc&gt;&gt;
!Code
***/
//{{{
version.extensions.UploadPlugin = {
	major: 3, minor: 3, revision: 3, 
	date: new Date(2006,6,30),
	type: 'macro',
	source: 'http://tiddlywiki.bidix.info/#UploadPlugin',
	docs: 'http://tiddlywiki.bidix.info/#UploadPluginDoc'
};
//}}}

////+++!![config.lib.file]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.file) config.lib.file= {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 0}, 
	date: new Date(2006,3,9)
};
config.lib.file.dirname = function (filePath) {
	var lastpos;
	if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {
		return filePath.substring(0, lastpos);
	} else {
		return filePath.substring(0, filePath.lastIndexOf(&quot;\\&quot;));
	}
};
config.lib.file.basename = function (filePath) {
	var lastpos;
	if ((lastpos = filePath.lastIndexOf(&quot;#&quot;)) != -1) 
		filePath = filePath.substring(0, lastpos);
	if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {
		return filePath.substring(lastpos + 1);
	} else
		return filePath.substring(filePath.lastIndexOf(&quot;\\&quot;)+1);
};
window.basename = function() {return &quot;@@deprecated@@&quot;;};
//}}}
////===

////+++!![config.lib.log]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.log) config.lib.log= {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 0}, 
	date: new Date(2006,3,9)
};
config.lib.Log = function(tiddlerTitle, logHeader) {
	if (version.major &lt; 2)
		this.tiddler = store.tiddlers[tiddlerTitle];
	else
		this.tiddler = store.getTiddler(tiddlerTitle);
	if (!this.tiddler) {
		this.tiddler = new Tiddler();
		this.tiddler.title = tiddlerTitle;
		this.tiddler.text = &quot;| !date | !user | !location |&quot; + logHeader;
		this.tiddler.created = new Date();
		this.tiddler.modifier = config.options.txtUserName;
		this.tiddler.modified = new Date();
	if (version.major &lt; 2)
		store.tiddlers[tiddlerTitle] = this.tiddler;
	else
		store.addTiddler(this.tiddler);
	}
	return this;
};

config.lib.Log.prototype.newLine = function (line) {
	var now = new Date();
	var newText = &quot;| &quot;;
	newText += now.getDate()+&quot;/&quot;+(now.getMonth()+1)+&quot;/&quot;+now.getFullYear() + &quot; &quot;;
	newText += now.getHours()+&quot;:&quot;+now.getMinutes()+&quot;:&quot;+now.getSeconds()+&quot; | &quot;;
	newText += config.options.txtUserName + &quot; | &quot;;
	var location = document.location.toString();
	var filename = config.lib.file.basename(location);
	if (!filename) filename = '/';
	newText += &quot;[[&quot;+filename+&quot;|&quot;+location + &quot;]] |&quot;;
	this.tiddler.text = this.tiddler.text + &quot;\n&quot; + newText;
	this.addToLine(line);
};

config.lib.Log.prototype.addToLine = function (text) {
	this.tiddler.text = this.tiddler.text + text;
	this.tiddler.modifier = config.options.txtUserName;
	this.tiddler.modified = new Date();
	if (version.major &lt; 2)
	store.tiddlers[this.tiddler.tittle] = this.tiddler;
	else {
		store.addTiddler(this.tiddler);
		story.refreshTiddler(this.tiddler.title);
		store.notify(this.tiddler.title, true);
	}
	if (version.major &lt; 2)
		store.notifyAll(); 
};
//}}}
////===

////+++!![config.lib.options]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.options) config.lib.options = {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 0}, 
	date: new Date(2006,3,9)
};

config.lib.options.init = function (name, defaultValue) {
	if (!config.options[name]) {
		config.options[name] = defaultValue;
		saveOptionCookie(name);
	}
};
//}}}
////===

////+++!![PasswordTweak]

//{{{
version.extensions.PasswordTweak = {
	major: 1, minor: 0, revision: 2, date: new Date(2006,3,11),
	type: 'tweak',
	source: 'http://tiddlywiki.bidix.info/#PasswordTweak'
};
//}}}
/***
!!config.macros.option
***/
//{{{
config.macros.option.passwordCheckboxLabel = &quot;Save this password on this computer&quot;;
config.macros.option.passwordType = &quot;password&quot;; // password | text

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute(&quot;option&quot;);
	var elementType,valueField;
	if(opt) {
		switch(opt.substr(0,3)) {
			case &quot;txt&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;value&quot;;
				break;
			case &quot;pas&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;value&quot;;
				break;
			case &quot;chk&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;checked&quot;;
				break;
		}
		config.options[opt] = this[valueField];
		saveOptionCookie(opt);
		var nodes = document.getElementsByTagName(elementType);
		for(var t=0; t&lt;nodes.length; t++) {
			var optNode = nodes[t].getAttribute(&quot;option&quot;);
			if (opt == optNode) 
				nodes[t][valueField] = this[valueField];
		}
	}
	return(true);
};

config.macros.option.handler = function(place,macroName,params)
{
    var opt = params[0];
	var size = 15;
	if (params[1])
		size = params[1];
    if(config.options[opt] === undefined) {
        return;}
    var c;
    switch(opt.substr(0,3)) {
		case &quot;txt&quot;:
			c = document.createElement(&quot;input&quot;);
			c.onkeyup = this.onChangeOption;
			c.setAttribute (&quot;option&quot;,opt);
			c.size = size;
			c.value = config.options[opt];
			place.appendChild(c);
			break;
		case &quot;pas&quot;:
			// input password
			c = document.createElement (&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,config.macros.option.passwordType);
			c.onkeyup = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,opt);
			c.size = size;
			c.value = config.options[opt];
			place.appendChild(c);
			// checkbox link with this password &quot;save this password on this computer&quot;
			c = document.createElement(&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);
			c.onclick = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,&quot;chk&quot;+opt);
			place.appendChild(c);
			c.checked = config.options[&quot;chk&quot;+opt];
			// text savePasswordCheckboxLabel
			place.appendChild(document.createTextNode(config.macros.option.passwordCheckboxLabel));
			break;
		case &quot;chk&quot;:
			c = document.createElement(&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);
			c.onclick = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,opt);
			place.appendChild(c);
			c.checked = config.options[opt];
			break;
	}
};
//}}}
/***
!! Option cookie stuff
***/
//{{{
window.loadOptionsCookie_orig_PasswordTweak = window.loadOptionsCookie;
window.loadOptionsCookie = function()
{
	var cookies = document.cookie.split(&quot;;&quot;);
	for(var c=0; c&lt;cookies.length; c++) {
		var p = cookies[c].indexOf(&quot;=&quot;);
		if(p != -1) {
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			switch(name.substr(0,3)) {
				case &quot;txt&quot;:
					config.options[name] = unescape(value);
					break;
				case &quot;pas&quot;:
					config.options[name] = unescape(value);
					break;
				case &quot;chk&quot;:
					config.options[name] = value == &quot;true&quot;;
					break;
			}
		}
	}
};

window.saveOptionCookie_orig_PasswordTweak = window.saveOptionCookie;
window.saveOptionCookie = function(name)
{
	var c = name + &quot;=&quot;;
	switch(name.substr(0,3)) {
		case &quot;txt&quot;:
			c += escape(config.options[name].toString());
			break;
		case &quot;chk&quot;:
			c += config.options[name] ? &quot;true&quot; : &quot;false&quot;;
			// is there an option link with this chk ?
			if (config.options[name.substr(3)]) {
				saveOptionCookie(name.substr(3));
			}
			break;
		case &quot;pas&quot;:
			if (config.options[&quot;chk&quot;+name]) {
				c += escape(config.options[name].toString());
			} else {
				c += &quot;&quot;;
			}
			break;
	}
	c += &quot;; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/&quot;;
	document.cookie = c;
};
//}}}
/***
!! Initializations
***/
//{{{
// define config.options.pasPassword
if (!config.options.pasPassword) {
	config.options.pasPassword = 'defaultPassword';
	window.saveOptionCookie('pasPassword');
}
// since loadCookies is first called befor password definition
// we need to reload cookies
window.loadOptionsCookie();
//}}}
////===

////+++!![config.macros.upload]

//{{{
config.macros.upload = {
	accessKey: &quot;U&quot;,
	formName: &quot;UploadPlugin&quot;,
	contentType: &quot;text/html;charset=UTF-8&quot;,
	defaultStoreScript: &quot;store.php&quot;
};

// only this two configs need to be translated
config.macros.upload.messages = {
	aboutToUpload: &quot;About to upload TiddlyWiki to %0&quot;,
	errorDownloading: &quot;Error downloading&quot;,
	errorUploadingContent: &quot;Error uploading content&quot;,
	fileNotFound: &quot;file to upload not found&quot;,
	fileNotUploaded: &quot;File %0 NOT uploaded&quot;,
	mainFileUploaded: &quot;Main TiddlyWiki file uploaded to %0&quot;,
	urlParamMissing: &quot;url param missing&quot;,
	rssFileNotUploaded: &quot;RssFile %0 NOT uploaded&quot;,
	rssFileUploaded: &quot;Rss File uploaded to %0&quot;
};

config.macros.upload.label = {
	promptOption: &quot;Save and Upload this TiddlyWiki with UploadOptions&quot;,
	promptParamMacro: &quot;Save and Upload this TiddlyWiki in %0&quot;,
	saveLabel: &quot;save to web&quot;, 
	saveToDisk: &quot;save to disk&quot;,
	uploadLabel: &quot;upload&quot;	
};

config.macros.upload.handler = function(place,macroName,params){
	// parameters initialization
	var storeUrl = params[0];
	var toFilename = params[1];
	var backupDir = params[2];
	var uploadDir = params[3];
	var username = params[4];
	var password; // for security reason no password as macro parameter
	var label;
	if (document.location.toString().substr(0,4) == &quot;http&quot;)
		label = this.label.saveLabel;
	else
		label = this.label.uploadLabel;
	var prompt;
	if (storeUrl) {
		prompt = this.label.promptParamMacro.toString().format([this.dirname(storeUrl)]);
	}
	else {
		prompt = this.label.promptOption;
	}
	createTiddlyButton(place, label, prompt, 
						function () {
							config.macros.upload.upload(storeUrl, toFilename, uploadDir, backupDir, username, password); 
							return false;}, 
						null, null, this.accessKey);
};
config.macros.upload.UploadLog = function() {
	return new config.lib.Log('UploadLog', &quot; !storeUrl | !uploadDir | !toFilename | !backupdir | !origin |&quot; );
};
config.macros.upload.UploadLog.prototype = config.lib.Log.prototype;
config.macros.upload.UploadLog.prototype.startUpload = function(storeUrl, toFilename, uploadDir,  backupDir) {
	var line = &quot; [[&quot; + config.lib.file.basename(storeUrl) + &quot;|&quot; + storeUrl + &quot;]] | &quot;;
	line += uploadDir + &quot; | &quot; + toFilename + &quot; | &quot; + backupDir + &quot; |&quot;;
	this.newLine(line);
};
config.macros.upload.UploadLog.prototype.endUpload = function() {
	this.addToLine(&quot; Ok |&quot;);
};
config.macros.upload.basename = config.lib.file.basename;
config.macros.upload.dirname = config.lib.file.dirname;
config.macros.upload.upload = function(storeUrl, toFilename, uploadDir, backupDir, username, password)
{
	// parameters initialization
	storeUrl = (storeUrl ? storeUrl : config.options.txtUploadStoreUrl);
	toFilename = (toFilename ? toFilename : config.options.txtUploadFilename);
	backupDir = (backupDir ? backupDir : config.options.txtUploadBackupDir);
	uploadDir = (uploadDir ? uploadDir : config.options.txtUploadDir);
	username = (username ? username : config.options.txtUploadUserName);
	password = config.options.pasUploadPassword; // for security reason no password as macro parameter
	if (storeUrl === '') {
		config.macros.upload.defaultStoreScript;
	}
	if (config.lib.file.dirname(storeUrl) === '') {
		storeUrl = config.lib.file.dirname(document.location.toString())+'/'+storeUrl;
	}
	if (toFilename === '') {
		toFilename = config.lib.file.basename(document.location.toString());
	}

	clearMessage();
	// only for forcing the message to display
	 if (version.major &lt; 2)
		store.notifyAll();
	if (!storeUrl) {
		alert(config.macros.upload.messages.urlParamMissing);
		return;
	}
	
	var log = new this.UploadLog();
	log.startUpload(storeUrl, toFilename, uploadDir,  backupDir);
	if (document.location.toString().substr(0,5) == &quot;file:&quot;) {
		saveChanges();
	}
	displayMessage(config.macros.upload.messages.aboutToUpload.format([this.dirname(storeUrl)]), this.dirname(storeUrl));
	this.uploadChanges(storeUrl, toFilename, uploadDir, backupDir, username, password);
	if(config.options.chkGenerateAnRssFeed) {
		//var rssContent = convertUnicodeToUTF8(generateRss());
		var rssContent = generateRss();
		var rssPath = toFilename.substr(0,toFilename.lastIndexOf(&quot;.&quot;)) + &quot;.xml&quot;;
		this.uploadContent(rssContent, storeUrl, rssPath, uploadDir, '', username, password, 
			function (responseText) {
				if (responseText.substring(0,1) != '0') {
					displayMessage(config.macros.upload.messages.rssFileNotUploaded.format([rssPath]));
				}
				else {
					if (uploadDir) {
						rssPath = uploadDir + &quot;/&quot; + config.macros.upload.basename(rssPath);
					} else {
						rssPath = config.macros.upload.basename(rssPath);
					}
					displayMessage(config.macros.upload.messages.rssFileUploaded.format(
						[config.macros.upload.dirname(storeUrl)+&quot;/&quot;+rssPath]), config.macros.upload.dirname(storeUrl)+&quot;/&quot;+rssPath);
				}
				// for debugging store.php uncomment last line
				//DEBUG alert(responseText);
			});
	}
	return;
};

config.macros.upload.uploadChanges = function(storeUrl, toFilename, uploadDir, backupDir, 
		username, password) {
	var original;
	if (document.location.toString().substr(0,4) == &quot;http&quot;) {
		original =  this.download(storeUrl, toFilename, uploadDir, backupDir, username, password);
		return;
	}
	else {
		// standard way : Local file
		
		original = loadFile(getLocalPath(document.location.toString()));
		if(window.Components) {
			// it's a mozilla browser
			try {
				netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
				var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]
									.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
				converter.charset = &quot;UTF-8&quot;;
				original = converter.ConvertToUnicode(original);
			}
			catch(e) {
			}
		}
	}
	//DEBUG alert(original);
	this.uploadChangesFrom(original, storeUrl, toFilename, uploadDir, backupDir, 
		username, password);
};

config.macros.upload.uploadChangesFrom = function(original, storeUrl, toFilename, uploadDir, backupDir, 
		username, password) {
	var startSaveArea = '&lt;div id=&quot;' + 'storeArea&quot;&gt;'; // Split up into two so that indexOf() of this source doesn't find it
	var endSaveArea = '&lt;/d' + 'iv&gt;';
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var posClosingDiv = original.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([document.location.toString()]));
		return;
		}
	var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + 
				allTiddlersAsHtml() + &quot;\n\t\t&quot; +
				original.substr(posClosingDiv);
	var newSiteTitle;
	if(version.major &lt; 2){
		newSiteTitle = (getElementText(&quot;siteTitle&quot;) + &quot; - &quot; + getElementText(&quot;siteSubtitle&quot;)).htmlEncode();
	} else {
		newSiteTitle = (wikifyPlain (&quot;SiteTitle&quot;) + &quot; - &quot; + wikifyPlain (&quot;SiteSubtitle&quot;)).htmlEncode();
	}
	revised = revised.replace(new RegExp(&quot;&lt;title&gt;[^&lt;]*&lt;/title&gt;&quot;, &quot;im&quot;),&quot;&lt;title&gt;&quot;+ newSiteTitle +&quot;&lt;/title&gt;&quot;);
	var response = this.uploadContent(revised, storeUrl, toFilename, uploadDir, backupDir, 
		username, password, function (responseText) {
					if (responseText.substring(0,1) != '0') {
						alert(responseText);
						displayMessage(config.macros.upload.messages.fileNotUploaded.format([getLocalPath(document.location.toString())]));
					}
					else {
						if (uploadDir !== '') {
							toFilename = uploadDir + &quot;/&quot; + config.macros.upload.basename(toFilename);
						} else {
							toFilename = config.macros.upload.basename(toFilename);
						}
						displayMessage(config.macros.upload.messages.mainFileUploaded.format(
							[config.macros.upload.dirname(storeUrl)+&quot;/&quot;+toFilename]), config.macros.upload.dirname(storeUrl)+&quot;/&quot;+toFilename);
						var log = new config.macros.upload.UploadLog();
						log.endUpload();
						store.setDirty(false);
					}
					// for debugging store.php uncomment last line
					//DEBUG alert(responseText);
				}
			);
};

config.macros.upload.uploadContent = function(content, storeUrl, toFilename, uploadDir, backupDir, 
		username, password, callbackFn) {
	var boundary = &quot;---------------------------&quot;+&quot;AaB03x&quot;;		
	var request;
	try {
		request = new XMLHttpRequest();
		} 
	catch (e) { 
		request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); 
		}
	if (window.netscape){
			try {
				if (document.location.toString().substr(0,4) != &quot;http&quot;) {
					netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead');}
			}
			catch (e) { }
		}		
	//DEBUG alert(&quot;user[&quot;+config.options.txtUploadUserName+&quot;] password[&quot; + config.options.pasUploadPassword + &quot;]&quot;);
	// compose headers data
	var sheader = &quot;&quot;;
	sheader += &quot;--&quot; + boundary + &quot;\r\nContent-disposition: form-data; name=\&quot;&quot;;
	sheader += config.macros.upload.formName +&quot;\&quot;\r\n\r\n&quot;;
	sheader += &quot;backupDir=&quot;+backupDir
				+&quot;;user=&quot; + username 
				+&quot;;password=&quot; + password
				+&quot;;uploaddir=&quot; + uploadDir
				+ &quot;;;\r\n&quot;; 
	sheader += &quot;\r\n&quot; + &quot;--&quot; + boundary + &quot;\r\n&quot;;
	sheader += &quot;Content-disposition: form-data; name=\&quot;userfile\&quot;; filename=\&quot;&quot;+toFilename+&quot;\&quot;\r\n&quot;;
	sheader += &quot;Content-Type: &quot; + config.macros.upload.contentType + &quot;\r\n&quot;;
	sheader += &quot;Content-Length: &quot; + content.length + &quot;\r\n\r\n&quot;;
	// compose trailer data
	var strailer = new String();
	strailer = &quot;\r\n--&quot; + boundary + &quot;--\r\n&quot;;
	var data;
	data = sheader + content + strailer;
	//request.open(&quot;POST&quot;, storeUrl, true, username, password);
	request.open(&quot;POST&quot;, storeUrl, true);
	request.onreadystatechange = function () {
				if (request.readyState == 4) {
				     if (request.status == 200)
						callbackFn(request.responseText);
					else
						alert(config.macros.upload.messages.errorUploadingContent);
				}
		};
	request.setRequestHeader(&quot;Content-Length&quot;,data.length);
	request.setRequestHeader(&quot;Content-Type&quot;,&quot;multipart/form-data; boundary=&quot;+boundary);
	request.send(data); 
};


config.macros.upload.download = function(uploadUrl, uploadToFilename, uploadDir, uploadBackupDir, 
	username, password) {
	var request;
	try {
		request = new XMLHttpRequest();
	} 
	catch (e) { 
		request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); 
	}
	try {
		if (uploadUrl.substr(0,4) == &quot;http&quot;) {
			netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);
			}
		else {
			netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
		}
	} catch (e) { }
	//request.open(&quot;GET&quot;, document.location.toString(), true, username, password);
	request.open(&quot;GET&quot;, document.location.toString(), true);
	request.onreadystatechange = function () {
		if (request.readyState == 4) {
			if(request.status == 200) {
				config.macros.upload.uploadChangesFrom(request.responseText, uploadUrl, 
					uploadToFilename, uploadDir, uploadBackupDir, username, password);
			}
			else
				alert(config.macros.upload.messages.errorDownloading.format(
					[document.location.toString()]));
		}
	};
	request.send(null);
};

//}}}
////===

////+++!![Initializations]

//{{{
config.lib.options.init('txtUploadStoreUrl','store.php');
config.lib.options.init('txtUploadFilename','');
config.lib.options.init('txtUploadDir','');
config.lib.options.init('txtUploadBackupDir','');
config.lib.options.init('txtUploadUserName',config.options.txtUserName);
config.lib.options.init('pasUploadPassword','');
config.shadowTiddlers.UploadPluginDoc = &quot;[[Full Documentation|http://tiddlywiki.bidix.info/l#UploadPluginDoc ]]\n&quot;; 


//}}}
////===

////+++!![Core Hijacking]

//{{{
config.macros.saveChanges.label_orig_UploadPlugin = config.macros.saveChanges.label;
config.macros.saveChanges.label = config.macros.upload.label.saveToDisk;

config.macros.saveChanges.handler_orig_UploadPlugin = config.macros.saveChanges.handler;

config.macros.saveChanges.handler = function(place)
{
	if ((!readOnly) &amp;&amp; (document.location.toString().substr(0,4) != &quot;http&quot;))
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
}

//}}}
////===</pre>
</div>
<div title="UpsideDown" modifier="SimonBaird" created="200601120538" modified="200601120538" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601120538">
<pre>Tiddlers that are currently flipped...</pre>
</div>
<div title="UpsideDownViewTemplate" modifier="SimonBaird" created="200601120406" modified="200603080032" tags="ViewTemplates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603080032">
<pre>&lt;!---
| Name:|UpsideDownViewTemplate |
| Purpose:|Stand on your head|
---&gt;
&lt;!--{{{--&gt;
&lt;div class=&quot;tagglyTagging&quot; macro=&quot;tagging&quot;&gt;&lt;/div&gt;
&lt;div style=&quot;background-image:url(../images/up.jpg);background-repeat:no-repeat;background-position:bottom right;&quot; class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div&gt;&lt;span class='title' macro='view title'&gt;&lt;/span&gt;&lt;span class=&quot;miniTag&quot; macro=&quot;miniTag&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;tagglyTagged&quot; macro=&quot;tags&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;toolbar&quot;&gt;
&lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Groceries toggleTag Buy&quot;&gt;&lt;/span&gt;
&lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Flippable toggleTag UpsideDown&quot;&gt;&lt;/span&gt;
&lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Plugins toggleTag systemConfig&quot;&gt;&lt;/span&gt;
&lt;span macro='toolbar -closeTiddler closeOthers +editTiddler permalink references jump newHere'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;br/&gt;

&lt;!--}}}--&gt;
</pre>
</div>
<div title="Urgent" modifier="SimonBaird" created="200604041724" modified="200604041724" tags="Priority" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041724">
<pre></pre>
</div>
<div title="ViewHtml" modifier="SimonBaird" created="200604210221" modified="200605120250" tags="systemConfig Plugins" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605120250">
<pre>/***
&lt;&lt;viewHtml&gt;&gt;
&lt;&lt;viewAsJs&gt;&gt;
***/
//{{{

config.macros.viewHtml = {handler: function (place,macroName,params,wikifier,paramString,tiddler) {
  createTiddlyButton(place,&quot;AsHtml&quot;,&quot;&quot;,function() {
    var divs = document.getElementById(&quot;tiddler&quot;+tiddler.title).getElementsByTagName(&quot;div&quot;);
    for (var i=0;i&lt;divs.length;i++)
      if (divs[i].className == &quot;viewer&quot;)
        displayMessage(divs[i].innerHTML);
  });
}};

String.prototype.escapeLineBreaks = function() {
  // from Tiddler.prototype.escapeLineBreaks
  return this.replace(regexpBackSlash,&quot;\\s&quot;).replace(regexpNewLine,&quot;\\n&quot;).replace(regexpCarriageReturn,&quot;&quot;);
}

// this doesn't work right in IE..
setStylesheet(&quot;#messageArea {overflow:auto; max-height:95%;}&quot;,&quot;scrollDisplayAreaCSS&quot;);

config.macros.viewAsJs = {handler: function (place,macroName,params,wikifier,paramString,tiddler) {
  createTiddlyButton(place,&quot;AsJs&quot;,&quot;&quot;,function() {
      displayMessage('config.shadowTiddlers[&quot;' + tiddler.title + '&quot;] = &quot;' + 
                 store.getTiddlerText(tiddler.title).escapeLineBreaks().replace(/&quot;/g,'\\&quot;') + '&quot;;');
  });
}};


//}}}
</pre>
</div>
<div title="ViewTemplate" modifier="YourName" created="200601061818" modified="200608071554" tags="ViewTemplates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200608071554">
<pre>&lt;!---
See TagglyTaggingViewTemplate
---&gt;
&lt;!--{{{--&gt;
&lt;div class=&quot;toolbar&quot;&gt;
 &lt;!-- testing this one --&gt;
 &lt;!--&lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;viewHtml&quot;&gt;&lt;/span&gt;--&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;viewAsJs&quot;&gt;&lt;/span&gt;
 &lt;!-- experimental stuff. puts checkboxes in toolbar --&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Groceries toggleTag Buy&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Flippable toggleTag UpsideDown&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Plugins toggleTag systemConfig&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Tasks selectUniqueTag Status&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Tasks selectUniqueTag Priority&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Todo toggleTag Urgent&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged Todo toggleTag Done&quot;&gt;&lt;/span&gt;
 &lt;span style=&quot;padding-right:0.75em;&quot; class='fakeButton' macro=&quot;runMacroIfTagged styleSheet toggleTag activeStyleSheet . refreshStyles&quot;&gt;&lt;/span&gt;
 &lt;span macro='toolbar -closeTiddler closeOthers +editTiddler references jump refresh newHere newJournalHere'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class=&quot;tagglyTagged&quot; macro=&quot;hideSomeTags&quot;&gt;&lt;/div&gt;
&lt;div&gt;&lt;span class=&quot;title&quot; macro='view title'&gt;&lt;/span&gt;&lt;span class=&quot;miniTag&quot; macro=&quot;miniTag&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;Created &lt;span macro='view created date [[DD-MM-YY]]'&gt;&lt;/span&gt;, updated &lt;span macro='view modified date [[DD-MM-YY]]'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class=&quot;tagglyTagging&quot; macro=&quot;tagglyTagging&quot;&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="ViewTemplates" modifier="SimonBaird" created="200601160549" modified="200601160549" tags="Templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601160549">
<pre></pre>
</div>
<div title="WhatsNew" modifier="SimonBaird" created="200603091438" modified="200603091439" tags="sortByCreated sortDesc" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200603091439">
<pre></pre>
</div>
<div title="WikifyContentsMacro" modifier="SimonBaird" created="200603080044" modified="200604041736" tags="Plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604041736">
<pre>//{{{
// for use in templates
config.macros.wikifyContents = {};
config.macros.wikifyContents.handler = function (place,macroName,params,wikifier,paramString,tiddler) {
	var contents = place.innerHTML;
	// to avoid CSS complications change the xmp to a div
	var newDiv = document.createElement(&quot;div&quot;);
	newDiv.className = place.className;
	newDiv.setAttribute(&quot;style&quot;,place.getAttribute(&quot;style&quot;));
	place.parentNode.insertBefore(newDiv,place);
	place.parentNode.removeChild(place);
	// the replace is a hack that allows non-br-ing line breaks. \r\n for IE, \n for FF.
	wikify(contents.replace(/\\\r\n/mg,'').replace(/\\\n/mg,'').trim(), newDiv, null, tiddler);
}
//}}}
</pre>
</div>
<div title="Work" modifier="SimonBaird" created="200602161135" modified="200602161135" tags="Contexts" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200602161135">
<pre></pre>
</div>
<div title="autoCorrectWords" modifier="SimonBaird" created="200604061335" modified="200604061347" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200604061347">
<pre>These are used by AutoCorrectPlugin.</pre>
</div>
<div title="systemConfig" modifier="SimonBaird" created="200601100400" modified="200601100400" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200601100400">
<pre>systemConfig contain javascript code that is executed when TiddlyWiki starts up.</pre>
</div>
<div title="testing" modifier="SimonBaird" created="200605100624" modified="200605100656" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/mptw2.html" server.page.revision="200605100656">
<pre>&lt;&lt;tiddlerList tagslogic:&quot;( Plugins &amp;&amp; Borrowed ) &amp;&amp; ! WhatsNew&quot;&gt;&gt;
/%
&lt;&lt;tiddlerList tags:&quot;Plugins,  Borrowed&quot;&gt;&gt;

&lt;&lt;tiddlerList tags2:&quot;Plugins  [[-WhatsNew]] Borrowed&quot;&gt;&gt;

&lt;&lt;tiddlerList tags2:&quot;FunStuff WhatsNew&quot; tagsmode:all&gt;&gt;

&lt;&lt;tiddlerList tags2:&quot;FunStuff WhatsNew&quot; tagsmode:any&gt;&gt;
%/</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[

//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project repository at https://github.com/TiddlyWiki/tiddlywiki
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//
// JSLint directives
/*global jQuery:false, version:false */
/*jslint bitwise:true, browser:true, confusion:true, eqeq:true, evil:true, forin:true, maxerr:100, plusplus:true, regexp:true, sloppy:true, sub:true, undef:true, unparam:true, vars:true, white:true */

//--
//-- Global tw object (window.tw) exposing available methods and structures for developers
//--

window.tw = {
	assets: {
		icons: {}
	},
	io: {},
	textUtils: {}
};

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

config.adaptors = {};
config.defaultAdaptor = null;

// defines the order of the backstage tasks
config.backstageTasks = ["save", "importTask", "tweak", "upgrade", "plugins"];
// map by names from config.backstageTasks, defines their content (see Lingo.js and Backstage.js)
config.tasks = {};

config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkAnimate: true,
	chkAutoSave: false,
	chkBackstage: false,
	chkCaseSensitiveSearch: false,
	chkConfirmDelete: true,
	chkDisplayInstrumentation: false,
	chkForceMinorUpdate: false,
	chkGenerateAnRssFeed: false,
	chkHttpReadOnly: true,
	chkIncrementalSearch: true,
	chkInsertTabs: false,
	chkOpenInNewWindow: true,
	chkPreventAsyncSaving: true,
	chkRegExpSearch: false,
	chkRemoveExtraMarkers: false, // #162
	chkSaveBackups: true,
	chkSaveEmptyTemplate: false,
	chkSliderOptionsPanel: false,
	chkToggleLinks: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtFileSystemCharSet: "UTF-8",
	txtMainTab: "tabTimeline",
	txtMaxEditRows: "30",
	txtMoreTab: "moreTabAll",
	txtTheme: "",
	txtUpgradeCoreURI: ""
};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: { sizeTextbox: 15 },
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: { defaultView: "text" },
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "https://classic.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: { hideReadOnly: true },
	cancelTiddler: {},
	deleteTiddler: { hideReadOnly: true },
	permalink: {},
	references: { type: "popup" },
	jump: { type: "popup" },
	syncing: { type: "popup" },
	fields: { type: "popup" }
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
var isBadSafari = !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")); //# see 52678d4 and #22  ..remove at all?
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
// Moved navigator dependent code out of Config.js into a separate module. Helps with https://github.com/TiddlyWiki/tiddlywiki/issues/22
if(isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern =
	"(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b|\\[|\\])"; // #132
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter +
	"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead, "mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp =
	new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");
config.textPrimitives.tiddlerAnyLinkRegExp =
	new RegExp("(" + config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");

config.glyphs = {
	currBrowser: null,
	browsers: [],
	codes: {}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	SystemSettings: '',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields permalink references jump|\n' +
		'|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|', // #160
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	// config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	ieVersion: /MSIE (\d{1,2}.\d)/i.exec(config.userAgent),
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")),
	// config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent),
	isOpera: config.userAgent.indexOf("opera") != -1,
	isChrome: config.userAgent.indexOf('chrome') > -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

merge(config.glyphs, {
	browsers: [
		function() { return config.browser.isIE },
		function() { return true }
	],
	codes: {
		downTriangle: ["\u25BC", "\u25BE"],
		downArrow: ["\u2193", "\u2193"],
		bentArrowLeft: ["\u2190", "\u21A9"],
		bentArrowRight: ["\u2192", "\u21AA"]
	}
});

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options, {
	txtUserName: "YourName"
});

merge(config.tasks, {
	save: { text: "save", tooltip: "Save your changes to this TiddlyWiki" },
	importTask: { text: "import", tooltip: "Import tiddlers and plugins " +
		"from other TiddlyWiki files and servers", content: '<<importTiddlers>>' },
	tweak: { text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>' },
	upgrade: { text: "upgrade", tooltip: "Upgrade TiddlyWiki core", content: '<<upgrade>>' },
	plugins: { text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>' }
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc, {
	chkAnimate: "Enable animations",
	chkAutoSave: "Automatically save changes",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkOpenInNewWindow: "Open external links in a new window",
	chkPreventAsyncSaving: "Disable attempting async saving (may be needed by old plugins)",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkSaveBackups: "Keep backup file when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	txtBackupFolder: "Name of folder to use for backups",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	chkRemoveExtraMarkers: "Replace unused transclusion markers with blanks", // #162
	txtTheme: "Name of the theme to use",
	txtUpgradeCoreURI: "Custom URI to download TiddlyWiki core from (when upgrading)",
	txtUserName: "Username for signing your edits"
});

merge(config.messages, {
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see https://classic.tiddlywiki.com/#SaveUnpredictabilities for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "TiddlyWiki saved",
	mainDownload: "Downloading/saving main TiddlyWiki file",
	mainDownloadManual: "RIGHT CLICK HERE to download/save main TiddlyWiki file",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"
});

merge(config.messages.messageClose, {
	text: "close",
	tooltip: "close this message area"
});

config.messages.backstage = {
	open: { text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks" },
	close: { text: "close", tooltip: "Close the backstage area" },
	prompt: "backstage: ",
	decal: {
		edit: { text: "edit", tooltip: "Edit the tiddler '%0'" }
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June",
	"July", "August", "September", "October", "November", "December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = [
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"th", "th", "th", "th", "th", "th", "th", "th", "th", "th",
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"st"
];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup, {});

merge(config.views.wikified.tag, {
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"
});

merge(config.views.wikified, {
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"
});

merge(config.views.editor, {
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"
});

merge(config.views.editor.tagChooser, {
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"
});

merge(config.messages, {
	sizeTemplates: [
		{ unit: 1024 * 1024 * 1024, template: "%0\u00a0GB" },
		{ unit: 1024 * 1024, template: "%0\u00a0MB" },
		{ unit: 1024, template: "%0\u00a0KB" },
		{ unit: 1, template: "%0\u00a0B" }
	]
});

merge(config.macros.search, {
	label: "search",
	prompt: "Search this TiddlyWiki",
	placeholder: "",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"
});

merge(config.macros.tagging, {
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"
});

merge(config.macros.timeline, {
	dateFormat: "DD MMM YYYY"
});

merge(config.macros.allTags, {
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"
});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll, {
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"
});

merge(config.macros.permaview, {
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"
});

merge(config.macros.saveChanges, {
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"
});

merge(config.macros.newTiddler, {
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"
});

merge(config.macros.newJournal, {
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"
});

merge(config.macros.options, {
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br>" +
		"<label><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</label>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{ name: 'Option', field: 'option', title: "Option", type: 'String' },
			{ name: 'Description', field: 'description', title: "Description", type: 'WikiText' },
			{ name: 'Name', field: 'name', title: "Name", type: 'String' }
		],
		rowClasses: [
			{ className: 'lowlight', field: 'lowlight' }
		]
	}
});

merge(config.macros.plugins, {
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox' },
			{ name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	},
	listViewTemplateReadOnly: {
		columns: [
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	}
});

merge(config.macros.toolbar, {
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
});

merge(config.macros.refreshDisplay, {
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
});

merge(config.macros.importTiddlers, {
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>" +
		"Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>" +
		"...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>" +
		"...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: " +
		"<select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	errorGettingTiddlerListHttp404: "Error retrieving tiddlers from url, please ensure the url exists. Click Cancel to try again.",
	errorGettingTiddlerListHttp: "Error retrieving tiddlers from url, please " +
		"ensure this url exists and is <a href='http://enable-cors.org/'>CORS</a> enabled",
	errorGettingTiddlerListFile: "Error retrieving tiddlers from local file, " +
		"please make sure the file is in the same directory as your TiddlyWiki. Click Cancel to try again.",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>" +
		"Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br>" +
		"<input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' " +
		"to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\n" +
		"This tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Tags', field: 'tags', title: "Tags", type: 'Tags' }
		],
		rowClasses: []
	}
});

merge(config.macros.upgrade, {
	wizardTitle: "Upgrade TiddlyWiki",
	step1Title: "Update or repair TiddlyWiki core to the latest release",
	step1Html: "You are about to upgrade TiddlyWiki core to the latest release " +
		"(from <a href='%0' class='externalLink' target='_blank'>%1</a>). " +
		"Your content will be preserved across the upgrade.<br><br>" +
		"Note that core upgrades have been known to interfere with older plugins. " +
		"If you run into problems with upgrading, read how to handle them " +
		"<a href='%2' class='externalLink' target='_blank'>here</a>.",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>" +
		"You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	errorVerifyingBackup: "Failed to verify the backup was saved. " +
		"This is either because it wasn't saved to the moment of the check or " +
		"loading file doesn't work with your saver (and it is needed for " +
		"the next step of upgrading). To upgrade your TiddlyWiki, you can use " +
		"other methods listed at <a href='%0' class='externalLink' target='_blank'>%0</a>",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
});

merge(config.macros.annotations, {});

merge(config.commands.closeTiddler, {
	text: "close",
	tooltip: "Close this tiddler"
});

merge(config.commands.closeOthers, {
	text: "close others",
	tooltip: "Close all other tiddlers"
});

merge(config.commands.editTiddler, {
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"
});

merge(config.commands.saveTiddler, {
	text: "done",
	tooltip: "Save changes to this tiddler"
});

merge(config.commands.cancelTiddler, {
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"
});

merge(config.commands.deleteTiddler, {
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"
});

merge(config.commands.permalink, {
	text: "permalink",
	tooltip: "Permalink for this tiddler"
});

merge(config.commands.references, {
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"
});

merge(config.commands.jump, {
	text: "jump",
	tooltip: "Jump to another open tiddler"
});

merge(config.commands.fields, {
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{ name: 'Field', field: 'field', title: "Field", type: 'String' },
			{ name: 'Value', field: 'value', title: "Value", type: 'String' }
		],
		rowClasses: [],
		buttons: []
	}
});

merge(config.shadowTiddlers, {
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">>' +
		'<<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
});

merge(config.annotations, {
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. " +
		"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. " +
	"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "Options may be stored here using the slice notation (like {{{chkAutoSave: true}}} or {{{|txtUserName|The great inventor|}}})",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo, tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file can be saved back to the same location [Preemption]
window.allowSave = window.allowSave || function(l) {
	return true;
};

// Whether this file is being viewed locally
window.isLocal = function() {
	return (document.location.protocol == "file:");
};

var useJavaSaver = false;

// Allow preemption code a chance to tweak config and useJavaSaver [Preemption]
if (window.tweakConfig) window.tweakConfig();

if(!window || !window.console) {
	console = { tiddlywiki: true, log: function(message) { displayMessage(message) } };
}

// Starting up
function main() {
	window.originalHTML = recreateOriginal();

	var t10, t9, t8, t7, t6, t5, t4, t3, t2, t1, t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) { if(window.confirmExit) return confirmExit(); };
	params = getParameters();
	if(params) params = params.parseParams("open", null, false);
	store = new TiddlyWiki({ config: config });
	invokeParamifier(params, "oninit");
	story = new Story("tiddlerDisplay", "tiddler");
	addEvent(document, "click", Popup.onDocumentClick);
	saveTest();
	for(var i = 0; i < config.notifyTiddlers.length; i++)
		store.addNotification(config.notifyTiddlers[i].name, config.notifyTiddlers[i].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea", "store", true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params, "onload");
	t4 = new Date();
	readOnly = window.isLocal() ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params, "onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	for(var name in config.macros) {
		if(config.macros[name].init)
			config.macros[name].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null, "PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2 - t1) + " ms");
		displayMessage("LoadFromDiv " + (t3 - t2) + " ms");
		displayMessage("LoadPlugins " + (t5 - t4) + " ms");
		displayMessage("Macro init " + (t7 - t6) + " ms");
		displayMessage("Notify " + (t8 - t7) + " ms");
		displayMessage("Restart " + (t9 - t8) + " ms");
		displayMessage("Total: " + (t10 - t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. Functions may get unloaded too, so they are called conditionally.
function unload() {
	if(window.checkUnsavedChanges) checkUnsavedChanges();
	if(window.scrubNodes) scrubNodes(document.body);
}

// Restarting
function restart() {
	invokeParamifier(params, "onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0, 0);
}

function saveTest() {
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers() {
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea", "shadows", true);
	shadows.forEachTiddler(function(title, tiddler) { config.shadowTiddlers[title] = tiddler.text });
}

function loadPlugins(tag) {
	if(safeMode) return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1) });

	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i = 0; i < nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n) map[n] = p;
		n = p.Source;
		if(n) map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done) return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i = 0; i < reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i = 0; i < nPlugins; i++)
		visit(installedPlugins[i]);
	for(i = 0; i < toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text) window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler) {
	var p = store.getTiddlerSlices(tiddler.title, ["Name", "Description", "Version",
		"Requires", "CoreVersion", "Date", "Source", "Author", "License", "Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin) {
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0], 10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1], 10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2], 10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin) {
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

//--
//-- Paramifiers
//--

function getParameters() {
	return window.location.hash ? decodeURIComponent(window.location.hash.substr(1)) : null;
}

function invokeParamifier(params, handler) {
	if(!params || params.length == undefined || params.length <= 1)
		return;

	for(var i = 1; i < params.length; i++) {
		var name = params[i].name,
		    value = params[i].value;
		var p = config.paramifiers[name];
		if(p && p[handler] instanceof Function)
			p[handler](value);
		else {
			var h = config.optionHandlers[name.substr(0, 3)];
			if(h && h.set instanceof Function)
				h.set(name, value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(title) {
		if(!readOnly || store.tiddlerExists(title) || store.isShadowTiddler(title))
			story.displayTiddler("bottom", title, null, false, null);
	}
};

config.paramifiers.story = {
	onstart: function(title) {
		var list = store.getTiddlerText(title, "").parseParams("open", null, false);
		invokeParamifier(list, "onstart");
	}
};

config.paramifiers.search = {
	onstart: function(query) {
		story.search(query, false, false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v, false, true);
	}
};

config.paramifiers.tag = {
	onstart: function(tag) {
		story.displayTiddlers(null, store.filterTiddlers("[tag[" + tag + "]]"), null, false, null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(readOnly) return;
		var args = v.parseParams("anon", null, null)[0];
		var title = args.title ? args.title[0] : v;
		var customFields = args.fields ? args.fields[0] : null;

		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, customFields);
		story.focusTiddler(title, "text");
		var i, tags = args.tag || [];
		for(i = 0; i < tags.length; i++) {
			story.setTiddlerTag(title, tags[i], +1);
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(titleTemplate) {
		if(readOnly) return;
		var now = new Date();
		var title = now.formatString(titleTemplate.trim());
		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE);
		story.focusTiddler(title, "text");
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(themeTitle) {
		story.switchTheme(themeTitle);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent = {
	onstart: function(limit) {
		var titles = [];
		var i, tiddlers = store.getTiddlers("modified", "excludeLists").reverse();
		for(i = 0; i < limit && i < tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null, titles);
	}
};

config.paramifiers.filter = {
	onstart: function(filterExpression) {
		story.displayTiddlers(null, store.filterTiddlers(filterExpression), null, false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters) {
	this.formatters = [];
	var pattern = [];
	for(var n = 0; n < formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"), "mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w) {
		w.subWikifyTerm(createTiddlyElement(w.output, this.element), this.termRegExp);
	},

	inlineCssHelper: function(w) {
		// Convert CSS property name to a JavaScript style name ("background-color" -> "backgroundColor")
		var unDash = function(name) {
			return name
				.split("-")
				.map(function(word, i) {
					return i == 0 ? word :
						word.charAt(0).toUpperCase() + word.slice(1);
				})
				.join("");
		};
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s, v;
			if(lookaheadMatch[1]) {
				s = unDash(lookaheadMatch[1]);
				v = lookaheadMatch[2];
			} else {
				s = unDash(lookaheadMatch[3]);
				v = lookaheadMatch[4];
			}
			if(s == "bgcolor") s = "backgroundColor";
			if(s == "float") s = "cssFloat";
			styles.push({ style: s, value: v });
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e, styles) {
		for(var i = 0; i < styles.length; i++) {
			try {
				e.style[styles[i].style] = styles[i].value;
			} catch (ex) {}
		}
	},

	enclosedTextHelper: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE && (config.browser.ieVersion[1] < 10))
				text = text.replace(/\n/g, "\r");
			createTiddlyElement(w.output, this.element, null, null, text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link) {
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern, "mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".") != -1 ||
		   link.indexOf("\\") != -1 ||
		   link.indexOf("/") != -1 ||
		   link.indexOf("#") != -1
		) {
			return true;
		}
		return false;
	}
};

//--
//-- Standard formatters
//--

config.formatters = [
	{
		name: "table",
		match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
		lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
		rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
		cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
		cellTermRegExp: /((?:\x20*)\|)/mg,
		rowTypes: { "c": "caption", "h": "thead", "": "tbody", "f": "tfoot" },
		handler: function(w) {
			var table = createTiddlyElement(w.output, "table", null, "twtable");
			var prevColumns = [];
			var currRowType = null;
			var rowContainer;
			var rowCount = 0;
			var onmouseover = function() { jQuery(this).addClass("hoverRow") };
			var onmouseout = function() { jQuery(this).removeClass("hoverRow") };
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				var nextRowType = lookaheadMatch[2];
				if(nextRowType == "k") {
					table.className = lookaheadMatch[1];
					w.nextMatch += lookaheadMatch[0].length + 1;
				} else {
					if(nextRowType != currRowType) {
						rowContainer = createTiddlyElement(table, this.rowTypes[nextRowType]);
						currRowType = nextRowType;
					}
					if(currRowType == "c") {
						// Caption
						w.nextMatch++;
						if(rowContainer != table.firstChild)
							table.insertBefore(rowContainer, table.firstChild);
						rowContainer.setAttribute("align", rowCount == 0 ? "top" : "bottom");
						w.subWikifyTerm(rowContainer, this.rowTermRegExp);
					} else {
						var theRow = createTiddlyElement(rowContainer, "tr", null, rowCount % 2 ? "oddRow" : "evenRow");
						theRow.onmouseover = onmouseover;
						theRow.onmouseout = onmouseout;
						this.rowHandler(w, theRow, prevColumns);
						rowCount++;
					}
				}
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		},
		rowHandler: function(w, e, prevColumns) {
			var col = 0;
			var colSpanCount = 1;
			var prevCell = null;
			this.cellRegExp.lastIndex = w.nextMatch;
			var cellMatch = this.cellRegExp.exec(w.source);
			while(cellMatch && cellMatch.index == w.nextMatch) {
				if(cellMatch[1] == "~") {
					// Rowspan
					var last = prevColumns[col];
					if(last) {
						last.rowSpanCount++;
						last.element.setAttribute("rowspan", last.rowSpanCount);
						last.element.setAttribute("rowSpan", last.rowSpanCount); // Needed for IE
						last.element.valign = "center";
						if(colSpanCount > 1) {
							last.element.setAttribute("colspan", colSpanCount);
							last.element.setAttribute("colSpan", colSpanCount); // Needed for IE
							colSpanCount = 1;
						}
					}
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[1] == ">") {
					// Colspan
					colSpanCount++;
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[2]) {
					// End of row
					if(prevCell && colSpanCount > 1) {
						prevCell.setAttribute("colspan", colSpanCount);
						prevCell.setAttribute("colSpan", colSpanCount); // Needed for IE
					}
					w.nextMatch = this.cellRegExp.lastIndex;
					break;
				} else {
					// Cell
					w.nextMatch++;
					var styles = config.formatterHelpers.inlineCssHelper(w);
					var spaceLeft = false;
					var chr = w.source.substr(w.nextMatch, 1);
					while(chr == " ") {
						spaceLeft = true;
						w.nextMatch++;
						chr = w.source.substr(w.nextMatch, 1);
					}
					var cell;
					if(chr == "!") {
						cell = createTiddlyElement(e, "th");
						w.nextMatch++;
					} else {
						var isInsideHeader = e.parentElement.tagName.toLocaleLowerCase() === 'thead';
						cell = createTiddlyElement(e, isInsideHeader ? "th" : "td");
					}
					prevCell = cell;
					prevColumns[col] = { rowSpanCount: 1, element: cell };
					if(colSpanCount > 1) {
						cell.setAttribute("colspan", colSpanCount);
						cell.setAttribute("colSpan", colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
					config.formatterHelpers.applyCssHelper(cell, styles);
					w.subWikifyTerm(cell, this.cellTermRegExp);
					if(w.matchText.substr(w.matchText.length - 2, 1) == " ") // spaceRight
						cell.align = spaceLeft ? "center" : "left";
					else if(spaceLeft)
						cell.align = "right";
					w.nextMatch--;
				}
				col++;
				this.cellRegExp.lastIndex = w.nextMatch;
				cellMatch = this.cellRegExp.exec(w.source);
			}
		}
	},

	{
		name: "heading",
		match: "^!{1,6}",
		termRegExp: /(\n)/mg,
		handler: function(w) {
			w.subWikifyTerm(createTiddlyElement(w.output, "h" + w.matchLength), this.termRegExp);
		}
	},

	{
		name: "list",
		match: "^(?:[\\*#;:]+)",
		lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
		termRegExp: /(\n)/mg,
		handler: function(w) {
			// stack holds nested elements to which (nested) lists are appended
			var stack = [w.output];
			var currLevel = 0, currType = null;
			var listLevel, listType, itemType, baseType;
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				if(lookaheadMatch[1]) {
					listType = "ul";
					itemType = "li";
				} else if(lookaheadMatch[2]) {
					listType = "ol";
					itemType = "li";
				} else if(lookaheadMatch[3]) {
					listType = "dl";
					itemType = "dt";
				} else if(lookaheadMatch[4]) {
					listType = "dl";
					itemType = "dd";
				}
				if(!baseType)
					baseType = listType;
				listLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				var l;
				if(listLevel > currLevel) {
					for(l = currLevel; l < listLevel; l++) {
						var target = (currLevel == 0) ? stack[stack.length - 1] : stack[stack.length - 1].lastChild;
						stack.push(createTiddlyElement(target, listType));
					}
				} else if(listType != baseType && listLevel == 1) {
					w.nextMatch -= lookaheadMatch[0].length;
					return;
				} else if(listLevel < currLevel) {
					for(l = currLevel; l > listLevel; l--)
						stack.pop();
				} else if(listLevel == currLevel && listType != currType) {
					stack.pop();
					stack.push(createTiddlyElement(stack[stack.length - 1].lastChild, listType));
				}
				currLevel = listLevel;
				currType = listType;
				var itemElement = createTiddlyElement(stack[stack.length - 1], itemType);
				w.subWikifyTerm(itemElement, this.termRegExp);
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		}
	},

	{
		name: "quoteByBlock",
		match: "^<<<\\n",
		termRegExp: /(^<<<(\n|$))/mg,
		element: "blockquote",
		handler: config.formatterHelpers.createElementAndWikify
	},

	{
		name: "quoteByLine",
		match: "^>+",
		lookaheadRegExp: /^>+/mg,
		termRegExp: /(\n)/mg,
		element: "blockquote",
		handler: function(w) {
			var stack = [w.output];
			var currLevel = 0;
			var newLevel = w.matchLength;
			var l, matched;
			do {
				if(newLevel > currLevel) {
					for(l = currLevel; l < newLevel; l++)
						stack.push(createTiddlyElement(stack[stack.length - 1], this.element));
				} else if(newLevel < currLevel) {
					for(l = currLevel; l > newLevel; l--)
						stack.pop();
				}
				currLevel = newLevel;
				w.subWikifyTerm(stack[stack.length - 1], this.termRegExp);
				createTiddlyElement(stack[stack.length - 1], "br");
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
				matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
				if(matched) {
					newLevel = lookaheadMatch[0].length;
					w.nextMatch += lookaheadMatch[0].length;
				}
			} while(matched);
		}
	},

	{
		name: "rule",
		match: "^----+$\\n?|<hr ?/?>\\n?",
		handler: function(w) {
			createTiddlyElement(w.output, "hr");
		}
	},

	{
		name: "monospacedByLine",
		match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
		element: "pre",
		handler: function(w) {
			switch(w.matchText) {
				case "/*{{{*/\n": // CSS
					this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
					break;
				case "{{{\n": // monospaced block
					this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
					break;
				case "//{{{\n": // plugin
					this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
					break;
				case "<!--{{{-->\n": //template
					this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
					break;
				default:
					break;
			}
			config.formatterHelpers.enclosedTextHelper.call(this, w);
		}
	},

	{
		name: "wikifyComment",
		match: "^(?:/\\*\\*\\*|<!---)\\n",
		handler: function(w) {
			var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
			w.subWikifyTerm(w.output, termRegExp);
		}
	},

	{
		name: "macro",
		match: "<<",
		lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
				w.nextMatch = this.lookaheadRegExp.lastIndex;
				invokeMacro(w.output, lookaheadMatch[1], lookaheadMatch[2], w, w.tiddler);
			}
		}
	},

	{
		name: "prettyLink",
		match: "\\[\\[",
		lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var e;
				var text = lookaheadMatch[1];
				if(lookaheadMatch[3]) {
					// Pretty bracketted link
					var link = lookaheadMatch[3];
					e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link))
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
				} else {
					// Simple bracketted link
					e = createTiddlyLink(w.output, text, false, null, w.isStatic, w.tiddler);
				}
				createTiddlyText(e, text);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "wikiLink",
		match: config.textPrimitives.unWikiLink + "?" + config.textPrimitives.wikiLink,
		handler: function(w) {
			if(w.matchText.substr(0, 1) == config.textPrimitives.unWikiLink) {
				w.outputText(w.output, w.matchStart + 1, w.nextMatch);
				return;
			}
			if(w.matchStart > 0) {
				var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict, "mg");
				preRegExp.lastIndex = w.matchStart - 1;
				var preMatch = preRegExp.exec(w.source);
				if(preMatch.index == w.matchStart - 1) {
					w.outputText(w.output, w.matchStart, w.nextMatch);
					return;
				}
			}
			if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
				var link = createTiddlyLink(w.output, w.matchText, false, null, w.isStatic, w.tiddler);
				w.outputText(link, w.matchStart, w.nextMatch);
			} else {
				w.outputText(w.output, w.matchStart, w.nextMatch);
			}
		}
	},

	{
		name: "urlLink",
		match: config.textPrimitives.urlPattern,
		handler: function(w) {
			w.outputText(createExternalLink(w.output, w.matchText), w.matchStart, w.nextMatch);
		}
	},

	{
		name: "image",
		match: "\\[[<>]?[Ii][Mm][Gg]\\[",
		lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var container = w.output;
				var link = lookaheadMatch[5];
				if(link) {
					container = config.formatterHelpers.isExternalLink(link)
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
					jQuery(container).addClass("imageLink");
				}
				var img = createTiddlyElement(container, "img");
				if(lookaheadMatch[1])
					img.align = "left";
				else if(lookaheadMatch[2])
					img.align = "right";
				if(lookaheadMatch[3]) {
					img.title = lookaheadMatch[3];
					img.setAttribute("alt", lookaheadMatch[3]);
				}
				img.src = lookaheadMatch[4];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "html",
		match: "<[Hh][Tt][Mm][Ll]>",
		lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span").innerHTML = lookaheadMatch[1];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "commentByBlock",
		match: "/%",
		lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
				w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	},

	{
		name: "characterFormat",
		match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "''":
					w.subWikifyTerm(w.output.appendChild(document.createElement("strong")), /('')/mg);
					break;
				case "//":
					w.subWikifyTerm(createTiddlyElement(w.output, "em"), /(\/\/)/mg);
					break;
				case "__":
					w.subWikifyTerm(createTiddlyElement(w.output, "u"), /(__)/mg);
					break;
				case "^^":
					w.subWikifyTerm(createTiddlyElement(w.output, "sup"), /(\^\^)/mg);
					break;
				case "~~":
					w.subWikifyTerm(createTiddlyElement(w.output, "sub"), /(~~)/mg);
					break;
				case "--":
					w.subWikifyTerm(createTiddlyElement(w.output, "strike"), /(--)/mg);
					break;
				case "{{{":
					var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
						createTiddlyElement(w.output, "code", null, null, lookaheadMatch[1]);
						w.nextMatch = lookaheadRegExp.lastIndex;
					}
					break;
			}
		}
	},

	{
		name: "customFormat",
		match: "@@|\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "@@":
					var e = createTiddlyElement(w.output, "span");
					var styles = config.formatterHelpers.inlineCssHelper(w);
					if(styles.length == 0)
						e.className = "marked";
					else
						config.formatterHelpers.applyCssHelper(e, styles);
					w.subWikifyTerm(e, /(@@)/mg);
					break;
				case "{{":
					var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w-]*)[\s]*\{(\n?)/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch) {
						w.nextMatch = lookaheadRegExp.lastIndex;
						e = createTiddlyElement(w.output, lookaheadMatch[2] == "\n" ? "div" : "span", null, lookaheadMatch[1]);
						w.subWikifyTerm(e, /(\}\}\})/mg);
					}
					break;
			}
		}
	},

	{
		name: "mdash",
		match: "--",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = "&mdash;";
		}
	},

	{
		name: "lineBreak",
		match: "\\n|<br ?/?>",
		handler: function(w) {
			createTiddlyElement(w.output, "br");
		}
	},

	{
		name: "rawText",
		match: "\"{3}|<nowiki>",
		lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span", null, null, lookaheadMatch[1]);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "htmlEntitiesEncoding",
		match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)" +
			"(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*" +
			"(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+" +
			"|&#?[a-zA-Z0-9]{2,8};)",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = w.matchText;
		}
	}
];

//--
//-- Wikifier
//--

function getParser(tiddler, format) {
	if(tiddler) {
		if(!format) format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers)
				if(format == config.parsers[i].format)
					return config.parsers[i];
		} else {
			for(i in config.parsers)
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
		}
	}
	return formatter;
}

function Wikifier(source, formatter, highlightRegExp, tiddler) {
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function() {
	var e = createTiddlyElement(document.body, "div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(output, terminator) {
	try {
		if(terminator)
			this.subWikifyTerm(output, new RegExp("(" + terminator + ")", "mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output) {
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch;
	while(formatterMatch = this.formatter.formatterRegExp.exec(this.source)) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output, terminatorRegExp) {
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
		this.source.substr(0, terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output, this.nextMatch, terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
			this.source.substr(0, terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place, startPos, endPos) {
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) &&
		  (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place, this.source.substring(startPos, this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex, endPos);
		createTiddlyElement(place, "span", null, "highlight", this.source.substring(startPos, highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place, this.source.substring(startPos, endPos));
	}
};

function wikify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, getParser(tiddler), highlightRegExp, tiddler);
	var t0 = new Date();
	wikifier.subWikify(output);
	if(tiddler && config.options.chkDisplayInstrumentation)
		displayMessage("wikify:" + tiddler.title + " in " + (new Date() - t0) + " ms");
}

function wikifyStatic(source, highlightRegExp, tiddler, format) {
	if(!source) return "";
	if(!tiddler) tiddler = new Tiddler("temp");
	var wikifier = new Wikifier(source, getParser(tiddler, format), highlightRegExp, tiddler);
	wikifier.isStatic = true;

	var e = createTiddlyElement(document.body, "pre");
	e.style.display = "none";
	wikifier.subWikify(e);
	var html = e.innerHTML;
	jQuery(e).remove();
	return html;
}

function wikifyPlainText(text, limit, tiddler) {
	if(limit > 0)
		text = text.substr(0, limit);
	var wikifier = new Wikifier(text, formatter, null, tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, formatter, highlightRegExp, tiddler);
	wikifier.outputText(output, 0, source.length);
}

//--
//-- Macro definitions
//--

function invokeMacro(place, macro, params, wikifier, tiddler) {
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);

			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;

			var allowEval = true;
			if(config.evaluateMacroParameters == "system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place, macro, m.noPreParse ? null : params.readMacroParams(!allowEval), wikifier, params, tiddler);
		} else {
			createTiddlyError(place, config.messages.macroError.format([macro]),
				config.messages.macroErrorDetails.format([macro, config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place, config.messages.macroError.format([macro]),
			config.messages.macroErrorDetails.format([macro, ex.toString()]));
	}
}

config.macros.version.handler = function(place) {
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place, macroName, params) {
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";
config.macros.list.handler = function(place, macroName, params, wikifier, paramString) {
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	var template = args.template ? store.getTiddlerText(args.template[0]) : false;
	if(!template) {
		template = config.macros.list.template;
	}
	var results;
	if(this[type].handler)
		results = this[type].handler(params);

	jQuery(list).empty().addClass("list list-" + type);
	if(this[type].prompt)
		createTiddlyElement(list, "li", null, "listTitle", this[type].prompt);

	for(var i = 0; i < results.length; i++) {
		var li = createTiddlyElement(list, "li");
		var tiddler = results[i];
		if(typeof(tiddler) == 'string') { // deal with missing etc..
			tiddler = store.getTiddler(tiddler) || new Tiddler(tiddler);
		}
		wikify(template, li, null, tiddler);
	}
	if(results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params) {
	return store.reverseLookup("tags", "excludeLists", false, "title");
};

config.macros.list.missing.handler = function(params) {
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params) {
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params) {
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params) {
	return store.getTouched();
};

config.macros.list.filter.handler = function(params) {
	var filter = params[1];
	if(!filter) return [];
	return store.filterTiddlers(filter).map(function(tiddler) {
		return tiddler.title;
	});
};

config.macros.allTags.handler = function(place, macroName, params) {
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place, "ul");
	if(tags.length == 0) createTiddlyElement(ul, "li", null, "listTitle", this.noTags);

	for(var i = 0; i < tags.length; i++) {
		var title = tags[i][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul, "li");
		var btn = createTiddlyButton(li, title + " (" + tags[i][1] + ")",
			this.tooltip.format([title]), onClickTag, info.classes);
		btn.setAttribute("tag", title);
		btn.setAttribute("refresh", "link");
		btn.setAttribute("tiddlyLink", title);
		if(params[1]) btn.setAttribute("sortby", params[1]);
	}
};

var macro = config.macros.timeline;
merge(macro, {
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).
			attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var field = params[0] || "modified";
		var prefix = field.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? field.substr(1, field.length) : field;
		var dateFormat = params[2] || this.dateFormat;

		var groupTemplate = (args.groupTemplate ? store.getTiddlerText(args.groupTemplate[0]) : null)
			|| macro.groupTemplate.format(no_prefix_field, dateFormat);
		var itemTemplate = (args.template ? store.getTiddlerText(args.template[0]) : null)
			|| macro.itemTemplate;

		var tiddlers = args.filter ? store.sortTiddlers(store.filterTiddlers(args.filter[0]), field) :
			store.reverseLookup("tags", "excludeLists", false, field);
		var last = params[1] ? tiddlers.length - Math.min(tiddlers.length, parseInt(params[1], 10)) : 0;
		var lastGroup = "", ul;

		for(var i = tiddlers.length - 1; i >= last; i--) {
			var theGroup = wikifyPlainText(groupTemplate, 0, tiddlers[i]);
			if(ul === undefined || theGroup != lastGroup) {
				ul = createTiddlyElement(container, "ul", null, "timeline");
				createTiddlyElement(ul, "li", null, "listTitle", theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul, "li", null, "listLink");
			wikify(itemTemplate, item, null, tiddlers[i]);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>",
	itemTemplate: "<<view title link>>"
});

config.macros.tiddler.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length - 1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0, pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name", null, allowEval, false, true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];

	var wrapper = createTiddlyElement(place, "span", null, className, null, {
		refresh: "content", tiddler: tiddlerName
	});
	if(args !== undefined)
		wrapper.macroArgs = args; // #154
	this.transclude(wrapper, tiddlerName, args);
};

config.macros.tiddler.transclude = function(wrapper, tiddlerName, args) {
	var text = store.getTiddlerText(tiddlerName);
	if(!text) return;

	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1) return;

	stack.push(tiddlerName);
	try {
		// substitute $1, $2, .. placeholders (markers)
		if(typeof args == "string")
			args = args.readBracketedList();
		var maxSupportedPlaceholders = 9; // $1 - $9
		var n = args ? args.length : 0;
		for(var i = 0; i < maxSupportedPlaceholders; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1), "mg");
			if(i < n) {
				text = text.replace(placeholderRE, args[i]);
			}
			// #162
			else if(n && config.options.chkRemoveExtraMarkers) {
				text = text.replace(placeholderRE, "");
			}
		}

		config.macros.tiddler.renderText(wrapper, text, tiddlerName);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place, text, tiddlerName) {
	wikify(text, place, null, store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place, macroName, params) {
	var btn = createTagButton(place, params[0], null, params[1], params[2]);
	if(params[3]) btn.setAttribute('sortby', params[3]);
};

config.macros.tags.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params, "sep", " ");
	var lingo = config.views.wikified.tag;

	var ul = createTiddlyElement(place, "ul");
	createTiddlyElement(ul, "li", null, "listTitle",
		(tiddler.tags.length ? lingo.labelTags : lingo.labelNoTags).format([tiddler.title])
	);
	for(var i = 0; i < tiddler.tags.length; i++) {
		var tag = store.getTiddler(tiddler.tags[i]);
		if(tag && tag.tags.indexOf("excludeLists") != -1) continue;
		createTagButton(createTiddlyElement(ul, "li"), tiddler.tags[i], tiddler.title);
		if(i < tiddler.tags.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.tagging.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params, "sep", " ");
	var sortby = getParam(params, "sortBy", false);
	var tagged = store.getTaggedTiddlers(title, sortby);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;

	var ul = createTiddlyElement(place, "ul");
	ul.setAttribute("title", this.tooltip.format([title]));
	createTiddlyElement(ul, "li", null, "listTitle", prompt.format([title, tagged.length]));

	for(var i = 0; i < tagged.length; i++) {
		createTiddlyLink(createTiddlyElement(ul, "li"), tagged[i].title, true);
		if(i < tagged.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.closeAll.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.closeAll.onClick = function(e) {
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.permaview.onClick = function(e) {
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place, macroName, params) {
	if(!readOnly)
		createTiddlyButton(place, params[0] || this.label, params[1] || this.prompt, this.onClick, null, null, this.accessKey);
};

config.macros.saveChanges.onClick = function(e) {
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev) {
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n, !isOpen, null, "none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place, cookie, title, tooltip) {
	var c = cookie || "";
	createTiddlyButton(place, title, tooltip, this.onClickSlider);
	var panel = createTiddlyElement(null, "div", null, "sliderPanel");
	panel.setAttribute("cookie", c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place, macroName, params) {
	var panel = this.createSlider(place, params[0], params[2], params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh", "content");
	panel.setAttribute("tiddler", params[1]);
	if(text)
		wikify(text, panel, null, store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var panel = wikifier ? createTiddlyElement(place, "div", null, "gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel, styles);
	}
	params = paramString.parseParams("color");
	var loColors = [], hiColors = [];

	for(var i = 2; i < params.length; i++) {
		var c = params[i].value;
		if(params[i].name == "snap") {
			hiColors[hiColors.length - 1] = c;
		} else {
			loColors.push(c);
			hiColors.push(c);
		}
	}
	drawGradient(panel, params[1].value != "vert", loColors, hiColors);
	if(wikifier)
		wikifier.subWikify(panel, ">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place, macroName, params) {
	if(!params[0]) return;

	var names = params[0].split(".");
	var lookupMessage = function(root, nameIndex) {
		if(root[names[nameIndex]]) {
			if(nameIndex < names.length - 1)
				return (lookupMessage(root[names[nameIndex]], nameIndex + 1));
			else
				return root[names[nameIndex]];
		} else
			return null;
	};
	var m = lookupMessage(config, 0);
	if(m == null)
		m = lookupMessage(window, 0);
	createTiddlyText(place, m.toString().format(params.splice(1)));
};

config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value, place, params, wikifier, paramString, tiddler) {
		highlightify(value, place, highlightHack, tiddler);
	},
	link: function(value, place, params, wikifier, paramString, tiddler) {
		createTiddlyLink(place, value, true);
	},
	wikified: function(value, place, params, wikifier, paramString, tiddler) {
		if(config.macros.view.depth > 50)
			return;
		if(config.macros.view.depth > 0) {
			if (value == config.macros.view.values[config.macros.view.depth - 1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if(params[2])
			value = params[2].unescapeLineBreaks().format([value]);
		wikify(value, place, highlightHack, tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value, place, params, wikifier, paramString, tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place, value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler) || !params[0]) return;
	var value = store.getValue(tiddler, params[0]);
	if(!value) return;

	var type = params[1] || config.macros.view.defaultView;
	var handler = config.macros.view.views[type];
	if(handler)
		handler(value, place, params, wikifier, paramString, tiddler);
};

config.macros.edit.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var field = params[0];
	var rows = params[1] || 0;
	var defaultValue = params[2] || '';
	if(!(tiddler instanceof Tiddler) || !field) return;

	story.setDirty(tiddler.title, true);
	var e, value = store.getValue(tiddler, field) || defaultValue;
	if(field != "text" && !rows) {
		e = createTiddlyElement(place, "input", null, null, null, {
			type: "text", edit: field, size: "40", autocomplete: "off"
		});
		e.value = value;
	} else {
		rows = rows || 10;
		var lines = value.match(/\n/mg);
		var maxLines = Math.max(parseInt(config.options.txtMaxEditRows), 5);
		if(lines != null && lines.length > rows)
			rows = lines.length + 5;
		rows = Math.min(rows, maxLines);

		var wrapper1 = createTiddlyElement(null, "fieldset", null, "fieldsetFix");
		var wrapper2 = createTiddlyElement(wrapper1, "div");
		e = createTiddlyElement(wrapper2, "textarea");
		e.value = value;
		e.setAttribute("rows", rows);
		e.setAttribute("edit", field);
		place.appendChild(wrapper1);
	}
	if(tiddler.isReadOnly()) {
		e.setAttribute("readOnly", "readOnly");
		jQuery(e).addClass("readOnly");
	}
	return e;
};

config.macros.tagChooser.onClick = function(ev) {
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));

	for(var i = 0; i < tags.length; i++) {
		var tag = createTiddlyButton(createTiddlyElement(popup, "li"), tags[i][0],
			lingo.tagTooltip.format([tags[i][0]]), config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag", tags[i][0]);
		tag.setAttribute("tiddler", this.getAttribute("tiddler"));
	}
	if(tags.length == 0) jQuery("<li/>").addClass('disabled').text(lingo.popupNone).appendTo(popup);

	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev) {
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly) story.setTiddlerTag(title, tag, 0);
	return false;
};

config.macros.tagChooser.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler)) return;
	var lingo = config.views.editor.tagChooser;
	createTiddlyButton(place, lingo.text, lingo.tooltip, this.onClick, null, null, null, {
		tiddler: tiddler.title,
		tags: params[0]
	});
};

config.macros.refreshDisplay.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.refreshDisplay.onClick = function(e) {
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = tiddler ? tiddler.title : null;
	var annotation = title ? config.annotations[title] : null;
	if(!tiddler || !title || !annotation) return;
	var text = annotation.format([title]);
	wikify(text, createTiddlyElement(place, "div", null, "annotation"), null, tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(
	place, title, params, label, prompt, accessKey, newFocus, isJournal
) {
	label = getParam(params, "label", label);
	prompt = getParam(params, "prompt", prompt);
	accessKey = getParam(params, "accessKey", accessKey);
	var customFields = getParam(params, "fields", "");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var tags = [];
	for(var i = 1; i < params.length; i++) {
		if((params[i].name == "anon" && i != 1) || (params[i].name == "tag"))
			tags.push(params[i].value);
	}
	var text = getParam(params, "text");

	var btn = createTiddlyButton(place, label, prompt, this.onClickNewTiddler, null, null, accessKey, {
		newTitle: title,
		isJournal: isJournal ? "true" : "false",
		newFocus: getParam(params, "focus", newFocus),
		newTemplate: getParam(params, "template", DEFAULT_EDIT_TEMPLATE)
	});
	if(tags.length > 0)
		btn.setAttribute("params", tags.join("|"));
	if(customFields !== "")
		btn.setAttribute("customFields", customFields);
	if(text !== undefined)
		btn.setAttribute("newText", text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function() {
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);

	story.displayTiddler(this, title, template, false, null, null); // #161
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem, customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title, "text"))
		story.getTiddlerField(title, "text").value = text.format([title]);
	for(var i = 0; i < tags.length; i++)
		story.setTiddlerTag(title, tags[i], +1);
	story.focusTiddler(title, focus);
	return false;
};

config.macros.newTiddler.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
	title = getParam(params, "title", title);
	this.createNewTiddlerButton(place, title, params, this.label, this.prompt, this.accessKey, "title", false);
};

config.macros.newJournal.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
	title = getParam(params, "title", title);
	config.macros.newTiddler.createNewTiddlerButton(place, title,
		params, this.label, this.prompt, this.accessKey, "text", true);
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, false, false, false);
	createTiddlyButton(place, this.label, this.prompt, this.onClick, "button searchButton");

	var attributes = {
		size: this.sizeTextbox,
		accessKey: getParam(params, "accesskey", this.accessKey),
		autocomplete: "off",
		lastSearchText: "",
		placeholder: getParam(params, "placeholder", this.placeholder)
	};
	if(config.browser.isSafari) {
		attributes.type = "search";
		attributes.results = "5";
	} else {
		attributes.type = "text";
	}

	var input = createTiddlyElement(place, "input", null, "txtOptionInput searchField", null, attributes);
	input.value = getParam(params, "anon", "");
	input.onkeyup = this.onKeyPress;
	input.onfocus = this.onFocus;
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(input) {
	if(input.value.length == 0) return;
	story.search(input.value, config.options.chkCaseSensitiveSearch, config.options.chkRegExpSearch);
	input.setAttribute("lastSearchText", input.value);
};

config.macros.search.onClick = function(e) {
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev) {
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) clearTimeout(me.timeout);
				var input = this;
				me.timeout = setTimeout(function() { me.doSearch(input) }, 500);
			}
		} else {
			if(me.timeout) clearTimeout(me.timeout);
		}
	}
};

config.macros.search.onFocus = function(e) {
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place, macroName, params) {
	var cookie = params[0];
	var numTabs = (params.length - 1) / 3;
	var wrapper = createTiddlyElement(null, "div", null, "tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper, "div", null, "tabset");
	tabset.setAttribute("cookie", cookie);
	var validTab = false;
	for(var i = 0; i < numTabs; i++) {
		var label = params[i * 3 + 1];
		var prompt = params[i * 3 + 2];
		var content = params[i * 3 + 3];
		var tab = createTiddlyButton(tabset, label, prompt, this.onClickTab, "tab tabUnselected");
		createTiddlyElement(tab, "span", null, null, " ", { style: "font-size:0pt;line-height:0px" });
		tab.setAttribute("tab", label);
		tab.setAttribute("content", content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset, config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e) {
	config.macros.tabs.switchTab(this.parentNode, this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset, tab) {
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var i = 0; i < nodes.length; i++) {
		if(nodes[i].getAttribute && nodes[i].getAttribute("tab") == tab) {
			theTab = nodes[i];
			theTab.className = "tab tabSelected";
		} else {
			nodes[i].className = "tab tabUnselected";
		}
	}
	if(!theTab) return;

	if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
		jQuery(tabset.nextSibling).remove();
	var tabContent = createTiddlyElement(null, "div", null, "tabContents");
	tabset.parentNode.insertBefore(tabContent, tabset.nextSibling);
	var contentTitle = theTab.getAttribute("content");
	wikify(store.getTiddlerText(contentTitle), tabContent, null, store.getTiddler(contentTitle));
	if(cookie) {
		config.options[cookie] = tab;
		saveOption(cookie);
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place, commandName, tiddler, className) {
	if(!(tiddler instanceof Tiddler)) return;
	if(typeof commandName != "string") {
		for(var name in config.commands) {
			if(config.commands[name] == commandName)
				commandName = name;
		}
	}
	if(typeof commandName != "string") return;
	var command = config.commands[commandName];
	if(command.isEnabled ? !command.isEnabled(tiddler) : !this.isCommandEnabled(command, tiddler))
		return;

	var text = command.getText ? command.getText(tiddler) : this.getCommandText(command, tiddler);
	var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command, tiddler);
	var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
	var btn = createTiddlyButton(place, text, tooltip, cmd, "button command_" + commandName, null, null, {
		commandName: commandName,
		tiddler: tiddler.title
	});
	if(className) jQuery(btn).addClass(className);
	if(commandName === 'permalink') {
		jQuery(btn).attr('href', config.commands.permalink.getUrl(tiddler.title));
	}
};

config.macros.toolbar.isCommandEnabled = function(command, tiddler) {
	var title = tiddler.title;
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	if(shadow && command.hideShadow) return false;
	var ro = tiddler.isReadOnly();
	return !ro || (ro && !command.hideReadOnly);
};

config.macros.toolbar.getCommandText = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e, this, this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var title = this.getAttribute("tiddler");
	popup.setAttribute("tiddler", title);
	var command = config.commands[this.getAttribute("commandName")];
	command.handlePopup(popup, title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place, className, event) {
	var children = place.getElementsByTagName("a");
	for(var i = 0; i < children.length; i++) {
		var c = children[i];
		if(jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c, event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev) {
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev) {
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	for(var i = 0; i < params.length; i++) {
		var commandName = params[i];
		switch(commandName) {
			case "!":
				createTiddlyText(place, this.separator);
				break;
			case "*":
				createTiddlyElement(place, "br");
				break;
			case "<":
				createTiddlyButton(place, this.lessLabel, this.lessPrompt,
					config.macros.toolbar.onClickLess, "button lessCommand");
				break;
			case ">":
				createTiddlyButton(place, this.moreLabel, this.morePrompt,
					config.macros.toolbar.onClickMore, "button moreCommand");
				place = createTiddlyElement(place, "span", null, "moreCommand");
				place.style.display = "none";
				break;
			default:
				var className = "";
				switch(commandName.substring(0, 1)) {
					case "+":
						className = "defaultCommand";
						commandName = commandName.substring(1);
						break;
					case "-":
						className = "cancelCommand";
						commandName = commandName.substring(1);
						break;
				}
				if(config.commands[commandName]) {
					this.createCommand(place, commandName, tiddler, className);
				} else {
					this.customCommand(place, commandName, wikifier, tiddler);
				}
				break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place, command, wikifier, tiddler) {
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event, src, title) {
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.closeTiddler(title, true);
	return false;
};

config.commands.closeOthers.handler = function(event, src, title) {
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event, src, title) {
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, fields);

	var editorElement = story.getTiddlerField(title, config.options.txtEditorFocus || "text");
	if(editorElement) setCaretPosition(editorElement, 0);
	return false;
};

config.commands.saveTiddler.handler = function(event, src, title) {
	var newTitle = story.saveTiddler(title, event.shiftKey);
	if(newTitle) story.displayTiddler(null, newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event, src, title) {
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.displayTiddler(null, title);
	return false;
};

config.commands.deleteTiddler.handler = function(event, src, title) {
	var deleteIt = true;
	if(config.options.chkConfirmDelete) deleteIt = confirm(this.warning.format([title]));
	if(!deleteIt) return false;

	store.removeTiddler(title);
	story.closeTiddler(title, true);
	autoSaveChanges();
	return false;
};

config.commands.permalink.getUrl = function(title) {
	var hash = story.getPermaViewHash([title]);
	return window.location.href.replace(/#.*/, '') + hash;
};
config.commands.permalink.handler = function(event, src, title) {
	var hash = story.getPermaViewHash([title]);
	if(window.location.hash != hash) window.location.hash = hash;
	return false;
};

config.commands.references.handlePopup = function(popup, title) {
	var references = store.getReferringTiddlers(title);
	var hasRefs = false;
	for(var i = 0; i < references.length; i++) {
		if(references[i].title != title && !references[i].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup, "li"), references[i].title, true);
			hasRefs = true;
		}
	}
	if(!hasRefs) createTiddlyElement(popup, "li", null, "disabled", this.popupNone);
};

config.commands.jump.handlePopup = function(popup, title) {
	story.forEachTiddler(function(title, element) {
		createTiddlyLink(createTiddlyElement(popup, "li"), title, true, null, false, null, true);
	});
};

config.commands.fields.handlePopup = function(popup, title) {
	var tiddler = store.fetchTiddler(title);
	if(!tiddler) return;
	var items = [];
	store.forEachField(tiddler, function(tiddler, fieldName, value) {
		items.push({ field: fieldName, value: value });
	}, true);
	items.sort(function(a, b) { return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1) });

	if(items.length > 0) {
		ListView.create(popup, items, this.listViewTemplate);
	} else {
		createTiddlyElement(popup, "li", null, "disabled", this.emptyText);
	}
};

//--
//-- Tiddler() object
//--

function Tiddler(title) {
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function() {
	if(this.linksUpdated == false) this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function() {
	var f = {};
	for(var i in this.fields) {
		if(i == "server.host" || i == "server.workspace" || i == "wikiformat" || i == "server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function() {
	var c = this.fields['changecount'];
	c = c ? parseInt(c, 10) : 0;
	this.fields['changecount'] = String(c + 1);
};

Tiddler.prototype.clearChangeCount = function() {
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function() {
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function() {
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title, text, modifier, modified, tags, created, fields, creator) {
	this.assign(title, text, modifier, modified, tags, created, fields, creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title, text, modifier, modified, tags, created, fields, creator) {
	if(title != undefined) this.title = title;
	if(text != undefined) this.text = text;
	if(modifier != undefined) this.modifier = modifier;
	if(modified != undefined) this.modified = modified;
	if(creator != undefined) this.creator = creator;
	if(created != undefined) this.created = created;
	if(fields != undefined) this.fields = fields;
	if(tags != undefined) this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined) this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function() {
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag) {
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text) {
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function() {
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like .links array) after a change to a tiddler
Tiddler.prototype.changed = function() {
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g, "")
		.replace(/\{{3}((?:.|\n)*?)\}{3}/g, "")
		.replace(/"""((?:.|\n)*?)"""/g, "")
		.replace(/<nowiki\>((?:.|\n)*?)<\/nowiki\>/g, "")
		.replace(/<html\>((?:.|\n)*?)<\/html\>/g, "")
		.replace(/<script((?:.|\n)*?)<\/script\>/g, "");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t == 0 ?
		config.textPrimitives.tiddlerAnyLinkRegExp :
		config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t == 0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink + "|" +
					config.textPrimitives.anyLetter, "mg");
				preRegExp.lastIndex = formatMatch.index - 1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index - 1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2 - t] && !config.formatterHelpers.isExternalLink(formatMatch[3 - t]))
			// titledBrackettedLink
			this.links.pushUnique(formatMatch[3 - t]);
		else if(formatMatch[4 - t] && formatMatch[4 - t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4 - t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function() {
	var modifier = this.modifier || config.messages.subtitleUnknown || "";
	var modified = this.modified ?
		this.modified.toLocaleString() :
		config.messages.subtitleUnknown || "";
	var f = config.messages.tiddlerLinkTooltip || "%0 - %1, %2";
	return f.format([this.title, modifier, modified]);
};

Tiddler.prototype.isReadOnly = function() {
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function() {
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function() {
	var serverType = this.fields['server.type'] || this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType]) return null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function() {
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki(params) {
	var tiddlers = {}; // Hashmap by name of tiddlers
	if(params && params.config) {
		this.config = config;
	}
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var title in tiddlers) {
			var tiddler = tiddlers[title];
			if(tiddler instanceof Tiddler)
				callback.call(this, title, tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty) {
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function() {
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title) {
	return this.fetchTiddler(title) != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title) {
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.isAvailable = function(title) {
	if(!title) return false;
	var i = title.indexOf(config.textPrimitives.sectionSeparator);
	if(i != -1) title = title.substring(0, i);
	return this.tiddlerExists(title) || this.isShadowTiddler(title);
};

TiddlyWiki.prototype.createTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title) {
	return this.fetchTiddler(title) || null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title) {
	return (typeof config.shadowTiddlers[title] == "string")
		? config.shadowTiddlers[title]
		: "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title, defaultText) {
	if(!title) return defaultText;

	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0, pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var sliceNameStart = pos + config.textPrimitives.sliceSeparator.length;
		var slice = this.getTiddlerSlice(title.substr(0, pos), title.substr(sliceNameStart));
		if(slice) return slice;
	}

	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(!text) return defaultText != undefined ? defaultText : null;
	if(!section) return text;

	var headerRE = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)", "mg");
	headerRE.lastIndex = 0;
	var match = headerRE.exec(text);
	if(!match) return defaultText;

	var t = text.substr(match.index + match[1].length);
	var nextHeaderRE = /^!/mg;
	nextHeaderRE.lastIndex = 0;
	match = nextHeaderRE.exec(t);
	return !match ? t :
		// don't include final \n
		t.substr(0, match.index - 1);
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title, defaultText, depth) {
	var text = this.getTiddlerText(title, null);
	if(text == null) return defaultText;

	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])", "mg");
	var textOut = [], match, lastPos = 0;
	do {
		if(match = bracketRegExp.exec(text)) {
			textOut.push(text.substr(lastPos, match.index - lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1], "", depth - 1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|\x20?([\'\/]{0,2})~?([^\|\s\:\~\'\/]|(?:[^\|\s~\'\/][^\|\n\f\r]*[^\|\s\:\'\/]))\:?\4[\x20\t]*\|[\t\x20]*([^\n\t\x20](?:[^\n]*[^\n\t\x20])?)[\t\x20]*\|$)/gm; // #112
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title) {
	var text = this.getTiddlerText(title, "");
	this.slicesRE.lastIndex = 0;
	var slices = {}, m;
	while(m = this.slicesRE.exec(text)) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title, sliceName) {
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title, sliceNames) {
	var i, r = {};
	for(i = 0; i < sliceNames.length; i++) {
		var slice = this.getTiddlerSlice(title, sliceNames[i]);
		if(slice) r[sliceNames[i]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function() {
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function() {
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title, doBlanket) {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if((n.name == null && doBlanket) || (n.name == title))
			n.notify(title);
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function() {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if(n.name)
			n.notify(n.name);
	}
};

// Add a notification handler to a tiddler unless it's already set
TiddlyWiki.prototype.addNotification = function(title, fn) {
	for(var i = 0; i < this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({ name: title, notify: fn });
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title, true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title, true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title, status, tag) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	var t = tiddler.tags.indexOf(tag);
	if(t != -1)
		tiddler.tags.splice(t, 1);
	if(status)
		tiddler.tags.push(tag);

	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

TiddlyWiki.prototype.addTiddlerFields = function(title, fields) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	merge(tiddler.fields, fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(titleOrTiddler, newTitle, newBody,
	modifier, modified, tags, fields, clearChangeCount, created, creator) {
	var wasTiddlerProvided = titleOrTiddler instanceof Tiddler;
	var tiddler = this.resolveTiddler(titleOrTiddler);
	var title = tiddler ? tiddler.title : titleOrTiddler;
	newTitle = newTitle || title;

	if(tiddler) {
		this.deleteTiddler(title); //# clean up slices for title, make sure the tiddler is not copied when renamed
		created = created || tiddler.created; // Preserve created date
		creator = creator || tiddler.creator;
	} else {
		tiddler = new Tiddler();
		created = created || modified;
	}

	if(wasTiddlerProvided) {
		tiddler.fields = merge(merge({}, tiddler.fields), config.defaultCustomFields, true);
	} else {
		fields = merge(merge({}, fields), config.defaultCustomFields, true);
		tiddler.set(newTitle, newBody, modifier, modified, tags, created, fields, creator);
	}
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();

	this.addTiddler(tiddler); //# clean up slices for newTitle, add/return the tiddler
	if(title != newTitle) this.notify(title, true);
	this.notify(newTitle, true);
	this.setDirty(true);

	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function() {
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function() {
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function() {
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src, idPrefix, noUpdate) {
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem) return;

	this.idPrefix = idPrefix;
	var tiddlers = this.getLoader().loadTiddlers(this, storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0; i < tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text) {
	var posDiv = locateStoreArea(text);
	if(!posDiv) return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0], posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";

	// Create an iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6

	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();

	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea, "store");

	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function() {
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title, tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp, sortField, excludeTag, match) {
	var candidates = this.reverseLookup("tags", excludeTag, !!match);
	var i, results = [];
	for(i = 0; i < candidates.length; i++) {
		if((candidates[i].title.search(searchRegExp) != -1) || (candidates[i].text.search(searchRegExp) != -1))
			results.push(candidates[i]);
	}
	if(!sortField) sortField = "title";
	results.sort(function(a, b) { return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1) });
	return results;
};

// Returns a list of all tags in use (in the form of an array of [tagName, numberOfOccurances] "tuples")
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
TiddlyWiki.prototype.getTags = function(excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
	    var i, j;
		for(i = 0; i < tiddler.tags.length; i++) {
			var tag = tiddler.tags[i];
			var isTagToAdd = true;
			for(j = 0; j < results.length; j++) {
				if(results[j][0] == tag) {
					isTagToAdd = false;
					results[j][1]++;
				}
			}
			if(isTagToAdd && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					isTagToAdd = false;
			}
			if(isTagToAdd) results.push([tag, 1]);
		}
	});
	results.sort(function(a, b) {
		var tag1 = a[0].toLowerCase(), tag2 = b[0].toLowerCase();
		return tag1 < tag2 ? -1 : (tag1 == tag2 ? 0 : +1);
	});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag, sortField) {
	return this.reverseLookup("tags", tag, true, sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field, value, sortField) {
	return this.reverseLookup(field, value, true, sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title, unusedParameter, sortField) {
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links", title, true, sortField);
};

// Return an array of the tiddlers that have a specified entry (lookupValue) in the specified field (lookupField, like "links" or "tags")
// if shouldMatch == true, or don't have such entry (if shouldMatch == false)
TiddlyWiki.prototype.reverseLookup = function(lookupField, lookupValue, shouldMatch, sortField) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			var accessor = TiddlyWiki.standardFieldAccess[lookupField];
			values = accessor ? [ accessor.get(tiddler) ] :
				( tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [] );
		}

		var hasMatch = false;
		for(var i = 0; i < values.length; i++) {
			if(values[i] == lookupValue)
				hasMatch = true;
		}
		if(hasMatch == !!shouldMatch) results.push(tiddler);
	});
	return this.sortTiddlers(results, sortField || "title");
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field, excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field) results.sort(function(a, b) { return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1) });
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function() {
	if(!this.tiddlersUpdated) this.updateTiddlers();

	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;

		for(var i = 0; i < tiddler.links.length; i++) {
			var link = tiddler.links[i];
			if(this.getTiddlerText(link, null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function() {
	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function() {
	var t, results = [];
	for(t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function() {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
	});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler) {
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers, field) {
	var asc = +1;
	switch(field.substr(0, 1)) {
		case "-":
			asc = -1;
			field = field.substr(1);
			break;
		case "+":
			field = field.substr(1);
			break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field == "title") {
			tiddlers.sort(function(a, b) {
				var t1 = a[field].toLowerCase(), t2 = b[field].toLowerCase();
				return t1 < t2 ? -asc : (t1 == t2 ? 0 : asc);
			});
		} else {
			tiddlers.sort(function(a, b) {
				return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);
			});
		}
	} else {
		tiddlers.sort(function(a, b) {
			return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);
		});
	}
	return tiddlers;
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results, match) {
		var title = match[1] || match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title, this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results, match) {
		var i, matched = this.getTaggedTiddlers(match[3]);
		for(i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	},
	sort: function(results, match) {
		return this.sortTiddlers(results, match[3]);
	},
	limit: function(results, match) {
		return results.slice(0, parseInt(match[3], 10));
	},
	field: function(results, match) {
		var i, matched = this.getValueTiddlers(match[2], match[3]);
		for (i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter, results) {
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	results = results || [];
	if(filter) {
		var match;
		while(match = re.exec(filter)) {
			var handler = (match[1] || match[4]) ? 'tiddler' :
				config.filters[match[2]] ? match[2] : 'field';
			results = config.filters[handler].call(this, results, match);
		}
	}
	return results;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name) {
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name) {
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(fName, readOnly) {
	this.set = readOnly ?
		function(tiddler, newValue) {
			if(newValue != tiddler[fName]) throw config.messages.fieldCannotBeChanged.format([fName]);
		} :
		function(tiddler, newValue) {
			if(newValue == tiddler[fName]) return;
			tiddler[fName] = newValue;
			return true;
		};
	this.get = function(tiddler) { return tiddler[fName] };
}

function DateFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var d = newValue instanceof Date ? newValue : Date.convertFromYYYYMMDDHHMM(newValue);
		if(d == tiddler[fName]) return;
		tiddler[fName] = d;
		return true;
	};
	this.get = function(tiddler) { return tiddler[fName].convertToYYYYMMDDHHMM() };
}

function LinksFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var items = (typeof newValue == "string") ? newValue.readBracketedList() : newValue;
		if(items.toString() == tiddler[fName].toString()) return;
		tiddler[fName] = items;
		return true;
	};
	this.get = function(tiddler) { return String.encodeTiddlyLinkList(tiddler[fName]) };
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title", true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title", true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name) {
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddlerOrTitle, fieldName, value) {
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return;

	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		// don't remove StandardFields
		if(isRemove) return;
		if(!accessor.set(t, value)) return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^" + fieldName + "\\.");
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty) return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience convert Date -> String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value) return;
			t.fields[fieldName] = value;
		}
	}

	// When we are here the tiddler/store really was changed.
	this.notify(t.title, true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddlerOrTitle, fieldName) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	if(fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 ||
	   fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0
	) {
		var separator = fieldName.substr(0, 2);
		var partName = fieldName.substring(2);
		return store.getTiddlerText(t.title + separator + partName);
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = TiddlyWiki.standardFieldAccess[fieldName];
		if(accessor) return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler, fieldName, value).
TiddlyWiki.prototype.forEachField = function(tiddlerOrTitle, callback, onlyExtendedFields) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	var name, result;
	for(name in t.fields) {
		result = callback(t, name, t.fields[name]);
		if(result) return result;
	}

	if(onlyExtendedFields) return undefined;
	for(name in TiddlyWiki.standardFieldAccess) {
		// even though the "title" field can also be referenced through the name "tiddler"
		// we only visit this field once.
		if(name == "tiddler") continue;

		result = callback(t, name, TiddlyWiki.standardFieldAccess[name].get(t));
		if(result) return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

// A story is a HTML div containing a sequence of tiddlers that can be manipulated
//  container - id of containing element
//  idPrefix - string prefix prepended to title to make ids for tiddlers in this story
function Story(containerId, idPrefix) {
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		var validId = title.replace(/_/g, "__").replace(/ /g, "_");
		var id = this.idPrefix + validId;
		return id == this.container ? this.idPrefix + "_" + validId : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title) {
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function() {
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(handleTiddler) {
	var place = this.getContainer();
	if(!place) return;
	var el = place.firstChild;
	while(el) {
		var next = el.nextSibling;
		var title = el.getAttribute("tiddler");
		if(title) {
			handleTiddler.call(this, title, el);
		}
		el = next;
	}
};

Story.prototype.displayTiddler = function(srcElement, tiddler,
	template, animate, unused, customFields, toggle, animationSrc) {
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title, true);
		} else {
			this.refreshTiddler(title, template, false, customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place, before, title, template, customFields);
	}

	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim &&
		   typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title, srcElement, tiddlerElem), new Scroller(tiddlerElem));
		else
			window.scrollTo(0, ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.displayTiddlers = function(srcElement, titles, template, animate, unused, customFields, toggle) {
	for(var i = titles.length - 1; i >= 0; i--)
		this.displayTiddler(srcElement, titles[i], template, animate, unused, customFields);
};

Story.prototype.displayDefaultTiddlers = function() {
	this.displayTiddlers(null, store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.positionTiddler = function(srcElement) {
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place, before, title, template, customFields) {
	var tiddlerElem = createTiddlyElement(null, "div", this.tiddlerId(title), "tiddler");
	tiddlerElem.setAttribute("refresh", "tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields", customFields);
	place.insertBefore(tiddlerElem, before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title, customFields);
	this.refreshTiddler(title, template, false, customFields, defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title, fields, callback) {
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields || {};
	var context = { serverType: tiddler.getServerType() };
	if(!context.serverType) return "";
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType]();

	var onLoadTiddlerResponse = function(context) {
		if(context.status) {
			var t = context.tiddler;
			t.created  = t.created  || new Date();
			t.modified = t.modified || t.created;
			var dirty = store.isDirty();
			context.tiddler = store.saveTiddler(t.title, t.title, t.text, t.modifier, t.modified,
				t.tags, t.fields, true, t.created, t.creator);
			if(!window.allowSave())
				store.setDirty(dirty);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title, null, true);
		}
		context.adaptor.close();
		if(callback) callback(context);
	};
	adaptor.getTiddler(title, context, null, onLoadTiddlerResponse);
	return config.messages.loadingMissingTiddler.format([title, context.serverType, context.host, context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title, template) {
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title, template, tiddler) {
	return store.getRecursiveTiddlerText(template, null, 10);
};

Story.prototype.refreshTiddler = function(title, template, force, customFields, defaultText) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	if(tiddlerElem.getAttribute("dirty") == "true" && !force)
		return tiddlerElem;
	template = this.chooseTemplateForTiddler(title, template);
	var currTemplate = tiddlerElem.getAttribute("template");
	if((template == currTemplate) && !force)
		return tiddlerElem;

	var tiddler = store.getTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler();
		if(store.isShadowTiddler(title)) {
			var tags = [];
			tiddler.set(title, store.getTiddlerText(title),
				config.views.wikified.shadowModifier, version.date, tags, version.date);
		} else {
			var text = template == config.tiddlerTemplates[DEFAULT_EDIT_TEMPLATE] // #166
				? config.views.editor.defaultText.format([title])
				: config.views.wikified.defaultText.format([title]);
			text = defaultText || text;
			var fields = customFields ? customFields.decodeHashMap() : null;
			tiddler.set(title, text, config.views.wikified.defaultModifier, version.date, [], version.date, fields);
		}
	}

	tiddlerElem.setAttribute("tags", tiddler.tags.join(" "));
	tiddlerElem.setAttribute("tiddler", title);
	tiddlerElem.setAttribute("template", template);
	tiddlerElem.onmouseover = this.onTiddlerMouseOver;
	tiddlerElem.onmouseout = this.onTiddlerMouseOut;
	tiddlerElem.ondblclick = this.onTiddlerDblClick;
	tiddlerElem[window.event ? "onkeydown" : "onkeypress"] = this.onTiddlerKeyPress;
	tiddlerElem.innerHTML = this.getTemplateForTiddler(title, template, tiddler);
	applyHtmlMacros(tiddlerElem, tiddler);
	if(store.getTaggedTiddlers(title).length > 0)
		jQuery(tiddlerElem).addClass("isTag");
	else
		jQuery(tiddlerElem).removeClass("isTag");
	if(store.tiddlerExists(title)) {
		jQuery(tiddlerElem).removeClass("shadow");
		jQuery(tiddlerElem).removeClass("missing");
	} else {
		jQuery(tiddlerElem).addClass(store.isShadowTiddler(title) ? "shadow" : "missing");
	}
	if(customFields)
		this.addCustomFields(tiddlerElem, customFields);

	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place, customFields) {
	var fields = customFields.decodeHashMap();
	var container = createTiddlyElement(place, "div", null, "customFields");
	container.style.display = "none";
	for(var fieldName in fields) {
		var input = document.createElement("input");
		input.setAttribute("type", "text");
		input.setAttribute("value", fields[fieldName]);
		container.appendChild(input);
		input.setAttribute("edit", fieldName);
	}
};

Story.prototype.refreshAllTiddlers = function(force) {
	this.forEachTiddler(function(title, element) {
		var template = element.getAttribute("template");
		if(template && element.getAttribute("dirty") != "true") {
			this.refreshTiddler(title, force ? null : template, true);
		}
	});
};

Story.prototype.onTiddlerMouseOver = function() {
	jQuery(this).addClass("selected");
};

Story.prototype.onTiddlerMouseOut = function() {
	jQuery(this).removeClass("selected");
};

Story.prototype.onTiddlerDblClick = function(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(!target || target.nodeName.toLowerCase() == "input" || target.nodeName.toLowerCase() == "textarea")
		return false;
	if(document.selection && document.selection.empty)
		document.selection.empty();
	config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return true;
};

Story.prototype.onTiddlerKeyPress = function(ev) {
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			var editor = story.getTiddlerField(title, "text");
			if(target.tagName.toLowerCase() == "input"
			   && editor.value == config.views.editor.defaultText.format([title])) {
				// moving from input field and editor still contains default text, so select it
				editor.focus();
				editor.select();
				consume = true;
			}
			if(config.options.chkInsertTabs && !e.ctrlKey && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target, String.fromCharCode(9));
				consume = true;
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
				consume = true;
			}
			break;
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this, "cancelCommand", e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title, field) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var $editors = jQuery(tiddlerElem).find('input, textarea');
	return $editors.filter('[edit="' + field + '"]')[0] || $editors[0] || null;
};

Story.prototype.focusTiddler = function(title, field) {
	var e = this.getTiddlerField(title, field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title, tag, mode, field) {
	var editor = this.getTiddlerField(title, field);
	var tags = editor.value.readBracketedList();

	var i = tags.indexOf(tag);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) tags.push(tag);
	} else if(mode == -1) {
		if(i != -1) tags.splice(i, 1);
	}

	editor.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title, tag, mode) {
	this.setTiddlerField(title, tag, mode, "tags");
};

Story.prototype.closeTiddler = function(title, shouldAnimate, unused) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return;

	clearMessage();
	this.scrubTiddler(tiddlerElem);
	if(config.options.chkAnimate && shouldAnimate && anim && typeof Slider == "function") {
		anim.startAnimating(new Slider(tiddlerElem, false, null, "all"));
	} else {
		jQuery(tiddlerElem).remove();
	}
};

Story.prototype.scrubTiddler = function(tiddlerElement) {
	tiddlerElement.id = null;
};

// 'dirty' flag attribute is used on tiddlers to mark those having unsaved changes

Story.prototype.setDirty = function(title, dirty) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty", dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;
	return tiddlerElem.getAttribute("dirty") == "true";
};

Story.prototype.areAnyDirty = function() {
	var r = false;
	this.forEachTiddler(function(title, element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude) {
	clearMessage();
	this.forEachTiddler(function(title, element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0, ensureVisible(this.container));
};

Story.prototype.isEmpty = function() {
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text, useCaseSensitive, useRegExp) {
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(), useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack, "title", "excludeSearch");
	this.displayTiddlers(null, matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(), q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(el) {
	while(el && !jQuery(el).hasClass("tiddler")) {
		el = jQuery(el).hasClass("popup") && Popup.stack[0] ? Popup.stack[0].root
			: el.parentNode;
	}
	return el;
};

Story.prototype.gatherSaveFields = function(el, fields) {
	if(!el || !el.getAttribute) return;
	var fieldName = el.getAttribute("edit");
	if(fieldName)
		fields[fieldName] = el.value.replace(/\r/mg, "");
	if(el.hasChildNodes()) {
		for(var i = 0; i < el.childNodes.length; i++)
			this.gatherSaveFields(el.childNodes[i], fields);
	}
};

Story.prototype.hasChanges = function(title) {
	var tiddlerElement = this.getTiddler(title);
	if(!tiddlerElement) return false;

	var fields = {};
	this.gatherSaveFields(tiddlerElement, fields);
	if(store.fetchTiddler(title)) {
		for(var fieldName in fields) {
			if(store.getValue(title, fieldName) != fields[fieldName])
				return true;
		}
		return false;
	}
	if(store.isShadowTiddler(title)) {
		// not checking for title or tags
		return store.getShadowTiddlerText(title) != fields.text;
	}
	// new tiddler
	return true;
};

Story.prototype.saveTiddler = function(title, minorUpdate) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var fields = {};
	this.gatherSaveFields(tiddlerElem, fields);
	var newTitle = fields.title || title;
	if(!store.tiddlerExists(newTitle)) {
		newTitle = newTitle.trim();
		var creator = config.options.txtUserName;
	}
	if(store.tiddlerExists(newTitle) && newTitle != title) {
		if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
			return null;
	}
	if(newTitle != title)
		this.closeTiddler(newTitle, false);
	tiddlerElem.id = this.tiddlerId(newTitle);
	tiddlerElem.setAttribute("tiddler", newTitle);
	tiddlerElem.setAttribute("template", DEFAULT_VIEW_TEMPLATE);
	tiddlerElem.setAttribute("dirty", "false");
	if(config.options.chkForceMinorUpdate)
		minorUpdate = !minorUpdate;
	if(!store.tiddlerExists(newTitle))
		minorUpdate = false;
	if(store.tiddlerExists(title)) {
		var t = store.fetchTiddler(title);
		var extendedFields = t.fields;
		creator = t.creator;
	} else {
		extendedFields = merge({}, config.defaultCustomFields);
	}
	for(var n in fields) {
		if(!TiddlyWiki.isStandardField(n))
			extendedFields[n] = fields[n];
	}
	var tiddler = store.saveTiddler(title, newTitle, fields.text, minorUpdate ? undefined : config.options.txtUserName,
		minorUpdate ? undefined : new Date(), fields.tags, extendedFields, null, null, creator);
	autoSaveChanges(null, [tiddler]);
	return newTitle;
};

Story.prototype.getPermaViewHash = function(titles) {
	return '#' + encodeURIComponent(String.encodeTiddlyLinkList(titles));
};

Story.prototype.permaView = function() {
	var titles = [];
	this.forEachTiddler(function(title, element) {
		titles.push(title);
	});
	var hash = this.getPermaViewHash(titles);
	if(window.location.hash != hash)
		window.location.hash = hash;
};

Story.prototype.switchTheme = function(theme) {
	if(safeMode) return;

	var getSlice = function(theme, slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme, slice + "ReadOnly") || store.getTiddlerSlice(theme, "Web" + slice);
		r = r || store.getTiddlerSlice(theme, slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator) == 0)
			r = theme + r;
		return store.isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i, name, theme, slice) {
		var newName = getSlice(theme, slice);
		if(name != newName && store.namedNotifications[i].name == name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i = 0; i < config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
			case "PageTemplate":
				config.refresherData.pageTemplate = replaceNotification(i, config.refresherData.pageTemplate, theme, name);
				break;
			case "StyleSheet":
				removeStyleSheet(config.refresherData.styleSheet);
				config.refresherData.styleSheet = replaceNotification(i, config.refresherData.styleSheet, theme, name);
				break;
			case "ColorPalette":
				config.refresherData.colorPalette = replaceNotification(i, config.refresherData.colorPalette, theme, name);
				break;
			default:
				break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme, "ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme, "EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate != pt || config.tiddlerTemplates[vi] != vt
		   || config.tiddlerTemplates[ei] != et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet, "", 10),
				config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};

//--
//-- Backstage
//--
// Backstage tasks
config.tasks.save.action = saveChanges;

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var text = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button, text, cmb.open.tooltip,
			function(e) { backstage.show(); return false }, null, "backstageShow");
		text = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button, text, cmb.close.tooltip,
			function(e) { backstage.hide(); return false }, null, "backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel, "div", null, "backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel, "div", null, "backstagePanelBody");
		this.cloak.onmousedown = function(e) { backstage.switchTab(null) };
		createTiddlyText(this.toolbar, cmb.prompt);
		for(var i = 0; i < config.backstageTasks.length; i++) {
			var taskName = config.backstageTasks[i];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar, text, task.tooltip, handler, "backstageTab");
			jQuery(btn).addClass(task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
		}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: findWindowWidth(), end: 0, template: "%0px" }
			]));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		jQuery(this.content).addClass("backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			// close current tab, not backstage
			this.switchTab(null);
			return;
		}

		backstage.toolbar.style.left = "0px";
		var hide = function() { backstage.area.style.display = "none" };
		if(anim && config.options.chkAnimate) {
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: 0, end: findWindowWidth(), template: "%0px" }
			], hide));
		} else {
			hide();
		}
		this.showButton.style.display = "block";
		this.hideButton.style.display = "none";
		config.options.chkBackstage = false;
		saveOption("chkBackstage");
		jQuery(this.content).removeClass("backstageVisible");
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e) {
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
		}
		if(tabName == this.currTabName) {
			this.hidePanel();
			return;
		}
		if(this.currTabElem) {
			jQuery(this.currTabElem).removeClass("backstageSelTab");
		}
		if(tabElem && tabName) {
			this.preparePanel();
			jQuery(tabElem).addClass("backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content, this.panelBody, null, null);
			this.showPanel();
		} else if(this.currTabElem) {
			this.hidePanel();
		}
		this.currTabName = tabName;
		this.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findDocHeight() + "px";
		backstage.cloak.style.display = "block";
		jQuery(backstage.panelBody).empty();
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px" }
			]), new Scroller(backstage.panel, false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			jQuery(backstage.currTabElem).removeClass("backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var callback = function() { backstage.cloak.style.display = "none" };
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px" },
				{ style: "display", atEnd: "none" }
			], callback));
		} else {
			jQuery([backstage.panel, backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place, macroName, params) {
	var backstageTask = config.tasks[params[0]];
	if(!backstageTask) return;
	createTiddlyButton(place, backstageTask.text, backstageTask.tooltip, function(e) {
		backstage.switchTab(params[0]);
		return false;
	});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(readOnly) {
		createTiddlyElement(place, "div", null, "marked", this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e) {
	var wizard = new Wizard(this);
	wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e) {
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard) {
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title, this.step1Html);

	var name, s = wizard.getElement("selTypes");
	for(name in config.adaptors) {
		var e = createTiddlyElement(s, "option", null, null, config.adaptors[name].serverLabel || name);
		e.value = name;
	}
	if(config.defaultAdaptor) s.value = config.defaultAdaptor;

	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(name in feeds) {
		e = createTiddlyElement(s, "option", null, null, name);
		e.value = name;
	}
	wizard.setValue("feeds", feeds);
	s.onchange = me.onFeedChange;

	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{ caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen }]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function() {
	var feeds = {};
	var i, tagged = store.getTaggedTiddlers("systemServer", "title");
	for(i = 0; i < tagged.length; i++) {
		var title = tagged[i].title;
		feeds[title] = {
			title: title,
			url: store.getTiddlerSlice(title, "URL"),
			workspace: store.getTiddlerSlice(title, "Workspace"),
			workspaceList: store.getTiddlerSlice(title, "WorkspaceList"),
			tiddlerFilter: store.getTiddlerSlice(title, "TiddlerFilter"),
			serverType: store.getTiddlerSlice(title, "Type") || "file",
			description: store.getTiddlerSlice(title, "Description")
		};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e) {
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName", f.serverType);
		wizard.setValue("feedHost", f.url);
		wizard.setValue("feedWorkspace", f.workspace);
		wizard.setValue("feedWorkspaceList", f.workspaceList);
		wizard.setValue("feedTiddlerFilter", f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e) {
	var wizard = new Wizard(this);
	var file = this.value;
	file = file.replace(/^C:\\fakepath\\/i, ''); // remove fakepath (chrome/opera/safari)
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
			file = this.files[0].fileName; // REQUIRES PRIVILEGES.. NULL otherwise
		} catch (ex) {
			// non-priv fallback: combine filename with path to current document
			var path = tw.io.getOriginalLocalPath();
			var slashpos = path.lastIndexOf('/');
			if (slashpos == -1) slashpos = path.lastIndexOf('\\');
			if (slashpos != -1) path = path.substr(0, slashpos + 1); // remove filename, leave trailing slash
			file = path + file;
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(file);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(path) {
	if(!path) return path;
	// use "/" for cross-platform consistency
	path = path.replace(/\\/g, "/");

	var t = path.split(":");
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		// input is already a URL
		return path;
	}

	var p = t[1] || t[0]; // remove drive letter (if any)
	if(p.substr(0, 1) == "/") {
		// path is absolute, add protocol + domain + extra slash (if drive letter)
		return document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + path;
	}

	// path is relative, add current document protocol + domain + path
	var c = document.location.href.replace(/\\/g, "/");
	var pos = c.lastIndexOf("/");
	if(pos != -1)
		c = c.substring(0, pos); // remove filename
	return c + "/" + p;
};

config.macros.importTiddlers.onOpen = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor", adaptor);
	wizard.setValue("serverType", serverType);
	wizard.setValue("host", url);
	adaptor.openHost(url, null, wizard, me.onOpenHost);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context, wizard) {
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	adaptor.getWorkspaceList(context, wizard, me.onGetWorkspaceList);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context", context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length == 1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		context.adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
		wizard.setValue("workspace", workspace);
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title, me.step2Html);
	var i, s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(i = 0; i < context.workspaces.length; i++) {
		var e = createTiddlyElement(s, "option", null, null, context.workspaces[i].title);
		e.value = context.workspaces[i].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace", null, false, true);
		for(i = 1; i < list.length; i++) {
			if(context.workspaces.findByField("title", list[i].value) == null) {
				e = createTiddlyElement(s, "option", null, null, list[i].value);
				e.value = list[i].value;
			}
		}
	}
	if(workspace) {
		wizard.getElement("txtWorkspace").value = workspace;
	}
	wizard.setButtons([{ caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace }]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e) {
	var wizard = new Wizard(this);
	wizard.getElement("txtWorkspace").value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace", workspace);
	var context = wizard.getValue("context");
	adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var browse = wizard.getElement("txtBrowse");
	if (browse.files) context.file = browse.files[0]; // for HTML5 FileReader
	adaptor.getTiddlerList(context, wizard, me.onGetTiddlerList, wizard.getValue("feedTiddlerFilter"));
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		var error = context.statusText || me.errorGettingTiddlerList;
		if(context.host.indexOf("file://") === 0) {
			error = me.errorGettingTiddlerListFile;
		} else {
			error = context.xhr && context.xhr.status == 404 ? me.errorGettingTiddlerListHttp404 :
				me.errorGettingTiddlerListHttp;
		}
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], "");
		jQuery("span.status", wizard.footerEl).html(error); // so error message can be html
		return;
	}

	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var i = 0; i < context.tiddlers.length; i++) {
			var tiddler = context.tiddlers[i];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text, 100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1) });

	// Display the listview
	wizard.addStep(me.step3Title, me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	var listView = ListView.create(listWrapper, listedTiddlers, me.listViewTemplate);
	wizard.setValue("listView", listView);
	wizard.setValue("context", context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel },
		{ caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport }
	]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard) {
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType, host, workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard) {
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType, host, workspace]);
	store.saveTiddler(txtSaveTiddler, txtSaveTiddler, text, me.serverSaveModifier, new Date(), ["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync", chkSync);

	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	for(var i = 0; i < rowNames.length; i++) {
		if(store.tiddlerExists(rowNames[i]))
			overwrite.push(rowNames[i]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}

	wizard.addStep(me.step4Title.format([rowNames.length]), me.step4Html);
	for(i = 0; i < rowNames.length; i++) {
		var linkHolder = document.createElement("div");
		createTiddlyLink(linkHolder, rowNames[i], true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(linkHolder, place);
	}
	wizard.setValue("remainingImports", rowNames.length);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	], me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(i = 0; i < rowNames.length; i++) {
		var context = {
			allowSynchronous: true,
			tiddler: tiddlers[tiddlers.findByField("title", rowNames[i])]
		};
		adaptor.getTiddler(rowNames[i], context, wizard, me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context, wizard) {
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier,
		tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title, 'server', null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous) store.notify(tiddler.title, true);

	var remainingImports = wizard.getValue("remainingImports") - 1;
	wizard.setValue("remainingImports", remainingImports);

	if(remainingImports != 0) return;
	if(context.isSynchronous) {
		store.notifyAll();
		refreshDisplay();
	}
	var me = config.macros.importTiddlers;
	wizard.setButtons([
		{ caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose }
	], me.statusDoneImport);
	autoSaveChanges();
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.docsUrl = 'https://classic.tiddlywiki.com/#HowToUpgrade';

config.macros.upgrade.getSourceURL = function() {
	return config.options.txtUpgradeCoreURI || config.macros.upgrade.source;
};

config.macros.upgrade.loadLatestCore = function(onSuccess, onError) {
	ajaxReq({
		type: "GET",
		url: this.getSourceURL(),
		processData: false,
		success: onSuccess,
		error: onError
	});
};

config.macros.upgrade.handler = function(place) {
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	w.addStep(this.step1Title, this.step1Html.format([
		this.getSourceURL(),
		this.getSourceURL().replace(/^https:\/\//, ''),
		this.docsUrl
	]));
	w.setButtons([{
		caption: this.upgradeLabel,
		tooltip: this.upgradePrompt,
		onClick: this.onClickUpgrade
	}]);
};

config.macros.upgrade.onClickUpgrade = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(!window.allowSave()) {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}

	w.setButtons([], me.statusPreparingBackup);
	var localPath = tw.io.getOriginalLocalPath();
	var backupPath = getBackupPath(localPath, me.backupExtension);
	var original = loadOriginal(localPath);

	w.setButtons([], me.statusSavingBackup);
	var backupSuccessOrPending = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(!backupSuccessOrPending) {
		w.setButtons([], me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}

	// make sure both the backup is saved and tw.io.loadFile works before proceeding
	tw.io.loadFile(backupPath, function(backupContent) {
		if(!backupContent) {
			w.setButtons([], me.errorVerifyingBackup.format([me.docsUrl]));
			return;
		}

		w.setValue("backupPath", backupPath);

		w.setButtons([], me.statusLoadingCore);
		var sourceURL = me.getSourceURL();
		me.loadLatestCore(function(data, textStatus, jqXHR) {
			me.onLoadCore(true, w, jqXHR.responseText, sourceURL, jqXHR);
		}, function(jqXHR, textStatus, errorThrown) {
			me.onLoadCore(false, w, null, sourceURL, jqXHR);
		});
	});

	return false;
};

config.macros.upgrade.onLoadCore = function(status, w, responseText, url, xhr) {
	var me = config.macros.upgrade;
	var errMsg;
	if(!status) errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer) errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([], errMsg);
		alert(errMsg);
		return;
	}

	var step2 = [me.step2Html_downgrade, me.step2Html_restore, me.step2Html_upgrade][compareVersions(version, newVer) + 1];
	w.addStep(me.step2Title, step2.format([formatVersion(newVer), formatVersion(version)]));
	w.setButtons([
		{ caption: me.startLabel,  tooltip: me.startPrompt,  onClick: function() {
			config.macros.upgrade.onStartUpgrade(w, responseText);
		} },
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	]);
};

config.macros.upgrade.onStartUpgrade = function(wizard, newCoreHtml) {
	wizard.setButtons([], config.macros.upgrade.statusSavingCore);
	var localPath = tw.io.getOriginalLocalPath();
	saveFile(localPath, newCoreHtml);

	wizard.setButtons([], config.macros.upgrade.statusReloadingCore);
	var backupPath = wizard.getValue("backupPath");
	var newLocation = addUpgradePartsToURI(document.location.toString(), backupPath);
	window.setTimeout(function () { window.location = newLocation }, 10);
};

config.macros.upgrade.onCancel = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title, me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile) {
	var re = /version = \{\s*title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return !m ? null : {
		title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])
	};
};

// a helper, splits uri into parts, passes the map of parts to modify and glues parts back
function changeUri(uri, modify) {
	var uriPartsRE = /^(?:([\w:]+)\/\/)?([^\/\?#]+)?([^\?#]+)?(?:\?([^#]*))?(?:#(.*))?$/;
	var match = uriPartsRE.exec(uri) || [null, '', '', '', '', ''];
	var parts = {
		scheme:	match[1],
		host:	match[2],
		path:	match[3],
		query:	match[4],
		hash:	match[5]
	};
	modify(parts);
	var newScheme = parts.scheme === undefined ? '' : (parts.scheme + '//'),
	    newHost   = parts.host || '',
	    newPath   = parts.path || '',
	    newQuery  = parts.query ? ('?' + parts.query) : '',
	    newHash   = parts.hash   === undefined ? '' : ('#' + parts.hash);
	return newScheme + newHost + newPath + newQuery + newHash;
}

function addUpgradePartsToURI(uri, backupPath) {
	return changeUri(uri, function(uriParts) {
		var newParamifier = 'upgrade:[[' + encodeURI(backupPath) + ']]';
		uriParts.hash = (uriParts.hash ? uriParts.hash + '%20' : '') + newParamifier;

		var newQuery = "time=" + new Date().convertToYYYYMMDDHHMM();
		uriParts.query = (uriParts.query ? uriParts.query + '&' : '') + newQuery;
	});
}

function stripUpgradePartsFromURI(uri) {
	return changeUri(uri, function(uriParts) {
		var queryParts = uriParts.query.split('&'),
		    hashParts = uriParts.hash.split('%20'); // splits paramifiers with a space in argument

		for(var i = 0; i < queryParts.length; i++)
			if(queryParts[i].indexOf('time=') == 0)
				queryParts.splice(i--, 1);

		// relies on the upgrade paramifier being added to the end of hash
		for(i = 0; i < hashParts.length; i++)
			if(hashParts[i].indexOf('upgrade:') == 0)
				hashParts = hashParts.slice(0, i);

		uriParts.query = queryParts.join('&');
		uriParts.hash = hashParts.join('%20') || undefined;
	});
}

function upgradeFrom(path) {
	tw.io.loadFile(path, function(oldTw) {
		var importStore = new TiddlyWiki();
		importStore.importTiddlyWiki(oldTw);
		importStore.forEachTiddler(function(title, tiddler) {
			if(!store.getTiddler(title)) {
				store.addTiddler(tiddler);
			}
		});

		refreshDisplay();
		saveChanges();
		alert(config.messages.upgradeDone.format([formatVersion()]));
		window.location = stripUpgradePartsFromURI(window.location.toString());
	});
}

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place, macroName, params, wikifier, paramString) {
	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	listWrapper.setAttribute("refresh", "macro");
	listWrapper.setAttribute("macroName", "plugins");
	listWrapper.setAttribute("params", paramString);
	this.refresh(listWrapper, paramString);
};

config.macros.plugins.refresh = function(listWrapper, paramString) {
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper, function(e, rowName) {
		if(e.checked) selectedRows.push(e.getAttribute("rowName"));
	});
	jQuery(listWrapper).empty();

	var plugins = installedPlugins.slice(0);
	// not all plugins are installed, gather info about those, too
	var i, tiddler, p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(i = 0; i < configTiddlers.length; i++) {
		tiddler = configTiddlers[i];
		if(plugins.findByField("title", tiddler.title) != null) continue;

		p = getPluginInfo(tiddler);
		p.executed = false;
		p.log.splice(0, 0, this.skippedText);
		plugins.push(p);
	}

	for(i = 0; i < plugins.length; i++) {
		p = plugins[i];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[i].title) != -1;
	}

	if(plugins.length == 0) {
		createTiddlyElement(listWrapper, "em", null, null, this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper, plugins, template, this.onSelectCommand);
		wizard.setValue("listView", listView);
		if(!readOnly) {
			var me = config.macros.plugins;
			wizard.setButtons([
				{ caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag },
				{ caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete }
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var i = 0; i < rowNames.length; i++) {
			store.setTiddlerTag(rowNames[i], false, "systemConfig");
		}
		autoSaveChanges();
	}
};

config.macros.plugins.doDelete = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(var i = 0; i < rowNames.length; i++) {
				store.removeTiddler(rowNames[i]);
				story.closeTiddler(rowNames[i], true);
			}
		}
		autoSaveChanges();
	}
};

//--
//-- Message area
//--

function getMessageDiv() {
	var msgArea = document.getElementById("messageArea");
	if(!msgArea) return null;

	if(!msgArea.hasChildNodes()) {
		var toolbar = createTiddlyElement(msgArea, "div", null, "messageArea__toolbar messageToolbar");
		var btn = createTiddlyButton(toolbar, '', config.messages.messageClose.tooltip, clearMessage,
			"button messageToolbar__button");

		btn.innerHTML = tw.assets.icons.closeSvg;
		// inline SVG is unsupported in old FireFox
		if(window.HTMLUnknownElement && btn.firstChild instanceof window.HTMLUnknownElement) {
			btn.innerHTML = config.messages.messageClose.text;
		} else {
			btn.classList.add('messageToolbar__button_withIcon');
		}
	}
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea, "div", null, "messageArea__text");
}

function displayMessage(text, link) {
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(!link) {
		createTiddlyText(e, text);
	} else {
		createTiddlyElement(e, "a", null, null, text, { href: link, target: "_blank" });
	}
}

function clearMessage() {
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		jQuery(msgArea).empty();
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{ name: "SystemSettings", notify: onSystemSettingsChange },
	{ name: "StyleSheetLayout", notify: refreshStyles },
	{ name: "StyleSheetColors", notify: refreshStyles },
	{ name: "StyleSheet", notify: refreshStyles },
	{ name: "StyleSheetPrint", notify: refreshStyles },
	{ name: "PageTemplate", notify: refreshPageTemplate },
	{ name: "SiteTitle", notify: refreshPageTitle },
	{ name: "SiteSubtitle", notify: refreshPageTitle },
	{ name: "WindowTitle", notify: refreshPageTitle },
	{ name: "ColorPalette", notify: refreshColorPalette },
	{ name: null, notify: refreshDisplay }
];

config.refreshers = {
	link: function(e, changeList) {
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e, title);
		return true;
	},

	tiddler: function(e, changeList) {
		if (startingUp) return true; // #147
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title, template, true);
		else
			refreshElements(e, changeList);
		return true;
	},

	content: function(e, changeList) {
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.macroArgs; // #154
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e, title, args);
			return true;
		} else
			return false;
	},

	macro: function(e, changeList) {
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e, params);
		return true;
	}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root, changeList) {
	var i, nodes = root.childNodes;
	for(i = 0; i < nodes.length; i++) {
		var e = nodes[i], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = refresher ? refresher(e, changeList) : false;
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e, changeList);
	}
}

function applyHtmlMacros(root, tiddler) {
	for(var e = root.firstChild; !!e; e = nextChild) {
		// macros can manipulate DOM, so we remember nextChild before invokeMacro
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p + 1);
					macro = macro.substr(0, p);
				}
				invokeMacro(e, macro, params, null, tiddler);
			}
		}
		if(e.hasChildNodes()) applyHtmlMacros(e, tiddler);
	}
}

function refreshPageTemplate(title) {
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes, i;
	if(display) {
		nodes = display.childNodes;
		for(i = nodes.length - 1; i >= 0; i--)
			stash.appendChild(nodes[i]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if(!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable

	wrapper.innerHTML = store.getRecursiveTiddlerText(title, null, 10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	jQuery(display).empty();
	if(!display)
		display = createTiddlyElement(wrapper, "div", story.containerId());
	nodes = stash.childNodes;
	for(i = nodes.length - 1; i >= 0; i--)
		display.appendChild(nodes[i]);
	jQuery(stash).remove();
}

function refreshDisplay(hint) {
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e, hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e, hint);
	}
}

function refreshPageTitle() {
	document.title = getPageTitle();
}

function getPageTitle() {
	return wikifyPlainText(store.getTiddlerText("WindowTitle", ""), null, tiddler);
}

function refreshStyles(title, doc) {
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title, "", 10), title, doc || document);
}

function refreshColorPalette(title) {
	if(!startingUp)
		refreshAll();
}

function refreshAll() {
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

tw.options = {
	defaults: {},
	define: function(name, defaultValue, description) {
		this.defaults[name] = defaultValue;
		if(config.options[name] === undefined) config.options[name] = defaultValue;
		if(description) config.optionsDesc[name] = description;
	},
	hasDefaultValue: function(name) {
		return config.options[name] == this.defaults[name] ||
		       config.options[name] === undefined;
	}
};

for(var name in config.options) {
	tw.options.define(name, config.options[name], config.optionsDesc[name]);
}

config.optionHandlers = {
	'txt': {
		get: function(name) { return encodeCookie(config.options[name].toString()) },
		set: function(name, value) { config.options[name] = decodeCookie(value) }
	},
	'chk': {
		get: function(name) { return config.options[name] ? 'true' : 'false' },
		set: function(name, value) { config.options[name] = value == 'true' }
	}
};

function setOption(name, value) {
	var optType = name.substr(0, 3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name, value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name) {
	var optType = name.substring(0, 3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ?
		config.optionHandlers[optType].get(name) : null;
}

function loadOptions() {
	if(safeMode) return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies() {
	var cookieList = document.cookie.split(';');
	var i, cookies = {};
	for(i = 0; i < cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = jQuery.trim(cookieList[i].substring(0, p));
			var value = jQuery.trim(cookieList[i].substring(p + 1));
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies() {
	var i, cookies = getCookies();
	if(cookies['TiddlyWikiClassicOptions']) // TW291 and later //#159
		cookies = cookies['TiddlyWikiClassicOptions'].replace(/%22/g, '"').replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWikiOptions']) // TW290 beta //#159
		cookies = cookies['TiddlyWikiOptions'].replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWiki']) // TW281 and earlier
		cookies = cookies['TiddlyWiki'].decodeHashMap();

	for(i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i, cookies[i]);
		}
	}
}

function loadSystemSettings() {
	var key, settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(key in settings) {
		setOption(key, settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange() {
	if(!startingUp) loadSystemSettings();
}

function saveOption(name) {
	if(safeMode) return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}

	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name, true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name) {
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name) {
	var key, cookies = {};
	for(key in config.options) {
		if(tw.options.hasDefaultValue(key)) continue;
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWikiClassicOptions='
		+ String.encodeHashMap(cookies).replace(/%/g, '%25').replace(/"/g, '%22')
		+ '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';

	// clean up cookies saved in an earlier format, before TW291 (#159)
	cookies = getCookies();
	for(var c in cookies) {
		var optType = c.substring(0, 3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

var systemSettingSave;
function commitSystemSettings(storeWasDirty) {
	if(systemSettingSave) {
		window.clearTimeout(systemSettingSave);
	}
	systemSettingSave = window.setTimeout(function() {
		var tiddler = store.getTiddler('SystemSettings');
		autoSaveChanges(null, [tiddler]);
	}, 1000);
}

function saveSystemSetting(name, saveFile) {
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title, name);
	var isUnchanged = slice === getOption(name);
	if(readOnly || isUnchanged) return;

	var slices = store.calcAllSlices(title);
	for(var key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}

	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key, slices[key]]));
	}
	text = text.sort().join('\n');

	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title, title, text, 'System',
			new Date(), ['excludeLists'], config.defaultCustomFields);
	}
	if(saveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s) {
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s) {
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re, function($0) { return String.fromCharCode(eval($0.replace(/[&#;]/g, ''))) });
}

config.macros.option.genericCreate = function(place, type, opt, className, desc) {
	var typeInfo = config.macros.option.types[type];
	var text = desc != 'no' ? (config.optionsDesc[opt] || opt) : null;
	var attributes = { option: opt };
	if(typeInfo.typeValue) attributes.type = typeInfo.typeValue;
	if(config.optionsDesc[opt]) attributes.title = config.optionsDesc[opt];
	var c = createTiddlyElement(place, typeInfo.elementType, null, className || typeInfo.className, text, attributes);
	c[typeInfo.eventName] = typeInfo.onChange;
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e) {
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substring(0, 3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt, handler.valueField,
				this[handler.valueField], handler.elementType, this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt, valueField, value, elementType, sourceEditor) {
	config.options[opt] = value;
	saveOption(opt);

	jQuery(elementType + '[option=' + opt + ']').each(function(i, editor) {
		if(editor != sourceEditor) editor[valueField] = value;
	});
};

config.macros.option.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params, 'name', null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params, 'class', null);
	var desc = getParam(params, 'desc', 'no');
	var type = opt.substring(0, 3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place, type, opt, className, desc);
};

config.macros.options.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var showUnknown = getParam(params, 'showUnknown', 'no');

	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper, markList);
	wizard.setValue('listWrapper', listWrapper);
	this.refreshOptions(listWrapper, showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper, showUnknown) {
	var n, opts = [];
	for(n in config.options) {
		var isUnknown = !config.optionsDesc[n];
		if(!isUnknown || showUnknown) opts.push({
			option: '',
			name: n,
			lowlight: isUnknown,
			description: config.optionsDesc[n] || this.unknownDescription
		});
	}
	opts.sort(function(a, b) {
		var nameA = a.name.substring(3);
		var nameB = b.name.substring(3);
		return nameA < nameB ? -1 : (nameA == nameB ? 0 : +1);
	});

	ListView.create(listWrapper, opts, this.listViewTemplate);
	for(var i = 0; i < opts.length; i++) {
		var type = opts[i].name.substring(0, 3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[i].colElements['option'], type, opts[i].name, null, 'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e) {
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper, this.checked);
	return false;
};

//--
//-- Saving
//--

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var startSaveAreaRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var endSaveArea = '</d' + 'iv>';
var endSaveAreaCaps = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit() {
	hadConfirmExit = true;
	var hasDirtyStore = store && store.isDirty && store.isDirty();
	var hasDirtyStory = story && story.areAnyDirty && story.areAnyDirty();
	if(hasDirtyStore || hasDirtyStory) return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges() {
	if(!(store && store.isDirty && store.isDirty()) || window.hadConfirmExit !== false) return;
	if(confirm(config.messages.unsavedChangesWarning)) saveChanges();
}

function updateLanguageAttribute(s) {
	if(!config.locale) return s;
	var m = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/.exec(s);
	if(!m) return s;

	var htmlTag = m[1];
	if(m[2]) htmlTag += ' xml:lang="' + config.locale + '"';
	if(m[3]) htmlTag += ' lang="' + config.locale + '"';
	htmlTag += ">";

	return s.substr(0, m.index) + htmlTag + s.substr(m.index + m[0].length);
}

function updateMarkupBlock(s, blockName, tiddlerName) {
	return tw.textUtils.replaceChunk(s,
		"<!--%0-START-->".format([blockName]),
		"<!--%0-END-->".format([blockName]),
		"\n" + store.getRecursiveTiddlerText(tiddlerName, "") + "\n");
}

function updateOriginal(original, posDiv, localPath) {
	if(!posDiv) posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0, posDiv[0] + startSaveArea.length) + "\n" +
		store.allTiddlersAsHtml() + "\n" +
		original.substr(posDiv[1]);
	var newSiteTitle = getPageTitle().htmlEncode();
	revised = tw.textUtils.replaceChunk(revised, "<title" + ">", "</title" + ">", " " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised, "PRE-HEAD", "MarkupPreHead");
	revised = updateMarkupBlock(revised, "POST-HEAD", "MarkupPostHead");
	revised = updateMarkupBlock(revised, "PRE-BODY", "MarkupPreBody");
	revised = updateMarkupBlock(revised, "POST-SCRIPT", "MarkupPostBody");
	return revised;
}

function locateStoreArea(original) {
	// Locate the storeArea divs
	if(!original) return null;
	var posOpeningDiv = original.search(startSaveAreaRE);
	var limitClosingDiv = original.indexOf("<" + "!--POST-STOREAREA--" + ">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<" + "!--POST-BODY-START--" + ">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(endSaveArea, start);
	if(posClosingDiv == -1)
		posClosingDiv = original.lastIndexOf(endSaveAreaCaps, start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv, posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty, tiddlers) {
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty, tiddlers);
}

// get the full HTML of the original file
function loadOriginal(localPath, callback) {
	if(!callback) return loadFile(localPath) || window.originalHTML || recreateOriginal();

	tw.io.loadFile(localPath, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			var original = window.originalHTML || recreateOriginal();
			callback(original);
		}
	});
}

// reconstruct original HTML file content from current document memory
function recreateOriginal() {
	// construct doctype
	var content = "<!DOCTYPE ";
	var t = document.doctype;
	if (!t)
		content += "html";
	else {
		content += t.name;
		if(t.publicId)
			content += ' PUBLIC "' + t.publicId + '"';
		else if(t.systemId)
			content += ' SYSTEM "' + t.systemId + '"';
	}
	content += ' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"';
	content += '>\n';

	// append current document content
	content += document.documentElement.outerHTML;

	// clear 'savetest' marker
	content = content.replace(/<div id="saveTest">savetest<\/div>/, '<div id="saveTest"></div>');
	content = content.replace(/script><applet [^\>]*><\/applet>/g, 'script>');
	// newline before head tag
	content = content.replace(/><head>/, '>\n<head>');
	// newlines before/after end of body/html tags
	content = content.replace(/\n\n<\/body><\/html>$/, '</' + 'body>\n</' + 'html>\n'); // #170
	// meta tag terminators
	content = content.replace(/(<(meta) [^\>]*[^\/])>/g, '$1 />');
	// decode LT/GT entities in noscript
	content = content.replace(/<noscript>[^\<]*<\/noscript>/,
		function(m) { return m.replace(/&lt;/g, '<').replace(/&gt;/g, '>') });
	// encode copyright symbols (UTF-8 to HTML entity)
	content = content.replace(/<div id="copyright">[^\<]*<\/div>/,
		function(m) { return m.replace(/\xA9/g, '&copy;') });

	return content;
}

// reconstruct the local path to TW itself
tw.io.getOriginalLocalPath = function() {
	return getLocalPath(document.location.toString());
};

// Save tiddlywiki (but not backup or anything else)
tw.io.knownSaveMainFailures = {
	failedToLoadOriginal: 1,
	invalidFile: 2
};

// Save this tiddlywiki with the pending changes
tw.io.saveMainAndReport = function(callback) {
	var localPath = tw.io.getOriginalLocalPath();
	var onLoadOriginal = function(original) {
		var msg = config.messages;
		if(original == null) {
			alert(msg.cantSaveError);
			if(store.tiddlerExists(msg.saveInstructions))
				story.displayTiddler(null, msg.saveInstructions);

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.failedToLoadOriginal
			});
		}

		var posDiv = locateStoreArea(original);
		if(!posDiv) {
			alert(msg.invalidFileError.format([localPath]));

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.invalidFile
			});
		}

		config.saveByDownload = false;
		config.saveByManualDownload = false;
		// chkPreventAsyncSaving is checked inside saveMain
		saveMain(localPath, original, posDiv, callback);
	};

	if(!config.options.chkPreventAsyncSaving) {
		loadOriginal(localPath, onLoadOriginal);
	} else {
		// useful when loadOriginal is overwritten without support of callback
		// or when an extension relies saveChanges being a sync function
		var original = loadOriginal(localPath);
		onLoadOriginal(original);
	}
};

function saveChanges(onlyIfDirty, tiddlers) {
	if(onlyIfDirty && !store.isDirty()) return;

	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	if(!window.allowSave()) {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null, msg.saveInstructions);
		return;
	}

	tw.io.saveMainAndReport(function postSave(savedOrPending, details) {
		var co = config.options;
		if (!config.saveByDownload && !config.saveByManualDownload && details && details.original) {
			var localPath = tw.io.getOriginalLocalPath();
			if(co.chkSaveBackups) saveBackup(localPath, details.original);
			if(co.chkSaveEmptyTemplate) saveEmpty(localPath, details.original);
			if(co.chkGenerateAnRssFeed) saveRss(localPath);
		}

		if(co.chkDisplayInstrumentation)
			displayMessage("saveChanges " + (new Date() - t0) + " ms");
	});
}

function saveMain(localPath, original, posDiv, callback) {
	var reportStatusAndHandle = function(successOrPending, localPath, revised) {
		if(successOrPending) {
			tw.io.onSaveMainSuccess(config.saveByDownload ?
				getDataURI(revised) : "file://" + localPath, revised, original);
		} else {
			tw.io.onSaveMainFail();
		}
	};
	try {
		var revised = updateOriginal(original, posDiv, localPath);

		if(!callback || config.options.chkPreventAsyncSaving) {
			var savedOrPending = tw.io.saveFile(localPath, revised);
			reportStatusAndHandle(savedOrPending, localPath, revised);
			if(callback) callback(savedOrPending, {
				original: original
			});
		} else tw.io.saveFile(localPath, revised, function(success, details) {
			reportStatusAndHandle(success, localPath, revised);
			details.original = original;
			callback(success, details);
		});
	} catch (ex) {
		tw.io.onSaveMainFail(ex);
		if(callback) callback(false, { original: original });
	}
}

tw.io.onSaveMainSuccess = function(urlSaved, savedHtml, original) {
	if (!config.saveByManualDownload) {
		displayMessage(
			// set by HTML5DownloadSaveFile()
			config.saveByDownload ?
				config.messages.mainDownload :
				config.messages.mainSaved,
			urlSaved);
	}

	store.setDirty(false);
};

tw.io.onSaveMainFail = function(catchedExeption) {
	alert(config.messages.mainFailed);
	if(catchedExeption) showException(catchedExeption);
};

function saveBackup(localPath, original) {
	var backupPath = getBackupPath(localPath);
	var backupSuccess = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(backupSuccess)
		displayMessage(config.messages.backupSaved, "file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath, original, posDiv) {
	posDiv = posDiv || locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.emptyFailed);
		return;
	}

	var emptyPath, slashPosition;
	if((slashPosition = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "/";
	else if((slashPosition = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";

	var empty = original.substr(0, posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath, empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved, "file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

// Translate URL to local path [Preemption]
window.getLocalPath = window.getLocalPath || function(origPath) {
	var originalPath = convertUriToUTF8(origPath, config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0, argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0, hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/", "g"), "\\");
	return localPath;
};

function getBackupPath(localPath, filenameSuffix, extension) {
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder || ".";
	var backupPath = localPath.substring(0, dirPathPos) + slash + backupFolder + localPath.substring(dirPathPos);
	backupPath = backupPath.substring(0, backupPath.lastIndexOf(".")) + ".";
	if(filenameSuffix) {
		var illegalFilenameCharacterOrSpaceRE = /[\\\/\*\?\":<> ]/g;
		backupPath += filenameSuffix.replace(illegalFilenameCharacterOrSpaceRE, "_") + ".";
	}
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath, callback) {
	var rssPath = localPath.substr(0, localPath.lastIndexOf(".")) + ".xml";

	tw.io.saveFile(rssPath, generateRss(), callback || function(result, details) {
		if(result)
			displayMessage(config.messages.rssSaved, "file://" + rssPath);
		else
			alert(config.messages.rssFailed);
	});
}

function tiddlerToRssItem(tiddler, uri) {
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text, null, tiddler).htmlEncode() + "</description>\n";
	for(var i = 0; i < tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s += "<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
}

function generateRss() {
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlainText(store.getTiddlerText("SiteTitle", ""),
		null, tiddler).htmlEncode() + "</title" + ">");
	if(u) s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlainText(store.getTiddlerText("SiteSubtitle", ""),
		null, tiddler).htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified", "excludeLists");
	var i, n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length - config.numRssItems;
	for(i = tiddlers.length - 1; i >= n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i], u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

// Copy a file in filesystem [Preemption]
window.copyFile = window.copyFile || function(dest, source) {
	return config.browser.isIE ? ieCopyFile(dest, source) : false;
};

// Save a file in filesystem [Preemption]
window.saveFile = window.saveFile || function(fileUrl, content) {
	var r = mozillaSaveFile(fileUrl, content);
	if(!r)
		r = ieSaveFile(fileUrl, content);
	if(!r)
		r = javaSaveFile(fileUrl, content);
	if(!r)
		r = HTML5DownloadSaveFile(fileUrl, content);
	if(!r)
		r = manualSaveFile(fileUrl, content);
	return r;
};

// A placeholder method that can be overwritten/decorated by savers.
// In such a case, it's required to call callback on both success and fail.
// See details about the callback in tw.io.saveFile.
tw.io.asyncSaveFile = tw.io.asyncSaveFile || function(fileUrl, content, callback) {
	callback(false, { reason: 'Async saving is not implemented' });
};

// The general save method to use
// ==============================
// If callback is set, tries to save in an async fashion and do callback(success: boolean, details: object)
//  Some savers within window.saveFile, like download saving or Timimi don't care about the callback,
// so it can be called before actual saving is done (or even give false positives).
tw.io.saveFile = function(fileUrl, content, callback) {
	if(!callback) return saveFile(fileUrl, content);

	tw.io.asyncSaveFile(fileUrl, content, function(success, details) {
		if(success) callback(success, details);
		else {
			result = saveFile(fileUrl, content);
			callback(result, {});
		}
	});
};

// Load a file from filesystem [Preemption]
window.loadFile = window.loadFile || function(fileUrl) {
	var r = mozillaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = ieLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = javaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = tw.io.xhrLoadFile(fileUrl);
	return r;
};

tw.io.xhrLoadFile = function(filePath, callback) {
	try {
		var isAsync = !!callback;
		var url = 'file://' + (filePath[0] != '/' ? '/' : '') + encodeURIComponent(filePath);
		if(isAsync) {
			httpReq('GET', url, function(status, params, responseText, url, xhr) {
				callback(responseText, { xhr: xhr });
			});
		} else {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, isAsync);
			xhr.send(null);
			return xhr.responseText;
		}
	} catch(ex) {
		return callback ? callback(null) : null;
	}
};

// The general load method to use
// ==============================
// If callback is set, tries to load in an async fashion and do callback(result, details)
tw.io.loadFile = function(fileUrl, callback) {
	if(!callback) return loadFile(fileUrl);

	tw.io.xhrLoadFile(fileUrl, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			result = loadFile(fileUrl);
			callback(result);
		}
	});
};


function ieCreatePath(path) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	// Remove the filename, if present. Use trailing slash (i.e. "foo\bar\") if no filename.
	var pos = path.lastIndexOf("\\");
	if(pos == -1) pos = path.lastIndexOf("/");
	if(pos != -1) path = path.substring(0, pos + 1);

	// Walk up the path until we find a folder that exists
	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	// Walk back down the path, creating folders
	for(var i = scan.length - 1; i >= 0; i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content) {
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath, 2, -1, 0);
	file.Write(convertUnicodeToHtmlEntities(content));
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath, 1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest, source) {
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content) {
	if(!window.Components) return null;

	content = mozConvertUnicodeToUTF8(content);
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"]
			.createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			file.create(0, 0x01B4);// 0x01B4 = 0664
		var out = Components.classes["@mozilla.org/network/file-output-stream;1"]
			.createInstance(Components.interfaces.nsIFileOutputStream);
		out.init(file, 0x22, 0x04, null);
		out.write(content, content.length);
		out.flush();
		out.close();
		return true;
	} catch(ex) {
		return false;
	}
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath) {
	if(!window.Components) return null;

	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			return null;
		var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"]
			.createInstance(Components.interfaces.nsIFileInputStream);
		inputStream.init(file, 0x01, 0x04, null);
		var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"]
			.createInstance(Components.interfaces.nsIScriptableInputStream);
		sInputStream.init(inputStream);
		var contents = sInputStream.read(sInputStream.available());
		sInputStream.close();
		inputStream.close();
		return mozConvertUTF8ToUnicode(contents);
	} catch(ex) {
		return false;
	}
}

function HTML5DownloadSaveFile(filePath, content) {
	var link = document.createElement("a");
	if(link.download === undefined)
		return null;

	config.saveByDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	link.setAttribute("target", "_blank");
	link.setAttribute("href", uri);
	link.setAttribute("download", filename);
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function manualSaveFile(filePath, content) {
	// FALLBACK for showing a link to data: URI
	config.saveByManualDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	displayMessage(config.messages.mainDownloadManual, uri);
	return true;
}

// construct data URI (using base64 encoding to preserve multi-byte encodings)
function getDataURI(data) {
	return config.browser.isIE ?
		"data:text/html," + encodeURIComponent(data) :

		// manualConvertUnicodeToUTF8 was moved here from convertUnicodeToFileFormat
		// In 2.9.1, it was used only for FireFox but happened to fix
		// download saving non-ASCII in Chrome & Safari as well (see 949aff6)
		"data:text/html;base64," + encodeBase64(manualConvertUnicodeToUTF8(data));
}

function encodeBase64(data) {
	if (!data) return "";
	var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
	var out = "";
	var chr1, chr2, chr3 = "";
	var enc1, enc2, enc3, enc4 = "";
	for (var i = 0; i < data.length; ) {
		chr1 = data.charCodeAt(i++);
		chr2 = data.charCodeAt(i++);
		chr3 = data.charCodeAt(i++);
		enc1 = chr1 >> 2;
		enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
		enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
		enc4 = chr3 & 63;
		if (isNaN(chr2)) enc3 = enc4 = 64;
		else if (isNaN(chr3)) enc4 = 64;
		out += keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
		chr1 = chr2 = chr3 = enc1 = enc2 = enc3 = enc4 = "";
	}
	return out;
}

//--
//-- Filesystem utilities
//--

function convertUTF8ToUnicode(u) {
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}


function manualConvertUTF8ToUnicode(utf) {
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s + fin : s;
}

function manualConvertUnicodeToUTF8(s) {
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUnicodeToHtmlEntities(s) {
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re, function($0) { return "&#" + $0.charCodeAt(0).toString() + ";" });
}

function convertUriToUTF8(uri, charSet) {
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"]
			.getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri, charSet);
}

// deprecated helper for backward-compatibility with elder extensions
// (browser/saving method-specific convertion is only needed in browser-specific savers)
function convertUnicodeToFileFormat(s) {
	return s;
}

// deprecated helper for backward-compatibility with elder extensions
function convertUnicodeToUTF8(s) {
	return s;
}

//--
//-- Server adaptor base class
//--

function AdaptorBase() {
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function() {
	return true;
};

AdaptorBase.prototype.fullHostName = function(host) {
	if(!host) return '';
	host = jQuery.trim(host);
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length - 1) == '/')
		host = host.substr(0, host.length - 1);
	return host;
};

AdaptorBase.minHostName = function(host) {
	return host;
};

AdaptorBase.prototype.setContext = function(context, userParams, callback) {
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
//   host - uri of host (eg, "http://www.tiddlywiki.com/" or "www.tiddlywiki.com")
//   context is itself passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - optional function to be called on completion
// Return value is true if the request was successfully issued, false if this connector doesn't support openHost(),
//   or an error description string if there was a problem
// The callback parameters are callback(context)
//   context.status - true if OK, string if error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openHost function
AdaptorBase.prototype.openHost = function(host, context, userParams, callback) {
	this.host = host;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	return true;
};

// Open the specified workspace
//   workspace - name of workspace to open
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openWorkspace function
AdaptorBase.prototype.openWorkspace = function(workspace, context, userParams, callback) {
	this.workspace = workspace;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor() {}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiSuccess = function(context, jqXHR) {
	context.status = true;
	context.adaptor.store = new TiddlyWiki();
	if(!context.adaptor.store.importTiddlyWiki(jqXHR.responseText)) {
		context.statusText = config.messages.invalidFileError.format([context.host]);
		context.status = false;
	}
	context.complete(context, context.userParams);
};

FileAdaptor.loadTiddlyWikiError = function(context, jqXHR) {
	context.status = false;
	context.statusText = jqXHR.message;
	context.complete(context, context.userParams);
};

// Get the list of workspaces on a given server
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   false if this connector doesn't support getWorkspaceList(),
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the getWorkspaceList function
FileAdaptor.prototype.getWorkspaceList = function(context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.workspaces = [{ title: "(default)" }];
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

// Gets the list of tiddlers within a given workspace
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
//   filter - filter expression
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddlers - array of tiddler objects
//   userParams - parameters as originally passed into the getTiddlerList function
FileAdaptor.prototype.getTiddlerList = function(context, userParams, callback, filter) {
	context = this.setContext(context, userParams, callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		file: context.file, // for HTML5 FileReader
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			context.xhr = jqXHR;
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerListComplete = function(context, userParams) {
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title, tiddler) { context.tiddlers.push(tiddler) });
		}
		for(var i = 0; i < context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler) {
	return {
		uri: tiddler.fields['server.host'] + "#" + tiddler.title
	};
};

// Retrieve a tiddler from a given workspace on a given server
//   title - title of the tiddler to get
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddler - the retrieved tiddler, or null if it cannot be found
//   userParams - parameters as originally passed into the getTiddler function
FileAdaptor.prototype.getTiddler = function(title, context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	if(context.adaptor.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerComplete = function(context, userParams) {
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context, userParams);
	} else {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.close = function() {
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

// Perform an http request using the jQuery ajax function
// fallback to privileged file I/O or HTML5 FileReader
function ajaxReq(args) {
	if (args.file || args.url.startsWith("file"))  // LOCAL FILE
		return localAjax(args);
	return jQuery.ajax(args);
}

// perform local I/O and FAKE a minimal XHR response object
function localAjax(args) {
	var success = function(data) {
		args.success(data, "success", { responseText: data });
	};
	var failure = function(who) {
		args.error({ message: who + ": cannot read local file" }, "error", 0);
	};

	if (args.file) try { // HTML5 FileReader (Chrome, FF20+, Safari, etc.)
		var reader = new FileReader();
		reader.onload = function(e)  { success(e.target.result) };
		reader.onerror = function(e) { failure("FileReader") };
		reader.readAsText(args.file);
		return true;
	} catch (ex) { ; }

	// local file I/O (IE, FF with security.fileuri.strict_origin_policy:false, etc.)
	try {
		var data = loadFile(getLocalPath(args.url));
		if (data) success(data);
		else failure("loadFile");
		return true;
	} catch (ex) { ; }

	return true;
}

// Perform an http request
//   type - GET/POST/PUT/DELETE
//   url - the source url
//   data - optional data for POST and PUT
//   contentType - optionalContent type for the data (defaults to application/x-www-form-urlencoded)
//   username - optional username for basic authentication
//   password - optional password for basic authentication
//   callback - function to call when there is a response
//   params - parameter object that gets passed to the callback for storing it's state
//   headers - optional hashmap of additional headers
//   allowCache - unless true, adds a "nocache=" parameter to the URL
// Return value is the underlying XMLHttpRequest object, or a string if there was an error
// Callback function is called like this:
//   callback(status, params, responseText, url, xhr)
//     status - true if OK, false if error
//     params - the parameter object provided to loadRemoteFile()
//     responseText - the text of the file
//     url - requested URL
//     xhr - the underlying XMLHttpRequest object
function httpReq(type, url, callback, params, headers, data, contentType, username, password, allowCache) {
	var httpSuccess = function(xhr) {
		try {
			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
			return (!xhr.status && location.protocol === "file:") ||
				(xhr.status >= 200 && xhr.status < 300) ||
				xhr.status === 304 || xhr.status === 1223;
		} catch(e) {}
		return false;
	};

	var options = {
		type: type,
		url: url,
		processData: false,
		data: data,
		cache: !!allowCache,
		beforeSend: function(xhr) {
			for(var i in headers)
				xhr.setRequestHeader(i, headers[i]);
		}
	};

	if(callback) {
		options.complete = function(xhr, textStatus) {
			if(httpSuccess(xhr))
				callback(true, params, xhr.responseText, url, xhr);
			else
				callback(false, params, null, url, xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	try {
		if(window.Components && window.netscape && window.netscape.security
		   && document.location.protocol.indexOf("http") == -1)
			window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	} catch (ex) {
	}
	return jQuery.ajax(options);
}
//--
//-- TiddlyWiki-specific utility functions
//--

// Return TiddlyWiki version string
function formatVersion(v) {
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "") +
		(v.nightly ? " (nightly " + v.nightly + ")" : "");
}

function compareVersions(v1, v2) {
	var x1, x2, i, a = ["major", "minor", "revision"];
	for(i = 0; i < a.length; i++) {
		x1 = v1[a[i]] || 0;
		x2 = v2[a[i]] || 0;
		if(x1 < x2) return +1;
		if(x1 > x2) return -1;
	}
	x1 = v1.beta || Infinity;
	x2 = v2.beta || Infinity;
	return x1 < x2 ? +1 :
	       x1 > x2 ? -1 : 0;
}

function merge(dst, src, preserveExisting) {
	for(var key in src)
		if(!preserveExisting || dst[key] === undefined)
			dst[key] = src[key];

	return dst;
}

// Get the target of an event
function resolveTarget(event) {
	var obj = event.target || event.srcElement;
	// defeat Safari bug
	if(obj.nodeType == 3)
		obj = obj.parentNode;
	return obj;
}

// Return the description of an exception (string)
function exceptionText(ex, prependedMessage) {
	var s = ex.description || ex.toString();
	return prependedMessage ? (prependedMessage + ":\n" + s) : s;
}

// Display an alert of an exception description with optional message
function showException(e, prependedMessage) {
	alert(exceptionText(e, prependedMessage));
}

function alertAndThrow(m) {
	alert(m);
	throw(m);
}

function glyph(name) {
	var g = config.glyphs;
	if(!g.codes[name]) return "";
	if(g.currBrowser == null) {
		var i = 0;
		while(i < g.browsers.length - 1 && !g.browsers[i]())
			i++;
		g.currBrowser = i;
	}
	return g.codes[name][g.currBrowser];
}

function createTiddlyText(parent, text) {
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent, caption, checked, onChange) {
	var cb = document.createElement("input");
	cb.setAttribute("type", "checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption, parent);
	return cb;
}

function createTiddlyElement(parent, element, id, className, text, attribs) {
	var n, e = document.createElement(element);
	if(className != null) e.className = className;
	if(       id != null) e.setAttribute('id', id);
	if(     text != null) createTiddlyText(e, text);
	if(attribs) {
		for(n in attribs) e.setAttribute(n, attribs[n]);
	}
	if(parent != null) parent.appendChild(e);
	return e;
}

function createTiddlyButton(parent, text, tooltip, action, className, id, accessKey, customAttributes) {
	var attributes = { href: 'javascript:;' };
	if(tooltip)   attributes.title = tooltip;
	if(accessKey) attributes.accessKey = accessKey;
	merge(attributes, customAttributes || {});

	var btn = createTiddlyElement(parent, 'a', id || null, className || 'button', text, attributes);
	if(action) btn.onclick = action;
	return btn;
}

function createExternalLink(place, url, label) {
	var tooltip = config.messages.externalLinkTooltip;
	var link = createTiddlyElement(place, 'a', null, 'externalLink', label, {
		href: url,
		title: tooltip ? tooltip.format([url]) : url
	});
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	return link;
}

function getTiddlyLinkInfo(title, currClasses) {
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
	    var f;
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			f = config.messages.shadowedTiddlerToolTip;
			classes.pushUnique("shadow");
		} else {
			f = config.messages.undefinedTiddlerToolTip;
			classes.remove("shadow");
		}
		subTitle = f ? f.format([title]) : "";
	}
	if(typeof config.annotations[title] == "string")
		subTitle = config.annotations[title];
	return { classes: classes.join(" "), subTitle: subTitle };
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f, config.defaultCustomFields, true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target, title, null, true, null, fields, toggling);
	}
	clearMessage();
	return false;
}

function getTiddlerLinkHref(title) {
	return window.location.toString().replace(/#.*$/, '') + story.getPermaViewHash([title]);
}

function createTiddlyLink(place, title, includeText, className, isStatic, linkedFromTiddler, noToggle) {
	var title = jQuery.trim(title);
	var text = includeText ? title : null;
	var info = getTiddlyLinkInfo(title, className);
	var btn = isStatic ?
		createExternalLink(place, store.getTiddlerText("SiteUrl", null) + story.getPermaViewHash([title])) :
		createTiddlyButton(place, text, info.subTitle, onClickTiddlerLink, info.classes, '', '', {
			href: getTiddlerLinkHref(title)
		});
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh", "link");
	btn.setAttribute("tiddlyLink", title);
	if(noToggle)
		btn.setAttribute("noToggle", "true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields", fields);
	}
	return btn;
}

function refreshTiddlyLink(e, title) {
	var info = getTiddlyLinkInfo(title, e.className);
	e.className = info.classes;
	e.title = info.subTitle;
}

function createTiddlyDropDown(place, onchange, options, defaultValue) {
	var sel = createTiddlyElement(place, "select");
	sel.onchange = onchange;

	for(var i = 0; i < options.length; i++) {
		var e = createTiddlyElement(sel, "option", null, null, options[i].caption);
		e.value = options[i].name;
		if(e.value == defaultValue)
			e.selected = true;
	}
	return sel;
}

//--
//-- TiddlyWiki-specific popup utility functions
//--

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev) {
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby && sortby.length) {
		store.sortTiddlers(tiddlers, sortby);
	}
	story.displayTiddlers(this, tiddlers);
	return false;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[") == -1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby && sortby.length) {
			store.sortTiddlers(tagged, sortby);
		}
		var titles = [];
		for(var i = 0; i < tagged.length; i++) {
			if(tagged[i].title != title)
				titles.push(tagged[i].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup, "li"),
				lingo.openAllText.format([tag]), lingo.openAllTooltip, onClickTagOpenAll);
			openAll.setAttribute("tag", tag);
			openAll.setAttribute("sortby", sortby);
			createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
			for(i = 0; i < titles.length; i++) {
				createTiddlyLink(createTiddlyElement(popup, "li"), titles[i], true);
			}
		} else {
			createTiddlyElement(popup, "li", null, "disabled", lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
		var link = createTiddlyLink(createTiddlyElement(popup, "li"), tag, false);
		createTiddlyText(link, lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place, tag, excludeTiddler, title, tooltip) {
	var btn = createTiddlyButton(place, title || tag,
		(tooltip || config.views.wikified.tag.tooltip).format([tag]), onClickTag);
	btn.setAttribute("tag", tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler", excludeTiddler);
	return btn;
}

function onClickTiddlyPopup(ev) {
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this, "div", "popupTiddler");
		wikify(tiddler.text, popup, null, tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyPopup(place, caption, tooltip, tiddler) {
	if(tiddler.text) {
		createTiddlyLink(place, caption, true);
		var btn = createTiddlyButton(place, glyph("downArrow"), tooltip, onClickTiddlyPopup, "tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place, caption);
	}
}

function onClickError(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var i = 0; i < lines.length; i++) {
		createTiddlyElement(popup, "li", null, "popupMessage", lines[i]);
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place, title, text) {
	var btn = createTiddlyButton(place, title, null, onClickError, "errorButton");
	if(text) btn.setAttribute("errorText", text);
}
//-
//- Animation engine
//-

function Animator() {
	// Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.running = 0;
	// ID of the timer used for animating
	this.timerID = 0;
	// List of animations in progress
	this.animations = [];
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() { //# Variable number of arguments
	for(var i = 0; i < arguments.length; i++)
		this.animations.push(arguments[i]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() { me.doAnimate(me) }, 10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me) {
	var i = 0;
	while(i < me.animations.length) {
		if(me.animations[i].tick()) {
			i++;
		} else {
			me.animations.splice(i, 1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress) {
	return 1 - ((Math.cos(progress * Math.PI) + 1) / 2);
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element, duration, properties, callback) {
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element, style, value) {
	switch(style) {
		case "-tw-vertScroll":
			window.scrollTo(findScrollX(), value);
			break;
		case "-tw-horizScroll":
			window.scrollTo(value, findScrollY());
			break;
		default:
			element.style[style] = value;
			break;
	}
};

Morpher.prototype.stop = function() {
	for(var i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element, p.style, p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element, this.properties);
};

Morpher.prototype.tick = function() {
	var currTime = Number(new Date());
	var i, progress = Animator.slowInSlowOut(Math.min(1, (currTime - this.startTime) / this.duration));
	for(i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
				case undefined:
				case "style":
					var value = p.start + (p.end - p.start) * progress;
					this.assignStyle(this.element, p.style, template.format([value]));
					break;
				case "color":
					break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text, startElement, targetElement, unused) {
	var e = createTiddlyElement(document.body, "div", null, "zoomer");
	createTiddlyElement(e, "div", null, null, text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{ style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px' },
		{ style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px' },
		{ style: 'width', start: Math.min(startElement.scrollWidth, winWidth),
		  end: Math.min(targetElement.scrollWidth, winWidth), template: '%0px', atEnd: 'auto' },
		{ style: 'height', start: Math.min(startElement.scrollHeight, winHeight),
		  end: Math.min(targetElement.scrollHeight, winHeight), template: '%0px', atEnd: 'auto' },
		{ style: 'fontSize', start: 8, end: 24, template: '%0pt' }
	];
	var c = function(element) { jQuery(element).remove() };
	return new Morpher(e, config.animDuration, p, c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement) {
	return new Morpher(targetElement, config.animDuration, [{
		style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)
	}]);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element, opening, unused, deleteMode) {
	element.style.overflow = 'hidden';
	// Workaround a Firefox flashing bug
	if(opening) element.style.height = '0px';
	element.style.display = 'block';
	var height = element.scrollHeight;
	var props = [];
	var callback = null;
	if(opening) {
		props.push({ style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto' });
		props.push({ style: 'opacity', start: 0, end: 1, template: '%0' });
		props.push({ style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)' });
	} else {
		props.push({ style: 'height', start: height, end: 0, template: '%0px' });
		props.push({ style: 'display', atEnd: 'none' });
		props.push({ style: 'opacity', start: 1, end: 0, template: '%0' });
		props.push({ style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)' });
		switch(deleteMode) {
			case "all":
				callback = function(element, properties) { jQuery(element).remove() };
				break;
			case "children":
				callback = function(element, properties) { jQuery(element).empty() };
				break;
		}
	}
	return new Morpher(element, config.animDuration, props, callback);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
};

Popup.create = function(root, elem, className) {
	var stackPosition = this.find(root, "popup");
	Popup.remove(stackPosition + 1);
	var popup = createTiddlyElement(document.body, elem || "ol", "popup", className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({ root: root, popup: popup });
	return popup;
};

Popup.onDocumentClick = function(ev) {
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign, halign, offset) {
	var curr = Popup.stack[Popup.stack.length - 1];
	this.place(curr.root, curr.popup, valign, halign, offset);
	jQuery(curr.root).addClass("highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0, ensureVisible(curr.popup));
};

Popup.place = function(root, popup, valign, halign, offset) {
	if(!offset)
		offset = { x: 0, y: 0 };
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth * 0.75)
		popup.style.width = winWidth * 0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e) {
	var i, pos = -1;
	for(i = this.stack.length - 1; i >= 0; i--) {
		if(isDescendant(e, this.stack[i].popup))
			pos = i;
	}
	return pos;
};

Popup.remove = function(pos) {
	if(!pos) pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from) {
	for(var i = Popup.stack.length - 1; i >= from; i--) {
		var p = Popup.stack[i];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0, from);
};

//--
//-- Wizard support
//--

function Wizard(place) {
	if(place) {
		this.formElem = findRelated(place, "wizard", "className");
		this.bodyElem = findRelated(this.formElem.firstChild, "wizardBody", "className", "nextSibling");
		this.footElem = findRelated(this.formElem.firstChild, "wizardFooter", "className", "nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name, value) {
	jQuery(this.formElem).data(name, value);
};

Wizard.prototype.getValue = function(name) {
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

Wizard.prototype.createWizard = function(place, title) {
	this.formElem = createTiddlyElement(place, "form", null, "wizard");
	createTiddlyElement(this.formElem, "h1", null, "wizard__title", title);
	this.bodyElem = createTiddlyElement(this.formElem, "div", null, "wizardBody");
	this.footElem = createTiddlyElement(this.formElem, "div", null, "wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function() {
	jQuery(this.bodyElem).empty();
};

Wizard.prototype.setButtons = function(buttonInfo, status) {
	jQuery(this.footElem).empty();
	for(var i = 0; i < buttonInfo.length; i++) {
		createTiddlyButton(this.footElem, buttonInfo[i].caption, buttonInfo[i].tooltip, buttonInfo[i].onClick);
		insertSpacer(this.footElem);
	}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem, "span", null, "status").innerHTML = status;
	}
};

Wizard.prototype.addStep = function(stepTitle, htmlString) {
	jQuery(this.bodyElem).empty();
	var wrapper = createTiddlyElement(this.bodyElem, "div");
	createTiddlyElement(wrapper, "h2", null, "wizard__subtitle", stepTitle);
	var step = createTiddlyElement(wrapper, "div", null, "wizardStep");
	step.innerHTML = htmlString;
	applyHtmlMacros(step, tiddler);
};

Wizard.prototype.getElement = function(name) {
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place, listObject, listTemplate, callback, className) {
	var table = createTiddlyElement(place, "table", null, className || "listView twtable");

	var thead = createTiddlyElement(table, "thead");
	var i, row = createTiddlyElement(thead, "tr");
	for(i = 0; i < listTemplate.columns.length; i++) {
		var columnTemplate = listTemplate.columns[i];
		var cell = createTiddlyElement(row, "th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(cell, columnTemplate, i);
			if(columnTemplate.className)
				jQuery(cell).addClass(columnTemplate.className);
		}
	}

	var rc, tbody = createTiddlyElement(table, "tbody");
	for(rc = 0; rc < listObject.length; rc++) {
		var rowObject = listObject[rc];
		row = createTiddlyElement(tbody, "tr");
		for(i = 0; i < listTemplate.rowClasses.length; i++) {
			if(rowObject[listTemplate.rowClasses[i].field])
				jQuery(row).addClass(listTemplate.rowClasses[i].className);
		}
		rowObject.rowElement = row;
		rowObject.colElements = {};
		for(i = 0; i < listTemplate.columns.length; i++) {
			cell = createTiddlyElement(row, "td");
			columnTemplate = listTemplate.columns[i];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(cell, rowObject, field, columnTemplate, i, rc);
				if(columnTemplate.className)
					jQuery(cell).addClass(columnTemplate.className);
			}
			rowObject.colElements[field] = cell;
		}
	}

	if(callback && listTemplate.actions)
		createTiddlyDropDown(place, ListView.getCommandHandler(callback), listTemplate.actions);

	if(callback && listTemplate.buttons) {
		for(i = 0; i < listTemplate.buttons.length; i++) {
			var b = listTemplate.buttons[i];
			if(b && b.name != "") createTiddlyButton(place, b.caption, null,
				ListView.getCommandHandler(callback, b.name, b.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback, name, allowEmptySelection) {
	return function(e) {
		var view = findRelated(this, "TABLE", null, "previousSibling");
		var tiddlers = ListView.getSelectedRows(view);
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view, this.value, tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view, name, tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view, callback) {
	var checkboxes = view.getElementsByTagName("input");
	var i, hadOne = false;
	for(i = 0; i < checkboxes.length; i++) {
		var cb = checkboxes[i];
		var rowName = cb.getAttribute("rowName");
		if(cb.getAttribute("type") != "checkbox" || !rowName) continue;
		callback(cb, rowName);
		hadOne = true;
	}
	return hadOne;
};

ListView.getSelectedRows = function(view) {
	var rowNames = [];
	ListView.forEachSelector(view, function(e, rowName) {
		if(e.checked) rowNames.push(rowName);
	});
	return rowNames;
};

// describes filling cells of a column of each type, a map of typeName => { createHeader, createItem }
ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyText(place, columnTemplate.title);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v);
	}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			wikify(v, place, null, null);
	}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined && v.title)
			createTiddlyPopup(place, v.title, config.messages.listView.tiddlerTooltip, v);
	}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var i = 0, msg = config.messages.sizeTemplates;
		while(i < msg.length - 1 && v < msg[i].unit)
			i++;
		createTiddlyText(place, msg[i].template.format([Math.round(v / msg[i].unit)]));
	}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		var c = columnTemplate.text;
		if(v != undefined) createExternalLink(place, v, c || v);
	}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v.formatString(columnTemplate.dateFormat));
	}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		for(var i = 0; i < v.length; i++) {
			createTiddlyText(place, v[i]);
			createTiddlyElement(place, "br");
		}
	}
};

ListView.columnTypes.Selector = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyCheckbox(place, null, false, this.onHeaderChange);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], null);
		e.setAttribute("rowName", listObject[columnTemplate.rowName]);
	},
	onHeaderChange: function(e) {
		var state = this.checked;
		var view = findRelated(this, "TABLE");
		if(!view) return;
		ListView.forEachSelector(view, function(e, rowName) {
			e.checked = state;
		});
	}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var tags = listObject[field];
		createTiddlyText(place, String.encodeTiddlyLinkList(tags));
	}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		if(listObject[field] == true)
			createTiddlyText(place, columnTemplate.trueText);
		if(listObject[field] == false)
			createTiddlyText(place, columnTemplate.falseText);
	}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], this.onChange);
		e.setAttribute("tiddler", listObject.title);
		e.setAttribute("tag", columnTemplate.tag);
	},
	onChange: function(e) {
		var tag = this.getAttribute("tag");
		var tiddler = this.getAttribute("tiddler");
		store.setTiddlerTag(tiddler, this.checked, tag);
	}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var link = createTiddlyLink(place, listObject[columnTemplate.tiddlerLink], false, null);
		createTiddlyText(link, listObject[field]);
	}
};

//--
//-- Augmented methods for the JavaScript Array() object
//--

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field, value) {
	for(var i = 0; i < this.length; i++) {
		if(this[i][field] === value) return i;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item) {
	return this.indexOf(item) != -1;
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array.
// If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item, unique) {
	if(unique === false || this.indexOf(item) == -1) {
		this.push(item);
	}
};

Array.prototype.remove = function(item) {
	var p = this.indexOf(item);
	if(p != -1) this.splice(p, 1);
};

//--
//-- Augmented methods for the JavaScript String() object
//--

// todo: create functions substituting String augmenting methods, use in the core; deprecate all String augmenting methods

// Trim whitespace from both ends of a string
String.prototype.trim = function() {
	return this.replace(/^\s*|\s*$/g, "");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s) {
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match, r = [];
	while(match = subRegExp.exec(this)) {
		if(!match[1]) continue;
		if(match.index > currPos)
			r.push(this.substring(currPos, match.index));
		r.push(substrings[parseInt(match[1], 10)]);
		currPos = subRegExp.lastIndex;
	}
	if(currPos < this.length)
		r.push(this.substring(currPos, this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function() {
	return this.replace(/[\-\/\\\^\$\*\+\?\.\(\)\|\[\]\{\}]/g, '\\$&'); // #157
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function() {
	return this.replace(/\\/mg, "\\s").replace(/\n/mg, "\\n").replace(/\r/mg, "");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function() {
	return this.replace(/\\n/mg, "\n").replace(/\\b/mg, " ").replace(/\\s/mg, "\\").replace(/\r/mg, "");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function() {
	return this.replace(/&/mg, "&amp;").replace(/</mg, "&lt;").replace(/>/mg, "&gt;").replace(/\"/mg, "&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function() {
	return this.replace(/&lt;/mg, "<").replace(/&gt;/mg, ">").replace(/&quot;/mg, "\"").replace(/&amp;/mg, "&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName, defaultValue, allowEval, noNames, cascadeDefaults) {
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" +
		dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token, "mg") :
		new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?", "mg");

	var parseToken = function(match, p) {
		// Double quoted
		if(match[p])     return match[p].replace(/\\"/g, '"');
		// Single quoted
		if(match[p + 1]) return match[p + 1].replace(/\\'/g, "'");
		// Double-square-bracket quoted
		if(match[p + 2]) return match[p + 2];
		// Double-brace quoted
		if(match[p + 3]) {
			var value = match[p + 3];
			if(allowEval && config.evaluateMacroParameters != "none") {
				try {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) value = window.restrictedEval(value);
					} else {
						value = window.eval(value);
					}
				} catch(ex) {
					throw "Unable to evaluate {{" + value + "}}: " + exceptionText(ex);
				}
			}
			return value;
		}
		// Unquoted
		if(match[p + 4]) return match[p + 4];
		// Empty quote
		if(match[p + 5]) return "";
	};

	var summary = {};
	var results = [summary], match;
	while(match = re.exec(this)) {
		// matched bit is like  firstToken  or  firstToken:tokenAfterColon  (like "param":{{evaluated expression}})
		var firstToken = parseToken(match, 1);
		if(noNames) {
			results.push({ name: "", value: firstToken });
			continue;
		}

		var tokenAfterColon = parseToken(match, 8);
		var newItem = {
			name: firstToken,
			value: tokenAfterColon
		};
		if(newItem.value == null) {
			if(defaultName) {
				newItem.value = firstToken;
				newItem.name = defaultName;
			}
			else if(defaultValue) newItem.value = defaultValue;
		}

		results.push(newItem);
		if(cascadeDefaults) {
			defaultName = newItem.name;
			defaultValue = newItem.value;
		}
	}

	for(var i = 1; i < results.length; i++) {
		var name = results[i].name;
		var value = results[i].value;
		if(!summary[name])
			summary[name] = [value];
		else
			summary[name].push(value);
	}
	return results;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval) {
	var p = this.parseParams("list", null, !notAllowEval, true);
	return p.slice(1).map(function(param) { return param.value });
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique) {
	var p = this.parseParams("list", null, false, true);
	var i, n = [];
	for(i = 1; i < p.length; i++) {
		if(p[i].value)
			n.pushUnique(p[i].value, unique);
	}
	return n;
};

// Get [startIndex, endIndex] of chunk between given startMarker and endMarker inside text, or undefined.
tw.textUtils.getChunkRange = function(text, startMarker, endMarker) {
	var s = text.indexOf(startMarker);
	if(s == -1) return;
	s += startMarker.length;
	var e = text.indexOf(endMarker, s);
	if(e != -1) return [s, e];
};

// Replace a chunk of a string given start and end markers
tw.textUtils.replaceChunk = function(text, startMarker, endMarker, newValue) {
	var r = this.getChunkRange(text, startMarker, endMarker);
	return r ? text.substring(0, r[0]) + newValue + text.substring(r[1]) : text;
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title) {
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list) {
	if(!list) return "";
	return list.map(function(item) { return String.encodeTiddlyLink(item) }).join(" ");
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function() {
	var fields = this.parseParams("anon", "", false);
	var i, hashmap = {};
	for(i = 1; i < fields.length; i++)
		hashmap[fields[i].name] = fields[i].value;
	return hashmap;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap) {
	var name, r = [];
	for(name in hashmap)
		r.push(name + ':"' + hashmap[name] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n, width) {
	var s = n.toString();
	if(s.length >= width) return s;
	return "000000000000000000000000000".substring(0, width - s.length) + s;
};

String.prototype.startsWith = function(prefix) {
	return !prefix || this.substring(0, prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params, name, defaultValue) {
	if(!params) return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params, name, defaultValue) {
	return !!getParam(params, name, defaultValue);
}

//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template) {
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	var t = template
		.replace(/0hh12/g, String.zeroPad(this.getHours12(), 2))
		.replace(/hh12/g, this.getHours12())
		.replace(/0hh/g, String.zeroPad(this.getHours(), 2))
		.replace(/hh/g, this.getHours())
		.replace(/mmm/g, config.messages.dates.shortMonths[this.getMonth()])
		.replace(/0mm/g, String.zeroPad(this.getMinutes(), 2))
		.replace(/mm/g, this.getMinutes())
		.replace(/0ss/g, String.zeroPad(this.getSeconds(), 2))
		.replace(/ss/g, this.getSeconds())
		.replace(/[ap]m/g, this.getAmPm().toLowerCase())
		.replace(/[AP]M/g, this.getAmPm().toUpperCase())
		.replace(/wYYYY/g, this.getYearForWeekNo())
		.replace(/wYY/g, String.zeroPad(this.getYearForWeekNo() - 2000, 2))
		.replace(/YYYY/g, this.getFullYear())
		.replace(/YY/g, String.zeroPad(this.getFullYear() - 2000, 2))
		.replace(/MMM/g, config.messages.dates.months[this.getMonth()])
		.replace(/0MM/g, String.zeroPad(this.getMonth() + 1, 2))
		.replace(/MM/g, this.getMonth() + 1)
		.replace(/0WW/g, String.zeroPad(this.getWeek(), 2))
		.replace(/WW/g, this.getWeek())
		.replace(/DDD/g, config.messages.dates.days[this.getDay()])
		.replace(/ddd/g, config.messages.dates.shortDays[this.getDay()])
		.replace(/0DD/g, String.zeroPad(this.getDate(), 2))
		.replace(/DDth/g, this.getDate() + this.daySuffix())
		.replace(/DD/g, this.getDate())
		.replace(/TZD/g, (tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60), 2) +
			':' + String.zeroPad(atz % 60, 2))
		.replace(/\\/g, "");
	return t;
};

Date.prototype.getWeek = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week to calculate weekNo
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	var n = Math.floor((dt.getTime() - new Date(dt.getFullYear(), 0, 1) + 3600000) / 86400000);
	return Math.floor(n / 7) + 1;
};

Date.prototype.getYearForWeekNo = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	return dt.getFullYear();
};

Date.prototype.getHours12 = function() {
	var h = this.getHours();
	return h > 12 ? h - 12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function() {
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function() {
	return config.messages.dates.daySuffixes[this.getDate() - 1];
};

// Convert to local YYYYMMDDHHMM format string
Date.prototype.convertToLocalYYYYMMDDHHMM = function() {
	return this.getFullYear() + String.zeroPad(this.getMonth() + 1, 2) + String.zeroPad(this.getDate(), 2) +
		String.zeroPad(this.getHours(), 2) + String.zeroPad(this.getMinutes(), 2);
};

// Convert to UTC YYYYMMDDHHMM format string
Date.prototype.convertToYYYYMMDDHHMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) + String.zeroPad(this.getUTCDate(), 2) +
		String.zeroPad(this.getUTCHours(), 2) + String.zeroPad(this.getUTCMinutes(), 2);
};

// Convert to UTC YYYYMMDD.HHMMSSMMM format string
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) +
		String.zeroPad(this.getUTCDate(), 2) + "." + String.zeroPad(this.getUTCHours(), 2) +
		String.zeroPad(this.getUTCMinutes(), 2) + String.zeroPad(this.getUTCSeconds(), 2) +
		String.zeroPad(this.getUTCMilliseconds(), 3) + "0";
};

// Static. Create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 12));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 14));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0, 4), 10),
		parseInt(d.substr(4, 2), 10) - 1,
		parseInt(d.substr(6, 2), 10),
		parseInt(d.substr(8, 2) || "00", 10),
		parseInt(d.substr(10, 2) || "00", 10),
		parseInt(d.substr(12, 2) || "00", 10),
		parseInt(d.substr(14, 3) || "000", 10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r, g, b) {
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0, 1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1, 2), 16) / 255;
				this.g = parseInt(r.substr(3, 2), 16) / 255;
				this.b = parseInt(r.substr(5, 2), 16) / 255;
			} else {
				this.r = parseInt(r.substr(1, 1), 16) / 15;
				this.g = parseInt(r.substr(2, 1), 16) / 15;
				this.b = parseInt(r.substr(3, 1), 16) / 15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1], 10) / 255;
				this.g = parseInt(c[2], 10) / 255;
				this.b = parseInt(c[3], 10) / 255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c, f) {
	return new RGB(this.r + (c.r - this.r) * f, this.g + (c.g - this.g) * f, this.b + (c.b - this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function() {
	var to255Range = function(value) {
		var clamped = value < 0 ? 0 : value > 1 ? 1 : value;
		return clamped * 255;
	};

	var to2DigitString = function(value) {
		var s = Math.floor(value).toString(16);
		return ("0" + s).slice(-2);
	};

	return "#" +
		to2DigitString(to255Range(this.r)) +
		to2DigitString(to255Range(this.g)) +
		to2DigitString(to255Range(this.b));
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

tw.assets.icons.closeSvg =
	'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" class="tw-icon">' +
	'	<line x1="1" y1="1" x2="9" y2="9" rx="1" ry="1"/>' +
	'	<line x1="9" y1="1" x2="1" y2="9" rx="1" ry="1"/>' +
	'</svg>';

function drawGradient(place, horiz, loColors, hiColors) {
	if(!hiColors) hiColors = loColors;

	for(var i = 0; i <= 100; i += 2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? i + "%" : 0;
		bar.style.top = horiz ? 0 : i + "%";
		bar.style.width = horiz ? (101 - i) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101 - i) + "%";
		bar.style.zIndex = -1;
		var p = i / 100 * (loColors.length - 1);
		var hc = hiColors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = loColors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc, p - Math.floor(p)).toString();
	}
}

function addEvent(obj, type, fn) {
	if(obj.attachEvent) {
		obj["e" + type + fn] = fn;
		obj[type + fn] = function() { obj["e" + type + fn](window.event) };
		obj.attachEvent("on" + type, obj[type + fn]);
	} else {
		obj.addEventListener(type, fn, false);
	}
}

function removeEvent(obj, type, fn) {
	if(obj.detachEvent) {
		obj.detachEvent("on" + type, obj[type + fn]);
		obj[type + fn] = null;
	} else {
		obj.removeEventListener(type, fn, false);
	}
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e, value, name, relative) {
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !jQuery(e).hasClass(value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e) {
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth() {
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight() {
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
	var d = document;
	return Math.max(
		Math.max(d.body.scrollHeight, d.documentElement.scrollHeight),
		Math.max(d.body.offsetHeight, d.documentElement.offsetHeight),
		Math.max(d.body.clientHeight, d.documentElement.clientHeight)
	);
}

// Get the current horizontal page scroll position
function findScrollX() {
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY() {
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj) {
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj) {
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

function blurElement(e) {
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place) {
	var e = document.createTextNode(String.fromCharCode(160));
	if(place) place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e, text) {
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0, e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length, oldpos + text.length);
		// scroll into view
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0, e.selectionStart).split("\n").length - 1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) { // support IE
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e, pos) {
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) { // support IE
		e.focus();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character', pos);
		sel.moveEnd('character', 0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e) {
	var text = "";
	while(e && e.nodeName == "#text") {
		text += e.nodeValue;
		e = e.nextSibling;
	}
	return text;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e, ancestor) {
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e) {
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e) {
	if(!config.browser.isIE) return;
	var att = e.attributes;
	if(att) {
		for(var i = 0; i < att.length; i++) {
			var n = att[i].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s, id, doc) {
	jQuery.twStylesheet(s, { id: id, doc: doc });
}

function removeStyleSheet(id) {
	jQuery.twStylesheet.remove({ id: id });
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store, node, tiddlers) {
	var title = this.getTitle(store, node);
	if(!title) return;
	if(safeMode && store.isShadowTiddler(title)) return;

	var tiddler = store.createTiddler(title);
	this.internalizeTiddler(store, tiddler, title, node);
	tiddlers.push(tiddler);
};

LoaderBase.prototype.loadTiddlers = function(store, nodes) {
	var i, tiddlers = [];
	for(i = 0; i < nodes.length; i++) {
		try {
			this.loadTiddler(store, nodes[i], tiddlers);
		} catch(ex) {
			showException(ex, config.messages.tiddlerLoadError.format([this.getTitle(store, nodes[i])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store) {
	var results = [];
	var i, tiddlers = store.getTiddlers("title");
	for(i = 0; i < tiddlers.length; i++) {
		if(!tiddlers[i].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[i]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store, node) {
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title") || node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var prefixLen = store.idPrefix.length;
		if(node.id.substr(0, prefixLen) == store.idPrefix)
			title = node.id.substr(prefixLen);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store, tiddler, title, node) {
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute && node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName != "PRE" && e.nodeName != "pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg, "").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var i, attrs = node.attributes;
	for(i = attrs.length - 1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title, text, modifier, modified, tags, created, fields, creator);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store, tiddler) {
	try {
		var usePre = config.options.chkUsePreForStorage;
		var created = tiddler.created;
		var modified = tiddler.modified;
		var tags = tiddler.getTags();
		var attributes =
			(tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "") +
			(tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "") +
			((usePre && created == version.date) ? "" : ' created="' + created.convertToYYYYMMDDHHMM() + '"') +
			((usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() + '"') +
			((!usePre || tags) ? ' tags="' + tags.htmlEncode() + '"' : "");
		var extendedAttributes = "";
		store.forEachField(tiddler, function(tiddler, fieldName, value) {
			if(typeof value != "string")
				value = "";
			// don't store fields from the temp namespace
			if(!fieldName.match(/^temp\./))
				extendedAttributes += ' %0="%1"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);
		}, true);
		return ('<div %0="%1"%2%3>%4</' + 'div>').format([
			usePre ? "title" : "tiddler",
			tiddler.title.htmlEncode(),
			attributes,
			extendedAttributes,
			usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
		]);
	} catch (ex) {
		throw exceptionText(ex, config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};



//]]>
</script>

<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output, this.element), this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead, "mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE) text = text.replace(/\n/g, "\r");
		createTiddlyElement(w.output, "pre", null, null, text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br = {};
config.macros.br.handler = function(place)
{
	createTiddlyElement(place, "br");
};

// Find an item in an array. If a predicate is provided, use the native Array.find (return the item);
// otherwise (for backwards compatibility) treat the argument as an item to find (return the index or null)
// @Deprecated: Use indexOf instead
Array.prototype.orig_find = Array.prototype.find;
Array.prototype.find = function(itemOrPredicate)
{
	if(itemOrPredicate instanceof Function) return Array.prototype.orig_find.apply(this, arguments);
	var i = this.indexOf(itemOrPredicate);
	return i == -1 ? null : i;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
// @Deprecated: No direct substitution
Array.prototype.setItem = function(value, mode)
{
	var i = this.indexOf(value);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) this.push(value);
	} else if(mode == -1) {
		if(i != -1) this.splice(i, 1);
	}
};

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.map) {
	Array.prototype.map = function(fn, thisObj)
	{
		var scope = thisObj || window;
		var i, j, a = [];
		for(i = 0, j = this.length; i < j; ++i) {
			a.push(fn.call(scope, this[i], i, this));
		}
		return a;
	};
}

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(item, from)
	{
		if(!from) from = 0;
		for(var i = from; i < this.length; i++) {
			if(this[i] === item) return i;
		}
		return -1;
	};
}

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef, title)
{
	return store.getLoader().internalizeTiddler(store, this, title, divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated: Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store, this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement, titles, template, unused1, unused2, animate, unused3)
{
	story.displayTiddlers(srcElement, titles, template, animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement, title, template, unused1, unused2, animate, unused3)
{
	story.displayTiddler(srcElement, title, template, animate);
}

// @Deprecated: Java IO is no longer supported;
// these "empty" versions are only left for the tiny chance of backwards
// compatibility issues and will be removed completely in the future
function javaSaveFile(filePath, content)
{
	return null;
}

function javaLoadFile(filePath)
{
	return null;
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n", "mg");
var regexpBackSlash = new RegExp("\\\\", "mg");
var regexpBackSlashEss = new RegExp("\\\\s", "mg");
var regexpNewLine = new RegExp("\n", "mg");
var regexpCarriageReturn = new RegExp("\r", "mg");

//--
//-- Deprecated FileAdaptor functions
//--

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"':  '\\"',
		'\\': '\\\\'
	};
	var replaceFn = function(a, b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
	};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g, replaceFn) + '"';
	return '"' + this + '"';
};

// @Deprecated: no direct replacement, since not used in core code
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length - n) : this;
};

// @Deprecated: no direct replacement, since not used in core code (see unDash in inlineCssHelper)
// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var i, words = this.split("-");
	for(i = 1; i < words.length; i++)
		words[i] = words[i].substring(0, 1).toUpperCase() + words[i].substring(1);
	return words.join("");
};

// @Deprecated: use tw.textUtils.getChunkRange instead
String.prototype.getChunkRange = function(startMarker, endMarker)
{
	return tw.textUtils.getChunkRange(this, startMarker, endMarker);
};

// @Deprecated: no direct replacement, since not used in core code
// Get a chunk of a string between startMarker and endMarker, or undefined
String.prototype.getChunk = function(startMarker, endMarker)
{
	var r = tw.textUtils.getChunkRange(this, startMarker, endMarker);
	if(r) return this.substring(r[0], r[1]);
};

// @Deprecated: use tw.textUtils.replaceChunk instead
String.prototype.replaceChunk = function(startMarker, endMarker, newValue)
{
	return tw.textUtils.replaceChunk(this, startMarker, endMarker, newValue);
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//--
//-- Deprecated Number functions
//--

// @Deprecated: no direct replacement, since not used in core code
// Clamp a number to a range
Number.prototype.clamp = function(min, max)
{
	var c = this;
	if(c < min) c = min;
	if(c > max) c = max;
	return Number(c);
};

//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Remove a node and all its children
function removeNode(e)
{
	jQuery(e).remove();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

function addClass(e, className)
{
	jQuery(e).addClass(className);
}

function removeClass(e, className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e, className)
{
	return jQuery(e).hasClass(className);
}

//--
//-- Deprecated Wikifier code
//--

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}


//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*! jQuery v1.9.1 | (c) 2005, 2012 jQuery Foundation, Inc. | jquery.org/license
//@ sourceMappingURL=jquery.min.map
*/(function(e,t){var n,r,i=typeof t,o=e.document,a=e.location,s=e.jQuery,u=e.$,l={},c=[],p="1.9.1",f=c.concat,d=c.push,h=c.slice,g=c.indexOf,m=l.toString,y=l.hasOwnProperty,v=p.trim,b=function(e,t){return new b.fn.init(e,t,r)},x=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,w=/\S+/g,T=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,N=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,k=/^[\],:{}\s]*$/,E=/(?:^|:|,)(?:\s*\[)+/g,S=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,A=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,j=/^-ms-/,D=/-([\da-z])/gi,L=function(e,t){return t.toUpperCase()},H=function(e){(o.addEventListener||"load"===e.type||"complete"===o.readyState)&&(q(),b.ready())},q=function(){o.addEventListener?(o.removeEventListener("DOMContentLoaded",H,!1),e.removeEventListener("load",H,!1)):(o.detachEvent("onreadystatechange",H),e.detachEvent("onload",H))};b.fn=b.prototype={jquery:p,constructor:b,init:function(e,n,r){var i,a;if(!e)return this;if("string"==typeof e){if(i="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:N.exec(e),!i||!i[1]&&n)return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e);if(i[1]){if(n=n instanceof b?n[0]:n,b.merge(this,b.parseHTML(i[1],n&&n.nodeType?n.ownerDocument||n:o,!0)),C.test(i[1])&&b.isPlainObject(n))for(i in n)b.isFunction(this[i])?this[i](n[i]):this.attr(i,n[i]);return this}if(a=o.getElementById(i[2]),a&&a.parentNode){if(a.id!==i[2])return r.find(e);this.length=1,this[0]=a}return this.context=o,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):b.isFunction(e)?r.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),b.makeArray(e,this))},selector:"",length:0,size:function(){return this.length},toArray:function(){return h.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=b.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return b.each(this,e,t)},ready:function(e){return b.ready.promise().done(e),this},slice:function(){return this.pushStack(h.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},map:function(e){return this.pushStack(b.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:d,sort:[].sort,splice:[].splice},b.fn.init.prototype=b.fn,b.extend=b.fn.extend=function(){var e,n,r,i,o,a,s=arguments[0]||{},u=1,l=arguments.length,c=!1;for("boolean"==typeof s&&(c=s,s=arguments[1]||{},u=2),"object"==typeof s||b.isFunction(s)||(s={}),l===u&&(s=this,--u);l>u;u++)if(null!=(o=arguments[u]))for(i in o)e=s[i],r=o[i],s!==r&&(c&&r&&(b.isPlainObject(r)||(n=b.isArray(r)))?(n?(n=!1,a=e&&b.isArray(e)?e:[]):a=e&&b.isPlainObject(e)?e:{},s[i]=b.extend(c,a,r)):r!==t&&(s[i]=r));return s},b.extend({noConflict:function(t){return e.$===b&&(e.$=u),t&&e.jQuery===b&&(e.jQuery=s),b},isReady:!1,readyWait:1,holdReady:function(e){e?b.readyWait++:b.ready(!0)},ready:function(e){if(e===!0?!--b.readyWait:!b.isReady){if(!o.body)return setTimeout(b.ready);b.isReady=!0,e!==!0&&--b.readyWait>0||(n.resolveWith(o,[b]),b.fn.trigger&&b(o).trigger("ready").off("ready"))}},isFunction:function(e){return"function"===b.type(e)},isArray:Array.isArray||function(e){return"array"===b.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[m.call(e)]||"object":typeof e},isPlainObject:function(e){if(!e||"object"!==b.type(e)||e.nodeType||b.isWindow(e))return!1;try{if(e.constructor&&!y.call(e,"constructor")&&!y.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}var r;for(r in e);return r===t||y.call(e,r)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||o;var r=C.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=b.buildFragment([e],t,i),i&&b(i).remove(),b.merge([],r.childNodes))},parseJSON:function(n){return e.JSON&&e.JSON.parse?e.JSON.parse(n):null===n?n:"string"==typeof n&&(n=b.trim(n),n&&k.test(n.replace(S,"@").replace(A,"]").replace(E,"")))?Function("return "+n)():(b.error("Invalid JSON: "+n),t)},parseXML:function(n){var r,i;if(!n||"string"!=typeof n)return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(o){r=t}return r&&r.documentElement&&!r.getElementsByTagName("parsererror").length||b.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&&b.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(j,"ms-").replace(D,L)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var r,i=0,o=e.length,a=M(e);if(n){if(a){for(;o>i;i++)if(r=t.apply(e[i],n),r===!1)break}else for(i in e)if(r=t.apply(e[i],n),r===!1)break}else if(a){for(;o>i;i++)if(r=t.call(e[i],i,e[i]),r===!1)break}else for(i in e)if(r=t.call(e[i],i,e[i]),r===!1)break;return e},trim:v&&!v.call("\ufeff\u00a0")?function(e){return null==e?"":v.call(e)}:function(e){return null==e?"":(e+"").replace(T,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(M(Object(e))?b.merge(n,"string"==typeof e?[e]:e):d.call(n,e)),n},inArray:function(e,t,n){var r;if(t){if(g)return g.call(t,e,n);for(r=t.length,n=n?0>n?Math.max(0,r+n):n:0;r>n;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,o=0;if("number"==typeof r)for(;r>o;o++)e[i++]=n[o];else while(n[o]!==t)e[i++]=n[o++];return e.length=i,e},grep:function(e,t,n){var r,i=[],o=0,a=e.length;for(n=!!n;a>o;o++)r=!!t(e[o],o),n!==r&&i.push(e[o]);return i},map:function(e,t,n){var r,i=0,o=e.length,a=M(e),s=[];if(a)for(;o>i;i++)r=t(e[i],i,n),null!=r&&(s[s.length]=r);else for(i in e)r=t(e[i],i,n),null!=r&&(s[s.length]=r);return f.apply([],s)},guid:1,proxy:function(e,n){var r,i,o;return"string"==typeof n&&(o=e[n],n=e,e=o),b.isFunction(e)?(r=h.call(arguments,2),i=function(){return e.apply(n||this,r.concat(h.call(arguments)))},i.guid=e.guid=e.guid||b.guid++,i):t},access:function(e,n,r,i,o,a,s){var u=0,l=e.length,c=null==r;if("object"===b.type(r)){o=!0;for(u in r)b.access(e,n,u,r[u],!0,a,s)}else if(i!==t&&(o=!0,b.isFunction(i)||(s=!0),c&&(s?(n.call(e,i),n=null):(c=n,n=function(e,t,n){return c.call(b(e),n)})),n))for(;l>u;u++)n(e[u],r,s?i:i.call(e[u],u,n(e[u],r)));return o?e:c?n.call(e):l?n(e[0],r):a},now:function(){return(new Date).getTime()}}),b.ready.promise=function(t){if(!n)if(n=b.Deferred(),"complete"===o.readyState)setTimeout(b.ready);else if(o.addEventListener)o.addEventListener("DOMContentLoaded",H,!1),e.addEventListener("load",H,!1);else{o.attachEvent("onreadystatechange",H),e.attachEvent("onload",H);var r=!1;try{r=null==e.frameElement&&o.documentElement}catch(i){}r&&r.doScroll&&function a(){if(!b.isReady){try{r.doScroll("left")}catch(e){return setTimeout(a,50)}q(),b.ready()}}()}return n.promise(t)},b.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){l["[object "+t+"]"]=t.toLowerCase()});function M(e){var t=e.length,n=b.type(e);return b.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}r=b(o);var _={};function F(e){var t=_[e]={};return b.each(e.match(w)||[],function(e,n){t[n]=!0}),t}b.Callbacks=function(e){e="string"==typeof e?_[e]||F(e):b.extend({},e);var n,r,i,o,a,s,u=[],l=!e.once&&[],c=function(t){for(r=e.memory&&t,i=!0,a=s||0,s=0,o=u.length,n=!0;u&&o>a;a++)if(u[a].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}n=!1,u&&(l?l.length&&c(l.shift()):r?u=[]:p.disable())},p={add:function(){if(u){var t=u.length;(function i(t){b.each(t,function(t,n){var r=b.type(n);"function"===r?e.unique&&p.has(n)||u.push(n):n&&n.length&&"string"!==r&&i(n)})})(arguments),n?o=u.length:r&&(s=t,c(r))}return this},remove:function(){return u&&b.each(arguments,function(e,t){var r;while((r=b.inArray(t,u,r))>-1)u.splice(r,1),n&&(o>=r&&o--,a>=r&&a--)}),this},has:function(e){return e?b.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],this},disable:function(){return u=l=r=t,this},disabled:function(){return!u},lock:function(){return l=t,r||p.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],!u||i&&!l||(n?l.push(t):c(t)),this},fire:function(){return p.fireWith(this,arguments),this},fired:function(){return!!i}};return p},b.extend({Deferred:function(e){var t=[["resolve","done",b.Callbacks("once memory"),"resolved"],["reject","fail",b.Callbacks("once memory"),"rejected"],["notify","progress",b.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return b.Deferred(function(n){b.each(t,function(t,o){var a=o[0],s=b.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&b.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[a+"With"](this===r?n.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?b.extend(e,r):r}},i={};return r.pipe=r.then,b.each(t,function(e,o){var a=o[2],s=o[3];r[o[1]]=a.add,s&&a.add(function(){n=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=a.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=h.call(arguments),r=n.length,i=1!==r||e&&b.isFunction(e.promise)?r:0,o=1===i?e:b.Deferred(),a=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?h.call(arguments):r,n===s?o.notifyWith(t,n):--i||o.resolveWith(t,n)}},s,u,l;if(r>1)for(s=Array(r),u=Array(r),l=Array(r);r>t;t++)n[t]&&b.isFunction(n[t].promise)?n[t].promise().done(a(t,l,n)).fail(o.reject).progress(a(t,u,s)):--i;return i||o.resolveWith(l,n),o.promise()}}),b.support=function(){var t,n,r,a,s,u,l,c,p,f,d=o.createElement("div");if(d.setAttribute("className","t"),d.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=d.getElementsByTagName("*"),r=d.getElementsByTagName("a")[0],!n||!r||!n.length)return{};s=o.createElement("select"),l=s.appendChild(o.createElement("option")),a=d.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t={getSetAttribute:"t"!==d.className,leadingWhitespace:3===d.firstChild.nodeType,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/top/.test(r.getAttribute("style")),hrefNormalized:"/a"===r.getAttribute("href"),opacity:/^0.5/.test(r.style.opacity),cssFloat:!!r.style.cssFloat,checkOn:!!a.value,optSelected:l.selected,enctype:!!o.createElement("form").enctype,html5Clone:"<:nav></:nav>"!==o.createElement("nav").cloneNode(!0).outerHTML,boxModel:"CSS1Compat"===o.compatMode,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},a.checked=!0,t.noCloneChecked=a.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!l.disabled;try{delete d.test}catch(h){t.deleteExpando=!1}a=o.createElement("input"),a.setAttribute("value",""),t.input=""===a.getAttribute("value"),a.value="t",a.setAttribute("type","radio"),t.radioValue="t"===a.value,a.setAttribute("checked","t"),a.setAttribute("name","t"),u=o.createDocumentFragment(),u.appendChild(a),t.appendChecked=a.checked,t.checkClone=u.cloneNode(!0).cloneNode(!0).lastChild.checked,d.attachEvent&&(d.attachEvent("onclick",function(){t.noCloneEvent=!1}),d.cloneNode(!0).click());for(f in{submit:!0,change:!0,focusin:!0})d.setAttribute(c="on"+f,"t"),t[f+"Bubbles"]=c in e||d.attributes[c].expando===!1;return d.style.backgroundClip="content-box",d.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===d.style.backgroundClip,b(function(){var n,r,a,s="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",u=o.getElementsByTagName("body")[0];u&&(n=o.createElement("div"),n.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",u.appendChild(n).appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",a=d.getElementsByTagName("td"),a[0].style.cssText="padding:0;margin:0;border:0;display:none",p=0===a[0].offsetHeight,a[0].style.display="",a[1].style.display="none",t.reliableHiddenOffsets=p&&0===a[0].offsetHeight,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",t.boxSizing=4===d.offsetWidth,t.doesNotIncludeMarginInBodyOffset=1!==u.offsetTop,e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(d,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(d,null)||{width:"4px"}).width,r=d.appendChild(o.createElement("div")),r.style.cssText=d.style.cssText=s,r.style.marginRight=r.style.width="0",d.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(r,null)||{}).marginRight)),typeof d.style.zoom!==i&&(d.innerHTML="",d.style.cssText=s+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=3===d.offsetWidth,d.style.display="block",d.innerHTML="<div></div>",d.firstChild.style.width="5px",t.shrinkWrapBlocks=3!==d.offsetWidth,t.inlineBlockNeedsLayout&&(u.style.zoom=1)),u.removeChild(n),n=d=a=r=null)}),n=s=u=l=r=a=null,t}();var O=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,B=/([A-Z])/g;function P(e,n,r,i){if(b.acceptData(e)){var o,a,s=b.expando,u="string"==typeof n,l=e.nodeType,p=l?b.cache:e,f=l?e[s]:e[s]&&s;if(f&&p[f]&&(i||p[f].data)||!u||r!==t)return f||(l?e[s]=f=c.pop()||b.guid++:f=s),p[f]||(p[f]={},l||(p[f].toJSON=b.noop)),("object"==typeof n||"function"==typeof n)&&(i?p[f]=b.extend(p[f],n):p[f].data=b.extend(p[f].data,n)),o=p[f],i||(o.data||(o.data={}),o=o.data),r!==t&&(o[b.camelCase(n)]=r),u?(a=o[n],null==a&&(a=o[b.camelCase(n)])):a=o,a}}function R(e,t,n){if(b.acceptData(e)){var r,i,o,a=e.nodeType,s=a?b.cache:e,u=a?e[b.expando]:b.expando;if(s[u]){if(t&&(o=n?s[u]:s[u].data)){b.isArray(t)?t=t.concat(b.map(t,b.camelCase)):t in o?t=[t]:(t=b.camelCase(t),t=t in o?[t]:t.split(" "));for(r=0,i=t.length;i>r;r++)delete o[t[r]];if(!(n?$:b.isEmptyObject)(o))return}(n||(delete s[u].data,$(s[u])))&&(a?b.cleanData([e],!0):b.support.deleteExpando||s!=s.window?delete s[u]:s[u]=null)}}}b.extend({cache:{},expando:"jQuery"+(p+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(e){return e=e.nodeType?b.cache[e[b.expando]]:e[b.expando],!!e&&!$(e)},data:function(e,t,n){return P(e,t,n)},removeData:function(e,t){return R(e,t)},_data:function(e,t,n){return P(e,t,n,!0)},_removeData:function(e,t){return R(e,t,!0)},acceptData:function(e){if(e.nodeType&&1!==e.nodeType&&9!==e.nodeType)return!1;var t=e.nodeName&&b.noData[e.nodeName.toLowerCase()];return!t||t!==!0&&e.getAttribute("classid")===t}}),b.fn.extend({data:function(e,n){var r,i,o=this[0],a=0,s=null;if(e===t){if(this.length&&(s=b.data(o),1===o.nodeType&&!b._data(o,"parsedAttrs"))){for(r=o.attributes;r.length>a;a++)i=r[a].name,i.indexOf("data-")||(i=b.camelCase(i.slice(5)),W(o,i,s[i]));b._data(o,"parsedAttrs",!0)}return s}return"object"==typeof e?this.each(function(){b.data(this,e)}):b.access(this,function(n){return n===t?o?W(o,e,b.data(o,e)):null:(this.each(function(){b.data(this,e,n)}),t)},null,n,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){b.removeData(this,e)})}});function W(e,n,r){if(r===t&&1===e.nodeType){var i="data-"+n.replace(B,"-$1").toLowerCase();if(r=e.getAttribute(i),"string"==typeof r){try{r="true"===r?!0:"false"===r?!1:"null"===r?null:+r+""===r?+r:O.test(r)?b.parseJSON(r):r}catch(o){}b.data(e,n,r)}else r=t}return r}function $(e){var t;for(t in e)if(("data"!==t||!b.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}b.extend({queue:function(e,n,r){var i;return e?(n=(n||"fx")+"queue",i=b._data(e,n),r&&(!i||b.isArray(r)?i=b._data(e,n,b.makeArray(r)):i.push(r)),i||[]):t},dequeue:function(e,t){t=t||"fx";var n=b.queue(e,t),r=n.length,i=n.shift(),o=b._queueHooks(e,t),a=function(){b.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),o.cur=i,i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return b._data(e,n)||b._data(e,n,{empty:b.Callbacks("once memory").add(function(){b._removeData(e,t+"queue"),b._removeData(e,n)})})}}),b.fn.extend({queue:function(e,n){var r=2;return"string"!=typeof e&&(n=e,e="fx",r--),r>arguments.length?b.queue(this[0],e):n===t?this:this.each(function(){var t=b.queue(this,e,n);b._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&b.dequeue(this,e)})},dequeue:function(e){return this.each(function(){b.dequeue(this,e)})},delay:function(e,t){return e=b.fx?b.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,o=b.Deferred(),a=this,s=this.length,u=function(){--i||o.resolveWith(a,[a])};"string"!=typeof e&&(n=e,e=t),e=e||"fx";while(s--)r=b._data(a[s],e+"queueHooks"),r&&r.empty&&(i++,r.empty.add(u));return u(),o.promise(n)}});var I,z,X=/[\t\r\n]/g,U=/\r/g,V=/^(?:input|select|textarea|button|object)$/i,Y=/^(?:a|area)$/i,J=/^(?:checked|selected|autofocus|autoplay|async|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped)$/i,G=/^(?:checked|selected)$/i,Q=b.support.getSetAttribute,K=b.support.input;b.fn.extend({attr:function(e,t){return b.access(this,b.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){b.removeAttr(this,e)})},prop:function(e,t){return b.access(this,b.prop,e,t,arguments.length>1)},removeProp:function(e){return e=b.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,o,a=0,s=this.length,u="string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).addClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):" ")){o=0;while(i=t[o++])0>r.indexOf(" "+i+" ")&&(r+=i+" ");n.className=b.trim(r)}return this},removeClass:function(e){var t,n,r,i,o,a=0,s=this.length,u=0===arguments.length||"string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).removeClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):"")){o=0;while(i=t[o++])while(r.indexOf(" "+i+" ")>=0)r=r.replace(" "+i+" "," ");n.className=e?b.trim(r):""}return this},toggleClass:function(e,t){var n=typeof e,r="boolean"==typeof t;return b.isFunction(e)?this.each(function(n){b(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if("string"===n){var o,a=0,s=b(this),u=t,l=e.match(w)||[];while(o=l[a++])u=r?u:!s.hasClass(o),s[u?"addClass":"removeClass"](o)}else(n===i||"boolean"===n)&&(this.className&&b._data(this,"__className__",this.className),this.className=this.className||e===!1?"":b._data(this,"__className__")||"")})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(X," ").indexOf(t)>=0)return!0;return!1},val:function(e){var n,r,i,o=this[0];{if(arguments.length)return i=b.isFunction(e),this.each(function(n){var o,a=b(this);1===this.nodeType&&(o=i?e.call(this,n,a.val()):e,null==o?o="":"number"==typeof o?o+="":b.isArray(o)&&(o=b.map(o,function(e){return null==e?"":e+""})),r=b.valHooks[this.type]||b.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))});if(o)return r=b.valHooks[o.type]||b.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(n=r.get(o,"value"))!==t?n:(n=o.value,"string"==typeof n?n.replace(U,""):null==n?"":n)}}}),b.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:r.length,u=0>i?s:o?i:0;for(;s>u;u++)if(n=r[u],!(!n.selected&&u!==i||(b.support.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&b.nodeName(n.parentNode,"optgroup"))){if(t=b(n).val(),o)return t;a.push(t)}return a},set:function(e,t){var n=b.makeArray(t);return b(e).find("option").each(function(){this.selected=b.inArray(b(this).val(),n)>=0}),n.length||(e.selectedIndex=-1),n}}},attr:function(e,n,r){var o,a,s,u=e.nodeType;if(e&&3!==u&&8!==u&&2!==u)return typeof e.getAttribute===i?b.prop(e,n,r):(a=1!==u||!b.isXMLDoc(e),a&&(n=n.toLowerCase(),o=b.attrHooks[n]||(J.test(n)?z:I)),r===t?o&&a&&"get"in o&&null!==(s=o.get(e,n))?s:(typeof e.getAttribute!==i&&(s=e.getAttribute(n)),null==s?t:s):null!==r?o&&a&&"set"in o&&(s=o.set(e,r,n))!==t?s:(e.setAttribute(n,r+""),r):(b.removeAttr(e,n),t))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(w);if(o&&1===e.nodeType)while(n=o[i++])r=b.propFix[n]||n,J.test(n)?!Q&&G.test(n)?e[b.camelCase("default-"+n)]=e[r]=!1:e[r]=!1:b.attr(e,n,""),e.removeAttribute(Q?n:r)},attrHooks:{type:{set:function(e,t){if(!b.support.radioValue&&"radio"===t&&b.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(e,n,r){var i,o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return a=1!==s||!b.isXMLDoc(e),a&&(n=b.propFix[n]||n,o=b.propHooks[n]),r!==t?o&&"set"in o&&(i=o.set(e,r,n))!==t?i:e[n]=r:o&&"get"in o&&null!==(i=o.get(e,n))?i:e[n]},propHooks:{tabIndex:{get:function(e){var n=e.getAttributeNode("tabindex");return n&&n.specified?parseInt(n.value,10):V.test(e.nodeName)||Y.test(e.nodeName)&&e.href?0:t}}}}),z={get:function(e,n){var r=b.prop(e,n),i="boolean"==typeof r&&e.getAttribute(n),o="boolean"==typeof r?K&&Q?null!=i:G.test(n)?e[b.camelCase("default-"+n)]:!!i:e.getAttributeNode(n);return o&&o.value!==!1?n.toLowerCase():t},set:function(e,t,n){return t===!1?b.removeAttr(e,n):K&&Q||!G.test(n)?e.setAttribute(!Q&&b.propFix[n]||n,n):e[b.camelCase("default-"+n)]=e[n]=!0,n}},K&&Q||(b.attrHooks.value={get:function(e,n){var r=e.getAttributeNode(n);return b.nodeName(e,"input")?e.defaultValue:r&&r.specified?r.value:t},set:function(e,n,r){return b.nodeName(e,"input")?(e.defaultValue=n,t):I&&I.set(e,n,r)}}),Q||(I=b.valHooks.button={get:function(e,n){var r=e.getAttributeNode(n);return r&&("id"===n||"name"===n||"coords"===n?""!==r.value:r.specified)?r.value:t},set:function(e,n,r){var i=e.getAttributeNode(r);return i||e.setAttributeNode(i=e.ownerDocument.createAttribute(r)),i.value=n+="","value"===r||n===e.getAttribute(r)?n:t}},b.attrHooks.contenteditable={get:I.get,set:function(e,t,n){I.set(e,""===t?!1:t,n)}},b.each(["width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{set:function(e,r){return""===r?(e.setAttribute(n,"auto"),r):t}})})),b.support.hrefNormalized||(b.each(["href","src","width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{get:function(e){var r=e.getAttribute(n,2);return null==r?t:r}})}),b.each(["href","src"],function(e,t){b.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}})),b.support.style||(b.attrHooks.style={get:function(e){return e.style.cssText||t},set:function(e,t){return e.style.cssText=t+""}}),b.support.optSelected||(b.propHooks.selected=b.extend(b.propHooks.selected,{get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}})),b.support.enctype||(b.propFix.enctype="encoding"),b.support.checkOn||b.each(["radio","checkbox"],function(){b.valHooks[this]={get:function(e){return null===e.getAttribute("value")?"on":e.value}}}),b.each(["radio","checkbox"],function(){b.valHooks[this]=b.extend(b.valHooks[this],{set:function(e,n){return b.isArray(n)?e.checked=b.inArray(b(e).val(),n)>=0:t}})});var Z=/^(?:input|select|textarea)$/i,et=/^key/,tt=/^(?:mouse|contextmenu)|click/,nt=/^(?:focusinfocus|focusoutblur)$/,rt=/^([^.]*)(?:\.(.+)|)$/;function it(){return!0}function ot(){return!1}b.event={global:{},add:function(e,n,r,o,a){var s,u,l,c,p,f,d,h,g,m,y,v=b._data(e);if(v){r.handler&&(c=r,r=c.handler,a=c.selector),r.guid||(r.guid=b.guid++),(u=v.events)||(u=v.events={}),(f=v.handle)||(f=v.handle=function(e){return typeof b===i||e&&b.event.triggered===e.type?t:b.event.dispatch.apply(f.elem,arguments)},f.elem=e),n=(n||"").match(w)||[""],l=n.length;while(l--)s=rt.exec(n[l])||[],g=y=s[1],m=(s[2]||"").split(".").sort(),p=b.event.special[g]||{},g=(a?p.delegateType:p.bindType)||g,p=b.event.special[g]||{},d=b.extend({type:g,origType:y,data:o,handler:r,guid:r.guid,selector:a,needsContext:a&&b.expr.match.needsContext.test(a),namespace:m.join(".")},c),(h=u[g])||(h=u[g]=[],h.delegateCount=0,p.setup&&p.setup.call(e,o,m,f)!==!1||(e.addEventListener?e.addEventListener(g,f,!1):e.attachEvent&&e.attachEvent("on"+g,f))),p.add&&(p.add.call(e,d),d.handler.guid||(d.handler.guid=r.guid)),a?h.splice(h.delegateCount++,0,d):h.push(d),b.event.global[g]=!0;e=null}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,p,f,d,h,g,m=b.hasData(e)&&b._data(e);if(m&&(c=m.events)){t=(t||"").match(w)||[""],l=t.length;while(l--)if(s=rt.exec(t[l])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d){p=b.event.special[d]||{},d=(r?p.delegateType:p.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),u=o=f.length;while(o--)a=f[o],!i&&g!==a.origType||n&&n.guid!==a.guid||s&&!s.test(a.namespace)||r&&r!==a.selector&&("**"!==r||!a.selector)||(f.splice(o,1),a.selector&&f.delegateCount--,p.remove&&p.remove.call(e,a));u&&!f.length&&(p.teardown&&p.teardown.call(e,h,m.handle)!==!1||b.removeEvent(e,d,m.handle),delete c[d])}else for(d in c)b.event.remove(e,d+t[l],n,r,!0);b.isEmptyObject(c)&&(delete m.handle,b._removeData(e,"events"))}},trigger:function(n,r,i,a){var s,u,l,c,p,f,d,h=[i||o],g=y.call(n,"type")?n.type:n,m=y.call(n,"namespace")?n.namespace.split("."):[];if(l=f=i=i||o,3!==i.nodeType&&8!==i.nodeType&&!nt.test(g+b.event.triggered)&&(g.indexOf(".")>=0&&(m=g.split("."),g=m.shift(),m.sort()),u=0>g.indexOf(":")&&"on"+g,n=n[b.expando]?n:new b.Event(g,"object"==typeof n&&n),n.isTrigger=!0,n.namespace=m.join("."),n.namespace_re=n.namespace?RegExp("(^|\\.)"+m.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,n.result=t,n.target||(n.target=i),r=null==r?[n]:b.makeArray(r,[n]),p=b.event.special[g]||{},a||!p.trigger||p.trigger.apply(i,r)!==!1)){if(!a&&!p.noBubble&&!b.isWindow(i)){for(c=p.delegateType||g,nt.test(c+g)||(l=l.parentNode);l;l=l.parentNode)h.push(l),f=l;f===(i.ownerDocument||o)&&h.push(f.defaultView||f.parentWindow||e)}d=0;while((l=h[d++])&&!n.isPropagationStopped())n.type=d>1?c:p.bindType||g,s=(b._data(l,"events")||{})[n.type]&&b._data(l,"handle"),s&&s.apply(l,r),s=u&&l[u],s&&b.acceptData(l)&&s.apply&&s.apply(l,r)===!1&&n.preventDefault();if(n.type=g,!(a||n.isDefaultPrevented()||p._default&&p._default.apply(i.ownerDocument,r)!==!1||"click"===g&&b.nodeName(i,"a")||!b.acceptData(i)||!u||!i[g]||b.isWindow(i))){f=i[u],f&&(i[u]=null),b.event.triggered=g;try{i[g]()}catch(v){}b.event.triggered=t,f&&(i[u]=f)}return n.result}},dispatch:function(e){e=b.event.fix(e);var n,r,i,o,a,s=[],u=h.call(arguments),l=(b._data(this,"events")||{})[e.type]||[],c=b.event.special[e.type]||{};if(u[0]=e,e.delegateTarget=this,!c.preDispatch||c.preDispatch.call(this,e)!==!1){s=b.event.handlers.call(this,e,l),n=0;while((o=s[n++])&&!e.isPropagationStopped()){e.currentTarget=o.elem,a=0;while((i=o.handlers[a++])&&!e.isImmediatePropagationStopped())(!e.namespace_re||e.namespace_re.test(i.namespace))&&(e.handleObj=i,e.data=i.data,r=((b.event.special[i.origType]||{}).handle||i.handler).apply(o.elem,u),r!==t&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,n){var r,i,o,a,s=[],u=n.delegateCount,l=e.target;if(u&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!=this;l=l.parentNode||this)if(1===l.nodeType&&(l.disabled!==!0||"click"!==e.type)){for(o=[],a=0;u>a;a++)i=n[a],r=i.selector+" ",o[r]===t&&(o[r]=i.needsContext?b(r,this).index(l)>=0:b.find(r,this,null,[l]).length),o[r]&&o.push(i);o.length&&s.push({elem:l,handlers:o})}return n.length>u&&s.push({elem:this,handlers:n.slice(u)}),s},fix:function(e){if(e[b.expando])return e;var t,n,r,i=e.type,a=e,s=this.fixHooks[i];s||(this.fixHooks[i]=s=tt.test(i)?this.mouseHooks:et.test(i)?this.keyHooks:{}),r=s.props?this.props.concat(s.props):this.props,e=new b.Event(a),t=r.length;while(t--)n=r[t],e[n]=a[n];return e.target||(e.target=a.srcElement||o),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,a):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,i,a,s=n.button,u=n.fromElement;return null==e.pageX&&null!=n.clientX&&(i=e.target.ownerDocument||o,a=i.documentElement,r=i.body,e.pageX=n.clientX+(a&&a.scrollLeft||r&&r.scrollLeft||0)-(a&&a.clientLeft||r&&r.clientLeft||0),e.pageY=n.clientY+(a&&a.scrollTop||r&&r.scrollTop||0)-(a&&a.clientTop||r&&r.clientTop||0)),!e.relatedTarget&&u&&(e.relatedTarget=u===e.target?n.toElement:u),e.which||s===t||(e.which=1&s?1:2&s?3:4&s?2:0),e}},special:{load:{noBubble:!0},click:{trigger:function(){return b.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):t}},focus:{trigger:function(){if(this!==o.activeElement&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===o.activeElement&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=b.extend(new b.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?b.event.trigger(i,null,t):b.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},b.removeEvent=o.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&&(typeof e[r]===i&&(e[r]=null),e.detachEvent(r,n))},b.Event=function(e,n){return this instanceof b.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault()?it:ot):this.type=e,n&&b.extend(this,n),this.timeStamp=e&&e.timeStamp||b.now(),this[b.expando]=!0,t):new b.Event(e,n)},b.Event.prototype={isDefaultPrevented:ot,isPropagationStopped:ot,isImmediatePropagationStopped:ot,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=it,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=it,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=it,this.stopPropagation()}},b.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){b.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;
return(!i||i!==r&&!b.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),b.support.submitBubbles||(b.event.special.submit={setup:function(){return b.nodeName(this,"form")?!1:(b.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=b.nodeName(n,"input")||b.nodeName(n,"button")?n.form:t;r&&!b._data(r,"submitBubbles")&&(b.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),b._data(r,"submitBubbles",!0))}),t)},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&b.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){return b.nodeName(this,"form")?!1:(b.event.remove(this,"._submit"),t)}}),b.support.changeBubbles||(b.event.special.change={setup:function(){return Z.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(b.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)}),b.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),b.event.simulate("change",this,e,!0)})),!1):(b.event.add(this,"beforeactivate._change",function(e){var t=e.target;Z.test(t.nodeName)&&!b._data(t,"changeBubbles")&&(b.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||b.event.simulate("change",this.parentNode,e,!0)}),b._data(t,"changeBubbles",!0))}),t)},handle:function(e){var n=e.target;return this!==n||e.isSimulated||e.isTrigger||"radio"!==n.type&&"checkbox"!==n.type?e.handleObj.handler.apply(this,arguments):t},teardown:function(){return b.event.remove(this,"._change"),!Z.test(this.nodeName)}}),b.support.focusinBubbles||b.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){b.event.simulate(t,e.target,b.event.fix(e),!0)};b.event.special[t]={setup:function(){0===n++&&o.addEventListener(e,r,!0)},teardown:function(){0===--n&&o.removeEventListener(e,r,!0)}}}),b.fn.extend({on:function(e,n,r,i,o){var a,s;if("object"==typeof e){"string"!=typeof n&&(r=r||n,n=t);for(a in e)this.on(a,n,r,e[a],o);return this}if(null==r&&null==i?(i=n,r=n=t):null==i&&("string"==typeof n?(i=r,r=t):(i=r,r=n,n=t)),i===!1)i=ot;else if(!i)return this;return 1===o&&(s=i,i=function(e){return b().off(e),s.apply(this,arguments)},i.guid=s.guid||(s.guid=b.guid++)),this.each(function(){b.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,o;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,b(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(o in e)this.off(o,n,e[o]);return this}return(n===!1||"function"==typeof n)&&(r=n,n=t),r===!1&&(r=ot),this.each(function(){b.event.remove(this,e,r,n)})},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},trigger:function(e,t){return this.each(function(){b.event.trigger(e,t,this)})},triggerHandler:function(e,n){var r=this[0];return r?b.event.trigger(e,n,r,!0):t}}),function(e,t){var n,r,i,o,a,s,u,l,c,p,f,d,h,g,m,y,v,x="sizzle"+-new Date,w=e.document,T={},N=0,C=0,k=it(),E=it(),S=it(),A=typeof t,j=1<<31,D=[],L=D.pop,H=D.push,q=D.slice,M=D.indexOf||function(e){var t=0,n=this.length;for(;n>t;t++)if(this[t]===e)return t;return-1},_="[\\x20\\t\\r\\n\\f]",F="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",O=F.replace("w","w#"),B="([*^$|!~]?=)",P="\\["+_+"*("+F+")"+_+"*(?:"+B+_+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+O+")|)|)"+_+"*\\]",R=":("+F+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+P.replace(3,8)+")*)|.*)\\)|)",W=RegExp("^"+_+"+|((?:^|[^\\\\])(?:\\\\.)*)"+_+"+$","g"),$=RegExp("^"+_+"*,"+_+"*"),I=RegExp("^"+_+"*([\\x20\\t\\r\\n\\f>+~])"+_+"*"),z=RegExp(R),X=RegExp("^"+O+"$"),U={ID:RegExp("^#("+F+")"),CLASS:RegExp("^\\.("+F+")"),NAME:RegExp("^\\[name=['\"]?("+F+")['\"]?\\]"),TAG:RegExp("^("+F.replace("w","w*")+")"),ATTR:RegExp("^"+P),PSEUDO:RegExp("^"+R),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+_+"*(even|odd|(([+-]|)(\\d*)n|)"+_+"*(?:([+-]|)"+_+"*(\\d+)|))"+_+"*\\)|)","i"),needsContext:RegExp("^"+_+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+_+"*((?:-\\d)?\\d*)"+_+"*\\)|)(?=[^-]|$)","i")},V=/[\x20\t\r\n\f]*[+~]/,Y=/^[^{]+\{\s*\[native code/,J=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,G=/^(?:input|select|textarea|button)$/i,Q=/^h\d$/i,K=/'|\\/g,Z=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,et=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,tt=function(e,t){var n="0x"+t-65536;return n!==n?t:0>n?String.fromCharCode(n+65536):String.fromCharCode(55296|n>>10,56320|1023&n)};try{q.call(w.documentElement.childNodes,0)[0].nodeType}catch(nt){q=function(e){var t,n=[];while(t=this[e++])n.push(t);return n}}function rt(e){return Y.test(e+"")}function it(){var e,t=[];return e=function(n,r){return t.push(n+=" ")>i.cacheLength&&delete e[t.shift()],e[n]=r}}function ot(e){return e[x]=!0,e}function at(e){var t=p.createElement("div");try{return e(t)}catch(n){return!1}finally{t=null}}function st(e,t,n,r){var i,o,a,s,u,l,f,g,m,v;if((t?t.ownerDocument||t:w)!==p&&c(t),t=t||p,n=n||[],!e||"string"!=typeof e)return n;if(1!==(s=t.nodeType)&&9!==s)return[];if(!d&&!r){if(i=J.exec(e))if(a=i[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return n;if(o.id===a)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&y(t,o)&&o.id===a)return n.push(o),n}else{if(i[2])return H.apply(n,q.call(t.getElementsByTagName(e),0)),n;if((a=i[3])&&T.getByClassName&&t.getElementsByClassName)return H.apply(n,q.call(t.getElementsByClassName(a),0)),n}if(T.qsa&&!h.test(e)){if(f=!0,g=x,m=t,v=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){l=ft(e),(f=t.getAttribute("id"))?g=f.replace(K,"\\$&"):t.setAttribute("id",g),g="[id='"+g+"'] ",u=l.length;while(u--)l[u]=g+dt(l[u]);m=V.test(e)&&t.parentNode||t,v=l.join(",")}if(v)try{return H.apply(n,q.call(m.querySelectorAll(v),0)),n}catch(b){}finally{f||t.removeAttribute("id")}}}return wt(e.replace(W,"$1"),t,n,r)}a=st.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},c=st.setDocument=function(e){var n=e?e.ownerDocument||e:w;return n!==p&&9===n.nodeType&&n.documentElement?(p=n,f=n.documentElement,d=a(n),T.tagNameNoComments=at(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),T.attributes=at(function(e){e.innerHTML="<select></select>";var t=typeof e.lastChild.getAttribute("multiple");return"boolean"!==t&&"string"!==t}),T.getByClassName=at(function(e){return e.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",e.getElementsByClassName&&e.getElementsByClassName("e").length?(e.lastChild.className="e",2===e.getElementsByClassName("e").length):!1}),T.getByName=at(function(e){e.id=x+0,e.innerHTML="<a name='"+x+"'></a><div name='"+x+"'></div>",f.insertBefore(e,f.firstChild);var t=n.getElementsByName&&n.getElementsByName(x).length===2+n.getElementsByName(x+0).length;return T.getIdNotName=!n.getElementById(x),f.removeChild(e),t}),i.attrHandle=at(function(e){return e.innerHTML="<a href='#'></a>",e.firstChild&&typeof e.firstChild.getAttribute!==A&&"#"===e.firstChild.getAttribute("href")})?{}:{href:function(e){return e.getAttribute("href",2)},type:function(e){return e.getAttribute("type")}},T.getIdNotName?(i.find.ID=function(e,t){if(typeof t.getElementById!==A&&!d){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){return e.getAttribute("id")===t}}):(i.find.ID=function(e,n){if(typeof n.getElementById!==A&&!d){var r=n.getElementById(e);return r?r.id===e||typeof r.getAttributeNode!==A&&r.getAttributeNode("id").value===e?[r]:t:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){var n=typeof e.getAttributeNode!==A&&e.getAttributeNode("id");return n&&n.value===t}}),i.find.TAG=T.tagNameNoComments?function(e,n){return typeof n.getElementsByTagName!==A?n.getElementsByTagName(e):t}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},i.find.NAME=T.getByName&&function(e,n){return typeof n.getElementsByName!==A?n.getElementsByName(name):t},i.find.CLASS=T.getByClassName&&function(e,n){return typeof n.getElementsByClassName===A||d?t:n.getElementsByClassName(e)},g=[],h=[":focus"],(T.qsa=rt(n.querySelectorAll))&&(at(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||h.push("\\["+_+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),e.querySelectorAll(":checked").length||h.push(":checked")}),at(function(e){e.innerHTML="<input type='hidden' i=''/>",e.querySelectorAll("[i^='']").length&&h.push("[*^$]="+_+"*(?:\"\"|'')"),e.querySelectorAll(":enabled").length||h.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),h.push(",.*:")})),(T.matchesSelector=rt(m=f.matchesSelector||f.mozMatchesSelector||f.webkitMatchesSelector||f.oMatchesSelector||f.msMatchesSelector))&&at(function(e){T.disconnectedMatch=m.call(e,"div"),m.call(e,"[s!='']:x"),g.push("!=",R)}),h=RegExp(h.join("|")),g=RegExp(g.join("|")),y=rt(f.contains)||f.compareDocumentPosition?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},v=f.compareDocumentPosition?function(e,t){var r;return e===t?(u=!0,0):(r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t))?1&r||e.parentNode&&11===e.parentNode.nodeType?e===n||y(w,e)?-1:t===n||y(w,t)?1:0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,i=0,o=e.parentNode,a=t.parentNode,s=[e],l=[t];if(e===t)return u=!0,0;if(!o||!a)return e===n?-1:t===n?1:o?-1:a?1:0;if(o===a)return ut(e,t);r=e;while(r=r.parentNode)s.unshift(r);r=t;while(r=r.parentNode)l.unshift(r);while(s[i]===l[i])i++;return i?ut(s[i],l[i]):s[i]===w?-1:l[i]===w?1:0},u=!1,[0,0].sort(v),T.detectDuplicates=u,p):p},st.matches=function(e,t){return st(e,null,null,t)},st.matchesSelector=function(e,t){if((e.ownerDocument||e)!==p&&c(e),t=t.replace(Z,"='$1']"),!(!T.matchesSelector||d||g&&g.test(t)||h.test(t)))try{var n=m.call(e,t);if(n||T.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(r){}return st(t,p,null,[e]).length>0},st.contains=function(e,t){return(e.ownerDocument||e)!==p&&c(e),y(e,t)},st.attr=function(e,t){var n;return(e.ownerDocument||e)!==p&&c(e),d||(t=t.toLowerCase()),(n=i.attrHandle[t])?n(e):d||T.attributes?e.getAttribute(t):((n=e.getAttributeNode(t))||e.getAttribute(t))&&e[t]===!0?t:n&&n.specified?n.value:null},st.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},st.uniqueSort=function(e){var t,n=[],r=1,i=0;if(u=!T.detectDuplicates,e.sort(v),u){for(;t=e[r];r++)t===e[r-1]&&(i=n.push(r));while(i--)e.splice(n[i],1)}return e};function ut(e,t){var n=t&&e,r=n&&(~t.sourceIndex||j)-(~e.sourceIndex||j);if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function lt(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function ct(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function pt(e){return ot(function(t){return t=+t,ot(function(n,r){var i,o=e([],n.length,t),a=o.length;while(a--)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}o=st.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r];r++)n+=o(t);return n},i=st.selectors={cacheLength:50,createPseudo:ot,match:U,find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(et,tt),e[3]=(e[4]||e[5]||"").replace(et,tt),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||st.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&st.error(e[0]),e},PSEUDO:function(e){var t,n=!e[5]&&e[2];return U.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:n&&z.test(n)&&(t=ft(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){return"*"===e?function(){return!0}:(e=e.replace(et,tt).toLowerCase(),function(t){return t.nodeName&&t.nodeName.toLowerCase()===e})},CLASS:function(e){var t=k[e+" "];return t||(t=RegExp("(^|"+_+")"+e+"("+_+"|$)"))&&k(e,function(e){return t.test(e.className||typeof e.getAttribute!==A&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=st.attr(r,e);return null==i?"!="===t:t?(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i+" ").indexOf(n)>-1:"|="===t?i===n||i.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,p,f,d,h,g=o!==a?"nextSibling":"previousSibling",m=t.parentNode,y=s&&t.nodeName.toLowerCase(),v=!u&&!s;if(m){if(o){while(g){p=t;while(p=p[g])if(s?p.nodeName.toLowerCase()===y:1===p.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?m.firstChild:m.lastChild],a&&v){c=m[x]||(m[x]={}),l=c[e]||[],d=l[0]===N&&l[1],f=l[0]===N&&l[2],p=d&&m.childNodes[d];while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if(1===p.nodeType&&++f&&p===t){c[e]=[N,d,f];break}}else if(v&&(l=(t[x]||(t[x]={}))[e])&&l[0]===N)f=l[1];else while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if((s?p.nodeName.toLowerCase()===y:1===p.nodeType)&&++f&&(v&&((p[x]||(p[x]={}))[e]=[N,f]),p===t))break;return f-=i,f===r||0===f%r&&f/r>=0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||st.error("unsupported pseudo: "+e);return r[x]?r(t):r.length>1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?ot(function(e,n){var i,o=r(e,t),a=o.length;while(a--)i=M.call(e,o[a]),e[i]=!(n[i]=o[a])}):function(e){return r(e,0,n)}):r}},pseudos:{not:ot(function(e){var t=[],n=[],r=s(e.replace(W,"$1"));return r[x]?ot(function(e,t,n,i){var o,a=r(e,null,i,[]),s=e.length;while(s--)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:ot(function(e){return function(t){return st(e,t).length>0}}),contains:ot(function(e){return function(t){return(t.textContent||t.innerText||o(t)).indexOf(e)>-1}}),lang:ot(function(e){return X.test(e||"")||st.error("unsupported lang: "+e),e=e.replace(et,tt).toLowerCase(),function(t){var n;do if(n=d?t.getAttribute("xml:lang")||t.getAttribute("lang"):t.lang)return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===f},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!i.pseudos.empty(e)},header:function(e){return Q.test(e.nodeName)},input:function(e){return G.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:pt(function(){return[0]}),last:pt(function(e,t){return[t-1]}),eq:pt(function(e,t,n){return[0>n?n+t:n]}),even:pt(function(e,t){var n=0;for(;t>n;n+=2)e.push(n);return e}),odd:pt(function(e,t){var n=1;for(;t>n;n+=2)e.push(n);return e}),lt:pt(function(e,t,n){var r=0>n?n+t:n;for(;--r>=0;)e.push(r);return e}),gt:pt(function(e,t,n){var r=0>n?n+t:n;for(;t>++r;)e.push(r);return e})}};for(n in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})i.pseudos[n]=lt(n);for(n in{submit:!0,reset:!0})i.pseudos[n]=ct(n);function ft(e,t){var n,r,o,a,s,u,l,c=E[e+" "];if(c)return t?0:c.slice(0);s=e,u=[],l=i.preFilter;while(s){(!n||(r=$.exec(s)))&&(r&&(s=s.slice(r[0].length)||s),u.push(o=[])),n=!1,(r=I.exec(s))&&(n=r.shift(),o.push({value:n,type:r[0].replace(W," ")}),s=s.slice(n.length));for(a in i.filter)!(r=U[a].exec(s))||l[a]&&!(r=l[a](r))||(n=r.shift(),o.push({value:n,type:a,matches:r}),s=s.slice(n.length));if(!n)break}return t?s.length:s?st.error(e):E(e,u).slice(0)}function dt(e){var t=0,n=e.length,r="";for(;n>t;t++)r+=e[t].value;return r}function ht(e,t,n){var i=t.dir,o=n&&"parentNode"===i,a=C++;return t.first?function(t,n,r){while(t=t[i])if(1===t.nodeType||o)return e(t,n,r)}:function(t,n,s){var u,l,c,p=N+" "+a;if(s){while(t=t[i])if((1===t.nodeType||o)&&e(t,n,s))return!0}else while(t=t[i])if(1===t.nodeType||o)if(c=t[x]||(t[x]={}),(l=c[i])&&l[0]===p){if((u=l[1])===!0||u===r)return u===!0}else if(l=c[i]=[p],l[1]=e(t,n,s)||r,l[1]===!0)return!0}}function gt(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function mt(e,t,n,r,i){var o,a=[],s=0,u=e.length,l=null!=t;for(;u>s;s++)(o=e[s])&&(!n||n(o,r,i))&&(a.push(o),l&&t.push(s));return a}function yt(e,t,n,r,i,o){return r&&!r[x]&&(r=yt(r)),i&&!i[x]&&(i=yt(i,o)),ot(function(o,a,s,u){var l,c,p,f=[],d=[],h=a.length,g=o||xt(t||"*",s.nodeType?[s]:s,[]),m=!e||!o&&t?g:mt(g,f,e,s,u),y=n?i||(o?e:h||r)?[]:a:m;if(n&&n(m,y,s,u),r){l=mt(y,d),r(l,[],s,u),c=l.length;while(c--)(p=l[c])&&(y[d[c]]=!(m[d[c]]=p))}if(o){if(i||e){if(i){l=[],c=y.length;while(c--)(p=y[c])&&l.push(m[c]=p);i(null,y=[],l,u)}c=y.length;while(c--)(p=y[c])&&(l=i?M.call(o,p):f[c])>-1&&(o[l]=!(a[l]=p))}}else y=mt(y===a?y.splice(h,y.length):y),i?i(null,a,y,u):H.apply(a,y)})}function vt(e){var t,n,r,o=e.length,a=i.relative[e[0].type],s=a||i.relative[" "],u=a?1:0,c=ht(function(e){return e===t},s,!0),p=ht(function(e){return M.call(t,e)>-1},s,!0),f=[function(e,n,r){return!a&&(r||n!==l)||((t=n).nodeType?c(e,n,r):p(e,n,r))}];for(;o>u;u++)if(n=i.relative[e[u].type])f=[ht(gt(f),n)];else{if(n=i.filter[e[u].type].apply(null,e[u].matches),n[x]){for(r=++u;o>r;r++)if(i.relative[e[r].type])break;return yt(u>1&&gt(f),u>1&&dt(e.slice(0,u-1)).replace(W,"$1"),n,r>u&&vt(e.slice(u,r)),o>r&&vt(e=e.slice(r)),o>r&&dt(e))}f.push(n)}return gt(f)}function bt(e,t){var n=0,o=t.length>0,a=e.length>0,s=function(s,u,c,f,d){var h,g,m,y=[],v=0,b="0",x=s&&[],w=null!=d,T=l,C=s||a&&i.find.TAG("*",d&&u.parentNode||u),k=N+=null==T?1:Math.random()||.1;for(w&&(l=u!==p&&u,r=n);null!=(h=C[b]);b++){if(a&&h){g=0;while(m=e[g++])if(m(h,u,c)){f.push(h);break}w&&(N=k,r=++n)}o&&((h=!m&&h)&&v--,s&&x.push(h))}if(v+=b,o&&b!==v){g=0;while(m=t[g++])m(x,y,u,c);if(s){if(v>0)while(b--)x[b]||y[b]||(y[b]=L.call(f));y=mt(y)}H.apply(f,y),w&&!s&&y.length>0&&v+t.length>1&&st.uniqueSort(f)}return w&&(N=k,l=T),x};return o?ot(s):s}s=st.compile=function(e,t){var n,r=[],i=[],o=S[e+" "];if(!o){t||(t=ft(e)),n=t.length;while(n--)o=vt(t[n]),o[x]?r.push(o):i.push(o);o=S(e,bt(i,r))}return o};function xt(e,t,n){var r=0,i=t.length;for(;i>r;r++)st(e,t[r],n);return n}function wt(e,t,n,r){var o,a,u,l,c,p=ft(e);if(!r&&1===p.length){if(a=p[0]=p[0].slice(0),a.length>2&&"ID"===(u=a[0]).type&&9===t.nodeType&&!d&&i.relative[a[1].type]){if(t=i.find.ID(u.matches[0].replace(et,tt),t)[0],!t)return n;e=e.slice(a.shift().value.length)}o=U.needsContext.test(e)?0:a.length;while(o--){if(u=a[o],i.relative[l=u.type])break;if((c=i.find[l])&&(r=c(u.matches[0].replace(et,tt),V.test(a[0].type)&&t.parentNode||t))){if(a.splice(o,1),e=r.length&&dt(a),!e)return H.apply(n,q.call(r,0)),n;break}}}return s(e,p)(r,t,d,n,V.test(e)),n}i.pseudos.nth=i.pseudos.eq;function Tt(){}i.filters=Tt.prototype=i.pseudos,i.setFilters=new Tt,c(),st.attr=b.attr,b.find=st,b.expr=st.selectors,b.expr[":"]=b.expr.pseudos,b.unique=st.uniqueSort,b.text=st.getText,b.isXMLDoc=st.isXML,b.contains=st.contains}(e);var at=/Until$/,st=/^(?:parents|prev(?:Until|All))/,ut=/^.[^:#\[\.,]*$/,lt=b.expr.match.needsContext,ct={children:!0,contents:!0,next:!0,prev:!0};b.fn.extend({find:function(e){var t,n,r,i=this.length;if("string"!=typeof e)return r=this,this.pushStack(b(e).filter(function(){for(t=0;i>t;t++)if(b.contains(r[t],this))return!0}));for(n=[],t=0;i>t;t++)b.find(e,this[t],n);return n=this.pushStack(i>1?b.unique(n):n),n.selector=(this.selector?this.selector+" ":"")+e,n},has:function(e){var t,n=b(e,this),r=n.length;return this.filter(function(){for(t=0;r>t;t++)if(b.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e,!1))},filter:function(e){return this.pushStack(ft(this,e,!0))},is:function(e){return!!e&&("string"==typeof e?lt.test(e)?b(e,this.context).index(this[0])>=0:b.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){var n,r=0,i=this.length,o=[],a=lt.test(e)||"string"!=typeof e?b(e,t||this.context):0;for(;i>r;r++){n=this[r];while(n&&n.ownerDocument&&n!==t&&11!==n.nodeType){if(a?a.index(n)>-1:b.find.matchesSelector(n,e)){o.push(n);break}n=n.parentNode}}return this.pushStack(o.length>1?b.unique(o):o)},index:function(e){return e?"string"==typeof e?b.inArray(this[0],b(e)):b.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var n="string"==typeof e?b(e,t):b.makeArray(e&&e.nodeType?[e]:e),r=b.merge(this.get(),n);return this.pushStack(b.unique(r))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),b.fn.andSelf=b.fn.addBack;function pt(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}b.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return b.dir(e,"parentNode")},parentsUntil:function(e,t,n){return b.dir(e,"parentNode",n)},next:function(e){return pt(e,"nextSibling")},prev:function(e){return pt(e,"previousSibling")},nextAll:function(e){return b.dir(e,"nextSibling")},prevAll:function(e){return b.dir(e,"previousSibling")},nextUntil:function(e,t,n){return b.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return b.dir(e,"previousSibling",n)},siblings:function(e){return b.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return b.sibling(e.firstChild)},contents:function(e){return b.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:b.merge([],e.childNodes)}},function(e,t){b.fn[e]=function(n,r){var i=b.map(this,t,n);return at.test(e)||(r=n),r&&"string"==typeof r&&(i=b.filter(r,i)),i=this.length>1&&!ct[e]?b.unique(i):i,this.length>1&&st.test(e)&&(i=i.reverse()),this.pushStack(i)}}),b.extend({filter:function(e,t,n){return n&&(e=":not("+e+")"),1===t.length?b.find.matchesSelector(t[0],e)?[t[0]]:[]:b.find.matches(e,t)},dir:function(e,n,r){var i=[],o=e[n];while(o&&9!==o.nodeType&&(r===t||1!==o.nodeType||!b(o).is(r)))1===o.nodeType&&i.push(o),o=o[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}});function ft(e,t,n){if(t=t||0,b.isFunction(t))return b.grep(e,function(e,r){var i=!!t.call(e,r,e);return i===n});if(t.nodeType)return b.grep(e,function(e){return e===t===n});if("string"==typeof t){var r=b.grep(e,function(e){return 1===e.nodeType});if(ut.test(t))return b.filter(t,r,!n);t=b.filter(t,r)}return b.grep(e,function(e){return b.inArray(e,t)>=0===n})}function dt(e){var t=ht.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}var ht="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gt=/ jQuery\d+="(?:null|\d+)"/g,mt=RegExp("<(?:"+ht+")[\\s/>]","i"),yt=/^\s+/,vt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bt=/<([\w:]+)/,xt=/<tbody/i,wt=/<|&#?\w+;/,Tt=/<(?:script|style|link)/i,Nt=/^(?:checkbox|radio)$/i,Ct=/checked\s*(?:[^=]|=\s*.checked.)/i,kt=/^$|\/(?:java|ecma)script/i,Et=/^true\/(.*)/,St=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,At={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:b.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},jt=dt(o),Dt=jt.appendChild(o.createElement("div"));At.optgroup=At.option,At.tbody=At.tfoot=At.colgroup=At.caption=At.thead,At.th=At.td,b.fn.extend({text:function(e){return b.access(this,function(e){return e===t?b.text(this):this.empty().append((this[0]&&this[0].ownerDocument||o).createTextNode(e))},null,e,arguments.length)},wrapAll:function(e){if(b.isFunction(e))return this.each(function(t){b(this).wrapAll(e.call(this,t))});if(this[0]){var t=b(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&&1===e.firstChild.nodeType)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return b.isFunction(e)?this.each(function(t){b(this).wrapInner(e.call(this,t))}):this.each(function(){var t=b(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=b.isFunction(e);return this.each(function(n){b(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){b.nodeName(this,"body")||b(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.appendChild(e)})},prepend:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.insertBefore(e,this.firstChild)})},before:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){var n,r=0;for(;null!=(n=this[r]);r++)(!e||b.filter(e,[n]).length>0)&&(t||1!==n.nodeType||b.cleanData(Ot(n)),n.parentNode&&(t&&b.contains(n.ownerDocument,n)&&Mt(Ot(n,"script")),n.parentNode.removeChild(n)));return this},empty:function(){var e,t=0;for(;null!=(e=this[t]);t++){1===e.nodeType&&b.cleanData(Ot(e,!1));while(e.firstChild)e.removeChild(e.firstChild);e.options&&b.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return b.clone(this,e,t)})},html:function(e){return b.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return 1===n.nodeType?n.innerHTML.replace(gt,""):t;if(!("string"!=typeof e||Tt.test(e)||!b.support.htmlSerialize&&mt.test(e)||!b.support.leadingWhitespace&&yt.test(e)||At[(bt.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(vt,"<$1></$2>");try{for(;i>r;r++)n=this[r]||{},1===n.nodeType&&(b.cleanData(Ot(n,!1)),n.innerHTML=e);n=0}catch(o){}}n&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(e){var t=b.isFunction(e);return t||"string"==typeof e||(e=b(e).not(this).detach()),this.domManip([e],!0,function(e){var t=this.nextSibling,n=this.parentNode;n&&(b(this).remove(),n.insertBefore(e,t))})},detach:function(e){return this.remove(e,!0)},domManip:function(e,n,r){e=f.apply([],e);var i,o,a,s,u,l,c=0,p=this.length,d=this,h=p-1,g=e[0],m=b.isFunction(g);if(m||!(1>=p||"string"!=typeof g||b.support.checkClone)&&Ct.test(g))return this.each(function(i){var o=d.eq(i);m&&(e[0]=g.call(this,i,n?o.html():t)),o.domManip(e,n,r)});if(p&&(l=b.buildFragment(e,this[0].ownerDocument,!1,this),i=l.firstChild,1===l.childNodes.length&&(l=i),i)){for(n=n&&b.nodeName(i,"tr"),s=b.map(Ot(l,"script"),Ht),a=s.length;p>c;c++)o=l,c!==h&&(o=b.clone(o,!0,!0),a&&b.merge(s,Ot(o,"script"))),r.call(n&&b.nodeName(this[c],"table")?Lt(this[c],"tbody"):this[c],o,c);if(a)for(u=s[s.length-1].ownerDocument,b.map(s,qt),c=0;a>c;c++)o=s[c],kt.test(o.type||"")&&!b._data(o,"globalEval")&&b.contains(u,o)&&(o.src?b.ajax({url:o.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):b.globalEval((o.text||o.textContent||o.innerHTML||"").replace(St,"")));l=i=null}return this}});function Lt(e,t){return e.getElementsByTagName(t)[0]||e.appendChild(e.ownerDocument.createElement(t))}function Ht(e){var t=e.getAttributeNode("type");return e.type=(t&&t.specified)+"/"+e.type,e}function qt(e){var t=Et.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function Mt(e,t){var n,r=0;for(;null!=(n=e[r]);r++)b._data(n,"globalEval",!t||b._data(t[r],"globalEval"))}function _t(e,t){if(1===t.nodeType&&b.hasData(e)){var n,r,i,o=b._data(e),a=b._data(t,o),s=o.events;if(s){delete a.handle,a.events={};for(n in s)for(r=0,i=s[n].length;i>r;r++)b.event.add(t,n,s[n][r])}a.data&&(a.data=b.extend({},a.data))}}function Ft(e,t){var n,r,i;if(1===t.nodeType){if(n=t.nodeName.toLowerCase(),!b.support.noCloneEvent&&t[b.expando]){i=b._data(t);for(r in i.events)b.removeEvent(t,r,i.handle);t.removeAttribute(b.expando)}"script"===n&&t.text!==e.text?(Ht(t).text=e.text,qt(t)):"object"===n?(t.parentNode&&(t.outerHTML=e.outerHTML),b.support.html5Clone&&e.innerHTML&&!b.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===n&&Nt.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===n?t.defaultSelected=t.selected=e.defaultSelected:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}}b.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){b.fn[e]=function(e){var n,r=0,i=[],o=b(e),a=o.length-1;for(;a>=r;r++)n=r===a?this:this.clone(!0),b(o[r])[t](n),d.apply(i,n.get());return this.pushStack(i)}});function Ot(e,n){var r,o,a=0,s=typeof e.getElementsByTagName!==i?e.getElementsByTagName(n||"*"):typeof e.querySelectorAll!==i?e.querySelectorAll(n||"*"):t;if(!s)for(s=[],r=e.childNodes||e;null!=(o=r[a]);a++)!n||b.nodeName(o,n)?s.push(o):b.merge(s,Ot(o,n));return n===t||n&&b.nodeName(e,n)?b.merge([e],s):s}function Bt(e){Nt.test(e.type)&&(e.defaultChecked=e.checked)}b.extend({clone:function(e,t,n){var r,i,o,a,s,u=b.contains(e.ownerDocument,e);if(b.support.html5Clone||b.isXMLDoc(e)||!mt.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(Dt.innerHTML=e.outerHTML,Dt.removeChild(o=Dt.firstChild)),!(b.support.noCloneEvent&&b.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||b.isXMLDoc(e)))for(r=Ot(o),s=Ot(e),a=0;null!=(i=s[a]);++a)r[a]&&Ft(i,r[a]);if(t)if(n)for(s=s||Ot(e),r=r||Ot(o),a=0;null!=(i=s[a]);a++)_t(i,r[a]);else _t(e,o);return r=Ot(o,"script"),r.length>0&&Mt(r,!u&&Ot(e,"script")),r=s=i=null,o},buildFragment:function(e,t,n,r){var i,o,a,s,u,l,c,p=e.length,f=dt(t),d=[],h=0;for(;p>h;h++)if(o=e[h],o||0===o)if("object"===b.type(o))b.merge(d,o.nodeType?[o]:o);else if(wt.test(o)){s=s||f.appendChild(t.createElement("div")),u=(bt.exec(o)||["",""])[1].toLowerCase(),c=At[u]||At._default,s.innerHTML=c[1]+o.replace(vt,"<$1></$2>")+c[2],i=c[0];while(i--)s=s.lastChild;if(!b.support.leadingWhitespace&&yt.test(o)&&d.push(t.createTextNode(yt.exec(o)[0])),!b.support.tbody){o="table"!==u||xt.test(o)?"<table>"!==c[1]||xt.test(o)?0:s:s.firstChild,i=o&&o.childNodes.length;while(i--)b.nodeName(l=o.childNodes[i],"tbody")&&!l.childNodes.length&&o.removeChild(l)
}b.merge(d,s.childNodes),s.textContent="";while(s.firstChild)s.removeChild(s.firstChild);s=f.lastChild}else d.push(t.createTextNode(o));s&&f.removeChild(s),b.support.appendChecked||b.grep(Ot(d,"input"),Bt),h=0;while(o=d[h++])if((!r||-1===b.inArray(o,r))&&(a=b.contains(o.ownerDocument,o),s=Ot(f.appendChild(o),"script"),a&&Mt(s),n)){i=0;while(o=s[i++])kt.test(o.type||"")&&n.push(o)}return s=null,f},cleanData:function(e,t){var n,r,o,a,s=0,u=b.expando,l=b.cache,p=b.support.deleteExpando,f=b.event.special;for(;null!=(n=e[s]);s++)if((t||b.acceptData(n))&&(o=n[u],a=o&&l[o])){if(a.events)for(r in a.events)f[r]?b.event.remove(n,r):b.removeEvent(n,r,a.handle);l[o]&&(delete l[o],p?delete n[u]:typeof n.removeAttribute!==i?n.removeAttribute(u):n[u]=null,c.push(o))}}});var Pt,Rt,Wt,$t=/alpha\([^)]*\)/i,It=/opacity\s*=\s*([^)]*)/,zt=/^(top|right|bottom|left)$/,Xt=/^(none|table(?!-c[ea]).+)/,Ut=/^margin/,Vt=RegExp("^("+x+")(.*)$","i"),Yt=RegExp("^("+x+")(?!px)[a-z%]+$","i"),Jt=RegExp("^([+-])=("+x+")","i"),Gt={BODY:"block"},Qt={position:"absolute",visibility:"hidden",display:"block"},Kt={letterSpacing:0,fontWeight:400},Zt=["Top","Right","Bottom","Left"],en=["Webkit","O","Moz","ms"];function tn(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=en.length;while(i--)if(t=en[i]+n,t in e)return t;return r}function nn(e,t){return e=t||e,"none"===b.css(e,"display")||!b.contains(e.ownerDocument,e)}function rn(e,t){var n,r,i,o=[],a=0,s=e.length;for(;s>a;a++)r=e[a],r.style&&(o[a]=b._data(r,"olddisplay"),n=r.style.display,t?(o[a]||"none"!==n||(r.style.display=""),""===r.style.display&&nn(r)&&(o[a]=b._data(r,"olddisplay",un(r.nodeName)))):o[a]||(i=nn(r),(n&&"none"!==n||!i)&&b._data(r,"olddisplay",i?n:b.css(r,"display"))));for(a=0;s>a;a++)r=e[a],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[a]||"":"none"));return e}b.fn.extend({css:function(e,n){return b.access(this,function(e,n,r){var i,o,a={},s=0;if(b.isArray(n)){for(o=Rt(e),i=n.length;i>s;s++)a[n[s]]=b.css(e,n[s],!1,o);return a}return r!==t?b.style(e,n,r):b.css(e,n)},e,n,arguments.length>1)},show:function(){return rn(this,!0)},hide:function(){return rn(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:nn(this))?b(this).show():b(this).hide()})}}),b.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Wt(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":b.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,u=b.camelCase(n),l=e.style;if(n=b.cssProps[u]||(b.cssProps[u]=tn(l,u)),s=b.cssHooks[n]||b.cssHooks[u],r===t)return s&&"get"in s&&(o=s.get(e,!1,i))!==t?o:l[n];if(a=typeof r,"string"===a&&(o=Jt.exec(r))&&(r=(o[1]+1)*o[2]+parseFloat(b.css(e,n)),a="number"),!(null==r||"number"===a&&isNaN(r)||("number"!==a||b.cssNumber[u]||(r+="px"),b.support.clearCloneStyle||""!==r||0!==n.indexOf("background")||(l[n]="inherit"),s&&"set"in s&&(r=s.set(e,r,i))===t)))try{l[n]=r}catch(c){}}},css:function(e,n,r,i){var o,a,s,u=b.camelCase(n);return n=b.cssProps[u]||(b.cssProps[u]=tn(e.style,u)),s=b.cssHooks[n]||b.cssHooks[u],s&&"get"in s&&(a=s.get(e,!0,r)),a===t&&(a=Wt(e,n,i)),"normal"===a&&n in Kt&&(a=Kt[n]),""===r||r?(o=parseFloat(a),r===!0||b.isNumeric(o)?o||0:a):a},swap:function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i}}),e.getComputedStyle?(Rt=function(t){return e.getComputedStyle(t,null)},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s.getPropertyValue(n)||s[n]:t,l=e.style;return s&&(""!==u||b.contains(e.ownerDocument,e)||(u=b.style(e,n)),Yt.test(u)&&Ut.test(n)&&(i=l.width,o=l.minWidth,a=l.maxWidth,l.minWidth=l.maxWidth=l.width=u,u=s.width,l.width=i,l.minWidth=o,l.maxWidth=a)),u}):o.documentElement.currentStyle&&(Rt=function(e){return e.currentStyle},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s[n]:t,l=e.style;return null==u&&l&&l[n]&&(u=l[n]),Yt.test(u)&&!zt.test(n)&&(i=l.left,o=e.runtimeStyle,a=o&&o.left,a&&(o.left=e.currentStyle.left),l.left="fontSize"===n?"1em":u,u=l.pixelLeft+"px",l.left=i,a&&(o.left=a)),""===u?"auto":u});function on(e,t,n){var r=Vt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function an(e,t,n,r,i){var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;for(;4>o;o+=2)"margin"===n&&(a+=b.css(e,n+Zt[o],!0,i)),r?("content"===n&&(a-=b.css(e,"padding"+Zt[o],!0,i)),"margin"!==n&&(a-=b.css(e,"border"+Zt[o]+"Width",!0,i))):(a+=b.css(e,"padding"+Zt[o],!0,i),"padding"!==n&&(a+=b.css(e,"border"+Zt[o]+"Width",!0,i)));return a}function sn(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=Rt(e),a=b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=Wt(e,t,o),(0>i||null==i)&&(i=e.style[t]),Yt.test(i))return i;r=a&&(b.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+an(e,t,n||(a?"border":"content"),r,o)+"px"}function un(e){var t=o,n=Gt[e];return n||(n=ln(e,t),"none"!==n&&n||(Pt=(Pt||b("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Pt[0].contentWindow||Pt[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),n=ln(e,t),Pt.detach()),Gt[e]=n),n}function ln(e,t){var n=b(t.createElement(e)).appendTo(t.body),r=b.css(n[0],"display");return n.remove(),r}b.each(["height","width"],function(e,n){b.cssHooks[n]={get:function(e,r,i){return r?0===e.offsetWidth&&Xt.test(b.css(e,"display"))?b.swap(e,Qt,function(){return sn(e,n,i)}):sn(e,n,i):t},set:function(e,t,r){var i=r&&Rt(e);return on(e,t,r?an(e,n,r,b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,i),i):0)}}}),b.support.opacity||(b.cssHooks.opacity={get:function(e,t){return It.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=b.isNumeric(t)?"alpha(opacity="+100*t+")":"",o=r&&r.filter||n.filter||"";n.zoom=1,(t>=1||""===t)&&""===b.trim(o.replace($t,""))&&n.removeAttribute&&(n.removeAttribute("filter"),""===t||r&&!r.filter)||(n.filter=$t.test(o)?o.replace($t,i):o+" "+i)}}),b(function(){b.support.reliableMarginRight||(b.cssHooks.marginRight={get:function(e,n){return n?b.swap(e,{display:"inline-block"},Wt,[e,"marginRight"]):t}}),!b.support.pixelPosition&&b.fn.position&&b.each(["top","left"],function(e,n){b.cssHooks[n]={get:function(e,r){return r?(r=Wt(e,n),Yt.test(r)?b(e).position()[n]+"px":r):t}}})}),b.expr&&b.expr.filters&&(b.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight||!b.support.reliableHiddenOffsets&&"none"===(e.style&&e.style.display||b.css(e,"display"))},b.expr.filters.visible=function(e){return!b.expr.filters.hidden(e)}),b.each({margin:"",padding:"",border:"Width"},function(e,t){b.cssHooks[e+t]={expand:function(n){var r=0,i={},o="string"==typeof n?n.split(" "):[n];for(;4>r;r++)i[e+Zt[r]+t]=o[r]||o[r-2]||o[0];return i}},Ut.test(e)||(b.cssHooks[e+t].set=on)});var cn=/%20/g,pn=/\[\]$/,fn=/\r?\n/g,dn=/^(?:submit|button|image|reset|file)$/i,hn=/^(?:input|select|textarea|keygen)/i;b.fn.extend({serialize:function(){return b.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=b.prop(this,"elements");return e?b.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!b(this).is(":disabled")&&hn.test(this.nodeName)&&!dn.test(e)&&(this.checked||!Nt.test(e))}).map(function(e,t){var n=b(this).val();return null==n?null:b.isArray(n)?b.map(n,function(e){return{name:t.name,value:e.replace(fn,"\r\n")}}):{name:t.name,value:n.replace(fn,"\r\n")}}).get()}}),b.param=function(e,n){var r,i=[],o=function(e,t){t=b.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(n===t&&(n=b.ajaxSettings&&b.ajaxSettings.traditional),b.isArray(e)||e.jquery&&!b.isPlainObject(e))b.each(e,function(){o(this.name,this.value)});else for(r in e)gn(r,e[r],n,o);return i.join("&").replace(cn,"+")};function gn(e,t,n,r){var i;if(b.isArray(t))b.each(t,function(t,i){n||pn.test(e)?r(e,i):gn(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==b.type(t))r(e,t);else for(i in t)gn(e+"["+i+"]",t[i],n,r)}b.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){b.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),b.fn.hover=function(e,t){return this.mouseenter(e).mouseleave(t||e)};var mn,yn,vn=b.now(),bn=/\?/,xn=/#.*$/,wn=/([?&])_=[^&]*/,Tn=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Nn=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Cn=/^(?:GET|HEAD)$/,kn=/^\/\//,En=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,Sn=b.fn.load,An={},jn={},Dn="*/".concat("*");try{yn=a.href}catch(Ln){yn=o.createElement("a"),yn.href="",yn=yn.href}mn=En.exec(yn.toLowerCase())||[];function Hn(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(w)||[];if(b.isFunction(n))while(r=o[i++])"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function qn(e,n,r,i){var o={},a=e===jn;function s(u){var l;return o[u]=!0,b.each(e[u]||[],function(e,u){var c=u(n,r,i);return"string"!=typeof c||a||o[c]?a?!(l=c):t:(n.dataTypes.unshift(c),s(c),!1)}),l}return s(n.dataTypes[0])||!o["*"]&&s("*")}function Mn(e,n){var r,i,o=b.ajaxSettings.flatOptions||{};for(i in n)n[i]!==t&&((o[i]?e:r||(r={}))[i]=n[i]);return r&&b.extend(!0,e,r),e}b.fn.load=function(e,n,r){if("string"!=typeof e&&Sn)return Sn.apply(this,arguments);var i,o,a,s=this,u=e.indexOf(" ");return u>=0&&(i=e.slice(u,e.length),e=e.slice(0,u)),b.isFunction(n)?(r=n,n=t):n&&"object"==typeof n&&(a="POST"),s.length>0&&b.ajax({url:e,type:a,dataType:"html",data:n}).done(function(e){o=arguments,s.html(i?b("<div>").append(b.parseHTML(e)).find(i):e)}).complete(r&&function(e,t){s.each(r,o||[e.responseText,t,e])}),this},b.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){b.fn[t]=function(e){return this.on(t,e)}}),b.each(["get","post"],function(e,n){b[n]=function(e,r,i,o){return b.isFunction(r)&&(o=o||i,i=r,r=t),b.ajax({url:e,type:n,dataType:o,data:r,success:i})}}),b.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:yn,type:"GET",isLocal:Nn.test(mn[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Dn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":e.String,"text html":!0,"text json":b.parseJSON,"text xml":b.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Mn(Mn(e,b.ajaxSettings),t):Mn(b.ajaxSettings,e)},ajaxPrefilter:Hn(An),ajaxTransport:Hn(jn),ajax:function(e,n){"object"==typeof e&&(n=e,e=t),n=n||{};var r,i,o,a,s,u,l,c,p=b.ajaxSetup({},n),f=p.context||p,d=p.context&&(f.nodeType||f.jquery)?b(f):b.event,h=b.Deferred(),g=b.Callbacks("once memory"),m=p.statusCode||{},y={},v={},x=0,T="canceled",N={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!c){c={};while(t=Tn.exec(a))c[t[1].toLowerCase()]=t[2]}t=c[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?a:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return x||(e=v[n]=v[n]||e,y[e]=t),this},overrideMimeType:function(e){return x||(p.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>x)for(t in e)m[t]=[m[t],e[t]];else N.always(e[N.status]);return this},abort:function(e){var t=e||T;return l&&l.abort(t),k(0,t),this}};if(h.promise(N).complete=g.add,N.success=N.done,N.error=N.fail,p.url=((e||p.url||yn)+"").replace(xn,"").replace(kn,mn[1]+"//"),p.type=n.method||n.type||p.method||p.type,p.dataTypes=b.trim(p.dataType||"*").toLowerCase().match(w)||[""],null==p.crossDomain&&(r=En.exec(p.url.toLowerCase()),p.crossDomain=!(!r||r[1]===mn[1]&&r[2]===mn[2]&&(r[3]||("http:"===r[1]?80:443))==(mn[3]||("http:"===mn[1]?80:443)))),p.data&&p.processData&&"string"!=typeof p.data&&(p.data=b.param(p.data,p.traditional)),qn(An,p,n,N),2===x)return N;u=p.global,u&&0===b.active++&&b.event.trigger("ajaxStart"),p.type=p.type.toUpperCase(),p.hasContent=!Cn.test(p.type),o=p.url,p.hasContent||(p.data&&(o=p.url+=(bn.test(o)?"&":"?")+p.data,delete p.data),p.cache===!1&&(p.url=wn.test(o)?o.replace(wn,"$1_="+vn++):o+(bn.test(o)?"&":"?")+"_="+vn++)),p.ifModified&&(b.lastModified[o]&&N.setRequestHeader("If-Modified-Since",b.lastModified[o]),b.etag[o]&&N.setRequestHeader("If-None-Match",b.etag[o])),(p.data&&p.hasContent&&p.contentType!==!1||n.contentType)&&N.setRequestHeader("Content-Type",p.contentType),N.setRequestHeader("Accept",p.dataTypes[0]&&p.accepts[p.dataTypes[0]]?p.accepts[p.dataTypes[0]]+("*"!==p.dataTypes[0]?", "+Dn+"; q=0.01":""):p.accepts["*"]);for(i in p.headers)N.setRequestHeader(i,p.headers[i]);if(p.beforeSend&&(p.beforeSend.call(f,N,p)===!1||2===x))return N.abort();T="abort";for(i in{success:1,error:1,complete:1})N[i](p[i]);if(l=qn(jn,p,n,N)){N.readyState=1,u&&d.trigger("ajaxSend",[N,p]),p.async&&p.timeout>0&&(s=setTimeout(function(){N.abort("timeout")},p.timeout));try{x=1,l.send(y,k)}catch(C){if(!(2>x))throw C;k(-1,C)}}else k(-1,"No Transport");function k(e,n,r,i){var c,y,v,w,T,C=n;2!==x&&(x=2,s&&clearTimeout(s),l=t,a=i||"",N.readyState=e>0?4:0,r&&(w=_n(p,N,r)),e>=200&&300>e||304===e?(p.ifModified&&(T=N.getResponseHeader("Last-Modified"),T&&(b.lastModified[o]=T),T=N.getResponseHeader("etag"),T&&(b.etag[o]=T)),204===e?(c=!0,C="nocontent"):304===e?(c=!0,C="notmodified"):(c=Fn(p,w),C=c.state,y=c.data,v=c.error,c=!v)):(v=C,(e||!C)&&(C="error",0>e&&(e=0))),N.status=e,N.statusText=(n||C)+"",c?h.resolveWith(f,[y,C,N]):h.rejectWith(f,[N,C,v]),N.statusCode(m),m=t,u&&d.trigger(c?"ajaxSuccess":"ajaxError",[N,p,c?y:v]),g.fireWith(f,[N,C]),u&&(d.trigger("ajaxComplete",[N,p]),--b.active||b.event.trigger("ajaxStop")))}return N},getScript:function(e,n){return b.get(e,t,n,"script")},getJSON:function(e,t,n){return b.get(e,t,n,"json")}});function _n(e,n,r){var i,o,a,s,u=e.contents,l=e.dataTypes,c=e.responseFields;for(s in c)s in r&&(n[c[s]]=r[s]);while("*"===l[0])l.shift(),o===t&&(o=e.mimeType||n.getResponseHeader("Content-Type"));if(o)for(s in u)if(u[s]&&u[s].test(o)){l.unshift(s);break}if(l[0]in r)a=l[0];else{for(s in r){if(!l[0]||e.converters[s+" "+l[0]]){a=s;break}i||(i=s)}a=a||i}return a?(a!==l[0]&&l.unshift(a),r[a]):t}function Fn(e,t){var n,r,i,o,a={},s=0,u=e.dataTypes.slice(),l=u[0];if(e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u[1])for(i in e.converters)a[i.toLowerCase()]=e.converters[i];for(;r=u[++s];)if("*"!==r){if("*"!==l&&l!==r){if(i=a[l+" "+r]||a["* "+r],!i)for(n in a)if(o=n.split(" "),o[1]===r&&(i=a[l+" "+o[0]]||a["* "+o[0]])){i===!0?i=a[n]:a[n]!==!0&&(r=o[0],u.splice(s--,0,r));break}if(i!==!0)if(i&&e["throws"])t=i(t);else try{t=i(t)}catch(c){return{state:"parsererror",error:i?c:"No conversion from "+l+" to "+r}}}l=r}return{state:"success",data:t}}b.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return b.globalEval(e),e}}}),b.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),b.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=o.head||b("head")[0]||o.documentElement;return{send:function(t,i){n=o.createElement("script"),n.async=!0,e.scriptCharset&&(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,t){(t||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),n=null,t||i(200,"success"))},r.insertBefore(n,r.firstChild)},abort:function(){n&&n.onload(t,!0)}}}});var On=[],Bn=/(=)\?(?=&|$)|\?\?/;b.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=On.pop()||b.expando+"_"+vn++;return this[e]=!0,e}}),b.ajaxPrefilter("json jsonp",function(n,r,i){var o,a,s,u=n.jsonp!==!1&&(Bn.test(n.url)?"url":"string"==typeof n.data&&!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&&Bn.test(n.data)&&"data");return u||"jsonp"===n.dataTypes[0]?(o=n.jsonpCallback=b.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,u?n[u]=n[u].replace(Bn,"$1"+o):n.jsonp!==!1&&(n.url+=(bn.test(n.url)?"&":"?")+n.jsonp+"="+o),n.converters["script json"]=function(){return s||b.error(o+" was not called"),s[0]},n.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},i.always(function(){e[o]=a,n[o]&&(n.jsonpCallback=r.jsonpCallback,On.push(o)),s&&b.isFunction(a)&&a(s[0]),s=a=t}),"script"):t});var Pn,Rn,Wn=0,$n=e.ActiveXObject&&function(){var e;for(e in Pn)Pn[e](t,!0)};function In(){try{return new e.XMLHttpRequest}catch(t){}}function zn(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}b.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&In()||zn()}:In,Rn=b.ajaxSettings.xhr(),b.support.cors=!!Rn&&"withCredentials"in Rn,Rn=b.support.ajax=!!Rn,Rn&&b.ajaxTransport(function(n){if(!n.crossDomain||b.support.cors){var r;return{send:function(i,o){var a,s,u=n.xhr();if(n.username?u.open(n.type,n.url,n.async,n.username,n.password):u.open(n.type,n.url,n.async),n.xhrFields)for(s in n.xhrFields)u[s]=n.xhrFields[s];n.mimeType&&u.overrideMimeType&&u.overrideMimeType(n.mimeType),n.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");try{for(s in i)u.setRequestHeader(s,i[s])}catch(l){}u.send(n.hasContent&&n.data||null),r=function(e,i){var s,l,c,p;try{if(r&&(i||4===u.readyState))if(r=t,a&&(u.onreadystatechange=b.noop,$n&&delete Pn[a]),i)4!==u.readyState&&u.abort();else{p={},s=u.status,l=u.getAllResponseHeaders(),"string"==typeof u.responseText&&(p.text=u.responseText);try{c=u.statusText}catch(f){c=""}s||!n.isLocal||n.crossDomain?1223===s&&(s=204):s=p.text?200:404}}catch(d){i||o(-1,d)}p&&o(s,c,p,l)},n.async?4===u.readyState?setTimeout(r):(a=++Wn,$n&&(Pn||(Pn={},b(e).unload($n)),Pn[a]=r),u.onreadystatechange=r):r()},abort:function(){r&&r(t,!0)}}}});var Xn,Un,Vn=/^(?:toggle|show|hide)$/,Yn=RegExp("^(?:([+-])=|)("+x+")([a-z%]*)$","i"),Jn=/queueHooks$/,Gn=[nr],Qn={"*":[function(e,t){var n,r,i=this.createTween(e,t),o=Yn.exec(t),a=i.cur(),s=+a||0,u=1,l=20;if(o){if(n=+o[2],r=o[3]||(b.cssNumber[e]?"":"px"),"px"!==r&&s){s=b.css(i.elem,e,!0)||n||1;do u=u||".5",s/=u,b.style(i.elem,e,s+r);while(u!==(u=i.cur()/a)&&1!==u&&--l)}i.unit=r,i.start=s,i.end=o[1]?s+(o[1]+1)*n:n}return i}]};function Kn(){return setTimeout(function(){Xn=t}),Xn=b.now()}function Zn(e,t){b.each(t,function(t,n){var r=(Qn[t]||[]).concat(Qn["*"]),i=0,o=r.length;for(;o>i;i++)if(r[i].call(e,t,n))return})}function er(e,t,n){var r,i,o=0,a=Gn.length,s=b.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;var t=Xn||Kn(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,o=1-r,a=0,u=l.tweens.length;for(;u>a;a++)l.tweens[a].run(o);return s.notifyWith(e,[l,o,n]),1>o&&u?n:(s.resolveWith(e,[l]),!1)},l=s.promise({elem:e,props:b.extend({},t),opts:b.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Xn||Kn(),duration:n.duration,tweens:[],createTween:function(t,n){var r=b.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)l.tweens[n].run(1);return t?s.resolveWith(e,[l,t]):s.rejectWith(e,[l,t]),this}}),c=l.props;for(tr(c,l.opts.specialEasing);a>o;o++)if(r=Gn[o].call(l,e,c,l.opts))return r;return Zn(l,c),b.isFunction(l.opts.start)&&l.opts.start.call(e,l),b.fx.timer(b.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function tr(e,t){var n,r,i,o,a;for(i in e)if(r=b.camelCase(i),o=t[r],n=e[i],b.isArray(n)&&(o=n[1],n=e[i]=n[0]),i!==r&&(e[r]=n,delete e[i]),a=b.cssHooks[r],a&&"expand"in a){n=a.expand(n),delete e[r];for(i in n)i in e||(e[i]=n[i],t[i]=o)}else t[r]=o}b.Animation=b.extend(er,{tweener:function(e,t){b.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;i>r;r++)n=e[r],Qn[n]=Qn[n]||[],Qn[n].unshift(t)},prefilter:function(e,t){t?Gn.unshift(e):Gn.push(e)}});function nr(e,t,n){var r,i,o,a,s,u,l,c,p,f=this,d=e.style,h={},g=[],m=e.nodeType&&nn(e);n.queue||(c=b._queueHooks(e,"fx"),null==c.unqueued&&(c.unqueued=0,p=c.empty.fire,c.empty.fire=function(){c.unqueued||p()}),c.unqueued++,f.always(function(){f.always(function(){c.unqueued--,b.queue(e,"fx").length||c.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[d.overflow,d.overflowX,d.overflowY],"inline"===b.css(e,"display")&&"none"===b.css(e,"float")&&(b.support.inlineBlockNeedsLayout&&"inline"!==un(e.nodeName)?d.zoom=1:d.display="inline-block")),n.overflow&&(d.overflow="hidden",b.support.shrinkWrapBlocks||f.always(function(){d.overflow=n.overflow[0],d.overflowX=n.overflow[1],d.overflowY=n.overflow[2]}));for(i in t)if(a=t[i],Vn.exec(a)){if(delete t[i],u=u||"toggle"===a,a===(m?"hide":"show"))continue;g.push(i)}if(o=g.length){s=b._data(e,"fxshow")||b._data(e,"fxshow",{}),"hidden"in s&&(m=s.hidden),u&&(s.hidden=!m),m?b(e).show():f.done(function(){b(e).hide()}),f.done(function(){var t;b._removeData(e,"fxshow");for(t in h)b.style(e,t,h[t])});for(i=0;o>i;i++)r=g[i],l=f.createTween(r,m?s[r]:0),h[r]=s[r]||b.style(e,r),r in s||(s[r]=l.start,m&&(l.end=l.start,l.start="width"===r||"height"===r?1:0))}}function rr(e,t,n,r,i){return new rr.prototype.init(e,t,n,r,i)}b.Tween=rr,rr.prototype={constructor:rr,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(b.cssNumber[n]?"":"px")},cur:function(){var e=rr.propHooks[this.prop];return e&&e.get?e.get(this):rr.propHooks._default.get(this)},run:function(e){var t,n=rr.propHooks[this.prop];return this.pos=t=this.options.duration?b.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):rr.propHooks._default.set(this),this}},rr.prototype.init.prototype=rr.prototype,rr.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=b.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){b.fx.step[e.prop]?b.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[b.cssProps[e.prop]]||b.cssHooks[e.prop])?b.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},rr.propHooks.scrollTop=rr.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},b.each(["toggle","show","hide"],function(e,t){var n=b.fn[t];b.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(ir(t,!0),e,r,i)}}),b.fn.extend({fadeTo:function(e,t,n,r){return this.filter(nn).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=b.isEmptyObject(e),o=b.speed(t,n,r),a=function(){var t=er(this,b.extend({},e),o);a.finish=function(){t.stop(!0)},(i||b._data(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=n,n=e,e=t),n&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,n=null!=e&&e+"queueHooks",o=b.timers,a=b._data(this);if(n)a[n]&&a[n].stop&&i(a[n]);else for(n in a)a[n]&&a[n].stop&&Jn.test(n)&&i(a[n]);for(n=o.length;n--;)o[n].elem!==this||null!=e&&o[n].queue!==e||(o[n].anim.stop(r),t=!1,o.splice(n,1));(t||!r)&&b.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=b._data(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=b.timers,a=r?r.length:0;for(n.finish=!0,b.queue(this,e,[]),i&&i.cur&&i.cur.finish&&i.cur.finish.call(this),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}});function ir(e,t){var n,r={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)n=Zt[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}b.each({slideDown:ir("show"),slideUp:ir("hide"),slideToggle:ir("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){b.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),b.speed=function(e,t,n){var r=e&&"object"==typeof e?b.extend({},e):{complete:n||!n&&t||b.isFunction(e)&&e,duration:e,easing:n&&t||t&&!b.isFunction(t)&&t};return r.duration=b.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in b.fx.speeds?b.fx.speeds[r.duration]:b.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){b.isFunction(r.old)&&r.old.call(this),r.queue&&b.dequeue(this,r.queue)},r},b.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},b.timers=[],b.fx=rr.prototype.init,b.fx.tick=function(){var e,n=b.timers,r=0;for(Xn=b.now();n.length>r;r++)e=n[r],e()||n[r]!==e||n.splice(r--,1);n.length||b.fx.stop(),Xn=t},b.fx.timer=function(e){e()&&b.timers.push(e)&&b.fx.start()},b.fx.interval=13,b.fx.start=function(){Un||(Un=setInterval(b.fx.tick,b.fx.interval))},b.fx.stop=function(){clearInterval(Un),Un=null},b.fx.speeds={slow:600,fast:200,_default:400},b.fx.step={},b.expr&&b.expr.filters&&(b.expr.filters.animated=function(e){return b.grep(b.timers,function(t){return e===t.elem}).length}),b.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){b.offset.setOffset(this,e,t)});var n,r,o={top:0,left:0},a=this[0],s=a&&a.ownerDocument;if(s)return n=s.documentElement,b.contains(n,a)?(typeof a.getBoundingClientRect!==i&&(o=a.getBoundingClientRect()),r=or(s),{top:o.top+(r.pageYOffset||n.scrollTop)-(n.clientTop||0),left:o.left+(r.pageXOffset||n.scrollLeft)-(n.clientLeft||0)}):o},b.offset={setOffset:function(e,t,n){var r=b.css(e,"position");"static"===r&&(e.style.position="relative");var i=b(e),o=i.offset(),a=b.css(e,"top"),s=b.css(e,"left"),u=("absolute"===r||"fixed"===r)&&b.inArray("auto",[a,s])>-1,l={},c={},p,f;u?(c=i.position(),p=c.top,f=c.left):(p=parseFloat(a)||0,f=parseFloat(s)||0),b.isFunction(t)&&(t=t.call(e,n,o)),null!=t.top&&(l.top=t.top-o.top+p),null!=t.left&&(l.left=t.left-o.left+f),"using"in t?t.using.call(e,l):i.css(l)}},b.fn.extend({position:function(){if(this[0]){var e,t,n={top:0,left:0},r=this[0];return"fixed"===b.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),b.nodeName(e[0],"html")||(n=e.offset()),n.top+=b.css(e[0],"borderTopWidth",!0),n.left+=b.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-b.css(r,"marginTop",!0),left:t.left-n.left-b.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||o.documentElement;while(e&&!b.nodeName(e,"html")&&"static"===b.css(e,"position"))e=e.offsetParent;return e||o.documentElement})}}),b.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);b.fn[e]=function(i){return b.access(this,function(e,i,o){var a=or(e);return o===t?a?n in a?a[n]:a.document.documentElement[i]:e[i]:(a?a.scrollTo(r?b(a).scrollLeft():o,r?o:b(a).scrollTop()):e[i]=o,t)},e,i,arguments.length,null)}});function or(e){return b.isWindow(e)?e:9===e.nodeType?e.defaultView||e.parentWindow:!1}b.each({Height:"height",Width:"width"},function(e,n){b.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){b.fn[i]=function(i,o){var a=arguments.length&&(r||"boolean"!=typeof i),s=r||(i===!0||o===!0?"margin":"border");return b.access(this,function(n,r,i){var o;return b.isWindow(n)?n.document.documentElement["client"+e]:9===n.nodeType?(o=n.documentElement,Math.max(n.body["scroll"+e],o["scroll"+e],n.body["offset"+e],o["offset"+e],o["client"+e])):i===t?b.css(n,r,s):b.style(n,r,i,s)},n,a?i:t,a,null)}})}),e.jQuery=e.$=b,"function"==typeof define&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return b})})(window);
//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);

//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
