<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 10, revision: 2, date: new Date("December 15, 2024"), extensions: {}};

//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2012

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.

" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> My TiddlyWiki - a reusable non-linear personal web notebook </title>
<style id="styleArea" type="text/css">
#saveTest, #messageArea, #copyright, #storeArea, #shadowArea {
	display: none;
}
#javascriptWarning {
	text-align: center;
	padding: 1em;
	font-weight: bold;
	background-color: #dd1100;
	color: #fff;
}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>

</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="GettingStarted">
<pre>When getting started, you may want to:
* Set your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;
* Change the page [[title|SiteTitle]] (now "&lt;&lt;tiddler SiteTitle&gt;&gt;") and [[subtitle|SiteSubtitle]] (now "&lt;&lt;tiddler SiteSubtitle&gt;&gt;"); they also set the browser tab title
* Create a tiddler where your content "starts"
** Use the button on the sidebar or [[link|My first tiddler]] it here, follow the link, edit, and click "done"
** It will be shown in the Timeline (usually on the right), but you may want to link it in the MainMenu (usually on the left)
** and/or make it open when the ~TiddlyWiki is opened by editing the list of [[DefaultTiddlers]] (separate links with spaces or linebreaks)
* Save your ~TiddlyWiki
** Although "download saving" works in any browser, it may be not that convenient, so you'll probably want to use [[a dedicated saver|https://classic.tiddlywiki.com/#%5B%5BSetting up saving%5D%5D]]
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' role='banner'&gt;
  &lt;div class='headerShadow'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class='headerForeground'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' role='navigation' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
  &lt;div id='sidebarOptions' role='navigation' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
  &lt;div id='sidebarTabs' role='complementary' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea' role='main'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1, h2, h3, h4, h5, h6 { color: [[ColorPalette::SecondaryDark]]; }
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.txtOptionInput {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {
	background: -moz-linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
	background: linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
}
.header a:hover {background:transparent;}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected {
	color:[[ColorPalette::Foreground]];
	background:[[ColorPalette::Background]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard { background:[[ColorPalette::PrimaryPale]]; }
.wizard__title    { color:[[ColorPalette::PrimaryDark]]; border:none; }
.wizard__subtitle { color:[[ColorPalette::Foreground]]; border:none; }
.wizardStep { background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]]; }
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizardFooter .status a { color: [[ColorPalette::PrimaryPale]]; }
.wizard .button {
	color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryDark]];
}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {
	color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];
}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]]; }
.messageToolbar__button { color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none; }
.messageToolbar__button_withIcon { background:inherit; }
.messageToolbar__button_withIcon:active { background:inherit; border:none; }
.tw-icon line { stroke: [[ColorPalette::TertiaryDark]]; }
.messageToolbar__button:hover .tw-icon line { stroke: [[ColorPalette::Foreground]]; }

.popup {
	background: [[ColorPalette::Background]];
	color: [[ColorPalette::TertiaryDark]];
	box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]];
}
.popup li a, .popup li a:visited, .popup li a:hover, .popup li a:active {
	color:[[ColorPalette::Foreground]]; border: none;
}
.popup li a:hover { background:[[ColorPalette::SecondaryLight]]; }
.popup li a:active { background:[[ColorPalette::SecondaryPale]]; }
.popup li.disabled { color:[[ColorPalette::TertiaryMid]]; }
.popupHighlight {color:[[ColorPalette::Foreground]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged { background: [[ColorPalette::Background]]; border: 2px solid [[ColorPalette::TertiaryPale]]; }
.selected .tagging, .selected .tagged { border: 2px solid [[ColorPalette::TertiaryLight]]; }
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button { border:none; }

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.twtable { background: [[ColorPalette::Background]]; }
.viewer th, .viewer thead td, .twtable th, .twtable thead td { background: [[ColorPalette::SecondaryMid]]; color: [[ColorPalette::Background]]; }
.viewer td, .viewer tr, .twtable td, .twtable tr { border: 1px solid [[ColorPalette::TertiaryLight]]; }
.twtable caption { color: [[ColorPalette::TertiaryMid]]; }

.viewer pre {background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:alpha(opacity=60);}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
body { font-size:.75em; font-family:arial,helvetica,sans-serif; margin:0; padding:0; }

* html .tiddler {height:1%;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em; border-width: 1px; }

#contentWrapper .chkOptionInput {border:0;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}


a {text-decoration:none;}

.externalLink {text-decoration:underline;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
#mainMenu .tiddlyLinkNonExisting,
#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}


.header {position:relative;}
.headerShadow {position:relative; padding:3em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:3em 0 1em 1em; left:0; top:0;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}
#sidebarTabs li:not(:last-child) { margin-bottom: 0.3em; }
#sidebarTabs ul:not(:last-child) { margin-bottom: 0.5em; }

.wizard { padding:0.1em 2em 0; }
.wizard__title    { font-size:2em; }
.wizard__subtitle { font-size:1.2em; }
.wizard__title, .wizard__subtitle { font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em; }
.wizardStep { padding:1em; }
.wizardFooter { padding: 0.8em 0; }
.wizardFooter .status { display: inline-block; line-height: 1.5; padding: 0.3em 1em; }
.wizardFooter .button { margin:0.5em 0 0; font-size:1.2em; padding:0.2em 0.5em; }

#messageArea { position:fixed; top:2em; right:0; margin:0.5em; padding:0.7em 1em; z-index:2000; }
.messageToolbar { text-align:right; padding:0.2em 0; }
.messageToolbar__button { text-decoration:underline; }
.messageToolbar__button_withIcon { display: inline-block; }
.tw-icon { height: 1em; width: 1em; } /* width for IE */
.tw-icon line { stroke-width: 1; stroke-linecap: round; }
.messageArea__text:not(:last-child) { margin-bottom: 0.3em; }
.messageArea__text a { text-decoration:underline; }

.popup {position:absolute; z-index:300; font-size:.9em; padding:0.3em 0; list-style:none; margin:0;}
.popup .popupMessage, .popup li.disabled, .popup li a { padding: 0.3em 0.7em; }
.popup li a {display:block; font-weight:normal; cursor:pointer;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {display: inline-block; white-space: nowrap; position: relative; bottom: -0.7px; margin: 0 0.25em 0 0; padding:0.2em;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler { padding: 1em; }

.title { font-size: 1.6em; font-weight: bold; }
.subtitle { font-size: 1.1em; }

.missing .viewer, .missing .title { font-style: italic; }
.missing .subtitle { display: none; }

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagged li, .tagging li { margin: 0.3em 0; }
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation { padding: 0.5em 0.8em; margin: 0.5em 1px; }

.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable { border-collapse: collapse; margin: 0.8em 0; }
.viewer th, .viewer td, .viewer tr, .viewer caption, .twtable th, .twtable td, .twtable tr, .twtable caption { padding: 0.2em 0.4em; }
.twtable caption { font-size: 0.9em; }
table.listView { margin: 0.8em 1.0em; }
table.listView th, table.listView td, table.listView tr { text-align: left; }
.listView &gt; thead { position: sticky; top: 0; }

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer pre {padding:0.5em; overflow:auto;}
pre, code { font-family: monospace, monospace; font-size: 1em; }
.viewer pre, .viewer code { line-height: 1.4em; }

.editor {font-size:1.1em; line-height:1.4em;}
.editor input, .editor textarea { display: block; width: 100%; box-sizing: border-box; font: inherit; padding: 0.1em 0.4em; }
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0; padding-bottom:0;}

.fieldsetFix {border:0; padding:0; margin:1px 0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding: 0.3em 0.5em; display: inline-block;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel { display:none; z-index:100; position:absolute; width:90%; margin:0 5%; }
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
  #mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea { display: none !important; }
  #displayArea { margin: 1em 1em 0em; }
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>

</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="BackupMacro Concept" modifier="FND" created="200705301512" modified="200706040731" tags="concept tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706040731">
<pre>a simple macro button for creating custom-named backup files
!Planned Features
* custom timestamp format for backups
* an optional edit summary can be added to the filename
!Implementation
* based upon Eric's [[NewDocumentPlugin|http://www.tiddlytools.com/#NewDocumentPlugin]] and/or [[LessBackupsPlugin|http://lessbackupsplugin.tiddlyspot.com]]
* edit summary via a simple input box ({{{prompt()}}})
!!Issues
* potentially dangerous characters need to be excluded from the edit summary</pre>
</div>
<div title="BlockCollapseMacro" modifier="FND" created="200708180717" modified="200708181433" tags="plugin macro systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708181433">
<pre>/***
|''Name''|BlockCollapseMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#BlockCollapseMacro]]|
|''Version''|0.3|
|''Author''|FND|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|macro for collapsing/expanding block elements' height on click|
!Usage Notes
* two options:
** add {{{&lt;&lt;blockCollapse [class] [tag]&gt;&gt;}}} to the desired tiddler(s)
** add as a macro to ViewTemplate: {{{&lt;span macro='blockCollapse [class] [tag]'&gt;&lt;/span&gt;}}}
!!Example
{{{&lt;&lt;blockCollapse &quot;footer&quot; &quot;h1&quot;&gt;&gt;}}} &lt;&lt;blockCollapse &quot;footer&quot; &quot;h1&quot;&gt;&gt; /% DEBUG: not working here %/
!Revision History
!!v0.3 (2007-08-17)
* adapted from [[TableHighlightMacro|http://devpad.tiddlyspot.com/#TableHighlightMacro]]
!To Do
* rename plugin =&gt; also rename dependencies (macro name, default class and style sheet)
* fix/remove DEBUG flags
* adjust Description and Usage Notes
!Code
***/
//{{{
config.macros.blockCollapse = {}
config.macros.blockCollapse.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	// process parameters
	var collapseClass = (params[0] &amp;&amp; params[0] != &quot;&quot;) ? params[0] : &quot;blockCollapse&quot;;
	var targetElement = (params[1] &amp;&amp; params[1] != &quot;&quot;) ? params[1] : &quot;pre&quot;;
	// toggle collapsing
	var els = story.findContainingTiddler(place).getElementsByTagName(targetElement);
	for(var i = 0; i &lt; els.length; i++) {
		els[i].onclick = function() {
			config.macros.blockCollapse.toggleCollapse(this, collapseClass);
		};
	}
}

config.macros.blockCollapse.toggleCollapse = function(el, customClass) {
	if(!hasClass(el, customClass)) {
		addClass(el, customClass);
		//el.style.height = &quot;1em !important&quot;; // DEBUG
		//el.style.border = &quot;10px dashed #F00 !important&quot;; // DEBUG 
	} else {
		removeClass(el, customClass);
		//el.style.height = &quot;&quot;; // DEBUG
		//el.style.border = &quot;&quot;; // DEBUG
	}
}

// set default styles
setStylesheet(&quot;.blockCollapse { &quot;
	+ &quot;height: 1em !important; &quot;
	+ &quot;border: 10px dashed #0F0 !important; &quot; // DEBUG
	+ &quot;overflow: hidden !important; &quot; // DEBUG
	+ &quot;}&quot;,
	&quot;StyleSheetBlockCollapse&quot;);
//}}}</pre>
</div>
<div title="ButtonMemoryMacro" modifier="FND" created="200712201748" modified="200712211026" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712211026">
<pre>/***
|''Name''|ButtonMemoryMacro|
|''Version''|0.2|
|''Status''|@@experimental@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#ButtonMemoryMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|creates a list of buttons and remembers the order they were clicked in|
!Usage
{{{
&lt;&lt;btnmem &quot;[button 1 label];[button 2 label];[button 3 label] ...&quot;&gt;&gt;
}}}
!!Example
&lt;&lt;btnmem &quot;foo;bar;baz&quot;&gt;&gt;
!Revision History
!!v0.1 (2007-12-20)
* initial release
!!v0.2 (2007-12-21)
* added configuration options
* changed parameter processing
* selection buttons now update output
!To Do
* rename
* named macro parameters for config items
* code sanitzing
* documentation
* allow for more than one instance at a time (due to global selection array and output container)
!Code
***/
//{{{
config.macros.btnmem = {
	resetLabel: &quot;reset&quot;,
	submitLabel: &quot;submit&quot;,
	itemSeparator: &quot;;&quot;,
	itemPrefix: &quot;* &quot;,
	itemSuffix: &quot;\n&quot;,
	outputID: &quot;btnMemOutput&quot;,
	itemButtonClass: &quot;button btnMemItemBtn&quot;,
	functionButtonClass: &quot;button btnMemFunctionBtn&quot;,
	selectionBoxClass: &quot;btnMemSelectionBox&quot;,
	functionBoxClass: &quot;btnMemFunctionBox&quot;,
	selection: []
};

config.macros.btnmem.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	// create selection buttons
	if(params[0]) var items = params[0].split(this.itemSeparator);
	var e = createTiddlyElement(place, &quot;div&quot;, null, this.selectionBoxClass);
	for(var i = 0; i &lt; items.length; i++) {
		createTiddlyButton(e, items[i], null,
			function() { config.macros.btnmem.extendSelection(this.firstChild.nodeValue); },
			this.itemButtonClass);
	}
	// create function buttons
	e = createTiddlyElement(place, &quot;div&quot;, null, this.functionBoxClass);
	createTiddlyButton(e, this.resetLabel, null,
		function() { config.macros.btnmem.resetResults(); },
		this.functionButtonClass);
	createTiddlyButton(e, this.submitLabel, null,
		function() { config.macros.btnmem.submitResults(); },
		this.functionButtonClass);
	// create output container -- DEBUG: reuse place instead!?
	config.macros.btnmem.output = createTiddlyElement(place, &quot;div&quot;, this.outputID);
}

config.macros.btnmem.extendSelection = function(str) {
	this.selection.push(str);
	var output = &quot;&quot;;
	var e = document.getElementById(this.outputID);
	if(e) {
		e.innerHTML = &quot;&quot;;
		for(var i = 0; i &lt; this.selection.length; i++) {
			output += this.itemPrefix + this.selection[i] + this.itemSuffix;
		}
		wikify(output.trim(), e);
	}
}

config.macros.btnmem.resetResults = function() {
	this.selection = [];
	var e = document.getElementById(this.outputID);
	if(e) e.innerHTML = &quot;&quot;;
}

config.macros.btnmem.submitResults = function() {
	var output = config.macros.btnmem.selection;
	this.resetResults();
	var e = document.getElementById(this.outputID);
	if(e) wikify(&quot;submitting selection:\n&quot; + output.join(), e);
}
//}}}</pre>
</div>
<div title="ColorPaletteView" modifier="FND" created="200711172342" modified="200711172346" tags="references" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711172346">
<pre>&lt;&lt;tiddler TemplateColorPaletteView with:ColorPalette&gt;&gt;</pre>
</div>
<div title="ColorPaletteView (obsolete)" modifier="FND" created="200706131357" modified="200711172339" tags="reference" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711172339">
<pre>&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','Background')}} Background&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','Foreground')}} Foreground&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','PrimaryPale')}} PrimaryPale&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','PrimaryLight')}} PrimaryLight&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','PrimaryMid')}} PrimaryMid&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','PrimaryDark')}} PrimaryDark&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','SecondaryPale')}} SecondaryPale&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','SecondaryLight')}} SecondaryLight&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','SecondaryMid')}} SecondaryMid&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','SecondaryDark')}} SecondaryDark&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','TertiaryPale')}} TertiaryPale&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','TertiaryLight')}} TertiaryLight&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','TertiaryMid')}} TertiaryMid&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','TertiaryDark')}} TertiaryDark&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('ColorPalette','Error')}} Error&gt;&gt;</pre>
</div>
<div title="CommentsFormatter" modifier="FND" created="200905061514" modified="200905071524" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200905071524">
<pre>/***
|''Name''|CommentsFormatter|
|''Description''|formatter adding comments syntax|
|''Author:''|FND|
|''Version''|0.1.2|
|''Status''|@@experimental@@|
|''Source''|http://devpad.tiddlyspot.com/#CommentsFormatter|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/contributors/FND/|
|''License''|[[BSD|http://www.opensource.org/licenses/bsd-license.php]]|
!Usage
!!Examples
{{{
lorem /# foo
ipsum /# bar
}}}
&lt;&lt;&lt;
lorem /# foo
ipsum /# bar
&lt;&lt;&lt;
!Revision History
!!v0.1 (2009-05-06)
* initial release
!Code
***/
//{{{
(function(formatters) {

formatters.push({
	name: &quot;comment&quot;,
	match: &quot;\/#.*?(\n|$)&quot;,
	handler: function(w) {
		createTiddlyElement(w.output, &quot;span&quot;, null, &quot;comment&quot;, w.matchText);
		createTiddlyElement(w.output, &quot;br&quot;);
	}
});

})(config.formatters);
//}}}</pre>
</div>
<div title="ComputedStyleMacro" modifier="FND" created="200803310716" modified="200803310716" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200803310716">
<pre>/***
|''Name''|ComputedStyleMacro|
|''Author''|FND|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#EvalMacro]]|
|''CodeRepository''|http://fnd.lewcid.org/svn/TiddlyWiki/|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Description''|retrieves parent container's computed CSS properties|
!Usage
{{{
&lt;&lt;calcStyle &quot;CSS property&quot;&gt;&gt;
}}}
!!Examples
&lt;&lt;calcStyle &quot;height&quot;&gt;&gt;
&lt;&lt;calcStyle &quot;font-size&quot;&gt;&gt;
!Revision History
!!v0.1 (2008-03-31)
* initial release
!Code
***/
//{{{
config.macros.calcStyle = {};
config.macros.calcStyle.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	wikify(&quot;; &quot; + params[0] + &quot;\n&quot; + &quot;: &quot; + getStyle(place, params[0]), place);
};

// retrieve computed CSS property
// by Inge JÃ¸rgensen (http://www.elektronaut.no/articles/2006/06/07/computed-styles)
function getStyle(element, cssRule) {
	if(document.defaultView &amp;&amp; document.defaultView.getComputedStyle) {
		var value = document.defaultView.getComputedStyle(element, &quot;&quot;).getPropertyValue(
			cssRule.replace(/[A-Z]/g, function(match, char) { 
				return &quot;-&quot; + char.toLowerCase(); 
			})
		);
	}
	else if(element.currentStyle)
		var value = element.currentStyle[cssRule];
	else
		var value = false;
	return value;
}
//}}}</pre>
</div>
<div title="ConditionalTableFormattingMacro" modifier="FND" created="200805302105" modified="200806010234" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200806010234">
<pre>/***
|''Name''|ConditionalTableFormattingMacro|
|''Description''|apply formatting based on table contents|
|''Author''|FND|
|''Version''|0.2|
|''Status''|@@experimental@@|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#EvalMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
!Usage
{{{
&lt;&lt;conditionalTableFormatting [cell|row] matchValue className&gt;&gt;
}}}
!!Parameters
|!Index|!Description|!Optional|!Default Value|
|1|case #1: value to search for|no|N/A|
|2|case #1: class to apply to matching elements|no|N/A|
|3|case #1: apply class to individual cells or the entire row|yes|cell|
|4|case #2: value to search for|yes|N/A|
|5|case #2: class to apply to matching elements|yes|N/A|
|6|case #2: apply class to individual cells or the entire row|yes|cell|
|7|...|yes|N/A|
|8|...|yes|N/A|
|9|...|yes|cell|
|10|case #//n//: value to search for|yes|N/A|
|11|case #//n//: class to apply to matching elements|yes|N/A|
|12|case #//n//: apply class to individual cells or the entire row|yes|cell|
!!Examples
&lt;&lt;&lt;
|foo|bar|baz|
&lt;&lt;conditionalTableFormatting &quot;&quot; &quot;bar&quot; &quot;header&quot;&gt;&gt;
&lt;&lt;&lt;
&lt;&lt;&lt;
|1|2|3|
|lorem|ipsum|dolor|
|foo|bar|baz|
&lt;&lt;conditionalTableFormatting &quot;row&quot; &quot;lorem&quot; &quot;header&quot; &quot;cell&quot; &quot;2&quot; &quot;wizard&quot;&gt;&gt;
&lt;&lt;&lt;
!Notes
The first table within the respective container (usually a tiddler) is used.
In order to target a different table, a CSS class wrapper can be used:
{{{
 {{dummyClass{
 |foo|bar|baz|
 }}}
}}}
!Revision History
!!v0.1 (2008-05-30)
* initial release
!!v0.2 (2008-06-01)
* significant changes to accommodate multiple cases per macro call
!To Do
* documentation
* option for combining matching conditions (boolean operators?)
* add option to target respective column
* add option for RegEx matching
!Code
***/
//{{{
config.macros.conditionalTableFormatting = {};

config.macros.conditionalTableFormatting.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	while(params.length) {
		// process parameters
		var target = (params.shift() === &quot;row&quot;) ? &quot;row&quot; : &quot;cell&quot;;
		var match = params.shift();
		var className = params.shift();
		// retrieve table cells
		var table = place.getElementsByTagName(&quot;table&quot;)[0];
		var cells = table.getElementsByTagName(&quot;td&quot;);
		for(var i = 0; i &lt; cells.length; i++) {
			var text = cells[i].innerText || cells[i].textContent;
			// apply conditional formatting
			if(text === match) {
				addClass((target === &quot;row&quot;) ? cells[i].parentNode : cells[i], className);
			}
		}
	}
};
//}}}</pre>
</div>
<div title="CoreOverride" modifier="FND" created="200707091221" modified="200707091221" tags="systemConfig tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200707091221">
<pre>//{{{
//--
//-- Popup menu (improvements to be included in the core)
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,theClass)
{
	var stackPosition = this.findStackPosition(root,&quot;popup&quot;);
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem ? elem : &quot;ol&quot;,&quot;popup&quot;,theClass ? theClass : &quot;popup&quot;);
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(offset,unused1,unused2)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,offset);
	addClass(curr.root,&quot;highlight&quot;);
	if(config.options.chkAnimate &amp;&amp; anim &amp;&amp; typeof Scroller == &quot;function&quot;)
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,offset)
{
	if(!offset) var offset = {x:0, y:0};
	if (popup.stackPosition&gt;=0){
		offset.x = offset.x + 15;
		}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var rootHeight = root.offsetHeight;
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + rootHeight + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth &gt; winWidth*0.75)
		popup.style.width = winWidth*0.75 + &quot;px&quot;;
	var popupWidth = popup.offsetWidth;
	if(popupLeft + popupWidth &gt; winWidth)
		popupLeft = winWidth - popupWidth;
	popup.style.left = popupLeft + &quot;px&quot;;
	popup.style.top = popupTop + &quot;px&quot;;
	popup.style.display = &quot;block&quot;;
}

Popup.findStackPosition = function(item,node)
{
	var pointer = -1;
	for (var i=this.stack.length-1; i&gt; -1; i--){
		if(isDescendant(item,this.stack[i][node])){
			pointer = i; 
		}
	}
	return pointer;
};

Popup.remove = function(pos)
{
	if (!pos) var pos = 0;
	if(Popup.stack.length &gt; pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t&gt;=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,&quot;highlight&quot;);
		removeNode(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};
//}}}</pre>
</div>
<div title="CrossIndexingMacro" modifier="FND" created="200802082231" modified="200802101354" tags="plguins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200802101354">
<pre>/***
|''Name''|CrossIndexingMacro|
|''Version''|0.7|
|''Status''|@@beta@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#CrossIndexingMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|[//TBD//]|
!Notes
Created [[for DaveG|http://groups.google.com/group/TiddlyWiki/browse_thread/thread/afa54bd105e791fa]]'s [[My Notes TiddlyWiki|http://www.giffmex.org/emptynotestw.html]].
!Usage
{{{
&lt;&lt;crossIndex [tag] [scope]&gt;&gt;
}}}
!Revision History
!!v0.5 (2008-02-08)
* initial release
!!v0.6 (2008-02-09)
* renamed to CrossIndexingMacro (from TiddlerHierarchyMacro)
* added listing of uncategorized items
* linkified headings
!!v0.7 (2008-02-10)
* added optional scope parameter
* fixed &quot;uncategorized&quot; listings
* minor code enhancements
!To Do
* rename
* documentation
* code sanitizing
!Code
***/
//{{{
config.macros.crossIndex = {};

config.macros.crossIndex.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var scope = params[1] || tiddler.title;
	var index = this.getIndex(scope, params[0]);
	var output = &quot;&quot;;
	var i;
	for(topic in index) {
		if(index[topic].length &gt; 0) {
			output += &quot;![[&quot; + topic + &quot;]]\n&quot;;
			for(i = 0; i &lt; index[topic].length; i++) {
				output += &quot;* [[&quot; + index[topic][i] + &quot;]]\n&quot;;
			}
		}
	}
	wikify(output, place);
}

config.macros.crossIndex.getIndex = function(scope, category) {
	// retrieve topics
	var topics = store.getTaggedTiddlers(category).map(function(t) { return t.title });
	// generate index
	var index = {
		uncategorized: []
	};
	for(i = 0; i &lt; topics.length; i++) {
		index[topics[i]] = [];
		store.forEachTiddler(function(title, tiddler) {
			if(tiddler.tags.containsAll([scope, topics[i]]))
				index[topics[i]].push(title);
			else if(tiddler.tags.contains(scope) &amp;&amp; !tiddler.tags.containsAny(topics))
				index.uncategorized.pushUnique(title);
		});
	}
	return index;
}
//}}}</pre>
</div>
<div title="DcTableOfContentsPlugin" modifier="FND" created="200711141727" modified="200805121322" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200805121322">
<pre>/***
|Name|DcTableOfContentsPlugin|
|Author|[[Doug Compton|http://www.zagware.com/tw/plugins.html#DcTableOfContentsPlugin]]|
|Contributors|[[Lewcid|http://lewcid.org]], [[FND|http://devpad.tiddlyspot.com]], [[ELS|http://www.tiddlytools.com]]|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com#DcTableOfContentsPlugin]]|
|Version|0.4.1|
|~CoreVersion|2.2|
&lt;&lt;showtoc&gt;&gt;
!Description
This macro will insert a table of contents reflecting the headings that are used in a tiddler and will be automatically updated when you make changes.  Each item in the table of contents can be clicked on to jump to that heading.  It can be used either inside of select tiddlers or inside a system wide template.

A parameter can be used to show the table of contents of a seperate tiddler, &amp;lt;&lt;showtoc tiddlerTitle&gt;&amp;gt;

It will also place a link beside each header which will jump the screen to the top of the current tiddler.  This will only be displayed if the current tiddler is using the &amp;lt;&lt;showtoc&gt;&amp;gt; macro.

The appearance of the table of contents and the link to jump to the top can be modified using CSS.  An example of this is given below.

!Usage
!!Only in select tiddlers
The table of contents above is an example of how to use this macro in a tiddler.  Just insert &amp;lt;&lt;showtoc&gt;&amp;gt; in a tiddler on a line by itself.

It can also display the table of contents of another tiddler by using the macro with a parameter, &amp;lt;&lt;showtoc tiddlerTitle&gt;&amp;gt;
!!On every tiddler
It can also be used in a template to have it show on every tiddler.  An example ViewTemplate is shown below.

//{{{
&lt;div class='toolbar' macro='toolbar -closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;Created &lt;span macro='view created date DD-MM-YY'&gt;&lt;/span&gt;, updated &lt;span macro='view modified date DD-MM-YY'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class=&quot;toc&quot; macro='showtoc'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
//}}}

!Examples
If you had a tiddler with the following headings:
{{{
!Heading1a
!!Heading2a
!!Heading2b
!!!Heading3
!Heading1b
}}}
this table of contents would be automatically generated:
* Heading1a
** Heading2a
** Heading2b
*** Heading3
* Heading1b
!Changing how it looks
To modifiy the appearance, you can use CSS similiar to the below.
//{{{
.dcTOC ul {
	color: red;
	list-style-type: lower-roman;
}
.dcTOC a {
	color: green;
	border: none;
}

.dcTOC a:hover {
	background: white;
	border: solid 1px;
}
.dcTOCTop {
	font-size: 2em;
	color: green;
}
//}}}

!Revision History
!!v0.1.0 (2006-04-07)
* initial release
!!v0.2.0 (2006-04-10)
* added the [top] link on headings to jump to the top of the current tiddler
* appearance can now be customized using CSS
* all event handlers now return false
!!v0.3.0 (2006-04-12)
* added the ability to show the table of contents of a seperate tiddler
* fixed an error when a heading had a ~WikiLink in it
!!v0.3.5 (2007-10-16)
* updated formatter object for compatibility with TiddlyWiki v2.2 (by Lewcid)
!!v0.4.0 (2007-11-14)
* added toggle button for collapsing/expanding table of contents element
* refactored documentation
!To Do
* code sanitizing/rewrite
* documentation refactoring
* use shadow tiddler for styles
!Code
***/
//{{{

version.extensions.DcTableOfContentsPlugin= {
	major: 0, minor: 4, revision: 0,
	type: &quot;macro&quot;,
	source: &quot;http://devpad.tiddlyspot.com#DcTableOfContentsPlugin&quot;
};

// Replace heading formatter with our own
for (var n=0; n&lt;config.formatters.length; n++) {
	var format = config.formatters[n];
	if (format.name == 'heading') {
		format.handler = function(w) {
			// following two lines is the default handler
			var e = createTiddlyElement(w.output, &quot;h&quot; + w.matchLength);
			w.subWikifyTerm(e, this.termRegExp); //updated for TW 2.2+

			// Only show [top] if current tiddler is using showtoc
			if (w.tiddler &amp;&amp; w.tiddler.isTOCInTiddler == 1) {
				// Create a container for the default CSS values
				var c = createTiddlyElement(e, &quot;div&quot;);
				c.setAttribute(&quot;style&quot;, &quot;font-size: 0.5em; color: blue;&quot;);
				// Create the link to jump to the top
				createTiddlyButton(c, &quot; [top]&quot;, &quot;Go to top of tiddler&quot;, window.scrollToTop, &quot;dcTOCTop&quot;, null, null);
			}
		}
		break;
	}
}

config.macros.showtoc = {
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		var text = &quot;&quot;;
		var title = &quot;&quot;;
		var myTiddler = null;

		// Did they pass in a tiddler?
		if (params.length) {
			title = params[0];
			myTiddler = store.getTiddler(title);
		} else {
			myTiddler = tiddler;
		}

		if (myTiddler == null) {
			wikify(&quot;ERROR: Could not find &quot; + title, place);
			return;
		}

		var lines = myTiddler .text.split(&quot;\n&quot;);
		myTiddler.isTOCInTiddler = 1;

		// Create a parent container so the TOC can be customized using CSS
		var r = createTiddlyElement(place, &quot;div&quot;, null, &quot;dcTOC&quot;);
		// create toggle button
		createTiddlyButton(r, &quot;toggle&quot;, &quot;show/collapse table of contents&quot;,
			function() { config.macros.showtoc.toggleElement(this.nextSibling); },
			&quot;toggleButton&quot;)
		// Create a container so the TOC can be customized using CSS
		var c = createTiddlyElement(r, &quot;div&quot;);

		if (lines != null) {
			for (var x=0; x&lt;lines.length; x++) {
				var line = lines[x];
				if (line.substr(0,1) == &quot;!&quot;) {
					// Find first non ! char
					for (var i=0; i&lt;line.length; i++) {
						if (line.substr(i, 1) != &quot;!&quot;) {
							break;
						}
					}
					var desc = line.substring(i);
					// Remove WikiLinks
					desc = desc.replace(/\[\[/g, &quot;&quot;);
					desc = desc.replace(/\]\]/g, &quot;&quot;);

					text += line.substr(0, i).replace(/[!]/g, '*');
					text += '&lt;html&gt;&lt;a href=&quot;javascript:;&quot; onClick=&quot;window.scrollToHeading(\'' + title + '\', \'' + desc+ '\', event)&quot;&gt;' + desc+ '&lt;/a&gt;&lt;/html&gt;\n';
				}
			}
		}
		wikify(text, c);
	}
}

config.macros.showtoc.toggleElement = function(e) {
	if(e) {
		if(e.style.display != &quot;none&quot;) {
			e.style.display = &quot;none&quot;;
		} else {
			e.style.display = &quot;&quot;;
		}
	}
};

window.scrollToTop = function(evt) {
	if (! evt)
		var evt = window.event;

	var target = resolveTarget(evt);
	var tiddler = story.findContainingTiddler(target);

	if (! tiddler)
		return false;

	window.scrollTo(0, ensureVisible(tiddler));

	return false;
};

window.scrollToHeading = function(title, anchorName, evt) {
	var tiddler = null;

	if (! evt)
		var evt = window.event;

	if (title) {
		story.displayTiddler(store.getTiddler(title), title, null, false);
		tiddler = document.getElementById(story.idPrefix + title);
	} else {
		var target = resolveTarget(evt);
		tiddler = story.findContainingTiddler(target);
	}

	if (tiddler == null)
		return false;
	
	var children1 = tiddler.getElementsByTagName(&quot;h1&quot;);
	var children2 = tiddler.getElementsByTagName(&quot;h2&quot;);
	var children3 = tiddler.getElementsByTagName(&quot;h3&quot;);
	var children4 = tiddler.getElementsByTagName(&quot;h4&quot;);
	var children5 = tiddler.getElementsByTagName(&quot;h5&quot;);

	var children = new Array();
	children = children.concat(children1, children2, children3, children4, children5);

	for (var i = 0; i &lt; children.length; i++) {
		for (var j = 0; j &lt; children[i].length; j++) {
			var heading = children[i][j].innerHTML;

			// Remove all HTML tags
			while (heading.indexOf(&quot;&lt;&quot;) &gt;= 0) {
				heading = heading.substring(0, heading.indexOf(&quot;&lt;&quot;)) + heading.substring(heading.indexOf(&quot;&gt;&quot;) + 1);
			}

			// Cut off the code added in showtoc for TOP
			heading = heading.substr(0, heading.length-6);

			if (heading == anchorName) {
				var y = findPosY(children[i][j]);
				window.scrollTo(0,y);
				return false;
			}
		}
	}
	return false
};
//}}}</pre>
</div>
<div title="DebuggingPlugin" modifier="FND" created="200705290911" modified="200705290953" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705290953">
<pre>/***
|Name|DebuggingPlugin|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#DebuggingPlugin]]|
|Version|0.5|
|Author|FND|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|provides a simple framework for debugging|
!Usage
* {{{showDebugBuffer(string)}}}
* {{{print_r(array, indentationPrefix)}}}
!Changelog
!!v0.5 (2007-05-29)
* initial release
!To Do
* use tiddler instead of a &quot;raw&quot; element
!Code
***/
//{{{
/* Styles (can be customized in the StyleSheetDEBUG shadow tiddler) */

config.shadowTiddlers.StyleSheetDEBUG = &quot;/*{{{*/\n&quot;
	+ &quot;#DebugBuffer {\n\tmargin: 10em 1em 1em;\n\tpadding: 4px;\n\tborder: 1px solid #AAA;\n\tfont-size: 1.2em;\n\tbackground-color: #F8F8F8;\n}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetDEBUG&quot;, refreshStyles);

/* Functions */

// create pane for debugging outputs
function createDebugBuffer(text) {
	// initialize DEBUG buffer
	text = &quot;******************\n&quot;
	+ &quot;** DEBUG BUFFER **\n&quot;
	+ &quot;******************\n\n&quot;
	+ text;
	// create output element
	createTiddlyElement(document.body, &quot;pre&quot;, &quot;DebugBuffer&quot;, null, text);
}

// print_r() for JavaScript (http://www.phpbuilder.com/board/showthread.php?t=10294264)
function print_r(input, _indent) {
    if(typeof(_indent) == 'string') {
        var indent = _indent + '    ';
        var paren_indent = _indent + '  ';
    } else {
        var indent = '    ';
        var paren_indent = '';
    }
    switch(typeof(input)) {
        case 'boolean':
            var output = (input ? 'true' : 'false') + &quot;\n&quot;;
            break;
        case 'object':
            if ( input===null ) {
                var output = &quot;null\n&quot;;
                break;
            }
            var output = ((input.reverse) ? 'Array' : 'Object') + &quot; (\n&quot;;
            for(var i in input) {
                output += indent + &quot;[&quot; + i + &quot;] =&gt; &quot; + print_r(input[i], indent);
            }
            output += paren_indent + &quot;)\n&quot;;
            break;
        case 'number':
        case 'string':
        default:
            var output = &quot;&quot; + input  + &quot;\n&quot;;
    }
    return output;
}
//}}}</pre>
</div>
<div title="DefaultOptions" modifier="FND" created="200701161457" modified="200705191526" tags="meta systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705191526">
<pre>/*{{{*/
// TiddlyWiki
config.options.txtUserName = &quot;FND&quot;;
config.options.chkAutoSave = false;
config.options.chkSaveBackups = false;
config.options.txtBackupFolder = &quot;Backup&quot;;
/*}}}*/</pre>
</div>
<div title="DoBackupMacro" modifier="FND" created="200701150641" modified="200706111006" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706111006">
<pre>/***
|''Name:''|DoBackupMacro|
|''Version:''|2.0 (9-Apr-2006)|
|''Author:''|[[Jack]]|
|''Type:''|Macro|
!Description
Creates a button which allows you to backup your TiddlyWiki on demand.
!Usage
Add the following command to your SideBarOptions tiddler:
{{{&lt;&lt;doBackup&gt;&gt;}}}
!Revision History
* Original by [[Jack]] 9-Apr-2006
!To Do
* List non-explicit links (e.g. from tagging macro)

!Code
***/
//{{{
version.extensions.doBackup= {major: 2, minor: 0, revision: 0, date: new Date(&quot;Apr 9, 2006&quot;)};
config.macros.doBackup={label: &quot;backup&quot;, prompt: &quot;Backup this TiddlyWiki&quot;}
config.macros.doBackup.handler = function(place)
{
 if(!readOnly)
 createTiddlyButton(place,this.label,this.prompt,function ()
{doBackup(); return false;},null,null,this.accessKey);
}

doBackup = function() {
 var optSaveBackups = config.options.chkSaveBackups
 config.options.chkSaveBackups = true
 saveChanges()
 config.options.chkSaveBackups = optSaveBackups
}

//}}}</pre>
</div>
<div title="EasyHighlightingPlugin" modifier="FND" created="200705251911" modified="200705271738" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705271738">
<pre>/***
|Name|EasyHighlightingPlugin|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#EasyHighlightingPlugin]]|
|Version|0.1|
|Author|FND|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|allow for simple highlighting by selecting text|
!Usage
[tbd]
!Changelog
!!v0.1 (2007-05-27)
* alpha version
!Issues / To Do
[tbd; cf [[[tw] discussion|http://groups.google.com/group/TiddlyWiki/t/349af49c41f8bf44]]]
''N.B.:'' development is currently ''ON HOLD'':
&lt;&lt;&lt;
Since the text is selected from the formatted (wikified) output, I'll run into trouble as soon as there's any kind of wiki markup involved (e.g. trying to highlight &quot;lorem ''ipsum'' dolor&quot; would not be recognized -- or it might even strip the bold formatting).
&lt;&lt;&lt;
!Code
***/
//{{{
/*
** Styles (can be customized in the StyleSheetEasyHighlighting shadow tiddler)
*/

config.shadowTiddlers.StyleSheetEasyHighlighting = &quot;/*{{{*/\n&quot;
	+ &quot;.highlightDefault {\n\tbackground-color: #FF0;\n\tcursor: pointer;\n}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetEasyHighlighting&quot;, refreshStyles);

/*
** Macro Code
*/

config.macros.EasyHighlighting = { label: &quot;Highlight&quot;, prompt: &quot;Toggle highlighting&quot; };
config.macros.EasyHighlighting.handler =
	function(place, macroName, params, wikifier, paramString, tiddler) {
		
}

/*
** Command Buttons
*/

/* Macro Button */
config.macros.EasyHighlighting = { label: &quot;Highlight&quot;, prompt: &quot;Toggle highlighting&quot;, accessKey: &quot;h&quot; }; // DEBUG: check accessKey usage
config.macros.EasyHighlighting.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	createTiddlyButton(place, this.label, this.prompt, function() { // DEBUG: how to pass current tiddler to function?
			// highlight selected text
			highlightPassage(place, tiddler, &quot;highlightDefault&quot;); // DEBUG: tiddler is undefined (see above)
			return false; // DEBUG: ?
		}, null, null, this.accessKey
	);
}

/* Toolbar Button */
config.commands.EasyHighlighting = { label: &quot;Highlight&quot;, prompt: &quot;Toggle highlighting&quot; } // DEBUG: accessKey!?
config.commands.EasyHighlighting.handler = function() {
	// highlight selected text
	highlightPassage(place, tiddler, &quot;highlightDefault&quot;);
	return false; // DEBUG: ?
}

/*
** Main Code
*/

highlightPassage = function(place, tiddler, className) {
	// get selection
	var selection = getSelText();
	if(selection == &quot;&quot;) {
		alert(&quot;Error: No text selected.&quot;);
		return
	}
	// retrieve tiddler -- DEBUG: obsolete?! only necessary for macro button, because tiddler parameter is not working there (see Command Buttons section)
	var here = story.findContainingTiddler(place);
	if(!here) {
		alert(&quot;Error: No tiddler specified.&quot;);
		return;
	}
	var title = here.getAttribute(&quot;tiddler&quot;);
	var tiddler = store.getTiddler(title);
	// determine tiddler contents
	var tiddlerContents = tiddler.text;
	var tiddlerParts = tiddlerContents.split(selection);
	var preSelection = tiddlerParts[0]; // DEBUG: to do
	var postSelection = tiddlerParts[1]; // DEBUG: to do
	// highlight selected passage
	alert(tiddlerParts.length + &quot;\n\npreSelection:\n&quot; + preSelection + &quot;\n\npostSelection:\n&quot; + postSelection); // DEBUG
	tiddlerContents = preSelection + &quot;{{&quot; + className + &quot;{&quot; + selection + &quot;}}}&quot; + postSelection;
	alert(&quot;tiddlerContents:\n&quot; + tiddlerContents); // DEBUG
	// store altered tiddler contents
	//wikify(tiddlerContents, place); // DEBUG'd
	// ??
	return false;
}

/*
** Support Functions
*/

// getSelText() by Jeff Anderson (http://www.codetoad.com/javascript_get_selected_text.asp)
function getSelText() {
	var txt = &quot;&quot;;
	if (window.getSelection) {
		txt = window.getSelection();
	} else if (document.getSelection) {
		txt = document.getSelection();
	} else if (document.selection) {
		txt = document.selection.createRange().text;
	} else {
		return;
	}
	return txt;
}
//}}}</pre>
</div>
<div title="EasyHighlightingTest" modifier="FND" created="200705271357" modified="200705271736" tags="test tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705271736">
<pre>This is a test for the EasyHighlightingPlugin.
&lt;&lt;EasyHighlighting&gt;&gt;
&lt;&lt;&lt;
Lorem ipsum dolor ''sit'' amet, consectetur adipisicing elit, sed do //eiusmod// tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea @@commodo@@ consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse --cillum-- dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia __deserunt__ mollit anim id est laborum.
&lt;&lt;&lt;</pre>
</div>
<div title="EasyLayoutPlugin" modifier="FND" created="200709091545" modified="200709091551" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709091551">
<pre>/***
&lt;&lt;EasyLayout&gt;&gt;
***/
//{{{
/*
** Macro Initialization
*/

config.macros.EasyLayout = {};
config.macros.EasyLayout.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	this.loadSettings();
	this.generateUI(place);
};

/*
** User Interface
*/

config.macros.EasyLayout.generateUI = function(parent) {
	// create root form
	var frm = createTiddlyElement(parent, &quot;form&quot;, null, &quot;easyLayout&quot;); // DEBUG: requires action parameter
	frm.style.border = &quot;1px solid #AAA&quot;; // DEBUG: use shadow tiddler for styles
	frm.style.marginBottom = &quot;1em&quot;; // DEBUG: use shadow tiddler for styles
	frm.style.padding = &quot;5px&quot;; // DEBUG: use shadow tiddler for styles
	frm.style.overflow = &quot;hidden&quot;; // DEBUG: use shadow tiddler for styles
	frm.style.backgroundColor = &quot;#EEE&quot;; // DEBUG: use shadow tiddler for styles

	// create custom UI elements
	this.createUiElements(frm);

	// create control buttons
	var btns = createTiddlyElement(frm, &quot;div&quot;);
	btns.style.textAlign = &quot;right&quot;; // DEBUG: use shadow tiddler for styles
	// preview
	var btn = createTiddlyElement(btns, &quot;input&quot;);
	btn.setAttribute(&quot;type&quot;, &quot;button&quot;);
	btn.setAttribute(&quot;value&quot;, &quot;Apply&quot;);
	btn.onclick = function() {
		config.macros.EasyLayout.applyChanges(false);
		return false;
	}
	// save
	btn = createTiddlyElement(btns, &quot;input&quot;);
	btn.setAttribute(&quot;type&quot;, &quot;button&quot;);
	btn.setAttribute(&quot;value&quot;, &quot;Save&quot;);
	btn.onclick = function() {
		config.macros.EasyLayout.applyChanges(true);
		return false;
	}
};

// DEBUG: read from JSON structure for easy modification
config.macros.EasyLayout.createUiElements = function(frm) {
	// initialize variables
	var fs = null; // fieldset
	var sc = null; // section

	/*
	** Header
	*/
	fs = this.createFieldset(frm, &quot;Header&quot;);
	// height
	sc = this.createSection(fs);
	this.createInputField(sc, &quot;input&quot;, &quot;height&quot;);
	this.createOptions(sc, &quot;headerHeight&quot;);
	// width
	sc = this.createSection(fs);
	this.createInputField(sc, &quot;input&quot;, &quot;width&quot;);
	this.createOptions(sc, &quot;headerWidth&quot;);

	/*
	** Sidebar
	*/
	fs = this.createFieldset(frm, &quot;Sidebar&quot;);
	// width
	sc = this.createSection(fs);
	this.createInputField(sc, &quot;input&quot;, &quot;width&quot;);
	this.createOptions(sc, &quot;sidebarWidth&quot;);
	// offset
	sc = this.createSection(fs);
	this.createInputField(sc, &quot;input&quot;, &quot;offset&quot;);
	this.createOptions(sc, &quot;sidebarOffset&quot;);
};

/*
** Layout Modification
*/

config.macros.EasyLayout.applyChanges = function(permanent) {
	alert(&quot;not implemented&quot;); // DEBUG: to do
	if(permanent)
		this.saveSettings();
}

/*
** Settings
*/

config.macros.EasyLayout.saveSettings = function() {
	alert(&quot;permanent settings not implemented&quot;); // DEBUG: to do -- options: slices in a dedicated tiddler, extended fields, JSON(?)
}

config.macros.EasyLayout.loadSettings = function() {
	alert(&quot;permanent settings not implemented&quot;); // DEBUG: to do
}

/*
** DOM Utilities
*/

config.macros.EasyLayout.createFieldset = function(parent, label) {
	var e = createTiddlyElement(parent, &quot;fieldset&quot;);
	e.style.marginBottom = &quot;5px&quot;; // DEBUG: use shadow tiddler for styles
	createTiddlyElement(e, &quot;legend&quot;, null, null, label);
	return e;
};

config.macros.EasyLayout.createSection = function(parent) {
	var e = createTiddlyElement(parent, &quot;DIV&quot;);
	e.style.marginBottom = &quot;5px&quot;; // DEBUG: use shadow tiddler for styles
	return e;
};

config.macros.EasyLayout.createInputField = function(parent, ID, description) {
	var e = createTiddlyElement(parent, &quot;div&quot;, null, null, description + &quot;:&quot;);
	e.style.fontWeight = &quot;bold&quot;; // DEBUG: use shadow tiddler for styles
	e.style.marginRight = &quot;1em&quot;; // DEBUG: use shadow tiddler for styles
	e = createTiddlyElement(parent, &quot;input&quot;, ID);
	e.setAttribute(&quot;type&quot;, &quot;text&quot;); // DEBUG: might not work in IE; need to set attribute before appending node to document!?
	return e;
};

config.macros.EasyLayout.createOptions = function(parent, IdPrefix) { // DEBUG: dynamic arguments - e.g. createOptions(&quot;px&quot;, &quot;em&quot;, &quot;%&quot;)	
	parent.innerHTML = parent.innerHTML // innerHTML required due to IE bug
		+ &quot;&lt;input id='&quot; + IdPrefix + &quot;1' name='&quot; + IdPrefix + &quot;' type='radio'&gt;&quot;
		+ &quot;&lt;label for='&quot; + IdPrefix + &quot;1'&gt;px&lt;/label&gt;&quot;
		+ &quot;&lt;input id='&quot; + IdPrefix + &quot;2' name='&quot; + IdPrefix + &quot;' type='radio'&gt;&quot;
		+ &quot;&lt;label for='&quot; + IdPrefix + &quot;2'&gt;em&lt;/label&gt;&quot;
		+ &quot;&lt;input id='&quot; + IdPrefix + &quot;3' name='&quot; + IdPrefix + &quot;' type='radio'&gt;&quot;
		+ &quot;&lt;label for='&quot; + IdPrefix + &quot;3'&gt;%&lt;/label&gt;&quot;
};
//}}}</pre>
</div>
<div title="EditPortlet" modifier="FND" created="200709062035" modified="200709062037" tags="plugin concept" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709062037">
<pre>free-floating edit window (non-disruptive edit mode)
edit mode as a (temporary) portlet instead of replacing the wikified tiddler view
cf. [[mock-up image|http://www.tiddlywiki.org/wiki/Image:EditPortlet.png]]</pre>
</div>
<div title="EvalMacro" modifier="FND" created="200710140801" modified="200804181034" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200804181034">
<pre>/***
|''Name''|EvalMacro|
|''Version''|0.96|
|''Status''|stable|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#EvalMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Allows executing JavaScript code to return computed values.|
!Usage
{{{
&lt;&lt;eval [code] [mode]&gt;&gt;
}}}
* {{{&lt;&lt;eval {{code}}&gt;&gt;}}}
** if no mode is specified, the first parameter's contents will be wikified
** through the use evaluated parameters, calculations can be performed within this parameter
* {{{&lt;&lt;eval [[code]] &quot;scriptMode&quot;&gt;&gt;}}}
** if &quot;scriptMode&quot; is specified, the contents of the first parameter will be evaluated in place, proving access to local variables like the tiddler object
** no output is generated in this mode by default, though the {{{wikify()}}} function can be used for that
!!Examples
&lt;&lt;eval {{
	var dateFormat = &quot;YYYY-0MM-0DD 0hh:0mm&quot;;
	var now = new Date;
	&quot;time: &quot; + now.formatString(dateFormat);
}}&gt;&gt;
&lt;&lt;eval
	[[
	var dateFormat = &quot;YYYY-0MM-0DD&quot;;
	var title = tiddler.title;
	var author = tiddler.modifier;
	var date = tiddler.modified.formatString(dateFormat);
	wikify(title + &quot;: &quot; + author + &quot;, &quot; + date, place);
	]]
	&quot;scriptMode&quot;
&gt;&gt;
!Revision History
!!v0.9 (2007-10-14)
* initial release
!!v0.95 (2007-12-23)
* introduced script mode
!!v0.96 (2008-04-18)
* bugfix regarding type conversion
!Code
***/
//{{{
config.macros.eval = {};
config.macros.eval.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(params[1] == &quot;scriptMode&quot;)
		eval(params[0]);
	else
		wikify(params[0].toString(), place);
}
//}}}</pre>
</div>
<div title="ExportAllPlugins" creator="YourName" modifier="YourName" created="202507091948" changecount="1">
<pre>&lt;&lt;exportByTag &quot;systemConfig&quot; file:&quot;./plugins/&quot; format:js&gt;&gt;</pre>
</div>
<div title="ForEachTiddlerPlugin" creator="YourName" modifier="YourName" created="202507091947" tags="systemConfig" changecount="1">
<pre>/***
|''Name:''|ForEachTiddlerPlugin|
|''Version:''|1.0.8 (2007-04-12)|
|''Source:''|http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2007 [[abego Software|http://www.abego-software.de]]|
|''TiddlyWiki:''|1.2.38+, 2.0|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|
!Description

Create customizable lists, tables etc. for your selections of tiddlers. Specify the tiddlers to include and their order through a powerful language.

''Syntax:''
|&gt;|{{{&lt;&lt;}}}''forEachTiddler'' [''in'' //tiddlyWikiPath//] [''where'' //whereCondition//] [''sortBy'' //sortExpression// [''ascending'' //or// ''descending'']] [''script'' //scriptText//] [//action// [//actionParameters//]]{{{&gt;&gt;}}}|
|//tiddlyWikiPath//|The filepath to the TiddlyWiki the macro should work on. When missing the current TiddlyWiki is used.|
|//whereCondition//|(quoted) JavaScript boolean expression. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//sortExpression//|(quoted) JavaScript expression returning &quot;comparable&quot; objects (using '{{{&lt;}}}','{{{&gt;}}}','{{{==}}}'. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//scriptText//|(quoted) JavaScript text. Typically defines JavaScript functions that are called by the various JavaScript expressions (whereClause, sortClause, action arguments,...)|
|//action//|The action that should be performed on every selected tiddler, in the given order. By default the actions [[addToList|AddToListAction]] and [[write|WriteAction]] are supported. When no action is specified [[addToList|AddToListAction]]  is used.|
|//actionParameters//|(action specific) parameters the action may refer while processing the tiddlers (see action descriptions for details). &lt;&lt;tiddler [[JavaScript in actionParameters]]&gt;&gt;|
|&gt;|~~Syntax formatting: Keywords in ''bold'', optional parts in [...]. 'or' means that exactly one of the two alternatives must exist.~~|

See details see [[ForEachTiddlerMacro]] and [[ForEachTiddlerExamples]].

!Revision history
* v1.0.8 (2007-04-12)
** Adapted to latest TiddlyWiki 2.2 Beta importTiddlyWiki API (introduced with changeset 2004). TiddlyWiki 2.2 Beta builds prior to changeset 2004 are no longer supported (but TiddlyWiki 2.1 and earlier, of cause)
* v1.0.7 (2007-03-28)
** Also support &quot;pre&quot; formatted TiddlyWikis (introduced with TW 2.2) (when using &quot;in&quot; clause to work on external tiddlers)
* v1.0.6 (2006-09-16)
** Context provides &quot;viewerTiddler&quot;, i.e. the tiddler used to view the macro. Most times this is equal to the &quot;inTiddler&quot;, but when using the &quot;tiddler&quot; macro both may be different.
** Support &quot;begin&quot;, &quot;end&quot; and &quot;none&quot; expressions in &quot;write&quot; action
* v1.0.5 (2006-02-05)
** Pass tiddler containing the macro with wikify, context object also holds reference to tiddler containing the macro (&quot;inTiddler&quot;). Thanks to SimonBaird.
** Support Firefox 1.5.0.1
** Internal
*** Make &quot;JSLint&quot; conform
*** &quot;Only install once&quot;
* v1.0.4 (2006-01-06)
** Support TiddlyWiki 2.0
* v1.0.3 (2005-12-22)
** Features:
*** Write output to a file supports multi-byte environments (Thanks to Bram Chen)
*** Provide API to access the forEachTiddler functionality directly through JavaScript (see getTiddlers and performMacro)
** Enhancements:
*** Improved error messages on InternetExplorer.
* v1.0.2 (2005-12-10)
** Features:
*** context object also holds reference to store (TiddlyWiki)
** Fixed Bugs:
*** ForEachTiddler 1.0.1 has broken support on win32 Opera 8.51 (Thanks to BrunoSabin for reporting)
* v1.0.1 (2005-12-08)
** Features:
*** Access tiddlers stored in separated TiddlyWikis through the &quot;in&quot; option. I.e. you are no longer limited to only work on the &quot;current TiddlyWiki&quot;.
*** Write output to an external file using the &quot;toFile&quot; option of the &quot;write&quot; action. With this option you may write your customized tiddler exports.
*** Use the &quot;script&quot; section to define &quot;helper&quot; JavaScript functions etc. to be used in the various JavaScript expressions (whereClause, sortClause, action arguments,...).
*** Access and store context information for the current forEachTiddler invocation (through the build-in &quot;context&quot; object) .
*** Improved script evaluation (for where/sort clause and write scripts).
* v1.0.0 (2005-11-20)
** initial version

!Code
***/
//{{{


//============================================================================
//============================================================================
//		   ForEachTiddlerPlugin
//============================================================================
//============================================================================

// Only install once
if (!version.extensions.ForEachTiddlerPlugin) {

if (!window.abego) window.abego = {};

version.extensions.ForEachTiddlerPlugin = {
	major: 1, minor: 0, revision: 8,
	date: new Date(2007,3,12),
	source: &quot;http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin&quot;,
	licence: &quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,
	copyright: &quot;Copyright (c) abego Software GmbH, 2005-2007 (www.abego-software.de)&quot;
};

// For backward compatibility with TW 1.2.x
//
if (!TiddlyWiki.prototype.forEachTiddler) {
	TiddlyWiki.prototype.forEachTiddler = function(callback) {
		for(var t in this.tiddlers) {
			callback.call(this,t,this.tiddlers[t]);
		}
	};
}

//============================================================================
// forEachTiddler Macro
//============================================================================

version.extensions.forEachTiddler = {
	major: 1, minor: 0, revision: 8, date: new Date(2007,3,12), provider: &quot;http://tiddlywiki.abego-software.de&quot;};

// ---------------------------------------------------------------------------
// Configurations and constants
// ---------------------------------------------------------------------------

config.macros.forEachTiddler = {
	 // Standard Properties
	 label: &quot;forEachTiddler&quot;,
	 prompt: &quot;Perform actions on a (sorted) selection of tiddlers&quot;,

	 // actions
	 actions: {
		 addToList: {},
		 write: {}
	 }
};

// ---------------------------------------------------------------------------
//  The forEachTiddler Macro Handler
// ---------------------------------------------------------------------------

config.macros.forEachTiddler.getContainingTiddler = function(e) {
	while(e &amp;&amp; !hasClass(e,&quot;tiddler&quot;))
		e = e.parentNode;
	var title = e ? e.getAttribute(&quot;tiddler&quot;) : null;
	return title ? store.getTiddler(title) : null;
};

config.macros.forEachTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	// config.macros.forEachTiddler.traceMacroCall(place,macroName,params,wikifier,paramString,tiddler);

	if (!tiddler) tiddler = config.macros.forEachTiddler.getContainingTiddler(place);
	// --- Parsing ------------------------------------------

	var i = 0; // index running over the params
	// Parse the &quot;in&quot; clause
	var tiddlyWikiPath = undefined;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;in&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;TiddlyWiki path expected behind 'in'.&quot;);
			return;
		}
		tiddlyWikiPath = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the where clause
	var whereClause =&quot;true&quot;;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;where&quot;) {
		i++;
		whereClause = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the sort stuff
	var sortClause = null;
	var sortAscending = true;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;sortBy&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;sortClause missing behind 'sortBy'.&quot;);
			return;
		}
		sortClause = this.paramEncode(params[i]);
		i++;

		if ((i &lt; params.length) &amp;&amp; (params[i] == &quot;ascending&quot; || params[i] == &quot;descending&quot;)) {
			 sortAscending = params[i] == &quot;ascending&quot;;
			 i++;
		}
	}

	// Parse the script
	var scriptText = null;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;script&quot;) {
		i++;
		scriptText = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the action.
	// When we are already at the end use the default action
	var actionName = &quot;addToList&quot;;
	if (i &lt; params.length) {
	   if (!config.macros.forEachTiddler.actions[params[i]]) {
			this.handleError(place, &quot;Unknown action '&quot;+params[i]+&quot;'.&quot;);
			return;
		} else {
			actionName = params[i];
			i++;
		}
	}

	// Get the action parameter
	// (the parsing is done inside the individual action implementation.)
	var actionParameter = params.slice(i);


	// --- Processing ------------------------------------------
	try {
		this.performMacro({
				place: place,
				inTiddler: tiddler,
				whereClause: whereClause,
				sortClause: sortClause,
				sortAscending: sortAscending,
				actionName: actionName,
				actionParameter: actionParameter,
				scriptText: scriptText,
				tiddlyWikiPath: tiddlyWikiPath});

	} catch (e) {
		this.handleError(place, e);
	}
};

// Returns an object with properties &quot;tiddlers&quot; and &quot;context&quot;.
// tiddlers holds the (sorted) tiddlers selected by the parameter,
// context the context of the execution of the macro.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlersAndContext = function(parameter) {

	var context = config.macros.forEachTiddler.createContext(parameter.place, parameter.whereClause, parameter.sortClause, parameter.sortAscending, parameter.actionName, parameter.actionParameter, parameter.scriptText, parameter.tiddlyWikiPath, parameter.inTiddler);

	var tiddlyWiki = parameter.tiddlyWikiPath ? this.loadTiddlyWiki(parameter.tiddlyWikiPath) : store;
	context[&quot;tiddlyWiki&quot;] = tiddlyWiki;

	// Get the tiddlers, as defined by the whereClause
	var tiddlers = this.findTiddlers(parameter.whereClause, context, tiddlyWiki);
	context[&quot;tiddlers&quot;] = tiddlers;

	// Sort the tiddlers, when sorting is required.
	if (parameter.sortClause) {
		this.sortTiddlers(tiddlers, parameter.sortClause, parameter.sortAscending, context);
	}

	return {tiddlers: tiddlers, context: context};
};

// Returns the (sorted) tiddlers selected by the parameter.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlers = function(parameter) {
	return this.getTiddlersAndContext(parameter).tiddlers;
};

// Performs the macros with the given parameter.
//
// @param parameter holds the parameter of the macro as separate properties.
//				  The following properties are supported:
//
//						place
//						whereClause
//						sortClause
//						sortAscending
//						actionName
//						actionParameter
//						scriptText
//						tiddlyWikiPath
//
//					All properties are optional.
//					For most actions the place property must be defined.
//
config.macros.forEachTiddler.performMacro = function(parameter) {
	var tiddlersAndContext = this.getTiddlersAndContext(parameter);

	// Perform the action
	var actionName = parameter.actionName ? parameter.actionName : &quot;addToList&quot;;
	var action = config.macros.forEachTiddler.actions[actionName];
	if (!action) {
		this.handleError(parameter.place, &quot;Unknown action '&quot;+actionName+&quot;'.&quot;);
		return;
	}

	var actionHandler = action.handler;
	actionHandler(parameter.place, tiddlersAndContext.tiddlers, parameter.actionParameter, tiddlersAndContext.context);
};

// ---------------------------------------------------------------------------
//  The actions
// ---------------------------------------------------------------------------

// Internal.
//
// --- The addToList Action -----------------------------------------------
//
config.macros.forEachTiddler.actions.addToList.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;addToList&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var list = document.createElement(&quot;ul&quot;);
	place.appendChild(list);
	for (var i = 0; i &lt; tiddlers.length; i++) {
		var tiddler = tiddlers[i];
		var listItem = document.createElement(&quot;li&quot;);
		list.appendChild(listItem);
		createTiddlyLink(listItem, tiddler.title, true);
	}
};

abego.parseNamedParameter = function(name, parameter, i) {
	var beginExpression = null;
	if ((i &lt; parameter.length) &amp;&amp; parameter[i] == name) {
		i++;
		if (i &gt;= parameter.length) {
			throw &quot;Missing text behind '%0'&quot;.format([name]);
		}

		return config.macros.forEachTiddler.paramEncode(parameter[i]);
	}
	return null;
}

// Internal.
//
// --- The write Action ---------------------------------------------------
//
config.macros.forEachTiddler.actions.write.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;
	if (p &gt;= parameter.length) {
		this.handleError(place, &quot;Missing expression behind 'write'.&quot;);
		return;
	}

	var textExpression = config.macros.forEachTiddler.paramEncode(parameter[p]);
	p++;

	// Parse the &quot;begin&quot; option
	var beginExpression = abego.parseNamedParameter(&quot;begin&quot;, parameter, p);
	if (beginExpression !== null)
		p += 2;
	var endExpression = abego.parseNamedParameter(&quot;end&quot;, parameter, p);
	if (endExpression !== null)
		p += 2;
	var noneExpression = abego.parseNamedParameter(&quot;none&quot;, parameter, p);
	if (noneExpression !== null)
		p += 2;

	// Parse the &quot;toFile&quot; option
	var filename = null;
	var lineSeparator = undefined;
	if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;toFile&quot;) {
		p++;
		if (p &gt;= parameter.length) {
			this.handleError(place, &quot;Filename expected behind 'toFile' of 'write' action.&quot;);
			return;
		}

		filename = config.macros.forEachTiddler.getLocalPath(config.macros.forEachTiddler.paramEncode(parameter[p]));
		p++;
		if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;withLineSeparator&quot;) {
			p++;
			if (p &gt;= parameter.length) {
				this.handleError(place, &quot;Line separator text expected behind 'withLineSeparator' of 'write' action.&quot;);
				return;
			}
			lineSeparator = config.macros.forEachTiddler.paramEncode(parameter[p]);
			p++;
		}
	}

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;write&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(textExpression, context);
	var count = tiddlers.length;
	var text = &quot;&quot;;
	if (count &gt; 0 &amp;&amp; beginExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(beginExpression, context)(undefined, context, count, undefined);

	for (var i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		text += func(tiddler, context, count, i);
	}

	if (count &gt; 0 &amp;&amp; endExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(endExpression, context)(undefined, context, count, undefined);

	if (count == 0 &amp;&amp; noneExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(noneExpression, context)(undefined, context, count, undefined);


	if (filename) {
		if (lineSeparator !== undefined) {
			lineSeparator = lineSeparator.replace(/\\n/mg, &quot;\n&quot;).replace(/\\r/mg, &quot;\r&quot;);
			text = text.replace(/\n/mg,lineSeparator);
		}
		saveFile(filename, convertUnicodeToUTF8(text));
	} else {
		var wrapper = createTiddlyElement(place, &quot;span&quot;);
		wikify(text, wrapper, null/* highlightRegExp */, context.inTiddler);
	}
};


// ---------------------------------------------------------------------------
//  Helpers
// ---------------------------------------------------------------------------

// Internal.
//
config.macros.forEachTiddler.createContext = function(placeParam, whereClauseParam, sortClauseParam, sortAscendingParam, actionNameParam, actionParameterParam, scriptText, tiddlyWikiPathParam, inTiddlerParam) {
	return {
		place : placeParam,
		whereClause : whereClauseParam,
		sortClause : sortClauseParam,
		sortAscending : sortAscendingParam,
		script : scriptText,
		actionName : actionNameParam,
		actionParameter : actionParameterParam,
		tiddlyWikiPath : tiddlyWikiPathParam,
		inTiddler : inTiddlerParam, // the tiddler containing the &lt;&lt;forEachTiddler ...&gt;&gt; macro call.
		viewerTiddler : config.macros.forEachTiddler.getContainingTiddler(placeParam) // the tiddler showing the forEachTiddler result
	};
};

// Internal.
//
// Returns a TiddlyWiki with the tiddlers loaded from the TiddlyWiki of
// the given path.
//
config.macros.forEachTiddler.loadTiddlyWiki = function(path, idPrefix) {
	if (!idPrefix) {
		idPrefix = &quot;store&quot;;
	}
	var lenPrefix = idPrefix.length;

	// Read the content of the given file
	var content = loadFile(this.getLocalPath(path));
	if(content === null) {
		throw &quot;TiddlyWiki '&quot;+path+&quot;' not found.&quot;;
	}

	var tiddlyWiki = new TiddlyWiki();

	// Starting with TW 2.2 there is a helper function to import the tiddlers
	if (tiddlyWiki.importTiddlyWiki) {
		if (!tiddlyWiki.importTiddlyWiki(content))
			throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
		tiddlyWiki.dirty = false;
		return tiddlyWiki;
	}

	// The legacy code, for TW &lt; 2.2

	// Locate the storeArea div's
	var posOpeningDiv = content.indexOf(startSaveArea);
	var posClosingDiv = content.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1)) {
		throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
	}
	var storageText = content.substr(posOpeningDiv + startSaveArea.length, posClosingDiv);

	// Create a &quot;div&quot; element that contains the storage text
	var myStorageDiv = document.createElement(&quot;div&quot;);
	myStorageDiv.innerHTML = storageText;
	myStorageDiv.normalize();

	// Create all tiddlers in a new TiddlyWiki
	// (following code is modified copy of TiddlyWiki.prototype.loadFromDiv)
	var store = myStorageDiv.childNodes;
	for(var t = 0; t &lt; store.length; t++) {
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute(&quot;tiddler&quot;);
		if(!title &amp;&amp; e.id &amp;&amp; e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title &amp;&amp; title !== &quot;&quot;) {
			var tiddler = tiddlyWiki.createTiddler(title);
			tiddler.loadFromDiv(e,title);
		}
	}
	tiddlyWiki.dirty = false;

	return tiddlyWiki;
};



// Internal.
//
// Returns a function that has a function body returning the given javaScriptExpression.
// The function has the parameters:
//
//	 (tiddler, context, count, index)
//
config.macros.forEachTiddler.getEvalTiddlerFunction = function (javaScriptExpression, context) {
	var script = context[&quot;script&quot;];
	var functionText = &quot;var theFunction = function(tiddler, context, count, index) { return &quot;+javaScriptExpression+&quot;}&quot;;
	var fullText = (script ? script+&quot;;&quot; : &quot;&quot;)+functionText+&quot;;theFunction;&quot;;
	return eval(fullText);
};

// Internal.
//
config.macros.forEachTiddler.findTiddlers = function(whereClause, context, tiddlyWiki) {
	var result = [];
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(whereClause, context);
	tiddlyWiki.forEachTiddler(function(title,tiddler) {
		if (func(tiddler, context, undefined, undefined)) {
			result.push(tiddler);
		}
	});
	return result;
};

// Internal.
//
config.macros.forEachTiddler.createExtraParameterErrorElement = function(place, actionName, parameter, firstUnusedIndex) {
	var message = &quot;Extra parameter behind '&quot;+actionName+&quot;':&quot;;
	for (var i = firstUnusedIndex; i &lt; parameter.length; i++) {
		message += &quot; &quot;+parameter[i];
	}
	this.handleError(place, message);
};

// Internal.
//
config.macros.forEachTiddler.sortAscending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? -1
			   : +1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortDescending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? +1
			   : -1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortTiddlers = function(tiddlers, sortClause, ascending, context) {
	// To avoid evaluating the sortClause whenever two items are compared
	// we pre-calculate the sortValue for every item in the array and store it in a
	// temporary property (&quot;forEachTiddlerSortValue&quot;) of the tiddlers.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(sortClause, context);
	var count = tiddlers.length;
	var i;
	for (i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		tiddler.forEachTiddlerSortValue = func(tiddler,context, undefined, undefined);
	}

	// Do the sorting
	tiddlers.sort(ascending ? this.sortAscending : this.sortDescending);

	// Delete the temporary property that holds the sortValue.
	for (i = 0; i &lt; tiddlers.length; i++) {
		delete tiddlers[i].forEachTiddlerSortValue;
	}
};


// Internal.
//
config.macros.forEachTiddler.trace = function(message) {
	displayMessage(message);
};

// Internal.
//
config.macros.forEachTiddler.traceMacroCall = function(place,macroName,params) {
	var message =&quot;&lt;&lt;&quot;+macroName;
	for (var i = 0; i &lt; params.length; i++) {
		message += &quot; &quot;+params[i];
	}
	message += &quot;&gt;&gt;&quot;;
	displayMessage(message);
};


// Internal.
//
// Creates an element that holds an error message
//
config.macros.forEachTiddler.createErrorElement = function(place, exception) {
	var message = (exception.description) ? exception.description : exception.toString();
	return createTiddlyElement(place,&quot;span&quot;,null,&quot;forEachTiddlerError&quot;,&quot;&lt;&lt;forEachTiddler ...&gt;&gt;: &quot;+message);
};

// Internal.
//
// @param place [may be null]
//
config.macros.forEachTiddler.handleError = function(place, exception) {
	if (place) {
		this.createErrorElement(place, exception);
	} else {
		throw exception;
	}
};

// Internal.
//
// Encodes the given string.
//
// Replaces
//	 &quot;$))&quot; to &quot;&gt;&gt;&quot;
//	 &quot;$)&quot; to &quot;&gt;&quot;
//
config.macros.forEachTiddler.paramEncode = function(s) {
	var reGTGT = new RegExp(&quot;\\$\\)\\)&quot;,&quot;mg&quot;);
	var reGT = new RegExp(&quot;\\$\\)&quot;,&quot;mg&quot;);
	return s.replace(reGTGT, &quot;&gt;&gt;&quot;).replace(reGT, &quot;&gt;&quot;);
};

// Internal.
//
// Returns the given original path (that is a file path, starting with &quot;file:&quot;)
// as a path to a local file, in the systems native file format.
//
// Location information in the originalPath (i.e. the &quot;#&quot; and stuff following)
// is stripped.
//
config.macros.forEachTiddler.getLocalPath = function(originalPath) {
	// Remove any location part of the URL
	var hashPos = originalPath.indexOf(&quot;#&quot;);
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert to a native file format assuming
	// &quot;file:///x:/path/path/path...&quot; - pc local file --&gt; &quot;x:\path\path\path...&quot;
	// &quot;file://///server/share/path/path/path...&quot; - FireFox pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	// &quot;file:///path/path/path...&quot; - mac/unix local file --&gt; &quot;/path/path/path...&quot;
	// &quot;file://server/share/path/path/path...&quot; - pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	var localPath;
	if(originalPath.charAt(9) == &quot;:&quot;) // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file://///&quot;) === 0) // FireFox pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(10)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file:///&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf(&quot;file:/&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(7)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	return localPath;
};

// ---------------------------------------------------------------------------
// Stylesheet Extensions (may be overridden by local StyleSheet)
// ---------------------------------------------------------------------------
//
setStylesheet(
	&quot;.forEachTiddlerError{color: #ffffff;background-color: #880000;}&quot;,
	&quot;forEachTiddler&quot;);

//============================================================================
// End of forEachTiddler Macro
//============================================================================


//============================================================================
// String.startsWith Function
//============================================================================
//
// Returns true if the string starts with the given prefix, false otherwise.
//
version.extensions[&quot;String.startsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.startsWith = function(prefix) {
	var n =  prefix.length;
	return (this.length &gt;= n) &amp;&amp; (this.slice(0, n) == prefix);
};



//============================================================================
// String.endsWith Function
//============================================================================
//
// Returns true if the string ends with the given suffix, false otherwise.
//
version.extensions[&quot;String.endsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.endsWith = function(suffix) {
	var n = suffix.length;
	return (this.length &gt;= n) &amp;&amp; (this.right(n) == suffix);
};


//============================================================================
// String.contains Function
//============================================================================
//
// Returns true when the string contains the given substring, false otherwise.
//
version.extensions[&quot;String.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.contains = function(substring) {
	return this.indexOf(substring) &gt;= 0;
};

//============================================================================
// Array.indexOf Function
//============================================================================
//
// Returns the index of the first occurance of the given item in the array or
// -1 when no such item exists.
//
// @param item [may be null]
//
version.extensions[&quot;Array.indexOf&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.indexOf = function(item) {
	for (var i = 0; i &lt; this.length; i++) {
		if (this[i] == item) {
			return i;
		}
	}
	return -1;
};

//============================================================================
// Array.contains Function
//============================================================================
//
// Returns true when the array contains the given item, otherwise false.
//
// @param item [may be null]
//
version.extensions[&quot;Array.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.contains = function(item) {
	return (this.indexOf(item) &gt;= 0);
};

//============================================================================
// Array.containsAny Function
//============================================================================
//
// Returns true when the array contains at least one of the elements
// of the item. Otherwise (or when items contains no elements) false is returned.
//
version.extensions[&quot;Array.containsAny&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAny = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (this.contains(items[i])) {
			return true;
		}
	}
	return false;
};


//============================================================================
// Array.containsAll Function
//============================================================================
//
// Returns true when the array contains all the items, otherwise false.
//
// When items is null false is returned (even if the array contains a null).
//
// @param items [may be null]
//
version.extensions[&quot;Array.containsAll&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAll = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (!this.contains(items[i])) {
			return false;
		}
	}
	return true;
};


} // of &quot;install only once&quot;

// Used Globals (for JSLint) ==============
// ... DOM
/*global 	document */
// ... TiddlyWiki Core
/*global 	convertUnicodeToUTF8, createTiddlyElement, createTiddlyLink,
			displayMessage, endSaveArea, hasClass, loadFile, saveFile,
			startSaveArea, store, wikify */
//}}}


/***
!Licence and Copyright
Copyright (c) abego Software ~GmbH, 2005 ([[www.abego-software.de|http://www.abego-software.de]])

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of abego Software nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
***/

</pre>
</div>
<div title="ForEachTiddlerTest" modifier="FND" created="200705211123" modified="200705211843" tags="tmp systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705211843">
<pre>/***
|Name|ForEachTiddlerTest|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#FETTest]]|
|Version|0.1|
|Author|FND|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|just for testing/debugging purposes|
!Usage
Add {{{&lt;&lt;FET&gt;&gt;}}} to the desired tiddler(s).
&lt;&lt;FET&gt;&gt;
!Changelog
!!v0.1 (2007-05-21)
* initial release
!Issues / To Do
* ...
!Code
***/
//{{{
/*
** Command Button
*/

/* Macro Button */
// adapted from Jack's DoBackupMacro (http://groups.google.com/group/TiddlyWiki/browse_thread/thread/5f1123d08bdadeac/86245d5e4bbe846c)
config.macros.FET = { label: &quot;FETTest&quot;, prompt: &quot;ForEachTiddler Test&quot; };
config.macros.FET.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, function() {
			var tmp = FETTest().tiddlers;
			tmp = FETTest(tmp, &quot;plugin&quot;); // DEBUG: test for second run
			alert(FETTest(tmp, &quot;systemConfig&quot;)); // DEBUG: test for third run
			return false; // DEBUG: ?
		}, null, null, this.accessKey
	); // DEBUG - to do: look up createTiddlyButton()'s parameters
}

/*
** Main Code
*/

FETTest = function(object, filter) {
	// initialize
	alert(object + &quot;\n\n&quot; + filter); // DEBUG
	var tiddlers = []; // title and tags[] for each tiddler
	var tags = []; // global tags list
	var results = {}; // object for return values
	if(object == null) { // use store if no object has been specified
		object = store;
	}
	// retrieve matching tiddlers
	object.forEachTiddler(
		function(title, tiddler) {
			if(filter == null || inArray(filter, tiddler.tags)) { // check whether tiddler is assigned the filter tag
				var t = {}; // DEBUG: viable container for using forEachTiddler on?
				t.title = title;
				t.tags = tiddler.tags;
				tiddlers.push(t);
				// add unique tags to global list
				for(var i = 0; i &lt; tiddler.tags.length; i++) {
					tags.pushUnique(tiddler.tags[i]);
				}
			}
		}
	);
	// return results
	results.tiddlers = tiddlers;
	results.tags = tags;
	return results;
}

/*
** Support Functions
*/

function inArray(needle, haystack) {
    for(var i = 0; i &lt; haystack.length; i++) {
        if(haystack[i] == needle) {
            return true;
        }
    }
    return false;
}
//}}}</pre>
</div>
<div title="InlineJavascriptPlugin" modifier="FND" created="200706062042" modified="200706062042" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706062042">
<pre>/***
|Name|InlineJavascriptPlugin|
|Source|http://www.TiddlyTools.com/#InlineJavascriptPlugin|
|Version|1.6.0|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;&lt;br&gt;&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides||
|Description|Insert Javascript executable code directly into your tiddler content.|

''Call directly into TW core utility routines, define new functions, calculate values, add dynamically-generated TiddlyWiki-formatted output'' into tiddler content, or perform any other programmatic actions each time the tiddler is rendered.
!!!!!Usage
&lt;&lt;&lt;
When installed, this plugin adds new wiki syntax for surrounding tiddler content with {{{&lt;script&gt;}}} and {{{&lt;/script&gt;}}} markers, so that it can be treated as embedded javascript and executed each time the tiddler is rendered.

''Deferred execution from an 'onClick' link''
By including a {{{label=&quot;...&quot;}}} parameter in the initial {{{&lt;script&gt;}}} marker, the plugin will create a link to an 'onclick' script that will only be executed when that specific link is clicked, rather than running the script each time the tiddler is rendered.  You may also include a {{{title=&quot;...&quot;}}} parameter to specify the 'tooltip' text that will appear whenever the mouse is moved over the onClick link text

''External script source files:''
You can also load javascript from an external source URL, by including a src=&quot;...&quot; parameter in the initial {{{&lt;script&gt;}}} marker (e.g., {{{&lt;script src=&quot;demo.js&quot;&gt;&lt;/script&gt;}}}).  This is particularly useful when incorporating third-party javascript libraries for use in custom extensions and plugins.  The 'foreign' javascript code remains isolated in a separate file that can be easily replaced whenever an updated library file becomes available.

''Display script source in tiddler output''
By including the keyword parameter &quot;show&quot;, in the initial {{{&lt;script&gt;}}} marker, the plugin will include the script source code in the output that it displays in the tiddler.

''Defining javascript functions and libraries:''
Although the external javascript file is loaded while the tiddler content is being rendered, any functions it defines will not be available for use until //after// the rendering has been completed.  Thus, you cannot load a library and //immediately// use it's functions within the same tiddler.  However, once that tiddler has been loaded, the library functions can be freely used in any tiddler (even the one in which it was initially loaded).

To ensure that your javascript functions are always available when needed, you should load the libraries from a tiddler that will be rendered as soon as your TiddlyWiki document is opened.  For example, you could put your {{{&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;}}} syntax into a tiddler called LoadScripts, and then add {{{&lt;&lt;tiddler LoadScripts&gt;&gt;}}} in your MainMenu tiddler.

Since the MainMenu is always rendered immediately upon opening your document, the library will always be loaded before any other tiddlers that rely upon the functions it defines.  Loading an external javascript library does not produce any direct output in the tiddler, so these definitions should have no impact on the appearance of your MainMenu.

''Creating dynamic tiddler content''
An important difference between this implementation of embedded scripting and conventional embedded javascript techniques for web pages is the method used to produce output that is dynamically inserted into the document:
* In a typical web document, you use the document.write() function to output text sequences (often containing HTML tags) that are then rendered when the entire document is first loaded into the browser window.
* However, in a ~TiddlyWiki document, tiddlers (and other DOM elements) are created, deleted, and rendered &quot;on-the-fly&quot;, so writing directly to the global 'document' object does not produce the results you want (i.e., replacing the embedded script within the tiddler content), and completely replaces the entire ~TiddlyWiki document in your browser window.
* To allow these scripts to work unmodified, the plugin automatically converts all occurences of document.write() so that the output is inserted into the tiddler content instead of replacing the entire ~TiddlyWiki document.

If your script does not use document.write() to create dynamically embedded content within a tiddler, your javascript can, as an alternative, explicitly return a text value that the plugin can then pass through the wikify() rendering engine to insert into the tiddler display.  For example, using {{{return &quot;thistext&quot;}}} will produce the same output as {{{document.write(&quot;thistext&quot;)}}}.

//Note: your script code is automatically 'wrapped' inside a function, {{{_out()}}}, so that any return value you provide can be correctly handled by the plugin and inserted into the tiddler.  To avoid unpredictable results (and possibly fatal execution errors), this function should never be redefined or called from ''within'' your script code.//

''Accessing the ~TiddlyWiki DOM''
The plugin provides one pre-defined variable, 'place', that is passed in to your javascript code so that it can have direct access to the containing DOM element into which the tiddler output is currently being rendered.

Access to this DOM element allows you to create scripts that can:
* vary their actions based upon the specific location in which they are embedded
* access 'tiddler-relative' information (use findContainingTiddler(place))
* perform direct DOM manipulations (when returning wikified text is not enough)
&lt;&lt;&lt;
!!!!!Examples
&lt;&lt;&lt;
an &quot;alert&quot; message box:
&gt;&lt;script show&gt;
	alert('InlineJavascriptPlugin: this is a demonstration message');
&lt;/script&gt;
dynamic output:
&gt;&lt;script show&gt;
	return (new Date()).toString();
&lt;/script&gt;
wikified dynamic output:
&gt;&lt;script show&gt;
	return &quot;link to current user: [[&quot;+config.options.txtUserName+&quot;]]&quot;;
&lt;/script&gt;
dynamic output using 'place' to get size information for current tiddler:
&gt;&lt;script show&gt;
   if (!window.story) window.story=window;
   var title=story.findContainingTiddler(place).id.substr(7);
   return title+&quot; is using &quot;+store.getTiddlerText(title).length+&quot; bytes&quot;;
&lt;/script&gt;
creating an 'onclick' button/link that runs a script:
&gt;&lt;script label=&quot;click here&quot; title=&quot;clicking this link will show an 'alert' box&quot; show&gt;
   if (!window.story) window.story=window;
   alert(&quot;Hello World!\nlinktext='&quot;+place.firstChild.data+&quot;'\ntiddler='&quot;+story.findContainingTiddler(place).id.substr(7)+&quot;'&quot;);
&lt;/script&gt;
loading a script from a source url:
&gt;http://www.TiddlyTools.com/demo.js contains:
&gt;&gt;{{{function demo() { alert('this output is from demo(), defined in demo.js') } }}}
&gt;&gt;{{{alert('InlineJavascriptPlugin: demo.js has been loaded'); }}}
&gt;&lt;script src=&quot;demo.js&quot; show&gt;
	return &quot;loading demo.js...&quot;
&lt;/script&gt;
&gt;&lt;script label=&quot;click to execute demo() function&quot; show&gt;
	demo()
&lt;/script&gt;
&lt;&lt;&lt;
!!!!!Installation
&lt;&lt;&lt;
import (or copy/paste) the following tiddlers into your document:
''InlineJavascriptPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2007.02.19 [1.6.0]'' added support for title=&quot;...&quot; to specify mouseover tooltip when using an onclick (label=&quot;...&quot;) script
''2006.10.16 [1.5.2]'' add newline before closing '}' in 'function out_' wrapper.  Fixes error caused when last line of script is a comment.
''2006.06.01 [1.5.1]'' when calling wikify() on script return value, pass hightlightRegExp and tiddler params so macros that rely on these values can render properly
''2006.04.19 [1.5.0]'' added 'show' parameter to force display of javascript source code in tiddler output
''2006.01.05 [1.4.0]'' added support 'onclick' scripts.  When label=&quot;...&quot; param is present, a button/link is created using the indicated label text, and the script is only executed when the button/link is clicked.  'place' value is set to match the clicked button/link element.
''2005.12.13 [1.3.1]'' when catching eval error in IE, e.description contains the error text, instead of e.toString().  Fixed error reporting so IE shows the correct response text.  Based on a suggestion by UdoBorkowski
''2005.11.09 [1.3.0]'' for 'inline' scripts (i.e., not scripts loaded with src=&quot;...&quot;), automatically replace calls to 'document.write()' with 'place.innerHTML+=' so script output is directed into tiddler content.  Based on a suggestion by BradleyMeck
''2005.11.08 [1.2.0]'' handle loading of javascript from an external URL via src=&quot;...&quot; syntax
''2005.11.08 [1.1.0]'' pass 'place' param into scripts to provide direct DOM access 
''2005.11.08 [1.0.0]'' initial release
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.inlineJavascript= {major: 1, minor: 6, revision: 0, date: new Date(2007,2,19)};

config.formatters.push( {
	name: &quot;inlineJavascript&quot;,
	match: &quot;\\&lt;script&quot;,
	lookahead: &quot;\\&lt;script(?: src=\\\&quot;((?:.|\\n)*?)\\\&quot;)?(?: label=\\\&quot;((?:.|\\n)*?)\\\&quot;)?(?: title=\\\&quot;((?:.|\\n)*?)\\\&quot;)?( show)?\\&gt;((?:.|\\n)*?)\\&lt;/script\\&gt;&quot;,

	handler: function(w) {
		var lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			if (lookaheadMatch[1]) { // load a script library
				// make script tag, set src, add to body to execute, then remove for cleanup
				var script = document.createElement(&quot;script&quot;); script.src = lookaheadMatch[1];
				document.body.appendChild(script); document.body.removeChild(script);
			}
			if (lookaheadMatch[5]) { // there is script code
				if (lookaheadMatch[4]) // show inline script code in tiddler output
					wikify(&quot;{{{\n&quot;+lookaheadMatch[0]+&quot;\n}}}\n&quot;,w.output);
				if (lookaheadMatch[2]) { // create a link to an 'onclick' script
					// add a link, define click handler, save code in link (pass 'place'), set link attributes
					var link=createTiddlyElement(w.output,&quot;a&quot;,null,&quot;tiddlyLinkExisting&quot;,lookaheadMatch[2]);
					link.onclick=function(){try{return(eval(this.code))}catch(e){alert(e.description?e.description:e.toString())}}
					link.code=&quot;function _out(place){&quot;+lookaheadMatch[5]+&quot;\n};_out(this);&quot;
					link.setAttribute(&quot;title&quot;,lookaheadMatch[3]?lookaheadMatch[3]:&quot;&quot;);
					link.setAttribute(&quot;href&quot;,&quot;javascript:;&quot;);
					link.style.cursor=&quot;pointer&quot;;
				}
				else { // run inline script code
					var code=&quot;function _out(place){&quot;+lookaheadMatch[5]+&quot;\n};_out(w.output);&quot;
					code=code.replace(/document.write\(/gi,'place.innerHTML+=(');
					try { var out = eval(code); } catch(e) { out = e.description?e.description:e.toString(); }
					if (out &amp;&amp; out.length) wikify(out,w.output,w.highlightRegExp,w.tiddler);
				}
			}
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	}
} )
//}}}</pre>
</div>
<div title="Installed_Plugins" creator="YourName" modifier="YourName" created="202507091947" modified="202507121540" changecount="2">
<pre>[
&lt;&lt;forEachTiddler 
where 
'tiddler.tags.contains(&quot;systemConfig&quot;)'
sortBy
'tiddler.title'
write 
'&quot;{&quot;
+&quot;\n&quot;
+&quot;\&quot;url\&quot;: \&quot;https://github.com/wangyenshu/TiddlyWikiClassicPluginsArchives/blob/main/MartinsPlugins/&quot;
+tiddler.title
+&quot;.js&quot;
+&quot;\&quot;,&quot;
+&quot;\n&quot;
+&quot;\&quot;description\&quot;: \&quot;&quot;
+tiddler.title
+&quot;\&quot;&quot;
+&quot;\n&quot;
+&quot;},&quot;
+&quot;\n&quot;'
&gt;&gt;]</pre>
</div>
<div title="JashLightMacro" modifier="FND" created="200712101957" modified="200712102256" tags="plugins systemConfig systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712102256">
<pre>/***
|''Name''|JashMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|[[Billy Reisinger|http://www.billyreisinger.com]]|
|''Contributor''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#JashMacro]]|
|''License''|[[GNU General Public License|http://www.gnu.org/licenses/gpl.html]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|JavaScript shell console|
!Notes
This macro is entirely based upon (and dependent on) [[Jash|http://www.billyreisinger.com/jash/]] by [[Billy Reisinger|http://www.billyreisinger.com]].
It dynamically loads the required code from the online resource.
!Usage
{{{
&lt;&lt;Jash [label] [tooltip] [class] [access key]&gt;&gt;
}}}
&lt;&lt;Jash&gt;&gt;
!Revision History
!!v0.1 (2007-12-10)
* initial release
!Code
***/
//{{{
config.macros.Jash = {
	label: &quot;Jash&quot;,
	prompt: &quot;open Jash&quot;,
	buttonClass: &quot;&quot;,
	accessKey: &quot;&quot;
};

config.macros.Jash.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var label = params[0] || this.label;
	var prompt = params[1] || this.prompt;
	var buttonClass = params[2] || this.buttonClass;
	var accessKey = params[3] || this.accessKey;
	createTiddlyButton(place, label, prompt, config.macros.Jash.toggle, buttonClass, null, accessKey);
}

config.macros.Jash.toggle = function(place, macroName, params, wikifier, paramString, tiddler) {
	document.body.appendChild(document.createElement(&quot;script&quot;)).src = &quot;http://www.billyreisinger.com/jash/source/latest/Jash.js&quot;;
}
//}}}</pre>
</div>
<div title="JashMacro" modifier="FND" created="200712101948" modified="200712102256" tags="plugins systemConfig systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712102256">
<pre>/***
|''Name''|JashMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|[[Billy Reisinger|http://www.billyreisinger.com]]|
|''Contributor''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#JashMacro]]|
|''License''|[[GNU General Public License|http://www.gnu.org/licenses/gpl.html]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|JavaScript shell console|
!Notes
This macro is entirely based upon [[Jash|http://www.billyreisinger.com/jash/]] by [[Billy Reisinger|http://www.billyreisinger.com]].
!Usage
{{{
&lt;&lt;Jash [label] [tooltip] [class] [access key]&gt;&gt;
}}}
&lt;&lt;Jash&gt;&gt;
!Revision History
!!v0.1 (2007-12-10)
* initial release
!Code
***/
//{{{
config.macros.Jash = {
	label: &quot;Jash&quot;,
	prompt: &quot;open Jash&quot;,
	buttonClass: &quot;&quot;,
	accessKey: &quot;&quot;
};

config.macros.Jash.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var label = params[0] || this.label;
	var prompt = params[1] || this.prompt;
	var buttonClass = params[2] || this.buttonClass;
	var accessKey = params[3] || this.accessKey;
	createTiddlyButton(place, label, prompt, config.macros.Jash.toggle, buttonClass, null, accessKey);
	config.macros.Jash.toggle(); // DEBUG: ugly hack to prevent Jash from being launched on startup
}

config.macros.Jash.toggle = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(&quot;jash&quot; in window) {
		window.jash.close();
	} else {
		window.jash = new Jash();
		window.jash.main();
	}
}

/*
** Jash.css
** http://www.billyreisinger.com/jash/source/latest/Jash.css
*/
config.shadowTiddlers.StyleSheetJash = &quot;#JashParent {\n&quot;+
 &quot;	width: 581px;\n&quot;+
 &quot;	height: 450px;\n&quot;+
 &quot;	border: 1px solid gray;\n&quot;+
 &quot;	color: black;\n&quot;+
 &quot;	z-index: 10000;\n&quot;+
 &quot;	overflow: hidden;\n&quot;+
 &quot;	background: #ccc;\n&quot;+
 &quot;	opacity: 0.90;\n&quot;+
 &quot;	filter: alpha(opacity=90);\n&quot;+
 &quot;	position: absolute;\n&quot;+
 &quot;	left: 25%;\n&quot;+
 &quot;	color: black;\n&quot;+
 &quot;	font-family: monospace;\n&quot;+
 &quot;	margin: 0;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashParent div {\n&quot;+
 &quot;	margin: 0;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashParent a, #JashParent a:visited, #JashParent a:active, #JashParent a:hover {\n&quot;+
 &quot;	text-decoration: none;\n&quot;+
 &quot;	color: black;\n&quot;+
 &quot;}\n&quot;+
 &quot;.transparentMode {\n&quot;+
 &quot;	opacity: 0.20 !important;\n&quot;+
 &quot;	filter: alpha(opacity=20) !important;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashDragBar {\n&quot;+
 &quot;	BACKGROUND: gray;\n&quot;+
 &quot;	CURSOR: move;\n&quot;+
 &quot;	COLOR: white;\n&quot;+
 &quot;	font-family: monospace;\n&quot;+
 &quot;	font-weight: bold;\n&quot;+
 &quot;	text-indent: 4px;\n&quot;+
 &quot;	font-size: 14px;\n&quot;+
 &quot;	HEIGHT: 25px;\n&quot;+
 &quot;	TEXT-ALIGN: left;\n&quot;+
 &quot;	overflow: hidden;\n&quot;+
 &quot;	border: 1px outset white;\n&quot;+
 &quot;}\n&quot;+
 &quot;.JashXButton {\n&quot;+
 &quot;    border: 1px solid white;\n&quot;+
 &quot;    color: white !important;\n&quot;+
 &quot;    position: absolute;\n&quot;+
 &quot;    background: #bbb;\n&quot;+
 &quot;    width: 20px; \n&quot;+
 &quot;    text-align: center;\n&quot;+
 &quot;    display: block;\n&quot;+
 &quot;    right: 3px; _right: 1px;\n&quot;+
 &quot;    top: 4px; _top: 1px;\n&quot;+
 &quot;    font-family: Arial sans-serif;\n&quot;+
 &quot;    font-size: 18px;\n&quot;+
 &quot;    cursor: pointer;\n&quot;+
 &quot;}\n&quot;+
 &quot;a.JashXButton:hover {\n&quot;+
 &quot;	background: #ddd; \n&quot;+
 &quot;}\n&quot;+
 &quot;#JashTextareaWrap {\n&quot;+
 &quot;	width: 100%;\n&quot;+
 &quot;	_height: 420px;\n&quot;+
 &quot;}\n&quot;+
 &quot;html&gt;body #JashTextareaWrap {\n&quot;+
 &quot;	height: 100%;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashOutput {\n&quot;+
 &quot;	border: 2px inset white;\n&quot;+
 &quot;	FONT-SIZE: 10px;\n&quot;+
 &quot;	font-family: \&quot;Lucida Console\&quot;, monaco, monospace;\n&quot;+
 &quot;	BACKGROUND: black;\n&quot;+
 &quot;	width: 99%;\n&quot;+
 &quot;	COLOR: lightgreen;\n&quot;+
 &quot;	PADDING: 2px;\n&quot;+
 &quot;	height: 60%;\n&quot;+
 &quot;	height: expression(parseInt(this.parentNode.parentNode.offsetHeight * (3/5)) + 'px');\n&quot;+
 &quot;	\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashInput {\n&quot;+
 &quot;	padding: 2px;\n&quot;+
 &quot;	WIDTH: 99%;\n&quot;+
 &quot;	border: 2px inset white;\n&quot;+
 &quot;	HEIGHT: 25%;\n&quot;+
 &quot;	font-family: monospace;\n&quot;+
 &quot;	font-size: 11px;\n&quot;+
 &quot;	height: expression(parseInt(this.parentNode.parentNode.offsetHeight * (3/13)) + 'px');\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashParent .cssEntry {\n&quot;+
 &quot;	background: lightgreen;\n&quot;+
 &quot;	font-size: 11px;\n&quot;+
 &quot;	font-family: monospace;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashBottomBar {\n&quot;+
 &quot;	BACKGROUND: #ccc;\n&quot;+
 &quot;	POSITION: relative;\n&quot;+
 &quot;	HEIGHT: 20px;\n&quot;+
 &quot;	overflow: hidden;\n&quot;+
 &quot;	margin-top: 2px;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashBottomBar a {\n&quot;+
 &quot;	HEIGHT: 14px;\n&quot;+
 &quot;	font-size: 9px;\n&quot;+
 &quot;	font-weight: normal;\n&quot;+
 &quot;	font-family: arial;\n&quot;+
 &quot;	float: left;\n&quot;+
 &quot;	padding: 4px;\n&quot;+
 &quot;	background: #eee;\n&quot;+
 &quot;	cursor: pointer;\n&quot;+
 &quot;	border: 1px outset white;\n&quot;+
 &quot;	margin-right: 1px;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashBottomBar a:hover {\n&quot;+
 &quot;	padding-top: 3px;\n&quot;+
 &quot;	padding-bottom: 5px;\n&quot;+
 &quot;	background-color: white;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashBottomBar a:active, #JashBottomBar a:focus {\n&quot;+
 &quot;	padding-top: 5px;\n&quot;+
 &quot;	padding-bottom: 3px;\n&quot;+
 &quot;	background-color: #ddd;\n&quot;+
 &quot;}\n&quot;+
 &quot;#JashResizeButton {\n&quot;+
 &quot;	BORDER: 1px solid gray;\n&quot;+
 &quot;	BACKGROUND: #eee;\n&quot;+
 &quot;	WIDTH: 17px;\n&quot;+
 &quot;	height: 17px;\n&quot;+
 &quot;	line-height: 0;\n&quot;+
 &quot;	CURSOR: move;\n&quot;+
 &quot;	position: absolute;\n&quot;+
 &quot;	bottom: 0px;\n&quot;+
 &quot;	right: 0px;\n&quot;+
 &quot;	z-index: 2000;\n&quot;+
 &quot;}&quot;
store.addNotification(&quot;StyleSheetJash&quot;, refreshStyles);

/*
** Jash.js
** http://www.billyreisinger.com/jash/source/latest/Jash.js
*/

function Jash(){this.jashRoot=&quot;http://www.billyreisinger.com/jash/source/latest/&quot;;this.domGetElFunctions={id:new Array(&quot;document.getElementById&quot;,&quot;$&quot;),className:new Array(&quot;getElementsByClassName&quot;,&quot;$C&quot;)};var line=&quot;-------------------------------------------------&quot;;var _null=&quot;nooutput&quot;;this.revision=&quot;$Revision: 1.14 $&quot;.replace(/(\$|[A-Za-z]|\s|:)/g,'');this.version=&quot;$Name: REL_1_35_7 $&quot;.replace(/\$|Name:|\s|REL_/g,'').replace(/_/g,'.');this.versionDate=&quot;$Date: 2007/11/16 03:24:54 $&quot;;this.main=function(){this.browser=this.returnBrowserType();this.lineNumber=0;this.mainBlock;this.output=document.getElementById(&quot;JashOutput&quot;);this.input;this.outputHistory=new Array();this.cssEvalFlag=false;this.innerHtmlInspection=false;this.accessKeyText=this.getAccessKeyText();this.defaultText=&quot;Jash, v&quot;+this.version+&quot;\nEnter \&quot;jash.help()\&quot; for a list of commands.\n&quot;;this.cls=this.clear;this.tabIndexIndex=0;this.currentNode={};this.tips=[&quot;Did you know?\nThe DOM Inspector will automatically put\n an element with an ID in the input field for you.&quot;,&quot;Did you know?\nYou can tie this script into your own to jash scripts. Use 'jash.methodName' anywhere\n in your scripts, and pull\n up this window before executing to see\n the results.&quot;,&quot;Did you know?\nUse jash.stopWatch.start() and jash.stopWatch.stop() to\n time execution speeds! Handy for optimization.&quot;,&quot;Did you know?\nPress TAB to complete a function, method, or property name.\n If more than one match is found, a list of possible\n matches will appear.&quot;,&quot;Did you know?\nYou can use jash.show() to show a list of the names\nand types of an object's members.\nOn the other hand, jash.dump will show names and\n_values_ of an object's members.&quot;,&quot;Whoa ---- you can now tab-complete HTML element ids after typing document.getElementsById(' (or the '$' shorthand if using Prototype).  This also works with class names (i.e. document.getElementsByClassName)&quot;]
this.defaultText+=line+&quot;\n&quot;+this.tips[(parseInt((Math.random()*10)%this.tips.length))]+&quot;\n&quot;+line+&quot;\n&quot;;if(this.returnBrowserType()!=&quot;sa&quot;){this.stylesheet=document.body.appendChild(document.createElement('link'));}else{this.stylesheet=document.getElementsByTagName(&quot;head&quot;)[0].appendChild(document.createElement(&quot;link&quot;));}
this.stylesheet.type='text/css';this.stylesheet.rel='stylesheet';this.stylesheet.href=this.jashRoot+'Jash.css';this.create();Jash.TabComplete.prototype=this;this.tabComplete=new Jash.TabComplete();Jash.Evaluator.prototype=this;this.evaluation=new Jash.Evaluator();this.history=new Jash.History();var _self=this;window.setTimeout(function(){_self.input.focus();},500);if(typeof event!=&quot;undefined&quot;)delete event;}
this.returnBrowserType=function(){if(window.navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;)!=-1){return&quot;op&quot;;}
if(window.navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;)!=-1){return&quot;ie&quot;;}
if(window.navigator.userAgent.toLowerCase().indexOf(&quot;firefox&quot;)!=-1){return&quot;ff&quot;;}
if(window.navigator.userAgent.toLowerCase().indexOf(&quot;safari&quot;)!=-1){return&quot;sa&quot;;}}
this.returnOsType=function(){var ua=window.navigator.userAgent.toLowerCase();if(ua.indexOf(&quot;macintosh&quot;)!=-1){return&quot;mac&quot;;}else if(ua.indexOf(&quot;windows&quot;)!=-1){return&quot;win&quot;;}else if(ua.indexOf(&quot;linux i686&quot;)!=-1){return&quot;linux&quot;;}}
this.getAccessKeyText=function(){var txt;var agt=this.returnOsType();switch(this.browser){case&quot;ie&quot;:txt=&quot;Alt&quot;;break;case&quot;ff&quot;:if(agt==&quot;mac&quot;){txt=&quot;Ctrl&quot;;}else if(agt==&quot;linux&quot;){txt=&quot;Alt&quot;;}else{txt=&quot;Alt-Shift&quot;;}
break;case&quot;op&quot;:txt=&quot;Shift-Esc&quot;;break;case&quot;sa&quot;:if(agt==&quot;mac&quot;){txt=&quot;Ctrl&quot;;}else{txt=&quot;Alt&quot;;}
break;default:txt=&quot;Alt&quot;;break;}
return txt;}
this.print=function(text,clear,suppressLineNumbers,autoscroll){clear=(typeof clear!=&quot;undefined&quot;)?clear:false;autoscroll=(typeof autoscroll!=&quot;undefined&quot;)?autoscroll:true;if(this.output==null||document.getElementById(&quot;JashParent&quot;)==null){this.create();this.output=document.getElementById(&quot;JashOutput&quot;);this.mainBlock=document.getElementById(&quot;JashParent&quot;);}
if(clear){this.clear();}
if(text!=&quot;&quot;){if(typeof suppressLineNumbers!=&quot;undefined&quot;&amp;&amp;!suppressLineNumbers){this.output.value+=this.lineNumber+&quot;. &quot;;}
this.output.value+=text+&quot;\n&quot;;if(autoscroll){this.output.scrollTop=this.output.scrollHeight;}
this.lineNumber++;}
return _null;}
this.show=function(obj){this.print(line,false,true);var out=&quot;&quot;;this.lineNumber=0;for(var p in obj){if(typeof obj[p]==&quot;function&quot;){var t=obj[p].toString();t=t.replace(/[\x0A\x0D]/g,&quot;&quot;).replace(/\s+/g,&quot;&quot;).replace(/\{.+\}/g,&quot;{ ... }&quot;);t=t.replace(p,&quot;&quot;);t=p+&quot;: &quot;+t;}else{t=p+&quot;: &quot;+typeof obj[p];}
out+=++this.lineNumber+&quot;. &quot;+t+&quot;\n&quot;;}
this.print(out,false,true);this.print(line,false,true);this.output.scrollTop=this.output.scrollHeight;return _null;}
this.dump=function(obj){if(typeof obj==&quot;string&quot;){this.print(obj);}else{this.print(line,false,true);var out=new Array();if(typeof obj.push==&quot;undefined&quot;){for(var th in obj){out.push(++this.lineNumber+&quot;. &quot;+th+&quot; = &quot;+obj[th]);}}else{for(var i=0;i&lt;obj.length;i++){out.push(++this.lineNumber+&quot;. &quot;+obj[i]);}}
this.print(out.join(&quot;\n&quot;),false,true);this.print(line,false,true);this.output.scrollTop=this.output.scrollHeight;}
return _null;}
this.clear=function(){this.outputHistory.push(this.output.value);this.output.value=&quot;&quot;;this.input.focus();return _null;}
this.showOutputHistory=function(){this.outputHistory.push(this.output.value);this.dump(this.outputHistory);}
this.assignInputKeyEvent=function(keyCode){if(keyCode==13){this.evaluation.evaluate(this.input.value);this.input.value=&quot;&quot;;return false;}else if(keyCode==38){if(this.browser!=&quot;op&quot;){this.input.value=this.history.getPreviousInput();}
return false;}else if(keyCode==40){if(this.browser!=&quot;op&quot;){this.input.value=this.history.getNextInput();}
return false;}else if(keyCode==9){this.tabComplete.tabComplete();return false;}}
this.getXBrowserYOffset=function(){var y;if(self.pageYOffset){y=self.pageYOffset;}else if(document.documentElement&amp;&amp;document.documentElement.scrollTop){y=document.documentElement.scrollTop;}else if(document.body){y=document.body.scrollTop;}
return y;}
this.getMouseXY=function(e){var tempX=0
var tempY=0
if(window.event){if(document.documentElement&amp;&amp;document.documentElement.scrollTop){tempX=window.event.clientX+document.documentElement.scrollLeft;tempY=window.event.clientY+document.documentElement.scrollTop;}else{tempX=window.event.clientX+document.body.scrollLeft;tempY=window.event.clientY+document.body.scrollTop;}}else{tempX=e.pageX;tempY=e.pageY;}
return{x:tempX,y:tempY};}
this.getDimensions=function(el){var dims={}
if(document.all){dims.x=el.offsetWidth;dims.y=el.offsetHeight;}else{dims.x=parseInt(document.defaultView.getComputedStyle(el,&quot;&quot;).getPropertyValue(&quot;width&quot;));dims.y=parseInt(document.defaultView.getComputedStyle(el,&quot;&quot;).getPropertyValue(&quot;height&quot;));}
return dims;}
this.addEvent=function(obj,eventName,func){if(obj.addEventListener)
return obj.addEventListener(eventName,func,true);else if(obj.attachEvent){obj.attachEvent(&quot;on&quot;+eventName,func);return true;}
return false;}
this.findElementPosition=function(obj){var curleft=0;var curtop=0;if(obj.offsetParent){curleft=obj.offsetLeft
curtop=obj.offsetTop
while(obj=obj.offsetParent){curleft+=obj.offsetLeft
curtop+=obj.offsetTop}}
return[curleft,curtop];}
this.create=function(){if(document.getElementsByTagName(&quot;frameset&quot;).length&gt;0){alert(&quot;Jash currently does not support pages with frames.&quot;);return;}
var self=this;var debugParent=document.createElement(&quot;div&quot;);var windowScrollY=0;if(document.documentElement&amp;&amp;document.documentElement.scrollTop){windowScrollY=document.documentElement.scrollTop;}else if(document.body){windowScrollY=document.body.scrollTop}else{windowScrollY=window.scrollY;}
debugParent.style.top=windowScrollY+50+&quot;px&quot;;debugParent.id=&quot;JashParent&quot;;this.addEvent(document,&quot;keydown&quot;,function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;if(e.keyCode==&quot;27&quot;){if(typeof e.shiftKey==&quot;undefined&quot;||!e.shiftKey){self.close();}}});var textareaWrap=document.createElement(&quot;div&quot;);textareaWrap.id=&quot;JashTextareaWrap&quot;;var debugOutput=document.createElement(&quot;textarea&quot;);debugOutput.id=&quot;JashOutput&quot;;debugOutput.wrap=&quot;off&quot;;debugOutput.readOnly=&quot;true&quot;;debugOutput.value=this.defaultText;var inp=document.createElement(&quot;textarea&quot;);inp.id=&quot;JashInput&quot;;var last=&quot;&quot;;inp.onkeydown=function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;return self.assignInputKeyEvent(e.keyCode);}
inp.onkeypress=function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;var k=e.keyCode;if(!self.evaluation.cssEvalFlag){if(k==9||k==13||k==38||k==40){if(k!=40&amp;&amp;this.browser!=&quot;ie&quot;){return false;}}}else if(k==9){return false;}}
var dragBut=document.createElement(&quot;div&quot;);dragBut.innerHTML=&quot;Jash&quot;;dragBut.id=&quot;JashDragBar&quot;;dragBut.onmousedown=function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;var xplus=(typeof e.layerX==&quot;undefined&quot;)?e.offsetX:e.layerX;var yplus=(typeof e.layerY==&quot;undefined&quot;)?e.offsetY:e.layerY;document.onmousemove=function(e){var coords=self.getMouseXY(e);document.getElementById(&quot;JashParent&quot;).style.top=coords.y-yplus+&quot;px&quot;;document.getElementById(&quot;JashParent&quot;).style.left=coords.x-xplus+&quot;px&quot;;}
return false;}
document.onmouseup=function(){document.onmousemove=null;};dragBut.onclick=function(){return false;}
var xBut=document.createElement(&quot;a&quot;);xBut.className=&quot;JashXButton&quot;;xBut.innerHTML=&quot;X&quot;;xBut.href=&quot;#&quot;;xBut.onclick=function(){self.close();return false;}
var clearBut=document.createElement(&quot;a&quot;);clearBut.innerHTML=&quot;Clear (&quot;+this.accessKeyText+&quot;-C)&quot;;clearBut.accessKey=&quot;C&quot;;clearBut.className=&quot;JashButton&quot;;clearBut.onclick=function(){self.clear();return false;}
this.setCrossBrowserAccessKeyFunctionForAnchor(clearBut);var evalBut=document.createElement(&quot;a&quot;);evalBut.value=&quot;Evaluate (&quot;+this.accessKeyText+&quot;-Z)&quot;;evalBut.innerHTML=&quot;Evaluate (&quot;+this.accessKeyText+&quot;-Z)&quot;;evalBut.accessKey=&quot;Z&quot;;evalBut.className=&quot;JashButton&quot;;evalBut.title=&quot;Evaluate current input (&quot;+this.accessKeyText+&quot;-Z)&quot;;evalBut.onclick=function(){self.evaluation.evaluate(inp.value);if(!self.evaluation.cssEvalFlag){inp.value=&quot;&quot;;}
inp.focus();return false;}
this.setCrossBrowserAccessKeyFunctionForAnchor(evalBut);var helpBut=document.createElement(&quot;a&quot;);helpBut.innerHTML=&quot;Help&quot;;helpBut.className=&quot;JashButton&quot;;helpBut.title=&quot;Help: show list of commands (or type jash.help(); )&quot;;helpBut.onclick=function(){self.help();}
var domBut=document.createElement(&quot;a&quot;);domBut.innerHTML=&quot;Mouseover DOM (&quot;+this.accessKeyText+&quot;-X)&quot;;domBut.title=&quot;Mouseover DOM: toggle to turn on/off inspection of document nodes (&quot;+this.accessKeyText+&quot;-X)&quot;;domBut.className=&quot;JashButton&quot;;domBut.accessKey=&quot;X&quot;;domBut.tabIndex=&quot;4&quot;;this.domActive=false;domBut.onclick=function(){if(!self.domActive){document.body.onmouseover=function(e){if(typeof e==&quot;undefined&quot;){e=window.event;}
self.showNodes(e);}
self.setButtonVisualActiveState(domBut,&quot;on&quot;);self.domActive=true;}else{document.body.onmouseover=function(){}
self.domActive=false;self.setButtonVisualActiveState(domBut,&quot;off&quot;);}
return _null;}
this.setCrossBrowserAccessKeyFunctionForAnchor(domBut);var innerHtmlInspectBut=document.createElement(&quot;a&quot;);innerHtmlInspectBut.innerHTML=&quot;innerHTML Dump (&quot;+this.accessKeyText+&quot;-A)&quot;;innerHtmlInspectBut.title=&quot;innerHTML Inspect: toggle to turn on/off innerHTML inspection of document nodes (&quot;+this.accessKeyText+&quot;-A)&quot;;innerHtmlInspectBut.className=&quot;JashButton&quot;;innerHtmlInspectBut.accessKey=&quot;A&quot;;innerHtmlInspectBut.tabIndex=&quot;5&quot;;this.innerHtmlInspection=false;innerHtmlInspectBut.onclick=function(){self.innerHtmlInspection=!self.innerHtmlInspection;self.setButtonVisualActiveState(innerHtmlInspectBut,self.innerHtmlInspection?&quot;on&quot;:&quot;off&quot;);return _null;}
this.setCrossBrowserAccessKeyFunctionForAnchor(innerHtmlInspectBut);var cssBut=document.createElement(&quot;a&quot;);cssBut.innerHTML=&quot;CSS Input (&quot;+this.accessKeyText+&quot;-S)&quot;;cssBut.title=&quot;CSS Input: turn on CSS input to enter arbitrary CSS (&quot;+this.accessKeyText+&quot;-S)&quot;;cssBut.className=&quot;JashButton&quot;;cssBut.accessKey=&quot;S&quot;;cssBut.onclick=function(){if(!self.evaluation.cssEvalFlag){self.setButtonVisualActiveState(cssBut,&quot;on&quot;);self.evaluation.cssEvalFlag=true;inp.className=&quot;cssEntry&quot;;if(document.getElementById(&quot;JashStyleInput&quot;)!=null){self.evaluation.styleInputTag.disabled=false;}
inp.value=&quot;&quot;;}else{self.setButtonVisualActiveState(cssBut,&quot;off&quot;);inp.className=&quot;&quot;;self.evaluation.cssEvalFlag=false;if(document.getElementById(&quot;JashStyleInput&quot;)!=null){self.evaluation.styleInputTag.disabled=true;}
inp.value=&quot;&quot;;}
inp.focus();return _null;}
this.setCrossBrowserAccessKeyFunctionForAnchor(cssBut);var resizeBut=document.createElement(&quot;div&quot;);resizeBut.id=&quot;JashResizeButton&quot;;this.minDims={x:100,y:100};resizeBut.onmousedown=function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;var originalDims=self.getDimensions(textareaWrap);var originMouseDims=self.getMouseXY(e);document.onmousemove=function(e){var newMouseDims=self.getMouseXY(e);var newWidth=originalDims.x+(newMouseDims.x-originMouseDims.x);if(newWidth&lt;self.minDims.x){newWidth=self.minDims.x;}
textareaWrap.style.width=newWidth+&quot;px&quot;;debugParent.style.width=newWidth+&quot;px&quot;;var newHeight=originalDims.y+(newMouseDims.y-originMouseDims.y);if(newHeight&lt;self.minDims.y){newHeight=self.minDims.y;}
textareaWrap.style.height=newHeight+&quot;px&quot;;debugParent.style.height=newHeight+&quot;px&quot;;}
document.onmouseup=function(){document.onmousemove=&quot;&quot;;}}
var bottomBar=document.createElement(&quot;div&quot;);bottomBar.id=&quot;JashBottomBar&quot;;debugParent.appendChild(dragBut);debugParent.appendChild(xBut);bottomBar.appendChild(evalBut);bottomBar.appendChild(cssBut);bottomBar.appendChild(domBut);bottomBar.appendChild(innerHtmlInspectBut);bottomBar.appendChild(clearBut);bottomBar.appendChild(helpBut);debugParent.appendChild(bottomBar);debugParent.appendChild(resizeBut);document.body.appendChild(debugParent);textareaWrap.appendChild(debugOutput);textareaWrap.appendChild(inp);debugParent.appendChild(textareaWrap);this.bottomBar=document.getElementById(&quot;JashBottomBar&quot;);this.dragBar=document.getElementById(&quot;JashDragBar&quot;)
this.output=document.getElementById(&quot;JashOutput&quot;);this.input=document.getElementById(&quot;JashInput&quot;);this.mainBlock=debugParent;this.addEvent(window,'scroll',function(){debugParent.style.top=50+self.getXBrowserYOffset()+'px';});}
this.setButtonVisualActiveState=function(button,state){if(state==&quot;on&quot;){button.style.backgroundColor=&quot;lightgreen&quot;;}else{button.style.backgroundColor=&quot;&quot;;}}
this.help=function(){var out=new Array();out.push(line);out.push(&quot;Jash v&quot;+this.version+&quot; &quot;+this.versionDate.replace(/\$/g,''),true);out.push(&quot;http://www.billyreisinger.com/jash/documentation.html&quot;);out.push(line);out.push(&quot;METHODS&quot;);out.push(line);out.push(&quot;this.cls() - clear console and terminal&quot;);out.push(&quot;jash.print(str,clear) - output str to console ~~ str = string ~~ clear = true|false: clear console before output&quot;);out.push(&quot;this.close() - close this console&quot;);out.push(&quot;this.dump(obj) - output object and members to console&quot;);out.push(&quot;this.show(obj) - print out the names and types (only) of all members of obj&quot;);out.push(&quot;this.stopWatch.start() - start timer&quot;);out.push(&quot;this.stopWatch.stop() - end timer and return result in ms&quot;);out.push(&quot;this.kill(HTML Element) - remove an element from the page.&quot;);out.push(&quot;this.getDimensions(HTML Element) - get width, height dimensions of an html element. Returns an object [x,y]&quot;);out.push(line);out.push(&quot;KEYSTROKES&quot;);out.push(line);out.push(&quot;press up arrow in input field to retrieve last input&quot;);out.push(&quot;press ESC to show/hide console&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-Q to turn on/off Transparent mode, so you can see through the Jash.&quot;);out.push(&quot;press ENTER in input field to enter a command&quot;);out.push(&quot;press TAB to auto-complete input&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-Z to evaluate input&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-X to activate/deactivate DOM inspector&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-A to activate/deactivate innerHTML dump (only works w/ DOM inspector)&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-C to clear output and input&quot;);out.push(&quot;press &quot;+this.accessKeyText+&quot;-S to turn on/off CSS input mode. In CSS input mode, you can enter arbitrary CSS selectors and rules, as you would normally do in a CSS stylesheet.&quot;);this.print(out.join(&quot;\n&quot;));return _null;}
this.close=function(){if(this.mainBlock.style.display==&quot;none&quot;){this.mainBlock.style.display=&quot;block&quot;;this.input.focus();}else{this.mainBlock.style.display=&quot;none&quot;;}}
this.setCrossBrowserAccessKeyFunctionForAnchor=function(el){var self=this;el.tabIndex=++this.tabIndexIndex;if(this.browser==&quot;ie&quot;){el.onfocus=function(){if(window.event.altKey){el.onclick();}
self.input.focus();}}}
this.stopWatch={t_start:0,t_end:0,t_total:0,start:function(){t_start=new Date().getTime();return t_start;},stop:function(){t_end=new Date().getTime();t_total=t_end-t_start;return(t_total);}}
this.showNodes=function(e){if(typeof e==&quot;undefined&quot;)e=window.event;var el=typeof e.target==&quot;undefined&quot;?e.srcElement:e.target;this.currentNode=el;var childMost=this.identifyNode(el,false);var out=&quot;&quot;;var childmostTxt=&quot;childmost..... &quot;+childMost.txt+&quot;\n&quot;;while(el=el.parentNode){if(el.nodeName.toLowerCase()==&quot;html&quot;){out=&quot;parentmost.... &lt;html&gt;\n&quot;+out;break;}
out=this.identifyNode(el).txt+&quot;\n&quot;+out;}
out=&quot;**** PRESS &quot;+this.accessKeyText+&quot;-X TO PAUSE / UNPAUSE ****\n&quot;+out;out+=childmostTxt;this.print(out,true,true,false);if(this.innerHtmlInspection){this.print(&quot;INNER HTML&quot;);if(this.currentNode.innerHTML.indexOf(&quot;&lt;&quot;)!=-1){this.print(Jash.Indenter.indent(this.currentNode.innerHTML),false,true,false);}else{this.print(this.currentNode.innerHTML,false,true,false);}}
if(!this.evaluation.cssEvalFlag){if(childMost.id!=&quot;&quot;){if(typeof $!=&quot;undefined&quot;){this.input.value='$(&quot;'+childMost.id+'&quot;)';}else{this.input.value='document.getElementById(&quot;'+childMost.id+'&quot;)';}}else{this.input.value=&quot;this.currentNode&quot;;}}}
this.identifyNode=function(el,showDots){showDots=typeof showDots==&quot;boolean&quot;?showDots:true;var out={txt:&quot;&quot;,id:&quot;&quot;};if(showDots)out.txt+=&quot;.............. &quot;;out.txt+=&quot;&lt;&quot;+el.nodeName.toLowerCase();for(var i=0;i&lt;el.attributes.length;i++){if((this.browser==&quot;ie&quot;&amp;&amp;el.attributes[i].specified===true)||this.browser!=&quot;ie&quot;){out.txt+=&quot; &quot;+el.attributes[i].name;out.txt+=&quot;=\&quot;&quot;+el.attributes[i].value+&quot;\&quot;&quot;;}}
out.txt+=&quot;&gt;&quot;;return out;}
this.kill=function(){this.currentNode.parentNode.removeChild(this.currentNode);}}
Jash.Evaluator=function(){this.cssEvalFlag=false;var _null=&quot;nooutput&quot;;this.evaluate=function(input){if(input==&quot;&quot;)return false;this.history.add(input);if(this.cssEvalFlag){this.evalCss(input);this.print(input);}else{var output=this.evalJs(input);if(typeof output!=&quot;undefined&quot;){this.print(&quot;&gt;&gt; &quot;+input);this.print(output);}}}
this.evalJs=function(input){try{var result;if(this.browser==&quot;ie&quot;){result=eval(input);}else{result=window.eval(input);}
if(result!=null&amp;&amp;result.toString()!=_null){return(result.toString());}else{return&quot;null&quot;}}catch(e){return(e.message);}}
this.evalCss=function(input){try{this.insertStyleRule(input);}catch(e){}
return input;}
this.insertStyleRule=function(rule){var lastStyleSheetIndex=document.styleSheets.length-1;if(document.getElementById(&quot;JashStyleInput&quot;)==null){this.styleInputTag=document.createElement(&quot;style&quot;);this.styleInputTag.id=&quot;JashStyleInput&quot;;this.styleInputTag.type=&quot;text/css&quot;;document.body.appendChild(this.styleInputTag);}
if(this.browser==&quot;ff&quot;||this.browser==&quot;op&quot;){this.styleInputTag.innerHTML+=rule+&quot;\n&quot;;}else if(this.browser==&quot;ie&quot;||this.browser==&quot;sa&quot;){if(this.browser==&quot;ie&quot;){var i=0;}else if(this.browser=&quot;sa&quot;){var i=document.styleSheets.length-1;}
var rulesArray=rule.split(&quot;}&quot;);for(var t=0;t&lt;rulesArray.length;t++){var ruleSplit=rulesArray[t].split(&quot;{&quot;);var selectors=ruleSplit[0].split(&quot;,&quot;);for(var k=0;k&lt;selectors.length;k++){document.styleSheets[i].addRule(selectors[k],ruleSplit[1]);}}}
return&quot;&quot;;}
return this;}
Jash.History=function(){this.entries=new Array('');this.position=0;}
Jash.History.prototype={add:function(input){this.entries.push(input);this.position=this.entries.length-1;},getPreviousInput:function(){if(this.position&lt;0){return'';}
var entry=typeof this.entries[this.position]!=&quot;undefined&quot;?this.entries[this.position]:'';if(this.position&gt;0){this.position--;}
return entry;},getNextInput:function(){if(this.position+1&lt;this.entries.length){return this.entries[++this.position];}else{return'';}}}
Jash.Indenter={indentChar:&quot;\t&quot;,nodesCommonlyUnclosed:new Array(&quot;link &quot;,&quot;img &quot;,&quot;meta &quot;,&quot;!DOCTYPE &quot;,&quot;input &quot;,&quot;param&quot;,&quot;hr&quot;,&quot;br&quot;),stringRepeat:function(stringToRepeat,times){var string=new Array();for(var i=0;i&lt;times;i++){string.push(stringToRepeat);}
return string.join('');},closeUnclosedNode:function(str){for(var k=0;k&lt;this.nodesCommonlyUnclosed.length;k++){var reg=new RegExp(&quot;^&quot;+this.nodesCommonlyUnclosed[k].toLowerCase());if(str.toLowerCase().match(reg)){return str.replace(&quot;&gt;&quot;,&quot;/&gt;&quot;);}}
return str;},indentAndAdd:function(level,string,arr){var indents=this.stringRepeat(this.indentChar,level);arr.push(indents+string);return arr;},indent:function(source){var source=source;var arr=new Array();source=source.replace(/[\n\r\t]/g,'');source=source.replace(/&gt;\s+/g,&quot;&gt;&quot;);source=source.replace(/\s+&lt;/g,&quot;&lt;&quot;);var splitsrc=source.split(&quot;&lt;&quot;);for(i=0;i&lt;splitsrc.length;i++){splitsrc[i]=this.closeUnclosedNode(splitsrc[i]);}
source=splitsrc.join(&quot;&lt;&quot;);var level=0;var sourceLength=source.length;var position=0;while(position&lt;sourceLength){if(source.charAt(position)=='&lt;'){var startedAt=position;var tagLevel=1;if(source.charAt(position+1)=='/'){tagLevel=-1;}
if(source.charAt(position+1)=='!'){tagLevel=0;}
while(source.charAt(position)!='&gt;'){position++;}
if(source.charAt(position-1)=='/'){tagLevel=0;}
var tagLength=position+1-startedAt;if(tagLevel===-1){level--;}
arr=this.indentAndAdd(level,source.substr(startedAt,tagLength),arr);if(tagLevel===1){level++;}}
if((position+1)&lt;sourceLength){if(source.charAt(position+1)!=='&lt;'){startedAt=position+1;while(source.charAt(position)!=='&lt;'&amp;&amp;position&lt;sourceLength){position++;}
if(source.charAt(position)==='&lt;'){tagLength=position-startedAt;arr=this.indentAndAdd(level,source.substr(startedAt,tagLength),arr);}}else{position++;}}else{break;}}
return arr.join(&quot;\n&quot;);}}
Jash.Profiler=function(func,onFinish){this.func=func;this.time=0;this.defaultOnFinish=function(){};this.results=new Array();this.onFinish=typeof onFinish!=&quot;function&quot;?this.defaultOnFinish:onFinish;var self=this;this.reverseWhile=function(reps){this.stopWatch.start();while(reps&gt;0){this.func();reps--;}
return this.stopWatch.stop();}
this.forLoop=function(reps){this.stopWatch.start();for(i=0;i&lt;reps;i++){this.func();}
return this.stopWatch.stop();}
this.loop=function(kind,reps){if(!this.results[kind]){this.results[kind]=new Array();}
var repsMemberName=&quot;r_&quot;+reps;if(!this.results[kind][repsMemberName]){this.results[kind][repsMemberName]=new Array();}
var time=this[kind](reps);this.results[kind][repsMemberName].push(time);}
this.runOnce=function(){if(!this.results.runOnce){this.results.runOnce=new Array();}
this.stopWatch.start();func();this.results.runOnce.push(this.stopWatch.stop());}
this.stopWatch={t_start:0,t_end:0,t_total:0,start:function(){t_start=new Date().getTime();return t_start;},stop:function(){t_end=new Date().getTime();t_total=t_end-t_start;self.time=t_total;return t_total;}}
this.average=function(arr){var sum=0;for(i=0;i&lt;arr.length;i++){sum+=arr[i];}
return sum/arr.length}
this.multiPass=function(passes,type,reps){if(typeof type==&quot;undefined&quot;){type=&quot;runOnce&quot;;}else if(typeof this[type]==&quot;undefined&quot;){jash.print(&quot;Error: the loop type '&quot;+type+&quot;' does not exist&quot;);return false;}
var self=this;if(type==&quot;runOnce&quot;){if(passes&lt;1){self.reportProfile(Math.round(this.average(this.results.runOnce)),type,reps);}else{window.setTimeout(function(){self.runOnce();self.multiPass(--passes,type);},50);}}else{if(passes&lt;1){var repsMemberName=&quot;r_&quot;+reps;self.reportProfile(Math.round(this.average(this.results[type][repsMemberName])),type,reps);}else{window.setTimeout(function(){self.loop(type,reps);self.multiPass(--passes,type,reps);},50);}}}
this.reportProfile=function(avgMs,type,reps){var line=&quot;-------PROFILER----------------------------------------------&quot;;var str=line+&quot;\n&quot;+this.func+&quot;\n&quot;+line+&quot;\n&quot;;str+=&quot;Type of profile: &quot;+type+&quot;\n&quot;;if(typeof reps!=&quot;undefined&quot;){str+=&quot;Loop iterations: &quot;+reps+&quot;\n&quot;;}
str+=&quot;Average execution time: &quot;+avgMs+&quot;ms&quot;+&quot;\n&quot;;if(type==&quot;runOnce&quot;){howManyTimes=this.results.runOnce.length;}else{repsMemberName=&quot;r_&quot;+reps;howManyTimes=this.results[type][repsMemberName].length;}
str+=&quot;Average calculated from &quot;+howManyTimes+&quot; pass(es)\n&quot;;str+=line+&quot;\n&quot;;jash.print(str);}}
Jash.TabComplete=function(){this.tabComplete=function(e){e=(typeof window.event!=&quot;undefined&quot;)?window.event:e;var inputText=this.input.value;var match=null;if(match=this.searchInputForDomGetElFunctions(inputText)){this.tabCompleteIdOrClassInJavascript(match.match[0],match.type);this.focusCaretAtEndOfInput();return false;}else if(this.evaluation.cssEvalFlag){this.tabCompleteIdOrClassInCss(inputText);this.focusCaretAtEndOfInput();return false;}else{this.tabCompleteJavascript(e,inputText);this.focusCaretAtEndOfInput();}}
this.focusCaretAtEndOfInput=function(){this.input.selectionEnd=this.input.selectionStart=this.input.value.length;}
this.tabCompleteJavascript=function(e,inputText){var words=inputText.split(/\s+/);var lastWord=words[(words.length-1)];var numOpeningParens=lastWord.split(&quot;(&quot;).length-1;var numClosingParens=lastWord.split(&quot;)&quot;).length-1;var scope;var sentinel=0;var diff=numOpeningParens-numClosingParens;if(diff&gt;0){numClosingParens=lastWord.split(&quot;(&quot;)[numOpeningParens].split(&quot;)&quot;).length-1;var numRealDanglers=numOpeningParens-numClosingParens;scope=lastWord.split(&quot;(&quot;).slice(numRealDanglers).join(&quot;(&quot;);}else if(diff&lt;0){this.print(&quot;error: too many closing parentheses&quot;);return false;}else{scope=lastWord;}
scope=scope.split(&quot;.&quot;);var fragment=scope.pop();scope=scope.join(&quot;.&quot;);if(scope==&quot;&quot;)scope=&quot;window&quot;;var members=this.getMembers(scope);var results=this.findTextMatchesInArray(members,fragment);if(results==false){}else if(typeof results!=&quot;string&quot;){this.dump(results);var bestMatch=this.findBestStringMatch(fragment,results);if(fragment!=''){fragReg=new RegExp(fragment+&quot;$&quot;);this.input.value=this.input.value.replace(fragReg,bestMatch);}else{this.input.value+=bestMatch;}}else{var reggie=new RegExp(fragment+&quot;$&quot;);this.input.value=this.input.value.replace(reggie,results);}
return false;}
this.doAllStringsInArrayHaveSameCharacterAtIndex=function(index,arr){var matched=0;if(!arr[0].charAt(index))return false;var character=arr[0].charAt(index);for(var i=1;i&lt;arr.length;i++){if(!arr[i].charAt(index)||arr[i].charAt(index)!=character){return false;}}
return true;}
this.findBestStringMatch=function(str,arr){var fragLength=str.length;var matches=this.doAllStringsInArrayHaveSameCharacterAtIndex(fragLength,arr);while(matches){fragLength++;matches=this.doAllStringsInArrayHaveSameCharacterAtIndex(fragLength,arr);}
return arr[0].substr(0,fragLength);}
this.tabCompleteIdOrClassInJavascript=function(inputText,type){var query=inputText.split(&quot;(&quot;);query=query[query.length-1].replace(/\W/g,'');var matches=new Array();var els=document.getElementsByTagName(&quot;*&quot;);if(type==&quot;id&quot;){for(var i=0;i&lt;els.length;i++){if(els[i].id&amp;&amp;els[i].id.indexOf(query)==0){matches.push(els[i].id);}}}else if(type==&quot;class&quot;){for(var i=0;i&lt;els.length;i++){if(els[i].className&amp;&amp;els[i].className!=''){var classes=els[i].className.split(/\s/);for(var ii=0;ii&lt;classes.length;ii++){if(classes[ii].indexOf(query)==0||query==''){if(matches.join(&quot;***&quot;).indexOf(classes[ii])==-1){matches.push(classes[ii]);}}}}}}
if(matches.length==1){this.input.value+=matches[0].split(query)[1];}else if(matches.length==0){this.print(&quot;no match&quot;);}else{this.dump(matches.sort());var bestMatch=this.findBestStringMatch(query,matches);if(query!=''){var replacement=inputText.split(&quot;(&quot;);replacement[replacement.length-1]=replacement[replacement.length-1].replace(query,bestMatch);this.input.value=this.input.value.replace(inputText,replacement.join(&quot;(&quot;));}else{this.input.value+=bestMatch;}}}
this.tabCompleteIdOrClassInCss=function(inputText){var selectors=inputText.replace(/(\.|#)/g,' $1').split(/\s+/);var lastSelector=selectors[selectors.length-1];var els=document.getElementsByTagName(&quot;*&quot;);var matches=new Array();if(lastSelector.match(/^\./)){for(var i=0;i&lt;els.length;i++){if(els[i].className&amp;&amp;els[i].className!=''){var classes=els[i].className.split(/\s/);for(var ii=0;ii&lt;classes.length;ii++){if(classes[ii].indexOf(lastSelector.substr(1))==0||lastSelector==&quot;.&quot;){if(matches.join(&quot;***&quot;).indexOf(classes[ii])==-1){matches.push(&quot;.&quot;+classes[ii]);}}}}}}else if(lastSelector.match(/^#/)){for(var i=0;i&lt;els.length;i++){if(els[i].id&amp;&amp;els[i].id.indexOf(lastSelector.substr(1))==0){matches.push(&quot;#&quot;+els[i].id);}}}
if(matches.length==1){this.input.value+=matches[0].split(lastSelector)[1];}else if(matches.length==0){this.print(&quot;no match&quot;);}else{this.dump(matches.sort());var bestMatch=this.findBestStringMatch(lastSelector,matches);if(lastSelector!=''){this.input.value=this.input.value.replace(lastSelector,bestMatch);}else{this.input.value+=bestMatch;}}}
this.searchInputForDomGetElFunctions=function(inputText){for(var i=0;i&lt;this.domGetElFunctions.id.length;i++){var selfct=new RegExp(this.domGetElFunctions.id[i].replace(&quot;\$&quot;,&quot;\\\$&quot;)+&quot;\\\(['\&quot;]\\w*$&quot;);if(inputText.match(selfct)){return{match:inputText.match(selfct),type:&quot;id&quot;};}}
for(var i=0;i&lt;this.domGetElFunctions.className.length;i++){var selfct=new RegExp(this.domGetElFunctions.className[i].replace(&quot;\$&quot;,&quot;\\\$&quot;)+&quot;\\\(['\&quot;]\\w*$&quot;);if(inputText.match(selfct)){return{match:inputText.match(selfct),type:&quot;class&quot;};}}}
this.findTextMatchesInArray=function(arrayToTest,findMe){var resultsArray=new Array();var tester=new RegExp(&quot;^&quot;+findMe);for(var i=0;i&lt;arrayToTest.length;i++){if(tester.test(arrayToTest[i])){resultsArray.push(arrayToTest[i]);}}
if(resultsArray.length&gt;1){resultsArray.sort();return resultsArray;}else if(resultsArray.length==1){return resultsArray[0];}else{return false;}}
this.getMembers=function(context){var members=new Array();for(memberName in eval(context)){members.push(memberName);}
return members;}
return this;}
new function(){if(&quot;jash&quot;in window){window.jash.close();}else{window.jash=new Jash();window.jash.main();}}
//}}}</pre>
</div>
<div title="MediaWikiTableFormatterPlugin" modifier="FND" created="200810311628" modified="200907080945" tags="plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200907080945">
<pre>/***
|''Name''|MediaWikiTableFormatterPlugin|
|''Description''|Allows MediaWiki style tables in TiddlyWiki|
|''Author''|Martin Budden (mjbudden (at) gmail (dot) com)|
|''Contributors''|FND|
|''Version''|0.1.2|
|''Status''|stable|
|''Source''|http://devpad.tiddlyspot.com/#MediaWikiTableFormatterPlugin|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/formatters/MediaWikiTableFormatterPlugin.js|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion:''|2.1.0|
!Description
Enables [[MediaWiki|http://www.mediawiki.org]]'s table markup in TiddlyWiki, allowing for multi-line contents within table cells.
(Note that all TiddlyWiki markup still applies.)
!Usage
Detailed documentation available at [[MediaWiki.org|http://www.mediawiki.org/wiki/Help:Tables]].
!!Examples
{{{
{|
! Heading 1
! Heading 2
! Heading 3
|-
| row 1, column 1
| row 1, column 2
| row 1, column 3
|-
| row 2, column 1
| row 2, column 2
| row 2, column 3
|}
}}}
{|
! Heading 1
! Heading 2
! Heading 3
|-
| row 1, column 1
| row 1, column 2
| row 1, column 3
|-
| row 2, column 1
| row 2, column 2
| row 2, column 3
|}
!Revision History
!!v0.1 (2008-10-31)
* initial release
!!v0.1.2 (2008-11-05)
* removed unnecessary code
!Code
***/
//{{{
if(!version.extensions.MediaWikiTableFormatterPlugin) { //# ensure that the plugin is only installed once
version.extensions.MediaWikiTableFormatterPlugin = {installed:true};

if(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1)) {
	alertAndThrow('MediaWikiTableFormatterPlugin requires TiddlyWiki 2.1 or later.');
}

config.formatters.push({
	name: 'enhancedTable',
	match: '^\\{\\|',
	handler: function(w) {
		var pair = MediaWikiTemplate.findTableBracePair(w.source,w.matchStart);
		if(pair.start==w.matchStart) {
			w.nextMatch = w.matchStart;
			var table = MediaWikiTemplate.createElement(w.output,'table');
			var tbody = MediaWikiTemplate.createElement(table,'tbody'); // required for IE
			var mwt = new MediaWikiTemplate();
			mwt.wikifyTable(tbody,w,pair);
		}
	}
});


MediaWikiTemplate = function()
{
	this.stack = [];
	this.error = false;
	this.tiddler = null;
};

MediaWikiTemplate.createElement = function(parent,element)
{
	return parent.appendChild(document.createElement(element));
}

MediaWikiTemplate.setAttributesFromParams = function(e,p)
{
	var re = /\s*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\w|%|#)*))/mg;
	var match = re.exec(p);
	while(match) {
		var s = match[1].unDash();
		if(s == 'bgcolor') {
			s = 'backgroundColor';
		}
		try {
			if(match[2]) {
				e.setAttribute(s,match[2]);
			} else if(match[3]) {
				e.setAttribute(s,match[3]);
			} else {
				e.setAttribute(s,match[4]);
			}
		}
		catch(ex) {}
		match = re.exec(p);
	}
};

MediaWikiTemplate.findRawDelimiter = function(delimiter,text,start)
//# find a delimiter that is not enclosed by [[..]]
{
	var d = text.indexOf(delimiter,start);
	if(d==-1)
		return -1;
	var b = {start:-1,end:-1};
	var bs = text.indexOf('[[',start);
	if(bs==-1 || bs &gt;d)
		return d;
	var s1 = -1;
	if(bs!=-1 &amp;&amp; bs &lt;d) {
		var be = text.indexOf(']]',bs);
		if(be!=-1) {
			b.start = bs;
			b.end = be;
		}
	}
	if(b.start!=-1 &amp;&amp; d&gt;b.start)
		s1 = b.end+2;
	return s1==-1 ? d : MediaWikiTemplate.findRawDelimiter(delimiter,text,s1);
};

MediaWikiTemplate.findTableBracePair = function(text,start)
{
	var ret = {start:-1,end:-1};
	var s = text.indexOf('{|',start);
	if(s==-1)
		return ret;
	var e = text.indexOf('\n|}',s+2);
	if(e==-1)
		return ret;
	e++;
	var s2 = text.indexOf('{|',s+2);
	if(s2==-1 || s2 &gt; e)
		return {start:s,end:e};
	var tp = MediaWikiTemplate.findTableBracePair(text,s+2);
	while(tp.end!=-1 &amp;&amp; e&gt;tp.start &amp;&amp; e&lt;=tp.end) {
		//# intervening table brace pair, so skip over
		e = tp.end+2;
		tp = MediaWikiTemplate.findTableBracePair(text,e);
		e = text.indexOf('\n|}',e);
		if(e==-1)
			return ret;
		e++;
	}
	return {start:s,end:e};
};

MediaWikiTemplate.prototype.wikifyTable = function(table,w,pair)
{
	function lineEnd(w) {
		var r = w.source.indexOf('\n',w.nextMatch);
		while(r!=-1) {
			var n = w.source.substr(r+1,1);
			if(n=='|' || n=='!' || (n=='{' &amp;&amp; w.source.substr(r+2,1)=='|'))
				break;
			r = w.source.indexOf('\n',r+1);
		}
		return r;
	}
	function subWikifyText(e,w,text) {
			var oldSource = w.source; var oldMatch = w.nextMatch;
			w.source = text; w.nextMatch = 0;
			w.subWikifyUnterm(e);
			w.source = oldSource; w.nextMatch = oldMatch;
	}
	//# skip over {|
	w.nextMatch += 2;
	var i = lineEnd(w);
	if(i&gt;w.nextMatch) {
		MediaWikiTemplate.setAttributesFromParams(table.parentNode,w.source.substring(w.nextMatch,i));
		w.nextMatch = i;
	}
	w.nextMatch++;
	if(w.source.substr(w.nextMatch,2)=='|+') {
		var caption = MediaWikiTemplate.createElement(table,'caption');
		w.nextMatch += 2;
		i = lineEnd(w);
		var d = MediaWikiTemplate.findRawDelimiter('|',w.source,w.nextMatch);
		if(d!=-1 &amp;&amp; d&lt;i) {
			MediaWikiTemplate.setAttributesFromParams(caption,w.source.substring(w.nextMatch,d));
			w.nextMatch = d+1;
		}
		w.subWikifyTerm(caption,/(\n)/mg);
	}
	var tr = MediaWikiTemplate.createElement(table,'tr');
	if(w.source.substr(w.nextMatch,2)=='|-') {
		w.nextMatch += 2;
		i = lineEnd(w);
		if(i&gt;w.nextMatch) {
			MediaWikiTemplate.setAttributesFromParams(tr,w.source.substring(w.nextMatch,i));
			w.nextMatch = i;
		}
		w.nextMatch++;
	}
	var x = w.source.substr(w.nextMatch,2);
	while(x!='|}') {
		if(x=='{|') {
			//# nested table
			var pair2 = MediaWikiTemplate.findTableBracePair(w.source,w.nextMatch);
			if(pair2.start==w.nextMatch) {
				var table2 = MediaWikiTemplate.createElement(cell,'table');
				this.wikifyTable(table2,w,pair2);
			}
		} else if(x=='|-') {
			//# new row
			tr = MediaWikiTemplate.createElement(table,'tr');
			w.nextMatch += 2;
			i = lineEnd(w);
			if(i==-1)
				break;
			if(i&gt;w.nextMatch) {
				MediaWikiTemplate.setAttributesFromParams(tr,w.source.substring(w.nextMatch,i));
				w.nextMatch = i;
			}
			w.nextMatch++;
		} else if(x.substr(0,1)=='!') {
			//# header cell
			w.nextMatch++;
			i = lineEnd(w);
			if(i==-1)
				break;
			var cell = MediaWikiTemplate.createElement(tr,'th');
			var c = w.source.indexOf('!!',w.nextMatch);
			while(c!=-1 &amp;&amp; c&lt;i) {
				d = MediaWikiTemplate.findRawDelimiter('|',w.source,w.nextMatch);
				if(d!=-1 &amp;&amp; d&lt;c) {
					MediaWikiTemplate.setAttributesFromParams(cell,w.source.substring(w.nextMatch,d));
					w.nextMatch = d+1;
				}
				while(w.source.substr(w.nextMatch,1)==' ') {
					w.nextMatch++;
				}
				w.subWikifyTerm(cell,/(\!\!)/mg);
				cell = MediaWikiTemplate.createElement(tr,'th');
				c = w.source.indexOf('!!',w.nextMatch);
			}
			d = MediaWikiTemplate.findRawDelimiter('|',w.source,w.nextMatch);
			if(d!=-1 &amp;&amp; d&lt;i) {
				MediaWikiTemplate.setAttributesFromParams(cell,w.source.substring(w.nextMatch,d));
				w.nextMatch = d+1;
			}
			while(w.source.substr(w.nextMatch,1)==' ') {
				w.nextMatch++;
			}
			subWikifyText(cell,w,w.source.substring(w.nextMatch,i));
			w.nextMatch = i+1;
		} else if(x.substr(0,1)=='|') {
			//# cell
			w.nextMatch++;
			i = lineEnd(w);
			if(i==-1)
				break;
			cell = MediaWikiTemplate.createElement(tr,'td');
			c = w.source.indexOf('||',w.nextMatch);
			while(c!=-1 &amp;&amp; c&lt;i) {
				d = MediaWikiTemplate.findRawDelimiter('|',w.source,w.nextMatch);
				if(d!=-1 &amp;&amp; d&lt;c) {
					MediaWikiTemplate.setAttributesFromParams(cell,w.source.substring(w.nextMatch,d));
					w.nextMatch = d+1;
				}
				while(w.source.substr(w.nextMatch,1)==' ') {
					w.nextMatch++;
				}
				w.subWikifyTerm(cell,/(\|\|)/mg);
				cell = MediaWikiTemplate.createElement(tr,'td');
				c = w.source.indexOf('||',w.nextMatch);
			}
			d = MediaWikiTemplate.findRawDelimiter('|',w.source,w.nextMatch);
			if(d!=-1 &amp;&amp; d&lt;i) {
				MediaWikiTemplate.setAttributesFromParams(cell,w.source.substring(w.nextMatch,d));
				w.nextMatch = d+1;
			}
			while(w.source.substr(w.nextMatch,1)==' ') {
				w.nextMatch++;
			}
			subWikifyText(cell,w,w.source.substring(w.nextMatch,i));
			w.nextMatch = i+1;
		}
		x = w.source.substr(w.nextMatch,2);
	}
	w.nextMatch = pair.end + 3;
	return;
};

} //# end of 'install only once'
//}}}</pre>
</div>
<div title="NestedBrowserMacro" modifier="FND" created="200710040939" modified="200710040947" tags="plugin macro systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200710040947">
<pre>/***
|''Name''|NestedBrowserMacro|
|''Description''|Creates a browser pane inside a tiddler for viewing external pages.|
|''Version''|0.1.1|
|''Source''|[[Rodney's Corner|http://rodney.gotdns.com]] (mirror: [[FND's DevPad|http://devpad.tiddlyspot.com/#NestedBrowserMacro]])|
|''Author''|[[RodneyGomes]]|
|''Contributor''|FND|
|''Type''|Macro|
!Usage
A name must be specified for the browser window in order to give for the back and forward buttons to work. Also required are the URL, width and height for the browser pane.
{{{
&lt;&lt;browse frameName url width height&gt;&gt;
}}}
!!Example
{{{
&lt;&lt;browse &quot;Google&quot; &quot;http://www.google.com&quot; &quot;100%&quot; &quot;100px&quot;&gt;&gt;
}}}
&lt;&lt;browse &quot;Google&quot; &quot;http://www.google.com&quot; &quot;100%&quot; &quot;100px&quot;&gt;&gt;
!Limitations
Uses an //iframe//, which some browsers might not support.
!Revision History
!!v0.1.0 (2006-02-18)
* initial release 
!!v0.1.1 (2007-10-04)
* various adjustments of the meta description
* mirrored at [[FND's DevPad|http://devpad.tiddlyspot.com/#NestedBrowserMacro]] as the original source is not available anymore
!Code
***/
//{{{
config.macros.browse = {};

config.macros.browse.handler = function(place,macroName,params) {
	
	var frameName = params[0];
	var url = params[1];
	var width = params[2];
	var height = params[3];
	
	var myBackButton = document.createElement('a');
	myBackButton.href = &quot;javascript:frames['&quot; + frameName + &quot;'].history.back()&quot;;
	var buttonText = document.createTextNode('[Back]');
	myBackButton.appendChild(buttonText);
	
	var myForwardButton = document.createElement('a');
	myForwardButton.href = &quot;javascript:frames['&quot; + frameName + &quot;'].history.forward()&quot;;
	var buttonText = document.createTextNode('[Forward]');
	myForwardButton.appendChild(buttonText);
	
	var myIframe = document.createElement('iframe');	
	myIframe.name = frameName;
	myIframe.src = url;
	myIframe.style.width = width;
	myIframe.style.height = height;
	
	place.appendChild(myBackButton);
	place.appendChild(myForwardButton);
	place.appendChild(myIframe);
	
}
//}}}</pre>
</div>
<div title="NewFromHereMacro" modifier="FND" created="200712270839" modified="200712270840" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712270840">
<pre>/***
|''Name''|NewFromHereMacro|
|''Version''|0.9|
|''Status''|stable|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#NewFromHereMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Creates a new tiddler, using the originating tiddler's title as a prefix.|
!Note
This macro is based upon the [[NewHerePlugin|http://mptw.tiddlyspot.com/#NewHerePlugin]].
!Usage
{{{
&lt;&lt;newFromHere [parameters]&gt;&gt;
}}}
Parameter handling is identical to the [[NewTiddler|http://www.tiddlywiki.com/#NewTiddlerMacro]] macro.
!!Example
&lt;&lt;newFromHere&gt;&gt;
&lt;&lt;newFromHere label:&quot;new tiddler from here&quot;&gt;&gt;
!Revision History
!!v0.9 (2007-12-27)
* initial release
!To Do
* custom separator character
* optional default tag
!Code
***/
//{{{
config.macros.newFromHere = {
	separator: &quot;: &quot;
};

config.macros.newFromHere.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	wikify(&quot;&lt;&lt;newTiddler &quot; + paramString + &quot; title:[[&quot; + tiddler.title + this.separator + &quot;]]&gt;&gt;&quot;,
		place,null,tiddler);
};
//}}}</pre>
</div>
<div title="OpenTaggedTiddlersMacro" modifier="FND" created="200706302027" modified="200706302141" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706302141">
<pre>/***
|Name|OpenTaggedTiddlersMacro|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#OpenTaggedTiddlersMacro]]|
|Version|0.1.2|
|Author|[[one_each|http://groups.google.com/group/TiddlyWiki/browse_thread/t/77d70c4e01e7c6fa]]|
|Contributor|FND|
|License|public domain|
|~CoreVersion|1.2|
|Type|macro|
|Requires|N/A|
|Overrides|N/A|
|Description|open all tiddlers with a given tag|
!Usage
{{{
&lt;&lt;openAll [[tag]] [&quot;title:...&quot;] [closeAllFirst]&gt;&gt;
}}}
!Options
Although the tag is required as the first parameter, the options listed below are optional and may appear in any order.
|!Option|!Description|
|closeAllFirst|close all other tiddlers first|
|&lt;nowiki&gt;title:Title&lt;/nowiki&gt;|button caption (enclose in quotation marks if the text contains spaces)|
!Examples
|!Code|!Output|
|{{{&lt;&lt;openAll systemConfig&gt;&gt;}}}|&lt;&lt;openAll systemConfig&gt;&gt;|
|{{{&lt;&lt;openAll systemConfig closeAllFirst&gt;&gt;}}}|&lt;&lt;openAll systemConfig closeAllFirst&gt;&gt;|
|{{{&lt;&lt;openAll systemConfig &quot;title:Open system tiddlers&quot;&gt;&gt;}}}|&lt;&lt;openAll systemConfig &quot;title:Open system tiddlers&quot;&gt;&gt;|
!Revision History
!!v0.1.1 (2005-09-01)
* initial release [[by one_each|http://groups.google.com/group/TiddlyWiki/browse_thread/t/77d70c4e01e7c6fa]] (named &quot;openAll macro&quot;)
!!v0.1.2 (2005-06-30)
* minor code cleanup by FND
* removed {{{reverseOrder}}} parameter due to incompatibility with TiddlyWiki 2.2
* renamed to OpenTaggedTiddlersMacro
!Issues / To Do
* code cleanup / refactoring
!Code
***/
//{{{
version.extensions.openAll = {major: 0, minor: 1, revision: 1, date: new Date(&quot;Jun 30, 2007&quot;)};
config.macros.openAll = {}
config.macros.openAll.handler = function(place,macroName,params) {
	var title = &quot;Open all &quot; + params[0];
	var closeAllFirst = &quot;false&quot;;
	for(var i = 1; i &lt; params.length; i++) { // skip the first parameter
		if(params[i] == &quot;closeAllFirst&quot;)
			closeAllFirst = &quot;true&quot;;
		if(params[i].substring(0,6) == &quot;title:&quot;)
			title = params[i].substring(6);
	}
	var btn = createTiddlyButton(place,title,null,onClickOpenAllMacro);
	btn.setAttribute(&quot;tag&quot;,params[0]);
	btn.setAttribute(&quot;closeAllFirst&quot;,closeAllFirst);
}

// Event handler for 'openAll' macro
function onClickOpenAllMacro(e)
{
	if (!e) var e = window.event;
	var tag = this.getAttribute(&quot;tag&quot;);
	var tagged = store.getTaggedTiddlers(tag);
	if(this.getAttribute(&quot;closeAllFirst&quot;) == &quot;true&quot;)
		story.closeAllTiddlers();
	for(var t=tagged.length-1; t&gt;=0; t--)
		displayTiddler(this,tagged[t].title,0,null,null,false,e.shiftKey || e.altKey);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}
//}}}</pre>
</div>
<div title="PaletteViewMacro" modifier="FND" created="200711180822" modified="200711202208" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711202208">
<pre>/***
|''Name''|PaletteViewMacro|
|''Version''|0.2|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#PaletteViewMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Displays color palettes.|
!Notes
There is also [[ViewPalettePlugin|http://simon.tiddlyspot.com/#ViewPalettePlugin]], which currently does not work with TiddlyWiki v2.2 though.
!Usage
{{{
&lt;&lt;paletteView [tiddler name]&gt;&gt;
}}}
!!Example
&lt;&lt;paletteView [[ColorPalette]]&gt;&gt;
!Revision History
!!v0.1 (2007-11-18)
* initial release
!!v0.2 (2007-11-20)
* limited processing to slices containing [[actual color values|http://www.w3.org/TR/CSS21/syndata.html#color-units]]
* changed fallback value to the tiddler the macro is called from (instead of using [[ColorPalette]])
!To Do
* selection list for all available palettes (tag-based)
* parameter for custom table class
* customizable column order
* documentation (e.g. using from within [[ViewTemplate]])
!Code
***/
//{{{
config.macros.paletteView = {};

config.macros.paletteView.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = params[0] || tiddler.title;
	//var palettes = store.getTaggedTiddlers(params[0]); // DEBUG: yet to be implemented
	var colors = store.calcAllSlices(title);
	var labels = [];
	for(var c in colors) {
		if(this.isColor(colors[c])) {
			labels.push(c);
		}
	}
	if(labels.length &gt; 0) {
		var output = &quot;|!Sample|!Value|!Name|h\n&quot;;
		for(var i = 0; i &lt; labels.length; i++) {
			output += &quot;|padding:0 4em;background-color:&quot; + colors[labels[i]] + &quot;;&amp;nbsp;|&quot;
				+ &quot;{{{&quot; + colors[labels[i]] + &quot;}}}|&quot;
				+ &quot;[[&quot; + labels[i] + &quot;|&quot; + title + &quot;]]|\n&quot;;
		}
		wikify(output, place);
	}
};

config.macros.paletteView.isColor = function(s) {
	var colors = [&quot;Black&quot;, &quot;Green&quot;, &quot;Silver&quot;, &quot;Lime&quot;, &quot;Gray&quot;, &quot;Olive&quot;, &quot;White&quot;, &quot;Yellow&quot;,
		&quot;Maroon&quot;, &quot;Navy&quot;, &quot;Red&quot;, &quot;Blue&quot;, &quot;Purple&quot;, &quot;Teal&quot;, &quot;Fuchsia&quot;, &quot;Aqua&quot;, &quot;Orange&quot;];
	var match = s.match(/^#[0-9A-F]{3}$|^#[0-9A-F]{6}$|^RGB\([\d,\s]{5,}\)$/i);
	if(match) return true;
	if(colors.contains(s)) return true;
	return false;
};
//}}}</pre>
</div>
<div title="ParagraphFormatter" modifier="FND" created="200812041539" modified="200812041539" tags="plugins systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200812041539">
<pre>/***
|''Name''|ParagraphFormatter|
|''Description''|formatter modifying TiddlyWiki's handling of line breaks|
|''Author:''|FND|
|''Version''|0.1.1|
|''Status''|@@beta@@|
|''Source''|http://devpad.tiddlyspot.com/#ParagraphFormatter|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/contributors/FND/|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
!Description
This formatter modifies the way line breaks in wiki markup are rendered;
single line breaks are ignored, two line breaks result in a blank line being inserted.
!Usage
!!Examples
{{{
lorem
ipsum

dolor
sit
amet
}}}
&lt;&lt;&lt;
lorem
ipsum

dolor
sit
amet
&lt;&lt;&lt;
!Revision History
!!v0.1 (2008-12-03)
* initial release
!Code
***/
//{{{
(function(formatters) { //# set up alias

// modify line-break formatter
var lineBreak = formatters[formatters.findByField(&quot;name&quot;, &quot;lineBreak&quot;)];
lineBreak.match = &quot;&lt;br ?/?&gt;&quot;;
// create paragraph formatter
formatters.push({
	name: &quot;paragraph&quot;,
	match: &quot;\\n\\n&quot;,
	handler: function(w) {
		createTiddlyElement(w.output, &quot;br&quot;);
		createTiddlyElement(w.output, &quot;br&quot;);
	}
});

})(config.formatters); //# end of alias
//}}}</pre>
</div>
<div title="PasswordOptionPlugin" modifier="FND" created="200707211359" modified="200707211359" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200707211359">
<pre>/***
|''Name:''|PasswordOptionPlugin|
|''Description:''|Extends TiddlyWiki options with non encrypted password option.|
|''Version:''|1.0.2|
|''Date:''|Apr 19, 2007|
|''Source:''|http://tiddlywiki.bidix.info/#PasswordOptionPlugin|
|''Author:''|BidiX (BidiX (at) bidix (dot) info)|
|''License:''|[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D ]]|
|''~CoreVersion:''|2.2.0 (Beta 5)|
***/
//{{{
version.extensions.PasswordOptionPlugin = {
	major: 1, minor: 0, revision: 2, 
	date: new Date(&quot;Apr 19, 2007&quot;),
	source: 'http://tiddlywiki.bidix.info/#PasswordOptionPlugin',
	author: 'BidiX (BidiX (at) bidix (dot) info',
	license: '[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D]]',
	coreVersion: '2.2.0 (Beta 5)'
};

config.macros.option.passwordCheckboxLabel = &quot;Save this password on this computer&quot;;
config.macros.option.passwordInputType = &quot;password&quot;; // password | text
setStylesheet(&quot;.pasOptionInput {width: 11em;}\n&quot;,&quot;passwordInputTypeStyle&quot;);

merge(config.macros.option.types, {
	'pas': {
		elementType: &quot;input&quot;,
		valueField: &quot;value&quot;,
		eventName: &quot;onkeyup&quot;,
		className: &quot;pasOptionInput&quot;,
		typeValue: config.macros.option.passwordInputType,
		create: function(place,type,opt,className,desc) {
			// password field
			config.macros.option.genericCreate(place,'pas',opt,className,desc);
			// checkbox linked with this password &quot;save this password on this computer&quot;
			config.macros.option.genericCreate(place,'chk','chk'+opt,className,desc);			
			// text savePasswordCheckboxLabel
			place.appendChild(document.createTextNode(config.macros.option.passwordCheckboxLabel));
		},
		onChange: config.macros.option.genericOnChange
	}
});

merge(config.optionHandlers['chk'], {
	get: function(name) {
		// is there an option linked with this chk ?
		var opt = name.substr(3);
		if (config.options[opt]) 
			saveOptionCookie(opt);
		return config.options[name] ? &quot;true&quot; : &quot;false&quot;;
	}
});

merge(config.optionHandlers, {
	'pas': {
 		get: function(name) {
			if (config.options[&quot;chk&quot;+name]) {
				return encodeCookie(config.options[name].toString());
			} else {
				return &quot;&quot;;
			}
		},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	}
});

// need to reload options to load passwordOptions
loadOptionsCookie();

/*
if (!config.options['pasPassword'])
	config.options['pasPassword'] = '';

merge(config.optionsDesc,{
		pasPassword: &quot;Test password&quot;
	});
*/
//}}}</pre>
</div>
<div title="PasswordPromptMacro" modifier="FND" created="200707191452" modified="200709050738" tags="macro systemConfig obsolete" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709050738">
<pre>/***
|''Name''|PasswordPromptMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#PasswordPromptMacro]]|
|''Version''|0.8|
|''Author''|FND|
|''Contributors''|[[Lewcid|http://tw.lewcid.org]], [[BidiX|http://www.bidix.info]]|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|create a prompt for password input|
&lt;&lt;&lt;
''N.B.'' [[PasswordPromptMacro]] has been superseded by [[PasswordPromptPlugin]]
&lt;&lt;&lt;
!Usage Notes
* styling can be customized in the [[StyleSheetPasswordPrompt]] shadow tiddler
!Revision History
!!v0.1 (2007-07-19)
* initial proof-of-concept implementation
!!v0.8 (2007-07-21)
* fixed IE issues (thanks Saq and BidiX)
* made ENTER/RETURN key trigger the password check
* various changes and improvements
!To Do
* {{{checkPassword()}}}: provide &quot;interface&quot; for other plugins to use this functionality (cf. {{{displayMessage()}}}) &lt;br&gt;&amp;rArr; read/write password from/to custom variable ({{{config.macros.passwordPrompt.password}}}?) or use function call(??) instead of using macro parameter&lt;br&gt;&amp;rArr; encryption issues!?
* fix positioning issue in IE (caused by negative margin)
* clean up code&lt;br&gt;&amp;rArr; remove/fix {{{DEBUG}}} flags&lt;br&gt;&amp;rArr; use {{{this}}} instead of {{{config.macros.passwordPrompt}}}
* documentation
!Code
***/
//{{{
/*
** Styles (can be customized in the StyleSheetPasswordPrompt shadow tiddler)
*/

config.shadowTiddlers.StyleSheetPasswordPrompt = &quot;/*{{{*/\n&quot;
	+ &quot;#passwordPrompt {\n&quot;
	+ &quot;\tz-index: 100;\n&quot;
	+ &quot;\tposition: absolute;\n&quot;
	+ &quot;\ttop: 50%;\n&quot;
	+ &quot;\tleft: 50%;\n&quot;
	+ &quot;\twidth: 15em;\n&quot;
	+ &quot;\theight: 4.5em;\n&quot;
	+ &quot;\tline-height: 1.3em;\n&quot;
	+ &quot;\tmargin: -2em 0 0 -5em;\n&quot;
	+ &quot;\tborder: 2px solid #AAA;\n&quot;
	+ &quot;\tpadding: 10px;\n&quot;
	+ &quot;\ttext-align: center;\n&quot;
	+ &quot;\tbackground-color: #EEE;\n&quot;
	+ &quot;}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetPasswordPrompt&quot;, refreshStyles);

/*
** Macro Code
*/

config.macros.passwordPrompt = { label: &quot;toggle prompt&quot;, prompt: &quot;show/hide password prompt&quot; };
config.macros.passwordPrompt.handler = 
function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!readOnly) {
		createTiddlyButton(place, this.label, this.prompt, function() {
				// process parameters -- DEBUG: obsolete (for testing purposes only)?
				if (params[0]) {
					config.macros.passwordPrompt.password = params[0];
				} else {
					config.macros.passwordPrompt.password = &quot;&quot;;
				}
				// toggle password prompt
				config.macros.passwordPrompt.togglePrompt(this);
				return false;
			}, null, null, this.accessKey
		);
	}
}

/*
** Main Code
*/

config.macros.passwordPrompt.togglePrompt = function() {
	var e = document.getElementById(&quot;passwordPrompt&quot;);
	if(!e) {
		// create display container for password prompt
		var r = createTiddlyElement(document.body, &quot;form&quot;);
		r.setAttribute(&quot;id&quot;, &quot;passwordPrompt&quot;);
		r.setAttribute(&quot;action&quot;, &quot;&quot;);
		r.setAttribute(&quot;onsubmit&quot;, &quot;return false&quot;); // DEBUG: valid? obsolete (cf. i.onKeyPress)?
		// create label
		var l = createTiddlyElement(r, &quot;label&quot;, null, null, &quot;Enter password:&quot;);
		l.setAttribute(&quot;for&quot;, &quot;passwordField&quot;);
		// create password field
		var i = document.createElement (&quot;input&quot;);
		i.setAttribute(&quot;id&quot;, &quot;passwordField&quot;);
		i.setAttribute(&quot;type&quot;,&quot;password&quot;);
		i.onkeypress = function(e) { e = e; return config.macros.passwordPrompt.checkEnter(e); };
		r.appendChild(i); // needs to be done *after* setting the type attribute
		// create separator
		createTiddlyElement(r, &quot;br&quot;);
		// create submit button
		var b = document.createElement (&quot;input&quot;);
		b.setAttribute(&quot;type&quot;,&quot;button&quot;);
		b.setAttribute(&quot;value&quot;, &quot;ok&quot;);
		b.onclick = config.macros.passwordPrompt.checkPassword;
		r.appendChild(b); // needs to be done *after* setting the type attribute
		// select password field
		i.focus();
	} else {
		// remove input field
		e.parentNode.removeChild(e);
	}
}

config.macros.passwordPrompt.checkPassword = function() {
	var e = document.getElementById(&quot;passwordField&quot;);
	if(e.value === config.macros.passwordPrompt.password) {
		config.macros.passwordPrompt.togglePrompt();
		alert(&quot;password correct&quot;); // DEBUG: for testing purposes only
	}
	else
		alert(&quot;password incorrect&quot;);
}

config.macros.passwordPrompt.checkEnter = function(e) {
	// retrieve key code
	if(!e)
		var e = window.event;
	if(e.keyCode)
		var code = e.keyCode;
	else if(e.which)
		var code = e.which;
	// check key code
	if(code == 13) // ENTER key
		this.checkPassword();
	return true;
}
//}}}</pre>
</div>
<div title="PasswordPromptPlugin" modifier="FND" created="200707221321" modified="200708051145" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708051145">
<pre>/***
|''Name''|PasswordPromptPlugin|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#PasswordPromptMacro]]|
|''Version''|0.95|
|''Author''|FND|
|''Contributors''|[[Lewcid|http://tw.lewcid.org]], [[BidiX|http://www.bidix.info]], [[Loic|http://dachary.org]]|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|create a prompt for masked password inputs|
!Usage Notes
* {{{passwordPrompt.handler(promptString, callbackFunction);}}}, whereas the callback function takes the prompt's inputs as parameter
* styling can be customized in the [[StyleSheetPasswordPrompt]] shadow tiddler
!Revision History
!!v0.1 (2007-07-19)
* initial proof-of-concept implementation
!!v0.8 (2007-07-21)
* fixed IE issues (thanks Saq and BidiX)
* made ENTER/RETURN key trigger the password check
* various changes and improvements
!!v0.9 (2007-07-22)
* converted from a macro to a general-purpose component (function library)
!!v0.95 (2007-08-05)
* corrected callback usage (thanks Loic)
!To Do
* add cancel button
* clean up code&lt;br&gt;&amp;rArr; remove/fix {{{DEBUG}}} flags&lt;br&gt;&amp;rArr; use {{{this.}}} instead of {{{passwordPrompt.}}}
* documentation
* fix positioning issue in IE (not perfectly centered due to issues with negative margin)
!Code
***/
//{{{
/*
** Styles (can be customized in the StyleSheetPasswordPrompt shadow tiddler)
*/

config.shadowTiddlers.StyleSheetPasswordPrompt = &quot;/*{{{*/\n&quot;
	+ &quot;#passwordPrompt {\n&quot;
	+ &quot;\tz-index: 100;\n&quot;
	+ &quot;\tposition: absolute;\n&quot;
	+ &quot;\ttop: 50%;\n&quot;
	+ &quot;\tleft: 50%;\n&quot;
	+ &quot;\twidth: 15em;\n&quot;
	+ &quot;\theight: 4.5em;\n&quot;
	+ &quot;\tline-height: 1.3em;\n&quot;
	+ &quot;\tmargin: -2em 0 0 -5em;\n&quot;
	+ &quot;\tborder: 2px solid #AAA;\n&quot;
	+ &quot;\tpadding: 10px;\n&quot;
	+ &quot;\ttext-align: center;\n&quot;
	+ &quot;\tbackground-color: #EEE;\n&quot;
	+ &quot;}\n\n&quot;
	+ &quot;#passwordPrompt label {\n&quot;
	+ &quot;\tdisplay: block;\n&quot;
	+ &quot;}\n\n&quot;
	+ &quot;* html #passwordPrompt { /* IE fix */\n&quot;
	+ &quot;\tmargin: 0;\n&quot;
	+ &quot;}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetPasswordPrompt&quot;, refreshStyles);

/*
** Password Prompt class
*/

passwordPrompt = {}

passwordPrompt.handler = function(promptString, callback) {
	passwordPrompt.togglePrompt(promptString, callback);
	return false; // DEBUG: obsolete/nonsense!?
}

passwordPrompt.togglePrompt = function(promptString, callback) {
	var e = document.getElementById(&quot;passwordPrompt&quot;);
	if(!e) {
		// create display container for password prompt
		var r = createTiddlyElement(document.body, &quot;form&quot;);
		r.setAttribute(&quot;id&quot;, &quot;passwordPrompt&quot;);
		r.setAttribute(&quot;action&quot;, &quot;&quot;);
		r.setAttribute(&quot;onsubmit&quot;, &quot;return false&quot;); // DEBUG: valid? obsolete (cf. i.onKeyPress)?
		// create label
		var l = createTiddlyElement(r, &quot;label&quot;, null, null, promptString);
		l.setAttribute(&quot;for&quot;, &quot;passwordField&quot;);
		// create password field
		var i = document.createElement(&quot;input&quot;);
		i.setAttribute(&quot;id&quot;, &quot;passwordField&quot;);
		i.setAttribute(&quot;type&quot;,&quot;password&quot;);
		i.onkeypress = function(e, callback) { e = e || window.event; return passwordPrompt.checkEnter(e, callback); }; // DEBUG: &quot;e = e || window.event;&quot;??
		r.appendChild(i); // needs to be done *after* setting the type attribute
		// create separator
		createTiddlyElement(r, &quot;br&quot;);
		// create submit button
		var b = document.createElement (&quot;input&quot;);
		b.setAttribute(&quot;type&quot;,&quot;button&quot;);
		b.setAttribute(&quot;value&quot;, &quot;ok&quot;);
		b.onclick = function() { passwordPrompt.checkPassword(callback); }
		r.appendChild(b); // needs to be done *after* setting the type attribute
		// select password field
		i.focus();
	} else {
		// remove input field
		e.parentNode.removeChild(e);
	}
	return false; // DEBUG: obsolete/nonsense!?
}

passwordPrompt.checkPassword = function(callback) {
	var e = document.getElementById(&quot;passwordField&quot;);
	passwordPrompt.togglePrompt();
	return callback(e.value);
}

passwordPrompt.checkEnter = function(e, callback) {
	// retrieve key code
	if(!e)
		var e = window.event;
	if(e.keyCode)
		var code = e.keyCode;
	else if(e.which)
		var code = e.which;
	// check key code
	if(code == 13) // ENTER key
		this.checkPassword(callback);
	// do not suppress key presses
	return true;
}
//}}}</pre>
</div>
<div title="PasswordPromptPluginTest" modifier="FND" created="200707221420" modified="200708101713" tags="systemConfig tmp systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708101713">
<pre>//{{{
passwordPrompt.handler(&quot;test&quot;, passwordPromptTest);

function passwordPromptTest(inputs) {
	if(inputs === null)
		alert(&quot;'inputs' is null&quot;);
	else if(inputs === &quot;&quot;)
		alert(&quot;'inputs' is empty&quot;);
	else
		alert(&quot;'inputs' is\n&quot; + inputs);
}
//}}}</pre>
</div>
<div title="PasswordPromptTest" modifier="FND" created="200707191452" modified="200708101713" tags="tmp obsolete" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708101713">
<pre>This is the sandbox for testing the [[PasswordPromptMacro]].

/%&lt;&lt;passwordPrompt&gt;&gt; (password: none)%/
/%&lt;&lt;passwordPrompt &quot;test&quot;&gt;&gt; (password: &quot;test&quot;)%/</pre>
</div>
<div title="PrintMacro" modifier="FND" created="200712101847" modified="200712101854" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712101854">
<pre>/***
|''Name''|PrintMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#PrintMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|prints the current document|
!Usage
{{{
&lt;&lt;print [label] [tooltip] [class] [access key]&gt;&gt;
}}}
&lt;&lt;print&gt;&gt;
!Revision History
!!v0.1 (2007-12-10)
* initial release
!Code
***/
//{{{
config.macros.print = {
	label: &quot;print&quot;,
	prompt: &quot;print document&quot;,
	buttonClass: &quot;&quot;,
	accessKey: &quot;&quot;
};

config.macros.print.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var label = params[0] || this.label;
	var prompt = params[1] || this.prompt;
	var buttonClass = params[2] || this.buttonClass;
	var accessKey = params[3] || this.accessKey;
	createTiddlyButton(place, label, prompt,
		function() { window.print(); },
		buttonClass, null, accessKey);
}
//}}}</pre>
</div>
<div title="RandomSliceMacro" modifier="FND" created="200712161254" modified="200712161255" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712161255">
<pre>/***
|''Name''|RandomSliceMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#RandomSliceMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Fetches a random slice from a given tiddler.|
!Usage
{{{
&lt;&lt;randomSlice [tiddler name] [show label] [separator string]&gt;&gt;
}}}
!!Examples
&lt;&lt;randomSlice [[ColorPalette]]&gt;&gt;
&lt;&lt;randomSlice [[ColorPalette]] true &quot;::&quot;&gt;&gt;
!Revision History
!!v0.1 (2007-12-16)
* initial release
!To Do
* documentation
* custom label position (pre-/suffix)
!Code
***/
//{{{
config.macros.randomSlice = {};

config.macros.randomSlice.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = params[0] || tiddler.title;
	var showLabel = params[1] || false;
	var separator = params[2] || &quot;: &quot;;
	var slices = store.calcAllSlices(title);
	var labels = [];
	for(var name in slices) { // use Hash.keys() instead? cf. http://rick.measham.id.au/javascript/hash.htm
		labels.push(name);
	}
	if(labels.length &gt; 0) {
		var r = Math.round((labels.length - 1) * Math.random());
		var value = slices[labels[r]];
		if(showLabel) {
			var output = labels[r] + separator + value;
		} else {
			var output = value;
		}
		wikify(output, place);
	}
};
//}}}</pre>
</div>
<div title="RawTextAdaptor" modifier="FND" created="200810290855" modified="200811260947" tags="plugins systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200811260947">
<pre>/***
|''Name''|RawTextAdaptor|
|''Description''|adaptor for importing plain-text files (e.g. from Subversion) as tiddlers|
|''Author''|FND|
|''Version''|0.2.3|
|''Status''|@@beta@@|
|''Source''|http://devpad.tiddlyspot.com/#RawTextAdaptor|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/association/adaptors/|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''CoreVersion''|2.5|
!Revision History
!!v0.1 (2008-10-28)
* initial release
!To Do
* properly normalize URIs (cf. {{{trimURI}}})
!Code
***/
//{{{
if(!version.extensions.RawTextAdaptor) { //# ensure that the plugin is only installed once
version.extensions.RawTextAdaptor = { installed: true };

config.adaptors.rawtext = function() {};

(function(adaptor) { //# set up alias

adaptor.prototype = new AdaptorBase();
adaptor.serverType = &quot;rawtext&quot;;
adaptor.serverLabel = &quot;Raw Text&quot;;
adaptor.defaultModifier = &quot;...&quot;; // XXX: use empty string?

adaptor.prototype.getWorkspaceList = function(context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.workspaces = [{ title: &quot;N/A&quot; }];
	if(context.callback) {
		context.status = true;
		window.setTimeout(function() { callback(context, context.userParams); }, 0);
	}
	return true;
};

adaptor.prototype.getTiddlerList = function(context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	if(context.callback) {
		context.status = true;
		var filename = adaptor.trimURI(context.host).split(&quot;/&quot;).pop();
		context.tiddlers = [adaptor.createTiddler(filename)];
		window.setTimeout(function() { callback(context, context.userParams); }, 0);
	}
	return true;
};

adaptor.prototype.getTiddler = function(title, context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	if(!context.tiddler) {
		context.tiddler = adaptor.createTiddler(title);
	}
	context.tiddler.fields[&quot;server.type&quot;] = adaptor.serverType;
	context.tiddler.fields[&quot;server.host&quot;] = AdaptorBase.minHostName(context.host);
	var req = httpReq(&quot;GET&quot;, context.host, adaptor.getTiddlerCallback, context);
	return typeof req == &quot;string&quot; ? req : true;
};

adaptor.getTiddlerCallback = function(status, context, responseText, uri, xhr) {
	context.status = status;
	context.statusText = xhr.statusText;
	context.httpStatus = xhr.status;
	if(status) {
		context.tiddler.text = responseText;
	}
	if(context.callback) {
		context.callback(context, context.userParams);
	}
};

// create tiddler from filename
adaptor.createTiddler = function(filename) {
	var tiddler = new Tiddler(filename);
	var pos = filename.lastIndexOf(&quot;.&quot;);
	if(pos != -1) { // strip file extension
		tiddler.title = filename.substr(0, pos); //# N.B.: altering title is acceptable since it's not used as URI component
		if(filename.substr(pos) == &quot;.js&quot;) { // treat as plugin
			tiddler.tags = [&quot;systemConfig&quot;];
		}
	}
	tiddler.created = new Date();
	tiddler.modified = tiddler.created;
	tiddler.modifier = adaptor.defaultModifier;
	return tiddler;
};

// strip fragments and parameters from URI
adaptor.trimURI = function(uri) {
	return uri.split(&quot;#&quot;)[0].split(&quot;?&quot;)[0];
}

})(config.adaptors.rawtext); //# end of alias

} //# end of &quot;install only once&quot;
//}}}</pre>
</div>
<div title="RegEx Tester" modifier="FND" created="200603281642" modified="200705102141" tags="tools" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705102141">
<pre>{{annotation{(via [[MathCell TiddlyWiki|http://genisis329.googlepages.com/TWMath.html#%5B%5BRegexp%20Tester%5D%5D]])}}}
&lt;html&gt;&lt;form&gt;&lt;table style=&quot;width: 80%; right: 0em;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;REGEX&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;regex&quot; style=&quot;width: 100%;&quot;&gt;&lt;/input&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;
FLAGS&lt;/td&gt;&lt;td style=&quot;text-align: right;&quot;&gt;Global&lt;input type=&quot;checkbox&quot; name=&quot;g&quot;&gt;&lt;br/&gt;Multiline&lt;input type=&quot;checkbox&quot; name=&quot;m&quot;&gt;&lt;br/&gt;Ignore Case&lt;input type=&quot;checkbox&quot; name=&quot;i&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;
&lt;td&gt;STRING&lt;/td&gt;&lt;td&gt;&lt;textarea type=&quot;text&quot; name=&quot;string&quot; style=&quot;width: 100%; height: 5em;&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td style=&quot;text-align: right;&quot;&gt;&lt;input type=&quot;button&quot; value=&quot;execute&quot; onclick=&quot;
var flagging = []
if(this.form.g.checked)flagging.push('g');
if(this.form.i.checked)flagging.push('i');
if(this.form.m.checked)flagging.push('m');
var Reg = new RegExp(this.form.regex.value,flagging.join(''));
var result =this.form.string.value.match(Reg);
for(var i = 0; i &lt; result.length;i++){alert(result[i].toSource())}
this.form.lastChild.innerHTML = result.join(&amp;quot;&amp;lt;hr/&amp;gt;&amp;quot;);
&quot;&gt;&lt;/input&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;br/&gt;RESULT&lt;hr/&gt;
&lt;pre name=&quot;results&quot;&gt;&lt;/pre&gt;&lt;/form&gt;
&lt;/html&gt;</pre>
</div>
<div title="RelativeLinkMacro" modifier="FND" created="200708101710" modified="200708111843" tags="plugin macro systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708111843">
<pre>/***
|''Name''|RelativeLinkMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#RelativeLinkMacro]]|
|''Version''|0.2|
|''Author''|FND|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|creates PrettyLinks relative to the current tiddler|
!Usage Notes
{{{
&lt;&lt;relLink &quot;sub-tiddler&quot; [&quot;link title&quot;]&gt;&gt;
}}}
!!Examples
* {{{&lt;&lt;relLink &quot;SubTiddler&quot;&gt;&gt;}}}: &lt;&lt;relLink &quot;SubTiddler&quot;&gt;&gt;
* {{{&lt;&lt;relLink &quot;SubTiddler&quot; &quot;custom link title&quot;&gt;&gt;}}}: &lt;&lt;relLink &quot;SubTiddler&quot; &quot;custom link title&quot;&gt;&gt;
!Revision History
!!v0.1 (2007-08-10)
* initial proof-of-concept implementation
!!v0.2 (2007-08-10)
* added optional parameter for link title
!To Do
* rename plugin(?)
* adjust description
!Code
***/
//{{{
config.macros.relLink = {}
config.macros.relLink.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!params[1])
		var link = &quot;[[&quot; + tiddler.title + params[0] + &quot;]]&quot;;
	else
		var link = &quot;[[&quot; + params[1] + &quot;|&quot; + tiddler.title + params[0] + &quot;]]&quot;;
	wikify(link, place);
}
//}}}</pre>
</div>
<div title="RemoteBackgroundPlugin" modifier="FND" created="200707010647" modified="200707010647" tags="plugin systemConfig systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200707010647">
<pre>/***
RemoteBackgroundPlugin v1.0 (2007-02-19)
 by FND

Retrieves a random image from XKCD and uses it as background image.

''N.B.:'' Do not abuse this; retrieving the images from XKCD could be regarded as hotlinking!
!!Changelog
!!!v0.9 (2007-02-18)
* initial release
!!!v1.0 (2007-02-19)
* added ability to position background image
* minor code adjustments
!!ToDo
* wait until TiddlyWiki loaded has completed before loading remote data
* extensive bug-testing (esp. non-Mozilla browsers)
!!Code
***/
/*{{{*/
setBgImg();

// set background image
function setBgImg() {
	if (img() != null) {
		document.body.style.backgroundImage = &quot;url(&quot; + img()[0] + &quot;)&quot;;
		document.body.style.backgroundRepeat = &quot;no-repeat&quot;;
		document.body.style.backgroundPosition = &quot;center&quot;;
		document.body.style.backgroundAttachment = &quot;fixed&quot;;
		document.body.title = img()[1];
	} else {
		alert(&quot;error fetching remote image&quot;);
	}
}

// fetch image URL
function img() {
	// get remote location
	var maxCount = 225; // current amount of comcics - 2007-02-19
	var counter = Math.ceil(Math.random() * maxCount);
	var remoteSite = &quot;http://xkcd.com/c&quot; + counter + &quot;.html&quot;;
	// fetch remote image
	var XmlHttp = true;
	var source = null;
	try { // query for permission to access remote file
		netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);
	} catch (e) {
		XmlHttp = false;
	}
	// initiate XmlHttp
	if (typeof XMLHttpRequest != 'undefined') { // Mozilla, Opera, Safari and Internet Explorer 7
		XmlHttp = new XMLHttpRequest();
	}
	if (!XmlHttp) { // Internet Explorer 6 and older
		try {
			XmlHttp  = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
		} catch(e) {
			try {
				XmlHttp  = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
			} catch(e) {
				XmlHttp  = null;
			}
		}
	}
	// get remote document
	if (XmlHttp != false) {
		XmlHttp = new XMLHttpRequest();
		if (XmlHttp) {
			// establish connection
			XmlHttp.open('GET', remoteSite, false);
			XmlHttp.send(null);
			// get image URL
			//source = XmlHttp.responseXML.getElementsByTagName('img')[1].src; // source data no valid XML =&gt; RexEx workaround
			var extract = XmlHttp.responseText.match(/&lt;img src=&quot;(.+)&quot; title=&quot;(.+)&quot; alt/i);
			image = new Array(extract[1], extract[2]); // store URL and title value
		}
	}
	return image;
}
/*}}}*/</pre>
</div>
<div title="SearchTagPlugin" modifier="FND" created="200807161350" modified="200807161351" tags="plugins systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200807161351">
<pre>/***
|''Name''|SearchTagPlugin|
|''Description''|adds web-search links to internal wiki links|
|''Author''|FND|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Source''|http://devpad.tiddlyspot.com/#SearchTagPlugin|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/contributors/FND/|
|''License''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
!Notes
Also see http://www.aboutus.org/TiddlyWikiGoogleTagCombinations.
!Revision History
!!v0.1 (2008-07-16)
* initial release
!Code
***/
//{{{
if(!version.extensions.SearchTagPlugin) {
version.extensions.SearchTagPlugin = {
	installed: true,
	URL: &quot;http://google.com/search?q=&quot;,
	label: &quot;[G]&quot;
};
 
// hijack createTiddlyLink() to prepend search link
createTiddlyLink_SearchTag = window.createTiddlyLink;
window.createTiddlyLink = function(place, title, includeText, className, isStatic, linkedFromTiddler, noToggle) {
	var cfg = version.extensions.SearchTagPlugin;
	createTiddlyText(createExternalLink(place, cfg.URL + title), cfg.label);
	createTiddlyText(place, &quot; &quot;);
	return createTiddlyLink_SearchTag.apply(this, arguments);
};

} //# end of &quot;install only once&quot;
//}}}</pre>
</div>
<div title="SearchTextTweaks" modifier="FND" created="200709091850" modified="200709091905" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709091905">
<pre>/***
|''Name:''|SearchTextTweaks|
|''Description:''|adds descriptive text to the search box|
|''Author:''|Saq Imtiaz (lewcid@gmail.com)|
|''Contributor:''|FND|
|''Source:''|http://tw.lewcid.org/#SearchTextTweaks|
|''Code Repository:''|http://tw.lewcid.org/svn/plugins|
|''Version:''|2.0 beta|
|''Date:''|2007-09-09|
|''License:''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion:''|2.1|
!Configuration
Using [[StyleSheet]], the {{{inactive}}} class can be used to change the search box's style (using CSS) when it is not active.
For example, the following code dims the text in the search box when it is not active:
{{{
.inactive { color: #aaa; }
}}}
***/
// /%
//!BEGIN-PLUGIN-CODE
//{{{
config.macros.search.defaultText = &quot;Search&quot;;

config.macros.search.old_handler = config.macros.search.handler;
config.macros.search.handler = function(place,macroName,params) {
	this.old_handler.apply(this,arguments);
	var e = place.lastChild;
	e.setAttribute(&quot;defaultText&quot;,params[0]||this.defaultText);
	e.value = e.getAttribute(&quot;defaultText&quot;);
	e.onblur = function() {
		if(this.value == '' || !this.value)
			this.value = this.getAttribute(&quot;defaultText&quot;);
		addClass(this, &quot;inactive&quot;);
	};
};

config.macros.search.onFocus = function(e) {
	if(this.value == this.getAttribute(&quot;defaultText&quot;))
		this.value = '';
	removeClass(this, &quot;inactive&quot;);
	this.select();
};
//}}}
//!END-PLUGIN-CODE
// %/</pre>
</div>
<div title="SimpleCommentsPlugin" modifier="FND" created="200705140830" modified="200705150609" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705150609">
<pre>/***
|Name|SimpleCommentsPlugin|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#SimpleCommentsPlugin]]|
|Version|0.7|
|Author|FND|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|add comments to a tiddler|
!Usage
Add {{{&lt;&lt;addComment&gt;&gt;}}} to the desired tiddler(s).
Alternatively, add the following to the tiddler toolbar (usually in ViewTemplate, {{{&lt;div class='toolbar' macro='...'&gt;}}}): {{{addComment}}} (currently untested)

''N.B.:'' For now, TiddlyWiki needs to be saved manually after adding a comment, thus making this plugin rather unsuitable for read-only TiddlyWikis.
!Changelog
!!v0.5 (2007-05-08)
* initial release
!!v0.6 (2007-05-10)
* moved required styles into a shadow tiddler
!!v0.7 (2007-05-14)
* complete rewrite from DOM-based to string-based processing
!Issues / To Do
* proper creation of command buttons
* global option and/or macro parameter for reverseOrder
* revise CSS properties
* review code (esp. section marked with DEBUG)
* some functions/routines might be redundant (i.e. already present in the TiddlyWiki core, e.g. {{{trim()}}}, {{{IsoTimestamp()}}} &amp; {{{zeroPad()}}}?)
!Code
***/
//{{{
/*
** Styles (can be customized in the StyleSheetSimpleComments shadow tiddler)
*/

config.shadowTiddlers.StyleSheetSimpleComments = &quot;/*{{{*/\n&quot;
	+ &quot;.comments {\n\tmargin-top: 2em;\n\tpadding: 1em 4px 4px;\n\tborder-top: 2px ridge #AAA;\n\tbackground-color: #F8F8F8;\n}\n\n&quot;
	+ &quot;.comments .comment {\n\tmargin: 0.5em 1em;\n\tpadding: 4px;\n\tborder: 1px solid #AAA;\n\tbackground-color: #FFF;\n}\n\n&quot;
	+ &quot;.comments .comment h1,\n.comments .comment h2 {\n\tmargin: 0 0 0.2em;\n\tpadding: 0;\n\tborder-bottom: 1px solid #AAA;\n\tbackground-color: transparent;\n}\n\n&quot;
	+ &quot;.comments .comment h1 {\n\tfloat: right;\n}\n\n&quot;
	+ &quot;.comments .comment p {\n\tmargin: 0 0 0.2em;\n}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetSimpleComments&quot;, refreshStyles);

/*
** Command Buttons
*/

/* Macro Button */
// adapted from Jack's DoBackupMacro (http://groups.google.com/group/TiddlyWiki/browse_thread/thread/5f1123d08bdadeac/86245d5e4bbe846c)
config.macros.addComment = { label: &quot;Add comment&quot;, prompt: &quot;Add a new comment&quot; }; // DEBUG: prompt not needed!?
config.macros.addComment.handler = function(place) {
	if(!readOnly) {
		createTiddlyButton(place, this.label, this.prompt, function() {
				addTiddlerComment(this);
				return false; // DEBUG: ?
			}, null, null, this.accessKey
		); // DEBUG - to do: look up createTiddlyButton()'s parameters
	}
}

/* Toolbar Button */
config.commands.addComment = { text: &quot;Add comment&quot;, tooltip: &quot;Add a comment&quot; }
config.commands.addComment.handler = function() {
	addTiddlerComment(this); // DEBUG: does that work?
}

/*
** Script
*/

// adapted from Eric Shulman's CommentScript (http://www.tiddlytools.com/#CommentScript)
addTiddlerComment = function(place) {
	// select current tiddler
	var here = story.findContainingTiddler(place);
	if (!here) {
		alert(&quot;error: no tiddler specified&quot;);
		return;
	}
	var title = here.getAttribute(&quot;tiddler&quot;);
	var tiddler = store.getTiddler(title);
	// retrieve tiddler sections
	var tiddlerContentsPre = tiddler.text + &quot;\n&quot;;
	var tiddlerComments = &quot;&quot;;
	var tiddlerContentsPost = &quot;&quot;;
	var RegEx = /^([\S\s]*)\{\{comments\{((?:\{\{comment\{[^}]*\}\}\}|\s+)*)\}\}\}([\S\s]*)$/i; // RegEx provided by Andreas &quot;Qtax&quot; Zetterlund (www.qtax.se)
	var tiddlerContents = RegEx.exec(tiddler.text);
	if (tiddlerContents != null) {
		tiddlerContentsPre = tiddlerContents[1];
		tiddlerComments += lTrim(tiddlerContents[2]); // assuming there is only a single comments section per tiddler
		tiddlerContentsPost = tiddlerContents[3];
	}
	// append comment
	var reverseOrder = false; // DEBUG: global option!?
	if (reverseOrder) {
		tiddlerComments = newComment() + &quot;\n&quot; + tiddlerComments;
	} else {
		tiddlerComments += newComment() + &quot;\n&quot;;
	}
	tiddlerComments = &quot;{{comments{\n&quot; + tiddlerComments + &quot;}}}&quot;;
	// re-create tiddler contents
	tiddlerContents = tiddlerContentsPre + tiddlerComments + tiddlerContentsPost;
	// store new tiddler contents
	store.saveTiddler(tiddler.title, tiddler.title, tiddlerContents, tiddler.modifier, tiddler.modified, tiddler.tags); // DEBUG: look up saveTiddler()'s parameters
	story.refreshTiddler(title, 1, true); // DEBUG: look up refreshTiddler()'s parameters
	// DEBUG: save file automatically? (could also be uploaded if the respective plugin is installed)
}

function newComment() {
	// get comment
	var comment = getComment();
	// create comment
	if (comment != null) {
		// get username
		getUserName();
		// get timestamp
		var now = new Date();
		var timestamp = IsoTimestamp(now, true); // use UTC -- DEBUG: use toLocaleString()?; make UTC a macro parameter
		// add timestamp and username
		comment = &quot;{{comment{\n&quot;
			+ &quot;!&quot; + timestamp + &quot;\n&quot;
			+ &quot;!!&quot; + config.options.txtUserName + &quot;\n&quot;
			+ comment + &quot;\n&quot;
			+ &quot;}}}&quot;;
	}
	return comment;
}

function getComment() { // DEBUG: use temporary textarea instead of dialog box?
	var comment = prompt(&quot;Please enter your comment (wiki markup is allowed).&quot;, &quot;&quot;);
	comment = trim(comment);
	if (comment == &quot;&quot;) { // disallow empty comments
		getComment();
	}
	return comment;
}

function getUserName() {
	if (config.options.txtUserName == &quot;&quot; || config.options.txtUserName == null) { // does not accept &quot;Cancel&quot;!
		config.options.txtUserName = prompt(&quot;Please enter your username.&quot;, config.options.txtUserName);
		config.options.txtUserName = trim(config.options.txtUserName);
		getUserName(); // check for empty username
	}
}

function IsoTimestamp(date, UTC) {
	var date = new Date(date)
	if (UTC == true) {
		date = date.getUTCFullYear() + &quot;-&quot;
			+ zeroPad(date.getUTCMonth() + 1, 2) + &quot;-&quot;
			+ zeroPad(date.getUTCDate(), 2) + &quot; &quot;
			+ zeroPad(date.getUTCHours(), 2) + &quot;:&quot;
			+ zeroPad(date.getUTCMinutes(), 2)
			+ &quot; UTC&quot;;
	} else {				
		date = date.getFullYear() + &quot;-&quot;
			+ zeroPad(date.getMonth() + 1, 2) + &quot;-&quot;
			+ zeroPad(date.getDate(), 2) + &quot; &quot;
			+ zeroPad(date.getHours(), 2) + &quot;:&quot;
			+ zeroPad(date.getMinutes(), 2);
	}
	return date;
}

function zeroPad(number, digits) {
	var s = String(number);
	while (s.length &lt; digits)
		s = '0' + s;
	return s;
}

// remove leading whitespaces
function lTrim(str) {
	var RE = /^\s*((\S+\s*)*)$/;
	return str.replace(RE, &quot;$1&quot;);
}

// remove trailing whitespaces
function rTrim(str) {
	var RE = /^((\s*\S+)*)\s*$/;
	return str.replace(RE, &quot;$1&quot;);
}

// remove leading and trailing whitespaces
function trim(str) {
	return lTrim(rTrim(str));
}
//}}}</pre>
</div>
<div title="SimpleCommentsTest" modifier="FND" created="200705071158" modified="200705201531" tags="test tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705201531">
<pre>This is the sandbox for testing the SimpleCommentsPlugin.
Add comments by using the button below.
The styling can be changed in the StyleSheetSimpleComments shadow tiddler.

&lt;&lt;addComment&gt;&gt;
{{comments{
{{comment{
!2007-05-14 15:10 UTC
!!FND
Frist!!111!!!!
}}}
}}}
@@display:block;width:50%;margin:1em auto;border:1px dashed #aaa;padding:0.5em;text-align:center;background-color:#fffff1;Please specify your username:
&lt;&lt;option txtUserName&gt;&gt;
@@</pre>
</div>
<div title="SimpleSearchPlugin" modifier="FND" created="200808191459" modified="201002091750" tags="plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="201002091750">
<pre>/***
|''Name''|SimpleSearchPlugin|
|''Description''|displays search results as a simple list of matching tiddlers|
|''Authors''|FND|
|''Version''|0.4.1|
|''Status''|stable|
|''Source''|http://devpad.tiddlyspot.com/#SimpleSearchPlugin|
|''CodeRepository''|http://svn.tiddlywiki.org/Trunk/contributors/FND/plugins/SimpleSearchPlugin.js|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''Keywords''|search|
!Revision History
!!v0.2.0 (2008-08-18)
* initial release
!!v0.3.0 (2008-08-19)
* added Open All button (renders Classic Search option obsolete)
* sorting by relevance (title matches before content matches)
!!v0.4.0 (2008-08-26)
* added tag matching
!To Do
* tag matching optional
* animations for container creation and removal
* when clicking on search results, do not scroll to the respective tiddler (optional)
* use template for search results
!Code
***/
//{{{
if(!version.extensions.SimpleSearchPlugin) { //# ensure that the plugin is only installed once
version.extensions.SimpleSearchPlugin = { installed: true };

if(!config.extensions) { config.extensions = {}; }

config.extensions.SimpleSearchPlugin = {
	heading: &quot;Search Results&quot;,
	containerId: &quot;searchResults&quot;,
	btnCloseLabel: &quot;close&quot;,
	btnCloseTooltip: &quot;dismiss search results&quot;,
	btnCloseId: &quot;search_close&quot;,
	btnOpenLabel: &quot;Open all&quot;,
	btnOpenTooltip: &quot;open all search results&quot;,
	btnOpenId: &quot;search_open&quot;,

	displayResults: function(matches, query) {
		story.refreshAllTiddlers(true); // update highlighting within story tiddlers
		var el = document.getElementById(this.containerId);
		query = '&quot;&quot;&quot;' + query + '&quot;&quot;&quot;'; // prevent WikiLinks
		if(el) {
			removeChildren(el);
		} else { //# fallback: use displayArea as parent
			var container = document.getElementById(&quot;displayArea&quot;);
			el = document.createElement(&quot;div&quot;);
			el.id = this.containerId;
			el = container.insertBefore(el, container.firstChild);
		}
		var msg = &quot;!&quot; + this.heading + &quot;\n&quot;;
		if(matches.length &gt; 0) {
			msg += &quot;''&quot; + config.macros.search.successMsg.format([matches.length.toString(), query]) + &quot;:''\n&quot;;
			this.results = [];
			for(var i = 0 ; i &lt; matches.length; i++) {
				this.results.push(matches[i].title);
				msg += &quot;* [[&quot; + matches[i].title + &quot;]]\n&quot;;
			}
		} else {
			msg += &quot;''&quot; + config.macros.search.failureMsg.format([query]) + &quot;''&quot;; // XXX: do not use bold here!?
		}
		createTiddlyButton(el, this.btnCloseLabel, this.btnCloseTooltip, config.extensions.SimpleSearchPlugin.closeResults, &quot;button&quot;, this.btnCloseId);
		wikify(msg, el);
		if(matches.length &gt; 0) { // XXX: redundant!?
			createTiddlyButton(el, this.btnOpenLabel, this.btnOpenTooltip, config.extensions.SimpleSearchPlugin.openAll, &quot;button&quot;, this.btnOpenId);
		}
	},

	closeResults: function() {
		var el = document.getElementById(config.extensions.SimpleSearchPlugin.containerId);
		removeNode(el);
		config.extensions.SimpleSearchPlugin.results = null;
		highlightHack = null;
	},

	openAll: function(ev) {
		story.displayTiddlers(null, config.extensions.SimpleSearchPlugin.results);
		return false;
	}
};

config.shadowTiddlers.StyleSheetSimpleSearch = &quot;/*{{{*/\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.containerId + &quot; {\n&quot; +
	&quot;\toverflow: auto;\n&quot; +
	&quot;\tpadding: 5px 1em 10px;\n&quot; +
	&quot;\tbackground-color: [[ColorPalette::TertiaryPale]];\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.containerId + &quot; h1 {\n&quot; +
	&quot;\tmargin-top: 0;\n&quot; +
	&quot;\tborder: none;\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.containerId + &quot; ul {\n&quot; +
	&quot;\tmargin: 0.5em;\n&quot; +
	&quot;\tpadding-left: 1.5em;\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.containerId + &quot; .button {\n&quot; +
	&quot;\tdisplay: block;\n&quot; +
	&quot;\tborder-color: [[ColorPalette::TertiaryDark]];\n&quot; +
	&quot;\tpadding: 5px;\n&quot; +
	&quot;\tbackground-color: [[ColorPalette::TertiaryLight]];\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.containerId + &quot; .button:hover {\n&quot; +
	&quot;\tborder-color: [[ColorPalette::SecondaryMid]];\n&quot; +
	&quot;\tbackground-color: [[ColorPalette::SecondaryLight]];\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.btnCloseId + &quot; {\n&quot; +
	&quot;\tfloat: right;\n&quot; +
	&quot;\tmargin: -5px -1em 5px 5px;\n&quot; +
	&quot;}\n\n&quot; +
	&quot;#&quot; + config.extensions.SimpleSearchPlugin.btnOpenId + &quot; {\n&quot; +
	&quot;\tfloat: left;\n&quot; +
	&quot;\tmargin-top: 5px;\n&quot; +
	&quot;}\n&quot; +
	&quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetSimpleSearch&quot;, refreshStyles);

// override Story.search()
Story.prototype.search = function(text, useCaseSensitive, useRegExp) {
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(), useCaseSensitive ? &quot;mg&quot; : &quot;img&quot;);
	var matches = store.search(highlightHack, null, &quot;excludeSearch&quot;);
	var q = useRegExp ? &quot;/&quot; : &quot;'&quot;;
	config.extensions.SimpleSearchPlugin.displayResults(matches, q + text + q);
};

// override TiddlyWiki.search() to sort by relevance
TiddlyWiki.prototype.search = function(searchRegExp, sortField, excludeTag, match) {
	var candidates = this.reverseLookup(&quot;tags&quot;, excludeTag, !!match);
	var primary = [];
	var secondary = [];
	var tertiary = [];
	for(var t = 0; t &lt; candidates.length; t++) {
		if(candidates[t].title.search(searchRegExp) != -1) {
			primary.push(candidates[t]);
		} else if(candidates[t].tags.join(&quot; &quot;).search(searchRegExp) != -1) {
			secondary.push(candidates[t]);
		} else if(candidates[t].text.search(searchRegExp) != -1) {
			tertiary.push(candidates[t]);
		}
	}
	var results = primary.concat(secondary).concat(tertiary);
	if(sortField) {
		results.sort(function(a, b) {
			return a[sortField] &lt; b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);
		});
	}
	return results;
};

} //# end of &quot;install only once&quot;
//}}}</pre>
</div>
<div title="SubTiddlers Concept" modifier="FND" created="200706101837" modified="200706121249" tags="concept tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706121249">
<pre>* TiddlyWiki equivalent of MediaWiki's subpages
* sub-tiddlers' names are preceded by the parent tiddler's name and a separator (e.g. &quot;parent/sub&quot;)
* the parent tiddler contains an automatically-created index of all sub-tiddlers (like a table of contents, or like a horizontal menu bar)
* sub-tiddlers contain a &quot;breadcrumb&quot; link back to the parent tiddler(s)
* multiple sub-levels?
* all tiddlers optionally contain a button to create a sub-tiddler
----
related examples / alternatives:
* [[PartTiddlerPlugin|http://tiddlywiki.abego-software.de/#PartTiddlerPlugin]]
* tiddler fields: [[ListboxPlugin|http://www.tiddlytools.com/#ListboxPlugin]], [[TaskViewTemplate|http://www.tiddlytools.com/#TaskViewTemplate]] / [[TaskTemplateTweak|http://www.tiddlytools.com/#TaskTemplateTweak]]
* [[easySlicer|http://yann.perrin.googlepages.com/twkd.html#easySlicer]] (might even render this project obsolete)</pre>
</div>
<div title="SuppressEmptyTagsPlugin" modifier="FND" created="200706111418" modified="200709180501" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709180501">
<pre>/***
|Name|SuppressEmptyTagsPlugin|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#SuppressEmptyTagsPlugin]]|
|Version|1.1|
|Author|FND|
|Contributors|[[Saq Imtiaz|http://tw.lewcid.org]], [[Eric Shulman|http://www.tiddlytools.com]]|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|config.macros.tags.handler|
|Description|suppress tagged box when tiddler is untagged|
!Changelog
!!v0.5 (2007-06-11)
* initial release
!!v1.0 (2007-06-11)
* proper overriding of core function (thanks Saq)
* changed ~CoreVersion to 2.1 (from 2.2)
!!v1.1 (2007-06-11)
* further improved hijacking method (thanks Eric)
!Code
***/
//{{{
config.macros.tags.oldHandler = config.macros.tags.handler;
config.macros.tags.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(tiddler.tags &amp;&amp; tiddler.tags.length &gt; 0)
		this.oldHandler.apply(this, arguments);
	else
		place.style.display = 'none';
};
//}}}</pre>
</div>
<div title="TableHighlightMacro" modifier="FND" created="200708160924" modified="200708180706" tags="plugin macro systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708180706">
<pre>/***
|''Name''|TableHighlightMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TableHighlightMacro]]|
|''Version''|0.3|
|''Author''|FND|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|macro for highlighting elements on mouse-over (hover)|
!Usage Notes
* two options:
** add {{{&lt;&lt;tableHighlight [class tag]&gt;&gt;}}} to the desired tiddler(s)
** add as a macro to ViewTemplate: {{{&lt;span macro='tableHighlight [class tag]'&gt;&lt;/span&gt;}}}
!!Example
highlight table rows (using footer class for compatibility reasons): {{{&lt;&lt;tableHighlight &quot;footer&quot; &quot;tr&quot;&gt;&gt;}}} &lt;&lt;tableHighlight &quot;footer&quot; &quot;tr&quot;&gt;&gt;
!Revision History
!!v0.1 (2007-08-16)
* initial proof-of-concept implementation
!!v0.2 (2007-08-16)
* added shadow tiddler for styles
!!v0.3 (2007-08-16)
* added optional parameters for class name and target element
* replaced minimal shadow tiddler with {{{setStylesheet()}}} call
* greatly improved code efficiency (thanks Lewcid)
!To Do
* rename plugin (e.g. ElementHoverHighlightMacro?) =&gt; also rename dependencies (macro name, default class and style sheet)
* adjust Description and Usage Notes
!Code
***/
//{{{
config.macros.tableHighlight = {}
config.macros.tableHighlight.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	// process parameters
	var highlightClass = (params[0] &amp;&amp; params[0] != &quot;&quot;) ? params[0] : &quot;tableHighlightActive&quot;;
	var targetElement = (params[1] &amp;&amp; params[1] != &quot;&quot;) ? params[1] : &quot;td&quot;;
	// highlight elements
	var cells = story.findContainingTiddler(place).getElementsByTagName(targetElement);
	for(var i = 0; i &lt; cells.length; i++) {
		cells[i].onmouseover = function() { addClass(this, highlightClass); };
		cells[i].onmouseout = function() { removeClass(this, highlightClass); };
	}
}

// set default styles
setStylesheet(&quot;.tableHighlightActive { &quot;
	+ &quot;background-color: &quot; + store.getTiddlerSlice(&quot;ColorPalette&quot;, &quot;SecondaryPale&quot;) + &quot;;&quot;
	+ &quot; }&quot;,
	+ &quot;StyleSheetTableHighlight&quot;);
//}}}</pre>
</div>
<div title="TableSlicesPlugin" modifier="FND" created="200709062034" modified="200709091546" tags="plugin concept" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709091546">
<pre>easy interface for records on DataVault

cf. [[SliceGridPlugin|http://www.tiddlytools.com/#SliceGridPlugin]]</pre>
</div>
<div title="TableToTiddlersMacro" modifier="FND" created="200801101741" modified="200801101805" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200801101805">
<pre>/***
|''Name''|TableToTiddlersMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TableToTiddlersMacro]]|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|FND|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|generates individual tiddlers from a table|
!Notes
* one tiddler per row (tiddler name is value of first column)
* transposing; one row in each tiddler per column (excluding first column) in the source data
!Usage
{{{
&lt;&lt;table2tiddlers [tiddler] [tags] [header] [footer] [author] [prefixes] [suffixes]&gt;&gt;
}}}
!!Parameters
|!Index|!Optional|!Description|!Default Value|h
|1|yes|name of target tiddler (containing the table to be processed)|current tiddler|
|2|yes|tags to assign to newly-created tiddlers|slices2tiddlers|
|3|yes|author to assign to newly-created tiddlers|slices2tiddlers|
|4|yes|table includes header row (true/false)|false|
|5|yes|table includes footer row (true/false)|false|
|6|yes|bracketed list of prefixes to assign to newly-created tiddlers' rows (one item per row)|N/A|
|7|yes|bracketed list of suffixes to assign to newly-created tiddler's rows (one item per row)|N/A|
!!Example
{{{
&lt;&lt;table2tiddlers [[Log Data]] &quot;logs&quot; &quot;admin&quot; &quot;true&quot; &quot;true&quot; &quot;|!Time| |!User| [[|!Avg. Value|]] |!Signature|&quot; &quot;|h | | |f&quot;&gt;&gt;
}}}
This will generate a table of three rows (&quot;Time&quot;, &quot;User&quot;, &quot;Avg. Value&quot;) in each newly-created tiddler, provided that there are a total of four columns in the source data.
!Revision History
!!v0.1 (2008-01-10)
* initial release
!To Do
* use launch button instead of executing the macro when rendered
* instead of suffix and prefix arrays as parameters, use one parameter (prefix-suffix pair) for each row
* documentation
!Code
***/
//{{{
config.macros.table2tiddlers = {
	tags: [&quot;slices2tiddlers&quot;],
	modifier: &quot;slices2tiddlers&quot;
};

config.macros.table2tiddlers.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var tiddlerTitle = params[0] || tiddler.title;
	var tags = params[1] ? params[1].readBracketedList() : this.tags;
	var modifier = params[2] || this.modifier;
	var header = (params[3] == &quot;true&quot;) ? true : false; // table includes header row
	var footer = (params[4] == &quot;true&quot;) ? true : false; // table includes footer row
	var prefixes = params[5] ? params[5].readBracketedList(false) : [];
	var suffixes = params[6] ? params[6].readBracketedList(false) : [];
	var tiddlers = [];
	var errors = [];
	// retrieve individual rows
	var rows = store.getTiddlerText(tiddlerTitle);
	if(rows)
		rows = rows.split(&quot;\n&quot;);
	else
		wikify(&quot;error: tiddler not found&quot;, place);
	// create tiddlers from rows
	if(rows &amp;&amp; rows.length &gt; 0) {
		// remove table header and footer
		if(header)
			rows.splice(0, 1);
		if(footer)
			rows.splice(rows.length - 1, 1);
		// create tiddlers
		var cols, title, text;
		for(var i = 0; i &lt; rows.length; i++) {
			// retrieve columns
			cols = rows[i].split(&quot;|&quot;);
			cols.splice(0, 1); // remove first element (always empty)
			cols.splice(cols.length - 1, 1); // remove last element (always empty)
			// create new tiddler
			title = cols[0];
			text = &quot;&quot;;
			for(var j = 1; j &lt; cols.length; j++) {
				text += (prefixes[j - 1] || &quot;&quot;)
					+ cols[j]
					+ (suffixes[j - 1] || &quot;&quot;)
					+ &quot;\n&quot;;
			}
			if(!store.tiddlerExists(title)) { // do not overwrite local tiddlers
				store.saveTiddler(title, title, text, modifier, (new Date), tags, null, null, (new Date));
				tiddlers.push(title);
			} else {
				errors.push(title);
			}
		}
		// report results
		var output = &quot;&quot;;
		if(errors.length &gt; 0) {
			output += &quot;!Tiddlers Not Created (&quot; + errors.length + &quot;)\n&quot;;
			for(i = 0; i &lt; errors.length; i++)
				output += &quot;* [[&quot; + errors[i] + &quot;]]\n&quot;;
		}
		if(tiddlers.length &gt; 0) {
			output += &quot;!Tiddlers Created (&quot; + tiddlers.length + &quot;)\n&quot;;
			for(i = 0; i &lt; tiddlers.length; i++)
				output += &quot;* [[&quot; + tiddlers[i] + &quot;]]\n&quot;;
		}
		wikify(output, place);
	}
};
//}}}</pre>
</div>
<div title="TagBoxToggleMacro" modifier="FND" created="200712201929" modified="200712201934" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200712201934">
<pre>/***
|''Name''|TagBoxToggleMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TagBoxToggleMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Description''|toggles the visibility of the respective tiddler's tag box|
!Usage
{{{
&lt;&lt;taggedToggle
	[class name]
	[button label]
	[button tooltip]
	[button class]
	[button access key]
	[startup mode]
&gt;&gt;
}}}
!!Example
&lt;&lt;taggedToggle &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;hide&quot;&gt;&gt;
!Revision History
!!v0.1 (2007-12-20)
* initial release
!To Do
* documentation
!Code
***/
//{{{
config.macros.taggedToggle = {
	className: &quot;tagged&quot;,
	label: &quot;Toggle Tagged&quot;,
	prompt: &quot;Switch tag box on and off&quot;,
	buttonClass: &quot;&quot;,
	accessKey: &quot;&quot;
};

config.macros.taggedToggle.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	// process command line parameters
	var className = params[0] || this.className;
	var label = params[1] || this.label;
	var prompt = params[2] || this.prompt;
	var buttonClass = params[3] || this.buttonClass;
	var accessKey = params[4] || this.accessKey;
	// startup mode
	var t = story.findContainingTiddler(place);
	if(params[5] == &quot;hide&quot;) {
		this.toggle(t, className);
	}
	// create toggle button
	createTiddlyButton(place, label, prompt,
		function() { config.macros.taggedToggle.toggle(t, className); },
		buttonClass, null, accessKey);
};

config.macros.taggedToggle.toggle = function(el, className) {
	if(el) {
		els = getElementsByClass(className, el);
		if(els[0].style.display != &quot;none&quot;) {
			els[0].style.display = &quot;none&quot;;
		} else {
			els[0].style.display = &quot;&quot;;
		}
	}
};

/* by Dustin Diaz (http://www.dustindiaz.com/getelementsbyclass/) */
function getElementsByClass(searchClass,node,tag) {
	var classElements = new Array();
	if ( node == null )
		node = document;
	if ( tag == null )
		tag = '*';
	var els = node.getElementsByTagName(tag);
	var elsLen = els.length;
	var pattern = new RegExp(&quot;(^|\\\\s)&quot;+searchClass+&quot;(\\\\s|$)&quot;);
	for (i = 0, j = 0; i &lt; elsLen; i++) {
		if ( pattern.test(els[i].className) ) {
			classElements[j] = els[i];
			j++;
		}
	}
	return classElements;
}
//}}}</pre>
</div>
<div title="TagComboMacro" modifier="FND" created="200711301620" modified="200711301625" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711301625">
<pre>/***
|''Name''|TagComboMacro|
|''Version''|0.1|
|''Status''|@@experimental@@|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TagComboMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|returns a list of tiddlers matching a combination of tags|
!Usage
{{{
&lt;&lt;tagcombo [tag1] [tag2] [tag3] ... &gt;&gt;
}}}
!!Example
&lt;&lt;tagcombo [[systemConfig]] [[plugins]]&gt;&gt;
!Revision History
!!v0.1 (2007-11-30)
* initial release
!To Do
* rename
* remove excessive spacing (i.e. replace {{{.join()}}} with {{{for()}}} loop!?)
* custom output format (e.g. comma-separated list)
!Code
***/
//{{{
config.macros.tagcombo = {};
config.macros.tagcombo.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var r = [];
	var t = store.getTaggedTiddlers(params[0]);
	for(var i = 0; i &lt; t.length; i++) {
		if(t[i].tags.containsAll(params)) {
			r.push(t[i].title);
		}
	}
	wikify(&quot;* [[&quot; + r.join(&quot;]]\n* [[&quot;) + &quot;]]&quot;, place);
}
//}}}</pre>
</div>
<div title="TagNavigator Concept" modifier="FND" created="200705211838" modified="200705291238" tags="concept tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705291238">
<pre>(preliminary implementation at [[ForEachTiddlerTest]])
!Name
* TagNavigatorPlugin
* DynamicTagTreePlugin (or TagTreePlugin)
* TagComboPlugin
!User Interface
{{{
 __________________________________
|                _______    _____  |
| Tag 1  Tag 2  | Tag 3 |  | add | |
|                Â¯Â¯Â¯Â¯Â¯Â¯Â¯    +------------+
|Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯|* [[Tag 4]] |
| * [[Tiddler 1]]           |* [[Tag 5]] |
| * [[Tiddler 2]]           |* [[Tag 6]] |
| * [[Tiddler 3]]           +------------+
| * [[Tiddler 4]]                  |
| * [[Tiddler 5]]                  |
| * [[Tiddler 6]]                  |
|__________________________________|
}}}
* upper part: tag (de)selection
** &quot;Tag 3&quot; removes this tag from the combination
** &quot;add&quot; expands a list of available tags (tags 4-6) to add to the combination (listed are only tags used in combination with the previously-selected tags)
* lower part: tiddler selection (list of tiddlers using the selected tags)
!Flowchart 
{{{
	+---------------------+
	| select all tiddlers |                store
	+---------------------+
	        |
	        V
	/Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯\
	| list of matching tiddlers |&lt;----+    story object
	\___________________________/     |
	        |                         |
	        V                         |
	+-----------------------------+   |
	| retrieve tags from tiddlers |   |    using getTags(), or forEachTiddler() and .tags property
	+-----------------------------+   |
	        |                         |
	        V                         |
	+----------------------+          |
	| filter and sort tags |          |    using pushUnique() or readBracketedList() -- possibly obsolete (see above)
	+----------------------+          |
	        |                         |
	        V                         |
	/Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯\           |
	| list of unique tags |           |
	\_____________________/           |
	        |                         |
	        V                         |
	  /Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯/                  |
	 / select tag /                   |    == BREAK POINT ==
	/____________/                    |
	        |                         |
	        V                         |
	+--------------------------+      |
	| select matching tiddlers |      |    using getTaggedTiddlers() -- problem (now obsolete?): how to return a story object?
	+--------------------------+      |
	        |                         |
	        V                         |
	+-------------------------+       |
	| retrieve tiddler titles |-------+    using forEachTiddler() and .title property
	+-------------------------+
	


	Key:
	Â¯Â¯Â¯Â¯
	+---------+    /Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯\      /Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯Â¯/
	| Process |    | Result |     / Interaction /
	+---------+    \________/    /_____________/
}}}</pre>
</div>
<div title="TagNavigatorPlugin" modifier="FND" created="200705181044" modified="200709091547" tags="plugin systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200709091547">
<pre>/***
|Name|TagNavigatorPlugin (working title)|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#TagNavigatorPlugin]]|
|Version|0.1|
|Author|FND|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|select tiddlers based on tag combinations|
!Usage
{{{&lt;&lt;TagNav tag1 tag2 tag3 ... &gt;&gt;}}}
''N.B.:'' Tags containing spaces must be enclosed either in {{{[[brackets]]}}} or in {{{&quot;quotation marks&quot;}}}.
!Revision History
!!v0.1 (2007-06-08)
* initial alpha version
!Issues / To Do
* many, many issues; cf. DEBUG markers in code
* popup menu can't be closed yet (can even be opened multiple times!)
* displayed  the count of the number of matching tiddlers
!Code
***/
//{{{
// create TagNavigator namespace
TagNav = {};

// create shadow tiddler for CSS rules
TagNav.addStyles = function(shadowTiddler) {
	config.shadowTiddlers[shadowTiddler] = &quot;/*{{{*/\n&quot;
		+ &quot;#TagNavigator {\n&quot;
		+ &quot;\tposition: absolute;\n&quot; // DEBUG: messy display (overlay issues)
		+ &quot;\tz-index: 99;\n&quot;
		+ &quot;\tmargin: 0;\n&quot;
		+ &quot;\tborder: 1px solid [[ColorPalette::PrimaryDark]];\n&quot;
		+ &quot;\tpadding: 0;\n&quot;
		+ &quot;\tbackground-color: [[ColorPalette::TertiaryPale]];\n&quot;
		+ &quot;}\n\n&quot;
		+ &quot;#TagNavigatorTagBar,\n&quot;
		+ &quot;#TagNavigatorTiddlers {\n&quot;
		+ &quot;\tmargin: 0;\n&quot;
		+ &quot;\tpadding: 5px;\n&quot;
		+ &quot;\tlist-style-type: none;\n&quot;
		+ &quot;}\n\n&quot;
		+ &quot;#TagNavigatorTagBar {\n&quot;
		+ &quot;\tmargin-bottom: 1.2em;\n&quot; // required due to floating
		+ &quot;}\n\n&quot;
		+ &quot;#TagNavigatorTiddlers {\n&quot;
		+ &quot;\tclear: both;\n&quot;
		+ &quot;\tborder-top: 1px solid [[ColorPalette::PrimaryDark]];\n&quot;
		+ &quot;}\n\n&quot;
		+ &quot;#TagNavigatorTagBar li {\n&quot;
		+ &quot;\tfloat: left;\n&quot;
		+ &quot;\tmargin: 0 0.2em 0.5em;\n&quot;
		+ &quot;}\n\n&quot;
		+ &quot;#TagNavigator .buttonClose {\n&quot;
		+ &quot;\tfloat: left;\n&quot; // DEBUG: temporary solution (right-floating expands container width)
		+ &quot;\tmargin: 0 5px 5px 0;\n&quot;
		+ &quot;\tborder: 1px solid [[ColorPalette::PrimaryDark]];\n&quot;
		+ &quot;\tpadding: 0 1px;\n&quot;
		+ &quot;}\n&quot;
		+ &quot;/*}}}*/&quot;;
	store.addNotification(shadowTiddler, refreshStyles);
}
TagNav.addStyles(&quot;StyleSheetTagNavigator&quot;);

/*
** Macro
*/

config.macros.TagNav = {
	label: &quot;Tag Navigator&quot;,
	prompt: &quot;select tiddlers based on tag combinations&quot;,
	accessKey: null
};

config.macros.TagNav.handler =
	function(place, macroName, params, wikifier, paramString, tiddler) {
		// create macro button
		createTiddlyButton(place, this.label, this.prompt,
			function() {
				// select active button
				TagNav.Btn = this;
				// close (remove) existing popups
				TagNav.popupClose(TagNav.Container, TagNav.active);
				// set activity status				
				TagNav.active = true;
				// process macro parameters (initial tags)
				TagNav.activeTags = [];
				if(params[0]) {
					for(var i = 0; i &lt; params.length; i++) {
						TagNav.activeTags.pushUnique(params[i], true);
					}
				}
				// initialize
				TagNav.initializeTiddlerSelection();
				TagNav.initializeInterface();
				return false; // DEBUG: purpose? obsolete?
			},
			null, null, this.accessKey);
		return false; // DEBUG: purpose? obsolete?
}

/*
** Initialization
*/

// initialize tiddler selection
TagNav.initializeTiddlerSelection = function() {
	// get all tiddlers
	TagNav.tiddlers = store.reverseLookup(&quot;tags&quot;, &quot;&quot;, false, &quot;title&quot;); // DEBUG: dirty hack!?
	// get tiddler titles
	TagNav.titles = TagNav.getTiddlerTitles(TagNav.tiddlers);
	// get tiddler tags
	TagNav.tags = TagNav.getTiddlerTags(TagNav.tiddlers);
	// process initial tags
	if(TagNav.activeTags.length &gt; 0) {
		for(var i = 0; i &lt; TagNav.activeTags.length; i++) {
			// update matching tiddler set
			TagNav.filter(TagNav.activeTags[i])
		}
	} 
}

// initialize Tag Navigator interface
TagNav.initializeInterface = function() {
	// create container elements
	TagNav.Container = createTiddlyElement(document.body, &quot;div&quot;, &quot;TagNavigator&quot;, null, null); // DEBUG: using document.body as parent only sub-optimal?	 
	btn = createTiddlyButton(TagNav.Container, &quot;x&quot;, &quot;close Tag Navigator popup&quot;, TagNav.popupClose, &quot;buttonClose&quot;, null, null); // close button
	TagNav.TagBar = createTiddlyElement(TagNav.Container, &quot;ul&quot;, &quot;TagNavigatorTagBar&quot;, null, null);
	TagNav.TiddlerBox = createTiddlyElement(TagNav.Container, &quot;ul&quot;, &quot;TagNavigatorTiddlers&quot;, null, null);
	// adjust Tag Navigator popup position
	TagNav.popupPosition(TagNav.Btn, TagNav.Container);
	 // add previously-selected filter tags to tag bar
	var item, btn;
	for(var i = 0; i &lt; TagNav.activeTags.length; i++) {
		item = createTiddlyElement(TagNav.TagBar, &quot;li&quot;, null, null, null);
		btn = createTiddlyButton(item, TagNav.activeTags[i], null, null, &quot;buttonBland&quot;, null, null); // DEBUG: buttonBland class not styled yet
	}
	 // add button for new filter tag to tag bar
	item = createTiddlyElement(TagNav.TagBar, &quot;li&quot;, null, null, null);
	btn = createTiddlyButton(item, &quot;+&quot;, &quot;add a tag to filter by&quot;, TagNav.tagSelection, null, null, null);
	// fill in contents of tiddler
	TagNav.listTiddlerTitles(TagNav.TiddlerBox, TagNav.titles);	
}

/*
** Interface
*/

// event click on tiddler button: open tiddler and close popups
TagNav.tiddlerSelection = function(e) {
	var theTarget = resolveTarget(e);
	// close popup
	TagNav.popupClose();
	// open tiddler
	var title = theTarget.getAttribute(&quot;tiddler&quot;);
	story.displayTiddler(null, title); // DEBUG: temporary workaround (see below)
	//onClickTiddlerLink(e); // DEBUG: causes error &quot;theLink.getAttribute is not a function&quot;
}

// event click on tag button: add new filtering level
TagNav.tagSelection = function(e) {
	//TagNav.listTiddlerTags(TagNav.TagBar, TagNav.tags); // DEBUG'd: continue here
	/* DEBUG'd
	var theTarget = resolveTarget(e);
	var tag = theTarget.getAttribute(&quot;tag&quot;);
	if(tag) {
		// update matching tiddler set
		TagNav.filter(tag);
		// create sub-menu -- DEBUG: buggy/incomplete (e.g. how to close popups)
		TagNav.subMenus.push(Popup.create(theTarget));
		var TagNavigator = createTiddlyElement(theTarget, &quot;ul&quot;, &quot;TagNavigator&quot;, null, null);
		TagNav.listTiddlers(TagNavigator, TagNav.titles);
		TagNav.listTags(TagNavigator, TagNav.tags);
		Popup.show(TagNavigator, false);
	}
	*/
}

// adjust Tag Navigator popup position -- based upon Popup.show()
TagNav.popupPosition = function(parent, popup) {
	var rootLeft = findPosX(parent);
	var rootTop = findPosY(parent);
	var rootHeight = parent.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;
	var popupWidth = popup.offsetWidth;
	var winWidth = findWindowWidth();
	if(popupLeft + popupWidth &gt; winWidth)
		popupLeft = winWidth - popupWidth;
	popup.style.left = popupLeft + &quot;px&quot;;
	popup.style.top = popupTop + &quot;px&quot;;
	popup.style.display = &quot;block&quot;;
	if(anim &amp;&amp; config.options.chkAnimate)
		anim.startAnimating(new Scroller(popup, false));
	else
		window.scrollTo(0,ensureVisible(popup));
}

// close (remove) existing popup
TagNav.popupClose = function(popup, check) {
	if(check) {
		popup.parentNode.removeChild(popup);
	}
	check = false;
}

/*
** Tiddler Processing
*/

// retrieve tiddlers with a specific tag from tiddlers array
TagNav.getTaggedTiddlers = function(container, tag) {
	var tiddlers = [];
	for(var i = 0; i &lt; container.length; i++) {
		if(container[i].tags.contains(tag)) {
			tiddlers.push(container[i]);
		}
	}
	return tiddlers;
}

// retrieve titles from tiddlers array
TagNav.getTiddlerTitles = function(container) {
	var titles = [];
	for(var i = 0; i &lt; container.length; i++) {
		titles.push(container[i].title);
	}
	titles.sort();
	return titles;
}

// retrieve tags from tiddlers array
TagNav.getTiddlerTags = function(tiddlers) {
	var tags = [];
	for(var i = 0; i &lt; tiddlers.length; i++) {
		for(var j = 0; j &lt; tiddlers[i].tags.length; j++) {
			tags.pushUnique(tiddlers[i].tags[j]);
		}
	}
	tags.sort();
	return tags;
}

// update matching tiddler set
TagNav.filter = function(tag) {
	TagNav.tiddlers = TagNav.getTaggedTiddlers(TagNav.tiddlers, tag);
	TagNav.titles = TagNav.getTiddlerTitles(TagNav.tiddlers);
	TagNav.tags = TagNav.getTiddlerTags(TagNav.tiddlers);
}

// create list of tiddlers as links
TagNav.listTiddlerTitles = function(parent, titles) {
	var item, btn;
	if(titles.length == 0) {
		createTiddlyElement(parent, &quot;span&quot;, null, null, &quot;no matching tiddlers&quot;);
	}
	for(var i = 0; i &lt; titles.length; i++) {
		item = createTiddlyElement(parent, &quot;li&quot;, null, null, null);
		btn = createTiddlyButton(item, titles[i], &quot;open tiddler&quot;, TagNav.tiddlerSelection, &quot;tiddlyLink tiddlyLinkExisting&quot;);
		btn.setAttribute(&quot;tiddler&quot;, titles[i]);
	}
}

// create list of tags as links -- DEBUG: revise titles and prompts
TagNav.listTiddlerTags = function(parent, tags) {
	var item, btn;
	if(tags.length == 0) {
		createTiddlyElement(parent, &quot;li&quot;, null, null, &quot;no matching tags&quot;);
	}
	for(var i = 0; i &lt; tags.length; i++) {
		item = createTiddlyElement(parent, &quot;li&quot;, null, null, null);
		btn = createTiddlyButton(item, tags[i], &quot;filter using this tag&quot;, TagNav.tagSelection);
		btn.setAttribute(&quot;tag&quot;, tags[i]);
	}
}
//}}}</pre>
</div>
<div title="TagNavigatorTest" modifier="FND" created="200706071630" modified="200706081727" tags="test tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706081727">
<pre>This is the sandbox for testing the TagNavigatorPlugin.
Activate the Tag Navigator by using the button below.
The styling can be changed in the StyleSheetTagNavigator shadow tiddler.

|&lt;&lt;TagNav&gt;&gt;&lt;br&gt;(no initial tags)|&lt;&lt;TagNav systemConfig&gt;&gt;&lt;br&gt;(inital tag &quot;systemConfig&quot;)|&lt;&lt;TagNav systemConfig plugin&gt;&gt;&lt;br&gt;(inital tags &quot;systemConfig&quot; and &quot;plugin&quot;)|</pre>
</div>
<div title="TaggedBackupsPlugin" modifier="FND" created="200708160925" modified="200708160925" tags="plugin macro systemConfig systemConfigDisable" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200708160925">
<pre>/***
|''Name''|TaggedBackupsPlugin|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TableHighlightMacro]]|
|''Version''|0.1|
|''Author''|FND|
|''License''|[[Creative Commons Attribution-Share Alike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|allows the creation of backup files with an edit summary|
!Usage Notes
&lt;&lt;taggedBackup&gt;&gt;
!Revision History
!!v0.1 (2007-08-11)
* initial proof-of-concept implementation
!To Do
* rename plugin(?)
* ensure that full backup path does not exceed OS limits (256 chars?)
!Code
***/
//{{{
config.macros.taggedBackup = {}
config.macros.taggedBackup.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var originalPath = document.location.toString();
	var localPath = getLocalPath(originalPath);
	var original = loadFile(localPath);
	var backupPath = getBackupPath(localPath);
	alert(originalPath + &quot;\n&quot; + localPath + &quot;\n&quot; + backupPath) // DEBUG
	// insert edit summary (&quot;tag&quot;)
	var backupFileName = backupPath.substring(0, backupPath.lastIndexOf(&quot;.&quot;));
	var backupFileExt = backupPath.substring(backupPath.lastIndexOf(&quot;.&quot;));
	//prompt(&quot;Please enter a concise edit summary&quot;); // DEBUG'd
	alert(backupPath) // DEBUG
	//var backup = saveFile(backupPath, original); // DEBUG'd
	if(backup)
		displayMessage(config.messages.backupSaved, &quot;file://&quot; + backupPath);
	else
		alert(config.messages.backupFailed);
}

// getBackupPath() -- DEBUG: needs to be hijacked/overwritten
function getBackupPath(localPath)
{
	var backSlash = true;
	var dirPathPos = localPath.lastIndexOf(&quot;\\&quot;);
	if(dirPathPos == -1)
		{
		dirPathPos = localPath.lastIndexOf(&quot;/&quot;);
		backSlash = false;
		}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == &quot;&quot;)
		backupFolder = &quot;.&quot;;
	var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? &quot;\\&quot; : &quot;/&quot;) + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(&quot;.&quot;)) + &quot;.&quot; + (new Date()).convertToYYYYMMDDHHMMSSMMM() + &quot;.html&quot;; // DEBUG: replace YYYYMMDDHHMMSSMMM with ISO 8601 and add edit summary
	return backupPath;
}
//}}}</pre>
</div>
<div title="TemplateColorPaletteView" modifier="FND" created="200711172341" modified="200711172346" tags="templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711172346">
<pre>&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','Background')}} Background $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','Foreground')}} Foreground $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','PrimaryPale')}} PrimaryPale $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','PrimaryLight')}} PrimaryLight $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','PrimaryMid')}} PrimaryMid $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','PrimaryDark')}} PrimaryDark $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','SecondaryPale')}} SecondaryPale $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','SecondaryLight')}} SecondaryLight $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','SecondaryMid')}} SecondaryMid $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','SecondaryDark')}} SecondaryDark $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','TertiaryPale')}} TertiaryPale $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','TertiaryLight')}} TertiaryLight $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','TertiaryMid')}} TertiaryMid $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','TertiaryDark')}} TertiaryDark $1&gt;&gt;
&lt;&lt;tiddler [[TemplateShowColor]] with:{{store.getTiddlerSlice('$1','Error')}} Error $1&gt;&gt;</pre>
</div>
<div title="TemplateShowColor" modifier="FND" created="200711172338" modified="200711172346" tags="templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711172346">
<pre>@@margin:0 1em;padding:0 4em;background-color:$1;&amp;nbsp;@@ @@padding-right:1em;{{{$1}}}@@ [[$2|$3]]</pre>
</div>
<div title="TemplateShowColor (obsolete)" modifier="FND" created="200706131356" modified="200711172340" tags="templates" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711172340">
<pre>@@margin: 0 1em;padding: 0 4em;width: 20em;background-color: $1;&amp;nbsp;@@ [[$2|ColorPalette]]</pre>
</div>
<div title="TidIDEPlugin" modifier="FND" created="200705230609" modified="200705230609" tags="plugin systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705230609">
<pre>/***
|Name|TidIDEPlugin|
|Source|http://www.TiddlyTools.com/#TidIDEPlugin|
|Version|1.6.1|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;&lt;br&gt;&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides||
|Description|TiddlyWiki Integrated Development Environment - tools for authors and plugin writers|

~TidIDE (//prounounced &quot;Tie Dyed&quot;//) - ''Tid''dlyWiki ''I''ntegrated ''D''evelopment ''E''nvironment - tools for ~TiddlyWiki authors and editors.  

Provides a full-featured tiddler editor with key-by-key ''LIVE PREVIEW'' of //formatted// tiddler content!!  Also includes diagnostic tools to help you debug your TiddlyWiki problems by letting you view current TiddlyWiki internal option values, messages, shadows, stylesheets, notify and macro functions or display the internal DOM (Document Object Model) tree structure for any specific part of the TiddlyWiki document.
!!!!!Configuration
&lt;&lt;&lt;
Automatically freeze preview updates when a tiddler takes more than &lt;&lt;option txtTidIDEAutoFreeze&gt;&gt; milliseconds to render.
&lt;&lt;&lt;
!!!!!Usage/Example
&lt;&lt;&lt;
{{{&lt;&lt;tidIDE id:example &quot;font:Courier New&quot; size:8pt system +edit:GettingStarted&gt;&gt;}}}
&lt;&lt;tidIDE id:example &quot;font:Courier New&quot; size:8pt system +edit:GettingStarted&gt;&gt;
!!!!!parameters:
* ''id'' - assign a unique ID to this instance of TidIDE.  (default id=current tiddler title or &quot;&quot; if not in a tiddler)
* ''font'' - sets the CSS font-family used by textarea controls in editor and system information panels.  Note: if the font name includes a space (e.g., Courier New), then you must enclose the entire parameter in double-quotes: {{{&quot;font:Courier New&quot;}}}.
* ''size'' - sets the CSS font-size used by text input and droplist controls in editor and system information panels.
* ''system'' includes system information panel.
* ''edit'' includes tiddler editor/previewer.
**''edit:here'' automatically sets the editor to show the current tiddler contents (if in a tiddler)
**''edit:tiddlertitle'' automatically sets the editor to show the specified tiddler contents
* use ''{{{[[label|tiddlertitle]]}}}'' to include 'custom panels' (and corresponding labelled checkboxes to toggle their display)
* all parameters are optional.  The default panel is &quot;edit:here&quot;.
* panel parameters preceded by a &quot;+&quot; are displayed by default.  If only one panel specified in the parameters, it is automatically displayed, even if the &quot;+&quot; is omitted.
!!!!!using the editor
The editor includes a droplist of all tiddlers in the document, sorted alpha-numerically by tiddler title.  Shadow tiddlers that have not been customized are added to the end of this list and marked with &quot;(shadow)&quot;.  Next to the droplist are several buttons:
* ''view'' opens the tiddler in the normal ~TiddlyWiki display area
* ''add'' prompts for a new tiddler title and begins a new editing session
* ''remove'' deletes an existing tiddler (note: shadow tiddlers cannot be removed)
* ''save'' saves changes to the tiddler currently being edited
* ''save as'' saves changes using a new tiddler title
If a tiddlername was not specified in the macro, select a tiddler from the droplist (or press ''add'') to begin editing.  Once a tiddler has been loaded into the editor, you can change it's content, enter or select tags.

Normally, when you save changes to a tiddler, the created/modified dates and tiddler author are automatically updated.  However, it is sometimes useful to make small changes to a tiddler without automatically updating the date/author information.  Select the ''minor edits'' checkbox to prevent those values from being //automatically// changed.  In addition, this enables the date/author edit fields which allows you to //manually// 'back date' a tiddler or change the author to another name.  When the tiddler is saved, the date/author values shown in the edit fields will be used.
!!!!!using the previewer
The ''preview'' checkbox adds a display area that shows you what your tiddler changes will look like, //before// committing to those changes.

By default, this preview display is automatically rendered each time a key is typed into the tiddler content edit field.  As soon as changes are entered, they will be instantly visible within the preview display.  Unfortunately, the partial tiddler source definitions that occur //during// editing may somtimes cause rendering problems, and some exceptionally complex tiddlers make take an unusually long amount of time to completely render their content.   In such cases, key-by-key display updates are undesirable or impractical.

When ''preview'' is selected, you can also select ''freeze'' to suspend automatic key-by-key preview display updates.  The preview display will not be re-rendered again until you press the ''refresh'' button, or clear the 'freeze' checkbox, or switch to editing a different tiddler.  The editor automatically freezes the preview display whenever the //rendering time// exceeds a pre-determined time limit (see configuration section), specified in milliseconds.  Note: the ''actual elapsed time'' used to process and render any given tiddler is reported in the browser's status bar area whenever that tiddler is previewed.

The previewer also can display a ''DOM viewer'' and an ''HTML viewer'' that are also updated with each keystroke.  These text-based displays can be helpful while attempting to correct or enhance the formatting of tiddler content, especially when complex combinations of wiki-syntax produce unexpected or undesired results.
!!!!!system information and TW option settings
You can use the ''system information'' panel to view a variety of system internal data and functions, and view/modify ''all'' of ~TiddlyWiki's internal config.option.* settings.  NOTE: Non-default config.options are stored in cookies and are retrieved whenever the TW document is loaded into a browser; however, ''core TW functions and custom-defined plugins can explicitly ignore or reset any locally-stored cookie values and use their own, internally-defined values'' instead.  As a result, changes to these may be completely ignored, or may only have an effect during the current TW document &quot;session&quot; (i.e., until the TW document is reloaded), even though a persistent cookie value has been saved.
!!!!! ~DOMViewer macro
syntax: {{{&lt;&lt;DOMViewer rows:nn indent:xxxx inline path elementID|tiddlertitle&gt;&gt;}}}

Whenever TiddlyWiki renders a given tiddler, it creates a 'tree' of DOM (Document Object Model) elements that represent the information that is displayed by the browser.  You can use the ''DOMViewer'' macro to examine the internal DOM elements that are produced by TiddlyWiki's formatter (the 'wikifier'), or elements directly produced by embedded macros that create custom formatted output.  This can be particularly helpful when trying to fine tune the layout and appearance of your tiddler content.

DOMViewer creates a textarea control and reports the DOM tree for the current 'insertion point' where the DOMViewer macro is being placed.  ''inline'' flag uses TiddlyWiki rendering instead of textarea control. ''path'' shows the relative location of each child element in the DOM tree, using subscript notation, ''[elementID or tiddlertitle]'' displays DOM elements starting from the node with the specified ID.  If that ID is not found in the DOM tree, the macro attempts to open a tiddler with that title and then displays the &quot;tiddler&quot;+title DOM elements that were rendered.
&lt;&lt;&lt;
!!!!!Installation
&lt;&lt;&lt;
import (or copy/paste) the following tiddlers into your document:
''TidIDEPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)
^^documentation and javascript for macro handling^^
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2006.12.09 [1.6.1]'' in handler(), allow non-existing tiddler title when processing &quot;edit:title&quot; param
so that new tiddler (or journal) can be created directly from newTiddler, newJournal, or tidIDE macro (without pressing &quot;new&quot; button).  Also, set 'edit=text' attribute on text area field so that default content can be initialized from &quot;text:xxx&quot; parameter specified in newTiddler/newJournal macro.
''2006.11.28 [1.6.0]'' added font and size params to set CSS for form controls in editor and system info panels
|please see [[TidIDEPluginHistory]] for additional revision details|
''2006.04.15 [0.5.0]'' Initial ALPHA release. Converted from TiddlerTweaker inline script.
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]].
&lt;&lt;&lt;
!!!!!Code
***/
// // version info
//{{{
version.extensions.tidIDE = {major: 1, minor: 6, revision: 1, date: new Date(2006,12,9)};
//}}}

// //  macro definition
//{{{
config.macros.tidIDE = {
	versionMsg: &quot;TidIDE v%0.%1.%2: &quot;,
	datetimefmt: &quot;0MM/0DD/YYYY 0hh:0mm&quot;,
	titleMsg: &quot;Please enter a new tiddler title&quot;,
	isShadowMsg: &quot;'%0' is a shadow tiddler and cannot be removed.&quot;,
	renderMsg: &quot;rendering preview...&quot;,
	timeoutMsg: &quot; (&gt; %0ms)&quot;,
	freezeMsg: &quot; - preview is frozen.  Press [refresh] to re-display.&quot;,
	evalMsg: &quot;Warning!!\n\nThis action will process '%0' as a systemConfig (plugin) tiddler, and may produce unexpected results!\n\nAre you sure you want to proceed?&quot;,
	toolsDef: &quot;&lt;html&gt;&lt;a href='javascript:config.macros.tidIDE.set(\&quot;%0\&quot;,\&quot;%1\&quot;);'&gt;edit %1...&lt;/a&gt;&lt;/html&gt;&quot;,
	editorLabel: &quot;TiddlerEditor&quot;,
	systemLabel: &quot;SystemInfo&quot;
};
config.macros.tidIDE.handler= function(place,macroName,params) {
	var here=story.findContainingTiddler(place);
	var selectors=&quot;&quot;;
	var panels=&quot;&quot;;
	var showsys=false;
	var title=&quot;&quot;;
	var id=&quot;&quot;; if (here) id=here.id.substr(7);
	var p=params.shift();
	if (!p) p=&quot;edit:here&quot;; // default to editor if no params
	var openpanels=[];
	var panelcount=0;
	var fontsize=&quot;8pt&quot;;
	var fontface=&quot;Courier New,fixed&quot;;
	while (p) {
		var defOpen=(p.substr(0,1)==&quot;+&quot;); if (defOpen) p=p.substr(1);
		if (p.substr(0,3)==&quot;id:&quot;)
			{ id=p.substr(3); }
		else if (p.substr(0,5)==&quot;font:&quot;)
			{ fontface=p.substr(5); }
		else if (p.substr(0,5)==&quot;size:&quot;)
			{ fontsize=p.substr(5); }
		else if (p.substr(0,4)==&quot;edit&quot;) {
			panelcount++;
			defOpen=defOpen || (!params[0] &amp;&amp; panelcount==1); // if only one panel to show, default to open
			var toolname=this.editorLabel;
			if (p.indexOf('|')!=-1) toolname=p.substr(0,p.indexOf('|'));
			selectors+=this.html.editorchk.replace(/%toolname%/mg,toolname);
			selectors=selectors.replace(/%showpanel%/mg,defOpen?&quot;CHECKED&quot;:&quot;&quot;);
			panels+=this.html.editorpanel;
			// editor panel setup...
			panels=panels.replace(/%showpanel%/mg,defOpen?&quot;block&quot;:&quot;none&quot;);
			panels=panels.replace(/%maxrows%/mg,config.options.txtMaxEditRows);
			panels=panels.replace(/%disabled%/mg,readOnly?&quot;DISABLED&quot;:&quot;&quot;);
			panels=panels.replace(/%readonlychk%/mg,readOnly?&quot;CHECKED&quot;:&quot;&quot;);
			panels=panels.replace(/%minoredits%/mg,config.options.chkForceMinorUpdate&amp;&amp;!readOnly?&quot;&quot;:&quot;DISABLED&quot;);
			panels=panels.replace(/%minorchk%/mg,config.options.chkForceMinorUpdate?&quot;CHECKED&quot;:&quot;&quot;);
			panels=panels.replace(/%fontsize%/mg,fontsize);
			panels=panels.replace(/%fontface%/mg,fontface);
			var tiddlers=store.getTiddlers(&quot;title&quot;); var tiddlerlist=&quot;&quot;; 
			for (var t=0; t&lt;tiddlers.length; t++)
				tiddlerlist+='&lt;option value=&quot;'+tiddlers[t].title+'&quot;&gt;'+tiddlers[t].title+'&lt;/option&gt;';
			for (var t in config.shadowTiddlers)
				if (!store.tiddlerExists(t)) tiddlerlist+=&quot;&lt;option value='&quot;+t+&quot;'&gt;&quot;+t+&quot; (shadow)&lt;/option&gt;&quot;;
			panels=panels.replace(/%tiddlerlist%/mg,tiddlerlist);
			var tags = store.getTags(); var taglist=&quot;&quot;;
			for (var t=0; t&lt;tags.length; t++)
				taglist+=&quot;&lt;option value='&quot;+tags[t][0]+&quot;'&gt;&quot;+tags[t][0]+&quot;&lt;/option&gt;&quot;;
			panels=panels.replace(/%taglist%/mg,taglist);
			if (p.substr(0,5)==&quot;edit:&quot;) { 
				title=p.substr(5); 
				if (here &amp;&amp; title==&quot;here&quot;) title=here.id.substr(7);
			}
		}
		else if (p==&quot;system&quot;) {
			panelcount++;
			defOpen=defOpen || (!params[0] &amp;&amp; panelcount==1); // if only one panel to show, default to open
			var toolname=this.systemLabel;
			showsys=defOpen;
			if (p.indexOf('|')!=-1) toolname=p.substr(0,p.indexOf('|'));
			selectors+=this.html.systemchk.replace(/%toolname%/mg,toolname);
			selectors=selectors.replace(/%showpanel%/mg,defOpen?&quot;CHECKED&quot;:&quot;&quot;);
			panels+=this.html.systempanel;
			panels=panels.replace(/%showpanel%/mg,defOpen?&quot;block&quot;:&quot;none&quot;);
			panels=panels.replace(/%fontsize%/mg,fontsize);
			panels=panels.replace(/%fontface%/mg,fontface);
		}
		else {
			panelcount++;
			defOpen=defOpen || (!params[0] &amp;&amp; panelcount==1); // if only one panel to show, default to open
			var toolid=toolname=p;
			if (p.indexOf('|')!=-1)
				{ toolname=p.substr(0,p.indexOf('|')); toolid=p.substr(p.indexOf('|')+1); }
			selectors+=this.html.toolschk.replace(/%toolid%/mg,toolid).replace(/%toolname%/mg,toolname);
			selectors=selectors.replace(/%showpanel%/mg,defOpen?&quot;CHECKED&quot;:&quot;&quot;);
			panels+=this.html.toolspanel.replace(/%toolid%/mg,toolid);
			panels=panels.replace(/%showpanel%/mg,defOpen?&quot;block&quot;:&quot;none&quot;);
			if (defOpen) openpanels.push(toolid);
		}
		p=params.shift(); // next param
	}
	var html=this.html.framework;
	if (panelcount&lt;2)
		html=html.replace(/%version%/mg,'').replace(/%selector%/mg,''); // omit header/selectors if just one panel to display
	else {
		html=html.replace(/%version%/mg,
			this.versionMsg.format([version.extensions.tidIDE.major,version.extensions.tidIDE.minor,version.extensions.tidIDE.revision]));
		html=html.replace(/%selector%/mg,selectors+&quot;&lt;hr style='margin:0;padding:0'&gt;&quot;);
	}
	html=html.replace(/%panels%/mg,panels);
	html=html.replace(/%id%/mg,id);
	var newIDE=createTiddlyElement(place,&quot;span&quot;);
	newIDE.innerHTML=html;
	if (title.length) this.set(id,title);  // pre-load tiddler editor (if needed)
	if (showsys) config.macros.tidIDE.getsys(id); // pre-load system information (if needed)
	if (openpanels.length) for (i=0;i&lt;openpanels.length;i++) { config.macros.tidIDE.loadPanel(id,openpanels[i]); }
	// see [[TextAreaPlugin]] for extended ctrl-F/G (search/search again)and TAB handler definitions
	var elems=newIDE.getElementsByTagName(&quot;textarea&quot;);
	for (var i=0;i&lt;elems.length;i++) { 
		if (window.addKeyDownHandlers!=undefined) window.addKeyDownHandlers(elems[i]);
	}
}
//}}}

// // CUSTOM PANEL FUNCTIONS 
//{{{
config.macros.tidIDE.loadPanel=function(id,toolid) {
	var place=document.getElementById(id+&quot;_&quot;+toolid+&quot;_panel&quot;); if (!place) return;
	var t=store.getTiddler(toolid);
	place.innerHTML=&quot;&quot;; 
	if (t) wikify(t.text,place); else place.innerHTML=this.toolsDef.format([id,toolid]);
}
//}}}

// // EDITOR PANEL FUNCTIONS
//{{{
config.macros.tidIDE.set=function(id,title) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	if (f.dirty &amp;&amp; !confirm(config.commands.cancelTiddler.warning.format([f.current]))) return;
	// reset to form defaults
	f.dirty=false;
	f.current=&quot;&quot;;
	f.created.value=f.created.defaultValue;
	f.modified.value=f.modified.defaultValue;
	f.author.value=f.author.defaultValue;
	f.content.value=f.content.defaultValue;
	f.tags.value=f.tags.defaultValue;
	f.size.value=f.size.defaultValue;
	f.freeze.checked=false;
	f.domview.value=&quot;&quot;;
	f.htmlview.value=&quot;&quot;;
	f.status.value=&quot;&quot;;
	p.innerHTML=&quot;&quot;;
	if (!title.length) return;
	f.current=title;
	// values for new/shadow tiddlers
	var cdate=new Date();
	var mdate=new Date();
	var modifier=config.options.txtUserName;
	var text=config.views.editor.defaultText.format([title]);
	var tags=&quot;&quot;;
	// adjust values for shadow tiddlers
	if (store.isShadowTiddler(title))
		{ modifier=config.views.wikified.shadowModifier; text=store.getTiddlerText(title) }
	// get values for specified tiddler (if it exists)
	var t=store.getTiddler(title);
	if (t)	{ var cdate=t.created; var mdate=t.modified; var modifier=t.modifier; var text=t.text; var tags=t.getTags(); }
	if (!t &amp;&amp; !store.isShadowTiddler(title)) f.tiddlers.options[f.tiddlers.options.length]=new Option(title,title,false,true); // add item to list
	f.tiddlers.value=title; // select current title (just in case it wasn't already selected)
	f.created.value=cdate.formatString(this.datetimefmt);
	f.modified.value=mdate.formatString(this.datetimefmt);
	f.author.value=modifier;
	f.content.value=text;
	f.tags.value=tags;
	f.minoredits.checked=config.options.chkForceMinorUpdate&amp;&amp;!readOnly;
	f.size.value=f.content.value.length+&quot; bytes&quot;;
	if (f.preview.checked) { p.style.display=&quot;block&quot;; this.render(id); }
}

config.macros.tidIDE.add=function(id) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	if (f.dirty &amp;&amp; !confirm(config.commands.cancelTiddler.warning.format([f.current]))) return;
	var title=prompt(this.titleMsg,config.macros.newTiddler.title);
	while (title &amp;&amp; store.tiddlerExists(title) &amp;&amp; !confirm(config.messages.overwriteWarning.format([title])))
		title=prompt(this.titleMsg,config.macros.newTiddler.title);
	if (!title || !title.trim().length) return; // cancelled by user
	f.dirty=false; // suppress unneeded confirmation message
	this.set(id,title);
}

config.macros.tidIDE.remove=function(id) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	if (!f.current.length) return;
	if (!store.tiddlerExists(f.current) &amp;&amp; store.isShadowTiddler(f.current)) { alert(this.isShadowMsg.format([f.current])); return; }
	if (config.options.chkConfirmDelete &amp;&amp; !confirm(config.commands.deleteTiddler.warning.format([f.current]))) return;
	if (store.tiddlerExists(f.current)) {
		story.closeTiddler(f.current);
		store.removeTiddler(f.current);
		store.setDirty(true);
		if(config.options.chkAutoSave) saveChanges();
	}
	f.tiddlers.options[f.tiddlers.selectedIndex]=null; // remove item from list
	f.dirty=false; // suppress unneeded confirmation message
	this.set(id,&quot;&quot;); // clear form controls
}

config.macros.tidIDE.save=function(id,saveAs) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var title=f.current;
	if (!title || !title.trim().length || saveAs) { // get a new title
		title=prompt(this.titleMsg,config.macros.newTiddler.title);
		while (title &amp;&amp; store.tiddlerExists(title) &amp;&amp; !confirm(config.messages.overwriteWarning.format([title])))
			title=prompt(this.titleMsg,config.macros.newTiddler.title);
		if (!title || !title.trim().length) return; // cancelled by user
		f.tiddlers.options[f.tiddlers.options.length]=new Option(title,title,false,true); // add item to list
		f.current=title;
	}
	var author=config.options.txtUserName;
	var mdate=new Date();
	var content=f.content.value;
	var tags=f.tags.value;
	var tiddler=store.saveTiddler(title,title,content,author,mdate,tags);
	if (f.minoredits.checked) {
		var author=f.author.value;
		var mdate=new Date(f.modified.value);
		var cdate=new Date(f.created.value);
		tiddler.assign(null,null,author,mdate,null,cdate);
	}
	store.setDirty(true);
	if(config.options.chkAutoSave) saveChanges();
	story.refreshTiddler(title,null,true);
	f.dirty=false;
}
//}}}

// // EDITOR PANEL: PREVIEW FUNCTIONS
//{{{
if (config.options.txtTidIDEAutoFreeze==undefined)
	config.options.txtTidIDEAutoFreeze=250; // limit (in milliseconds) for auto-freezing preview display

config.macros.tidIDE.render=function(id) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	var d=document.getElementById(id+&quot;_domview&quot;);
	var h=document.getElementById(id+&quot;_htmlview&quot;);
	p.innerHTML=&quot;&quot;;
	f.status.value=this.renderMsg;
	var start=new Date();
	wikify(f.content.value.replace(regexpCarriageReturn,''),p);
	var end=new Date();
	this.renderDOM(id);
	this.renderHTML(id);
	f.status.value=f.current+&quot;: &quot;+(end-start+1)+&quot;ms&quot;;
	// automatically suspend preview updates for slow rendering tiddlers
	if (end-start+1&gt;config.options.txtTidIDEAutoFreeze) {
		f.freeze.checked=true;
		f.status.value+=this.timeoutMsg.format([config.options.txtTidIDEAutoFreeze]);
	}
	if (f.freeze.checked) f.status.value+=this.freezeMsg;
}

config.macros.tidIDE.renderDOM=function(id) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	var d=document.getElementById(id+&quot;_domview&quot;);
	var h=document.getElementById(id+&quot;_htmlview&quot;);
	p.style.height=(f.dom.checked||f.html.checked)?&quot;10em&quot;:&quot;25em&quot;;
	if (f.dom.checked) d.value=this.getNodeTree(p,&quot;|  &quot;);
	d.style.display=f.dom.checked?&quot;inline&quot;:&quot;none&quot;;
	d.style.width=f.html.checked?&quot;49.5%&quot;:&quot;100%&quot;;
	h.style.width=f.dom.checked?&quot;49.5%&quot;:&quot;100%&quot;;
}

config.macros.tidIDE.renderHTML=function(id) {
	var place=document.getElementById(id+&quot;_editorpanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_editorform&quot;);
	var p=document.getElementById(id+&quot;_preview&quot;);
	var d=document.getElementById(id+&quot;_domview&quot;);
	var h=document.getElementById(id+&quot;_htmlview&quot;);
	p.style.height=(f.dom.checked||f.html.checked)?&quot;10em&quot;:&quot;25em&quot;;
	if (f.html.checked) h.value=this.formatHTML(p.innerHTML);
	h.style.display=f.html.checked?&quot;inline&quot;:&quot;none&quot;;
	d.style.width=f.html.checked?&quot;49.5%&quot;:&quot;100%&quot;;
	h.style.width=f.dom.checked?&quot;49.5%&quot;:&quot;100%&quot;;
}

config.macros.tidIDE.formatHTML=function(txt) {
	if (config.browser.isIE) return txt; // BYPASS - 4/24/2006 due to IE hang problem.  Will fix later...
	var out=&quot;&quot;;
	var indent=&quot;&quot;;
	var level=0;
	for (var i=0;i&lt;txt.length;i++) {
		var c=txt.substr(i,1);
		if (c==&quot;&lt;&quot;) {
			if (txt.substr(i+1,1)==&quot;/&quot;)  indent=indent.substr(0,indent.length-2);
			out+=&quot;\n&quot;+indent;
			if (txt.substr(i+1,1)!=&quot;/&quot; &amp;&amp; txt.substr(i+1,3)!=&quot;br&gt;&quot; &amp;&amp; txt.substr(i+1,2)!=&quot;p&gt;&quot; &amp;&amp; txt.substr(i+1,3)!=&quot;hr&gt;&quot;)  indent+=&quot;  &quot;;
		}
		out+=c;
		if (c==&quot;\n&quot;)
			out+=indent;
		if (c==&quot;&gt;&quot; &amp;&amp; txt.substr(i+1,1)!=&quot;&lt;&quot;)
			out+=&quot;\n&quot;+indent;
	}
	return out;
}

config.macros.tidIDE.getNodeTree=function(theNode,theIndent,showPath,inline,thePrefix,thePath)
{
	if (!theNode) return &quot;&quot;;
	if (!thePrefix) thePrefix=&quot;&quot;;
	if (!thePath) thePath=&quot;&quot;;
	var mquote='&quot;'+(inline?&quot;{{{&quot;:&quot;&quot;);
	var endmquote=(inline?&quot;}}}&quot;:&quot;&quot;)+'&quot;';
	// generate output for this node
	var out = thePrefix;
	if (showPath &amp;&amp; thePath.length)
		out += (inline?&quot;//&quot;:&quot;&quot;)+thePath.substr(1)+&quot;:&quot;+(inline?&quot;//&quot;:&quot;&quot;)+&quot;\r\n&quot;+thePrefix;
	if (theNode.className==&quot;DOMViewer&quot;)
		return out+'[DOMViewer]\r\n'; // avoid self-referential recursion
	out += (inline?&quot;''&quot;:&quot;&quot;)+theNode.nodeName.toUpperCase()+(inline?&quot;''&quot;:&quot;&quot;);
	if (theNode.nodeName==&quot;#text&quot;)
		out += ' '+mquote+theNode.nodeValue.replace(/\n/g,'\\n')+endmquote;
	if (theNode.className)
		out += ' class='+mquote+theNode.className+endmquote;
	if (theNode.type)
		out += ' type='+mquote+theNode.type+endmquote;
	if (theNode.id)
		out += ' id='+mquote+theNode.id+endmquote;
	if (theNode.name)
		out += &quot; &quot;+theNode.name+(theNode.value?&quot;=&quot;+mquote+theNode.value+endmquote:&quot;&quot;);
	if (theNode.href)
		out += ' href='+mquote+theNode.href+endmquote;
	if (theNode.src)
		out += ' src='+mquote+theNode.src+endmquote;
	if (theNode.attributes &amp;&amp; theNode.getAttribute(&quot;tiddlyLink&quot;)!=undefined)
		out += ' tiddler='+mquote+theNode.getAttribute(&quot;tiddlyLink&quot;)+endmquote;
	out += &quot;\r\n&quot;;
	// recursively generate output for child nodes
	thePath=thePath+&quot;.&quot;+theNode.nodeName.toLowerCase();
	thePrefix=theIndent+thePrefix;
	for (var i=0;i&lt;theNode.childNodes.length;i++)
	{
		var thisChild=theNode.childNodes.item(i);
		var theNum=(inline?&quot;~~&quot;:&quot;(&quot;)+(i+1)+(inline?&quot;~~&quot;:&quot;)&quot;);
		out += this.getNodeTree(thisChild,theIndent,showPath,inline,thePrefix,thePath+theNum);
	}
	return out;
}
//}}}

// // DOMViewer macro
//{{{
version.extensions.DOMViewer = version.extensions.tidIDE;
config.macros.DOMViewer = { };
config.macros.DOMViewer.handler = function(place,macroName,params) {
	// set default params
	var inline=false;
	var theRows=15;
	var theIndent=&quot;|  &quot;;
	var showPath=false;
	var theTarget=place;
	// unpack options parameters
	if (params[0]=='inline') { inline=true; theIndent=&quot;&gt;&quot;; params.shift(); } 
	if (params[0]&amp;&amp;(params[0].substr(0,7)==&quot;indent:&quot;)) { theIndent=params[0].substr(7); params.shift(); } 
	if (params[0]&amp;&amp;(params[0].substr(0,5)==&quot;rows:&quot;)) { theRows=params[0].substr(5); params.shift(); } 
	if (params[0]=='path') { showPath=true; params.shift(); } 
	if (params[0]) {
		theTarget=document.getElementById(params[0]);
		if (!theTarget)
			if (store.getTiddler(params[0])!=undefined) {
				theTarget=document.getElementById(&quot;tiddler&quot;+params[0]);
				if (!theTarget &amp;&amp; confirm(&quot;DOMViewer asks:\n\nIs it OK to open tiddler '&quot;+params[0]+&quot;' now?&quot;)) { 
					story.displayTiddler(null,params[0],1,null,null,false);
					theTarget=document.getElementById(&quot;tiddler&quot;+params[0]);
				}
			}
		params.shift();
	}
	// generate and display DOM tree
	if (inline) {
		var out=config.macros.tidIDE.getNodeTree(theTarget,theIndent,showPath,inline);
		wikify(out,place);
	}
	else {
		var out=config.macros.tidIDE.getNodeTree(theTarget,theIndent,showPath,inline);
		var css=&quot;.DOMViewer{width:100%;font-size:8pt;color:inherit;background:transparent;border:0px;}&quot;;
		setStylesheet(css,&quot;DOMViewerPlugin&quot;);
		var theTextArea=createTiddlyElement(place,&quot;textarea&quot;,null,&quot;DOMViewer&quot;,out);
		theTextArea.rows=theRows;
		theTextArea.cols=60;
		theTextArea.wrap=&quot;off&quot;;
		theTextArea.theTarget=theTarget;
		theTextArea.theIndent=theIndent;
		theTextArea.showPath=showPath;
	}
}
//}}}

// // SYSTEM PANEL FUNCTIONS
//{{{
config.macros.tidIDE.showObject=function(o) { // generate formatted output for displaying object references
	var t=&quot;&quot;;
	for (var p in o) {
		if (typeof o[p]==&quot;function&quot;) {
			t+=&quot;- - - - - - - - - - &quot;+p+&quot; - - - - - - - - - -\n&quot;;
			t+=o[p].toString();
			t+=&quot;\n- - - - - - - - - - END: &quot;+p+&quot; - - - - - - - - - -\n&quot;;
		}
		else
			t+='['+typeof o[p]+'] '+p+&quot;: &quot;+o[p]+&quot;\n&quot;;
	}
	return t;
}

config.macros.tidIDE.getsys=function(id) {
	var place=document.getElementById(id+&quot;_systempanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_systemform&quot;);
	f.sysview.value=&quot;&quot;;
	// OPTIONS
	while (f.sys_opts.options.length &gt; 1) { f.sys_opts.options[1]=null; } // clear list
	f.config_view.value=&quot;&quot;;  // clear edit field
	var cookies = { };
	if (document.cookie != &quot;&quot;) {
		var p = document.cookie.split(&quot;; &quot;);
		for (var i=0; i &lt; p.length; i++) {
			var pos=p[i].indexOf(&quot;=&quot;);
			if (pos==-1)
				cookies[p[i]]=&quot;&quot;;
			else
				cookies[p[i].substr(0,pos)]=unescape(p[i].slice(pos+1));
		}
	}
	var c=1;
	var opt=new Array(); for (var i in config.options) opt.push(i); opt.sort();
	for(var i=0; i&lt;opt.length; i++) {
		if ((opt[i].substr(0,3)==&quot;txt&quot;)||(opt[i].substr(0,3)==&quot;chk&quot;)) {
			var txt = (opt[i].substr(0,3)==&quot;chk&quot;?(&quot;[&quot;+(config.options[opt[i]]?&quot;x&quot;:&quot;_&quot;)+&quot;] &quot;):&quot;&quot;)+opt[i]+(cookies[opt[i]]?&quot; (cookie)&quot;:&quot;&quot;);
			var val = config.options[opt[i]];
			f.sys_opts.options[c++]=new Option(txt,val,false,false);
		}
	}
	// STYLESHEETS
	while (f.sys_styles.options.length &gt; 1) { f.sys_styles.options[1]=null; } // clear list
	var c=1;
	var styles=document.getElementsByTagName(&quot;style&quot;);
	for(var i=0; i &lt; styles.length; i++) {
		var id=styles[i].getAttribute(&quot;id&quot;); if (!id) id=&quot;(default)&quot;;
		var txt=id;
		var val=&quot;/* stylesheet:&quot;+txt+&quot; */\n&quot;+styles[i].innerHTML;
		f.sys_styles.options[c++]=new Option(txt,val,false,false);
	}
	// SHADOWS
	while (f.sys_shadows.options.length &gt; 1) { f.sys_shadows.options[1]=null; } // clear list
	var c=1;
	for(var s in config.shadowTiddlers) f.sys_shadows.options[c++]=new Option(s,config.shadowTiddlers[s],false,false);
	// NOTIFICATIONS
	while (f.sys_notify.options.length &gt; 1) { f.sys_notify.options[1]=null; } // clear list
	var c=1;
	for (var i=0; i&lt;store.namedNotifications.length; i++) {
		var n = store.namedNotifications[i];
		var fn = n.notify.toString();
		fn = fn.substring(fn.indexOf(&quot;function &quot;)+9,fn.indexOf(&quot;{&quot;)-1);
		var txt=(n.name?n.name:&quot;any change&quot;)+&quot;=&quot;+fn;
		var val=&quot;/* notify: &quot;+txt+&quot; */\n&quot;+n.notify.toString();
		f.sys_notify.options[c++]=new Option(txt,val,false,false);
	}
	// MACROS
	while (f.sys_macros.options.length &gt; 1) { f.sys_macros.options[1]=null; } // clear list
	var c=1;
	var macros=new Array(); for (var m in config.macros) macros.push(m); macros.sort();
	for(var i=0; i &lt; macros.length; i++)
		f.sys_macros.options[c++]=new Option(macros[i],this.showObject(config.macros[macros[i]]),false,false);
	// TOOLBAR COMMANDS
	while (f.sys_commands.options.length &gt; 1) { f.sys_commands.options[1]=null; } // clear list
	var c=1;
	for(var cmd in config.commands)
		f.sys_commands.options[c++]=new Option(cmd,this.showObject(config.commands[cmd]),false,false);
	// FORMATTERS
	while (f.sys_formatters.options.length &gt; 1) { f.sys_formatters.options[1]=null; } // clear list
	var c=1;
	for(var i=0; i &lt; config.formatters.length; i++)
		f.sys_formatters.options[c++]=new Option(config.formatters[i].name,this.showObject(config.formatters[i]),false,false);
	// PARAMIFIERS
	while (f.sys_params.options.length &gt; 1) { f.sys_params.options[1]=null; } // clear list
	var c=1;
	for(var param in config.paramifiers)
		f.sys_params.options[c++]=new Option(param,this.showObject(config.paramifiers[param]),false,false);
	// GLOBALS
	//global variables and functions (excluding most DOM and ~TiddyWiki core definitions)://
	var DOM0_globals = {
		addEventListener: 1, alert: 1, atob: 1, back: 1, blur: 1, btoa: 1, captureEvents: 1, clearInterval: 1,
		clearTimeout: 1, close: 1, closed: 1, Components: 1, confirm: 1, content: 1, controllers: 1, crypto: 1,
		defaultStatus: 1, defaultStatus: 1, directories: 1, disableExternalCapture: 1, dispatchEvent: 1, document: 1,
		dump: 1, enableExternalCapture: 1, escape: 1, find: 1, focus: 1, forward: 1, frameElement: 1, frames: 1,
		fullScreen: 1, getAttention: 1, getComputedStyle: 1, getSelection: 1, history: 1, home: 1, innerHeight: 1,
		innerWidth: 1, length: 1, location: 1, locationbar: 1, menubar: 1, moveBy: 1, moveTo: 1, name: 1,
		navigator: 1, open: 1, openDialog: 1, opener: 1, outerHeight: 1, outerWidth: 1, pageXOffset: 1,
		pageYOffset: 1, parent: 1, personalbar: 1, pkcs11: 1, print: 1, prompt: 1, prompter: 1, releaseEvents: 1,
		removeEventListener: 1, resizeBy: 1, resizeTo: 1, routeEvent: 1, screen: 1, screenX: 1, screenY: 1,
		scroll: 1, scrollbars: 1, scrollBy: 1, scrollByLines: 1, scrollByPages: 1, scrollMaxX: 1, scrollMaxY: 1,
		scrollTo: 1, scrollX: 1, scrollY: 1, self: 1, setInterval: 1, setResizable: 1, setTimeout: 1, sidebar: 1,
		sizeToContent: 1, status: 1, statusbar: 1, stop: 1, toolbar: 1, top: 1, unescape: 1, updateCommands: 1,
		window: 1, getInterface: 1
	};
	var tw_globals = {
		version: 1, config: 1, DEFAULT_VIEW_TEMPLATE: 1, DEFAULT_EDIT_TEMPLATE: 1, store: 1, story: 1,
		Formatter: 1, anim: 1, readOnly: 1, highlightHack: 1, main: 1, restart: 1, saveTest: 1,  loadSystemConfig: 1,
		processConfig: 1, invokeMacro: 1, Formatter: 1, wikify: 1, wikifyPlain: 1, highlightify: 1, Wikifier: 1, 
		Tiddler: 1, regexpBackSlashEn: 1, regexpBackSlash: 1, regexpBackSlashEss: 1, regexpNewLine: 1, 
		regexpCarriageReturn: 1, TiddlyWiki: 1, displayTiddlers: 1, displayTiddler: 1, Story: 1, displayMessage: 1,
		clearMessage: 1, refreshElements: 1, applyHtmlMacros: 1, refreshPageTemplate: 1, applyPageTemplate: 1,
		refreshDisplay: 1, refreshPageTitle: 1, refreshStyles: 1, loadOptionsCookie: 1, saveOptionCookie: 1,
		saveUsingSafari: 1, startSaveArea: 1, endSaveArea: 1, checkUnsavedChanges: 1, saveChanges: 1,
		getBackupPath: 1, generateRss: 1, allTiddlersAsHtml: 1,
		convertUTF8ToUnicode: 1, manualConvertUTF8ToUnicode: 1, mozConvertUTF8ToUnicode: 1,
		convertUnicodeToUTF8: 1, manualConvertUnicodeToUTF8: 1, mozConvertUnicodeToUTF8: 1,
		saveFile: 1, loadFile: 1, ieSaveFile: 1, ieLoadFile: 1, mozillaSaveFile: 1, mozillaLoadFile: 1,
		operaUrlToFilename: 1, operaSaveFile: 1, operaLoadFile: 1, safariFilenameToUrl: 1, safariLoadFile: 1,
		safariSaveFile: 1, detectPlugin: 1, createTiddlyButton: 1, createTiddlyLink: 1, refreshTiddlyLink: 1,
		createExternalLink: 1, onClickTiddlerLink: 1, createTagButton: 1, onClickTag: 1, onClickTagOpenAll: 1,
		createTiddlyError: 1, Animator: 1, Zoomer: 1, Cascade: 1, Scroller: 1, Slider: 1, Popup: 1,
		createTiddlerPopup: 1, scrollToTiddlerPopup: 1, hideTiddlerPopup: 1, RGB: 1, drawGradient: 1,
		createTiddlyText: 1, createTiddlyElement: 1, addEvent: 1, removeEvent: 1, addClass: 1,
		removeClass: 1, hasClass: 1, resolveTarget: 1, getPlainText: 1, ensureVisible: 1, 
		findWindowWidth: 1, findWindowHeight: 1, findScrollX: 1, findScrollY: 1, findPosX: 1, findPosY: 1,
		insertSpacer: 1, removeChildren: 1, setStylesheet: 1,
		Packages: 1, sun: 1, java: 1, netscape: 1, XPCNativeWrapper: 1, GeckoActiveXObject: 1
	};
	while (f.sys_globals.options.length &gt; 1) { f.sys_globals.options[1]=null; } // clear list
	if (config.browser.isIE) return; // BYPASS - 8/16/2006 // DON'T LIST GLOBALS IN IE... throws object error - WFFL
	try {
		var c=1;
		for (var v in window) if (!(DOM0_globals[v] || tw_globals[v])) {
			var t=window[v];
			if ((typeof window[v])=='object') {
				var t='';
				for (var p in window[v]) {
					t+=((typeof window[v][p])!='function')?('['+typeof window[v][p]+'] '+p):p;
					t+=((typeof window[v][p])!='function')?('='+window[v][p]):'';
					t+='\n';
				}
			}
			f.sys_globals.options[c++]=new Option(((typeof window[v])!='function')?('['+typeof window[v]+'] '+v):v,t,false,false);
		}	
	}
	catch(e) { ; }
}

config.macros.tidIDE.setsys=function(id) {
	var place=document.getElementById(id+&quot;_systempanel&quot;); if (!place) return;
	var f=document.getElementById(id+&quot;_systemform&quot;);
	if (f.sys_opts.selectedIndex==0) return; // heading - do nothing
	var name=f.sys_opts.options[f.sys_opts.selectedIndex].text.replace(/\[[Xx_]\] /,'').replace(/ \(cookie\)/,'')
	var value=f.config_view.value;
	config.options[name]=value;
	saveOptionCookie(name);
	f.sys_opts.options[f.sys_opts.selectedIndex].value=value;
	return;
}
//}}}

// // HTML DEFINITIONS
//{{{
config.macros.tidIDE.html = { };
config.macros.tidIDE.html.framework = &quot; \
	&lt;html&gt; %version% &lt;form style='display:inline;margin:0;padding:0;'&gt;%selector%&lt;/form&gt; %panels% &lt;/html&gt; \
&quot;;
//}}}
//{{{
config.macros.tidIDE.html.editorchk = &quot; \
	&lt;input type=checkbox name=editor \
		style='display:inline;width:auto;margin:1px;' \
		title='add/delete/modify tiddlers' %showpanel% \
		onclick='document.getElementById(\&quot;%id%_editorpanel\&quot;).style.display=this.checked?\&quot;block\&quot;:\&quot;none\&quot;; \
			if (this.checked) config.macros.tidIDE.render(\&quot;%id%\&quot;);'&gt;%toolname% \
&quot;;
config.macros.tidIDE.html.systemchk = &quot; \
	&lt;input type=checkbox name=system \
		style='display:inline;width:auto;margin:1px;' \
		title='view TiddlyWiki system internals and configurable options' %showpanel% \
		onclick='document.getElementById(\&quot;%id%_systempanel\&quot;).style.display=this.checked?\&quot;block\&quot;:\&quot;none\&quot;; \
			if (this.checked) config.macros.tidIDE.getsys(\&quot;%id%\&quot;);'&gt;%toolname% \
&quot;;
config.macros.tidIDE.html.toolschk = &quot; \
	&lt;input type=checkbox name=tools \
		style='display:inline;width:auto;margin:1px;' \
		title='' %showpanel% \
		onclick='document.getElementById(\&quot;%id%_%toolid%_panel\&quot;).style.display=this.checked?\&quot;block\&quot;:\&quot;none\&quot;; \
			if (this.checked) config.macros.tidIDE.loadPanel(\&quot;%id%\&quot;,\&quot;%toolid%\&quot;);'&gt;%toolname% \
&quot;;
//}}}
//{{{
config.macros.tidIDE.html.toolspanel = &quot; \
	&lt;div id='%id%_%toolid%_panel' style='display:%showpanel%;margin:0;margin-top:0.5em'&gt; \
	&lt;/div&gt; \
&quot;;
//}}}
//{{{
config.macros.tidIDE.html.systempanel = &quot; \
	&lt;div id='%id%_systempanel' style='display:%showpanel%;margin:0;margin-top:0.5em;white-space:nowrap'&gt; \
		&lt;form id='%id%_systemform' style='display:inline;margin:0;padding:0;'&gt; \
		&lt;!-- configurable options --&gt; \
		&lt;table style='width:100%;border:0;padding:0;margin:0'&gt;&lt;tr style='border:0;padding:0;margin:0'&gt; \
		&lt;td style='width:30%;border:0;padding:0;margin:0'&gt; \
			&lt;select size=1 name='sys_opts' style='width:100%;font-size:%fontsize%;' \
				onchange='this.form.config_view.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;config.options.*&lt;/option&gt; \
			&lt;/select&gt; \
		&lt;/td&gt;&lt;td style='width:50%;border:0;padding:0;margin:0;'&gt; \
			&lt;input type=text name='config_view' size=60 style='width:99%;font-size:%fontsize%;' value=''&gt; \
		&lt;/td&gt;&lt;td style='width:20%;white-space:nowrap;border:0;padding:0;margin:0;'&gt; \
			&lt;input type=button style='width:50%;' value='set option' title='save this TiddlyWiki option value' \
				onclick='config.macros.tidIDE.setsys(\&quot;%id%\&quot;);config.macros.tidIDE.getsys(\&quot;%id%\&quot;);'&gt;&lt;!-- \
			--&gt;&lt;input type=button style='width:50%;' value='refresh' title='retrieve current options and system values' \
				onclick='this.form.sysview.style.display=\&quot;none\&quot;; config.macros.tidIDE.getsys(\&quot;%id%\&quot;);'&gt; \
		&lt;/td&gt;&lt;/tr&gt;&lt;tr style='border:0;padding:0;margin:0'&gt;&lt;td colspan=3 \
				style='white-space:nowrap;width:100%;border:0;padding:0;margin:0'&gt; \
			&lt;!-- system objects --&gt; \
			&lt;select size=1  name='sys_styles' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;stylesheets...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_shadows' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;shadows...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_notify' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;notifications...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_globals' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;globals...&lt;/option&gt; \
			&lt;/select&gt;&lt;br&gt;&lt;select size=1  name='sys_macros' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;macros...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_commands' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;toolbars...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_formatters' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;wikifiers...&lt;/option&gt; \
			&lt;/select&gt;&lt;select size=1  name='sys_params' style='width:25%;font-size:%fontsize%;' \
				onchange='this.form.sysview.style.display=\&quot;block\&quot;; this.form.%id%_sysview.value=this.value'&gt; \
				&lt;option value=\&quot;\&quot;&gt;paramifiers...&lt;/option&gt; \
			&lt;/select&gt; \
			&lt;!-- system value display area --&gt; \
			&lt;span style='white-space:normal;'&gt;&lt;textarea id='%id%_sysview' name=sysview cols=60 rows=12 \
				onfocus='this.select()' style='width:99.5%;height:16em;font-size:%fontsize%;font-family:%fontface%;display:none'&gt;&lt;/textarea&gt;&lt;/span&gt; \
		&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; \
		&lt;/form&gt; \
	&lt;/div&gt; \
&quot;;
//}}}
//{{{
config.macros.tidIDE.html.editorpanel = &quot; \
	&lt;div id='%id%_editorpanel' style='display:%showpanel%;margin:0;margin-top:0.5em'&gt; \
	&lt;form id='%id%_editorform' style='display:inline;margin:0;padding:0;'&gt; \
	&lt;!-- tiddler editor list and buttons --&gt; \
	&lt;select size=1 name=tiddlers style='display:inline;width:40%;font-size:%fontsize%;'  \
		onchange='config.macros.tidIDE.set(\&quot;%id%\&quot;,this.value); this.value=this.form.current;'&gt; \
	&lt;option value=''&gt;select a tiddler...&lt;/option&gt; \
	%tiddlerlist% \
	&lt;/select&gt;&lt;!-- \
	--&gt;&lt;input name=add type=button style='display:inline;width:10%' \
		value='new' title='create a new tiddler' \
		onclick='config.macros.tidIDE.add(\&quot;%id%\&quot;)' %disabled%&gt;&lt;!-- \
	--&gt;&lt;input name=remove type=button style='display:inline;width:10%' \
		value='remove' title='delete this tiddler' \
		onclick='config.macros.tidIDE.remove(\&quot;%id%\&quot;)' %disabled%&gt;&lt;!-- \
	--&gt;&lt;input name=save type=button style='display:inline;width:10%' \
		value='save' title='save changes to this tiddler' \
		onclick='config.macros.tidIDE.save(\&quot;%id%\&quot;)' %disabled%&gt;&lt;!-- \
	--&gt;&lt;input name=saveas type=button style='display:inline;width:10%' \
		value='save as' title='save changes to a new tiddler' \
		onclick='config.macros.tidIDE.save(\&quot;%id%\&quot;,true)' %disabled%&gt;&lt;!-- \
	--&gt;&lt;input name=view type=button style='display:inline;width:10%' \
		value='open' title='open this tiddler for regular viewing' \
		onclick='if (!this.form.current.length) return;	story.displayTiddler(null,this.form.current)'&gt;&lt;!-- \
	--&gt;&lt;!-- COMMENTED OUT &lt;input name=run type=button style='display:inline;width:9%' \
		value='run' title='evaluate this tiddler as a javascript \&quot;systemConfig\&quot; plugin' \
		onclick='if (!confirm(config.macros.tidIDE.evalMsg.format([this.form.current]))) return false; \
			var err=processConfig(this.form.content.value); \
			if(err)displayMessage(config.messages.customConfigError.format([err,this.form.current]));'&gt; END COMMENT --&gt;&lt;!-- \
	--&gt;&lt;input name=previewbutton type=button style='display:inline;width:10%;' \
		value='preview' title='show \&quot;live\&quot; preview display' \
		onclick='document.getElementById(\&quot;%id%_previewpanel\&quot;).style.display=\&quot;block\&quot;; \
			this.form.preview.checked=true; config.macros.tidIDE.render(\&quot;%id%\&quot;)'&gt;&lt;!-- \
	hidden field for preview show/hide state: \
	--&gt;&lt;input name=preview type=checkbox style='display:none;'&gt;\
	&lt;!-- tiddler content edit --&gt; \
	&lt;div&gt;&lt;textarea id='%id%_content' name='content' edit='text' cols=60 rows=%maxrows% \
		style='width:100%;font-size:%fontsize%;font-family:%fontface%;' \
		onkeyup='var f=this.form; f.dirty=true; f.size.value=this.value.length+\&quot; bytes\&quot;;  \
			var p=document.getElementById(\&quot;%id%_preview\&quot;); \
			if (f.preview.checked &amp;&amp; !f.freeze.checked) { config.macros.tidIDE.render(\&quot;%id%\&quot;); }'&gt;&lt;/textarea&gt;&lt;/div&gt; \
	&lt;!-- tag edit and droplist --&gt; \
	&lt;table width='100%' style='border:0;padding:0;margin:0'&gt;&lt;tr style='border:0;padding:0;margin:0'&gt; \
	&lt;td style='border:0;padding:0;margin:0'&gt; \
		&lt;input type=text name=tags size=60 style='width:100%;font-size:%fontsize%;' value='' \
			onchange='this.form.dirty=true' %disabled%&gt; \
	&lt;/td&gt;&lt;td width='1' style='border:0;padding:0;margin:0;'&gt; \
		&lt;select size=1 name=taglist style='font-size:%fontsize%;' \
			onchange='this.form.dirty=true; this.form.tags.value+=\&quot; \&quot;+this.value' %disabled%&gt; \
		&lt;option value=''&gt;select tags...&lt;/option&gt; \
		%taglist% \
		&lt;/select&gt; \
	&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; \
	&lt;!--  created/modified dates, author, current tiddler size --&gt; \
	&lt;div style='float:right;'&gt; \
		created &lt;input type=text name=created size=15 \
			style='display:inline;font-size:%fontsize%;text-align:center;padding:0;' value='' \
			onchange='this.form.dirty=true' %minoredits%&gt; \
		modified &lt;input type=text name=modified size=15 \
			style='display:inline;font-size:%fontsize%;text-align:center;padding:0;' value='' \
			onchange='this.form.dirty=true;' %minoredits%&gt; \
		by &lt;input type=text name=author size=15 \
			style='display:inline;font-size:%fontsize%;padding:0;' value='' \
			onfocus='this.select()' onchange='this.form.dirty=true' %minoredits%&gt; \
		&lt;input type=text name=size size=10 \
			style='display:inline;font-size:%fontsize%;text-align:center;padding:0;' value='' \
			onfocus='this.blur()' onkeydown='return false' DISABLED&gt;  \
	&lt;/div&gt; \
	&lt;!-- toggles: read-only, minor edit --&gt; \
	&lt;span style='white-space:nowrap'&gt; \
	&lt;input type=checkbox name=readonly \
		style='display:inline;width:auto;margin:1px;' %readonlychk% \
		title='do not allow tiddler changes to be saved' \
		onclick='readOnly=config.options.chkHttpReadOnly=this.checked;saveOptionCookie(\&quot;chkHttpReadOnly\&quot;); \
			var f=this.form; f.minoredits.disabled=f.tags.disabled=f.taglist.disabled=this.checked; \
			f.add.disabled=f.remove.disabled=f.save.disabled=f.saveas.disabled=this.checked; \
			f.created.disabled=f.modified.disabled=f.author.disabled=this.checked||!f.minoredits.checked;'&gt;readonly \
	&lt;input type=checkbox name=minoredits \
		style='display:inline;width:auto;margin:1px;' %disabled% %minorchk% \
		title='check: save datestamps/author as entered, uncheck: auto-update modified/author' \
		onclick='this.form.created.disabled=this.form.modified.disabled=this.form.author.disabled=!this.checked; \
			config.options.chkForceMinorUpdate=this.checked;saveOptionCookie(\&quot;chkForceMinorUpdate\&quot;);'&gt;minor edits \
	&lt;/span&gt; \
	&lt;!-- tiddler preview display --&gt; \
	&lt;div id='%id%_previewpanel' style='display:none;white-space:nowrap'&gt; \
	&lt;div id='%id%_preview' class='viewer' style='margin:0;margin-top:.5em;height:25em;overflow:auto;white-space:normal'&gt; \
		&amp;nbsp; \
	&lt;/div&gt; \
	&lt;!-- DOM and HTML viewers --&gt; \
	&lt;textarea id='%id%_domview' name=domview cols=60 rows=12 wrap=off \
		onfocus='this.select()' style='display:none;width:100%;height:16em;font-size:%fontsize%;'&gt;&lt;/textarea&gt;&lt;!-- \
	--&gt;&lt;textarea id='%id%_htmlview' name=htmlview cols=60 rows=12 wrap=off \
		onfocus='this.select()' style='display:none;width:100%;height:16em;font-size:%fontsize%;'&gt;&lt;/textarea&gt; \
	&lt;!-- status line, preview option checkboxes, run/refresh buttons --&gt; \
	&lt;table width='100%' style='border:0;padding:0;margin:0'&gt;&lt;tr style='border:0;padding:0;margin:0'&gt; \
	&lt;td style='border:0;padding:0;margin:0'&gt; \
		&lt;input type=text '%id%_status' name=status style='padding:0;width:100%;font-size:%fontsize%;'&gt; \
	&lt;/td&gt;&lt;td style='width:1%;border:0;padding:0;margin:0;text-align:right;white-space:nowrap'&gt; \
		&lt;input type=checkbox name=dom style='display:inline;width:auto;margin:1px;' \
			title='show Document Object Model (DOM) information' \
			onclick='config.macros.tidIDE.renderDOM(\&quot;%id%\&quot;);'&gt;DOM \
		&lt;input type=checkbox name=html style='display:inline;width:auto;margin:1px;' \
			title='show rendered HTML' \
			onclick='config.macros.tidIDE.renderHTML(\&quot;%id%\&quot;);'&gt;HTML \
		&lt;input type=checkbox name=freeze style='display:inline;width:auto;margin:1px;' \
			title='do not update preview display as changes are made' \
			onclick='var p=document.getElementById(\&quot;%id%_preview\&quot;);  \
				if (this.checked) this.form.status.value+=config.macros.tidIDE.freezeMsg; \
				else config.macros.tidIDE.render(\&quot;%id%\&quot;);'&gt;freeze \
		&lt;!-- COMMENTED OUT &lt;input type=button style='display:inline;width:auto;' value='run' \
			title='evaluate this tiddler as a javascript \&quot;systemConfig\&quot; plugin' \
			onclick='if (!confirm(config.macros.tidIDE.evalMsg.format([this.form.current]))) return false; \
				var err=processConfig(this.form.content.value); \
				if(err)displayMessage(config.messages.customConfigError.format([err,this.form.current]));'&gt; END COMMENT --&gt;&lt;!-- \
		--&gt;&lt;input type=button style='display:inline;width:auto;' value='refresh' \
			title='update preview display' \
			onclick='config.macros.tidIDE.render(\&quot;%id%\&quot;)'&gt;&lt;!-- \
		--&gt;&lt;input type=button style='display:inline;width:auto;' value='hide' \
			title='hide preview display' \
			onclick='document.getElementById(\&quot;%id%_previewpanel\&quot;).style.display=\&quot;none\&quot;; \
				this.form.preview.checked=false; config.macros.tidIDE.render(\&quot;%id%\&quot;)'&gt; \
	&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; \
	&lt;/div&gt; \
	&lt;/form&gt; \
	&lt;/div&gt; \
&quot;;
//}}}</pre>
</div>
<div title="TiddlerInFilePlugin-ByTagFork" creator="YourName" modifier="YourName" created="202507091948" tags="systemConfig" changecount="1">
<pre>/***
|Description |Allows to store any number of tiddlers as external files and more|
|Source      |https://github.com/YakovL/TiddlyWiki_TiddlerInFilePlugin/blob/master/TiddlerInFilePlugin.js|
|Author      |Yakov Litvin, Modified by Yanshu Wang|
|Version     |1.1.4|
|License     |[[MIT|https://github.com/YakovL/TiddlyWiki_YL_ExtensionsCollection/blob/master/Common%20License%20(MIT)]]|
!!!Requirements
Since the plugin loads and saves files, it needs that the browser and/or saver supports these operations. Here are some options:
* Loading files:
** Works when TW is opened (and external files are attempted to be loaded) via http (or https) protocol (but not, by default, via file:// url);
** Firefox allows loading local files when the {{{security.fileuri.strict_origin_policy}}} setting is set to {{{false}}} (type {{{about:config}}} in address bar to open the configuration UI). If Firefox is your primary browser, i.e. you use it not just for TW and some trusted sites, it is recommended to [[create|https://groups.google.com/g/tiddlywikiclassic/c/T1q0q9uF2aI/m/f2SVb8CYAAAJ]] a separate profile for using ~TWs and change the setting there to ensure better security.
** Some savers may provide full file loading functionality. Those yet to be tested: [[TiddlyDesktop|https://github.com/Jermolene/TiddlyDesktop]], [[tiddly-node-saver|https://github.com/fallwest/tiddly-node-saver]], [[nwTWcSaver|https://github.com/nwOkido/nwTWcSaver]], ..;
* Saving files:
** suitable savers include: [[Timimi|https://github.com/ibnishak/Timimi]]; the savers yet to be tested: [[TiddlyDesktop|https://github.com/Jermolene/TiddlyDesktop]], ..;

!!!Usage
Once the plugin is installed (copy, tag with {{{systemConfig}}}, reload) storing tiddlers in files is done via 2 steps:
# list (describe) those in [[ExternalTiddlersList]] by writing {{{&lt;&lt;external&gt;&gt;}}} macros there
# if the file exists and the tiddler doesn't, reload TW (external tiddler will be loaded on startup);&lt;br&gt;if the tiddler exists and the file doesn't, just save your TW
Note: external tiddler is always the main &quot;source of truth&quot;: if {{{keepInternal:true}}} is used, it is saved in TW as well, but loading external content will overwrite what is saved in TW.

Here's how the macro is used:
{{{
&lt;&lt;external [[MyTestTiddler]]&gt;&gt;
}}}
will store the tiddler's text in {{{MyTestTiddler.txt}}} in the same folder as TW. There's a number of other options:
{{{
&lt;&lt;external [[tiddler name]]
  [file:&lt;relative path with or without filename and extension&gt;]
  [format:{externalized | text}]
  [keepInternal:true]
  [plugin:true]
&gt;&gt;
}}}
Examples of the {{{file}}} param usage:
* {{{&lt;&lt;external [[MyTestTiddler]] file:&quot;other name&quot;&gt;&gt;}}} makes file name different from tiddler name
* {{{&lt;&lt;external [[MyPlugin]] file:&quot;MyPlugin.js&quot; plugin:true&gt;&gt;}}} sets a custom file extension (see also the {{{plugin}}} option below)
* {{{&lt;&lt;external [[MyLog]] file:&quot;../logs/&quot;&gt;&gt;}}} will store the file in another folder (note that omitted filename after {{{/}}} means &quot;use tiddler name as filename and default extension&quot;)
* the plugin doesn't take care of forbidden characters yet ({{{*}}}, {{{?}}}, {{{&quot;}}} etc), so be careful about those

Supported formats are
* {{{text}}} (default) â only tiddler text is stored in the file with {{{.txt}}} extension; and
* {{{externalized}}} â whole tiddler is stored in the same format as in TW store, file has {{{.tid.html}}} extension and is displayed is monospace tiddler text when opened in browser
Formats can be added by extending {{{config.macros.external.fileFormats}}}.

The {{{keepInternal}}} option makes TW save the tiddler in both external file and TW itself. This, for instance, affects tiddlers stored in {{{text}}} format: without it, all fields like creator, modified etc are destroyed on reload (since are not saved), but with it they are preserved.

The {{{plugin}}} option makes TW evaluate the tiddler like it does with plugins. Note that it doesn't handle plugin dependencies yet. @@color:red;Warning@@: TIFP doesn't currently take care of installing only once, so use {{{plugin}}} with {{{keepInternal}}} ''only'' if you understand the outcome (for instance, some plugins may create infinite loops; also remember that internal version will be always installed first).
***/
//{{{
config.macros.external = {
	fileFormats: {
		text: {
			extension: 'txt',
			externalize: function(tiddler) { return tiddler.text },
			// changes tiddler as a side-effect not to remove existing fields
			internalize: function(tiddler, source) {
				tiddler.text = source
			}
		},
		externalized: {
			extension: 'tid.html',
			externalize: function(tiddler) {
				return store.getSaver().externalizeTiddler(store, tiddler)
			},
			// like for 'text', extends tiddler, doesn't create from scratch
			internalize: function(tiddler, source) {
				const div = createTiddlyElement(document.body, 'div')
				div.setAttribute('style','display:none;')
				div.innerHTML = source
				store.getLoader().internalizeTiddler(store, tiddler,
					tiddler.title, div.firstChild)
				div.remove()
			}
		},
                js: {
			extension: 'js',
			externalize: function(tiddler) { return tiddler.text },
			// changes tiddler as a side-effect not to remove existing fields
			internalize: function(tiddler, source) {
				tiddler.text = source
			}
		}/*,
		tid: { extension: 'tid' },
		json: { extension: 'tid.json' }
		externalizedWithFormatter? sane to implement?
		*/
	},
	// here and below &quot;meta&quot; means &quot;info about registered external tiddler,
	// be it loaded or not&quot;
	getExtension: function(meta) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		return format.extension
	},
	externalizeTiddler: function(meta) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		return format.externalize(meta.tiddler)
	},
	internalizeTiddler: function(meta, source) {
		const format = this.fileFormats[meta.fileFormat]
		if(!format) return //# ok??
		
		const tiddler = store.fetchTiddler(meta.tiddlerName) ||
			new Tiddler(meta.tiddlerName)
		format.internalize(tiddler, source) //# pass meta to tiddler?
		// a patch for Windows: don't get linebreaks duplicated
		tiddler.text = tiddler.text.replace(/\r\n/g, '\n')
		tiddler.doNotSave = function() { return !meta.keepInTW }
		meta.tiddler = tiddler
		
		return tiddler
	},

	listName: &quot;ExternalTiddlersList&quot;,
	// read files list, load
	init: function() {
		const listTiddler = store.fetchTiddler(this.listName)
		if(!listTiddler || !listTiddler.text) return
		wikify(listTiddler.text, createTiddlyElement(null, 'div'))

		for(let meta of this.tiddlersMeta) this.loadExternal(meta)
	},
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		// parse params, register
		const defaultParam = 'tiddler'
		const pParams = paramString.parseParams(defaultParam, null, true)
		const meta = {}
		meta.tiddlerName = getParam(pParams, defaultParam)
		if(!meta.tiddlerName) return

		// although called .fileName, it actually can contain relative part of a path
		// fallback to meta.tiddlerName is set when calculating the full path
		meta.fileName = getParam(pParams, 'file', '')
		//# check if contains &quot;bad&quot; characters (like &quot; or * ..for local paths only)
		meta.fileFormat = getParam(pParams, 'format', 'text')
		meta.isPlugin = getFlag(pParams, 'plugin') //# allow just &quot;plugin&quot; instead of &quot;plugin:true&quot;?
		const keepInternal = getParam(pParams, 'keepInternal')
		meta.keepInTW = !!keepInternal &amp;&amp; keepInternal !== 'false' //# ~
		this.registerExternal(meta)

		// visual feedback
		const macroText = wikifier.source.substring(wikifier.matchStart, wikifier.nextMatch)
		createTiddlyText(place, 'external ')
		createTiddlyLink(place, meta.tiddlerName, true)
		createTiddlyText(place, ' (')
		createTiddlyElement(place, 'code', '', '', macroText.slice(2 + macroName.length + 1, -2))
		createTiddlyText(place, ')')
	},
	// describes tiddlers registered as external, not necessarily loaded
	tiddlersMeta: [],
	registerExternal: function(meta) {
		//# check if already registered, don't register twice
		this.tiddlersMeta.push(meta)
	},
	getMetaFor: function(tiddlerOrTitle) {
		const isTitle = typeof tiddlerOrTitle == &quot;string&quot;
		for(meta of this.tiddlersMeta)
			if(isTitle &amp;&amp; meta.tiddlerName == tiddlerOrTitle ||
			  !isTitle &amp;&amp; meta.tiddler == tiddlerOrTitle)
				return meta
	},
	loadExternal: function(meta) {
		// sync loading fails on startup because TF injects new mozillaLoadFile too late
//		const tiddlerText = loadFile(getLocalPath(getFullPath(meta.fileName)));
//		onExternalTiddlerLoad(tiddlerText !== null, meta, tiddlerText);
		// so we use async instead:

		const callback = this.onExternalTiddlerLoad
		const path = getFullPath(meta.fileName, meta.tiddlerName, this.getExtension(meta))
		// httpReq(&quot;GET&quot;, path, callback, meta) uses default dataType,
		// which causes js to get evaluated on load. To avoid this, we customize the ajax call:
		jQuery.ajax({
			type: &quot;GET&quot;,
			url: path,
			dataType: &quot;text&quot;,
			processData: false,
			cache: false,
			complete: function(xhr, textStatus) {
				if((!xhr.status &amp;&amp; location.protocol === &quot;file:&quot;) || (xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status === 304)
					callback(true, meta, xhr.responseText, path, xhr)
				else
					callback(false, meta, null, path, xhr)
			}
		})
		//# rename onExternalTiddlerLoad into internalizeAndRegister?
	},
	onExternalTiddlerLoad: function(success, meta, responseText) {
		if(!success) return //# notify somehow? may fail because file is not created yet or ...
		const tiddler = config.macros.external.internalizeTiddler(meta, responseText)
		store.addTiddler(tiddler)
		//# what if tiddler already exists?
		if(meta.isPlugin) {
			// make it look normally
			tiddler.tags.pushUnique('systemConfig')
			const author = store.getTiddlerText(tiddler.title + &quot;::Author&quot;)
			if(author) {
				tiddler.creator = tiddler.creator || author
				tiddler.modifier = tiddler.modifier || tiddler.creator
			}

			eval(tiddler.text)
			// for plugins introducing macros, formatters etc (may be adjusted in the future)
			refreshAll()
		}
		//meta.lastLoaded = responseText
	},
	saveExternal: function(meta, callback) {
		const fullPath = getFullPath(meta.fileName, meta.tiddlerName, this.getExtension(meta))
		// we don't try to save remote files (yet)
		if(!isLocalAbsolutePath(fullPath)) {
			//# if(callback) callback(.., '[saving remote is not supported]')
			return
		}
		const localPath = getLocalPath(fullPath)

		const contentToSave = this.externalizeTiddler(meta)
		// save only if have something to save
		//if(contentToSave != meta.lastLoaded) {
			saveFile(localPath, contentToSave)
			//# get result of saving, return it
			//# or move externalizing into a separate helper?
		//	meta.lastLoaded = contentToSave
			//# this assumes saving didn't fail, which may be wrong
		//}

		//# if(callback) callback(.., '[...]')
	},
	saveAll: function() {
		let overallSuccess = true
		for(let meta of this.tiddlersMeta) {
			// a tiddler may got created after registration
			if(!meta.tiddler) {
				let tiddlerInStore = store.fetchTiddler(meta.tiddlerName)
				if(tiddlerInStore) {
					meta.tiddler = tiddlerInStore
				} else
					// tiddler doesn't exist and we do nothing
					continue
					//# based on config, we can show a warning instead
			}
			//# if(meta.tiddler.title != meta.tiddlerName)
			//  means tiddler got renamed â change meta.tiddlerName &amp;
			//  update this.listName . If store contains another tiddler
			//  with that name, still keep the registered one?
			overallSuccess = this.saveExternal(meta) &amp;&amp; overallSuccess
			//# if saving failed, do something! (.oO dirty, notifying)
		}
		return overallSuccess
	}
}

config.macros.exportByTag = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        const pParams = paramString.parseParams(&quot;tag&quot;, null, true)
        const tag = getParam(pParams, &quot;tag&quot;)
        if (!tag) {
            createTiddlyElement(place, &quot;span&quot;, null, &quot;error&quot;, &quot;&lt;&lt;exportByTag&gt;&gt; macro requires a 'tag' parameter.&quot;)
            return
        }

        const fileFormat = getParam(pParams, 'format', 'text')
        const filePathPrefix = getParam(pParams, 'file', '')

        const tiddlersToExport = store.getTaggedTiddlers(tag);
        
        createTiddlyElement(place, &quot;span&quot;, null, null, &quot;Exporting tiddlers with tag '&quot;)
        createTiddlyElement(place, &quot;b&quot;, null, null, tag)
        createTiddlyElement(place, &quot;span&quot;, null, null, &quot;':&quot;)
        const ul = createTiddlyElement(place, &quot;ul&quot;)

        let exportCount = 0;
        for (let i = 0; i &lt; tiddlersToExport.length; i++) {
            const currentTiddler = tiddlersToExport[i];
            const meta = {
                tiddlerName: currentTiddler.title,
                tiddler: currentTiddler,
                fileFormat: fileFormat,
                fileName: filePathPrefix, // Will be combined with tiddler name and extension
                keepInTW: true // Always keep in TW for this export function
            };

            const li = createTiddlyElement(ul, &quot;li&quot;)
            createTiddlyLink(li, currentTiddler.title, true)
            
            try {
                config.macros.external.saveExternal(meta);
                createTiddlyText(li, &quot; - Exported successfully.&quot;)
                exportCount++;
            } catch (e) {
                createTiddlyText(li, &quot; - Export failed: &quot; + e.message)
                displayMessage(&quot;Error exporting tiddler &quot; + currentTiddler.title + &quot;: &quot; + e.message);
            }
        }
        createTiddlyElement(place, &quot;p&quot;, null, null, &quot;Total exported: &quot; + exportCount + &quot; of &quot; + tiddlersToExport.length);
    }
};

//# see implementations in STP (share to the core?)
function isAbsolutePath(path) {
	// covers http:, https:, file:, other schemas, windows paths (D:\...)
	if(/^\w+\:/.exec(path)) return true
	// unix absolute paths, starting with /
	if(/^\//.exec(path)) return true
	return false
}
function isLocalAbsolutePath(path) {
	//# rename? we're going to check whether an absolute path is local, not path is absolute local
	return /^\w\:/.exec(path) || /^\//.exec(path) || /^file\:/.exec(path)
}
function getFullPath(subPath, nameFallback, extension) {
	const fileNamePosition = subPath.lastIndexOf('/') + 1
	const fileName = subPath.substr(fileNamePosition)
	if(fileName &amp;&amp; fileName.indexOf('.') == -1)
		subPath += '.' + extension
	if(!fileName)
		subPath += nameFallback + '.' + extension

	if(isAbsolutePath(subPath)) return subPath

	const url = window.location.toString()
	const base = url.substr(0, url.lastIndexOf('/') + 1)
	return base + subPath
}

//# ideally, don't save main store if it were not changed
if(!config.macros.external.orig_saveChanges) {
	config.macros.external.orig_saveChanges = saveChanges
	saveChanges = function(onlyIfDirty, tiddlers) {
		config.macros.external.saveAll()
		//# should we do smth about setDirty (if saving of a tiddler failed)?

		return config.macros.external.orig_saveChanges.apply(this, arguments)
	}
}

// hijack method of store (since not present in TiddlyWiki.prototype)
if(!config.macros.external.orig_deleteTiddler) {
	config.macros.external.orig_deleteTiddler = store.deleteTiddler
	store.deleteTiddler = function(title) {
		const registeredMeta = config.macros.external.getMetaFor(title)
		if(registeredMeta) registeredMeta.tiddler = null

		return config.macros.external.orig_deleteTiddler.apply(this, arguments)
	}
}
//}}}</pre>
</div>
<div title="TiddlerPopupMacro" modifier="FND" created="200711191518" modified="200711191650" tags="plugins macros sample systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711191650">
<pre>/***
|''Name''|TiddlerPopupMacro|
|''Version''|0.1|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TiddlerPopupMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Shows the contents of the specified tiddler in a popup.|
!Notes
This is a sample macro, created only for educational purposes.
!Usage
{{{
&lt;&lt;tiddlerPopup [tiddler name]&gt;&gt;
}}}
!!Example
&lt;&lt;tiddlerPopup [[ColorPalette]]&gt;&gt;
!Revision History
!!v0.1 (2007-11-19)
* initial release
!To Do
* parameters for {{{buttonClass}}}, {{{popupClass}}}, {{{id}}}, {{{accessKey}}}
* customizable order (title, tags, contents)
!Code
***/
//{{{
config.macros.tiddlerPopup = {
	label: &quot;label&quot;,
	tooltip: &quot;tooltip&quot;,
	buttonClass: null,
	id: null,
	accessKey: null
};

config.macros.tiddlerPopup.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = params[0] || tiddler.title;
	this.label = title;
	this.tooltip = &quot;show &quot; + title;
	createTiddlyButton(place, this.label, this.tooltip,
		function(e) { config.macros.tiddlerPopup.show(e, this, title) },
		this.buttonClass, this.id, this.accessKey);
};

config.macros.tiddlerPopup.show = function(ev, el, title) {
	// prevent event bubbling
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	// show tiddler contents
	var tiddler = store.getTiddler(title);
	var popup = Popup.create(el, &quot;div&quot;);
	if(tiddler) {
		var contents = &quot;tags: &quot; + tiddler.tags.join(&quot; &quot;) + &quot;\n----\n&quot;
			+ &quot;[[&quot; + tiddler.title + &quot;]]\n----\n&quot;
			+ tiddler.text;
	} else {
		if(store.getTiddlerText(title)) { // shadow tiddler
			var contents = &quot;[[&quot; + title + &quot;]]\n----\n&quot; + store.getTiddlerText(title);
		} else {
			var contents = &quot;Error: Tiddler [[&quot; + title + &quot;]] not found.&quot;;
		}
	}
	wikify(contents, popup);
	Popup.show();
}
//}}}</pre>
</div>
<div title="TiddlerPreviewPlugin" modifier="FND" created="200812061825" modified="200812061832" tags="plugins systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200812061832">
<pre>/***
|''Name''|TiddlerPreviewPlugin|
|''Description''|provides a toolbar command for previewing tiddlers in edit mode|
|''Author''|FND|
|''Contributors''|Saq Imtiaz|
|''Version''|0.2.5|
|''Status''|@@beta@@|
|''Source''|http://svn.tiddlywiki.org/contributors/FND/plugins/TiddlerPreviewPlugin.js|
|''CodeRepository''|http://svn.tiddlywiki.org/contributors/FND/|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''CoreVersion''|2.2|
!Usage
Previews are accessed via the {{{previewTiddler}}} command, which must be added to the [[tiddler toolbar|http://www.tiddlywiki.org/wiki/Tiddler_Toolbar]].
!Configuration Options
&lt;&lt;option chkPopupPreview&gt;&gt; use popup for preview
!Revision History
!!v0.2 (2008-12-06)
* initial release
!To Do
* styling inconsistencies in preview (e.g. tag buttons)
* disable in view mode
* smooth scrolling
!Code
***/
//{{{
if(!version.extensions.TiddlerPreviewPlugin) { //# ensure that the plugin is only installed once
version.extensions.TiddlerPreviewPlugin = { installed: true };

config.optionsDesc.chkPopupPreview = &quot;use popup for preview&quot;;

config.commands.previewTiddler = {
	text: &quot;preview&quot;,
	tooltip: &quot;preview tiddler contents&quot;,
	className: &quot;preview&quot;,

	handler: function(ev, src, title) {
		var tiddlerElem = story.findContainingTiddler(src);
		if(config.options.chkPopupPreview) {
			this.generatePopup(title, tiddlerElem, src, ev);
		} else {
			this.generatePane(title, tiddlerElem);
		}
		return false;
	},

	generatePane: function(title, tiddlerElem) {
		var containers = tiddlerElem.getElementsByTagName(&quot;div&quot;);
		var pane = containers[containers.length - 1];
		if(pane &amp;&amp; hasClass(pane, this.className)) {
			removeChildren(pane);
		} else {
			pane = createTiddlyElement(tiddlerElem, &quot;div&quot;, null,
				this.className + &quot; viewer&quot;);
		}
		this.displayPreview(pane, tiddlerElem, title);
		pane.ondblclick = function(ev) {
			window.scrollTo(0, ensureVisible(this.parentNode));
			stopEvent(ev);
			return false;
		};
		window.scrollTo(0, ensureVisible(pane));
	},

	generatePopup: function(title, tiddlerElem, src, ev) {
		var popup = Popup.create(src, &quot;div&quot;,
			this.className + &quot; popupTiddler viewer&quot;);
		this.displayPreview(popup, tiddlerElem, title);
		Popup.show();
		stopEvent(ev);
		return false;
	},

	displayPreview: function(container, tiddlerElem, title) {
		var tiddler = merge(new Tiddler(title), store.getTiddler(title));
		var newTitle = title;
		if(tiddlerElem) {
			var fields = {};
			story.gatherSaveFields(tiddlerElem, fields);
			tiddler.fields = store.tiddlerExists(newTitle) ?
				store.fetchTiddler(newTitle).fields :
				(newTitle != title &amp;&amp; store.tiddlerExists(title) ?
					store.fetchTiddler(title).fields :
					merge({}, config.defaultCustomFields));
			for(var p in fields) {
				if(TiddlyWiki.isStandardField(p)) {
					if(p == &quot;tags&quot;) {
						tiddler[p] = fields[p].readBracketedList();
					} else {
						tiddler[p] = fields[p];
					}
				} else {
					tiddler.fields[p] = fields[p];
				}
			}
			var template = story.chooseTemplateForTiddler(title, DEFAULT_VIEW_TEMPLATE);
			container.innerHTML = story.getTemplateForTiddler(title, template, tiddler);
			applyHtmlMacros(container, tiddler);
			forceReflow();
		}
	}
};

config.shadowTiddlers.StyleSheetPreview = (&quot;/*{{{*/\n&quot; +
	&quot;.%0 {\n&quot; +
	&quot;\tpadding: 5px;\n&quot; +
	&quot;\tbackground-color: #eee;\n&quot; +
	&quot;}\n\n&quot; +
	&quot;.%0 .toolbar {\n&quot; +
	&quot;\tdisplay: none;\n&quot; +
	&quot;}\n&quot; +
	&quot;/*}}}*/&quot;).format([config.commands.previewTiddler.className]);
store.addNotification(&quot;StyleSheetPreview&quot;, refreshStyles);

} //# end of &quot;install only once&quot;
//}}}
</pre>
</div>
<div title="TiddlerToCPlugin" modifier="FND" created="200705201300" modified="200802071536" tags="plugin test systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200802071536">
<pre>/***
|Name|TiddlerToCPlugin|
|Source|[[FND's DevPad|http://devpad.tiddlyspot.com/#TiddlerToCPlugin]]|
|Version|0.7|
|Author|FND|
|Contributors|[[Saq|http://tw.lewcid.org]]|
|License|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|N/A|
|Overrides|N/A|
|Description|create a table of contents from a tiddler's headings|
!Notes
Doug Compton has written a similar, though much more advanced plugin for this purpose, called [[DcTableOfContentsPlugin|http://devpad.tiddlyspot.com/#DcTableOfContentsPlugin]].
!Usage
Add {{{&lt;&lt;ToC&gt;&gt;}}} to the desired tiddler(s). Alternatively, a parameter can be used to display the table of contents for another tiddler: {{{&lt;&lt;ToC &quot;tiddlerName&quot;&gt;&gt;}}}.
The styling can be modified in the [[StyleSheetTableOfContents]] shadow tiddler.
&lt;&lt;ToC&gt;&gt;
!Changelog
!!v0.5a (2007-05-20)
* initial release
!!v0.5b (2007-05-20)
* renamed to TiddlerToCPlugin (to prevent confusion with the existing [[TableOfContentsPlugin|http://tiddlytools.com/#TableOfContentsPlugin]])
!!v0.6 (2007-05-21)
* several bugfixes and significant improvements regarding the macro code (thanks Saq)
!!v0.7 (2007-08-29)
* fixed error for tiddlers not containing any headings
!Issues / To Do
* add links to sections (problematic, as there are no anchors, yet?)
* introduce thresholds (minimum amount of headings to show a ToC, maximum depth)
!Code
***/
//{{{
/*
** Styles (can be customized in the StyleSheetTableOfContents shadow tiddler)
*/

config.shadowTiddlers.StyleSheetTableOfContents = &quot;/*{{{*/\n&quot;
	+ &quot;.ToC {\n\tfloat: left; /* auto-width */\n\tmargin: 0 2em 2em 0;\n\tborder: 1px solid #aaa;\n\tpadding: 5px;\n\tbackground-color: #eee;\n}\n\n&quot;
	+ &quot;.ToC ol {\n\tmargin: 0 1em;\n}\n\n&quot;
	+ &quot;h1 {\n\tclear: left;\n}\n&quot;
	+ &quot;/*}}}*/&quot;;
store.addNotification(&quot;StyleSheetTableOfContents&quot;, refreshStyles);

/*
** Macro Code
*/

config.macros.ToC = { label: &quot;Add Table of Contents&quot;, prompt: &quot;Add Table of Contents&quot; }; // DEBUG: obsolete?
config.macros.ToC.handler =
	function(place, macroName, params, wikifier, paramString, tiddler) {
		// process parameters
		if (params[0]) { // tiddler name
			tiddler = store.getTiddler(params[0]);
		}
		// create table of contents
		generateToC(place, tiddler);
		return false; // DEBUG: ?
}

/*
** Main Code
*/

generateToC = function(place, tiddler) {
	// retrieve headings
	var RegEx = /^!+(.*)$/gim;
	var tiddlerContents = tiddler.text.match(RegEx);
	// create ToC
	if(tiddlerContents) {
		var ToC = &quot;&quot;;
		for(var i = 0; i &lt; tiddlerContents.length; i++) {
			ToC += tiddlerContents[i] + &quot;\n&quot;;
		}
		// replace headings markup with list markup
		for(var i = 0; i &lt; 6; i++) { // DEBUG: inefficient!? (use a single RegEx instead? problem: JavaScript RegEx limitations)
			ToC = ToC.replace(/^(#*)!/gim, &quot;$1#&quot;);
		}
		// add ToC wrapper container
		ToC = &quot;{{ToC{\n''Table of Contents''\n&quot; + ToC + &quot;}}}\n&quot;;
		// add ToC to tiddler
		wikify(ToC, place);
	}
	return false;
}
//}}}</pre>
</div>
<div title="TiddlerToCTest" modifier="FND" created="200705201301" modified="200705211810" tags="test tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705211810">
<pre>This is the sandbox for testing the TiddlerToCPlugin.
The styling can be changed in the StyleSheetTableOfContents shadow tiddler.

Table of contents for the current tiddler:
&lt;&lt;ToC&gt;&gt;
@@display(block):clear(both):@@
Table of contents for the StyleSheet tiddler:
&lt;&lt;ToC &quot;StyleSheet&quot;&gt;&gt;
@@display(block):clear(both):@@
!Heading 1
Lorem ipsum dolor sit amet, consectetur adipisicing elit.
!!Heading 1-1
Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
!!Heading 1-2
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
!Heading 2
Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
!!Heading 2-1
Excepteur sint occaecat cupidatat non proident.
!!Heading 2-2
Sunt in culpa qui officia deserunt mollit anim id est laborum.</pre>
</div>
<div title="TiddlerWriteMacro" modifier="FND" created="200711191644" modified="200711191653" tags="plugins macros sample systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711191653">
<pre>/***
|''Name''|TiddlerWriteMacro|
|''Version''|0.1|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#TiddlerPopupMacro]]|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|Shows the contents of the specified tiddler.|
!Notes
This is a sample macro, created only for educational purposes.
!Usage
{{{
&lt;&lt;tiddlerWrite tiddlerName&gt;&gt;
}}}
!!Example
&lt;&lt;tiddlerWrite [[ColorPalette]]&gt;&gt;
!Revision History
!!v0.1 (2007-11-19)
* initial release
!Code
***/
//{{{
config.macros.tiddlerWrite = {};
config.macros.tiddlerWrite.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = params[0];
	if(title == tiddler.title) {
		title = &quot;Error: Can't use the same tiddler from which the macro is called (infinite recursion)!&quot;;
	}
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		var contents = &quot;tags: &quot; + tiddler.tags.join(&quot; &quot;) + &quot;\n----\n&quot;
			+ &quot;[[&quot; + tiddler.title + &quot;]]\n----\n&quot;
			+ tiddler.text;
	} else {
		if(store.getTiddlerText(title)) { // shadow tiddler
			var contents = &quot;[[&quot; + title + &quot;]]\n----\n&quot; + store.getTiddlerText(title);
		} else {
			var contents = &quot;Error: Tiddler [[&quot; + title + &quot;]] not found.&quot;;
		}
	}
	wikify(&quot;&lt;&lt;&lt;\n&quot; + contents + &quot;\n&lt;&lt;&lt;&quot;, place);
}
//}}}</pre>
</div>
<div title="TiddlyWiki" modifier="FND" created="200705081546" modified="200705081546" tags="meta" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200705081546">
<pre>[[TiddlyWiki]] - a reusable non-linear personal web notebook
http://www.tiddlywiki.com</pre>
</div>
<div title="ToggleElementMacro" modifier="FND" created="200709221914" modified="200711231607" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711231607">
<pre>/***
|''Name''|ToggleElementMacro|
|''Description''|toggles the visibility of the element specified|
|''Author''|FND|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#ToggleElementMacro]]|
|''Version''|0.6|
|''Status''|@@experimental@@|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion''|2.1|
!Notes
This macro was created for use with the [[overflow technique|http://cleanlayout.tiddlyspot.com/#StyleSheet]] (cf. [[[twdev] StyleSheetLayout: overflow technique|http://groups.google.at/group/TiddlyWikiDev/browse_thread/thread/b55011665c5e04d9/]]).
!Usage
{{{
&lt;&lt;toggleElement
	[element ID]
	[button label]
	[button tooltip]
	[button class]
	[button access key]
	[startup mode]
&gt;&gt;
}}}
All parameters are optional.
If the last parameter is {{{&quot;hide&quot;}}}, the respective element will be hidden when the macro is first rendered.
In order to use the default value for a certain property, the respective parameter can either be omitted or defined as empty by using {{{&quot;&quot;}}}.
!!Examples
|!Code|!Result|
|{{{&lt;&lt;toggleElement&gt;&gt;}}}| &lt;&lt;toggleElement&gt;&gt; |
|{{{&lt;&lt;toggleElement &quot;mainMenu&quot; &quot;Toggle MainMenu&quot; &quot;&quot; &quot;tiddlyLinkExisting&quot;&gt;&gt;}}}| &lt;&lt;toggleElement &quot;mainMenu&quot; &quot;Toggle MainMenu&quot; &quot;&quot; &quot;tiddlyLinkExisting&quot;&gt;&gt; |
|{{{&lt;&lt;toggleElement &quot;mainMenu&quot; &quot;Toggle MainMenu&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;hide&quot;&gt;&gt;}}}| &lt;&lt;toggleElement &quot;mainMenu&quot; &quot;Toggle MainMenu&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;hide&quot;&gt;&gt; |
!Revision History
!!v0.5 (2007-09-22)
* initial proof-of-concept implementation
!!v0.6 (2007-11-11)
* added parameter for hiding element by default
* renamed to [[ToggleElementMacro]] (from [[ToggleElementPlugin]])
!To Do
* use named parameters
* documentation (esp. parameters)
* separate button labels depending on element's toggle state
* add animations (using [[AnimationsLibrary]]; cf. [[ToggleElementPlugin (animated)]])
!Code
***/
//{{{
config.macros.toggleElement = {
	elementID: &quot;sidebar&quot;,
	label: &quot;Toggle Sidebar&quot;,
	prompt: &quot;Switch sidebar on and off&quot;,
	buttonClass: &quot;&quot;,
	accessKey: &quot;&quot;
};

config.macros.toggleElement.handler = function(place, macroName, params) {
	// process command line parameters
	var elementID = params[0] || this.elementID;
	var label = params[1] || this.label;
	var prompt = params[2] || this.prompt;
	var buttonClass = params[3] || this.buttonClass;
	var accessKey = params[4] || this.accessKey;
	// startup mode
	if(params[5] == &quot;hide&quot;) {
		this.toggle(elementID);
	}
	// create toggle button
	createTiddlyButton(place, label, prompt,
		function() { config.macros.toggleElement.toggle(elementID); },
		buttonClass, null, accessKey);
};

config.macros.toggleElement.toggle = function(id) {
	var e = document.getElementById(id);
	if(e) {
		if(e.style.display != &quot;none&quot;) {
			e.style.display = &quot;none&quot;;
		} else {
			e.style.display = &quot;&quot;;
		}
	}
};
//}}}</pre>
</div>
<div title="TspotSetupPlugin" modifier="YourName" created="200705140730" modified="200703221316" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200703221316">
<pre>/***
Required by Tiddlyspot
***/
//{{{

config.options.chkHttpReadOnly = false; // make it so you can by default see edit controls via http

if (window.location.protocol != &quot;file:&quot;)
	config.options.chkGTDLazyAutoSave = false; // disable autosave in d3

config.tiddlyspotSiteId = 'devpad';

// probably will need to redo this for TW 2.2
with (config.shadowTiddlers) {
	SiteUrl = 'http://'+config.tiddlyspotSiteId+'.tiddlyspot.com';
	SideBarOptions = SideBarOptions.replace(/(&lt;&lt;saveChanges&gt;&gt;)/,&quot;$1&lt;&lt;tiddler TspotSidebar&gt;&gt;&quot;);
	OptionsPanel = OptionsPanel.replace(/^/,&quot;&lt;&lt;tiddler TspotOptions&gt;&gt;&quot;);
	DefaultTiddlers = DefaultTiddlers.replace(/^/,&quot;[[Welcome to Tiddlyspot]] &quot;);
	MainMenu = MainMenu.replace(/^/,&quot;[[Welcome to Tiddlyspot]] &quot;);
}

merge(config.shadowTiddlers,{

'Welcome to Tiddlyspot':[
 &quot;This document is a ~TiddlyWiki from tiddlyspot.com.  A ~TiddlyWiki is an electronic notebook that is great for managing todo lists, personal information, and all sorts of things.&quot;,
 &quot;&quot;,
 &quot;@@font-weight:bold;font-size:1.3em;color:#444; //What now?// &amp;nbsp;&amp;nbsp;@@ Before you can save any changes, you need to enter your password in the form below.  Then configure privacy and other site settings at your [[control panel|http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/controlpanel]] (your control panel username is //&quot; + config.tiddlyspotSiteId + &quot;//).&quot;,
 &quot;&lt;&lt;tiddler TspotControls&gt;&gt;&quot;,
 &quot;See also GettingStarted.&quot;,
 &quot;&quot;,
 &quot;@@font-weight:bold;font-size:1.3em;color:#444; //Working online// &amp;nbsp;&amp;nbsp;@@ You can edit this ~TiddlyWiki right now, and save your changes using the \&quot;save to web\&quot; button in the column on the right.&quot;,
 &quot;&quot;,
 &quot;@@font-weight:bold;font-size:1.3em;color:#444; //Working offline// &amp;nbsp;&amp;nbsp;@@ A fully functioning copy of this ~TiddlyWiki can be saved onto your hard drive or USB stick.  You can make changes and save them locally without being connected to the Internet.  When you're ready to sync up again, just click \&quot;upload\&quot; and your ~TiddlyWiki will be saved back to tiddlyspot.com.&quot;,
 &quot;&quot;,
 &quot;@@font-weight:bold;font-size:1.3em;color:#444; //Help!// &amp;nbsp;&amp;nbsp;@@ Find out more about ~TiddlyWiki at [[TiddlyWiki.com|http://tiddlywiki.com]].  Also visit [[TiddlyWiki Guides|http://tiddlywikiguides.org]] for documentation on learning and using ~TiddlyWiki. New users are especially welcome on the [[TiddlyWiki mailing list|http://groups.google.com/group/TiddlyWiki]], which is an excellent place to ask questions and get help.  If you have a tiddlyspot related problem email [[tiddlyspot support|mailto:support@tiddlyspot.com]].&quot;,
 &quot;&quot;,
 &quot;@@font-weight:bold;font-size:1.3em;color:#444; //Enjoy :)// &amp;nbsp;&amp;nbsp;@@ We hope you like using your tiddlyspot.com site.  Please email [[feedback@tiddlyspot.com|mailto:feedback@tiddlyspot.com]] with any comments or suggestions.&quot;
].join(&quot;\n&quot;),

'TspotControls':[
 &quot;| tiddlyspot password:|&lt;&lt;option pasUploadPassword&gt;&gt;|&quot;,
 &quot;| site management:|&lt;&lt;upload http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/store.cgi index.html . .  &quot; + config.tiddlyspotSiteId + &quot;&gt;&gt;//(requires tiddlyspot password)//&lt;&lt;br&gt;&gt;[[control panel|http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/controlpanel]], [[download (go offline)|http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/download]]|&quot;,
 &quot;| links:|[[tiddlyspot.com|http://tiddlyspot.com/]], [[FAQs|http://faq.tiddlyspot.com/]], [[announcements|http://announce.tiddlyspot.com/]], [[blog|http://tiddlyspot.com/blog/]], email [[support|mailto:support@tiddlyspot.com]] &amp; [[feedback|mailto:feedback@tiddlyspot.com]], [[donate|http://tiddlyspot.com/?page=donate]]|&quot;
].join(&quot;\n&quot;),

'TspotSidebar':[
 &quot;&lt;&lt;upload http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/store.cgi index.html . .  &quot; + config.tiddlyspotSiteId + &quot;&gt;&gt;&lt;html&gt;&lt;a href='http://&quot; + config.tiddlyspotSiteId + &quot;.tiddlyspot.com/download' class='button'&gt;download&lt;/a&gt;&lt;/html&gt;&quot;
].join(&quot;\n&quot;),

'TspotOptions':[
 &quot;tiddlyspot password:&quot;,
 &quot;&lt;&lt;option pasUploadPassword&gt;&gt;&quot;,
 &quot;&quot;
].join(&quot;\n&quot;)

});
//}}}
</pre>
</div>
<div title="UploadLog" modifier="FND" created="200801101745" modified="201002091751" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="201002091751">
<pre>| !date | !user | !location | !storeUrl | !uploadDir | !toFilename | !backupdir | !origin | Ok |
| 10/1/2008 18:46:1 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 10/1/2008 18:52:39 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 10/1/2008 18:59:27 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |
| 10/1/2008 19:5:36 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 7/2/2008 16:37:2 | FND | [[/|http://devpad.tiddlyspot.com/#DcTableOfContentsPlugin]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 8/2/2008 23:32:5 | FND | [[/|http://devpad.tiddlyspot.com/#EvalMacro]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 10/2/2008 14:54:35 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 31/3/2008 8:16:25 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 18/4/2008 11:34:40 | FND | [[/|http://devpad.tiddlyspot.com/#EvalMacro]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 12/5/2008 14:22:20 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 30/5/2008 22:5:44 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 1/6/2008 3:35:5 | FND | [[/|http://devpad.tiddlyspot.com/#ConditionalTableFormattingMacro]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 16/7/2008 14:50:40 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 16/7/2008 14:51:19 | FND | [[/|http://devpad.tiddlyspot.com/#SearchTagPlugin]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 19/8/2008 15:59:49 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |
| 19/8/2008 16:11:27 | FND | [[/|http://devpad.tiddlyspot.com/#SimpleSearchPlugin]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 26/8/2008 13:26:43 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 15/10/2008 12:59:28 | FND | [[/|http://devpad.tiddlyspot.com/#DcTableOfContentsPlugin]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 29/10/2008 8:56:10 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 31/10/2008 16:28:9 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 4/11/2008 16:58:52 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 5/11/2008 13:2:29 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 26/11/2008 9:47:48 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 4/12/2008 15:39:45 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 6/12/2008 18:25:34 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |
| 6/12/2008 18:26:27 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 6/12/2008 18:33:5 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 25/1/2009 21:50:27 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 25/1/2009 21:51:26 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 19/3/2009 11:23:4 | FND | [[/|http://devpad.tiddlyspot.com/#eMailMacro%20templatesTest%20TagNavigatorTest%20SimpleCommentsTest%20TiddlerToCTest]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 6/5/2009 16:15:9 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 6/5/2009 18:56:0 | FND | [[/|http://devpad.tiddlyspot.com/#CommentsFormatter]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . | Ok |
| 6/5/2009 18:56:31 | FND | [[/|http://devpad.tiddlyspot.com/#CommentsFormatter]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 6/5/2009 20:32:22 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 7/5/2009 16:24:12 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 8/7/2009 10:45:16 | FND | [[/|http://devpad.tiddlyspot.com/]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |
| 9/2/2010 17:51:1 | FND | [[/|http://devpad.tiddlyspot.com/#SimpleSearchPlugin%20templatesTest%20TagNavigatorTest%20SimpleCommentsTest%20TiddlerToCTest]] | [[store.cgi|http://devpad.tiddlyspot.com/store.cgi]] | . | index.html | . |</pre>
</div>
<div title="UploadPlugin" modifier="YourName" created="200705140730" modified="200703200115" tags="systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200703200115">
<pre>/***
|''Name:''|UploadPlugin|
|''Description:''|Save to web a TiddlyWiki|
|''Version:''|3.4.5|
|''Date:''|Oct 15, 2006|
|''Source:''|http://tiddlywiki.bidix.info/#UploadPlugin|
|''Documentation:''|http://tiddlywiki.bidix.info/#UploadDoc|
|''Author:''|BidiX (BidiX (at) bidix (dot) info)|
|''License:''|[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D ]]|
|''~CoreVersion:''|2.0.0|
|''Browser:''|Firefox 1.5; InternetExplorer 6.0; Safari|
|''Include:''|config.lib.file; config.lib.log; config.lib.options; PasswordTweak|
|''Require:''|[[UploadService|http://tiddlywiki.bidix.info/#UploadService]]|
***/
//{{{
version.extensions.UploadPlugin = {
	major: 3, minor: 4, revision: 5, 
	date: new Date(2006,9,15),
	source: 'http://tiddlywiki.bidix.info/#UploadPlugin',
	documentation: 'http://tiddlywiki.bidix.info/#UploadDoc',
	author: 'BidiX (BidiX (at) bidix (dot) info',
	license: '[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D]]',
	coreVersion: '2.0.0',
	browser: 'Firefox 1.5; InternetExplorer 6.0; Safari'
};
//}}}

////+++!![config.lib.file]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.file) config.lib.file= {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 0}, 
	date: new Date(2006,3,9)
};
config.lib.file.dirname = function (filePath) {
	var lastpos;
	if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {
		return filePath.substring(0, lastpos);
	} else {
		return filePath.substring(0, filePath.lastIndexOf(&quot;\\&quot;));
	}
};
config.lib.file.basename = function (filePath) {
	var lastpos;
	if ((lastpos = filePath.lastIndexOf(&quot;#&quot;)) != -1) 
		filePath = filePath.substring(0, lastpos);
	if ((lastpos = filePath.lastIndexOf(&quot;/&quot;)) != -1) {
		return filePath.substring(lastpos + 1);
	} else
		return filePath.substring(filePath.lastIndexOf(&quot;\\&quot;)+1);
};
window.basename = function() {return &quot;@@deprecated@@&quot;;};
//}}}
////===

////+++!![config.lib.log]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.log) config.lib.log= {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 1}, 
	date: new Date(2006,8,19)
};
config.lib.Log = function(tiddlerTitle, logHeader) {
	if (version.major &lt; 2)
		this.tiddler = store.tiddlers[tiddlerTitle];
	else
		this.tiddler = store.getTiddler(tiddlerTitle);
	if (!this.tiddler) {
		this.tiddler = new Tiddler();
		this.tiddler.title = tiddlerTitle;
		this.tiddler.text = &quot;| !date | !user | !location |&quot; + logHeader;
		this.tiddler.created = new Date();
		this.tiddler.modifier = config.options.txtUserName;
		this.tiddler.modified = new Date();
	if (version.major &lt; 2)
		store.tiddlers[tiddlerTitle] = this.tiddler;
	else
		store.addTiddler(this.tiddler);
	}
	return this;
};

config.lib.Log.prototype.newLine = function (line) {
	var now = new Date();
	var newText = &quot;| &quot;;
	newText += now.getDate()+&quot;/&quot;+(now.getMonth()+1)+&quot;/&quot;+now.getFullYear() + &quot; &quot;;
	newText += now.getHours()+&quot;:&quot;+now.getMinutes()+&quot;:&quot;+now.getSeconds()+&quot; | &quot;;
	newText += config.options.txtUserName + &quot; | &quot;;
	var location = document.location.toString();
	var filename = config.lib.file.basename(location);
	if (!filename) filename = '/';
	newText += &quot;[[&quot;+filename+&quot;|&quot;+location + &quot;]] |&quot;;
	this.tiddler.text = this.tiddler.text + &quot;\n&quot; + newText;
	this.addToLine(line);
};

config.lib.Log.prototype.addToLine = function (text) {
	this.tiddler.text = this.tiddler.text + text;
	this.tiddler.modifier = config.options.txtUserName;
	this.tiddler.modified = new Date();
	if (version.major &lt; 2)
	store.tiddlers[this.tiddler.tittle] = this.tiddler;
	else {
		store.addTiddler(this.tiddler);
		story.refreshTiddler(this.tiddler.title);
		store.notify(this.tiddler.title, true);
	}
	if (version.major &lt; 2)
		store.notifyAll(); 
};
//}}}
////===

////+++!![config.lib.options]

//{{{
if (!config.lib) config.lib = {};
if (!config.lib.options) config.lib.options = {
	author: 'BidiX',
	version: {major: 0, minor: 1, revision: 0}, 
	date: new Date(2006,3,9)
};

config.lib.options.init = function (name, defaultValue) {
	if (!config.options[name]) {
		config.options[name] = defaultValue;
		saveOptionCookie(name);
	}
};
//}}}
////===

////+++!![PasswordTweak]

//{{{
version.extensions.PasswordTweak = {
	major: 1, minor: 0, revision: 3, date: new Date(2006,8,30),
	type: 'tweak',
	source: 'http://tiddlywiki.bidix.info/#PasswordTweak'
};
//}}}
/***
!!config.macros.option
***/
//{{{
config.macros.option.passwordCheckboxLabel = &quot;Save this password on this computer&quot;;
config.macros.option.passwordType = &quot;password&quot;; // password | text

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute(&quot;option&quot;);
	var elementType,valueField;
	if(opt) {
		switch(opt.substr(0,3)) {
			case &quot;txt&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;value&quot;;
				break;
			case &quot;pas&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;value&quot;;
				break;
			case &quot;chk&quot;:
				elementType = &quot;input&quot;;
				valueField = &quot;checked&quot;;
				break;
		}
		config.options[opt] = this[valueField];
		saveOptionCookie(opt);
		var nodes = document.getElementsByTagName(elementType);
		for(var t=0; t&lt;nodes.length; t++) 
			{
			var optNode = nodes[t].getAttribute(&quot;option&quot;);
			if (opt == optNode) 
				nodes[t][valueField] = this[valueField];
			}
		}
	return(true);
};

config.macros.option.handler = function(place,macroName,params)
{
    var opt = params[0];
    if(config.options[opt] === undefined) {
        return;}
    var c;
    switch(opt.substr(0,3)) {
		case &quot;txt&quot;:
			c = document.createElement(&quot;input&quot;);
			c.onkeyup = this.onChangeOption;
			c.setAttribute (&quot;option&quot;,opt);
			c.className = &quot;txtOptionInput &quot;+opt;
			place.appendChild(c);
			c.value = config.options[opt];
			break;
		case &quot;pas&quot;:
			// input password
			c = document.createElement (&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,config.macros.option.passwordType);
			c.onkeyup = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,opt);
			c.className = &quot;pasOptionInput &quot;+opt;
			place.appendChild(c);
			c.value = config.options[opt];
			// checkbox link with this password &quot;save this password on this computer&quot;
			c = document.createElement(&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);
			c.onclick = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,&quot;chk&quot;+opt);
			c.className = &quot;chkOptionInput &quot;+opt;
			place.appendChild(c);
			c.checked = config.options[&quot;chk&quot;+opt];
			// text savePasswordCheckboxLabel
			place.appendChild(document.createTextNode(config.macros.option.passwordCheckboxLabel));
			break;
		case &quot;chk&quot;:
			c = document.createElement(&quot;input&quot;);
			c.setAttribute(&quot;type&quot;,&quot;checkbox&quot;);
			c.onclick = this.onChangeOption;
			c.setAttribute(&quot;option&quot;,opt);
			c.className = &quot;chkOptionInput &quot;+opt;
			place.appendChild(c);
			c.checked = config.options[opt];
			break;
	}
};
//}}}
/***
!! Option cookie stuff
***/
//{{{
window.loadOptionsCookie_orig_PasswordTweak = window.loadOptionsCookie;
window.loadOptionsCookie = function()
{
	var cookies = document.cookie.split(&quot;;&quot;);
	for(var c=0; c&lt;cookies.length; c++) {
		var p = cookies[c].indexOf(&quot;=&quot;);
		if(p != -1) {
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			switch(name.substr(0,3)) {
				case &quot;txt&quot;:
					config.options[name] = unescape(value);
					break;
				case &quot;pas&quot;:
					config.options[name] = unescape(value);
					break;
				case &quot;chk&quot;:
					config.options[name] = value == &quot;true&quot;;
					break;
			}
		}
	}
};

window.saveOptionCookie_orig_PasswordTweak = window.saveOptionCookie;
window.saveOptionCookie = function(name)
{
	var c = name + &quot;=&quot;;
	switch(name.substr(0,3)) {
		case &quot;txt&quot;:
			c += escape(config.options[name].toString());
			break;
		case &quot;chk&quot;:
			c += config.options[name] ? &quot;true&quot; : &quot;false&quot;;
			// is there an option link with this chk ?
			if (config.options[name.substr(3)]) {
				saveOptionCookie(name.substr(3));
			}
			break;
		case &quot;pas&quot;:
			if (config.options[&quot;chk&quot;+name]) {
				c += escape(config.options[name].toString());
			} else {
				c += &quot;&quot;;
			}
			break;
	}
	c += &quot;; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/&quot;;
	document.cookie = c;
};
//}}}
/***
!! Initializations
***/
//{{{
// define config.options.pasPassword
if (!config.options.pasPassword) {
	config.options.pasPassword = 'defaultPassword';
	window.saveOptionCookie('pasPassword');
}
// since loadCookies is first called befor password definition
// we need to reload cookies
window.loadOptionsCookie();
//}}}
////===

////+++!![config.macros.upload]

//{{{
config.macros.upload = {
	accessKey: &quot;U&quot;,
	formName: &quot;UploadPlugin&quot;,
	contentType: &quot;text/html;charset=UTF-8&quot;,
	defaultStoreScript: &quot;store.php&quot;
};

// only this two configs need to be translated
config.macros.upload.messages = {
	aboutToUpload: &quot;About to upload TiddlyWiki to %0&quot;,
	backupFileStored: &quot;Previous file backuped in %0&quot;,
	crossDomain: &quot;Certainly a cross-domain isue: access to an other site isn't allowed&quot;,
	errorDownloading: &quot;Error downloading&quot;,
	errorUploadingContent: &quot;Error uploading content&quot;,
	fileLocked: &quot;Files is locked: You are not allowed to Upload&quot;,
	fileNotFound: &quot;file to upload not found&quot;,
	fileNotUploaded: &quot;File %0 NOT uploaded&quot;,
	mainFileUploaded: &quot;Main TiddlyWiki file uploaded to %0&quot;,
	passwordEmpty: &quot;Unable to upload, your password is empty&quot;,
	urlParamMissing: &quot;url param missing&quot;,
	rssFileNotUploaded: &quot;RssFile %0 NOT uploaded&quot;,
	rssFileUploaded: &quot;Rss File uploaded to %0&quot;
};

config.macros.upload.label = {
	promptOption: &quot;Save and Upload this TiddlyWiki with UploadOptions&quot;,
	promptParamMacro: &quot;Save and Upload this TiddlyWiki in %0&quot;,
	saveLabel: &quot;save to web&quot;, 
	saveToDisk: &quot;save to disk&quot;,
	uploadLabel: &quot;upload&quot;	
};

config.macros.upload.handler = function(place,macroName,params){
	// parameters initialization
	var storeUrl = params[0];
	var toFilename = params[1];
	var backupDir = params[2];
	var uploadDir = params[3];
	var username = params[4];
	var password; // for security reason no password as macro parameter
	var label;
	if (document.location.toString().substr(0,4) == &quot;http&quot;)
		label = this.label.saveLabel;
	else
		label = this.label.uploadLabel;
	var prompt;
	if (storeUrl) {
		prompt = this.label.promptParamMacro.toString().format([this.toDirUrl(storeUrl, uploadDir, username)]);
	}
	else {
		prompt = this.label.promptOption;
	}
	createTiddlyButton(place, label, prompt, 
						function () {
							config.macros.upload.upload(storeUrl, toFilename, uploadDir, backupDir, username, password); 
							return false;}, 
						null, null, this.accessKey);
};
config.macros.upload.UploadLog = function() {
	return new config.lib.Log('UploadLog', &quot; !storeUrl | !uploadDir | !toFilename | !backupdir | !origin |&quot; );
};
config.macros.upload.UploadLog.prototype = config.lib.Log.prototype;
config.macros.upload.UploadLog.prototype.startUpload = function(storeUrl, toFilename, uploadDir,  backupDir) {
	var line = &quot; [[&quot; + config.lib.file.basename(storeUrl) + &quot;|&quot; + storeUrl + &quot;]] | &quot;;
	line += uploadDir + &quot; | &quot; + toFilename + &quot; | &quot; + backupDir + &quot; |&quot;;
	this.newLine(line);
};
config.macros.upload.UploadLog.prototype.endUpload = function() {
	this.addToLine(&quot; Ok |&quot;);
};
config.macros.upload.basename = config.lib.file.basename;
config.macros.upload.dirname = config.lib.file.dirname;
config.macros.upload.toRootUrl = function (storeUrl, username)
{
	return root = (this.dirname(storeUrl)?this.dirname(storeUrl):this.dirname(document.location.toString()));
}
config.macros.upload.toDirUrl = function (storeUrl,  uploadDir, username)
{
	var root = this.toRootUrl(storeUrl, username);
	if (uploadDir &amp;&amp; uploadDir != '.')
		root = root + '/' + uploadDir;
	return root;
}
config.macros.upload.toFileUrl = function (storeUrl, toFilename,  uploadDir, username)
{
	return this.toDirUrl(storeUrl, uploadDir, username) + '/' + toFilename;
}
config.macros.upload.upload = function(storeUrl, toFilename, uploadDir, backupDir, username, password)
{
	// parameters initialization
	storeUrl = (storeUrl ? storeUrl : config.options.txtUploadStoreUrl);
	toFilename = (toFilename ? toFilename : config.options.txtUploadFilename);
	backupDir = (backupDir ? backupDir : config.options.txtUploadBackupDir);
	uploadDir = (uploadDir ? uploadDir : config.options.txtUploadDir);
	username = (username ? username : config.options.txtUploadUserName);
	password = config.options.pasUploadPassword; // for security reason no password as macro parameter
	if (!password || password === '') {
		alert(config.macros.upload.messages.passwordEmpty);
		return;
	}
	if (storeUrl === '') {
		storeUrl = config.macros.upload.defaultStoreScript;
	}
	if (config.lib.file.dirname(storeUrl) === '') {
		storeUrl = config.lib.file.dirname(document.location.toString())+'/'+storeUrl;
	}
	if (toFilename === '') {
		toFilename = config.lib.file.basename(document.location.toString());
	}

	clearMessage();
	// only for forcing the message to display
	 if (version.major &lt; 2)
		store.notifyAll();
	if (!storeUrl) {
		alert(config.macros.upload.messages.urlParamMissing);
		return;
	}
	// Check that file is not locked
	if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {
		if (BidiX.GroupAuthoring.lock.isLocked() &amp;&amp; !BidiX.GroupAuthoring.lock.isMyLock()) {
			alert(config.macros.upload.messages.fileLocked);
			return;
		}
	}
	
	var log = new this.UploadLog();
	log.startUpload(storeUrl, toFilename, uploadDir,  backupDir);
	if (document.location.toString().substr(0,5) == &quot;file:&quot;) {
		saveChanges();
	}
	var toDir = config.macros.upload.toDirUrl(storeUrl, toFilename, uploadDir, username);
	displayMessage(config.macros.upload.messages.aboutToUpload.format([toDir]), toDir);
	this.uploadChanges(storeUrl, toFilename, uploadDir, backupDir, username, password);
	if(config.options.chkGenerateAnRssFeed) {
		//var rssContent = convertUnicodeToUTF8(generateRss());
		var rssContent = generateRss();
		var rssPath = toFilename.substr(0,toFilename.lastIndexOf(&quot;.&quot;)) + &quot;.xml&quot;;
		this.uploadContent(rssContent, storeUrl, rssPath, uploadDir, '', username, password, 
			function (responseText) {
				if (responseText.substring(0,1) != '0') {
					displayMessage(config.macros.upload.messages.rssFileNotUploaded.format([rssPath]));
				}
				else {
					var toFileUrl = config.macros.upload.toFileUrl(storeUrl, rssPath, uploadDir, username);
					displayMessage(config.macros.upload.messages.rssFileUploaded.format(
						[toFileUrl]), toFileUrl);
				}
				// for debugging store.php uncomment last line
				//DEBUG alert(responseText);
			});
	}
	return;
};

config.macros.upload.uploadChanges = function(storeUrl, toFilename, uploadDir, backupDir, 
		username, password) {
	var original;
	if (document.location.toString().substr(0,4) == &quot;http&quot;) {
		original =  this.download(storeUrl, toFilename, uploadDir, backupDir, username, password);
		return;
	}
	else {
		// standard way : Local file
		
		original = loadFile(getLocalPath(document.location.toString()));
		if(window.Components) {
			// it's a mozilla browser
			try {
				netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
				var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]
									.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
				converter.charset = &quot;UTF-8&quot;;
				original = converter.ConvertToUnicode(original);
			}
			catch(e) {
			}
		}
	}
	//DEBUG alert(original);
	this.uploadChangesFrom(original, storeUrl, toFilename, uploadDir, backupDir, 
		username, password);
};

config.macros.upload.uploadChangesFrom = function(original, storeUrl, toFilename, uploadDir, backupDir, 
		username, password) {
	var startSaveArea = '&lt;div id=&quot;' + 'storeArea&quot;&gt;'; // Split up into two so that indexOf() of this source doesn't find it
	var endSaveArea = '&lt;/d' + 'iv&gt;';
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var posClosingDiv = original.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([document.location.toString()]));
		return;
		}
	var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + 
				allTiddlersAsHtml() + &quot;\n\t\t&quot; +
				original.substr(posClosingDiv);
	var newSiteTitle;
	if(version.major &lt; 2){
		newSiteTitle = (getElementText(&quot;siteTitle&quot;) + &quot; - &quot; + getElementText(&quot;siteSubtitle&quot;)).htmlEncode();
	} else {
		newSiteTitle = (wikifyPlain (&quot;SiteTitle&quot;) + &quot; - &quot; + wikifyPlain (&quot;SiteSubtitle&quot;)).htmlEncode();
	}

	revised = revised.replaceChunk(&quot;&lt;title&quot;+&quot;&gt;&quot;,&quot;&lt;/title&quot;+&quot;&gt;&quot;,&quot; &quot; + newSiteTitle + &quot; &quot;);
	revised = revised.replaceChunk(&quot;&lt;!--PRE-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPreHead&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--POST-HEAD-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-HEAD-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPostHead&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--PRE-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--PRE-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPreBody&quot;,&quot;&quot;) + &quot;\n&quot;);
	revised = revised.replaceChunk(&quot;&lt;!--POST-BODY-START--&quot;+&quot;&gt;&quot;,&quot;&lt;!--POST-BODY-END--&quot;+&quot;&gt;&quot;,&quot;\n&quot; + store.getTiddlerText(&quot;MarkupPostBody&quot;,&quot;&quot;) + &quot;\n&quot;);

	var response = this.uploadContent(revised, storeUrl, toFilename, uploadDir, backupDir, 
		username, password, function (responseText) {
					if (responseText.substring(0,1) != '0') {
						alert(responseText);
						displayMessage(config.macros.upload.messages.fileNotUploaded.format([getLocalPath(document.location.toString())]));
					}
					else {
						if (uploadDir !== '') {
							toFilename = uploadDir + &quot;/&quot; + config.macros.upload.basename(toFilename);
						} else {
							toFilename = config.macros.upload.basename(toFilename);
						}
						var toFileUrl = config.macros.upload.toFileUrl(storeUrl, toFilename, uploadDir, username);
						if (responseText.indexOf(&quot;destfile:&quot;) &gt; 0) {
							var destfile = responseText.substring(responseText.indexOf(&quot;destfile:&quot;)+9, 
							responseText.indexOf(&quot;\n&quot;, responseText.indexOf(&quot;destfile:&quot;)));
							toFileUrl = config.macros.upload.toRootUrl(storeUrl, username) + '/' + destfile;
						}
						else {
							toFileUrl = config.macros.upload.toFileUrl(storeUrl, toFilename, uploadDir, username);
						}
						displayMessage(config.macros.upload.messages.mainFileUploaded.format(
							[toFileUrl]), toFileUrl);
						if (backupDir &amp;&amp; responseText.indexOf(&quot;backupfile:&quot;) &gt; 0) {
							var backupFile = responseText.substring(responseText.indexOf(&quot;backupfile:&quot;)+11, 
							responseText.indexOf(&quot;\n&quot;, responseText.indexOf(&quot;backupfile:&quot;)));
							toBackupUrl = config.macros.upload.toRootUrl(storeUrl, username) + '/' + backupFile;
							displayMessage(config.macros.upload.messages.backupFileStored.format(
								[toBackupUrl]), toBackupUrl);
						}
						var log = new config.macros.upload.UploadLog();
						log.endUpload();
						store.setDirty(false);
						// erase local lock
						if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {
							BidiX.GroupAuthoring.lock.eraseLock();
							// change mtime with new mtime after upload
							var mtime = responseText.substr(responseText.indexOf(&quot;mtime:&quot;)+6);
							BidiX.GroupAuthoring.lock.mtime = mtime;
						}
						
						
					}
					// for debugging store.php uncomment last line
					//DEBUG alert(responseText);
				}
			);
};

config.macros.upload.uploadContent = function(content, storeUrl, toFilename, uploadDir, backupDir, 
		username, password, callbackFn) {
	var boundary = &quot;---------------------------&quot;+&quot;AaB03x&quot;;		
	var request;
	try {
		request = new XMLHttpRequest();
		} 
	catch (e) { 
		request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); 
		}
	if (window.netscape){
			try {
				if (document.location.toString().substr(0,4) != &quot;http&quot;) {
					netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead');}
			}
			catch (e) {}
		}		
	//DEBUG alert(&quot;user[&quot;+config.options.txtUploadUserName+&quot;] password[&quot; + config.options.pasUploadPassword + &quot;]&quot;);
	// compose headers data
	var sheader = &quot;&quot;;
	sheader += &quot;--&quot; + boundary + &quot;\r\nContent-disposition: form-data; name=\&quot;&quot;;
	sheader += config.macros.upload.formName +&quot;\&quot;\r\n\r\n&quot;;
	sheader += &quot;backupDir=&quot;+backupDir
				+&quot;;user=&quot; + username 
				+&quot;;password=&quot; + password
				+&quot;;uploaddir=&quot; + uploadDir;
	// add lock attributes to sheader
	if (window.BidiX &amp;&amp; BidiX.GroupAuthoring &amp;&amp; BidiX.GroupAuthoring.lock) {
		var l = BidiX.GroupAuthoring.lock.myLock;
		sheader += &quot;;lockuser=&quot; + l.user
				+ &quot;;mtime=&quot; + l.mtime
				+ &quot;;locktime=&quot; + l.locktime;
	}
	sheader += &quot;;;\r\n&quot;; 
	sheader += &quot;\r\n&quot; + &quot;--&quot; + boundary + &quot;\r\n&quot;;
	sheader += &quot;Content-disposition: form-data; name=\&quot;userfile\&quot;; filename=\&quot;&quot;+toFilename+&quot;\&quot;\r\n&quot;;
	sheader += &quot;Content-Type: &quot; + config.macros.upload.contentType + &quot;\r\n&quot;;
	sheader += &quot;Content-Length: &quot; + content.length + &quot;\r\n\r\n&quot;;
	// compose trailer data
	var strailer = new String();
	strailer = &quot;\r\n--&quot; + boundary + &quot;--\r\n&quot;;
	//strailer = &quot;--&quot; + boundary + &quot;--\r\n&quot;;
	var data;
	data = sheader + content + strailer;
	//request.open(&quot;POST&quot;, storeUrl, true, username, password);
	try {
		request.open(&quot;POST&quot;, storeUrl, true);		
	}
	catch(e) {
		alert(config.macros.upload.messages.crossDomain + &quot;\nError:&quot; +e);
		exit;
	}
	request.onreadystatechange = function () {
				if (request.readyState == 4) {
				     if (request.status == 200)
						callbackFn(request.responseText);
					else
						alert(config.macros.upload.messages.errorUploadingContent + &quot;\nStatus: &quot;+request.status.statusText);
				}
		};
	request.setRequestHeader(&quot;Content-Length&quot;,data.length);
	request.setRequestHeader(&quot;Content-Type&quot;,&quot;multipart/form-data; boundary=&quot;+boundary);
	request.send(data); 
};


config.macros.upload.download = function(uploadUrl, uploadToFilename, uploadDir, uploadBackupDir, 
	username, password) {
	var request;
	try {
		request = new XMLHttpRequest();
	} 
	catch (e) { 
		request = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); 
	}
	try {
		if (uploadUrl.substr(0,4) == &quot;http&quot;) {
			netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalBrowserRead&quot;);
			}
		else {
			netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
		}
	} catch (e) { }
	//request.open(&quot;GET&quot;, document.location.toString(), true, username, password);
	try {
		request.open(&quot;GET&quot;, document.location.toString(), true);
	}
	catch(e) {
		alert(config.macros.upload.messages.crossDomain + &quot;\nError:&quot; +e);
		exit;
	}
	
	request.onreadystatechange = function () {
		if (request.readyState == 4) {
			if(request.status == 200) {
				config.macros.upload.uploadChangesFrom(request.responseText, uploadUrl, 
					uploadToFilename, uploadDir, uploadBackupDir, username, password);
			}
			else
				alert(config.macros.upload.messages.errorDownloading.format(
					[document.location.toString()]) + &quot;\nStatus: &quot;+request.status.statusText);
		}
	};
	request.send(null);
};

//}}}
////===

////+++!![Initializations]

//{{{
config.lib.options.init('txtUploadStoreUrl','store.php');
config.lib.options.init('txtUploadFilename','');
config.lib.options.init('txtUploadDir','');
config.lib.options.init('txtUploadBackupDir','');
config.lib.options.init('txtUploadUserName',config.options.txtUserName);
config.lib.options.init('pasUploadPassword','');
setStylesheet(
	&quot;.pasOptionInput {width: 11em;}\n&quot;+
	&quot;.txtOptionInput.txtUploadStoreUrl {width: 25em;}\n&quot;+
	&quot;.txtOptionInput.txtUploadFilename {width: 25em;}\n&quot;+
	&quot;.txtOptionInput.txtUploadDir {width: 25em;}\n&quot;+
	&quot;.txtOptionInput.txtUploadBackupDir {width: 25em;}\n&quot;+
	&quot;&quot;,
	&quot;UploadOptionsStyles&quot;);
if (document.location.toString().substr(0,4) == &quot;http&quot;) {
	config.options.chkAutoSave = false; 
	saveOptionCookie('chkAutoSave');
}
config.shadowTiddlers.UploadDoc = &quot;[[Full Documentation|http://tiddlywiki.bidix.info/l#UploadDoc ]]\n&quot;; 

//}}}
////===

////+++!![Core Hijacking]

//{{{
config.macros.saveChanges.label_orig_UploadPlugin = config.macros.saveChanges.label;
config.macros.saveChanges.label = config.macros.upload.label.saveToDisk;

config.macros.saveChanges.handler_orig_UploadPlugin = config.macros.saveChanges.handler;

config.macros.saveChanges.handler = function(place)
{
	if ((!readOnly) &amp;&amp; (document.location.toString().substr(0,4) != &quot;http&quot;))
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
};

//}}}
////===

</pre>
</div>
<div title="eMailMacro" modifier="FND" created="200707050912" modified="200903191122" tags="plugins macros systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200903191122">
<pre>/***
|''Name''|eMailMacro|
|''Source''|[[FND's DevPad|http://devpad.tiddlyspot.com/#eMailMacro]]|
|''Version''|0.97|
|''Status''|stable|
|''Author''|Rick Magers, FND|
|''Contributors''|HeX|
|''License''|public domain|
|''~CoreVersion''|2.1|
|''Type''|macro|
|''Requires''|N/A|
|''Overrides''|N/A|
|''Description''|create an e-mail from tiddler contents|
!Usage
{{{
&lt;&lt;email
	[tiddler:&quot;name&quot;]
	[to:&quot;address&quot;]
	[cc:&quot;address&quot;]
	[bcc:&quot;address&quot;]
	[subject:&quot;text&quot;]
	[maxChars:&quot;number&quot;]
	[filterMacro:&quot;true&quot;]
	[label:&quot;text&quot;]
	[tooltip:&quot;text&quot;]
	[permalink:&quot;true&quot;]
	[class:&quot;customClass&quot;]
&gt;&gt;
}}}
All parameters are optional.
Multiple recipients can be added by separating the addresses with a comma.
!!Example
&lt;&lt;email subject:&quot;Hello World&quot; to:&quot;foo@bar.baz,bar@foo.baz&quot; label:&quot;mail to Foo&quot; tooltip:&quot;send this tiddler to Foo&quot; permalink:&quot;true&quot;&gt;&gt;
!!Adding the macro to the toolbar
After importing this plugin tiddler, the [[ViewTemplate]] needs to be modified by adding {{{&lt;span macro='email'&gt;&lt;/span&gt;}}} to the toolbar:
{{{
&lt;div class='toolbar'&gt;
&lt;span macro='toolbar newHere +editTiddler deleteTiddler permalink references jump closeOthers -closeTiddler'&gt;
&lt;span macro='email'&gt;&lt;/span&gt;
&lt;/div&gt;
}}}
(The respective version of the ViewTemplate might differ from the one displayed here.)
!Limitations
* limited number of characters for the message body (due to [[inherent limitations|http://www.boutell.com/newfaq/misc/urllength.html]] of {{{mailto:}}} links)
* the user's combination of browser and e-mail client needs to support the respective features of the mailto protocol
!Revision History
!!v0.1 (2007-06-16)
* initial release [[by Rick Magers|http://groups.google.com/group/TiddlyWiki/browse_thread/thread/ff7ae93cbe94345e/f6699532351f0802?#f6699532351f0802]]
!!v0.8 (2007-07-05)
* various modifications to enhance support for special characters ([[by FND and HeX|http://groups.google.com/group/TiddlyWikiDev/browse_thread/thread/ed196a32b295d2c9]])
!!v0.9 (2007-10-08)
* code refactoring
* added parameters for various fields
!!v0.91 (2007-10-10)
* fixed malformed mailto string (additional ampersand in some cases)
!!v0.95 (2007-12-27)
* added parameter for removing {{{&lt;&lt;email&gt;&gt;}}} macro calls from output (thanks [[ELS|http://www.tiddlytools.com]])
* using custom {{{escapeHTML()}}} function instead of {{{htmlDecode()}}}
!!v0.96 (2007-12-28)
* added parameter for specifying a target tiddler
* added parameter for limiting the number of characters returned from the tiddler body (default: 2000)
* some code refactoring
!!v0.97 (2009-03-19)
* added permalink parameter
!To Do
* documentation
* further enhance handling of special characters
!Code
***/
//{{{
(function() {

config.macros.email = {
	subject: &quot;default title&quot;,
	body: &quot;default contents&quot;,
	label: &quot;e-mail&quot;,
	tooltip: &quot;e-mail this tiddler&quot;,
	btnClass: &quot;button&quot;,
	maxChars: 2000
};

config.macros.email.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	// process parameters
	var prms = paramString.parseParams(null, null, true);
	var label = getParam(prms, &quot;label&quot;) || this.label;
	var tooltip = getParam(prms, &quot;tooltip&quot;) || this.tooltip;
	var btnClass = getParam(prms, &quot;class&quot;) || this.btnClass;
	var msgTo = getParam(prms, &quot;to&quot;);
	var msgCC = getParam(prms, &quot;cc&quot;);
	var msgBCC = getParam(prms, &quot;bcc&quot;);
	var msgSubject = getParam(prms, &quot;subject&quot;);
	var title = getParam(prms, &quot;tiddler&quot;) || tiddler.title;
	var filterMacro = getParam(prms, &quot;filterMacro&quot;) == &quot;true&quot;;
	var permalink = getParam(prms, &quot;permalink&quot;) == &quot;true&quot;;
	var maxChars = getParam(prms, &quot;maxChars&quot;) || this.maxChars;
	// retrieve tiddler contents
	if(!msgSubject) {
		if(store.getTiddler(title) || store.isShadowTiddler(title)) {
			msgSubject = strEscape(title);
		} else {
			msgSubject = this.subject;
		}
	}
	var msgBody = store.getTiddlerText(title, this.body);
	if(permalink) {
		config.commands.permalink.handler(null, null, tiddler.title); // XXX: hacky
		msgBody = window.location.toString() + &quot;\n\n&quot; + msgBody;
	}
	if(filterMacro) {
		msgBody = msgBody.replace(/&lt;&lt;email(.*|\n)?\&gt;\&gt;/gi, &quot;&quot;);
	}
	msgBody = strEscape(msgBody);
	// compose message
	var msg = &quot;&quot;;
	if(msgTo) {
		msg += msgTo;
	}
	msg += &quot;?&quot;;
	msg += &quot;subject=&quot; + msgSubject;
	if(msgCC) {
		msg += &quot;&amp;cc=&quot; + msgCC;
	}
	if(msgBCC) {
		msg += &quot;&amp;bcc=&quot; + msgBCC;
	}
	msg += &quot;&amp;body=&quot; + msgBody;
	if(msg.length &gt; maxChars) {
		msg = msg.substr(0, maxChars);
	}
	// create link
	wikify(&quot;[[&quot; + label + &quot;|&quot; + &quot;mailto:&quot; + msg + &quot;]]&quot;, place);
	place.lastChild.className = btnClass;
	place.lastChild.title = tooltip;
};

var strEscape = function(str) {
	return entitify(escape(escapeHTML(str)));
};

/* inspired by the Prototype library (http://prototype.conio.net) */
var escapeHTML = function(str) {
	var div = document.createElement(&quot;div&quot;);
	var text = document.createTextNode(str);
	div.appendChild(text);
	return div.innerHTML;
};

// handle special characters
var entitify = function(str) {
	return str
		.replace(/%A2/g, &quot;Â¢&quot;)
		.replace(/%A3/g, &quot;Â£&quot;)
		.replace(/%A5/g, &quot;Â¥&quot;)
		.replace(/%AB/g, &quot;Â«&quot;)
		.replace(/%BB/g, &quot;Â»&quot;)
		.replace(/%B5/g, &quot;Âµ&quot;)
		.replace(/%C4/g, &quot;Ã&quot;)
		.replace(/%C5/g, &quot;Ã&quot;)
		.replace(/%C6/g, &quot;Ã&quot;)
		.replace(/%D6/g, &quot;Ã&quot;)
		.replace(/%D8/g, &quot;Ã&quot;)
		.replace(/%DC/g, &quot;Ã&quot;)
		.replace(/%DF/g, &quot;Ã&quot;)
		.replace(/%E4/g, &quot;Ã¤&quot;)
		.replace(/%E5/g, &quot;Ã¥&quot;)
		.replace(/%E6/g, &quot;Ã¦&quot;)
		.replace(/%F0/g, &quot;Ã°&quot;)
		.replace(/%F6/g, &quot;Ã¶&quot;)
		.replace(/%F8/g, &quot;Ã¸&quot;)
		.replace(/%FC/g, &quot;Ã¼&quot;)
		.replace(/%u20AC/g, &quot;â¬&quot;);
};

})();
//}}}</pre>
</div>
<div title="newJournalHereMacro" modifier="FND" created="200711180848" modified="200711180848" tags="plugins macros experimental systemConfig" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200711180848">
<pre>/***
!Usage
{{{
&lt;&lt;newJournalHere&gt;&gt;
}}}
&lt;&lt;newJournalHere&gt;&gt;
***/
//{{{
config.macros.newJournalHere = {
	label: &quot;new journal&quot;,
	prompt: &quot;Create a new tiddler from the current date and time&quot;,
	accessKey: &quot;J&quot;
}

config.macros.newJournalHere.handler = function(place, macroName, params, wikifier, paramString, tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams(&quot;anon&quot;, null, true, false, false);
		var title = params[1] &amp;&amp; params[1].name == &quot;anon&quot; ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,&quot;title&quot;,title);
		title = tiddler.title + title;
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,&quot;text&quot;,true);
	}
};
//}}}</pre>
</div>
<div title="templatePopup" modifier="FND" created="200706020758" modified="200706020758" tags="template" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706020758">
<pre>/%
|Name|ShowPopup|
|Source|http://www.TiddlyTools.com/#ShowPopup|
|Version|1.0.2|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;&lt;br&gt;&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|transcluded html|
|Requires||
|Overrides||
|Description|display tiddler content in a TW popup|

usage: &lt;&lt;tiddler ShowPopup with: TiddlerName label tooltip buttonClass width popupClass&gt;&gt;

%/&lt;html&gt;&lt;a href=&quot;javascript:;&quot; class=&quot;$4&quot; title=&quot;$3&quot; onclick=&quot;var p=Popup.create(this); if (!p) return; var t=store.getTiddler('$1'); if (!t) return; p.className+=' $6'; var d=createTiddlyElement(p,'div'); d.style.whiteSpace='normal'; d.style.width='$5'; d.style.padding='2px'; wikify(t.text,d); Popup.show(p,false); event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation(); return(false);&quot;&gt;$2&lt;/a&gt;&lt;/html&gt;</pre>
</div>
<div title="templatesTest" modifier="FND" created="200706020800" modified="200706020801" tags="test tmp" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706020801">
<pre>dropdownPopup: &lt;&lt;tiddler [[templatePopup]] with: [[MainMenu]] &quot;MainMenu&quot; &quot;MainMenu&quot; &quot;tiddlyLinkExisting&quot; &quot;&quot; &quot;dropdownPopup&quot;&gt;&gt;
infoPopup: &lt;&lt;tiddler [[templatePopup]] with: [[TiddlyWiki]] &quot;TiddlyWiki&quot; &quot;TiddlyWiki&quot; &quot;tiddlyLinkExisting&quot; &quot;&quot; &quot;infoPopup&quot;&gt;&gt;</pre>
</div>
<div title="testTiddler" modifier="FND" created="200706111422" modified="200706111423" server.type="file" server.host="file:///home/stark/TiddlyWikiClassicPluginsArchives/devpad.html" server.page.revision="200706111423">
<pre>Type the text for 'New Tiddler'</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[

//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project repository at https://github.com/TiddlyWiki/tiddlywiki
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//
// JSLint directives
/*global jQuery:false, version:false */
/*jslint bitwise:true, browser:true, confusion:true, eqeq:true, evil:true, forin:true, maxerr:100, plusplus:true, regexp:true, sloppy:true, sub:true, undef:true, unparam:true, vars:true, white:true */

//--
//-- Global tw object (window.tw) exposing available methods and structures for developers
//--

window.tw = {
	assets: {
		icons: {}
	},
	io: {},
	textUtils: {}
};

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

config.adaptors = {};
config.defaultAdaptor = null;

// defines the order of the backstage tasks
config.backstageTasks = ["save", "importTask", "tweak", "upgrade", "plugins"];
// map by names from config.backstageTasks, defines their content (see Lingo.js and Backstage.js)
config.tasks = {};

config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkAnimate: true,
	chkAutoSave: false,
	chkBackstage: false,
	chkCaseSensitiveSearch: false,
	chkConfirmDelete: true,
	chkDisplayInstrumentation: false,
	chkForceMinorUpdate: false,
	chkGenerateAnRssFeed: false,
	chkHttpReadOnly: true,
	chkIncrementalSearch: true,
	chkInsertTabs: false,
	chkOpenInNewWindow: true,
	chkPreventAsyncSaving: true,
	chkRegExpSearch: false,
	chkRemoveExtraMarkers: false, // #162
	chkSaveBackups: true,
	chkSaveEmptyTemplate: false,
	chkSliderOptionsPanel: false,
	chkToggleLinks: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtFileSystemCharSet: "UTF-8",
	txtMainTab: "tabTimeline",
	txtMaxEditRows: "30",
	txtMoreTab: "moreTabAll",
	txtTheme: "",
	txtUpgradeCoreURI: ""
};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: { sizeTextbox: 15 },
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: { defaultView: "text" },
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "https://classic.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: { hideReadOnly: true },
	cancelTiddler: {},
	deleteTiddler: { hideReadOnly: true },
	permalink: {},
	references: { type: "popup" },
	jump: { type: "popup" },
	syncing: { type: "popup" },
	fields: { type: "popup" }
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
var isBadSafari = !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")); //# see 52678d4 and #22  ..remove at all?
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
// Moved navigator dependent code out of Config.js into a separate module. Helps with https://github.com/TiddlyWiki/tiddlywiki/issues/22
if(isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern =
	"(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b|\\[|\\])"; // #132
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter +
	"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead, "mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp =
	new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");
config.textPrimitives.tiddlerAnyLinkRegExp =
	new RegExp("(" + config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");

config.glyphs = {
	currBrowser: null,
	browsers: [],
	codes: {}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	SystemSettings: '',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields permalink references jump|\n' +
		'|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|', // #160
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	// config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	ieVersion: /MSIE (\d{1,2}.\d)/i.exec(config.userAgent),
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")),
	// config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent),
	isOpera: config.userAgent.indexOf("opera") != -1,
	isChrome: config.userAgent.indexOf('chrome') > -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

merge(config.glyphs, {
	browsers: [
		function() { return config.browser.isIE },
		function() { return true }
	],
	codes: {
		downTriangle: ["\u25BC", "\u25BE"],
		downArrow: ["\u2193", "\u2193"],
		bentArrowLeft: ["\u2190", "\u21A9"],
		bentArrowRight: ["\u2192", "\u21AA"]
	}
});

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options, {
	txtUserName: "YourName"
});

merge(config.tasks, {
	save: { text: "save", tooltip: "Save your changes to this TiddlyWiki" },
	importTask: { text: "import", tooltip: "Import tiddlers and plugins " +
		"from other TiddlyWiki files and servers", content: '<<importTiddlers>>' },
	tweak: { text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>' },
	upgrade: { text: "upgrade", tooltip: "Upgrade TiddlyWiki core", content: '<<upgrade>>' },
	plugins: { text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>' }
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc, {
	chkAnimate: "Enable animations",
	chkAutoSave: "Automatically save changes",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkOpenInNewWindow: "Open external links in a new window",
	chkPreventAsyncSaving: "Disable attempting async saving (may be needed by old plugins)",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkSaveBackups: "Keep backup file when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	txtBackupFolder: "Name of folder to use for backups",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	chkRemoveExtraMarkers: "Replace unused transclusion markers with blanks", // #162
	txtTheme: "Name of the theme to use",
	txtUpgradeCoreURI: "Custom URI to download TiddlyWiki core from (when upgrading)",
	txtUserName: "Username for signing your edits"
});

merge(config.messages, {
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see https://classic.tiddlywiki.com/#SaveUnpredictabilities for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "TiddlyWiki saved",
	mainDownload: "Downloading/saving main TiddlyWiki file",
	mainDownloadManual: "RIGHT CLICK HERE to download/save main TiddlyWiki file",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"
});

merge(config.messages.messageClose, {
	text: "close",
	tooltip: "close this message area"
});

config.messages.backstage = {
	open: { text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks" },
	close: { text: "close", tooltip: "Close the backstage area" },
	prompt: "backstage: ",
	decal: {
		edit: { text: "edit", tooltip: "Edit the tiddler '%0'" }
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June",
	"July", "August", "September", "October", "November", "December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = [
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"th", "th", "th", "th", "th", "th", "th", "th", "th", "th",
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"st"
];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup, {});

merge(config.views.wikified.tag, {
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"
});

merge(config.views.wikified, {
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"
});

merge(config.views.editor, {
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"
});

merge(config.views.editor.tagChooser, {
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"
});

merge(config.messages, {
	sizeTemplates: [
		{ unit: 1024 * 1024 * 1024, template: "%0\u00a0GB" },
		{ unit: 1024 * 1024, template: "%0\u00a0MB" },
		{ unit: 1024, template: "%0\u00a0KB" },
		{ unit: 1, template: "%0\u00a0B" }
	]
});

merge(config.macros.search, {
	label: "search",
	prompt: "Search this TiddlyWiki",
	placeholder: "",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"
});

merge(config.macros.tagging, {
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"
});

merge(config.macros.timeline, {
	dateFormat: "DD MMM YYYY"
});

merge(config.macros.allTags, {
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"
});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll, {
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"
});

merge(config.macros.permaview, {
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"
});

merge(config.macros.saveChanges, {
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"
});

merge(config.macros.newTiddler, {
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"
});

merge(config.macros.newJournal, {
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"
});

merge(config.macros.options, {
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br>" +
		"<label><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</label>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{ name: 'Option', field: 'option', title: "Option", type: 'String' },
			{ name: 'Description', field: 'description', title: "Description", type: 'WikiText' },
			{ name: 'Name', field: 'name', title: "Name", type: 'String' }
		],
		rowClasses: [
			{ className: 'lowlight', field: 'lowlight' }
		]
	}
});

merge(config.macros.plugins, {
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox' },
			{ name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	},
	listViewTemplateReadOnly: {
		columns: [
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	}
});

merge(config.macros.toolbar, {
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
});

merge(config.macros.refreshDisplay, {
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
});

merge(config.macros.importTiddlers, {
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>" +
		"Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>" +
		"...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>" +
		"...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: " +
		"<select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	errorGettingTiddlerListHttp404: "Error retrieving tiddlers from url, please ensure the url exists. Click Cancel to try again.",
	errorGettingTiddlerListHttp: "Error retrieving tiddlers from url, please " +
		"ensure this url exists and is <a href='http://enable-cors.org/'>CORS</a> enabled",
	errorGettingTiddlerListFile: "Error retrieving tiddlers from local file, " +
		"please make sure the file is in the same directory as your TiddlyWiki. Click Cancel to try again.",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>" +
		"Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br>" +
		"<input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' " +
		"to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\n" +
		"This tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Tags', field: 'tags', title: "Tags", type: 'Tags' }
		],
		rowClasses: []
	}
});

merge(config.macros.upgrade, {
	wizardTitle: "Upgrade TiddlyWiki",
	step1Title: "Update or repair TiddlyWiki core to the latest release",
	step1Html: "You are about to upgrade TiddlyWiki core to the latest release " +
		"(from <a href='%0' class='externalLink' target='_blank'>%1</a>). " +
		"Your content will be preserved across the upgrade.<br><br>" +
		"Note that core upgrades have been known to interfere with older plugins. " +
		"If you run into problems with upgrading, read how to handle them " +
		"<a href='%2' class='externalLink' target='_blank'>here</a>.",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>" +
		"You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	errorVerifyingBackup: "Failed to verify the backup was saved. " +
		"This is either because it wasn't saved to the moment of the check or " +
		"loading file doesn't work with your saver (and it is needed for " +
		"the next step of upgrading). To upgrade your TiddlyWiki, you can use " +
		"other methods listed at <a href='%0' class='externalLink' target='_blank'>%0</a>",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
});

merge(config.macros.annotations, {});

merge(config.commands.closeTiddler, {
	text: "close",
	tooltip: "Close this tiddler"
});

merge(config.commands.closeOthers, {
	text: "close others",
	tooltip: "Close all other tiddlers"
});

merge(config.commands.editTiddler, {
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"
});

merge(config.commands.saveTiddler, {
	text: "done",
	tooltip: "Save changes to this tiddler"
});

merge(config.commands.cancelTiddler, {
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"
});

merge(config.commands.deleteTiddler, {
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"
});

merge(config.commands.permalink, {
	text: "permalink",
	tooltip: "Permalink for this tiddler"
});

merge(config.commands.references, {
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"
});

merge(config.commands.jump, {
	text: "jump",
	tooltip: "Jump to another open tiddler"
});

merge(config.commands.fields, {
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{ name: 'Field', field: 'field', title: "Field", type: 'String' },
			{ name: 'Value', field: 'value', title: "Value", type: 'String' }
		],
		rowClasses: [],
		buttons: []
	}
});

merge(config.shadowTiddlers, {
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">>' +
		'<<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
});

merge(config.annotations, {
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. " +
		"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. " +
	"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "Options may be stored here using the slice notation (like {{{chkAutoSave: true}}} or {{{|txtUserName|The great inventor|}}})",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo, tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file can be saved back to the same location [Preemption]
window.allowSave = window.allowSave || function(l) {
	return true;
};

// Whether this file is being viewed locally
window.isLocal = function() {
	return (document.location.protocol == "file:");
};

var useJavaSaver = false;

// Allow preemption code a chance to tweak config and useJavaSaver [Preemption]
if (window.tweakConfig) window.tweakConfig();

if(!window || !window.console) {
	console = { tiddlywiki: true, log: function(message) { displayMessage(message) } };
}

// Starting up
function main() {
	window.originalHTML = recreateOriginal();

	var t10, t9, t8, t7, t6, t5, t4, t3, t2, t1, t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) { if(window.confirmExit) return confirmExit(); };
	params = getParameters();
	if(params) params = params.parseParams("open", null, false);
	store = new TiddlyWiki({ config: config });
	invokeParamifier(params, "oninit");
	story = new Story("tiddlerDisplay", "tiddler");
	addEvent(document, "click", Popup.onDocumentClick);
	saveTest();
	for(var i = 0; i < config.notifyTiddlers.length; i++)
		store.addNotification(config.notifyTiddlers[i].name, config.notifyTiddlers[i].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea", "store", true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params, "onload");
	t4 = new Date();
	readOnly = window.isLocal() ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params, "onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	for(var name in config.macros) {
		if(config.macros[name].init)
			config.macros[name].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null, "PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2 - t1) + " ms");
		displayMessage("LoadFromDiv " + (t3 - t2) + " ms");
		displayMessage("LoadPlugins " + (t5 - t4) + " ms");
		displayMessage("Macro init " + (t7 - t6) + " ms");
		displayMessage("Notify " + (t8 - t7) + " ms");
		displayMessage("Restart " + (t9 - t8) + " ms");
		displayMessage("Total: " + (t10 - t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. Functions may get unloaded too, so they are called conditionally.
function unload() {
	if(window.checkUnsavedChanges) checkUnsavedChanges();
	if(window.scrubNodes) scrubNodes(document.body);
}

// Restarting
function restart() {
	invokeParamifier(params, "onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0, 0);
}

function saveTest() {
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers() {
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea", "shadows", true);
	shadows.forEachTiddler(function(title, tiddler) { config.shadowTiddlers[title] = tiddler.text });
}

function loadPlugins(tag) {
	if(safeMode) return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1) });

	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i = 0; i < nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n) map[n] = p;
		n = p.Source;
		if(n) map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done) return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i = 0; i < reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i = 0; i < nPlugins; i++)
		visit(installedPlugins[i]);
	for(i = 0; i < toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text) window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler) {
	var p = store.getTiddlerSlices(tiddler.title, ["Name", "Description", "Version",
		"Requires", "CoreVersion", "Date", "Source", "Author", "License", "Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin) {
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0], 10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1], 10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2], 10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin) {
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

//--
//-- Paramifiers
//--

function getParameters() {
	return window.location.hash ? decodeURIComponent(window.location.hash.substr(1)) : null;
}

function invokeParamifier(params, handler) {
	if(!params || params.length == undefined || params.length <= 1)
		return;

	for(var i = 1; i < params.length; i++) {
		var name = params[i].name,
		    value = params[i].value;
		var p = config.paramifiers[name];
		if(p && p[handler] instanceof Function)
			p[handler](value);
		else {
			var h = config.optionHandlers[name.substr(0, 3)];
			if(h && h.set instanceof Function)
				h.set(name, value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(title) {
		if(!readOnly || store.tiddlerExists(title) || store.isShadowTiddler(title))
			story.displayTiddler("bottom", title, null, false, null);
	}
};

config.paramifiers.story = {
	onstart: function(title) {
		var list = store.getTiddlerText(title, "").parseParams("open", null, false);
		invokeParamifier(list, "onstart");
	}
};

config.paramifiers.search = {
	onstart: function(query) {
		story.search(query, false, false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v, false, true);
	}
};

config.paramifiers.tag = {
	onstart: function(tag) {
		story.displayTiddlers(null, store.filterTiddlers("[tag[" + tag + "]]"), null, false, null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(readOnly) return;
		var args = v.parseParams("anon", null, null)[0];
		var title = args.title ? args.title[0] : v;
		var customFields = args.fields ? args.fields[0] : null;

		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, customFields);
		story.focusTiddler(title, "text");
		var i, tags = args.tag || [];
		for(i = 0; i < tags.length; i++) {
			story.setTiddlerTag(title, tags[i], +1);
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(titleTemplate) {
		if(readOnly) return;
		var now = new Date();
		var title = now.formatString(titleTemplate.trim());
		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE);
		story.focusTiddler(title, "text");
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(themeTitle) {
		story.switchTheme(themeTitle);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent = {
	onstart: function(limit) {
		var titles = [];
		var i, tiddlers = store.getTiddlers("modified", "excludeLists").reverse();
		for(i = 0; i < limit && i < tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null, titles);
	}
};

config.paramifiers.filter = {
	onstart: function(filterExpression) {
		story.displayTiddlers(null, store.filterTiddlers(filterExpression), null, false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters) {
	this.formatters = [];
	var pattern = [];
	for(var n = 0; n < formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"), "mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w) {
		w.subWikifyTerm(createTiddlyElement(w.output, this.element), this.termRegExp);
	},

	inlineCssHelper: function(w) {
		// Convert CSS property name to a JavaScript style name ("background-color" -> "backgroundColor")
		var unDash = function(name) {
			return name
				.split("-")
				.map(function(word, i) {
					return i == 0 ? word :
						word.charAt(0).toUpperCase() + word.slice(1);
				})
				.join("");
		};
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s, v;
			if(lookaheadMatch[1]) {
				s = unDash(lookaheadMatch[1]);
				v = lookaheadMatch[2];
			} else {
				s = unDash(lookaheadMatch[3]);
				v = lookaheadMatch[4];
			}
			if(s == "bgcolor") s = "backgroundColor";
			if(s == "float") s = "cssFloat";
			styles.push({ style: s, value: v });
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e, styles) {
		for(var i = 0; i < styles.length; i++) {
			try {
				e.style[styles[i].style] = styles[i].value;
			} catch (ex) {}
		}
	},

	enclosedTextHelper: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE && (config.browser.ieVersion[1] < 10))
				text = text.replace(/\n/g, "\r");
			createTiddlyElement(w.output, this.element, null, null, text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link) {
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern, "mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".") != -1 ||
		   link.indexOf("\\") != -1 ||
		   link.indexOf("/") != -1 ||
		   link.indexOf("#") != -1
		) {
			return true;
		}
		return false;
	}
};

//--
//-- Standard formatters
//--

config.formatters = [
	{
		name: "table",
		match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
		lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
		rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
		cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
		cellTermRegExp: /((?:\x20*)\|)/mg,
		rowTypes: { "c": "caption", "h": "thead", "": "tbody", "f": "tfoot" },
		handler: function(w) {
			var table = createTiddlyElement(w.output, "table", null, "twtable");
			var prevColumns = [];
			var currRowType = null;
			var rowContainer;
			var rowCount = 0;
			var onmouseover = function() { jQuery(this).addClass("hoverRow") };
			var onmouseout = function() { jQuery(this).removeClass("hoverRow") };
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				var nextRowType = lookaheadMatch[2];
				if(nextRowType == "k") {
					table.className = lookaheadMatch[1];
					w.nextMatch += lookaheadMatch[0].length + 1;
				} else {
					if(nextRowType != currRowType) {
						rowContainer = createTiddlyElement(table, this.rowTypes[nextRowType]);
						currRowType = nextRowType;
					}
					if(currRowType == "c") {
						// Caption
						w.nextMatch++;
						if(rowContainer != table.firstChild)
							table.insertBefore(rowContainer, table.firstChild);
						rowContainer.setAttribute("align", rowCount == 0 ? "top" : "bottom");
						w.subWikifyTerm(rowContainer, this.rowTermRegExp);
					} else {
						var theRow = createTiddlyElement(rowContainer, "tr", null, rowCount % 2 ? "oddRow" : "evenRow");
						theRow.onmouseover = onmouseover;
						theRow.onmouseout = onmouseout;
						this.rowHandler(w, theRow, prevColumns);
						rowCount++;
					}
				}
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		},
		rowHandler: function(w, e, prevColumns) {
			var col = 0;
			var colSpanCount = 1;
			var prevCell = null;
			this.cellRegExp.lastIndex = w.nextMatch;
			var cellMatch = this.cellRegExp.exec(w.source);
			while(cellMatch && cellMatch.index == w.nextMatch) {
				if(cellMatch[1] == "~") {
					// Rowspan
					var last = prevColumns[col];
					if(last) {
						last.rowSpanCount++;
						last.element.setAttribute("rowspan", last.rowSpanCount);
						last.element.setAttribute("rowSpan", last.rowSpanCount); // Needed for IE
						last.element.valign = "center";
						if(colSpanCount > 1) {
							last.element.setAttribute("colspan", colSpanCount);
							last.element.setAttribute("colSpan", colSpanCount); // Needed for IE
							colSpanCount = 1;
						}
					}
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[1] == ">") {
					// Colspan
					colSpanCount++;
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[2]) {
					// End of row
					if(prevCell && colSpanCount > 1) {
						prevCell.setAttribute("colspan", colSpanCount);
						prevCell.setAttribute("colSpan", colSpanCount); // Needed for IE
					}
					w.nextMatch = this.cellRegExp.lastIndex;
					break;
				} else {
					// Cell
					w.nextMatch++;
					var styles = config.formatterHelpers.inlineCssHelper(w);
					var spaceLeft = false;
					var chr = w.source.substr(w.nextMatch, 1);
					while(chr == " ") {
						spaceLeft = true;
						w.nextMatch++;
						chr = w.source.substr(w.nextMatch, 1);
					}
					var cell;
					if(chr == "!") {
						cell = createTiddlyElement(e, "th");
						w.nextMatch++;
					} else {
						var isInsideHeader = e.parentElement.tagName.toLocaleLowerCase() === 'thead';
						cell = createTiddlyElement(e, isInsideHeader ? "th" : "td");
					}
					prevCell = cell;
					prevColumns[col] = { rowSpanCount: 1, element: cell };
					if(colSpanCount > 1) {
						cell.setAttribute("colspan", colSpanCount);
						cell.setAttribute("colSpan", colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
					config.formatterHelpers.applyCssHelper(cell, styles);
					w.subWikifyTerm(cell, this.cellTermRegExp);
					if(w.matchText.substr(w.matchText.length - 2, 1) == " ") // spaceRight
						cell.align = spaceLeft ? "center" : "left";
					else if(spaceLeft)
						cell.align = "right";
					w.nextMatch--;
				}
				col++;
				this.cellRegExp.lastIndex = w.nextMatch;
				cellMatch = this.cellRegExp.exec(w.source);
			}
		}
	},

	{
		name: "heading",
		match: "^!{1,6}",
		termRegExp: /(\n)/mg,
		handler: function(w) {
			w.subWikifyTerm(createTiddlyElement(w.output, "h" + w.matchLength), this.termRegExp);
		}
	},

	{
		name: "list",
		match: "^(?:[\\*#;:]+)",
		lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
		termRegExp: /(\n)/mg,
		handler: function(w) {
			// stack holds nested elements to which (nested) lists are appended
			var stack = [w.output];
			var currLevel = 0, currType = null;
			var listLevel, listType, itemType, baseType;
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				if(lookaheadMatch[1]) {
					listType = "ul";
					itemType = "li";
				} else if(lookaheadMatch[2]) {
					listType = "ol";
					itemType = "li";
				} else if(lookaheadMatch[3]) {
					listType = "dl";
					itemType = "dt";
				} else if(lookaheadMatch[4]) {
					listType = "dl";
					itemType = "dd";
				}
				if(!baseType)
					baseType = listType;
				listLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				var l;
				if(listLevel > currLevel) {
					for(l = currLevel; l < listLevel; l++) {
						var target = (currLevel == 0) ? stack[stack.length - 1] : stack[stack.length - 1].lastChild;
						stack.push(createTiddlyElement(target, listType));
					}
				} else if(listType != baseType && listLevel == 1) {
					w.nextMatch -= lookaheadMatch[0].length;
					return;
				} else if(listLevel < currLevel) {
					for(l = currLevel; l > listLevel; l--)
						stack.pop();
				} else if(listLevel == currLevel && listType != currType) {
					stack.pop();
					stack.push(createTiddlyElement(stack[stack.length - 1].lastChild, listType));
				}
				currLevel = listLevel;
				currType = listType;
				var itemElement = createTiddlyElement(stack[stack.length - 1], itemType);
				w.subWikifyTerm(itemElement, this.termRegExp);
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		}
	},

	{
		name: "quoteByBlock",
		match: "^<<<\\n",
		termRegExp: /(^<<<(\n|$))/mg,
		element: "blockquote",
		handler: config.formatterHelpers.createElementAndWikify
	},

	{
		name: "quoteByLine",
		match: "^>+",
		lookaheadRegExp: /^>+/mg,
		termRegExp: /(\n)/mg,
		element: "blockquote",
		handler: function(w) {
			var stack = [w.output];
			var currLevel = 0;
			var newLevel = w.matchLength;
			var l, matched;
			do {
				if(newLevel > currLevel) {
					for(l = currLevel; l < newLevel; l++)
						stack.push(createTiddlyElement(stack[stack.length - 1], this.element));
				} else if(newLevel < currLevel) {
					for(l = currLevel; l > newLevel; l--)
						stack.pop();
				}
				currLevel = newLevel;
				w.subWikifyTerm(stack[stack.length - 1], this.termRegExp);
				createTiddlyElement(stack[stack.length - 1], "br");
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
				matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
				if(matched) {
					newLevel = lookaheadMatch[0].length;
					w.nextMatch += lookaheadMatch[0].length;
				}
			} while(matched);
		}
	},

	{
		name: "rule",
		match: "^----+$\\n?|<hr ?/?>\\n?",
		handler: function(w) {
			createTiddlyElement(w.output, "hr");
		}
	},

	{
		name: "monospacedByLine",
		match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
		element: "pre",
		handler: function(w) {
			switch(w.matchText) {
				case "/*{{{*/\n": // CSS
					this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
					break;
				case "{{{\n": // monospaced block
					this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
					break;
				case "//{{{\n": // plugin
					this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
					break;
				case "<!--{{{-->\n": //template
					this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
					break;
				default:
					break;
			}
			config.formatterHelpers.enclosedTextHelper.call(this, w);
		}
	},

	{
		name: "wikifyComment",
		match: "^(?:/\\*\\*\\*|<!---)\\n",
		handler: function(w) {
			var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
			w.subWikifyTerm(w.output, termRegExp);
		}
	},

	{
		name: "macro",
		match: "<<",
		lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
				w.nextMatch = this.lookaheadRegExp.lastIndex;
				invokeMacro(w.output, lookaheadMatch[1], lookaheadMatch[2], w, w.tiddler);
			}
		}
	},

	{
		name: "prettyLink",
		match: "\\[\\[",
		lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var e;
				var text = lookaheadMatch[1];
				if(lookaheadMatch[3]) {
					// Pretty bracketted link
					var link = lookaheadMatch[3];
					e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link))
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
				} else {
					// Simple bracketted link
					e = createTiddlyLink(w.output, text, false, null, w.isStatic, w.tiddler);
				}
				createTiddlyText(e, text);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "wikiLink",
		match: config.textPrimitives.unWikiLink + "?" + config.textPrimitives.wikiLink,
		handler: function(w) {
			if(w.matchText.substr(0, 1) == config.textPrimitives.unWikiLink) {
				w.outputText(w.output, w.matchStart + 1, w.nextMatch);
				return;
			}
			if(w.matchStart > 0) {
				var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict, "mg");
				preRegExp.lastIndex = w.matchStart - 1;
				var preMatch = preRegExp.exec(w.source);
				if(preMatch.index == w.matchStart - 1) {
					w.outputText(w.output, w.matchStart, w.nextMatch);
					return;
				}
			}
			if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
				var link = createTiddlyLink(w.output, w.matchText, false, null, w.isStatic, w.tiddler);
				w.outputText(link, w.matchStart, w.nextMatch);
			} else {
				w.outputText(w.output, w.matchStart, w.nextMatch);
			}
		}
	},

	{
		name: "urlLink",
		match: config.textPrimitives.urlPattern,
		handler: function(w) {
			w.outputText(createExternalLink(w.output, w.matchText), w.matchStart, w.nextMatch);
		}
	},

	{
		name: "image",
		match: "\\[[<>]?[Ii][Mm][Gg]\\[",
		lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var container = w.output;
				var link = lookaheadMatch[5];
				if(link) {
					container = config.formatterHelpers.isExternalLink(link)
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
					jQuery(container).addClass("imageLink");
				}
				var img = createTiddlyElement(container, "img");
				if(lookaheadMatch[1])
					img.align = "left";
				else if(lookaheadMatch[2])
					img.align = "right";
				if(lookaheadMatch[3]) {
					img.title = lookaheadMatch[3];
					img.setAttribute("alt", lookaheadMatch[3]);
				}
				img.src = lookaheadMatch[4];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "html",
		match: "<[Hh][Tt][Mm][Ll]>",
		lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span").innerHTML = lookaheadMatch[1];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "commentByBlock",
		match: "/%",
		lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
				w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	},

	{
		name: "characterFormat",
		match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "''":
					w.subWikifyTerm(w.output.appendChild(document.createElement("strong")), /('')/mg);
					break;
				case "//":
					w.subWikifyTerm(createTiddlyElement(w.output, "em"), /(\/\/)/mg);
					break;
				case "__":
					w.subWikifyTerm(createTiddlyElement(w.output, "u"), /(__)/mg);
					break;
				case "^^":
					w.subWikifyTerm(createTiddlyElement(w.output, "sup"), /(\^\^)/mg);
					break;
				case "~~":
					w.subWikifyTerm(createTiddlyElement(w.output, "sub"), /(~~)/mg);
					break;
				case "--":
					w.subWikifyTerm(createTiddlyElement(w.output, "strike"), /(--)/mg);
					break;
				case "{{{":
					var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
						createTiddlyElement(w.output, "code", null, null, lookaheadMatch[1]);
						w.nextMatch = lookaheadRegExp.lastIndex;
					}
					break;
			}
		}
	},

	{
		name: "customFormat",
		match: "@@|\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "@@":
					var e = createTiddlyElement(w.output, "span");
					var styles = config.formatterHelpers.inlineCssHelper(w);
					if(styles.length == 0)
						e.className = "marked";
					else
						config.formatterHelpers.applyCssHelper(e, styles);
					w.subWikifyTerm(e, /(@@)/mg);
					break;
				case "{{":
					var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w-]*)[\s]*\{(\n?)/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch) {
						w.nextMatch = lookaheadRegExp.lastIndex;
						e = createTiddlyElement(w.output, lookaheadMatch[2] == "\n" ? "div" : "span", null, lookaheadMatch[1]);
						w.subWikifyTerm(e, /(\}\}\})/mg);
					}
					break;
			}
		}
	},

	{
		name: "mdash",
		match: "--",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = "&mdash;";
		}
	},

	{
		name: "lineBreak",
		match: "\\n|<br ?/?>",
		handler: function(w) {
			createTiddlyElement(w.output, "br");
		}
	},

	{
		name: "rawText",
		match: "\"{3}|<nowiki>",
		lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span", null, null, lookaheadMatch[1]);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "htmlEntitiesEncoding",
		match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)" +
			"(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*" +
			"(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+" +
			"|&#?[a-zA-Z0-9]{2,8};)",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = w.matchText;
		}
	}
];

//--
//-- Wikifier
//--

function getParser(tiddler, format) {
	if(tiddler) {
		if(!format) format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers)
				if(format == config.parsers[i].format)
					return config.parsers[i];
		} else {
			for(i in config.parsers)
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
		}
	}
	return formatter;
}

function Wikifier(source, formatter, highlightRegExp, tiddler) {
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function() {
	var e = createTiddlyElement(document.body, "div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(output, terminator) {
	try {
		if(terminator)
			this.subWikifyTerm(output, new RegExp("(" + terminator + ")", "mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output) {
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch;
	while(formatterMatch = this.formatter.formatterRegExp.exec(this.source)) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output, terminatorRegExp) {
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
		this.source.substr(0, terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output, this.nextMatch, terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
			this.source.substr(0, terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place, startPos, endPos) {
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) &&
		  (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place, this.source.substring(startPos, this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex, endPos);
		createTiddlyElement(place, "span", null, "highlight", this.source.substring(startPos, highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place, this.source.substring(startPos, endPos));
	}
};

function wikify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, getParser(tiddler), highlightRegExp, tiddler);
	var t0 = new Date();
	wikifier.subWikify(output);
	if(tiddler && config.options.chkDisplayInstrumentation)
		displayMessage("wikify:" + tiddler.title + " in " + (new Date() - t0) + " ms");
}

function wikifyStatic(source, highlightRegExp, tiddler, format) {
	if(!source) return "";
	if(!tiddler) tiddler = new Tiddler("temp");
	var wikifier = new Wikifier(source, getParser(tiddler, format), highlightRegExp, tiddler);
	wikifier.isStatic = true;

	var e = createTiddlyElement(document.body, "pre");
	e.style.display = "none";
	wikifier.subWikify(e);
	var html = e.innerHTML;
	jQuery(e).remove();
	return html;
}

function wikifyPlainText(text, limit, tiddler) {
	if(limit > 0)
		text = text.substr(0, limit);
	var wikifier = new Wikifier(text, formatter, null, tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, formatter, highlightRegExp, tiddler);
	wikifier.outputText(output, 0, source.length);
}

//--
//-- Macro definitions
//--

function invokeMacro(place, macro, params, wikifier, tiddler) {
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);

			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;

			var allowEval = true;
			if(config.evaluateMacroParameters == "system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place, macro, m.noPreParse ? null : params.readMacroParams(!allowEval), wikifier, params, tiddler);
		} else {
			createTiddlyError(place, config.messages.macroError.format([macro]),
				config.messages.macroErrorDetails.format([macro, config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place, config.messages.macroError.format([macro]),
			config.messages.macroErrorDetails.format([macro, ex.toString()]));
	}
}

config.macros.version.handler = function(place) {
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place, macroName, params) {
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";
config.macros.list.handler = function(place, macroName, params, wikifier, paramString) {
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	var template = args.template ? store.getTiddlerText(args.template[0]) : false;
	if(!template) {
		template = config.macros.list.template;
	}
	var results;
	if(this[type].handler)
		results = this[type].handler(params);

	jQuery(list).empty().addClass("list list-" + type);
	if(this[type].prompt)
		createTiddlyElement(list, "li", null, "listTitle", this[type].prompt);

	for(var i = 0; i < results.length; i++) {
		var li = createTiddlyElement(list, "li");
		var tiddler = results[i];
		if(typeof(tiddler) == 'string') { // deal with missing etc..
			tiddler = store.getTiddler(tiddler) || new Tiddler(tiddler);
		}
		wikify(template, li, null, tiddler);
	}
	if(results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params) {
	return store.reverseLookup("tags", "excludeLists", false, "title");
};

config.macros.list.missing.handler = function(params) {
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params) {
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params) {
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params) {
	return store.getTouched();
};

config.macros.list.filter.handler = function(params) {
	var filter = params[1];
	if(!filter) return [];
	return store.filterTiddlers(filter).map(function(tiddler) {
		return tiddler.title;
	});
};

config.macros.allTags.handler = function(place, macroName, params) {
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place, "ul");
	if(tags.length == 0) createTiddlyElement(ul, "li", null, "listTitle", this.noTags);

	for(var i = 0; i < tags.length; i++) {
		var title = tags[i][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul, "li");
		var btn = createTiddlyButton(li, title + " (" + tags[i][1] + ")",
			this.tooltip.format([title]), onClickTag, info.classes);
		btn.setAttribute("tag", title);
		btn.setAttribute("refresh", "link");
		btn.setAttribute("tiddlyLink", title);
		if(params[1]) btn.setAttribute("sortby", params[1]);
	}
};

var macro = config.macros.timeline;
merge(macro, {
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).
			attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var field = params[0] || "modified";
		var prefix = field.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? field.substr(1, field.length) : field;
		var dateFormat = params[2] || this.dateFormat;

		var groupTemplate = (args.groupTemplate ? store.getTiddlerText(args.groupTemplate[0]) : null)
			|| macro.groupTemplate.format(no_prefix_field, dateFormat);
		var itemTemplate = (args.template ? store.getTiddlerText(args.template[0]) : null)
			|| macro.itemTemplate;

		var tiddlers = args.filter ? store.sortTiddlers(store.filterTiddlers(args.filter[0]), field) :
			store.reverseLookup("tags", "excludeLists", false, field);
		var last = params[1] ? tiddlers.length - Math.min(tiddlers.length, parseInt(params[1], 10)) : 0;
		var lastGroup = "", ul;

		for(var i = tiddlers.length - 1; i >= last; i--) {
			var theGroup = wikifyPlainText(groupTemplate, 0, tiddlers[i]);
			if(ul === undefined || theGroup != lastGroup) {
				ul = createTiddlyElement(container, "ul", null, "timeline");
				createTiddlyElement(ul, "li", null, "listTitle", theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul, "li", null, "listLink");
			wikify(itemTemplate, item, null, tiddlers[i]);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>",
	itemTemplate: "<<view title link>>"
});

config.macros.tiddler.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length - 1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0, pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name", null, allowEval, false, true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];

	var wrapper = createTiddlyElement(place, "span", null, className, null, {
		refresh: "content", tiddler: tiddlerName
	});
	if(args !== undefined)
		wrapper.macroArgs = args; // #154
	this.transclude(wrapper, tiddlerName, args);
};

config.macros.tiddler.transclude = function(wrapper, tiddlerName, args) {
	var text = store.getTiddlerText(tiddlerName);
	if(!text) return;

	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1) return;

	stack.push(tiddlerName);
	try {
		// substitute $1, $2, .. placeholders (markers)
		if(typeof args == "string")
			args = args.readBracketedList();
		var maxSupportedPlaceholders = 9; // $1 - $9
		var n = args ? args.length : 0;
		for(var i = 0; i < maxSupportedPlaceholders; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1), "mg");
			if(i < n) {
				text = text.replace(placeholderRE, args[i]);
			}
			// #162
			else if(n && config.options.chkRemoveExtraMarkers) {
				text = text.replace(placeholderRE, "");
			}
		}

		config.macros.tiddler.renderText(wrapper, text, tiddlerName);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place, text, tiddlerName) {
	wikify(text, place, null, store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place, macroName, params) {
	var btn = createTagButton(place, params[0], null, params[1], params[2]);
	if(params[3]) btn.setAttribute('sortby', params[3]);
};

config.macros.tags.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params, "sep", " ");
	var lingo = config.views.wikified.tag;

	var ul = createTiddlyElement(place, "ul");
	createTiddlyElement(ul, "li", null, "listTitle",
		(tiddler.tags.length ? lingo.labelTags : lingo.labelNoTags).format([tiddler.title])
	);
	for(var i = 0; i < tiddler.tags.length; i++) {
		var tag = store.getTiddler(tiddler.tags[i]);
		if(tag && tag.tags.indexOf("excludeLists") != -1) continue;
		createTagButton(createTiddlyElement(ul, "li"), tiddler.tags[i], tiddler.title);
		if(i < tiddler.tags.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.tagging.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params, "sep", " ");
	var sortby = getParam(params, "sortBy", false);
	var tagged = store.getTaggedTiddlers(title, sortby);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;

	var ul = createTiddlyElement(place, "ul");
	ul.setAttribute("title", this.tooltip.format([title]));
	createTiddlyElement(ul, "li", null, "listTitle", prompt.format([title, tagged.length]));

	for(var i = 0; i < tagged.length; i++) {
		createTiddlyLink(createTiddlyElement(ul, "li"), tagged[i].title, true);
		if(i < tagged.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.closeAll.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.closeAll.onClick = function(e) {
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.permaview.onClick = function(e) {
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place, macroName, params) {
	if(!readOnly)
		createTiddlyButton(place, params[0] || this.label, params[1] || this.prompt, this.onClick, null, null, this.accessKey);
};

config.macros.saveChanges.onClick = function(e) {
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev) {
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n, !isOpen, null, "none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place, cookie, title, tooltip) {
	var c = cookie || "";
	createTiddlyButton(place, title, tooltip, this.onClickSlider);
	var panel = createTiddlyElement(null, "div", null, "sliderPanel");
	panel.setAttribute("cookie", c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place, macroName, params) {
	var panel = this.createSlider(place, params[0], params[2], params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh", "content");
	panel.setAttribute("tiddler", params[1]);
	if(text)
		wikify(text, panel, null, store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var panel = wikifier ? createTiddlyElement(place, "div", null, "gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel, styles);
	}
	params = paramString.parseParams("color");
	var loColors = [], hiColors = [];

	for(var i = 2; i < params.length; i++) {
		var c = params[i].value;
		if(params[i].name == "snap") {
			hiColors[hiColors.length - 1] = c;
		} else {
			loColors.push(c);
			hiColors.push(c);
		}
	}
	drawGradient(panel, params[1].value != "vert", loColors, hiColors);
	if(wikifier)
		wikifier.subWikify(panel, ">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place, macroName, params) {
	if(!params[0]) return;

	var names = params[0].split(".");
	var lookupMessage = function(root, nameIndex) {
		if(root[names[nameIndex]]) {
			if(nameIndex < names.length - 1)
				return (lookupMessage(root[names[nameIndex]], nameIndex + 1));
			else
				return root[names[nameIndex]];
		} else
			return null;
	};
	var m = lookupMessage(config, 0);
	if(m == null)
		m = lookupMessage(window, 0);
	createTiddlyText(place, m.toString().format(params.splice(1)));
};

config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value, place, params, wikifier, paramString, tiddler) {
		highlightify(value, place, highlightHack, tiddler);
	},
	link: function(value, place, params, wikifier, paramString, tiddler) {
		createTiddlyLink(place, value, true);
	},
	wikified: function(value, place, params, wikifier, paramString, tiddler) {
		if(config.macros.view.depth > 50)
			return;
		if(config.macros.view.depth > 0) {
			if (value == config.macros.view.values[config.macros.view.depth - 1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if(params[2])
			value = params[2].unescapeLineBreaks().format([value]);
		wikify(value, place, highlightHack, tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value, place, params, wikifier, paramString, tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place, value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler) || !params[0]) return;
	var value = store.getValue(tiddler, params[0]);
	if(!value) return;

	var type = params[1] || config.macros.view.defaultView;
	var handler = config.macros.view.views[type];
	if(handler)
		handler(value, place, params, wikifier, paramString, tiddler);
};

config.macros.edit.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var field = params[0];
	var rows = params[1] || 0;
	var defaultValue = params[2] || '';
	if(!(tiddler instanceof Tiddler) || !field) return;

	story.setDirty(tiddler.title, true);
	var e, value = store.getValue(tiddler, field) || defaultValue;
	if(field != "text" && !rows) {
		e = createTiddlyElement(place, "input", null, null, null, {
			type: "text", edit: field, size: "40", autocomplete: "off"
		});
		e.value = value;
	} else {
		rows = rows || 10;
		var lines = value.match(/\n/mg);
		var maxLines = Math.max(parseInt(config.options.txtMaxEditRows), 5);
		if(lines != null && lines.length > rows)
			rows = lines.length + 5;
		rows = Math.min(rows, maxLines);

		var wrapper1 = createTiddlyElement(null, "fieldset", null, "fieldsetFix");
		var wrapper2 = createTiddlyElement(wrapper1, "div");
		e = createTiddlyElement(wrapper2, "textarea");
		e.value = value;
		e.setAttribute("rows", rows);
		e.setAttribute("edit", field);
		place.appendChild(wrapper1);
	}
	if(tiddler.isReadOnly()) {
		e.setAttribute("readOnly", "readOnly");
		jQuery(e).addClass("readOnly");
	}
	return e;
};

config.macros.tagChooser.onClick = function(ev) {
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));

	for(var i = 0; i < tags.length; i++) {
		var tag = createTiddlyButton(createTiddlyElement(popup, "li"), tags[i][0],
			lingo.tagTooltip.format([tags[i][0]]), config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag", tags[i][0]);
		tag.setAttribute("tiddler", this.getAttribute("tiddler"));
	}
	if(tags.length == 0) jQuery("<li/>").addClass('disabled').text(lingo.popupNone).appendTo(popup);

	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev) {
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly) story.setTiddlerTag(title, tag, 0);
	return false;
};

config.macros.tagChooser.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler)) return;
	var lingo = config.views.editor.tagChooser;
	createTiddlyButton(place, lingo.text, lingo.tooltip, this.onClick, null, null, null, {
		tiddler: tiddler.title,
		tags: params[0]
	});
};

config.macros.refreshDisplay.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.refreshDisplay.onClick = function(e) {
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = tiddler ? tiddler.title : null;
	var annotation = title ? config.annotations[title] : null;
	if(!tiddler || !title || !annotation) return;
	var text = annotation.format([title]);
	wikify(text, createTiddlyElement(place, "div", null, "annotation"), null, tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(
	place, title, params, label, prompt, accessKey, newFocus, isJournal
) {
	label = getParam(params, "label", label);
	prompt = getParam(params, "prompt", prompt);
	accessKey = getParam(params, "accessKey", accessKey);
	var customFields = getParam(params, "fields", "");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var tags = [];
	for(var i = 1; i < params.length; i++) {
		if((params[i].name == "anon" && i != 1) || (params[i].name == "tag"))
			tags.push(params[i].value);
	}
	var text = getParam(params, "text");

	var btn = createTiddlyButton(place, label, prompt, this.onClickNewTiddler, null, null, accessKey, {
		newTitle: title,
		isJournal: isJournal ? "true" : "false",
		newFocus: getParam(params, "focus", newFocus),
		newTemplate: getParam(params, "template", DEFAULT_EDIT_TEMPLATE)
	});
	if(tags.length > 0)
		btn.setAttribute("params", tags.join("|"));
	if(customFields !== "")
		btn.setAttribute("customFields", customFields);
	if(text !== undefined)
		btn.setAttribute("newText", text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function() {
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);

	story.displayTiddler(this, title, template, false, null, null); // #161
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem, customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title, "text"))
		story.getTiddlerField(title, "text").value = text.format([title]);
	for(var i = 0; i < tags.length; i++)
		story.setTiddlerTag(title, tags[i], +1);
	story.focusTiddler(title, focus);
	return false;
};

config.macros.newTiddler.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
	title = getParam(params, "title", title);
	this.createNewTiddlerButton(place, title, params, this.label, this.prompt, this.accessKey, "title", false);
};

config.macros.newJournal.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
	title = getParam(params, "title", title);
	config.macros.newTiddler.createNewTiddlerButton(place, title,
		params, this.label, this.prompt, this.accessKey, "text", true);
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, false, false, false);
	createTiddlyButton(place, this.label, this.prompt, this.onClick, "button searchButton");

	var attributes = {
		size: this.sizeTextbox,
		accessKey: getParam(params, "accesskey", this.accessKey),
		autocomplete: "off",
		lastSearchText: "",
		placeholder: getParam(params, "placeholder", this.placeholder)
	};
	if(config.browser.isSafari) {
		attributes.type = "search";
		attributes.results = "5";
	} else {
		attributes.type = "text";
	}

	var input = createTiddlyElement(place, "input", null, "txtOptionInput searchField", null, attributes);
	input.value = getParam(params, "anon", "");
	input.onkeyup = this.onKeyPress;
	input.onfocus = this.onFocus;
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(input) {
	if(input.value.length == 0) return;
	story.search(input.value, config.options.chkCaseSensitiveSearch, config.options.chkRegExpSearch);
	input.setAttribute("lastSearchText", input.value);
};

config.macros.search.onClick = function(e) {
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev) {
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) clearTimeout(me.timeout);
				var input = this;
				me.timeout = setTimeout(function() { me.doSearch(input) }, 500);
			}
		} else {
			if(me.timeout) clearTimeout(me.timeout);
		}
	}
};

config.macros.search.onFocus = function(e) {
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place, macroName, params) {
	var cookie = params[0];
	var numTabs = (params.length - 1) / 3;
	var wrapper = createTiddlyElement(null, "div", null, "tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper, "div", null, "tabset");
	tabset.setAttribute("cookie", cookie);
	var validTab = false;
	for(var i = 0; i < numTabs; i++) {
		var label = params[i * 3 + 1];
		var prompt = params[i * 3 + 2];
		var content = params[i * 3 + 3];
		var tab = createTiddlyButton(tabset, label, prompt, this.onClickTab, "tab tabUnselected");
		createTiddlyElement(tab, "span", null, null, " ", { style: "font-size:0pt;line-height:0px" });
		tab.setAttribute("tab", label);
		tab.setAttribute("content", content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset, config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e) {
	config.macros.tabs.switchTab(this.parentNode, this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset, tab) {
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var i = 0; i < nodes.length; i++) {
		if(nodes[i].getAttribute && nodes[i].getAttribute("tab") == tab) {
			theTab = nodes[i];
			theTab.className = "tab tabSelected";
		} else {
			nodes[i].className = "tab tabUnselected";
		}
	}
	if(!theTab) return;

	if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
		jQuery(tabset.nextSibling).remove();
	var tabContent = createTiddlyElement(null, "div", null, "tabContents");
	tabset.parentNode.insertBefore(tabContent, tabset.nextSibling);
	var contentTitle = theTab.getAttribute("content");
	wikify(store.getTiddlerText(contentTitle), tabContent, null, store.getTiddler(contentTitle));
	if(cookie) {
		config.options[cookie] = tab;
		saveOption(cookie);
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place, commandName, tiddler, className) {
	if(!(tiddler instanceof Tiddler)) return;
	if(typeof commandName != "string") {
		for(var name in config.commands) {
			if(config.commands[name] == commandName)
				commandName = name;
		}
	}
	if(typeof commandName != "string") return;
	var command = config.commands[commandName];
	if(command.isEnabled ? !command.isEnabled(tiddler) : !this.isCommandEnabled(command, tiddler))
		return;

	var text = command.getText ? command.getText(tiddler) : this.getCommandText(command, tiddler);
	var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command, tiddler);
	var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
	var btn = createTiddlyButton(place, text, tooltip, cmd, "button command_" + commandName, null, null, {
		commandName: commandName,
		tiddler: tiddler.title
	});
	if(className) jQuery(btn).addClass(className);
	if(commandName === 'permalink') {
		jQuery(btn).attr('href', config.commands.permalink.getUrl(tiddler.title));
	}
};

config.macros.toolbar.isCommandEnabled = function(command, tiddler) {
	var title = tiddler.title;
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	if(shadow && command.hideShadow) return false;
	var ro = tiddler.isReadOnly();
	return !ro || (ro && !command.hideReadOnly);
};

config.macros.toolbar.getCommandText = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e, this, this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var title = this.getAttribute("tiddler");
	popup.setAttribute("tiddler", title);
	var command = config.commands[this.getAttribute("commandName")];
	command.handlePopup(popup, title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place, className, event) {
	var children = place.getElementsByTagName("a");
	for(var i = 0; i < children.length; i++) {
		var c = children[i];
		if(jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c, event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev) {
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev) {
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	for(var i = 0; i < params.length; i++) {
		var commandName = params[i];
		switch(commandName) {
			case "!":
				createTiddlyText(place, this.separator);
				break;
			case "*":
				createTiddlyElement(place, "br");
				break;
			case "<":
				createTiddlyButton(place, this.lessLabel, this.lessPrompt,
					config.macros.toolbar.onClickLess, "button lessCommand");
				break;
			case ">":
				createTiddlyButton(place, this.moreLabel, this.morePrompt,
					config.macros.toolbar.onClickMore, "button moreCommand");
				place = createTiddlyElement(place, "span", null, "moreCommand");
				place.style.display = "none";
				break;
			default:
				var className = "";
				switch(commandName.substring(0, 1)) {
					case "+":
						className = "defaultCommand";
						commandName = commandName.substring(1);
						break;
					case "-":
						className = "cancelCommand";
						commandName = commandName.substring(1);
						break;
				}
				if(config.commands[commandName]) {
					this.createCommand(place, commandName, tiddler, className);
				} else {
					this.customCommand(place, commandName, wikifier, tiddler);
				}
				break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place, command, wikifier, tiddler) {
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event, src, title) {
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.closeTiddler(title, true);
	return false;
};

config.commands.closeOthers.handler = function(event, src, title) {
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event, src, title) {
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, fields);

	var editorElement = story.getTiddlerField(title, config.options.txtEditorFocus || "text");
	if(editorElement) setCaretPosition(editorElement, 0);
	return false;
};

config.commands.saveTiddler.handler = function(event, src, title) {
	var newTitle = story.saveTiddler(title, event.shiftKey);
	if(newTitle) story.displayTiddler(null, newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event, src, title) {
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.displayTiddler(null, title);
	return false;
};

config.commands.deleteTiddler.handler = function(event, src, title) {
	var deleteIt = true;
	if(config.options.chkConfirmDelete) deleteIt = confirm(this.warning.format([title]));
	if(!deleteIt) return false;

	store.removeTiddler(title);
	story.closeTiddler(title, true);
	autoSaveChanges();
	return false;
};

config.commands.permalink.getUrl = function(title) {
	var hash = story.getPermaViewHash([title]);
	return window.location.href.replace(/#.*/, '') + hash;
};
config.commands.permalink.handler = function(event, src, title) {
	var hash = story.getPermaViewHash([title]);
	if(window.location.hash != hash) window.location.hash = hash;
	return false;
};

config.commands.references.handlePopup = function(popup, title) {
	var references = store.getReferringTiddlers(title);
	var hasRefs = false;
	for(var i = 0; i < references.length; i++) {
		if(references[i].title != title && !references[i].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup, "li"), references[i].title, true);
			hasRefs = true;
		}
	}
	if(!hasRefs) createTiddlyElement(popup, "li", null, "disabled", this.popupNone);
};

config.commands.jump.handlePopup = function(popup, title) {
	story.forEachTiddler(function(title, element) {
		createTiddlyLink(createTiddlyElement(popup, "li"), title, true, null, false, null, true);
	});
};

config.commands.fields.handlePopup = function(popup, title) {
	var tiddler = store.fetchTiddler(title);
	if(!tiddler) return;
	var items = [];
	store.forEachField(tiddler, function(tiddler, fieldName, value) {
		items.push({ field: fieldName, value: value });
	}, true);
	items.sort(function(a, b) { return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1) });

	if(items.length > 0) {
		ListView.create(popup, items, this.listViewTemplate);
	} else {
		createTiddlyElement(popup, "li", null, "disabled", this.emptyText);
	}
};

//--
//-- Tiddler() object
//--

function Tiddler(title) {
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function() {
	if(this.linksUpdated == false) this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function() {
	var f = {};
	for(var i in this.fields) {
		if(i == "server.host" || i == "server.workspace" || i == "wikiformat" || i == "server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function() {
	var c = this.fields['changecount'];
	c = c ? parseInt(c, 10) : 0;
	this.fields['changecount'] = String(c + 1);
};

Tiddler.prototype.clearChangeCount = function() {
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function() {
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function() {
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title, text, modifier, modified, tags, created, fields, creator) {
	this.assign(title, text, modifier, modified, tags, created, fields, creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title, text, modifier, modified, tags, created, fields, creator) {
	if(title != undefined) this.title = title;
	if(text != undefined) this.text = text;
	if(modifier != undefined) this.modifier = modifier;
	if(modified != undefined) this.modified = modified;
	if(creator != undefined) this.creator = creator;
	if(created != undefined) this.created = created;
	if(fields != undefined) this.fields = fields;
	if(tags != undefined) this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined) this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function() {
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag) {
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text) {
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function() {
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like .links array) after a change to a tiddler
Tiddler.prototype.changed = function() {
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g, "")
		.replace(/\{{3}((?:.|\n)*?)\}{3}/g, "")
		.replace(/"""((?:.|\n)*?)"""/g, "")
		.replace(/<nowiki\>((?:.|\n)*?)<\/nowiki\>/g, "")
		.replace(/<html\>((?:.|\n)*?)<\/html\>/g, "")
		.replace(/<script((?:.|\n)*?)<\/script\>/g, "");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t == 0 ?
		config.textPrimitives.tiddlerAnyLinkRegExp :
		config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t == 0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink + "|" +
					config.textPrimitives.anyLetter, "mg");
				preRegExp.lastIndex = formatMatch.index - 1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index - 1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2 - t] && !config.formatterHelpers.isExternalLink(formatMatch[3 - t]))
			// titledBrackettedLink
			this.links.pushUnique(formatMatch[3 - t]);
		else if(formatMatch[4 - t] && formatMatch[4 - t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4 - t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function() {
	var modifier = this.modifier || config.messages.subtitleUnknown || "";
	var modified = this.modified ?
		this.modified.toLocaleString() :
		config.messages.subtitleUnknown || "";
	var f = config.messages.tiddlerLinkTooltip || "%0 - %1, %2";
	return f.format([this.title, modifier, modified]);
};

Tiddler.prototype.isReadOnly = function() {
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function() {
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function() {
	var serverType = this.fields['server.type'] || this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType]) return null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function() {
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki(params) {
	var tiddlers = {}; // Hashmap by name of tiddlers
	if(params && params.config) {
		this.config = config;
	}
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var title in tiddlers) {
			var tiddler = tiddlers[title];
			if(tiddler instanceof Tiddler)
				callback.call(this, title, tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty) {
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function() {
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title) {
	return this.fetchTiddler(title) != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title) {
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.isAvailable = function(title) {
	if(!title) return false;
	var i = title.indexOf(config.textPrimitives.sectionSeparator);
	if(i != -1) title = title.substring(0, i);
	return this.tiddlerExists(title) || this.isShadowTiddler(title);
};

TiddlyWiki.prototype.createTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title) {
	return this.fetchTiddler(title) || null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title) {
	return (typeof config.shadowTiddlers[title] == "string")
		? config.shadowTiddlers[title]
		: "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title, defaultText) {
	if(!title) return defaultText;

	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0, pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var sliceNameStart = pos + config.textPrimitives.sliceSeparator.length;
		var slice = this.getTiddlerSlice(title.substr(0, pos), title.substr(sliceNameStart));
		if(slice) return slice;
	}

	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(!text) return defaultText != undefined ? defaultText : null;
	if(!section) return text;

	var headerRE = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)", "mg");
	headerRE.lastIndex = 0;
	var match = headerRE.exec(text);
	if(!match) return defaultText;

	var t = text.substr(match.index + match[1].length);
	var nextHeaderRE = /^!/mg;
	nextHeaderRE.lastIndex = 0;
	match = nextHeaderRE.exec(t);
	return !match ? t :
		// don't include final \n
		t.substr(0, match.index - 1);
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title, defaultText, depth) {
	var text = this.getTiddlerText(title, null);
	if(text == null) return defaultText;

	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])", "mg");
	var textOut = [], match, lastPos = 0;
	do {
		if(match = bracketRegExp.exec(text)) {
			textOut.push(text.substr(lastPos, match.index - lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1], "", depth - 1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|\x20?([\'\/]{0,2})~?([^\|\s\:\~\'\/]|(?:[^\|\s~\'\/][^\|\n\f\r]*[^\|\s\:\'\/]))\:?\4[\x20\t]*\|[\t\x20]*([^\n\t\x20](?:[^\n]*[^\n\t\x20])?)[\t\x20]*\|$)/gm; // #112
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title) {
	var text = this.getTiddlerText(title, "");
	this.slicesRE.lastIndex = 0;
	var slices = {}, m;
	while(m = this.slicesRE.exec(text)) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title, sliceName) {
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title, sliceNames) {
	var i, r = {};
	for(i = 0; i < sliceNames.length; i++) {
		var slice = this.getTiddlerSlice(title, sliceNames[i]);
		if(slice) r[sliceNames[i]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function() {
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function() {
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title, doBlanket) {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if((n.name == null && doBlanket) || (n.name == title))
			n.notify(title);
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function() {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if(n.name)
			n.notify(n.name);
	}
};

// Add a notification handler to a tiddler unless it's already set
TiddlyWiki.prototype.addNotification = function(title, fn) {
	for(var i = 0; i < this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({ name: title, notify: fn });
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title, true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title, true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title, status, tag) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	var t = tiddler.tags.indexOf(tag);
	if(t != -1)
		tiddler.tags.splice(t, 1);
	if(status)
		tiddler.tags.push(tag);

	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

TiddlyWiki.prototype.addTiddlerFields = function(title, fields) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	merge(tiddler.fields, fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(titleOrTiddler, newTitle, newBody,
	modifier, modified, tags, fields, clearChangeCount, created, creator) {
	var wasTiddlerProvided = titleOrTiddler instanceof Tiddler;
	var tiddler = this.resolveTiddler(titleOrTiddler);
	var title = tiddler ? tiddler.title : titleOrTiddler;
	newTitle = newTitle || title;

	if(tiddler) {
		this.deleteTiddler(title); //# clean up slices for title, make sure the tiddler is not copied when renamed
		created = created || tiddler.created; // Preserve created date
		creator = creator || tiddler.creator;
	} else {
		tiddler = new Tiddler();
		created = created || modified;
	}

	if(wasTiddlerProvided) {
		tiddler.fields = merge(merge({}, tiddler.fields), config.defaultCustomFields, true);
	} else {
		fields = merge(merge({}, fields), config.defaultCustomFields, true);
		tiddler.set(newTitle, newBody, modifier, modified, tags, created, fields, creator);
	}
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();

	this.addTiddler(tiddler); //# clean up slices for newTitle, add/return the tiddler
	if(title != newTitle) this.notify(title, true);
	this.notify(newTitle, true);
	this.setDirty(true);

	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function() {
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function() {
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function() {
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src, idPrefix, noUpdate) {
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem) return;

	this.idPrefix = idPrefix;
	var tiddlers = this.getLoader().loadTiddlers(this, storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0; i < tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text) {
	var posDiv = locateStoreArea(text);
	if(!posDiv) return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0], posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";

	// Create an iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6

	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();

	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea, "store");

	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function() {
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title, tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp, sortField, excludeTag, match) {
	var candidates = this.reverseLookup("tags", excludeTag, !!match);
	var i, results = [];
	for(i = 0; i < candidates.length; i++) {
		if((candidates[i].title.search(searchRegExp) != -1) || (candidates[i].text.search(searchRegExp) != -1))
			results.push(candidates[i]);
	}
	if(!sortField) sortField = "title";
	results.sort(function(a, b) { return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1) });
	return results;
};

// Returns a list of all tags in use (in the form of an array of [tagName, numberOfOccurances] "tuples")
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
TiddlyWiki.prototype.getTags = function(excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
	    var i, j;
		for(i = 0; i < tiddler.tags.length; i++) {
			var tag = tiddler.tags[i];
			var isTagToAdd = true;
			for(j = 0; j < results.length; j++) {
				if(results[j][0] == tag) {
					isTagToAdd = false;
					results[j][1]++;
				}
			}
			if(isTagToAdd && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					isTagToAdd = false;
			}
			if(isTagToAdd) results.push([tag, 1]);
		}
	});
	results.sort(function(a, b) {
		var tag1 = a[0].toLowerCase(), tag2 = b[0].toLowerCase();
		return tag1 < tag2 ? -1 : (tag1 == tag2 ? 0 : +1);
	});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag, sortField) {
	return this.reverseLookup("tags", tag, true, sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field, value, sortField) {
	return this.reverseLookup(field, value, true, sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title, unusedParameter, sortField) {
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links", title, true, sortField);
};

// Return an array of the tiddlers that have a specified entry (lookupValue) in the specified field (lookupField, like "links" or "tags")
// if shouldMatch == true, or don't have such entry (if shouldMatch == false)
TiddlyWiki.prototype.reverseLookup = function(lookupField, lookupValue, shouldMatch, sortField) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			var accessor = TiddlyWiki.standardFieldAccess[lookupField];
			values = accessor ? [ accessor.get(tiddler) ] :
				( tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [] );
		}

		var hasMatch = false;
		for(var i = 0; i < values.length; i++) {
			if(values[i] == lookupValue)
				hasMatch = true;
		}
		if(hasMatch == !!shouldMatch) results.push(tiddler);
	});
	return this.sortTiddlers(results, sortField || "title");
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field, excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field) results.sort(function(a, b) { return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1) });
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function() {
	if(!this.tiddlersUpdated) this.updateTiddlers();

	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;

		for(var i = 0; i < tiddler.links.length; i++) {
			var link = tiddler.links[i];
			if(this.getTiddlerText(link, null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function() {
	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function() {
	var t, results = [];
	for(t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function() {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
	});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler) {
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers, field) {
	var asc = +1;
	switch(field.substr(0, 1)) {
		case "-":
			asc = -1;
			field = field.substr(1);
			break;
		case "+":
			field = field.substr(1);
			break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field == "title") {
			tiddlers.sort(function(a, b) {
				var t1 = a[field].toLowerCase(), t2 = b[field].toLowerCase();
				return t1 < t2 ? -asc : (t1 == t2 ? 0 : asc);
			});
		} else {
			tiddlers.sort(function(a, b) {
				return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);
			});
		}
	} else {
		tiddlers.sort(function(a, b) {
			return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);
		});
	}
	return tiddlers;
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results, match) {
		var title = match[1] || match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title, this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results, match) {
		var i, matched = this.getTaggedTiddlers(match[3]);
		for(i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	},
	sort: function(results, match) {
		return this.sortTiddlers(results, match[3]);
	},
	limit: function(results, match) {
		return results.slice(0, parseInt(match[3], 10));
	},
	field: function(results, match) {
		var i, matched = this.getValueTiddlers(match[2], match[3]);
		for (i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter, results) {
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	results = results || [];
	if(filter) {
		var match;
		while(match = re.exec(filter)) {
			var handler = (match[1] || match[4]) ? 'tiddler' :
				config.filters[match[2]] ? match[2] : 'field';
			results = config.filters[handler].call(this, results, match);
		}
	}
	return results;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name) {
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name) {
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(fName, readOnly) {
	this.set = readOnly ?
		function(tiddler, newValue) {
			if(newValue != tiddler[fName]) throw config.messages.fieldCannotBeChanged.format([fName]);
		} :
		function(tiddler, newValue) {
			if(newValue == tiddler[fName]) return;
			tiddler[fName] = newValue;
			return true;
		};
	this.get = function(tiddler) { return tiddler[fName] };
}

function DateFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var d = newValue instanceof Date ? newValue : Date.convertFromYYYYMMDDHHMM(newValue);
		if(d == tiddler[fName]) return;
		tiddler[fName] = d;
		return true;
	};
	this.get = function(tiddler) { return tiddler[fName].convertToYYYYMMDDHHMM() };
}

function LinksFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var items = (typeof newValue == "string") ? newValue.readBracketedList() : newValue;
		if(items.toString() == tiddler[fName].toString()) return;
		tiddler[fName] = items;
		return true;
	};
	this.get = function(tiddler) { return String.encodeTiddlyLinkList(tiddler[fName]) };
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title", true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title", true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name) {
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddlerOrTitle, fieldName, value) {
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return;

	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		// don't remove StandardFields
		if(isRemove) return;
		if(!accessor.set(t, value)) return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^" + fieldName + "\\.");
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty) return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience convert Date -> String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value) return;
			t.fields[fieldName] = value;
		}
	}

	// When we are here the tiddler/store really was changed.
	this.notify(t.title, true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddlerOrTitle, fieldName) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	if(fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 ||
	   fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0
	) {
		var separator = fieldName.substr(0, 2);
		var partName = fieldName.substring(2);
		return store.getTiddlerText(t.title + separator + partName);
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = TiddlyWiki.standardFieldAccess[fieldName];
		if(accessor) return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler, fieldName, value).
TiddlyWiki.prototype.forEachField = function(tiddlerOrTitle, callback, onlyExtendedFields) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	var name, result;
	for(name in t.fields) {
		result = callback(t, name, t.fields[name]);
		if(result) return result;
	}

	if(onlyExtendedFields) return undefined;
	for(name in TiddlyWiki.standardFieldAccess) {
		// even though the "title" field can also be referenced through the name "tiddler"
		// we only visit this field once.
		if(name == "tiddler") continue;

		result = callback(t, name, TiddlyWiki.standardFieldAccess[name].get(t));
		if(result) return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

// A story is a HTML div containing a sequence of tiddlers that can be manipulated
//  container - id of containing element
//  idPrefix - string prefix prepended to title to make ids for tiddlers in this story
function Story(containerId, idPrefix) {
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		var validId = title.replace(/_/g, "__").replace(/ /g, "_");
		var id = this.idPrefix + validId;
		return id == this.container ? this.idPrefix + "_" + validId : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title) {
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function() {
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(handleTiddler) {
	var place = this.getContainer();
	if(!place) return;
	var el = place.firstChild;
	while(el) {
		var next = el.nextSibling;
		var title = el.getAttribute("tiddler");
		if(title) {
			handleTiddler.call(this, title, el);
		}
		el = next;
	}
};

Story.prototype.displayTiddler = function(srcElement, tiddler,
	template, animate, unused, customFields, toggle, animationSrc) {
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title, true);
		} else {
			this.refreshTiddler(title, template, false, customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place, before, title, template, customFields);
	}

	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim &&
		   typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title, srcElement, tiddlerElem), new Scroller(tiddlerElem));
		else
			window.scrollTo(0, ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.displayTiddlers = function(srcElement, titles, template, animate, unused, customFields, toggle) {
	for(var i = titles.length - 1; i >= 0; i--)
		this.displayTiddler(srcElement, titles[i], template, animate, unused, customFields);
};

Story.prototype.displayDefaultTiddlers = function() {
	this.displayTiddlers(null, store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.positionTiddler = function(srcElement) {
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place, before, title, template, customFields) {
	var tiddlerElem = createTiddlyElement(null, "div", this.tiddlerId(title), "tiddler");
	tiddlerElem.setAttribute("refresh", "tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields", customFields);
	place.insertBefore(tiddlerElem, before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title, customFields);
	this.refreshTiddler(title, template, false, customFields, defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title, fields, callback) {
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields || {};
	var context = { serverType: tiddler.getServerType() };
	if(!context.serverType) return "";
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType]();

	var onLoadTiddlerResponse = function(context) {
		if(context.status) {
			var t = context.tiddler;
			t.created  = t.created  || new Date();
			t.modified = t.modified || t.created;
			var dirty = store.isDirty();
			context.tiddler = store.saveTiddler(t.title, t.title, t.text, t.modifier, t.modified,
				t.tags, t.fields, true, t.created, t.creator);
			if(!window.allowSave())
				store.setDirty(dirty);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title, null, true);
		}
		context.adaptor.close();
		if(callback) callback(context);
	};
	adaptor.getTiddler(title, context, null, onLoadTiddlerResponse);
	return config.messages.loadingMissingTiddler.format([title, context.serverType, context.host, context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title, template) {
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title, template, tiddler) {
	return store.getRecursiveTiddlerText(template, null, 10);
};

Story.prototype.refreshTiddler = function(title, template, force, customFields, defaultText) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	if(tiddlerElem.getAttribute("dirty") == "true" && !force)
		return tiddlerElem;
	template = this.chooseTemplateForTiddler(title, template);
	var currTemplate = tiddlerElem.getAttribute("template");
	if((template == currTemplate) && !force)
		return tiddlerElem;

	var tiddler = store.getTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler();
		if(store.isShadowTiddler(title)) {
			var tags = [];
			tiddler.set(title, store.getTiddlerText(title),
				config.views.wikified.shadowModifier, version.date, tags, version.date);
		} else {
			var text = template == config.tiddlerTemplates[DEFAULT_EDIT_TEMPLATE] // #166
				? config.views.editor.defaultText.format([title])
				: config.views.wikified.defaultText.format([title]);
			text = defaultText || text;
			var fields = customFields ? customFields.decodeHashMap() : null;
			tiddler.set(title, text, config.views.wikified.defaultModifier, version.date, [], version.date, fields);
		}
	}

	tiddlerElem.setAttribute("tags", tiddler.tags.join(" "));
	tiddlerElem.setAttribute("tiddler", title);
	tiddlerElem.setAttribute("template", template);
	tiddlerElem.onmouseover = this.onTiddlerMouseOver;
	tiddlerElem.onmouseout = this.onTiddlerMouseOut;
	tiddlerElem.ondblclick = this.onTiddlerDblClick;
	tiddlerElem[window.event ? "onkeydown" : "onkeypress"] = this.onTiddlerKeyPress;
	tiddlerElem.innerHTML = this.getTemplateForTiddler(title, template, tiddler);
	applyHtmlMacros(tiddlerElem, tiddler);
	if(store.getTaggedTiddlers(title).length > 0)
		jQuery(tiddlerElem).addClass("isTag");
	else
		jQuery(tiddlerElem).removeClass("isTag");
	if(store.tiddlerExists(title)) {
		jQuery(tiddlerElem).removeClass("shadow");
		jQuery(tiddlerElem).removeClass("missing");
	} else {
		jQuery(tiddlerElem).addClass(store.isShadowTiddler(title) ? "shadow" : "missing");
	}
	if(customFields)
		this.addCustomFields(tiddlerElem, customFields);

	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place, customFields) {
	var fields = customFields.decodeHashMap();
	var container = createTiddlyElement(place, "div", null, "customFields");
	container.style.display = "none";
	for(var fieldName in fields) {
		var input = document.createElement("input");
		input.setAttribute("type", "text");
		input.setAttribute("value", fields[fieldName]);
		container.appendChild(input);
		input.setAttribute("edit", fieldName);
	}
};

Story.prototype.refreshAllTiddlers = function(force) {
	this.forEachTiddler(function(title, element) {
		var template = element.getAttribute("template");
		if(template && element.getAttribute("dirty") != "true") {
			this.refreshTiddler(title, force ? null : template, true);
		}
	});
};

Story.prototype.onTiddlerMouseOver = function() {
	jQuery(this).addClass("selected");
};

Story.prototype.onTiddlerMouseOut = function() {
	jQuery(this).removeClass("selected");
};

Story.prototype.onTiddlerDblClick = function(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(!target || target.nodeName.toLowerCase() == "input" || target.nodeName.toLowerCase() == "textarea")
		return false;
	if(document.selection && document.selection.empty)
		document.selection.empty();
	config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return true;
};

Story.prototype.onTiddlerKeyPress = function(ev) {
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			var editor = story.getTiddlerField(title, "text");
			if(target.tagName.toLowerCase() == "input"
			   && editor.value == config.views.editor.defaultText.format([title])) {
				// moving from input field and editor still contains default text, so select it
				editor.focus();
				editor.select();
				consume = true;
			}
			if(config.options.chkInsertTabs && !e.ctrlKey && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target, String.fromCharCode(9));
				consume = true;
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
				consume = true;
			}
			break;
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this, "cancelCommand", e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title, field) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var $editors = jQuery(tiddlerElem).find('input, textarea');
	return $editors.filter('[edit="' + field + '"]')[0] || $editors[0] || null;
};

Story.prototype.focusTiddler = function(title, field) {
	var e = this.getTiddlerField(title, field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title, tag, mode, field) {
	var editor = this.getTiddlerField(title, field);
	var tags = editor.value.readBracketedList();

	var i = tags.indexOf(tag);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) tags.push(tag);
	} else if(mode == -1) {
		if(i != -1) tags.splice(i, 1);
	}

	editor.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title, tag, mode) {
	this.setTiddlerField(title, tag, mode, "tags");
};

Story.prototype.closeTiddler = function(title, shouldAnimate, unused) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return;

	clearMessage();
	this.scrubTiddler(tiddlerElem);
	if(config.options.chkAnimate && shouldAnimate && anim && typeof Slider == "function") {
		anim.startAnimating(new Slider(tiddlerElem, false, null, "all"));
	} else {
		jQuery(tiddlerElem).remove();
	}
};

Story.prototype.scrubTiddler = function(tiddlerElement) {
	tiddlerElement.id = null;
};

// 'dirty' flag attribute is used on tiddlers to mark those having unsaved changes

Story.prototype.setDirty = function(title, dirty) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty", dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;
	return tiddlerElem.getAttribute("dirty") == "true";
};

Story.prototype.areAnyDirty = function() {
	var r = false;
	this.forEachTiddler(function(title, element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude) {
	clearMessage();
	this.forEachTiddler(function(title, element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0, ensureVisible(this.container));
};

Story.prototype.isEmpty = function() {
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text, useCaseSensitive, useRegExp) {
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(), useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack, "title", "excludeSearch");
	this.displayTiddlers(null, matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(), q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(el) {
	while(el && !jQuery(el).hasClass("tiddler")) {
		el = jQuery(el).hasClass("popup") && Popup.stack[0] ? Popup.stack[0].root
			: el.parentNode;
	}
	return el;
};

Story.prototype.gatherSaveFields = function(el, fields) {
	if(!el || !el.getAttribute) return;
	var fieldName = el.getAttribute("edit");
	if(fieldName)
		fields[fieldName] = el.value.replace(/\r/mg, "");
	if(el.hasChildNodes()) {
		for(var i = 0; i < el.childNodes.length; i++)
			this.gatherSaveFields(el.childNodes[i], fields);
	}
};

Story.prototype.hasChanges = function(title) {
	var tiddlerElement = this.getTiddler(title);
	if(!tiddlerElement) return false;

	var fields = {};
	this.gatherSaveFields(tiddlerElement, fields);
	if(store.fetchTiddler(title)) {
		for(var fieldName in fields) {
			if(store.getValue(title, fieldName) != fields[fieldName])
				return true;
		}
		return false;
	}
	if(store.isShadowTiddler(title)) {
		// not checking for title or tags
		return store.getShadowTiddlerText(title) != fields.text;
	}
	// new tiddler
	return true;
};

Story.prototype.saveTiddler = function(title, minorUpdate) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var fields = {};
	this.gatherSaveFields(tiddlerElem, fields);
	var newTitle = fields.title || title;
	if(!store.tiddlerExists(newTitle)) {
		newTitle = newTitle.trim();
		var creator = config.options.txtUserName;
	}
	if(store.tiddlerExists(newTitle) && newTitle != title) {
		if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
			return null;
	}
	if(newTitle != title)
		this.closeTiddler(newTitle, false);
	tiddlerElem.id = this.tiddlerId(newTitle);
	tiddlerElem.setAttribute("tiddler", newTitle);
	tiddlerElem.setAttribute("template", DEFAULT_VIEW_TEMPLATE);
	tiddlerElem.setAttribute("dirty", "false");
	if(config.options.chkForceMinorUpdate)
		minorUpdate = !minorUpdate;
	if(!store.tiddlerExists(newTitle))
		minorUpdate = false;
	if(store.tiddlerExists(title)) {
		var t = store.fetchTiddler(title);
		var extendedFields = t.fields;
		creator = t.creator;
	} else {
		extendedFields = merge({}, config.defaultCustomFields);
	}
	for(var n in fields) {
		if(!TiddlyWiki.isStandardField(n))
			extendedFields[n] = fields[n];
	}
	var tiddler = store.saveTiddler(title, newTitle, fields.text, minorUpdate ? undefined : config.options.txtUserName,
		minorUpdate ? undefined : new Date(), fields.tags, extendedFields, null, null, creator);
	autoSaveChanges(null, [tiddler]);
	return newTitle;
};

Story.prototype.getPermaViewHash = function(titles) {
	return '#' + encodeURIComponent(String.encodeTiddlyLinkList(titles));
};

Story.prototype.permaView = function() {
	var titles = [];
	this.forEachTiddler(function(title, element) {
		titles.push(title);
	});
	var hash = this.getPermaViewHash(titles);
	if(window.location.hash != hash)
		window.location.hash = hash;
};

Story.prototype.switchTheme = function(theme) {
	if(safeMode) return;

	var getSlice = function(theme, slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme, slice + "ReadOnly") || store.getTiddlerSlice(theme, "Web" + slice);
		r = r || store.getTiddlerSlice(theme, slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator) == 0)
			r = theme + r;
		return store.isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i, name, theme, slice) {
		var newName = getSlice(theme, slice);
		if(name != newName && store.namedNotifications[i].name == name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i = 0; i < config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
			case "PageTemplate":
				config.refresherData.pageTemplate = replaceNotification(i, config.refresherData.pageTemplate, theme, name);
				break;
			case "StyleSheet":
				removeStyleSheet(config.refresherData.styleSheet);
				config.refresherData.styleSheet = replaceNotification(i, config.refresherData.styleSheet, theme, name);
				break;
			case "ColorPalette":
				config.refresherData.colorPalette = replaceNotification(i, config.refresherData.colorPalette, theme, name);
				break;
			default:
				break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme, "ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme, "EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate != pt || config.tiddlerTemplates[vi] != vt
		   || config.tiddlerTemplates[ei] != et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet, "", 10),
				config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};

//--
//-- Backstage
//--
// Backstage tasks
config.tasks.save.action = saveChanges;

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var text = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button, text, cmb.open.tooltip,
			function(e) { backstage.show(); return false }, null, "backstageShow");
		text = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button, text, cmb.close.tooltip,
			function(e) { backstage.hide(); return false }, null, "backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel, "div", null, "backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel, "div", null, "backstagePanelBody");
		this.cloak.onmousedown = function(e) { backstage.switchTab(null) };
		createTiddlyText(this.toolbar, cmb.prompt);
		for(var i = 0; i < config.backstageTasks.length; i++) {
			var taskName = config.backstageTasks[i];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar, text, task.tooltip, handler, "backstageTab");
			jQuery(btn).addClass(task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
		}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: findWindowWidth(), end: 0, template: "%0px" }
			]));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		jQuery(this.content).addClass("backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			// close current tab, not backstage
			this.switchTab(null);
			return;
		}

		backstage.toolbar.style.left = "0px";
		var hide = function() { backstage.area.style.display = "none" };
		if(anim && config.options.chkAnimate) {
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: 0, end: findWindowWidth(), template: "%0px" }
			], hide));
		} else {
			hide();
		}
		this.showButton.style.display = "block";
		this.hideButton.style.display = "none";
		config.options.chkBackstage = false;
		saveOption("chkBackstage");
		jQuery(this.content).removeClass("backstageVisible");
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e) {
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
		}
		if(tabName == this.currTabName) {
			this.hidePanel();
			return;
		}
		if(this.currTabElem) {
			jQuery(this.currTabElem).removeClass("backstageSelTab");
		}
		if(tabElem && tabName) {
			this.preparePanel();
			jQuery(tabElem).addClass("backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content, this.panelBody, null, null);
			this.showPanel();
		} else if(this.currTabElem) {
			this.hidePanel();
		}
		this.currTabName = tabName;
		this.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findDocHeight() + "px";
		backstage.cloak.style.display = "block";
		jQuery(backstage.panelBody).empty();
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px" }
			]), new Scroller(backstage.panel, false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			jQuery(backstage.currTabElem).removeClass("backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var callback = function() { backstage.cloak.style.display = "none" };
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px" },
				{ style: "display", atEnd: "none" }
			], callback));
		} else {
			jQuery([backstage.panel, backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place, macroName, params) {
	var backstageTask = config.tasks[params[0]];
	if(!backstageTask) return;
	createTiddlyButton(place, backstageTask.text, backstageTask.tooltip, function(e) {
		backstage.switchTab(params[0]);
		return false;
	});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(readOnly) {
		createTiddlyElement(place, "div", null, "marked", this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e) {
	var wizard = new Wizard(this);
	wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e) {
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard) {
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title, this.step1Html);

	var name, s = wizard.getElement("selTypes");
	for(name in config.adaptors) {
		var e = createTiddlyElement(s, "option", null, null, config.adaptors[name].serverLabel || name);
		e.value = name;
	}
	if(config.defaultAdaptor) s.value = config.defaultAdaptor;

	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(name in feeds) {
		e = createTiddlyElement(s, "option", null, null, name);
		e.value = name;
	}
	wizard.setValue("feeds", feeds);
	s.onchange = me.onFeedChange;

	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{ caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen }]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function() {
	var feeds = {};
	var i, tagged = store.getTaggedTiddlers("systemServer", "title");
	for(i = 0; i < tagged.length; i++) {
		var title = tagged[i].title;
		feeds[title] = {
			title: title,
			url: store.getTiddlerSlice(title, "URL"),
			workspace: store.getTiddlerSlice(title, "Workspace"),
			workspaceList: store.getTiddlerSlice(title, "WorkspaceList"),
			tiddlerFilter: store.getTiddlerSlice(title, "TiddlerFilter"),
			serverType: store.getTiddlerSlice(title, "Type") || "file",
			description: store.getTiddlerSlice(title, "Description")
		};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e) {
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName", f.serverType);
		wizard.setValue("feedHost", f.url);
		wizard.setValue("feedWorkspace", f.workspace);
		wizard.setValue("feedWorkspaceList", f.workspaceList);
		wizard.setValue("feedTiddlerFilter", f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e) {
	var wizard = new Wizard(this);
	var file = this.value;
	file = file.replace(/^C:\\fakepath\\/i, ''); // remove fakepath (chrome/opera/safari)
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
			file = this.files[0].fileName; // REQUIRES PRIVILEGES.. NULL otherwise
		} catch (ex) {
			// non-priv fallback: combine filename with path to current document
			var path = tw.io.getOriginalLocalPath();
			var slashpos = path.lastIndexOf('/');
			if (slashpos == -1) slashpos = path.lastIndexOf('\\');
			if (slashpos != -1) path = path.substr(0, slashpos + 1); // remove filename, leave trailing slash
			file = path + file;
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(file);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(path) {
	if(!path) return path;
	// use "/" for cross-platform consistency
	path = path.replace(/\\/g, "/");

	var t = path.split(":");
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		// input is already a URL
		return path;
	}

	var p = t[1] || t[0]; // remove drive letter (if any)
	if(p.substr(0, 1) == "/") {
		// path is absolute, add protocol + domain + extra slash (if drive letter)
		return document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + path;
	}

	// path is relative, add current document protocol + domain + path
	var c = document.location.href.replace(/\\/g, "/");
	var pos = c.lastIndexOf("/");
	if(pos != -1)
		c = c.substring(0, pos); // remove filename
	return c + "/" + p;
};

config.macros.importTiddlers.onOpen = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor", adaptor);
	wizard.setValue("serverType", serverType);
	wizard.setValue("host", url);
	adaptor.openHost(url, null, wizard, me.onOpenHost);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context, wizard) {
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	adaptor.getWorkspaceList(context, wizard, me.onGetWorkspaceList);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context", context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length == 1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		context.adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
		wizard.setValue("workspace", workspace);
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title, me.step2Html);
	var i, s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(i = 0; i < context.workspaces.length; i++) {
		var e = createTiddlyElement(s, "option", null, null, context.workspaces[i].title);
		e.value = context.workspaces[i].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace", null, false, true);
		for(i = 1; i < list.length; i++) {
			if(context.workspaces.findByField("title", list[i].value) == null) {
				e = createTiddlyElement(s, "option", null, null, list[i].value);
				e.value = list[i].value;
			}
		}
	}
	if(workspace) {
		wizard.getElement("txtWorkspace").value = workspace;
	}
	wizard.setButtons([{ caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace }]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e) {
	var wizard = new Wizard(this);
	wizard.getElement("txtWorkspace").value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace", workspace);
	var context = wizard.getValue("context");
	adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var browse = wizard.getElement("txtBrowse");
	if (browse.files) context.file = browse.files[0]; // for HTML5 FileReader
	adaptor.getTiddlerList(context, wizard, me.onGetTiddlerList, wizard.getValue("feedTiddlerFilter"));
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		var error = context.statusText || me.errorGettingTiddlerList;
		if(context.host.indexOf("file://") === 0) {
			error = me.errorGettingTiddlerListFile;
		} else {
			error = context.xhr && context.xhr.status == 404 ? me.errorGettingTiddlerListHttp404 :
				me.errorGettingTiddlerListHttp;
		}
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], "");
		jQuery("span.status", wizard.footerEl).html(error); // so error message can be html
		return;
	}

	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var i = 0; i < context.tiddlers.length; i++) {
			var tiddler = context.tiddlers[i];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text, 100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1) });

	// Display the listview
	wizard.addStep(me.step3Title, me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	var listView = ListView.create(listWrapper, listedTiddlers, me.listViewTemplate);
	wizard.setValue("listView", listView);
	wizard.setValue("context", context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel },
		{ caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport }
	]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard) {
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType, host, workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard) {
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType, host, workspace]);
	store.saveTiddler(txtSaveTiddler, txtSaveTiddler, text, me.serverSaveModifier, new Date(), ["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync", chkSync);

	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	for(var i = 0; i < rowNames.length; i++) {
		if(store.tiddlerExists(rowNames[i]))
			overwrite.push(rowNames[i]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}

	wizard.addStep(me.step4Title.format([rowNames.length]), me.step4Html);
	for(i = 0; i < rowNames.length; i++) {
		var linkHolder = document.createElement("div");
		createTiddlyLink(linkHolder, rowNames[i], true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(linkHolder, place);
	}
	wizard.setValue("remainingImports", rowNames.length);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	], me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(i = 0; i < rowNames.length; i++) {
		var context = {
			allowSynchronous: true,
			tiddler: tiddlers[tiddlers.findByField("title", rowNames[i])]
		};
		adaptor.getTiddler(rowNames[i], context, wizard, me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context, wizard) {
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier,
		tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title, 'server', null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous) store.notify(tiddler.title, true);

	var remainingImports = wizard.getValue("remainingImports") - 1;
	wizard.setValue("remainingImports", remainingImports);

	if(remainingImports != 0) return;
	if(context.isSynchronous) {
		store.notifyAll();
		refreshDisplay();
	}
	var me = config.macros.importTiddlers;
	wizard.setButtons([
		{ caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose }
	], me.statusDoneImport);
	autoSaveChanges();
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.docsUrl = 'https://classic.tiddlywiki.com/#HowToUpgrade';

config.macros.upgrade.getSourceURL = function() {
	return config.options.txtUpgradeCoreURI || config.macros.upgrade.source;
};

config.macros.upgrade.loadLatestCore = function(onSuccess, onError) {
	ajaxReq({
		type: "GET",
		url: this.getSourceURL(),
		processData: false,
		success: onSuccess,
		error: onError
	});
};

config.macros.upgrade.handler = function(place) {
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	w.addStep(this.step1Title, this.step1Html.format([
		this.getSourceURL(),
		this.getSourceURL().replace(/^https:\/\//, ''),
		this.docsUrl
	]));
	w.setButtons([{
		caption: this.upgradeLabel,
		tooltip: this.upgradePrompt,
		onClick: this.onClickUpgrade
	}]);
};

config.macros.upgrade.onClickUpgrade = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(!window.allowSave()) {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}

	w.setButtons([], me.statusPreparingBackup);
	var localPath = tw.io.getOriginalLocalPath();
	var backupPath = getBackupPath(localPath, me.backupExtension);
	var original = loadOriginal(localPath);

	w.setButtons([], me.statusSavingBackup);
	var backupSuccessOrPending = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(!backupSuccessOrPending) {
		w.setButtons([], me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}

	// make sure both the backup is saved and tw.io.loadFile works before proceeding
	tw.io.loadFile(backupPath, function(backupContent) {
		if(!backupContent) {
			w.setButtons([], me.errorVerifyingBackup.format([me.docsUrl]));
			return;
		}

		w.setValue("backupPath", backupPath);

		w.setButtons([], me.statusLoadingCore);
		var sourceURL = me.getSourceURL();
		me.loadLatestCore(function(data, textStatus, jqXHR) {
			me.onLoadCore(true, w, jqXHR.responseText, sourceURL, jqXHR);
		}, function(jqXHR, textStatus, errorThrown) {
			me.onLoadCore(false, w, null, sourceURL, jqXHR);
		});
	});

	return false;
};

config.macros.upgrade.onLoadCore = function(status, w, responseText, url, xhr) {
	var me = config.macros.upgrade;
	var errMsg;
	if(!status) errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer) errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([], errMsg);
		alert(errMsg);
		return;
	}

	var step2 = [me.step2Html_downgrade, me.step2Html_restore, me.step2Html_upgrade][compareVersions(version, newVer) + 1];
	w.addStep(me.step2Title, step2.format([formatVersion(newVer), formatVersion(version)]));
	w.setButtons([
		{ caption: me.startLabel,  tooltip: me.startPrompt,  onClick: function() {
			config.macros.upgrade.onStartUpgrade(w, responseText);
		} },
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	]);
};

config.macros.upgrade.onStartUpgrade = function(wizard, newCoreHtml) {
	wizard.setButtons([], config.macros.upgrade.statusSavingCore);
	var localPath = tw.io.getOriginalLocalPath();
	saveFile(localPath, newCoreHtml);

	wizard.setButtons([], config.macros.upgrade.statusReloadingCore);
	var backupPath = wizard.getValue("backupPath");
	var newLocation = addUpgradePartsToURI(document.location.toString(), backupPath);
	window.setTimeout(function () { window.location = newLocation }, 10);
};

config.macros.upgrade.onCancel = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title, me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile) {
	var re = /version = \{\s*title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return !m ? null : {
		title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])
	};
};

// a helper, splits uri into parts, passes the map of parts to modify and glues parts back
function changeUri(uri, modify) {
	var uriPartsRE = /^(?:([\w:]+)\/\/)?([^\/\?#]+)?([^\?#]+)?(?:\?([^#]*))?(?:#(.*))?$/;
	var match = uriPartsRE.exec(uri) || [null, '', '', '', '', ''];
	var parts = {
		scheme:	match[1],
		host:	match[2],
		path:	match[3],
		query:	match[4],
		hash:	match[5]
	};
	modify(parts);
	var newScheme = parts.scheme === undefined ? '' : (parts.scheme + '//'),
	    newHost   = parts.host || '',
	    newPath   = parts.path || '',
	    newQuery  = parts.query ? ('?' + parts.query) : '',
	    newHash   = parts.hash   === undefined ? '' : ('#' + parts.hash);
	return newScheme + newHost + newPath + newQuery + newHash;
}

function addUpgradePartsToURI(uri, backupPath) {
	return changeUri(uri, function(uriParts) {
		var newParamifier = 'upgrade:[[' + encodeURI(backupPath) + ']]';
		uriParts.hash = (uriParts.hash ? uriParts.hash + '%20' : '') + newParamifier;

		var newQuery = "time=" + new Date().convertToYYYYMMDDHHMM();
		uriParts.query = (uriParts.query ? uriParts.query + '&' : '') + newQuery;
	});
}

function stripUpgradePartsFromURI(uri) {
	return changeUri(uri, function(uriParts) {
		var queryParts = uriParts.query.split('&'),
		    hashParts = uriParts.hash.split('%20'); // splits paramifiers with a space in argument

		for(var i = 0; i < queryParts.length; i++)
			if(queryParts[i].indexOf('time=') == 0)
				queryParts.splice(i--, 1);

		// relies on the upgrade paramifier being added to the end of hash
		for(i = 0; i < hashParts.length; i++)
			if(hashParts[i].indexOf('upgrade:') == 0)
				hashParts = hashParts.slice(0, i);

		uriParts.query = queryParts.join('&');
		uriParts.hash = hashParts.join('%20') || undefined;
	});
}

function upgradeFrom(path) {
	tw.io.loadFile(path, function(oldTw) {
		var importStore = new TiddlyWiki();
		importStore.importTiddlyWiki(oldTw);
		importStore.forEachTiddler(function(title, tiddler) {
			if(!store.getTiddler(title)) {
				store.addTiddler(tiddler);
			}
		});

		refreshDisplay();
		saveChanges();
		alert(config.messages.upgradeDone.format([formatVersion()]));
		window.location = stripUpgradePartsFromURI(window.location.toString());
	});
}

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place, macroName, params, wikifier, paramString) {
	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	listWrapper.setAttribute("refresh", "macro");
	listWrapper.setAttribute("macroName", "plugins");
	listWrapper.setAttribute("params", paramString);
	this.refresh(listWrapper, paramString);
};

config.macros.plugins.refresh = function(listWrapper, paramString) {
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper, function(e, rowName) {
		if(e.checked) selectedRows.push(e.getAttribute("rowName"));
	});
	jQuery(listWrapper).empty();

	var plugins = installedPlugins.slice(0);
	// not all plugins are installed, gather info about those, too
	var i, tiddler, p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(i = 0; i < configTiddlers.length; i++) {
		tiddler = configTiddlers[i];
		if(plugins.findByField("title", tiddler.title) != null) continue;

		p = getPluginInfo(tiddler);
		p.executed = false;
		p.log.splice(0, 0, this.skippedText);
		plugins.push(p);
	}

	for(i = 0; i < plugins.length; i++) {
		p = plugins[i];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[i].title) != -1;
	}

	if(plugins.length == 0) {
		createTiddlyElement(listWrapper, "em", null, null, this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper, plugins, template, this.onSelectCommand);
		wizard.setValue("listView", listView);
		if(!readOnly) {
			var me = config.macros.plugins;
			wizard.setButtons([
				{ caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag },
				{ caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete }
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var i = 0; i < rowNames.length; i++) {
			store.setTiddlerTag(rowNames[i], false, "systemConfig");
		}
		autoSaveChanges();
	}
};

config.macros.plugins.doDelete = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(var i = 0; i < rowNames.length; i++) {
				store.removeTiddler(rowNames[i]);
				story.closeTiddler(rowNames[i], true);
			}
		}
		autoSaveChanges();
	}
};

//--
//-- Message area
//--

function getMessageDiv() {
	var msgArea = document.getElementById("messageArea");
	if(!msgArea) return null;

	if(!msgArea.hasChildNodes()) {
		var toolbar = createTiddlyElement(msgArea, "div", null, "messageArea__toolbar messageToolbar");
		var btn = createTiddlyButton(toolbar, '', config.messages.messageClose.tooltip, clearMessage,
			"button messageToolbar__button");

		btn.innerHTML = tw.assets.icons.closeSvg;
		// inline SVG is unsupported in old FireFox
		if(window.HTMLUnknownElement && btn.firstChild instanceof window.HTMLUnknownElement) {
			btn.innerHTML = config.messages.messageClose.text;
		} else {
			btn.classList.add('messageToolbar__button_withIcon');
		}
	}
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea, "div", null, "messageArea__text");
}

function displayMessage(text, link) {
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(!link) {
		createTiddlyText(e, text);
	} else {
		createTiddlyElement(e, "a", null, null, text, { href: link, target: "_blank" });
	}
}

function clearMessage() {
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		jQuery(msgArea).empty();
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{ name: "SystemSettings", notify: onSystemSettingsChange },
	{ name: "StyleSheetLayout", notify: refreshStyles },
	{ name: "StyleSheetColors", notify: refreshStyles },
	{ name: "StyleSheet", notify: refreshStyles },
	{ name: "StyleSheetPrint", notify: refreshStyles },
	{ name: "PageTemplate", notify: refreshPageTemplate },
	{ name: "SiteTitle", notify: refreshPageTitle },
	{ name: "SiteSubtitle", notify: refreshPageTitle },
	{ name: "WindowTitle", notify: refreshPageTitle },
	{ name: "ColorPalette", notify: refreshColorPalette },
	{ name: null, notify: refreshDisplay }
];

config.refreshers = {
	link: function(e, changeList) {
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e, title);
		return true;
	},

	tiddler: function(e, changeList) {
		if (startingUp) return true; // #147
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title, template, true);
		else
			refreshElements(e, changeList);
		return true;
	},

	content: function(e, changeList) {
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.macroArgs; // #154
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e, title, args);
			return true;
		} else
			return false;
	},

	macro: function(e, changeList) {
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e, params);
		return true;
	}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root, changeList) {
	var i, nodes = root.childNodes;
	for(i = 0; i < nodes.length; i++) {
		var e = nodes[i], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = refresher ? refresher(e, changeList) : false;
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e, changeList);
	}
}

function applyHtmlMacros(root, tiddler) {
	for(var e = root.firstChild; !!e; e = nextChild) {
		// macros can manipulate DOM, so we remember nextChild before invokeMacro
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p + 1);
					macro = macro.substr(0, p);
				}
				invokeMacro(e, macro, params, null, tiddler);
			}
		}
		if(e.hasChildNodes()) applyHtmlMacros(e, tiddler);
	}
}

function refreshPageTemplate(title) {
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes, i;
	if(display) {
		nodes = display.childNodes;
		for(i = nodes.length - 1; i >= 0; i--)
			stash.appendChild(nodes[i]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if(!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable

	wrapper.innerHTML = store.getRecursiveTiddlerText(title, null, 10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	jQuery(display).empty();
	if(!display)
		display = createTiddlyElement(wrapper, "div", story.containerId());
	nodes = stash.childNodes;
	for(i = nodes.length - 1; i >= 0; i--)
		display.appendChild(nodes[i]);
	jQuery(stash).remove();
}

function refreshDisplay(hint) {
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e, hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e, hint);
	}
}

function refreshPageTitle() {
	document.title = getPageTitle();
}

function getPageTitle() {
	return wikifyPlainText(store.getTiddlerText("WindowTitle", ""), null, tiddler);
}

function refreshStyles(title, doc) {
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title, "", 10), title, doc || document);
}

function refreshColorPalette(title) {
	if(!startingUp)
		refreshAll();
}

function refreshAll() {
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

tw.options = {
	defaults: {},
	define: function(name, defaultValue, description) {
		this.defaults[name] = defaultValue;
		if(config.options[name] === undefined) config.options[name] = defaultValue;
		if(description) config.optionsDesc[name] = description;
	},
	hasDefaultValue: function(name) {
		return config.options[name] == this.defaults[name] ||
		       config.options[name] === undefined;
	}
};

for(var name in config.options) {
	tw.options.define(name, config.options[name], config.optionsDesc[name]);
}

config.optionHandlers = {
	'txt': {
		get: function(name) { return encodeCookie(config.options[name].toString()) },
		set: function(name, value) { config.options[name] = decodeCookie(value) }
	},
	'chk': {
		get: function(name) { return config.options[name] ? 'true' : 'false' },
		set: function(name, value) { config.options[name] = value == 'true' }
	}
};

function setOption(name, value) {
	var optType = name.substr(0, 3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name, value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name) {
	var optType = name.substring(0, 3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ?
		config.optionHandlers[optType].get(name) : null;
}

function loadOptions() {
	if(safeMode) return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies() {
	var cookieList = document.cookie.split(';');
	var i, cookies = {};
	for(i = 0; i < cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = jQuery.trim(cookieList[i].substring(0, p));
			var value = jQuery.trim(cookieList[i].substring(p + 1));
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies() {
	var i, cookies = getCookies();
	if(cookies['TiddlyWikiClassicOptions']) // TW291 and later //#159
		cookies = cookies['TiddlyWikiClassicOptions'].replace(/%22/g, '"').replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWikiOptions']) // TW290 beta //#159
		cookies = cookies['TiddlyWikiOptions'].replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWiki']) // TW281 and earlier
		cookies = cookies['TiddlyWiki'].decodeHashMap();

	for(i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i, cookies[i]);
		}
	}
}

function loadSystemSettings() {
	var key, settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(key in settings) {
		setOption(key, settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange() {
	if(!startingUp) loadSystemSettings();
}

function saveOption(name) {
	if(safeMode) return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}

	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name, true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name) {
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name) {
	var key, cookies = {};
	for(key in config.options) {
		if(tw.options.hasDefaultValue(key)) continue;
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWikiClassicOptions='
		+ String.encodeHashMap(cookies).replace(/%/g, '%25').replace(/"/g, '%22')
		+ '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';

	// clean up cookies saved in an earlier format, before TW291 (#159)
	cookies = getCookies();
	for(var c in cookies) {
		var optType = c.substring(0, 3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

var systemSettingSave;
function commitSystemSettings(storeWasDirty) {
	if(systemSettingSave) {
		window.clearTimeout(systemSettingSave);
	}
	systemSettingSave = window.setTimeout(function() {
		var tiddler = store.getTiddler('SystemSettings');
		autoSaveChanges(null, [tiddler]);
	}, 1000);
}

function saveSystemSetting(name, saveFile) {
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title, name);
	var isUnchanged = slice === getOption(name);
	if(readOnly || isUnchanged) return;

	var slices = store.calcAllSlices(title);
	for(var key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}

	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key, slices[key]]));
	}
	text = text.sort().join('\n');

	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title, title, text, 'System',
			new Date(), ['excludeLists'], config.defaultCustomFields);
	}
	if(saveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s) {
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s) {
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re, function($0) { return String.fromCharCode(eval($0.replace(/[&#;]/g, ''))) });
}

config.macros.option.genericCreate = function(place, type, opt, className, desc) {
	var typeInfo = config.macros.option.types[type];
	var text = desc != 'no' ? (config.optionsDesc[opt] || opt) : null;
	var attributes = { option: opt };
	if(typeInfo.typeValue) attributes.type = typeInfo.typeValue;
	if(config.optionsDesc[opt]) attributes.title = config.optionsDesc[opt];
	var c = createTiddlyElement(place, typeInfo.elementType, null, className || typeInfo.className, text, attributes);
	c[typeInfo.eventName] = typeInfo.onChange;
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e) {
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substring(0, 3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt, handler.valueField,
				this[handler.valueField], handler.elementType, this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt, valueField, value, elementType, sourceEditor) {
	config.options[opt] = value;
	saveOption(opt);

	jQuery(elementType + '[option=' + opt + ']').each(function(i, editor) {
		if(editor != sourceEditor) editor[valueField] = value;
	});
};

config.macros.option.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params, 'name', null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params, 'class', null);
	var desc = getParam(params, 'desc', 'no');
	var type = opt.substring(0, 3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place, type, opt, className, desc);
};

config.macros.options.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var showUnknown = getParam(params, 'showUnknown', 'no');

	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper, markList);
	wizard.setValue('listWrapper', listWrapper);
	this.refreshOptions(listWrapper, showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper, showUnknown) {
	var n, opts = [];
	for(n in config.options) {
		var isUnknown = !config.optionsDesc[n];
		if(!isUnknown || showUnknown) opts.push({
			option: '',
			name: n,
			lowlight: isUnknown,
			description: config.optionsDesc[n] || this.unknownDescription
		});
	}
	opts.sort(function(a, b) {
		var nameA = a.name.substring(3);
		var nameB = b.name.substring(3);
		return nameA < nameB ? -1 : (nameA == nameB ? 0 : +1);
	});

	ListView.create(listWrapper, opts, this.listViewTemplate);
	for(var i = 0; i < opts.length; i++) {
		var type = opts[i].name.substring(0, 3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[i].colElements['option'], type, opts[i].name, null, 'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e) {
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper, this.checked);
	return false;
};

//--
//-- Saving
//--

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var startSaveAreaRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var endSaveArea = '</d' + 'iv>';
var endSaveAreaCaps = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit() {
	hadConfirmExit = true;
	var hasDirtyStore = store && store.isDirty && store.isDirty();
	var hasDirtyStory = story && story.areAnyDirty && story.areAnyDirty();
	if(hasDirtyStore || hasDirtyStory) return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges() {
	if(!(store && store.isDirty && store.isDirty()) || window.hadConfirmExit !== false) return;
	if(confirm(config.messages.unsavedChangesWarning)) saveChanges();
}

function updateLanguageAttribute(s) {
	if(!config.locale) return s;
	var m = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/.exec(s);
	if(!m) return s;

	var htmlTag = m[1];
	if(m[2]) htmlTag += ' xml:lang="' + config.locale + '"';
	if(m[3]) htmlTag += ' lang="' + config.locale + '"';
	htmlTag += ">";

	return s.substr(0, m.index) + htmlTag + s.substr(m.index + m[0].length);
}

function updateMarkupBlock(s, blockName, tiddlerName) {
	return tw.textUtils.replaceChunk(s,
		"<!--%0-START-->".format([blockName]),
		"<!--%0-END-->".format([blockName]),
		"\n" + store.getRecursiveTiddlerText(tiddlerName, "") + "\n");
}

function updateOriginal(original, posDiv, localPath) {
	if(!posDiv) posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0, posDiv[0] + startSaveArea.length) + "\n" +
		store.allTiddlersAsHtml() + "\n" +
		original.substr(posDiv[1]);
	var newSiteTitle = getPageTitle().htmlEncode();
	revised = tw.textUtils.replaceChunk(revised, "<title" + ">", "</title" + ">", " " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised, "PRE-HEAD", "MarkupPreHead");
	revised = updateMarkupBlock(revised, "POST-HEAD", "MarkupPostHead");
	revised = updateMarkupBlock(revised, "PRE-BODY", "MarkupPreBody");
	revised = updateMarkupBlock(revised, "POST-SCRIPT", "MarkupPostBody");
	return revised;
}

function locateStoreArea(original) {
	// Locate the storeArea divs
	if(!original) return null;
	var posOpeningDiv = original.search(startSaveAreaRE);
	var limitClosingDiv = original.indexOf("<" + "!--POST-STOREAREA--" + ">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<" + "!--POST-BODY-START--" + ">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(endSaveArea, start);
	if(posClosingDiv == -1)
		posClosingDiv = original.lastIndexOf(endSaveAreaCaps, start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv, posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty, tiddlers) {
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty, tiddlers);
}

// get the full HTML of the original file
function loadOriginal(localPath, callback) {
	if(!callback) return loadFile(localPath) || window.originalHTML || recreateOriginal();

	tw.io.loadFile(localPath, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			var original = window.originalHTML || recreateOriginal();
			callback(original);
		}
	});
}

// reconstruct original HTML file content from current document memory
function recreateOriginal() {
	// construct doctype
	var content = "<!DOCTYPE ";
	var t = document.doctype;
	if (!t)
		content += "html";
	else {
		content += t.name;
		if(t.publicId)
			content += ' PUBLIC "' + t.publicId + '"';
		else if(t.systemId)
			content += ' SYSTEM "' + t.systemId + '"';
	}
	content += ' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"';
	content += '>\n';

	// append current document content
	content += document.documentElement.outerHTML;

	// clear 'savetest' marker
	content = content.replace(/<div id="saveTest">savetest<\/div>/, '<div id="saveTest"></div>');
	content = content.replace(/script><applet [^\>]*><\/applet>/g, 'script>');
	// newline before head tag
	content = content.replace(/><head>/, '>\n<head>');
	// newlines before/after end of body/html tags
	content = content.replace(/\n\n<\/body><\/html>$/, '</' + 'body>\n</' + 'html>\n'); // #170
	// meta tag terminators
	content = content.replace(/(<(meta) [^\>]*[^\/])>/g, '$1 />');
	// decode LT/GT entities in noscript
	content = content.replace(/<noscript>[^\<]*<\/noscript>/,
		function(m) { return m.replace(/&lt;/g, '<').replace(/&gt;/g, '>') });
	// encode copyright symbols (UTF-8 to HTML entity)
	content = content.replace(/<div id="copyright">[^\<]*<\/div>/,
		function(m) { return m.replace(/\xA9/g, '&copy;') });

	return content;
}

// reconstruct the local path to TW itself
tw.io.getOriginalLocalPath = function() {
	return getLocalPath(document.location.toString());
};

// Save tiddlywiki (but not backup or anything else)
tw.io.knownSaveMainFailures = {
	failedToLoadOriginal: 1,
	invalidFile: 2
};

// Save this tiddlywiki with the pending changes
tw.io.saveMainAndReport = function(callback) {
	var localPath = tw.io.getOriginalLocalPath();
	var onLoadOriginal = function(original) {
		var msg = config.messages;
		if(original == null) {
			alert(msg.cantSaveError);
			if(store.tiddlerExists(msg.saveInstructions))
				story.displayTiddler(null, msg.saveInstructions);

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.failedToLoadOriginal
			});
		}

		var posDiv = locateStoreArea(original);
		if(!posDiv) {
			alert(msg.invalidFileError.format([localPath]));

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.invalidFile
			});
		}

		config.saveByDownload = false;
		config.saveByManualDownload = false;
		// chkPreventAsyncSaving is checked inside saveMain
		saveMain(localPath, original, posDiv, callback);
	};

	if(!config.options.chkPreventAsyncSaving) {
		loadOriginal(localPath, onLoadOriginal);
	} else {
		// useful when loadOriginal is overwritten without support of callback
		// or when an extension relies saveChanges being a sync function
		var original = loadOriginal(localPath);
		onLoadOriginal(original);
	}
};

function saveChanges(onlyIfDirty, tiddlers) {
	if(onlyIfDirty && !store.isDirty()) return;

	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	if(!window.allowSave()) {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null, msg.saveInstructions);
		return;
	}

	tw.io.saveMainAndReport(function postSave(savedOrPending, details) {
		var co = config.options;
		if (!config.saveByDownload && !config.saveByManualDownload && details && details.original) {
			var localPath = tw.io.getOriginalLocalPath();
			if(co.chkSaveBackups) saveBackup(localPath, details.original);
			if(co.chkSaveEmptyTemplate) saveEmpty(localPath, details.original);
			if(co.chkGenerateAnRssFeed) saveRss(localPath);
		}

		if(co.chkDisplayInstrumentation)
			displayMessage("saveChanges " + (new Date() - t0) + " ms");
	});
}

function saveMain(localPath, original, posDiv, callback) {
	var reportStatusAndHandle = function(successOrPending, localPath, revised) {
		if(successOrPending) {
			tw.io.onSaveMainSuccess(config.saveByDownload ?
				getDataURI(revised) : "file://" + localPath, revised, original);
		} else {
			tw.io.onSaveMainFail();
		}
	};
	try {
		var revised = updateOriginal(original, posDiv, localPath);

		if(!callback || config.options.chkPreventAsyncSaving) {
			var savedOrPending = tw.io.saveFile(localPath, revised);
			reportStatusAndHandle(savedOrPending, localPath, revised);
			if(callback) callback(savedOrPending, {
				original: original
			});
		} else tw.io.saveFile(localPath, revised, function(success, details) {
			reportStatusAndHandle(success, localPath, revised);
			details.original = original;
			callback(success, details);
		});
	} catch (ex) {
		tw.io.onSaveMainFail(ex);
		if(callback) callback(false, { original: original });
	}
}

tw.io.onSaveMainSuccess = function(urlSaved, savedHtml, original) {
	if (!config.saveByManualDownload) {
		displayMessage(
			// set by HTML5DownloadSaveFile()
			config.saveByDownload ?
				config.messages.mainDownload :
				config.messages.mainSaved,
			urlSaved);
	}

	store.setDirty(false);
};

tw.io.onSaveMainFail = function(catchedExeption) {
	alert(config.messages.mainFailed);
	if(catchedExeption) showException(catchedExeption);
};

function saveBackup(localPath, original) {
	var backupPath = getBackupPath(localPath);
	var backupSuccess = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(backupSuccess)
		displayMessage(config.messages.backupSaved, "file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath, original, posDiv) {
	posDiv = posDiv || locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.emptyFailed);
		return;
	}

	var emptyPath, slashPosition;
	if((slashPosition = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "/";
	else if((slashPosition = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";

	var empty = original.substr(0, posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath, empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved, "file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

// Translate URL to local path [Preemption]
window.getLocalPath = window.getLocalPath || function(origPath) {
	var originalPath = convertUriToUTF8(origPath, config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0, argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0, hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/", "g"), "\\");
	return localPath;
};

function getBackupPath(localPath, filenameSuffix, extension) {
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder || ".";
	var backupPath = localPath.substring(0, dirPathPos) + slash + backupFolder + localPath.substring(dirPathPos);
	backupPath = backupPath.substring(0, backupPath.lastIndexOf(".")) + ".";
	if(filenameSuffix) {
		var illegalFilenameCharacterOrSpaceRE = /[\\\/\*\?\":<> ]/g;
		backupPath += filenameSuffix.replace(illegalFilenameCharacterOrSpaceRE, "_") + ".";
	}
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath, callback) {
	var rssPath = localPath.substr(0, localPath.lastIndexOf(".")) + ".xml";

	tw.io.saveFile(rssPath, generateRss(), callback || function(result, details) {
		if(result)
			displayMessage(config.messages.rssSaved, "file://" + rssPath);
		else
			alert(config.messages.rssFailed);
	});
}

function tiddlerToRssItem(tiddler, uri) {
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text, null, tiddler).htmlEncode() + "</description>\n";
	for(var i = 0; i < tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s += "<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
}

function generateRss() {
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlainText(store.getTiddlerText("SiteTitle", ""),
		null, tiddler).htmlEncode() + "</title" + ">");
	if(u) s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlainText(store.getTiddlerText("SiteSubtitle", ""),
		null, tiddler).htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified", "excludeLists");
	var i, n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length - config.numRssItems;
	for(i = tiddlers.length - 1; i >= n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i], u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

// Copy a file in filesystem [Preemption]
window.copyFile = window.copyFile || function(dest, source) {
	return config.browser.isIE ? ieCopyFile(dest, source) : false;
};

// Save a file in filesystem [Preemption]
window.saveFile = window.saveFile || function(fileUrl, content) {
	var r = mozillaSaveFile(fileUrl, content);
	if(!r)
		r = ieSaveFile(fileUrl, content);
	if(!r)
		r = javaSaveFile(fileUrl, content);
	if(!r)
		r = HTML5DownloadSaveFile(fileUrl, content);
	if(!r)
		r = manualSaveFile(fileUrl, content);
	return r;
};

// A placeholder method that can be overwritten/decorated by savers.
// In such a case, it's required to call callback on both success and fail.
// See details about the callback in tw.io.saveFile.
tw.io.asyncSaveFile = tw.io.asyncSaveFile || function(fileUrl, content, callback) {
	callback(false, { reason: 'Async saving is not implemented' });
};

// The general save method to use
// ==============================
// If callback is set, tries to save in an async fashion and do callback(success: boolean, details: object)
// â ï¸ Some savers within window.saveFile, like download saving or Timimi don't care about the callback,
// so it can be called before actual saving is done (or even give false positives).
tw.io.saveFile = function(fileUrl, content, callback) {
	if(!callback) return saveFile(fileUrl, content);

	tw.io.asyncSaveFile(fileUrl, content, function(success, details) {
		if(success) callback(success, details);
		else {
			result = saveFile(fileUrl, content);
			callback(result, {});
		}
	});
};

// Load a file from filesystem [Preemption]
window.loadFile = window.loadFile || function(fileUrl) {
	var r = mozillaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = ieLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = javaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = tw.io.xhrLoadFile(fileUrl);
	return r;
};

tw.io.xhrLoadFile = function(filePath, callback) {
	try {
		var isAsync = !!callback;
		var url = 'file://' + (filePath[0] != '/' ? '/' : '') + encodeURIComponent(filePath);
		if(isAsync) {
			httpReq('GET', url, function(status, params, responseText, url, xhr) {
				callback(responseText, { xhr: xhr });
			});
		} else {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, isAsync);
			xhr.send(null);
			return xhr.responseText;
		}
	} catch(ex) {
		return callback ? callback(null) : null;
	}
};

// The general load method to use
// ==============================
// If callback is set, tries to load in an async fashion and do callback(result, details)
tw.io.loadFile = function(fileUrl, callback) {
	if(!callback) return loadFile(fileUrl);

	tw.io.xhrLoadFile(fileUrl, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			result = loadFile(fileUrl);
			callback(result);
		}
	});
};


function ieCreatePath(path) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	// Remove the filename, if present. Use trailing slash (i.e. "foo\bar\") if no filename.
	var pos = path.lastIndexOf("\\");
	if(pos == -1) pos = path.lastIndexOf("/");
	if(pos != -1) path = path.substring(0, pos + 1);

	// Walk up the path until we find a folder that exists
	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	// Walk back down the path, creating folders
	for(var i = scan.length - 1; i >= 0; i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content) {
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath, 2, -1, 0);
	file.Write(convertUnicodeToHtmlEntities(content));
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath, 1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest, source) {
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content) {
	if(!window.Components) return null;

	content = mozConvertUnicodeToUTF8(content);
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"]
			.createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			file.create(0, 0x01B4);// 0x01B4 = 0664
		var out = Components.classes["@mozilla.org/network/file-output-stream;1"]
			.createInstance(Components.interfaces.nsIFileOutputStream);
		out.init(file, 0x22, 0x04, null);
		out.write(content, content.length);
		out.flush();
		out.close();
		return true;
	} catch(ex) {
		return false;
	}
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath) {
	if(!window.Components) return null;

	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			return null;
		var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"]
			.createInstance(Components.interfaces.nsIFileInputStream);
		inputStream.init(file, 0x01, 0x04, null);
		var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"]
			.createInstance(Components.interfaces.nsIScriptableInputStream);
		sInputStream.init(inputStream);
		var contents = sInputStream.read(sInputStream.available());
		sInputStream.close();
		inputStream.close();
		return mozConvertUTF8ToUnicode(contents);
	} catch(ex) {
		return false;
	}
}

function HTML5DownloadSaveFile(filePath, content) {
	var link = document.createElement("a");
	if(link.download === undefined)
		return null;

	config.saveByDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	link.setAttribute("target", "_blank");
	link.setAttribute("href", uri);
	link.setAttribute("download", filename);
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function manualSaveFile(filePath, content) {
	// FALLBACK for showing a link to data: URI
	config.saveByManualDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	displayMessage(config.messages.mainDownloadManual, uri);
	return true;
}

// construct data URI (using base64 encoding to preserve multi-byte encodings)
function getDataURI(data) {
	return config.browser.isIE ?
		"data:text/html," + encodeURIComponent(data) :

		// manualConvertUnicodeToUTF8 was moved here from convertUnicodeToFileFormat
		// In 2.9.1, it was used only for FireFox but happened to fix
		// download saving non-ASCII in Chrome & Safari as well (see 949aff6)
		"data:text/html;base64," + encodeBase64(manualConvertUnicodeToUTF8(data));
}

function encodeBase64(data) {
	if (!data) return "";
	var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
	var out = "";
	var chr1, chr2, chr3 = "";
	var enc1, enc2, enc3, enc4 = "";
	for (var i = 0; i < data.length; ) {
		chr1 = data.charCodeAt(i++);
		chr2 = data.charCodeAt(i++);
		chr3 = data.charCodeAt(i++);
		enc1 = chr1 >> 2;
		enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
		enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
		enc4 = chr3 & 63;
		if (isNaN(chr2)) enc3 = enc4 = 64;
		else if (isNaN(chr3)) enc4 = 64;
		out += keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
		chr1 = chr2 = chr3 = enc1 = enc2 = enc3 = enc4 = "";
	}
	return out;
}

//--
//-- Filesystem utilities
//--

function convertUTF8ToUnicode(u) {
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}


function manualConvertUTF8ToUnicode(utf) {
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s + fin : s;
}

function manualConvertUnicodeToUTF8(s) {
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUnicodeToHtmlEntities(s) {
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re, function($0) { return "&#" + $0.charCodeAt(0).toString() + ";" });
}

function convertUriToUTF8(uri, charSet) {
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"]
			.getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri, charSet);
}

// deprecated helper for backward-compatibility with elder extensions
// (browser/saving method-specific convertion is only needed in browser-specific savers)
function convertUnicodeToFileFormat(s) {
	return s;
}

// deprecated helper for backward-compatibility with elder extensions
function convertUnicodeToUTF8(s) {
	return s;
}

//--
//-- Server adaptor base class
//--

function AdaptorBase() {
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function() {
	return true;
};

AdaptorBase.prototype.fullHostName = function(host) {
	if(!host) return '';
	host = jQuery.trim(host);
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length - 1) == '/')
		host = host.substr(0, host.length - 1);
	return host;
};

AdaptorBase.minHostName = function(host) {
	return host;
};

AdaptorBase.prototype.setContext = function(context, userParams, callback) {
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
//   host - uri of host (eg, "http://www.tiddlywiki.com/" or "www.tiddlywiki.com")
//   context is itself passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - optional function to be called on completion
// Return value is true if the request was successfully issued, false if this connector doesn't support openHost(),
//   or an error description string if there was a problem
// The callback parameters are callback(context)
//   context.status - true if OK, string if error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openHost function
AdaptorBase.prototype.openHost = function(host, context, userParams, callback) {
	this.host = host;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	return true;
};

// Open the specified workspace
//   workspace - name of workspace to open
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openWorkspace function
AdaptorBase.prototype.openWorkspace = function(workspace, context, userParams, callback) {
	this.workspace = workspace;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor() {}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiSuccess = function(context, jqXHR) {
	context.status = true;
	context.adaptor.store = new TiddlyWiki();
	if(!context.adaptor.store.importTiddlyWiki(jqXHR.responseText)) {
		context.statusText = config.messages.invalidFileError.format([context.host]);
		context.status = false;
	}
	context.complete(context, context.userParams);
};

FileAdaptor.loadTiddlyWikiError = function(context, jqXHR) {
	context.status = false;
	context.statusText = jqXHR.message;
	context.complete(context, context.userParams);
};

// Get the list of workspaces on a given server
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   false if this connector doesn't support getWorkspaceList(),
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the getWorkspaceList function
FileAdaptor.prototype.getWorkspaceList = function(context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.workspaces = [{ title: "(default)" }];
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

// Gets the list of tiddlers within a given workspace
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
//   filter - filter expression
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddlers - array of tiddler objects
//   userParams - parameters as originally passed into the getTiddlerList function
FileAdaptor.prototype.getTiddlerList = function(context, userParams, callback, filter) {
	context = this.setContext(context, userParams, callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		file: context.file, // for HTML5 FileReader
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			context.xhr = jqXHR;
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerListComplete = function(context, userParams) {
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title, tiddler) { context.tiddlers.push(tiddler) });
		}
		for(var i = 0; i < context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler) {
	return {
		uri: tiddler.fields['server.host'] + "#" + tiddler.title
	};
};

// Retrieve a tiddler from a given workspace on a given server
//   title - title of the tiddler to get
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddler - the retrieved tiddler, or null if it cannot be found
//   userParams - parameters as originally passed into the getTiddler function
FileAdaptor.prototype.getTiddler = function(title, context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	if(context.adaptor.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerComplete = function(context, userParams) {
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context, userParams);
	} else {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.close = function() {
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

// Perform an http request using the jQuery ajax function
// fallback to privileged file I/O or HTML5 FileReader
function ajaxReq(args) {
	if (args.file || args.url.startsWith("file"))  // LOCAL FILE
		return localAjax(args);
	return jQuery.ajax(args);
}

// perform local I/O and FAKE a minimal XHR response object
function localAjax(args) {
	var success = function(data) {
		args.success(data, "success", { responseText: data });
	};
	var failure = function(who) {
		args.error({ message: who + ": cannot read local file" }, "error", 0);
	};

	if (args.file) try { // HTML5 FileReader (Chrome, FF20+, Safari, etc.)
		var reader = new FileReader();
		reader.onload = function(e)  { success(e.target.result) };
		reader.onerror = function(e) { failure("FileReader") };
		reader.readAsText(args.file);
		return true;
	} catch (ex) { ; }

	// local file I/O (IE, FF with security.fileuri.strict_origin_policy:false, etc.)
	try {
		var data = loadFile(getLocalPath(args.url));
		if (data) success(data);
		else failure("loadFile");
		return true;
	} catch (ex) { ; }

	return true;
}

// Perform an http request
//   type - GET/POST/PUT/DELETE
//   url - the source url
//   data - optional data for POST and PUT
//   contentType - optionalContent type for the data (defaults to application/x-www-form-urlencoded)
//   username - optional username for basic authentication
//   password - optional password for basic authentication
//   callback - function to call when there is a response
//   params - parameter object that gets passed to the callback for storing it's state
//   headers - optional hashmap of additional headers
//   allowCache - unless true, adds a "nocache=" parameter to the URL
// Return value is the underlying XMLHttpRequest object, or a string if there was an error
// Callback function is called like this:
//   callback(status, params, responseText, url, xhr)
//     status - true if OK, false if error
//     params - the parameter object provided to loadRemoteFile()
//     responseText - the text of the file
//     url - requested URL
//     xhr - the underlying XMLHttpRequest object
function httpReq(type, url, callback, params, headers, data, contentType, username, password, allowCache) {
	var httpSuccess = function(xhr) {
		try {
			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
			return (!xhr.status && location.protocol === "file:") ||
				(xhr.status >= 200 && xhr.status < 300) ||
				xhr.status === 304 || xhr.status === 1223;
		} catch(e) {}
		return false;
	};

	var options = {
		type: type,
		url: url,
		processData: false,
		data: data,
		cache: !!allowCache,
		beforeSend: function(xhr) {
			for(var i in headers)
				xhr.setRequestHeader(i, headers[i]);
		}
	};

	if(callback) {
		options.complete = function(xhr, textStatus) {
			if(httpSuccess(xhr))
				callback(true, params, xhr.responseText, url, xhr);
			else
				callback(false, params, null, url, xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	try {
		if(window.Components && window.netscape && window.netscape.security
		   && document.location.protocol.indexOf("http") == -1)
			window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	} catch (ex) {
	}
	return jQuery.ajax(options);
}
//--
//-- TiddlyWiki-specific utility functions
//--

// Return TiddlyWiki version string
function formatVersion(v) {
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "") +
		(v.nightly ? " (nightly " + v.nightly + ")" : "");
}

function compareVersions(v1, v2) {
	var x1, x2, i, a = ["major", "minor", "revision"];
	for(i = 0; i < a.length; i++) {
		x1 = v1[a[i]] || 0;
		x2 = v2[a[i]] || 0;
		if(x1 < x2) return +1;
		if(x1 > x2) return -1;
	}
	x1 = v1.beta || Infinity;
	x2 = v2.beta || Infinity;
	return x1 < x2 ? +1 :
	       x1 > x2 ? -1 : 0;
}

function merge(dst, src, preserveExisting) {
	for(var key in src)
		if(!preserveExisting || dst[key] === undefined)
			dst[key] = src[key];

	return dst;
}

// Get the target of an event
function resolveTarget(event) {
	var obj = event.target || event.srcElement;
	// defeat Safari bug
	if(obj.nodeType == 3)
		obj = obj.parentNode;
	return obj;
}

// Return the description of an exception (string)
function exceptionText(ex, prependedMessage) {
	var s = ex.description || ex.toString();
	return prependedMessage ? (prependedMessage + ":\n" + s) : s;
}

// Display an alert of an exception description with optional message
function showException(e, prependedMessage) {
	alert(exceptionText(e, prependedMessage));
}

function alertAndThrow(m) {
	alert(m);
	throw(m);
}

function glyph(name) {
	var g = config.glyphs;
	if(!g.codes[name]) return "";
	if(g.currBrowser == null) {
		var i = 0;
		while(i < g.browsers.length - 1 && !g.browsers[i]())
			i++;
		g.currBrowser = i;
	}
	return g.codes[name][g.currBrowser];
}

function createTiddlyText(parent, text) {
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent, caption, checked, onChange) {
	var cb = document.createElement("input");
	cb.setAttribute("type", "checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption, parent);
	return cb;
}

function createTiddlyElement(parent, element, id, className, text, attribs) {
	var n, e = document.createElement(element);
	if(className != null) e.className = className;
	if(       id != null) e.setAttribute('id', id);
	if(     text != null) createTiddlyText(e, text);
	if(attribs) {
		for(n in attribs) e.setAttribute(n, attribs[n]);
	}
	if(parent != null) parent.appendChild(e);
	return e;
}

function createTiddlyButton(parent, text, tooltip, action, className, id, accessKey, customAttributes) {
	var attributes = { href: 'javascript:;' };
	if(tooltip)   attributes.title = tooltip;
	if(accessKey) attributes.accessKey = accessKey;
	merge(attributes, customAttributes || {});

	var btn = createTiddlyElement(parent, 'a', id || null, className || 'button', text, attributes);
	if(action) btn.onclick = action;
	return btn;
}

function createExternalLink(place, url, label) {
	var tooltip = config.messages.externalLinkTooltip;
	var link = createTiddlyElement(place, 'a', null, 'externalLink', label, {
		href: url,
		title: tooltip ? tooltip.format([url]) : url
	});
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	return link;
}

function getTiddlyLinkInfo(title, currClasses) {
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
	    var f;
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			f = config.messages.shadowedTiddlerToolTip;
			classes.pushUnique("shadow");
		} else {
			f = config.messages.undefinedTiddlerToolTip;
			classes.remove("shadow");
		}
		subTitle = f ? f.format([title]) : "";
	}
	if(typeof config.annotations[title] == "string")
		subTitle = config.annotations[title];
	return { classes: classes.join(" "), subTitle: subTitle };
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f, config.defaultCustomFields, true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target, title, null, true, null, fields, toggling);
	}
	clearMessage();
	return false;
}

function getTiddlerLinkHref(title) {
	return window.location.toString().replace(/#.*$/, '') + story.getPermaViewHash([title]);
}

function createTiddlyLink(place, title, includeText, className, isStatic, linkedFromTiddler, noToggle) {
	var title = jQuery.trim(title);
	var text = includeText ? title : null;
	var info = getTiddlyLinkInfo(title, className);
	var btn = isStatic ?
		createExternalLink(place, store.getTiddlerText("SiteUrl", null) + story.getPermaViewHash([title])) :
		createTiddlyButton(place, text, info.subTitle, onClickTiddlerLink, info.classes, '', '', {
			href: getTiddlerLinkHref(title)
		});
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh", "link");
	btn.setAttribute("tiddlyLink", title);
	if(noToggle)
		btn.setAttribute("noToggle", "true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields", fields);
	}
	return btn;
}

function refreshTiddlyLink(e, title) {
	var info = getTiddlyLinkInfo(title, e.className);
	e.className = info.classes;
	e.title = info.subTitle;
}

function createTiddlyDropDown(place, onchange, options, defaultValue) {
	var sel = createTiddlyElement(place, "select");
	sel.onchange = onchange;

	for(var i = 0; i < options.length; i++) {
		var e = createTiddlyElement(sel, "option", null, null, options[i].caption);
		e.value = options[i].name;
		if(e.value == defaultValue)
			e.selected = true;
	}
	return sel;
}

//--
//-- TiddlyWiki-specific popup utility functions
//--

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev) {
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby && sortby.length) {
		store.sortTiddlers(tiddlers, sortby);
	}
	story.displayTiddlers(this, tiddlers);
	return false;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[") == -1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby && sortby.length) {
			store.sortTiddlers(tagged, sortby);
		}
		var titles = [];
		for(var i = 0; i < tagged.length; i++) {
			if(tagged[i].title != title)
				titles.push(tagged[i].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup, "li"),
				lingo.openAllText.format([tag]), lingo.openAllTooltip, onClickTagOpenAll);
			openAll.setAttribute("tag", tag);
			openAll.setAttribute("sortby", sortby);
			createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
			for(i = 0; i < titles.length; i++) {
				createTiddlyLink(createTiddlyElement(popup, "li"), titles[i], true);
			}
		} else {
			createTiddlyElement(popup, "li", null, "disabled", lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
		var link = createTiddlyLink(createTiddlyElement(popup, "li"), tag, false);
		createTiddlyText(link, lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place, tag, excludeTiddler, title, tooltip) {
	var btn = createTiddlyButton(place, title || tag,
		(tooltip || config.views.wikified.tag.tooltip).format([tag]), onClickTag);
	btn.setAttribute("tag", tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler", excludeTiddler);
	return btn;
}

function onClickTiddlyPopup(ev) {
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this, "div", "popupTiddler");
		wikify(tiddler.text, popup, null, tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyPopup(place, caption, tooltip, tiddler) {
	if(tiddler.text) {
		createTiddlyLink(place, caption, true);
		var btn = createTiddlyButton(place, glyph("downArrow"), tooltip, onClickTiddlyPopup, "tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place, caption);
	}
}

function onClickError(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var i = 0; i < lines.length; i++) {
		createTiddlyElement(popup, "li", null, "popupMessage", lines[i]);
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place, title, text) {
	var btn = createTiddlyButton(place, title, null, onClickError, "errorButton");
	if(text) btn.setAttribute("errorText", text);
}
//-
//- Animation engine
//-

function Animator() {
	// Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.running = 0;
	// ID of the timer used for animating
	this.timerID = 0;
	// List of animations in progress
	this.animations = [];
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() { //# Variable number of arguments
	for(var i = 0; i < arguments.length; i++)
		this.animations.push(arguments[i]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() { me.doAnimate(me) }, 10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me) {
	var i = 0;
	while(i < me.animations.length) {
		if(me.animations[i].tick()) {
			i++;
		} else {
			me.animations.splice(i, 1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress) {
	return 1 - ((Math.cos(progress * Math.PI) + 1) / 2);
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element, duration, properties, callback) {
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element, style, value) {
	switch(style) {
		case "-tw-vertScroll":
			window.scrollTo(findScrollX(), value);
			break;
		case "-tw-horizScroll":
			window.scrollTo(value, findScrollY());
			break;
		default:
			element.style[style] = value;
			break;
	}
};

Morpher.prototype.stop = function() {
	for(var i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element, p.style, p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element, this.properties);
};

Morpher.prototype.tick = function() {
	var currTime = Number(new Date());
	var i, progress = Animator.slowInSlowOut(Math.min(1, (currTime - this.startTime) / this.duration));
	for(i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
				case undefined:
				case "style":
					var value = p.start + (p.end - p.start) * progress;
					this.assignStyle(this.element, p.style, template.format([value]));
					break;
				case "color":
					break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text, startElement, targetElement, unused) {
	var e = createTiddlyElement(document.body, "div", null, "zoomer");
	createTiddlyElement(e, "div", null, null, text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{ style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px' },
		{ style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px' },
		{ style: 'width', start: Math.min(startElement.scrollWidth, winWidth),
		  end: Math.min(targetElement.scrollWidth, winWidth), template: '%0px', atEnd: 'auto' },
		{ style: 'height', start: Math.min(startElement.scrollHeight, winHeight),
		  end: Math.min(targetElement.scrollHeight, winHeight), template: '%0px', atEnd: 'auto' },
		{ style: 'fontSize', start: 8, end: 24, template: '%0pt' }
	];
	var c = function(element) { jQuery(element).remove() };
	return new Morpher(e, config.animDuration, p, c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement) {
	return new Morpher(targetElement, config.animDuration, [{
		style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)
	}]);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element, opening, unused, deleteMode) {
	element.style.overflow = 'hidden';
	// Workaround a Firefox flashing bug
	if(opening) element.style.height = '0px';
	element.style.display = 'block';
	var height = element.scrollHeight;
	var props = [];
	var callback = null;
	if(opening) {
		props.push({ style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto' });
		props.push({ style: 'opacity', start: 0, end: 1, template: '%0' });
		props.push({ style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)' });
	} else {
		props.push({ style: 'height', start: height, end: 0, template: '%0px' });
		props.push({ style: 'display', atEnd: 'none' });
		props.push({ style: 'opacity', start: 1, end: 0, template: '%0' });
		props.push({ style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)' });
		switch(deleteMode) {
			case "all":
				callback = function(element, properties) { jQuery(element).remove() };
				break;
			case "children":
				callback = function(element, properties) { jQuery(element).empty() };
				break;
		}
	}
	return new Morpher(element, config.animDuration, props, callback);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
};

Popup.create = function(root, elem, className) {
	var stackPosition = this.find(root, "popup");
	Popup.remove(stackPosition + 1);
	var popup = createTiddlyElement(document.body, elem || "ol", "popup", className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({ root: root, popup: popup });
	return popup;
};

Popup.onDocumentClick = function(ev) {
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign, halign, offset) {
	var curr = Popup.stack[Popup.stack.length - 1];
	this.place(curr.root, curr.popup, valign, halign, offset);
	jQuery(curr.root).addClass("highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0, ensureVisible(curr.popup));
};

Popup.place = function(root, popup, valign, halign, offset) {
	if(!offset)
		offset = { x: 0, y: 0 };
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth * 0.75)
		popup.style.width = winWidth * 0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e) {
	var i, pos = -1;
	for(i = this.stack.length - 1; i >= 0; i--) {
		if(isDescendant(e, this.stack[i].popup))
			pos = i;
	}
	return pos;
};

Popup.remove = function(pos) {
	if(!pos) pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from) {
	for(var i = Popup.stack.length - 1; i >= from; i--) {
		var p = Popup.stack[i];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0, from);
};

//--
//-- Wizard support
//--

function Wizard(place) {
	if(place) {
		this.formElem = findRelated(place, "wizard", "className");
		this.bodyElem = findRelated(this.formElem.firstChild, "wizardBody", "className", "nextSibling");
		this.footElem = findRelated(this.formElem.firstChild, "wizardFooter", "className", "nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name, value) {
	jQuery(this.formElem).data(name, value);
};

Wizard.prototype.getValue = function(name) {
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

Wizard.prototype.createWizard = function(place, title) {
	this.formElem = createTiddlyElement(place, "form", null, "wizard");
	createTiddlyElement(this.formElem, "h1", null, "wizard__title", title);
	this.bodyElem = createTiddlyElement(this.formElem, "div", null, "wizardBody");
	this.footElem = createTiddlyElement(this.formElem, "div", null, "wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function() {
	jQuery(this.bodyElem).empty();
};

Wizard.prototype.setButtons = function(buttonInfo, status) {
	jQuery(this.footElem).empty();
	for(var i = 0; i < buttonInfo.length; i++) {
		createTiddlyButton(this.footElem, buttonInfo[i].caption, buttonInfo[i].tooltip, buttonInfo[i].onClick);
		insertSpacer(this.footElem);
	}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem, "span", null, "status").innerHTML = status;
	}
};

Wizard.prototype.addStep = function(stepTitle, htmlString) {
	jQuery(this.bodyElem).empty();
	var wrapper = createTiddlyElement(this.bodyElem, "div");
	createTiddlyElement(wrapper, "h2", null, "wizard__subtitle", stepTitle);
	var step = createTiddlyElement(wrapper, "div", null, "wizardStep");
	step.innerHTML = htmlString;
	applyHtmlMacros(step, tiddler);
};

Wizard.prototype.getElement = function(name) {
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place, listObject, listTemplate, callback, className) {
	var table = createTiddlyElement(place, "table", null, className || "listView twtable");

	var thead = createTiddlyElement(table, "thead");
	var i, row = createTiddlyElement(thead, "tr");
	for(i = 0; i < listTemplate.columns.length; i++) {
		var columnTemplate = listTemplate.columns[i];
		var cell = createTiddlyElement(row, "th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(cell, columnTemplate, i);
			if(columnTemplate.className)
				jQuery(cell).addClass(columnTemplate.className);
		}
	}

	var rc, tbody = createTiddlyElement(table, "tbody");
	for(rc = 0; rc < listObject.length; rc++) {
		var rowObject = listObject[rc];
		row = createTiddlyElement(tbody, "tr");
		for(i = 0; i < listTemplate.rowClasses.length; i++) {
			if(rowObject[listTemplate.rowClasses[i].field])
				jQuery(row).addClass(listTemplate.rowClasses[i].className);
		}
		rowObject.rowElement = row;
		rowObject.colElements = {};
		for(i = 0; i < listTemplate.columns.length; i++) {
			cell = createTiddlyElement(row, "td");
			columnTemplate = listTemplate.columns[i];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(cell, rowObject, field, columnTemplate, i, rc);
				if(columnTemplate.className)
					jQuery(cell).addClass(columnTemplate.className);
			}
			rowObject.colElements[field] = cell;
		}
	}

	if(callback && listTemplate.actions)
		createTiddlyDropDown(place, ListView.getCommandHandler(callback), listTemplate.actions);

	if(callback && listTemplate.buttons) {
		for(i = 0; i < listTemplate.buttons.length; i++) {
			var b = listTemplate.buttons[i];
			if(b && b.name != "") createTiddlyButton(place, b.caption, null,
				ListView.getCommandHandler(callback, b.name, b.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback, name, allowEmptySelection) {
	return function(e) {
		var view = findRelated(this, "TABLE", null, "previousSibling");
		var tiddlers = ListView.getSelectedRows(view);
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view, this.value, tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view, name, tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view, callback) {
	var checkboxes = view.getElementsByTagName("input");
	var i, hadOne = false;
	for(i = 0; i < checkboxes.length; i++) {
		var cb = checkboxes[i];
		var rowName = cb.getAttribute("rowName");
		if(cb.getAttribute("type") != "checkbox" || !rowName) continue;
		callback(cb, rowName);
		hadOne = true;
	}
	return hadOne;
};

ListView.getSelectedRows = function(view) {
	var rowNames = [];
	ListView.forEachSelector(view, function(e, rowName) {
		if(e.checked) rowNames.push(rowName);
	});
	return rowNames;
};

// describes filling cells of a column of each type, a map of typeName => { createHeader, createItem }
ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyText(place, columnTemplate.title);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v);
	}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			wikify(v, place, null, null);
	}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined && v.title)
			createTiddlyPopup(place, v.title, config.messages.listView.tiddlerTooltip, v);
	}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var i = 0, msg = config.messages.sizeTemplates;
		while(i < msg.length - 1 && v < msg[i].unit)
			i++;
		createTiddlyText(place, msg[i].template.format([Math.round(v / msg[i].unit)]));
	}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		var c = columnTemplate.text;
		if(v != undefined) createExternalLink(place, v, c || v);
	}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v.formatString(columnTemplate.dateFormat));
	}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		for(var i = 0; i < v.length; i++) {
			createTiddlyText(place, v[i]);
			createTiddlyElement(place, "br");
		}
	}
};

ListView.columnTypes.Selector = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyCheckbox(place, null, false, this.onHeaderChange);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], null);
		e.setAttribute("rowName", listObject[columnTemplate.rowName]);
	},
	onHeaderChange: function(e) {
		var state = this.checked;
		var view = findRelated(this, "TABLE");
		if(!view) return;
		ListView.forEachSelector(view, function(e, rowName) {
			e.checked = state;
		});
	}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var tags = listObject[field];
		createTiddlyText(place, String.encodeTiddlyLinkList(tags));
	}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		if(listObject[field] == true)
			createTiddlyText(place, columnTemplate.trueText);
		if(listObject[field] == false)
			createTiddlyText(place, columnTemplate.falseText);
	}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], this.onChange);
		e.setAttribute("tiddler", listObject.title);
		e.setAttribute("tag", columnTemplate.tag);
	},
	onChange: function(e) {
		var tag = this.getAttribute("tag");
		var tiddler = this.getAttribute("tiddler");
		store.setTiddlerTag(tiddler, this.checked, tag);
	}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var link = createTiddlyLink(place, listObject[columnTemplate.tiddlerLink], false, null);
		createTiddlyText(link, listObject[field]);
	}
};

//--
//-- Augmented methods for the JavaScript Array() object
//--

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field, value) {
	for(var i = 0; i < this.length; i++) {
		if(this[i][field] === value) return i;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item) {
	return this.indexOf(item) != -1;
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array.
// If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item, unique) {
	if(unique === false || this.indexOf(item) == -1) {
		this.push(item);
	}
};

Array.prototype.remove = function(item) {
	var p = this.indexOf(item);
	if(p != -1) this.splice(p, 1);
};

//--
//-- Augmented methods for the JavaScript String() object
//--

// todo: create functions substituting String augmenting methods, use in the core; deprecate all String augmenting methods

// Trim whitespace from both ends of a string
String.prototype.trim = function() {
	return this.replace(/^\s*|\s*$/g, "");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s) {
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match, r = [];
	while(match = subRegExp.exec(this)) {
		if(!match[1]) continue;
		if(match.index > currPos)
			r.push(this.substring(currPos, match.index));
		r.push(substrings[parseInt(match[1], 10)]);
		currPos = subRegExp.lastIndex;
	}
	if(currPos < this.length)
		r.push(this.substring(currPos, this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function() {
	return this.replace(/[\-\/\\\^\$\*\+\?\.\(\)\|\[\]\{\}]/g, '\\$&'); // #157
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function() {
	return this.replace(/\\/mg, "\\s").replace(/\n/mg, "\\n").replace(/\r/mg, "");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function() {
	return this.replace(/\\n/mg, "\n").replace(/\\b/mg, " ").replace(/\\s/mg, "\\").replace(/\r/mg, "");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function() {
	return this.replace(/&/mg, "&amp;").replace(/</mg, "&lt;").replace(/>/mg, "&gt;").replace(/\"/mg, "&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function() {
	return this.replace(/&lt;/mg, "<").replace(/&gt;/mg, ">").replace(/&quot;/mg, "\"").replace(/&amp;/mg, "&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName, defaultValue, allowEval, noNames, cascadeDefaults) {
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" +
		dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token, "mg") :
		new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?", "mg");

	var parseToken = function(match, p) {
		// Double quoted
		if(match[p])     return match[p].replace(/\\"/g, '"');
		// Single quoted
		if(match[p + 1]) return match[p + 1].replace(/\\'/g, "'");
		// Double-square-bracket quoted
		if(match[p + 2]) return match[p + 2];
		// Double-brace quoted
		if(match[p + 3]) {
			var value = match[p + 3];
			if(allowEval && config.evaluateMacroParameters != "none") {
				try {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) value = window.restrictedEval(value);
					} else {
						value = window.eval(value);
					}
				} catch(ex) {
					throw "Unable to evaluate {{" + value + "}}: " + exceptionText(ex);
				}
			}
			return value;
		}
		// Unquoted
		if(match[p + 4]) return match[p + 4];
		// Empty quote
		if(match[p + 5]) return "";
	};

	var summary = {};
	var results = [summary], match;
	while(match = re.exec(this)) {
		// matched bit is like  firstToken  or  firstToken:tokenAfterColon  (like "param":{{evaluated expression}})
		var firstToken = parseToken(match, 1);
		if(noNames) {
			results.push({ name: "", value: firstToken });
			continue;
		}

		var tokenAfterColon = parseToken(match, 8);
		var newItem = {
			name: firstToken,
			value: tokenAfterColon
		};
		if(newItem.value == null) {
			if(defaultName) {
				newItem.value = firstToken;
				newItem.name = defaultName;
			}
			else if(defaultValue) newItem.value = defaultValue;
		}

		results.push(newItem);
		if(cascadeDefaults) {
			defaultName = newItem.name;
			defaultValue = newItem.value;
		}
	}

	for(var i = 1; i < results.length; i++) {
		var name = results[i].name;
		var value = results[i].value;
		if(!summary[name])
			summary[name] = [value];
		else
			summary[name].push(value);
	}
	return results;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval) {
	var p = this.parseParams("list", null, !notAllowEval, true);
	return p.slice(1).map(function(param) { return param.value });
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique) {
	var p = this.parseParams("list", null, false, true);
	var i, n = [];
	for(i = 1; i < p.length; i++) {
		if(p[i].value)
			n.pushUnique(p[i].value, unique);
	}
	return n;
};

// Get [startIndex, endIndex] of chunk between given startMarker and endMarker inside text, or undefined.
tw.textUtils.getChunkRange = function(text, startMarker, endMarker) {
	var s = text.indexOf(startMarker);
	if(s == -1) return;
	s += startMarker.length;
	var e = text.indexOf(endMarker, s);
	if(e != -1) return [s, e];
};

// Replace a chunk of a string given start and end markers
tw.textUtils.replaceChunk = function(text, startMarker, endMarker, newValue) {
	var r = this.getChunkRange(text, startMarker, endMarker);
	return r ? text.substring(0, r[0]) + newValue + text.substring(r[1]) : text;
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title) {
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list) {
	if(!list) return "";
	return list.map(function(item) { return String.encodeTiddlyLink(item) }).join(" ");
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function() {
	var fields = this.parseParams("anon", "", false);
	var i, hashmap = {};
	for(i = 1; i < fields.length; i++)
		hashmap[fields[i].name] = fields[i].value;
	return hashmap;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap) {
	var name, r = [];
	for(name in hashmap)
		r.push(name + ':"' + hashmap[name] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n, width) {
	var s = n.toString();
	if(s.length >= width) return s;
	return "000000000000000000000000000".substring(0, width - s.length) + s;
};

String.prototype.startsWith = function(prefix) {
	return !prefix || this.substring(0, prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params, name, defaultValue) {
	if(!params) return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params, name, defaultValue) {
	return !!getParam(params, name, defaultValue);
}

//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template) {
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	var t = template
		.replace(/0hh12/g, String.zeroPad(this.getHours12(), 2))
		.replace(/hh12/g, this.getHours12())
		.replace(/0hh/g, String.zeroPad(this.getHours(), 2))
		.replace(/hh/g, this.getHours())
		.replace(/mmm/g, config.messages.dates.shortMonths[this.getMonth()])
		.replace(/0mm/g, String.zeroPad(this.getMinutes(), 2))
		.replace(/mm/g, this.getMinutes())
		.replace(/0ss/g, String.zeroPad(this.getSeconds(), 2))
		.replace(/ss/g, this.getSeconds())
		.replace(/[ap]m/g, this.getAmPm().toLowerCase())
		.replace(/[AP]M/g, this.getAmPm().toUpperCase())
		.replace(/wYYYY/g, this.getYearForWeekNo())
		.replace(/wYY/g, String.zeroPad(this.getYearForWeekNo() - 2000, 2))
		.replace(/YYYY/g, this.getFullYear())
		.replace(/YY/g, String.zeroPad(this.getFullYear() - 2000, 2))
		.replace(/MMM/g, config.messages.dates.months[this.getMonth()])
		.replace(/0MM/g, String.zeroPad(this.getMonth() + 1, 2))
		.replace(/MM/g, this.getMonth() + 1)
		.replace(/0WW/g, String.zeroPad(this.getWeek(), 2))
		.replace(/WW/g, this.getWeek())
		.replace(/DDD/g, config.messages.dates.days[this.getDay()])
		.replace(/ddd/g, config.messages.dates.shortDays[this.getDay()])
		.replace(/0DD/g, String.zeroPad(this.getDate(), 2))
		.replace(/DDth/g, this.getDate() + this.daySuffix())
		.replace(/DD/g, this.getDate())
		.replace(/TZD/g, (tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60), 2) +
			':' + String.zeroPad(atz % 60, 2))
		.replace(/\\/g, "");
	return t;
};

Date.prototype.getWeek = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week to calculate weekNo
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	var n = Math.floor((dt.getTime() - new Date(dt.getFullYear(), 0, 1) + 3600000) / 86400000);
	return Math.floor(n / 7) + 1;
};

Date.prototype.getYearForWeekNo = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	return dt.getFullYear();
};

Date.prototype.getHours12 = function() {
	var h = this.getHours();
	return h > 12 ? h - 12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function() {
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function() {
	return config.messages.dates.daySuffixes[this.getDate() - 1];
};

// Convert to local YYYYMMDDHHMM format string
Date.prototype.convertToLocalYYYYMMDDHHMM = function() {
	return this.getFullYear() + String.zeroPad(this.getMonth() + 1, 2) + String.zeroPad(this.getDate(), 2) +
		String.zeroPad(this.getHours(), 2) + String.zeroPad(this.getMinutes(), 2);
};

// Convert to UTC YYYYMMDDHHMM format string
Date.prototype.convertToYYYYMMDDHHMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) + String.zeroPad(this.getUTCDate(), 2) +
		String.zeroPad(this.getUTCHours(), 2) + String.zeroPad(this.getUTCMinutes(), 2);
};

// Convert to UTC YYYYMMDD.HHMMSSMMM format string
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) +
		String.zeroPad(this.getUTCDate(), 2) + "." + String.zeroPad(this.getUTCHours(), 2) +
		String.zeroPad(this.getUTCMinutes(), 2) + String.zeroPad(this.getUTCSeconds(), 2) +
		String.zeroPad(this.getUTCMilliseconds(), 3) + "0";
};

// Static. Create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 12));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 14));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0, 4), 10),
		parseInt(d.substr(4, 2), 10) - 1,
		parseInt(d.substr(6, 2), 10),
		parseInt(d.substr(8, 2) || "00", 10),
		parseInt(d.substr(10, 2) || "00", 10),
		parseInt(d.substr(12, 2) || "00", 10),
		parseInt(d.substr(14, 3) || "000", 10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r, g, b) {
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0, 1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1, 2), 16) / 255;
				this.g = parseInt(r.substr(3, 2), 16) / 255;
				this.b = parseInt(r.substr(5, 2), 16) / 255;
			} else {
				this.r = parseInt(r.substr(1, 1), 16) / 15;
				this.g = parseInt(r.substr(2, 1), 16) / 15;
				this.b = parseInt(r.substr(3, 1), 16) / 15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1], 10) / 255;
				this.g = parseInt(c[2], 10) / 255;
				this.b = parseInt(c[3], 10) / 255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c, f) {
	return new RGB(this.r + (c.r - this.r) * f, this.g + (c.g - this.g) * f, this.b + (c.b - this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function() {
	var to255Range = function(value) {
		var clamped = value < 0 ? 0 : value > 1 ? 1 : value;
		return clamped * 255;
	};

	var to2DigitString = function(value) {
		var s = Math.floor(value).toString(16);
		return ("0" + s).slice(-2);
	};

	return "#" +
		to2DigitString(to255Range(this.r)) +
		to2DigitString(to255Range(this.g)) +
		to2DigitString(to255Range(this.b));
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

tw.assets.icons.closeSvg =
	'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" class="tw-icon">' +
	'	<line x1="1" y1="1" x2="9" y2="9" rx="1" ry="1"/>' +
	'	<line x1="9" y1="1" x2="1" y2="9" rx="1" ry="1"/>' +
	'</svg>';

function drawGradient(place, horiz, loColors, hiColors) {
	if(!hiColors) hiColors = loColors;

	for(var i = 0; i <= 100; i += 2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? i + "%" : 0;
		bar.style.top = horiz ? 0 : i + "%";
		bar.style.width = horiz ? (101 - i) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101 - i) + "%";
		bar.style.zIndex = -1;
		var p = i / 100 * (loColors.length - 1);
		var hc = hiColors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = loColors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc, p - Math.floor(p)).toString();
	}
}

function addEvent(obj, type, fn) {
	if(obj.attachEvent) {
		obj["e" + type + fn] = fn;
		obj[type + fn] = function() { obj["e" + type + fn](window.event) };
		obj.attachEvent("on" + type, obj[type + fn]);
	} else {
		obj.addEventListener(type, fn, false);
	}
}

function removeEvent(obj, type, fn) {
	if(obj.detachEvent) {
		obj.detachEvent("on" + type, obj[type + fn]);
		obj[type + fn] = null;
	} else {
		obj.removeEventListener(type, fn, false);
	}
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e, value, name, relative) {
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !jQuery(e).hasClass(value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e) {
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth() {
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight() {
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
	var d = document;
	return Math.max(
		Math.max(d.body.scrollHeight, d.documentElement.scrollHeight),
		Math.max(d.body.offsetHeight, d.documentElement.offsetHeight),
		Math.max(d.body.clientHeight, d.documentElement.clientHeight)
	);
}

// Get the current horizontal page scroll position
function findScrollX() {
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY() {
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj) {
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj) {
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

function blurElement(e) {
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place) {
	var e = document.createTextNode(String.fromCharCode(160));
	if(place) place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e, text) {
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0, e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length, oldpos + text.length);
		// scroll into view
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0, e.selectionStart).split("\n").length - 1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) { // support IE
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e, pos) {
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) { // support IE
		e.focus();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character', pos);
		sel.moveEnd('character', 0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e) {
	var text = "";
	while(e && e.nodeName == "#text") {
		text += e.nodeValue;
		e = e.nextSibling;
	}
	return text;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e, ancestor) {
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e) {
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e) {
	if(!config.browser.isIE) return;
	var att = e.attributes;
	if(att) {
		for(var i = 0; i < att.length; i++) {
			var n = att[i].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s, id, doc) {
	jQuery.twStylesheet(s, { id: id, doc: doc });
}

function removeStyleSheet(id) {
	jQuery.twStylesheet.remove({ id: id });
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store, node, tiddlers) {
	var title = this.getTitle(store, node);
	if(!title) return;
	if(safeMode && store.isShadowTiddler(title)) return;

	var tiddler = store.createTiddler(title);
	this.internalizeTiddler(store, tiddler, title, node);
	tiddlers.push(tiddler);
};

LoaderBase.prototype.loadTiddlers = function(store, nodes) {
	var i, tiddlers = [];
	for(i = 0; i < nodes.length; i++) {
		try {
			this.loadTiddler(store, nodes[i], tiddlers);
		} catch(ex) {
			showException(ex, config.messages.tiddlerLoadError.format([this.getTitle(store, nodes[i])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store) {
	var results = [];
	var i, tiddlers = store.getTiddlers("title");
	for(i = 0; i < tiddlers.length; i++) {
		if(!tiddlers[i].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[i]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store, node) {
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title") || node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var prefixLen = store.idPrefix.length;
		if(node.id.substr(0, prefixLen) == store.idPrefix)
			title = node.id.substr(prefixLen);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store, tiddler, title, node) {
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute && node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName != "PRE" && e.nodeName != "pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg, "").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var i, attrs = node.attributes;
	for(i = attrs.length - 1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title, text, modifier, modified, tags, created, fields, creator);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store, tiddler) {
	try {
		var usePre = config.options.chkUsePreForStorage;
		var created = tiddler.created;
		var modified = tiddler.modified;
		var tags = tiddler.getTags();
		var attributes =
			(tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "") +
			(tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "") +
			((usePre && created == version.date) ? "" : ' created="' + created.convertToYYYYMMDDHHMM() + '"') +
			((usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() + '"') +
			((!usePre || tags) ? ' tags="' + tags.htmlEncode() + '"' : "");
		var extendedAttributes = "";
		store.forEachField(tiddler, function(tiddler, fieldName, value) {
			if(typeof value != "string")
				value = "";
			// don't store fields from the temp namespace
			if(!fieldName.match(/^temp\./))
				extendedAttributes += ' %0="%1"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);
		}, true);
		return ('<div %0="%1"%2%3>%4</' + 'div>').format([
			usePre ? "title" : "tiddler",
			tiddler.title.htmlEncode(),
			attributes,
			extendedAttributes,
			usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
		]);
	} catch (ex) {
		throw exceptionText(ex, config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};



//]]>
</script>

<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output, this.element), this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead, "mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE) text = text.replace(/\n/g, "\r");
		createTiddlyElement(w.output, "pre", null, null, text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br = {};
config.macros.br.handler = function(place)
{
	createTiddlyElement(place, "br");
};

// Find an item in an array. If a predicate is provided, use the native Array.find (return the item);
// otherwise (for backwards compatibility) treat the argument as an item to find (return the index or null)
// @Deprecated: Use indexOf instead
Array.prototype.orig_find = Array.prototype.find;
Array.prototype.find = function(itemOrPredicate)
{
	if(itemOrPredicate instanceof Function) return Array.prototype.orig_find.apply(this, arguments);
	var i = this.indexOf(itemOrPredicate);
	return i == -1 ? null : i;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
// @Deprecated: No direct substitution
Array.prototype.setItem = function(value, mode)
{
	var i = this.indexOf(value);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) this.push(value);
	} else if(mode == -1) {
		if(i != -1) this.splice(i, 1);
	}
};

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.map) {
	Array.prototype.map = function(fn, thisObj)
	{
		var scope = thisObj || window;
		var i, j, a = [];
		for(i = 0, j = this.length; i < j; ++i) {
			a.push(fn.call(scope, this[i], i, this));
		}
		return a;
	};
}

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(item, from)
	{
		if(!from) from = 0;
		for(var i = from; i < this.length; i++) {
			if(this[i] === item) return i;
		}
		return -1;
	};
}

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef, title)
{
	return store.getLoader().internalizeTiddler(store, this, title, divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated: Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store, this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement, titles, template, unused1, unused2, animate, unused3)
{
	story.displayTiddlers(srcElement, titles, template, animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement, title, template, unused1, unused2, animate, unused3)
{
	story.displayTiddler(srcElement, title, template, animate);
}

// @Deprecated: Java IO is no longer supported;
// these "empty" versions are only left for the tiny chance of backwards
// compatibility issues and will be removed completely in the future
function javaSaveFile(filePath, content)
{
	return null;
}

function javaLoadFile(filePath)
{
	return null;
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n", "mg");
var regexpBackSlash = new RegExp("\\\\", "mg");
var regexpBackSlashEss = new RegExp("\\\\s", "mg");
var regexpNewLine = new RegExp("\n", "mg");
var regexpCarriageReturn = new RegExp("\r", "mg");

//--
//-- Deprecated FileAdaptor functions
//--

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"':  '\\"',
		'\\': '\\\\'
	};
	var replaceFn = function(a, b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
	};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g, replaceFn) + '"';
	return '"' + this + '"';
};

// @Deprecated: no direct replacement, since not used in core code
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length - n) : this;
};

// @Deprecated: no direct replacement, since not used in core code (see unDash in inlineCssHelper)
// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var i, words = this.split("-");
	for(i = 1; i < words.length; i++)
		words[i] = words[i].substring(0, 1).toUpperCase() + words[i].substring(1);
	return words.join("");
};

// @Deprecated: use tw.textUtils.getChunkRange instead
String.prototype.getChunkRange = function(startMarker, endMarker)
{
	return tw.textUtils.getChunkRange(this, startMarker, endMarker);
};

// @Deprecated: no direct replacement, since not used in core code
// Get a chunk of a string between startMarker and endMarker, or undefined
String.prototype.getChunk = function(startMarker, endMarker)
{
	var r = tw.textUtils.getChunkRange(this, startMarker, endMarker);
	if(r) return this.substring(r[0], r[1]);
};

// @Deprecated: use tw.textUtils.replaceChunk instead
String.prototype.replaceChunk = function(startMarker, endMarker, newValue)
{
	return tw.textUtils.replaceChunk(this, startMarker, endMarker, newValue);
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//--
//-- Deprecated Number functions
//--

// @Deprecated: no direct replacement, since not used in core code
// Clamp a number to a range
Number.prototype.clamp = function(min, max)
{
	var c = this;
	if(c < min) c = min;
	if(c > max) c = max;
	return Number(c);
};

//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Remove a node and all its children
function removeNode(e)
{
	jQuery(e).remove();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

function addClass(e, className)
{
	jQuery(e).addClass(className);
}

function removeClass(e, className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e, className)
{
	return jQuery(e).hasClass(className);
}

//--
//-- Deprecated Wikifier code
//--

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}


//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*! jQuery v1.9.1 | (c) 2005, 2012 jQuery Foundation, Inc. | jquery.org/license
//@ sourceMappingURL=jquery.min.map
*/(function(e,t){var n,r,i=typeof t,o=e.document,a=e.location,s=e.jQuery,u=e.$,l={},c=[],p="1.9.1",f=c.concat,d=c.push,h=c.slice,g=c.indexOf,m=l.toString,y=l.hasOwnProperty,v=p.trim,b=function(e,t){return new b.fn.init(e,t,r)},x=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,w=/\S+/g,T=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,N=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,k=/^[\],:{}\s]*$/,E=/(?:^|:|,)(?:\s*\[)+/g,S=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,A=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,j=/^-ms-/,D=/-([\da-z])/gi,L=function(e,t){return t.toUpperCase()},H=function(e){(o.addEventListener||"load"===e.type||"complete"===o.readyState)&&(q(),b.ready())},q=function(){o.addEventListener?(o.removeEventListener("DOMContentLoaded",H,!1),e.removeEventListener("load",H,!1)):(o.detachEvent("onreadystatechange",H),e.detachEvent("onload",H))};b.fn=b.prototype={jquery:p,constructor:b,init:function(e,n,r){var i,a;if(!e)return this;if("string"==typeof e){if(i="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:N.exec(e),!i||!i[1]&&n)return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e);if(i[1]){if(n=n instanceof b?n[0]:n,b.merge(this,b.parseHTML(i[1],n&&n.nodeType?n.ownerDocument||n:o,!0)),C.test(i[1])&&b.isPlainObject(n))for(i in n)b.isFunction(this[i])?this[i](n[i]):this.attr(i,n[i]);return this}if(a=o.getElementById(i[2]),a&&a.parentNode){if(a.id!==i[2])return r.find(e);this.length=1,this[0]=a}return this.context=o,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):b.isFunction(e)?r.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),b.makeArray(e,this))},selector:"",length:0,size:function(){return this.length},toArray:function(){return h.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=b.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return b.each(this,e,t)},ready:function(e){return b.ready.promise().done(e),this},slice:function(){return this.pushStack(h.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},map:function(e){return this.pushStack(b.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:d,sort:[].sort,splice:[].splice},b.fn.init.prototype=b.fn,b.extend=b.fn.extend=function(){var e,n,r,i,o,a,s=arguments[0]||{},u=1,l=arguments.length,c=!1;for("boolean"==typeof s&&(c=s,s=arguments[1]||{},u=2),"object"==typeof s||b.isFunction(s)||(s={}),l===u&&(s=this,--u);l>u;u++)if(null!=(o=arguments[u]))for(i in o)e=s[i],r=o[i],s!==r&&(c&&r&&(b.isPlainObject(r)||(n=b.isArray(r)))?(n?(n=!1,a=e&&b.isArray(e)?e:[]):a=e&&b.isPlainObject(e)?e:{},s[i]=b.extend(c,a,r)):r!==t&&(s[i]=r));return s},b.extend({noConflict:function(t){return e.$===b&&(e.$=u),t&&e.jQuery===b&&(e.jQuery=s),b},isReady:!1,readyWait:1,holdReady:function(e){e?b.readyWait++:b.ready(!0)},ready:function(e){if(e===!0?!--b.readyWait:!b.isReady){if(!o.body)return setTimeout(b.ready);b.isReady=!0,e!==!0&&--b.readyWait>0||(n.resolveWith(o,[b]),b.fn.trigger&&b(o).trigger("ready").off("ready"))}},isFunction:function(e){return"function"===b.type(e)},isArray:Array.isArray||function(e){return"array"===b.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[m.call(e)]||"object":typeof e},isPlainObject:function(e){if(!e||"object"!==b.type(e)||e.nodeType||b.isWindow(e))return!1;try{if(e.constructor&&!y.call(e,"constructor")&&!y.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}var r;for(r in e);return r===t||y.call(e,r)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||o;var r=C.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=b.buildFragment([e],t,i),i&&b(i).remove(),b.merge([],r.childNodes))},parseJSON:function(n){return e.JSON&&e.JSON.parse?e.JSON.parse(n):null===n?n:"string"==typeof n&&(n=b.trim(n),n&&k.test(n.replace(S,"@").replace(A,"]").replace(E,"")))?Function("return "+n)():(b.error("Invalid JSON: "+n),t)},parseXML:function(n){var r,i;if(!n||"string"!=typeof n)return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(o){r=t}return r&&r.documentElement&&!r.getElementsByTagName("parsererror").length||b.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&&b.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(j,"ms-").replace(D,L)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var r,i=0,o=e.length,a=M(e);if(n){if(a){for(;o>i;i++)if(r=t.apply(e[i],n),r===!1)break}else for(i in e)if(r=t.apply(e[i],n),r===!1)break}else if(a){for(;o>i;i++)if(r=t.call(e[i],i,e[i]),r===!1)break}else for(i in e)if(r=t.call(e[i],i,e[i]),r===!1)break;return e},trim:v&&!v.call("\ufeff\u00a0")?function(e){return null==e?"":v.call(e)}:function(e){return null==e?"":(e+"").replace(T,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(M(Object(e))?b.merge(n,"string"==typeof e?[e]:e):d.call(n,e)),n},inArray:function(e,t,n){var r;if(t){if(g)return g.call(t,e,n);for(r=t.length,n=n?0>n?Math.max(0,r+n):n:0;r>n;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,o=0;if("number"==typeof r)for(;r>o;o++)e[i++]=n[o];else while(n[o]!==t)e[i++]=n[o++];return e.length=i,e},grep:function(e,t,n){var r,i=[],o=0,a=e.length;for(n=!!n;a>o;o++)r=!!t(e[o],o),n!==r&&i.push(e[o]);return i},map:function(e,t,n){var r,i=0,o=e.length,a=M(e),s=[];if(a)for(;o>i;i++)r=t(e[i],i,n),null!=r&&(s[s.length]=r);else for(i in e)r=t(e[i],i,n),null!=r&&(s[s.length]=r);return f.apply([],s)},guid:1,proxy:function(e,n){var r,i,o;return"string"==typeof n&&(o=e[n],n=e,e=o),b.isFunction(e)?(r=h.call(arguments,2),i=function(){return e.apply(n||this,r.concat(h.call(arguments)))},i.guid=e.guid=e.guid||b.guid++,i):t},access:function(e,n,r,i,o,a,s){var u=0,l=e.length,c=null==r;if("object"===b.type(r)){o=!0;for(u in r)b.access(e,n,u,r[u],!0,a,s)}else if(i!==t&&(o=!0,b.isFunction(i)||(s=!0),c&&(s?(n.call(e,i),n=null):(c=n,n=function(e,t,n){return c.call(b(e),n)})),n))for(;l>u;u++)n(e[u],r,s?i:i.call(e[u],u,n(e[u],r)));return o?e:c?n.call(e):l?n(e[0],r):a},now:function(){return(new Date).getTime()}}),b.ready.promise=function(t){if(!n)if(n=b.Deferred(),"complete"===o.readyState)setTimeout(b.ready);else if(o.addEventListener)o.addEventListener("DOMContentLoaded",H,!1),e.addEventListener("load",H,!1);else{o.attachEvent("onreadystatechange",H),e.attachEvent("onload",H);var r=!1;try{r=null==e.frameElement&&o.documentElement}catch(i){}r&&r.doScroll&&function a(){if(!b.isReady){try{r.doScroll("left")}catch(e){return setTimeout(a,50)}q(),b.ready()}}()}return n.promise(t)},b.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){l["[object "+t+"]"]=t.toLowerCase()});function M(e){var t=e.length,n=b.type(e);return b.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}r=b(o);var _={};function F(e){var t=_[e]={};return b.each(e.match(w)||[],function(e,n){t[n]=!0}),t}b.Callbacks=function(e){e="string"==typeof e?_[e]||F(e):b.extend({},e);var n,r,i,o,a,s,u=[],l=!e.once&&[],c=function(t){for(r=e.memory&&t,i=!0,a=s||0,s=0,o=u.length,n=!0;u&&o>a;a++)if(u[a].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}n=!1,u&&(l?l.length&&c(l.shift()):r?u=[]:p.disable())},p={add:function(){if(u){var t=u.length;(function i(t){b.each(t,function(t,n){var r=b.type(n);"function"===r?e.unique&&p.has(n)||u.push(n):n&&n.length&&"string"!==r&&i(n)})})(arguments),n?o=u.length:r&&(s=t,c(r))}return this},remove:function(){return u&&b.each(arguments,function(e,t){var r;while((r=b.inArray(t,u,r))>-1)u.splice(r,1),n&&(o>=r&&o--,a>=r&&a--)}),this},has:function(e){return e?b.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],this},disable:function(){return u=l=r=t,this},disabled:function(){return!u},lock:function(){return l=t,r||p.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],!u||i&&!l||(n?l.push(t):c(t)),this},fire:function(){return p.fireWith(this,arguments),this},fired:function(){return!!i}};return p},b.extend({Deferred:function(e){var t=[["resolve","done",b.Callbacks("once memory"),"resolved"],["reject","fail",b.Callbacks("once memory"),"rejected"],["notify","progress",b.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return b.Deferred(function(n){b.each(t,function(t,o){var a=o[0],s=b.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&b.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[a+"With"](this===r?n.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?b.extend(e,r):r}},i={};return r.pipe=r.then,b.each(t,function(e,o){var a=o[2],s=o[3];r[o[1]]=a.add,s&&a.add(function(){n=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=a.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=h.call(arguments),r=n.length,i=1!==r||e&&b.isFunction(e.promise)?r:0,o=1===i?e:b.Deferred(),a=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?h.call(arguments):r,n===s?o.notifyWith(t,n):--i||o.resolveWith(t,n)}},s,u,l;if(r>1)for(s=Array(r),u=Array(r),l=Array(r);r>t;t++)n[t]&&b.isFunction(n[t].promise)?n[t].promise().done(a(t,l,n)).fail(o.reject).progress(a(t,u,s)):--i;return i||o.resolveWith(l,n),o.promise()}}),b.support=function(){var t,n,r,a,s,u,l,c,p,f,d=o.createElement("div");if(d.setAttribute("className","t"),d.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=d.getElementsByTagName("*"),r=d.getElementsByTagName("a")[0],!n||!r||!n.length)return{};s=o.createElement("select"),l=s.appendChild(o.createElement("option")),a=d.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t={getSetAttribute:"t"!==d.className,leadingWhitespace:3===d.firstChild.nodeType,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/top/.test(r.getAttribute("style")),hrefNormalized:"/a"===r.getAttribute("href"),opacity:/^0.5/.test(r.style.opacity),cssFloat:!!r.style.cssFloat,checkOn:!!a.value,optSelected:l.selected,enctype:!!o.createElement("form").enctype,html5Clone:"<:nav></:nav>"!==o.createElement("nav").cloneNode(!0).outerHTML,boxModel:"CSS1Compat"===o.compatMode,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},a.checked=!0,t.noCloneChecked=a.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!l.disabled;try{delete d.test}catch(h){t.deleteExpando=!1}a=o.createElement("input"),a.setAttribute("value",""),t.input=""===a.getAttribute("value"),a.value="t",a.setAttribute("type","radio"),t.radioValue="t"===a.value,a.setAttribute("checked","t"),a.setAttribute("name","t"),u=o.createDocumentFragment(),u.appendChild(a),t.appendChecked=a.checked,t.checkClone=u.cloneNode(!0).cloneNode(!0).lastChild.checked,d.attachEvent&&(d.attachEvent("onclick",function(){t.noCloneEvent=!1}),d.cloneNode(!0).click());for(f in{submit:!0,change:!0,focusin:!0})d.setAttribute(c="on"+f,"t"),t[f+"Bubbles"]=c in e||d.attributes[c].expando===!1;return d.style.backgroundClip="content-box",d.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===d.style.backgroundClip,b(function(){var n,r,a,s="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",u=o.getElementsByTagName("body")[0];u&&(n=o.createElement("div"),n.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",u.appendChild(n).appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",a=d.getElementsByTagName("td"),a[0].style.cssText="padding:0;margin:0;border:0;display:none",p=0===a[0].offsetHeight,a[0].style.display="",a[1].style.display="none",t.reliableHiddenOffsets=p&&0===a[0].offsetHeight,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",t.boxSizing=4===d.offsetWidth,t.doesNotIncludeMarginInBodyOffset=1!==u.offsetTop,e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(d,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(d,null)||{width:"4px"}).width,r=d.appendChild(o.createElement("div")),r.style.cssText=d.style.cssText=s,r.style.marginRight=r.style.width="0",d.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(r,null)||{}).marginRight)),typeof d.style.zoom!==i&&(d.innerHTML="",d.style.cssText=s+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=3===d.offsetWidth,d.style.display="block",d.innerHTML="<div></div>",d.firstChild.style.width="5px",t.shrinkWrapBlocks=3!==d.offsetWidth,t.inlineBlockNeedsLayout&&(u.style.zoom=1)),u.removeChild(n),n=d=a=r=null)}),n=s=u=l=r=a=null,t}();var O=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,B=/([A-Z])/g;function P(e,n,r,i){if(b.acceptData(e)){var o,a,s=b.expando,u="string"==typeof n,l=e.nodeType,p=l?b.cache:e,f=l?e[s]:e[s]&&s;if(f&&p[f]&&(i||p[f].data)||!u||r!==t)return f||(l?e[s]=f=c.pop()||b.guid++:f=s),p[f]||(p[f]={},l||(p[f].toJSON=b.noop)),("object"==typeof n||"function"==typeof n)&&(i?p[f]=b.extend(p[f],n):p[f].data=b.extend(p[f].data,n)),o=p[f],i||(o.data||(o.data={}),o=o.data),r!==t&&(o[b.camelCase(n)]=r),u?(a=o[n],null==a&&(a=o[b.camelCase(n)])):a=o,a}}function R(e,t,n){if(b.acceptData(e)){var r,i,o,a=e.nodeType,s=a?b.cache:e,u=a?e[b.expando]:b.expando;if(s[u]){if(t&&(o=n?s[u]:s[u].data)){b.isArray(t)?t=t.concat(b.map(t,b.camelCase)):t in o?t=[t]:(t=b.camelCase(t),t=t in o?[t]:t.split(" "));for(r=0,i=t.length;i>r;r++)delete o[t[r]];if(!(n?$:b.isEmptyObject)(o))return}(n||(delete s[u].data,$(s[u])))&&(a?b.cleanData([e],!0):b.support.deleteExpando||s!=s.window?delete s[u]:s[u]=null)}}}b.extend({cache:{},expando:"jQuery"+(p+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(e){return e=e.nodeType?b.cache[e[b.expando]]:e[b.expando],!!e&&!$(e)},data:function(e,t,n){return P(e,t,n)},removeData:function(e,t){return R(e,t)},_data:function(e,t,n){return P(e,t,n,!0)},_removeData:function(e,t){return R(e,t,!0)},acceptData:function(e){if(e.nodeType&&1!==e.nodeType&&9!==e.nodeType)return!1;var t=e.nodeName&&b.noData[e.nodeName.toLowerCase()];return!t||t!==!0&&e.getAttribute("classid")===t}}),b.fn.extend({data:function(e,n){var r,i,o=this[0],a=0,s=null;if(e===t){if(this.length&&(s=b.data(o),1===o.nodeType&&!b._data(o,"parsedAttrs"))){for(r=o.attributes;r.length>a;a++)i=r[a].name,i.indexOf("data-")||(i=b.camelCase(i.slice(5)),W(o,i,s[i]));b._data(o,"parsedAttrs",!0)}return s}return"object"==typeof e?this.each(function(){b.data(this,e)}):b.access(this,function(n){return n===t?o?W(o,e,b.data(o,e)):null:(this.each(function(){b.data(this,e,n)}),t)},null,n,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){b.removeData(this,e)})}});function W(e,n,r){if(r===t&&1===e.nodeType){var i="data-"+n.replace(B,"-$1").toLowerCase();if(r=e.getAttribute(i),"string"==typeof r){try{r="true"===r?!0:"false"===r?!1:"null"===r?null:+r+""===r?+r:O.test(r)?b.parseJSON(r):r}catch(o){}b.data(e,n,r)}else r=t}return r}function $(e){var t;for(t in e)if(("data"!==t||!b.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}b.extend({queue:function(e,n,r){var i;return e?(n=(n||"fx")+"queue",i=b._data(e,n),r&&(!i||b.isArray(r)?i=b._data(e,n,b.makeArray(r)):i.push(r)),i||[]):t},dequeue:function(e,t){t=t||"fx";var n=b.queue(e,t),r=n.length,i=n.shift(),o=b._queueHooks(e,t),a=function(){b.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),o.cur=i,i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return b._data(e,n)||b._data(e,n,{empty:b.Callbacks("once memory").add(function(){b._removeData(e,t+"queue"),b._removeData(e,n)})})}}),b.fn.extend({queue:function(e,n){var r=2;return"string"!=typeof e&&(n=e,e="fx",r--),r>arguments.length?b.queue(this[0],e):n===t?this:this.each(function(){var t=b.queue(this,e,n);b._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&b.dequeue(this,e)})},dequeue:function(e){return this.each(function(){b.dequeue(this,e)})},delay:function(e,t){return e=b.fx?b.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,o=b.Deferred(),a=this,s=this.length,u=function(){--i||o.resolveWith(a,[a])};"string"!=typeof e&&(n=e,e=t),e=e||"fx";while(s--)r=b._data(a[s],e+"queueHooks"),r&&r.empty&&(i++,r.empty.add(u));return u(),o.promise(n)}});var I,z,X=/[\t\r\n]/g,U=/\r/g,V=/^(?:input|select|textarea|button|object)$/i,Y=/^(?:a|area)$/i,J=/^(?:checked|selected|autofocus|autoplay|async|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped)$/i,G=/^(?:checked|selected)$/i,Q=b.support.getSetAttribute,K=b.support.input;b.fn.extend({attr:function(e,t){return b.access(this,b.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){b.removeAttr(this,e)})},prop:function(e,t){return b.access(this,b.prop,e,t,arguments.length>1)},removeProp:function(e){return e=b.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,o,a=0,s=this.length,u="string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).addClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):" ")){o=0;while(i=t[o++])0>r.indexOf(" "+i+" ")&&(r+=i+" ");n.className=b.trim(r)}return this},removeClass:function(e){var t,n,r,i,o,a=0,s=this.length,u=0===arguments.length||"string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).removeClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):"")){o=0;while(i=t[o++])while(r.indexOf(" "+i+" ")>=0)r=r.replace(" "+i+" "," ");n.className=e?b.trim(r):""}return this},toggleClass:function(e,t){var n=typeof e,r="boolean"==typeof t;return b.isFunction(e)?this.each(function(n){b(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if("string"===n){var o,a=0,s=b(this),u=t,l=e.match(w)||[];while(o=l[a++])u=r?u:!s.hasClass(o),s[u?"addClass":"removeClass"](o)}else(n===i||"boolean"===n)&&(this.className&&b._data(this,"__className__",this.className),this.className=this.className||e===!1?"":b._data(this,"__className__")||"")})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(X," ").indexOf(t)>=0)return!0;return!1},val:function(e){var n,r,i,o=this[0];{if(arguments.length)return i=b.isFunction(e),this.each(function(n){var o,a=b(this);1===this.nodeType&&(o=i?e.call(this,n,a.val()):e,null==o?o="":"number"==typeof o?o+="":b.isArray(o)&&(o=b.map(o,function(e){return null==e?"":e+""})),r=b.valHooks[this.type]||b.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))});if(o)return r=b.valHooks[o.type]||b.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(n=r.get(o,"value"))!==t?n:(n=o.value,"string"==typeof n?n.replace(U,""):null==n?"":n)}}}),b.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:r.length,u=0>i?s:o?i:0;for(;s>u;u++)if(n=r[u],!(!n.selected&&u!==i||(b.support.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&b.nodeName(n.parentNode,"optgroup"))){if(t=b(n).val(),o)return t;a.push(t)}return a},set:function(e,t){var n=b.makeArray(t);return b(e).find("option").each(function(){this.selected=b.inArray(b(this).val(),n)>=0}),n.length||(e.selectedIndex=-1),n}}},attr:function(e,n,r){var o,a,s,u=e.nodeType;if(e&&3!==u&&8!==u&&2!==u)return typeof e.getAttribute===i?b.prop(e,n,r):(a=1!==u||!b.isXMLDoc(e),a&&(n=n.toLowerCase(),o=b.attrHooks[n]||(J.test(n)?z:I)),r===t?o&&a&&"get"in o&&null!==(s=o.get(e,n))?s:(typeof e.getAttribute!==i&&(s=e.getAttribute(n)),null==s?t:s):null!==r?o&&a&&"set"in o&&(s=o.set(e,r,n))!==t?s:(e.setAttribute(n,r+""),r):(b.removeAttr(e,n),t))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(w);if(o&&1===e.nodeType)while(n=o[i++])r=b.propFix[n]||n,J.test(n)?!Q&&G.test(n)?e[b.camelCase("default-"+n)]=e[r]=!1:e[r]=!1:b.attr(e,n,""),e.removeAttribute(Q?n:r)},attrHooks:{type:{set:function(e,t){if(!b.support.radioValue&&"radio"===t&&b.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(e,n,r){var i,o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return a=1!==s||!b.isXMLDoc(e),a&&(n=b.propFix[n]||n,o=b.propHooks[n]),r!==t?o&&"set"in o&&(i=o.set(e,r,n))!==t?i:e[n]=r:o&&"get"in o&&null!==(i=o.get(e,n))?i:e[n]},propHooks:{tabIndex:{get:function(e){var n=e.getAttributeNode("tabindex");return n&&n.specified?parseInt(n.value,10):V.test(e.nodeName)||Y.test(e.nodeName)&&e.href?0:t}}}}),z={get:function(e,n){var r=b.prop(e,n),i="boolean"==typeof r&&e.getAttribute(n),o="boolean"==typeof r?K&&Q?null!=i:G.test(n)?e[b.camelCase("default-"+n)]:!!i:e.getAttributeNode(n);return o&&o.value!==!1?n.toLowerCase():t},set:function(e,t,n){return t===!1?b.removeAttr(e,n):K&&Q||!G.test(n)?e.setAttribute(!Q&&b.propFix[n]||n,n):e[b.camelCase("default-"+n)]=e[n]=!0,n}},K&&Q||(b.attrHooks.value={get:function(e,n){var r=e.getAttributeNode(n);return b.nodeName(e,"input")?e.defaultValue:r&&r.specified?r.value:t},set:function(e,n,r){return b.nodeName(e,"input")?(e.defaultValue=n,t):I&&I.set(e,n,r)}}),Q||(I=b.valHooks.button={get:function(e,n){var r=e.getAttributeNode(n);return r&&("id"===n||"name"===n||"coords"===n?""!==r.value:r.specified)?r.value:t},set:function(e,n,r){var i=e.getAttributeNode(r);return i||e.setAttributeNode(i=e.ownerDocument.createAttribute(r)),i.value=n+="","value"===r||n===e.getAttribute(r)?n:t}},b.attrHooks.contenteditable={get:I.get,set:function(e,t,n){I.set(e,""===t?!1:t,n)}},b.each(["width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{set:function(e,r){return""===r?(e.setAttribute(n,"auto"),r):t}})})),b.support.hrefNormalized||(b.each(["href","src","width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{get:function(e){var r=e.getAttribute(n,2);return null==r?t:r}})}),b.each(["href","src"],function(e,t){b.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}})),b.support.style||(b.attrHooks.style={get:function(e){return e.style.cssText||t},set:function(e,t){return e.style.cssText=t+""}}),b.support.optSelected||(b.propHooks.selected=b.extend(b.propHooks.selected,{get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}})),b.support.enctype||(b.propFix.enctype="encoding"),b.support.checkOn||b.each(["radio","checkbox"],function(){b.valHooks[this]={get:function(e){return null===e.getAttribute("value")?"on":e.value}}}),b.each(["radio","checkbox"],function(){b.valHooks[this]=b.extend(b.valHooks[this],{set:function(e,n){return b.isArray(n)?e.checked=b.inArray(b(e).val(),n)>=0:t}})});var Z=/^(?:input|select|textarea)$/i,et=/^key/,tt=/^(?:mouse|contextmenu)|click/,nt=/^(?:focusinfocus|focusoutblur)$/,rt=/^([^.]*)(?:\.(.+)|)$/;function it(){return!0}function ot(){return!1}b.event={global:{},add:function(e,n,r,o,a){var s,u,l,c,p,f,d,h,g,m,y,v=b._data(e);if(v){r.handler&&(c=r,r=c.handler,a=c.selector),r.guid||(r.guid=b.guid++),(u=v.events)||(u=v.events={}),(f=v.handle)||(f=v.handle=function(e){return typeof b===i||e&&b.event.triggered===e.type?t:b.event.dispatch.apply(f.elem,arguments)},f.elem=e),n=(n||"").match(w)||[""],l=n.length;while(l--)s=rt.exec(n[l])||[],g=y=s[1],m=(s[2]||"").split(".").sort(),p=b.event.special[g]||{},g=(a?p.delegateType:p.bindType)||g,p=b.event.special[g]||{},d=b.extend({type:g,origType:y,data:o,handler:r,guid:r.guid,selector:a,needsContext:a&&b.expr.match.needsContext.test(a),namespace:m.join(".")},c),(h=u[g])||(h=u[g]=[],h.delegateCount=0,p.setup&&p.setup.call(e,o,m,f)!==!1||(e.addEventListener?e.addEventListener(g,f,!1):e.attachEvent&&e.attachEvent("on"+g,f))),p.add&&(p.add.call(e,d),d.handler.guid||(d.handler.guid=r.guid)),a?h.splice(h.delegateCount++,0,d):h.push(d),b.event.global[g]=!0;e=null}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,p,f,d,h,g,m=b.hasData(e)&&b._data(e);if(m&&(c=m.events)){t=(t||"").match(w)||[""],l=t.length;while(l--)if(s=rt.exec(t[l])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d){p=b.event.special[d]||{},d=(r?p.delegateType:p.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),u=o=f.length;while(o--)a=f[o],!i&&g!==a.origType||n&&n.guid!==a.guid||s&&!s.test(a.namespace)||r&&r!==a.selector&&("**"!==r||!a.selector)||(f.splice(o,1),a.selector&&f.delegateCount--,p.remove&&p.remove.call(e,a));u&&!f.length&&(p.teardown&&p.teardown.call(e,h,m.handle)!==!1||b.removeEvent(e,d,m.handle),delete c[d])}else for(d in c)b.event.remove(e,d+t[l],n,r,!0);b.isEmptyObject(c)&&(delete m.handle,b._removeData(e,"events"))}},trigger:function(n,r,i,a){var s,u,l,c,p,f,d,h=[i||o],g=y.call(n,"type")?n.type:n,m=y.call(n,"namespace")?n.namespace.split("."):[];if(l=f=i=i||o,3!==i.nodeType&&8!==i.nodeType&&!nt.test(g+b.event.triggered)&&(g.indexOf(".")>=0&&(m=g.split("."),g=m.shift(),m.sort()),u=0>g.indexOf(":")&&"on"+g,n=n[b.expando]?n:new b.Event(g,"object"==typeof n&&n),n.isTrigger=!0,n.namespace=m.join("."),n.namespace_re=n.namespace?RegExp("(^|\\.)"+m.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,n.result=t,n.target||(n.target=i),r=null==r?[n]:b.makeArray(r,[n]),p=b.event.special[g]||{},a||!p.trigger||p.trigger.apply(i,r)!==!1)){if(!a&&!p.noBubble&&!b.isWindow(i)){for(c=p.delegateType||g,nt.test(c+g)||(l=l.parentNode);l;l=l.parentNode)h.push(l),f=l;f===(i.ownerDocument||o)&&h.push(f.defaultView||f.parentWindow||e)}d=0;while((l=h[d++])&&!n.isPropagationStopped())n.type=d>1?c:p.bindType||g,s=(b._data(l,"events")||{})[n.type]&&b._data(l,"handle"),s&&s.apply(l,r),s=u&&l[u],s&&b.acceptData(l)&&s.apply&&s.apply(l,r)===!1&&n.preventDefault();if(n.type=g,!(a||n.isDefaultPrevented()||p._default&&p._default.apply(i.ownerDocument,r)!==!1||"click"===g&&b.nodeName(i,"a")||!b.acceptData(i)||!u||!i[g]||b.isWindow(i))){f=i[u],f&&(i[u]=null),b.event.triggered=g;try{i[g]()}catch(v){}b.event.triggered=t,f&&(i[u]=f)}return n.result}},dispatch:function(e){e=b.event.fix(e);var n,r,i,o,a,s=[],u=h.call(arguments),l=(b._data(this,"events")||{})[e.type]||[],c=b.event.special[e.type]||{};if(u[0]=e,e.delegateTarget=this,!c.preDispatch||c.preDispatch.call(this,e)!==!1){s=b.event.handlers.call(this,e,l),n=0;while((o=s[n++])&&!e.isPropagationStopped()){e.currentTarget=o.elem,a=0;while((i=o.handlers[a++])&&!e.isImmediatePropagationStopped())(!e.namespace_re||e.namespace_re.test(i.namespace))&&(e.handleObj=i,e.data=i.data,r=((b.event.special[i.origType]||{}).handle||i.handler).apply(o.elem,u),r!==t&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,n){var r,i,o,a,s=[],u=n.delegateCount,l=e.target;if(u&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!=this;l=l.parentNode||this)if(1===l.nodeType&&(l.disabled!==!0||"click"!==e.type)){for(o=[],a=0;u>a;a++)i=n[a],r=i.selector+" ",o[r]===t&&(o[r]=i.needsContext?b(r,this).index(l)>=0:b.find(r,this,null,[l]).length),o[r]&&o.push(i);o.length&&s.push({elem:l,handlers:o})}return n.length>u&&s.push({elem:this,handlers:n.slice(u)}),s},fix:function(e){if(e[b.expando])return e;var t,n,r,i=e.type,a=e,s=this.fixHooks[i];s||(this.fixHooks[i]=s=tt.test(i)?this.mouseHooks:et.test(i)?this.keyHooks:{}),r=s.props?this.props.concat(s.props):this.props,e=new b.Event(a),t=r.length;while(t--)n=r[t],e[n]=a[n];return e.target||(e.target=a.srcElement||o),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,a):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,i,a,s=n.button,u=n.fromElement;return null==e.pageX&&null!=n.clientX&&(i=e.target.ownerDocument||o,a=i.documentElement,r=i.body,e.pageX=n.clientX+(a&&a.scrollLeft||r&&r.scrollLeft||0)-(a&&a.clientLeft||r&&r.clientLeft||0),e.pageY=n.clientY+(a&&a.scrollTop||r&&r.scrollTop||0)-(a&&a.clientTop||r&&r.clientTop||0)),!e.relatedTarget&&u&&(e.relatedTarget=u===e.target?n.toElement:u),e.which||s===t||(e.which=1&s?1:2&s?3:4&s?2:0),e}},special:{load:{noBubble:!0},click:{trigger:function(){return b.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):t}},focus:{trigger:function(){if(this!==o.activeElement&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===o.activeElement&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=b.extend(new b.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?b.event.trigger(i,null,t):b.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},b.removeEvent=o.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&&(typeof e[r]===i&&(e[r]=null),e.detachEvent(r,n))},b.Event=function(e,n){return this instanceof b.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault()?it:ot):this.type=e,n&&b.extend(this,n),this.timeStamp=e&&e.timeStamp||b.now(),this[b.expando]=!0,t):new b.Event(e,n)},b.Event.prototype={isDefaultPrevented:ot,isPropagationStopped:ot,isImmediatePropagationStopped:ot,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=it,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=it,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=it,this.stopPropagation()}},b.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){b.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;
return(!i||i!==r&&!b.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),b.support.submitBubbles||(b.event.special.submit={setup:function(){return b.nodeName(this,"form")?!1:(b.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=b.nodeName(n,"input")||b.nodeName(n,"button")?n.form:t;r&&!b._data(r,"submitBubbles")&&(b.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),b._data(r,"submitBubbles",!0))}),t)},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&b.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){return b.nodeName(this,"form")?!1:(b.event.remove(this,"._submit"),t)}}),b.support.changeBubbles||(b.event.special.change={setup:function(){return Z.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(b.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)}),b.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),b.event.simulate("change",this,e,!0)})),!1):(b.event.add(this,"beforeactivate._change",function(e){var t=e.target;Z.test(t.nodeName)&&!b._data(t,"changeBubbles")&&(b.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||b.event.simulate("change",this.parentNode,e,!0)}),b._data(t,"changeBubbles",!0))}),t)},handle:function(e){var n=e.target;return this!==n||e.isSimulated||e.isTrigger||"radio"!==n.type&&"checkbox"!==n.type?e.handleObj.handler.apply(this,arguments):t},teardown:function(){return b.event.remove(this,"._change"),!Z.test(this.nodeName)}}),b.support.focusinBubbles||b.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){b.event.simulate(t,e.target,b.event.fix(e),!0)};b.event.special[t]={setup:function(){0===n++&&o.addEventListener(e,r,!0)},teardown:function(){0===--n&&o.removeEventListener(e,r,!0)}}}),b.fn.extend({on:function(e,n,r,i,o){var a,s;if("object"==typeof e){"string"!=typeof n&&(r=r||n,n=t);for(a in e)this.on(a,n,r,e[a],o);return this}if(null==r&&null==i?(i=n,r=n=t):null==i&&("string"==typeof n?(i=r,r=t):(i=r,r=n,n=t)),i===!1)i=ot;else if(!i)return this;return 1===o&&(s=i,i=function(e){return b().off(e),s.apply(this,arguments)},i.guid=s.guid||(s.guid=b.guid++)),this.each(function(){b.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,o;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,b(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(o in e)this.off(o,n,e[o]);return this}return(n===!1||"function"==typeof n)&&(r=n,n=t),r===!1&&(r=ot),this.each(function(){b.event.remove(this,e,r,n)})},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},trigger:function(e,t){return this.each(function(){b.event.trigger(e,t,this)})},triggerHandler:function(e,n){var r=this[0];return r?b.event.trigger(e,n,r,!0):t}}),function(e,t){var n,r,i,o,a,s,u,l,c,p,f,d,h,g,m,y,v,x="sizzle"+-new Date,w=e.document,T={},N=0,C=0,k=it(),E=it(),S=it(),A=typeof t,j=1<<31,D=[],L=D.pop,H=D.push,q=D.slice,M=D.indexOf||function(e){var t=0,n=this.length;for(;n>t;t++)if(this[t]===e)return t;return-1},_="[\\x20\\t\\r\\n\\f]",F="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",O=F.replace("w","w#"),B="([*^$|!~]?=)",P="\\["+_+"*("+F+")"+_+"*(?:"+B+_+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+O+")|)|)"+_+"*\\]",R=":("+F+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+P.replace(3,8)+")*)|.*)\\)|)",W=RegExp("^"+_+"+|((?:^|[^\\\\])(?:\\\\.)*)"+_+"+$","g"),$=RegExp("^"+_+"*,"+_+"*"),I=RegExp("^"+_+"*([\\x20\\t\\r\\n\\f>+~])"+_+"*"),z=RegExp(R),X=RegExp("^"+O+"$"),U={ID:RegExp("^#("+F+")"),CLASS:RegExp("^\\.("+F+")"),NAME:RegExp("^\\[name=['\"]?("+F+")['\"]?\\]"),TAG:RegExp("^("+F.replace("w","w*")+")"),ATTR:RegExp("^"+P),PSEUDO:RegExp("^"+R),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+_+"*(even|odd|(([+-]|)(\\d*)n|)"+_+"*(?:([+-]|)"+_+"*(\\d+)|))"+_+"*\\)|)","i"),needsContext:RegExp("^"+_+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+_+"*((?:-\\d)?\\d*)"+_+"*\\)|)(?=[^-]|$)","i")},V=/[\x20\t\r\n\f]*[+~]/,Y=/^[^{]+\{\s*\[native code/,J=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,G=/^(?:input|select|textarea|button)$/i,Q=/^h\d$/i,K=/'|\\/g,Z=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,et=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,tt=function(e,t){var n="0x"+t-65536;return n!==n?t:0>n?String.fromCharCode(n+65536):String.fromCharCode(55296|n>>10,56320|1023&n)};try{q.call(w.documentElement.childNodes,0)[0].nodeType}catch(nt){q=function(e){var t,n=[];while(t=this[e++])n.push(t);return n}}function rt(e){return Y.test(e+"")}function it(){var e,t=[];return e=function(n,r){return t.push(n+=" ")>i.cacheLength&&delete e[t.shift()],e[n]=r}}function ot(e){return e[x]=!0,e}function at(e){var t=p.createElement("div");try{return e(t)}catch(n){return!1}finally{t=null}}function st(e,t,n,r){var i,o,a,s,u,l,f,g,m,v;if((t?t.ownerDocument||t:w)!==p&&c(t),t=t||p,n=n||[],!e||"string"!=typeof e)return n;if(1!==(s=t.nodeType)&&9!==s)return[];if(!d&&!r){if(i=J.exec(e))if(a=i[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return n;if(o.id===a)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&y(t,o)&&o.id===a)return n.push(o),n}else{if(i[2])return H.apply(n,q.call(t.getElementsByTagName(e),0)),n;if((a=i[3])&&T.getByClassName&&t.getElementsByClassName)return H.apply(n,q.call(t.getElementsByClassName(a),0)),n}if(T.qsa&&!h.test(e)){if(f=!0,g=x,m=t,v=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){l=ft(e),(f=t.getAttribute("id"))?g=f.replace(K,"\\$&"):t.setAttribute("id",g),g="[id='"+g+"'] ",u=l.length;while(u--)l[u]=g+dt(l[u]);m=V.test(e)&&t.parentNode||t,v=l.join(",")}if(v)try{return H.apply(n,q.call(m.querySelectorAll(v),0)),n}catch(b){}finally{f||t.removeAttribute("id")}}}return wt(e.replace(W,"$1"),t,n,r)}a=st.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},c=st.setDocument=function(e){var n=e?e.ownerDocument||e:w;return n!==p&&9===n.nodeType&&n.documentElement?(p=n,f=n.documentElement,d=a(n),T.tagNameNoComments=at(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),T.attributes=at(function(e){e.innerHTML="<select></select>";var t=typeof e.lastChild.getAttribute("multiple");return"boolean"!==t&&"string"!==t}),T.getByClassName=at(function(e){return e.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",e.getElementsByClassName&&e.getElementsByClassName("e").length?(e.lastChild.className="e",2===e.getElementsByClassName("e").length):!1}),T.getByName=at(function(e){e.id=x+0,e.innerHTML="<a name='"+x+"'></a><div name='"+x+"'></div>",f.insertBefore(e,f.firstChild);var t=n.getElementsByName&&n.getElementsByName(x).length===2+n.getElementsByName(x+0).length;return T.getIdNotName=!n.getElementById(x),f.removeChild(e),t}),i.attrHandle=at(function(e){return e.innerHTML="<a href='#'></a>",e.firstChild&&typeof e.firstChild.getAttribute!==A&&"#"===e.firstChild.getAttribute("href")})?{}:{href:function(e){return e.getAttribute("href",2)},type:function(e){return e.getAttribute("type")}},T.getIdNotName?(i.find.ID=function(e,t){if(typeof t.getElementById!==A&&!d){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){return e.getAttribute("id")===t}}):(i.find.ID=function(e,n){if(typeof n.getElementById!==A&&!d){var r=n.getElementById(e);return r?r.id===e||typeof r.getAttributeNode!==A&&r.getAttributeNode("id").value===e?[r]:t:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){var n=typeof e.getAttributeNode!==A&&e.getAttributeNode("id");return n&&n.value===t}}),i.find.TAG=T.tagNameNoComments?function(e,n){return typeof n.getElementsByTagName!==A?n.getElementsByTagName(e):t}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},i.find.NAME=T.getByName&&function(e,n){return typeof n.getElementsByName!==A?n.getElementsByName(name):t},i.find.CLASS=T.getByClassName&&function(e,n){return typeof n.getElementsByClassName===A||d?t:n.getElementsByClassName(e)},g=[],h=[":focus"],(T.qsa=rt(n.querySelectorAll))&&(at(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||h.push("\\["+_+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),e.querySelectorAll(":checked").length||h.push(":checked")}),at(function(e){e.innerHTML="<input type='hidden' i=''/>",e.querySelectorAll("[i^='']").length&&h.push("[*^$]="+_+"*(?:\"\"|'')"),e.querySelectorAll(":enabled").length||h.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),h.push(",.*:")})),(T.matchesSelector=rt(m=f.matchesSelector||f.mozMatchesSelector||f.webkitMatchesSelector||f.oMatchesSelector||f.msMatchesSelector))&&at(function(e){T.disconnectedMatch=m.call(e,"div"),m.call(e,"[s!='']:x"),g.push("!=",R)}),h=RegExp(h.join("|")),g=RegExp(g.join("|")),y=rt(f.contains)||f.compareDocumentPosition?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},v=f.compareDocumentPosition?function(e,t){var r;return e===t?(u=!0,0):(r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t))?1&r||e.parentNode&&11===e.parentNode.nodeType?e===n||y(w,e)?-1:t===n||y(w,t)?1:0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,i=0,o=e.parentNode,a=t.parentNode,s=[e],l=[t];if(e===t)return u=!0,0;if(!o||!a)return e===n?-1:t===n?1:o?-1:a?1:0;if(o===a)return ut(e,t);r=e;while(r=r.parentNode)s.unshift(r);r=t;while(r=r.parentNode)l.unshift(r);while(s[i]===l[i])i++;return i?ut(s[i],l[i]):s[i]===w?-1:l[i]===w?1:0},u=!1,[0,0].sort(v),T.detectDuplicates=u,p):p},st.matches=function(e,t){return st(e,null,null,t)},st.matchesSelector=function(e,t){if((e.ownerDocument||e)!==p&&c(e),t=t.replace(Z,"='$1']"),!(!T.matchesSelector||d||g&&g.test(t)||h.test(t)))try{var n=m.call(e,t);if(n||T.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(r){}return st(t,p,null,[e]).length>0},st.contains=function(e,t){return(e.ownerDocument||e)!==p&&c(e),y(e,t)},st.attr=function(e,t){var n;return(e.ownerDocument||e)!==p&&c(e),d||(t=t.toLowerCase()),(n=i.attrHandle[t])?n(e):d||T.attributes?e.getAttribute(t):((n=e.getAttributeNode(t))||e.getAttribute(t))&&e[t]===!0?t:n&&n.specified?n.value:null},st.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},st.uniqueSort=function(e){var t,n=[],r=1,i=0;if(u=!T.detectDuplicates,e.sort(v),u){for(;t=e[r];r++)t===e[r-1]&&(i=n.push(r));while(i--)e.splice(n[i],1)}return e};function ut(e,t){var n=t&&e,r=n&&(~t.sourceIndex||j)-(~e.sourceIndex||j);if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function lt(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function ct(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function pt(e){return ot(function(t){return t=+t,ot(function(n,r){var i,o=e([],n.length,t),a=o.length;while(a--)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}o=st.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r];r++)n+=o(t);return n},i=st.selectors={cacheLength:50,createPseudo:ot,match:U,find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(et,tt),e[3]=(e[4]||e[5]||"").replace(et,tt),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||st.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&st.error(e[0]),e},PSEUDO:function(e){var t,n=!e[5]&&e[2];return U.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:n&&z.test(n)&&(t=ft(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){return"*"===e?function(){return!0}:(e=e.replace(et,tt).toLowerCase(),function(t){return t.nodeName&&t.nodeName.toLowerCase()===e})},CLASS:function(e){var t=k[e+" "];return t||(t=RegExp("(^|"+_+")"+e+"("+_+"|$)"))&&k(e,function(e){return t.test(e.className||typeof e.getAttribute!==A&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=st.attr(r,e);return null==i?"!="===t:t?(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i+" ").indexOf(n)>-1:"|="===t?i===n||i.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,p,f,d,h,g=o!==a?"nextSibling":"previousSibling",m=t.parentNode,y=s&&t.nodeName.toLowerCase(),v=!u&&!s;if(m){if(o){while(g){p=t;while(p=p[g])if(s?p.nodeName.toLowerCase()===y:1===p.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?m.firstChild:m.lastChild],a&&v){c=m[x]||(m[x]={}),l=c[e]||[],d=l[0]===N&&l[1],f=l[0]===N&&l[2],p=d&&m.childNodes[d];while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if(1===p.nodeType&&++f&&p===t){c[e]=[N,d,f];break}}else if(v&&(l=(t[x]||(t[x]={}))[e])&&l[0]===N)f=l[1];else while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if((s?p.nodeName.toLowerCase()===y:1===p.nodeType)&&++f&&(v&&((p[x]||(p[x]={}))[e]=[N,f]),p===t))break;return f-=i,f===r||0===f%r&&f/r>=0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||st.error("unsupported pseudo: "+e);return r[x]?r(t):r.length>1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?ot(function(e,n){var i,o=r(e,t),a=o.length;while(a--)i=M.call(e,o[a]),e[i]=!(n[i]=o[a])}):function(e){return r(e,0,n)}):r}},pseudos:{not:ot(function(e){var t=[],n=[],r=s(e.replace(W,"$1"));return r[x]?ot(function(e,t,n,i){var o,a=r(e,null,i,[]),s=e.length;while(s--)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:ot(function(e){return function(t){return st(e,t).length>0}}),contains:ot(function(e){return function(t){return(t.textContent||t.innerText||o(t)).indexOf(e)>-1}}),lang:ot(function(e){return X.test(e||"")||st.error("unsupported lang: "+e),e=e.replace(et,tt).toLowerCase(),function(t){var n;do if(n=d?t.getAttribute("xml:lang")||t.getAttribute("lang"):t.lang)return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===f},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!i.pseudos.empty(e)},header:function(e){return Q.test(e.nodeName)},input:function(e){return G.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:pt(function(){return[0]}),last:pt(function(e,t){return[t-1]}),eq:pt(function(e,t,n){return[0>n?n+t:n]}),even:pt(function(e,t){var n=0;for(;t>n;n+=2)e.push(n);return e}),odd:pt(function(e,t){var n=1;for(;t>n;n+=2)e.push(n);return e}),lt:pt(function(e,t,n){var r=0>n?n+t:n;for(;--r>=0;)e.push(r);return e}),gt:pt(function(e,t,n){var r=0>n?n+t:n;for(;t>++r;)e.push(r);return e})}};for(n in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})i.pseudos[n]=lt(n);for(n in{submit:!0,reset:!0})i.pseudos[n]=ct(n);function ft(e,t){var n,r,o,a,s,u,l,c=E[e+" "];if(c)return t?0:c.slice(0);s=e,u=[],l=i.preFilter;while(s){(!n||(r=$.exec(s)))&&(r&&(s=s.slice(r[0].length)||s),u.push(o=[])),n=!1,(r=I.exec(s))&&(n=r.shift(),o.push({value:n,type:r[0].replace(W," ")}),s=s.slice(n.length));for(a in i.filter)!(r=U[a].exec(s))||l[a]&&!(r=l[a](r))||(n=r.shift(),o.push({value:n,type:a,matches:r}),s=s.slice(n.length));if(!n)break}return t?s.length:s?st.error(e):E(e,u).slice(0)}function dt(e){var t=0,n=e.length,r="";for(;n>t;t++)r+=e[t].value;return r}function ht(e,t,n){var i=t.dir,o=n&&"parentNode"===i,a=C++;return t.first?function(t,n,r){while(t=t[i])if(1===t.nodeType||o)return e(t,n,r)}:function(t,n,s){var u,l,c,p=N+" "+a;if(s){while(t=t[i])if((1===t.nodeType||o)&&e(t,n,s))return!0}else while(t=t[i])if(1===t.nodeType||o)if(c=t[x]||(t[x]={}),(l=c[i])&&l[0]===p){if((u=l[1])===!0||u===r)return u===!0}else if(l=c[i]=[p],l[1]=e(t,n,s)||r,l[1]===!0)return!0}}function gt(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function mt(e,t,n,r,i){var o,a=[],s=0,u=e.length,l=null!=t;for(;u>s;s++)(o=e[s])&&(!n||n(o,r,i))&&(a.push(o),l&&t.push(s));return a}function yt(e,t,n,r,i,o){return r&&!r[x]&&(r=yt(r)),i&&!i[x]&&(i=yt(i,o)),ot(function(o,a,s,u){var l,c,p,f=[],d=[],h=a.length,g=o||xt(t||"*",s.nodeType?[s]:s,[]),m=!e||!o&&t?g:mt(g,f,e,s,u),y=n?i||(o?e:h||r)?[]:a:m;if(n&&n(m,y,s,u),r){l=mt(y,d),r(l,[],s,u),c=l.length;while(c--)(p=l[c])&&(y[d[c]]=!(m[d[c]]=p))}if(o){if(i||e){if(i){l=[],c=y.length;while(c--)(p=y[c])&&l.push(m[c]=p);i(null,y=[],l,u)}c=y.length;while(c--)(p=y[c])&&(l=i?M.call(o,p):f[c])>-1&&(o[l]=!(a[l]=p))}}else y=mt(y===a?y.splice(h,y.length):y),i?i(null,a,y,u):H.apply(a,y)})}function vt(e){var t,n,r,o=e.length,a=i.relative[e[0].type],s=a||i.relative[" "],u=a?1:0,c=ht(function(e){return e===t},s,!0),p=ht(function(e){return M.call(t,e)>-1},s,!0),f=[function(e,n,r){return!a&&(r||n!==l)||((t=n).nodeType?c(e,n,r):p(e,n,r))}];for(;o>u;u++)if(n=i.relative[e[u].type])f=[ht(gt(f),n)];else{if(n=i.filter[e[u].type].apply(null,e[u].matches),n[x]){for(r=++u;o>r;r++)if(i.relative[e[r].type])break;return yt(u>1&&gt(f),u>1&&dt(e.slice(0,u-1)).replace(W,"$1"),n,r>u&&vt(e.slice(u,r)),o>r&&vt(e=e.slice(r)),o>r&&dt(e))}f.push(n)}return gt(f)}function bt(e,t){var n=0,o=t.length>0,a=e.length>0,s=function(s,u,c,f,d){var h,g,m,y=[],v=0,b="0",x=s&&[],w=null!=d,T=l,C=s||a&&i.find.TAG("*",d&&u.parentNode||u),k=N+=null==T?1:Math.random()||.1;for(w&&(l=u!==p&&u,r=n);null!=(h=C[b]);b++){if(a&&h){g=0;while(m=e[g++])if(m(h,u,c)){f.push(h);break}w&&(N=k,r=++n)}o&&((h=!m&&h)&&v--,s&&x.push(h))}if(v+=b,o&&b!==v){g=0;while(m=t[g++])m(x,y,u,c);if(s){if(v>0)while(b--)x[b]||y[b]||(y[b]=L.call(f));y=mt(y)}H.apply(f,y),w&&!s&&y.length>0&&v+t.length>1&&st.uniqueSort(f)}return w&&(N=k,l=T),x};return o?ot(s):s}s=st.compile=function(e,t){var n,r=[],i=[],o=S[e+" "];if(!o){t||(t=ft(e)),n=t.length;while(n--)o=vt(t[n]),o[x]?r.push(o):i.push(o);o=S(e,bt(i,r))}return o};function xt(e,t,n){var r=0,i=t.length;for(;i>r;r++)st(e,t[r],n);return n}function wt(e,t,n,r){var o,a,u,l,c,p=ft(e);if(!r&&1===p.length){if(a=p[0]=p[0].slice(0),a.length>2&&"ID"===(u=a[0]).type&&9===t.nodeType&&!d&&i.relative[a[1].type]){if(t=i.find.ID(u.matches[0].replace(et,tt),t)[0],!t)return n;e=e.slice(a.shift().value.length)}o=U.needsContext.test(e)?0:a.length;while(o--){if(u=a[o],i.relative[l=u.type])break;if((c=i.find[l])&&(r=c(u.matches[0].replace(et,tt),V.test(a[0].type)&&t.parentNode||t))){if(a.splice(o,1),e=r.length&&dt(a),!e)return H.apply(n,q.call(r,0)),n;break}}}return s(e,p)(r,t,d,n,V.test(e)),n}i.pseudos.nth=i.pseudos.eq;function Tt(){}i.filters=Tt.prototype=i.pseudos,i.setFilters=new Tt,c(),st.attr=b.attr,b.find=st,b.expr=st.selectors,b.expr[":"]=b.expr.pseudos,b.unique=st.uniqueSort,b.text=st.getText,b.isXMLDoc=st.isXML,b.contains=st.contains}(e);var at=/Until$/,st=/^(?:parents|prev(?:Until|All))/,ut=/^.[^:#\[\.,]*$/,lt=b.expr.match.needsContext,ct={children:!0,contents:!0,next:!0,prev:!0};b.fn.extend({find:function(e){var t,n,r,i=this.length;if("string"!=typeof e)return r=this,this.pushStack(b(e).filter(function(){for(t=0;i>t;t++)if(b.contains(r[t],this))return!0}));for(n=[],t=0;i>t;t++)b.find(e,this[t],n);return n=this.pushStack(i>1?b.unique(n):n),n.selector=(this.selector?this.selector+" ":"")+e,n},has:function(e){var t,n=b(e,this),r=n.length;return this.filter(function(){for(t=0;r>t;t++)if(b.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e,!1))},filter:function(e){return this.pushStack(ft(this,e,!0))},is:function(e){return!!e&&("string"==typeof e?lt.test(e)?b(e,this.context).index(this[0])>=0:b.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){var n,r=0,i=this.length,o=[],a=lt.test(e)||"string"!=typeof e?b(e,t||this.context):0;for(;i>r;r++){n=this[r];while(n&&n.ownerDocument&&n!==t&&11!==n.nodeType){if(a?a.index(n)>-1:b.find.matchesSelector(n,e)){o.push(n);break}n=n.parentNode}}return this.pushStack(o.length>1?b.unique(o):o)},index:function(e){return e?"string"==typeof e?b.inArray(this[0],b(e)):b.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var n="string"==typeof e?b(e,t):b.makeArray(e&&e.nodeType?[e]:e),r=b.merge(this.get(),n);return this.pushStack(b.unique(r))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),b.fn.andSelf=b.fn.addBack;function pt(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}b.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return b.dir(e,"parentNode")},parentsUntil:function(e,t,n){return b.dir(e,"parentNode",n)},next:function(e){return pt(e,"nextSibling")},prev:function(e){return pt(e,"previousSibling")},nextAll:function(e){return b.dir(e,"nextSibling")},prevAll:function(e){return b.dir(e,"previousSibling")},nextUntil:function(e,t,n){return b.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return b.dir(e,"previousSibling",n)},siblings:function(e){return b.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return b.sibling(e.firstChild)},contents:function(e){return b.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:b.merge([],e.childNodes)}},function(e,t){b.fn[e]=function(n,r){var i=b.map(this,t,n);return at.test(e)||(r=n),r&&"string"==typeof r&&(i=b.filter(r,i)),i=this.length>1&&!ct[e]?b.unique(i):i,this.length>1&&st.test(e)&&(i=i.reverse()),this.pushStack(i)}}),b.extend({filter:function(e,t,n){return n&&(e=":not("+e+")"),1===t.length?b.find.matchesSelector(t[0],e)?[t[0]]:[]:b.find.matches(e,t)},dir:function(e,n,r){var i=[],o=e[n];while(o&&9!==o.nodeType&&(r===t||1!==o.nodeType||!b(o).is(r)))1===o.nodeType&&i.push(o),o=o[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}});function ft(e,t,n){if(t=t||0,b.isFunction(t))return b.grep(e,function(e,r){var i=!!t.call(e,r,e);return i===n});if(t.nodeType)return b.grep(e,function(e){return e===t===n});if("string"==typeof t){var r=b.grep(e,function(e){return 1===e.nodeType});if(ut.test(t))return b.filter(t,r,!n);t=b.filter(t,r)}return b.grep(e,function(e){return b.inArray(e,t)>=0===n})}function dt(e){var t=ht.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}var ht="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gt=/ jQuery\d+="(?:null|\d+)"/g,mt=RegExp("<(?:"+ht+")[\\s/>]","i"),yt=/^\s+/,vt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bt=/<([\w:]+)/,xt=/<tbody/i,wt=/<|&#?\w+;/,Tt=/<(?:script|style|link)/i,Nt=/^(?:checkbox|radio)$/i,Ct=/checked\s*(?:[^=]|=\s*.checked.)/i,kt=/^$|\/(?:java|ecma)script/i,Et=/^true\/(.*)/,St=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,At={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:b.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},jt=dt(o),Dt=jt.appendChild(o.createElement("div"));At.optgroup=At.option,At.tbody=At.tfoot=At.colgroup=At.caption=At.thead,At.th=At.td,b.fn.extend({text:function(e){return b.access(this,function(e){return e===t?b.text(this):this.empty().append((this[0]&&this[0].ownerDocument||o).createTextNode(e))},null,e,arguments.length)},wrapAll:function(e){if(b.isFunction(e))return this.each(function(t){b(this).wrapAll(e.call(this,t))});if(this[0]){var t=b(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&&1===e.firstChild.nodeType)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return b.isFunction(e)?this.each(function(t){b(this).wrapInner(e.call(this,t))}):this.each(function(){var t=b(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=b.isFunction(e);return this.each(function(n){b(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){b.nodeName(this,"body")||b(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.appendChild(e)})},prepend:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.insertBefore(e,this.firstChild)})},before:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){var n,r=0;for(;null!=(n=this[r]);r++)(!e||b.filter(e,[n]).length>0)&&(t||1!==n.nodeType||b.cleanData(Ot(n)),n.parentNode&&(t&&b.contains(n.ownerDocument,n)&&Mt(Ot(n,"script")),n.parentNode.removeChild(n)));return this},empty:function(){var e,t=0;for(;null!=(e=this[t]);t++){1===e.nodeType&&b.cleanData(Ot(e,!1));while(e.firstChild)e.removeChild(e.firstChild);e.options&&b.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return b.clone(this,e,t)})},html:function(e){return b.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return 1===n.nodeType?n.innerHTML.replace(gt,""):t;if(!("string"!=typeof e||Tt.test(e)||!b.support.htmlSerialize&&mt.test(e)||!b.support.leadingWhitespace&&yt.test(e)||At[(bt.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(vt,"<$1></$2>");try{for(;i>r;r++)n=this[r]||{},1===n.nodeType&&(b.cleanData(Ot(n,!1)),n.innerHTML=e);n=0}catch(o){}}n&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(e){var t=b.isFunction(e);return t||"string"==typeof e||(e=b(e).not(this).detach()),this.domManip([e],!0,function(e){var t=this.nextSibling,n=this.parentNode;n&&(b(this).remove(),n.insertBefore(e,t))})},detach:function(e){return this.remove(e,!0)},domManip:function(e,n,r){e=f.apply([],e);var i,o,a,s,u,l,c=0,p=this.length,d=this,h=p-1,g=e[0],m=b.isFunction(g);if(m||!(1>=p||"string"!=typeof g||b.support.checkClone)&&Ct.test(g))return this.each(function(i){var o=d.eq(i);m&&(e[0]=g.call(this,i,n?o.html():t)),o.domManip(e,n,r)});if(p&&(l=b.buildFragment(e,this[0].ownerDocument,!1,this),i=l.firstChild,1===l.childNodes.length&&(l=i),i)){for(n=n&&b.nodeName(i,"tr"),s=b.map(Ot(l,"script"),Ht),a=s.length;p>c;c++)o=l,c!==h&&(o=b.clone(o,!0,!0),a&&b.merge(s,Ot(o,"script"))),r.call(n&&b.nodeName(this[c],"table")?Lt(this[c],"tbody"):this[c],o,c);if(a)for(u=s[s.length-1].ownerDocument,b.map(s,qt),c=0;a>c;c++)o=s[c],kt.test(o.type||"")&&!b._data(o,"globalEval")&&b.contains(u,o)&&(o.src?b.ajax({url:o.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):b.globalEval((o.text||o.textContent||o.innerHTML||"").replace(St,"")));l=i=null}return this}});function Lt(e,t){return e.getElementsByTagName(t)[0]||e.appendChild(e.ownerDocument.createElement(t))}function Ht(e){var t=e.getAttributeNode("type");return e.type=(t&&t.specified)+"/"+e.type,e}function qt(e){var t=Et.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function Mt(e,t){var n,r=0;for(;null!=(n=e[r]);r++)b._data(n,"globalEval",!t||b._data(t[r],"globalEval"))}function _t(e,t){if(1===t.nodeType&&b.hasData(e)){var n,r,i,o=b._data(e),a=b._data(t,o),s=o.events;if(s){delete a.handle,a.events={};for(n in s)for(r=0,i=s[n].length;i>r;r++)b.event.add(t,n,s[n][r])}a.data&&(a.data=b.extend({},a.data))}}function Ft(e,t){var n,r,i;if(1===t.nodeType){if(n=t.nodeName.toLowerCase(),!b.support.noCloneEvent&&t[b.expando]){i=b._data(t);for(r in i.events)b.removeEvent(t,r,i.handle);t.removeAttribute(b.expando)}"script"===n&&t.text!==e.text?(Ht(t).text=e.text,qt(t)):"object"===n?(t.parentNode&&(t.outerHTML=e.outerHTML),b.support.html5Clone&&e.innerHTML&&!b.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===n&&Nt.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===n?t.defaultSelected=t.selected=e.defaultSelected:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}}b.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){b.fn[e]=function(e){var n,r=0,i=[],o=b(e),a=o.length-1;for(;a>=r;r++)n=r===a?this:this.clone(!0),b(o[r])[t](n),d.apply(i,n.get());return this.pushStack(i)}});function Ot(e,n){var r,o,a=0,s=typeof e.getElementsByTagName!==i?e.getElementsByTagName(n||"*"):typeof e.querySelectorAll!==i?e.querySelectorAll(n||"*"):t;if(!s)for(s=[],r=e.childNodes||e;null!=(o=r[a]);a++)!n||b.nodeName(o,n)?s.push(o):b.merge(s,Ot(o,n));return n===t||n&&b.nodeName(e,n)?b.merge([e],s):s}function Bt(e){Nt.test(e.type)&&(e.defaultChecked=e.checked)}b.extend({clone:function(e,t,n){var r,i,o,a,s,u=b.contains(e.ownerDocument,e);if(b.support.html5Clone||b.isXMLDoc(e)||!mt.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(Dt.innerHTML=e.outerHTML,Dt.removeChild(o=Dt.firstChild)),!(b.support.noCloneEvent&&b.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||b.isXMLDoc(e)))for(r=Ot(o),s=Ot(e),a=0;null!=(i=s[a]);++a)r[a]&&Ft(i,r[a]);if(t)if(n)for(s=s||Ot(e),r=r||Ot(o),a=0;null!=(i=s[a]);a++)_t(i,r[a]);else _t(e,o);return r=Ot(o,"script"),r.length>0&&Mt(r,!u&&Ot(e,"script")),r=s=i=null,o},buildFragment:function(e,t,n,r){var i,o,a,s,u,l,c,p=e.length,f=dt(t),d=[],h=0;for(;p>h;h++)if(o=e[h],o||0===o)if("object"===b.type(o))b.merge(d,o.nodeType?[o]:o);else if(wt.test(o)){s=s||f.appendChild(t.createElement("div")),u=(bt.exec(o)||["",""])[1].toLowerCase(),c=At[u]||At._default,s.innerHTML=c[1]+o.replace(vt,"<$1></$2>")+c[2],i=c[0];while(i--)s=s.lastChild;if(!b.support.leadingWhitespace&&yt.test(o)&&d.push(t.createTextNode(yt.exec(o)[0])),!b.support.tbody){o="table"!==u||xt.test(o)?"<table>"!==c[1]||xt.test(o)?0:s:s.firstChild,i=o&&o.childNodes.length;while(i--)b.nodeName(l=o.childNodes[i],"tbody")&&!l.childNodes.length&&o.removeChild(l)
}b.merge(d,s.childNodes),s.textContent="";while(s.firstChild)s.removeChild(s.firstChild);s=f.lastChild}else d.push(t.createTextNode(o));s&&f.removeChild(s),b.support.appendChecked||b.grep(Ot(d,"input"),Bt),h=0;while(o=d[h++])if((!r||-1===b.inArray(o,r))&&(a=b.contains(o.ownerDocument,o),s=Ot(f.appendChild(o),"script"),a&&Mt(s),n)){i=0;while(o=s[i++])kt.test(o.type||"")&&n.push(o)}return s=null,f},cleanData:function(e,t){var n,r,o,a,s=0,u=b.expando,l=b.cache,p=b.support.deleteExpando,f=b.event.special;for(;null!=(n=e[s]);s++)if((t||b.acceptData(n))&&(o=n[u],a=o&&l[o])){if(a.events)for(r in a.events)f[r]?b.event.remove(n,r):b.removeEvent(n,r,a.handle);l[o]&&(delete l[o],p?delete n[u]:typeof n.removeAttribute!==i?n.removeAttribute(u):n[u]=null,c.push(o))}}});var Pt,Rt,Wt,$t=/alpha\([^)]*\)/i,It=/opacity\s*=\s*([^)]*)/,zt=/^(top|right|bottom|left)$/,Xt=/^(none|table(?!-c[ea]).+)/,Ut=/^margin/,Vt=RegExp("^("+x+")(.*)$","i"),Yt=RegExp("^("+x+")(?!px)[a-z%]+$","i"),Jt=RegExp("^([+-])=("+x+")","i"),Gt={BODY:"block"},Qt={position:"absolute",visibility:"hidden",display:"block"},Kt={letterSpacing:0,fontWeight:400},Zt=["Top","Right","Bottom","Left"],en=["Webkit","O","Moz","ms"];function tn(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=en.length;while(i--)if(t=en[i]+n,t in e)return t;return r}function nn(e,t){return e=t||e,"none"===b.css(e,"display")||!b.contains(e.ownerDocument,e)}function rn(e,t){var n,r,i,o=[],a=0,s=e.length;for(;s>a;a++)r=e[a],r.style&&(o[a]=b._data(r,"olddisplay"),n=r.style.display,t?(o[a]||"none"!==n||(r.style.display=""),""===r.style.display&&nn(r)&&(o[a]=b._data(r,"olddisplay",un(r.nodeName)))):o[a]||(i=nn(r),(n&&"none"!==n||!i)&&b._data(r,"olddisplay",i?n:b.css(r,"display"))));for(a=0;s>a;a++)r=e[a],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[a]||"":"none"));return e}b.fn.extend({css:function(e,n){return b.access(this,function(e,n,r){var i,o,a={},s=0;if(b.isArray(n)){for(o=Rt(e),i=n.length;i>s;s++)a[n[s]]=b.css(e,n[s],!1,o);return a}return r!==t?b.style(e,n,r):b.css(e,n)},e,n,arguments.length>1)},show:function(){return rn(this,!0)},hide:function(){return rn(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:nn(this))?b(this).show():b(this).hide()})}}),b.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Wt(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":b.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,u=b.camelCase(n),l=e.style;if(n=b.cssProps[u]||(b.cssProps[u]=tn(l,u)),s=b.cssHooks[n]||b.cssHooks[u],r===t)return s&&"get"in s&&(o=s.get(e,!1,i))!==t?o:l[n];if(a=typeof r,"string"===a&&(o=Jt.exec(r))&&(r=(o[1]+1)*o[2]+parseFloat(b.css(e,n)),a="number"),!(null==r||"number"===a&&isNaN(r)||("number"!==a||b.cssNumber[u]||(r+="px"),b.support.clearCloneStyle||""!==r||0!==n.indexOf("background")||(l[n]="inherit"),s&&"set"in s&&(r=s.set(e,r,i))===t)))try{l[n]=r}catch(c){}}},css:function(e,n,r,i){var o,a,s,u=b.camelCase(n);return n=b.cssProps[u]||(b.cssProps[u]=tn(e.style,u)),s=b.cssHooks[n]||b.cssHooks[u],s&&"get"in s&&(a=s.get(e,!0,r)),a===t&&(a=Wt(e,n,i)),"normal"===a&&n in Kt&&(a=Kt[n]),""===r||r?(o=parseFloat(a),r===!0||b.isNumeric(o)?o||0:a):a},swap:function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i}}),e.getComputedStyle?(Rt=function(t){return e.getComputedStyle(t,null)},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s.getPropertyValue(n)||s[n]:t,l=e.style;return s&&(""!==u||b.contains(e.ownerDocument,e)||(u=b.style(e,n)),Yt.test(u)&&Ut.test(n)&&(i=l.width,o=l.minWidth,a=l.maxWidth,l.minWidth=l.maxWidth=l.width=u,u=s.width,l.width=i,l.minWidth=o,l.maxWidth=a)),u}):o.documentElement.currentStyle&&(Rt=function(e){return e.currentStyle},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s[n]:t,l=e.style;return null==u&&l&&l[n]&&(u=l[n]),Yt.test(u)&&!zt.test(n)&&(i=l.left,o=e.runtimeStyle,a=o&&o.left,a&&(o.left=e.currentStyle.left),l.left="fontSize"===n?"1em":u,u=l.pixelLeft+"px",l.left=i,a&&(o.left=a)),""===u?"auto":u});function on(e,t,n){var r=Vt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function an(e,t,n,r,i){var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;for(;4>o;o+=2)"margin"===n&&(a+=b.css(e,n+Zt[o],!0,i)),r?("content"===n&&(a-=b.css(e,"padding"+Zt[o],!0,i)),"margin"!==n&&(a-=b.css(e,"border"+Zt[o]+"Width",!0,i))):(a+=b.css(e,"padding"+Zt[o],!0,i),"padding"!==n&&(a+=b.css(e,"border"+Zt[o]+"Width",!0,i)));return a}function sn(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=Rt(e),a=b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=Wt(e,t,o),(0>i||null==i)&&(i=e.style[t]),Yt.test(i))return i;r=a&&(b.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+an(e,t,n||(a?"border":"content"),r,o)+"px"}function un(e){var t=o,n=Gt[e];return n||(n=ln(e,t),"none"!==n&&n||(Pt=(Pt||b("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Pt[0].contentWindow||Pt[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),n=ln(e,t),Pt.detach()),Gt[e]=n),n}function ln(e,t){var n=b(t.createElement(e)).appendTo(t.body),r=b.css(n[0],"display");return n.remove(),r}b.each(["height","width"],function(e,n){b.cssHooks[n]={get:function(e,r,i){return r?0===e.offsetWidth&&Xt.test(b.css(e,"display"))?b.swap(e,Qt,function(){return sn(e,n,i)}):sn(e,n,i):t},set:function(e,t,r){var i=r&&Rt(e);return on(e,t,r?an(e,n,r,b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,i),i):0)}}}),b.support.opacity||(b.cssHooks.opacity={get:function(e,t){return It.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=b.isNumeric(t)?"alpha(opacity="+100*t+")":"",o=r&&r.filter||n.filter||"";n.zoom=1,(t>=1||""===t)&&""===b.trim(o.replace($t,""))&&n.removeAttribute&&(n.removeAttribute("filter"),""===t||r&&!r.filter)||(n.filter=$t.test(o)?o.replace($t,i):o+" "+i)}}),b(function(){b.support.reliableMarginRight||(b.cssHooks.marginRight={get:function(e,n){return n?b.swap(e,{display:"inline-block"},Wt,[e,"marginRight"]):t}}),!b.support.pixelPosition&&b.fn.position&&b.each(["top","left"],function(e,n){b.cssHooks[n]={get:function(e,r){return r?(r=Wt(e,n),Yt.test(r)?b(e).position()[n]+"px":r):t}}})}),b.expr&&b.expr.filters&&(b.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight||!b.support.reliableHiddenOffsets&&"none"===(e.style&&e.style.display||b.css(e,"display"))},b.expr.filters.visible=function(e){return!b.expr.filters.hidden(e)}),b.each({margin:"",padding:"",border:"Width"},function(e,t){b.cssHooks[e+t]={expand:function(n){var r=0,i={},o="string"==typeof n?n.split(" "):[n];for(;4>r;r++)i[e+Zt[r]+t]=o[r]||o[r-2]||o[0];return i}},Ut.test(e)||(b.cssHooks[e+t].set=on)});var cn=/%20/g,pn=/\[\]$/,fn=/\r?\n/g,dn=/^(?:submit|button|image|reset|file)$/i,hn=/^(?:input|select|textarea|keygen)/i;b.fn.extend({serialize:function(){return b.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=b.prop(this,"elements");return e?b.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!b(this).is(":disabled")&&hn.test(this.nodeName)&&!dn.test(e)&&(this.checked||!Nt.test(e))}).map(function(e,t){var n=b(this).val();return null==n?null:b.isArray(n)?b.map(n,function(e){return{name:t.name,value:e.replace(fn,"\r\n")}}):{name:t.name,value:n.replace(fn,"\r\n")}}).get()}}),b.param=function(e,n){var r,i=[],o=function(e,t){t=b.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(n===t&&(n=b.ajaxSettings&&b.ajaxSettings.traditional),b.isArray(e)||e.jquery&&!b.isPlainObject(e))b.each(e,function(){o(this.name,this.value)});else for(r in e)gn(r,e[r],n,o);return i.join("&").replace(cn,"+")};function gn(e,t,n,r){var i;if(b.isArray(t))b.each(t,function(t,i){n||pn.test(e)?r(e,i):gn(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==b.type(t))r(e,t);else for(i in t)gn(e+"["+i+"]",t[i],n,r)}b.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){b.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),b.fn.hover=function(e,t){return this.mouseenter(e).mouseleave(t||e)};var mn,yn,vn=b.now(),bn=/\?/,xn=/#.*$/,wn=/([?&])_=[^&]*/,Tn=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Nn=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Cn=/^(?:GET|HEAD)$/,kn=/^\/\//,En=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,Sn=b.fn.load,An={},jn={},Dn="*/".concat("*");try{yn=a.href}catch(Ln){yn=o.createElement("a"),yn.href="",yn=yn.href}mn=En.exec(yn.toLowerCase())||[];function Hn(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(w)||[];if(b.isFunction(n))while(r=o[i++])"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function qn(e,n,r,i){var o={},a=e===jn;function s(u){var l;return o[u]=!0,b.each(e[u]||[],function(e,u){var c=u(n,r,i);return"string"!=typeof c||a||o[c]?a?!(l=c):t:(n.dataTypes.unshift(c),s(c),!1)}),l}return s(n.dataTypes[0])||!o["*"]&&s("*")}function Mn(e,n){var r,i,o=b.ajaxSettings.flatOptions||{};for(i in n)n[i]!==t&&((o[i]?e:r||(r={}))[i]=n[i]);return r&&b.extend(!0,e,r),e}b.fn.load=function(e,n,r){if("string"!=typeof e&&Sn)return Sn.apply(this,arguments);var i,o,a,s=this,u=e.indexOf(" ");return u>=0&&(i=e.slice(u,e.length),e=e.slice(0,u)),b.isFunction(n)?(r=n,n=t):n&&"object"==typeof n&&(a="POST"),s.length>0&&b.ajax({url:e,type:a,dataType:"html",data:n}).done(function(e){o=arguments,s.html(i?b("<div>").append(b.parseHTML(e)).find(i):e)}).complete(r&&function(e,t){s.each(r,o||[e.responseText,t,e])}),this},b.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){b.fn[t]=function(e){return this.on(t,e)}}),b.each(["get","post"],function(e,n){b[n]=function(e,r,i,o){return b.isFunction(r)&&(o=o||i,i=r,r=t),b.ajax({url:e,type:n,dataType:o,data:r,success:i})}}),b.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:yn,type:"GET",isLocal:Nn.test(mn[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Dn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":e.String,"text html":!0,"text json":b.parseJSON,"text xml":b.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Mn(Mn(e,b.ajaxSettings),t):Mn(b.ajaxSettings,e)},ajaxPrefilter:Hn(An),ajaxTransport:Hn(jn),ajax:function(e,n){"object"==typeof e&&(n=e,e=t),n=n||{};var r,i,o,a,s,u,l,c,p=b.ajaxSetup({},n),f=p.context||p,d=p.context&&(f.nodeType||f.jquery)?b(f):b.event,h=b.Deferred(),g=b.Callbacks("once memory"),m=p.statusCode||{},y={},v={},x=0,T="canceled",N={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!c){c={};while(t=Tn.exec(a))c[t[1].toLowerCase()]=t[2]}t=c[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?a:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return x||(e=v[n]=v[n]||e,y[e]=t),this},overrideMimeType:function(e){return x||(p.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>x)for(t in e)m[t]=[m[t],e[t]];else N.always(e[N.status]);return this},abort:function(e){var t=e||T;return l&&l.abort(t),k(0,t),this}};if(h.promise(N).complete=g.add,N.success=N.done,N.error=N.fail,p.url=((e||p.url||yn)+"").replace(xn,"").replace(kn,mn[1]+"//"),p.type=n.method||n.type||p.method||p.type,p.dataTypes=b.trim(p.dataType||"*").toLowerCase().match(w)||[""],null==p.crossDomain&&(r=En.exec(p.url.toLowerCase()),p.crossDomain=!(!r||r[1]===mn[1]&&r[2]===mn[2]&&(r[3]||("http:"===r[1]?80:443))==(mn[3]||("http:"===mn[1]?80:443)))),p.data&&p.processData&&"string"!=typeof p.data&&(p.data=b.param(p.data,p.traditional)),qn(An,p,n,N),2===x)return N;u=p.global,u&&0===b.active++&&b.event.trigger("ajaxStart"),p.type=p.type.toUpperCase(),p.hasContent=!Cn.test(p.type),o=p.url,p.hasContent||(p.data&&(o=p.url+=(bn.test(o)?"&":"?")+p.data,delete p.data),p.cache===!1&&(p.url=wn.test(o)?o.replace(wn,"$1_="+vn++):o+(bn.test(o)?"&":"?")+"_="+vn++)),p.ifModified&&(b.lastModified[o]&&N.setRequestHeader("If-Modified-Since",b.lastModified[o]),b.etag[o]&&N.setRequestHeader("If-None-Match",b.etag[o])),(p.data&&p.hasContent&&p.contentType!==!1||n.contentType)&&N.setRequestHeader("Content-Type",p.contentType),N.setRequestHeader("Accept",p.dataTypes[0]&&p.accepts[p.dataTypes[0]]?p.accepts[p.dataTypes[0]]+("*"!==p.dataTypes[0]?", "+Dn+"; q=0.01":""):p.accepts["*"]);for(i in p.headers)N.setRequestHeader(i,p.headers[i]);if(p.beforeSend&&(p.beforeSend.call(f,N,p)===!1||2===x))return N.abort();T="abort";for(i in{success:1,error:1,complete:1})N[i](p[i]);if(l=qn(jn,p,n,N)){N.readyState=1,u&&d.trigger("ajaxSend",[N,p]),p.async&&p.timeout>0&&(s=setTimeout(function(){N.abort("timeout")},p.timeout));try{x=1,l.send(y,k)}catch(C){if(!(2>x))throw C;k(-1,C)}}else k(-1,"No Transport");function k(e,n,r,i){var c,y,v,w,T,C=n;2!==x&&(x=2,s&&clearTimeout(s),l=t,a=i||"",N.readyState=e>0?4:0,r&&(w=_n(p,N,r)),e>=200&&300>e||304===e?(p.ifModified&&(T=N.getResponseHeader("Last-Modified"),T&&(b.lastModified[o]=T),T=N.getResponseHeader("etag"),T&&(b.etag[o]=T)),204===e?(c=!0,C="nocontent"):304===e?(c=!0,C="notmodified"):(c=Fn(p,w),C=c.state,y=c.data,v=c.error,c=!v)):(v=C,(e||!C)&&(C="error",0>e&&(e=0))),N.status=e,N.statusText=(n||C)+"",c?h.resolveWith(f,[y,C,N]):h.rejectWith(f,[N,C,v]),N.statusCode(m),m=t,u&&d.trigger(c?"ajaxSuccess":"ajaxError",[N,p,c?y:v]),g.fireWith(f,[N,C]),u&&(d.trigger("ajaxComplete",[N,p]),--b.active||b.event.trigger("ajaxStop")))}return N},getScript:function(e,n){return b.get(e,t,n,"script")},getJSON:function(e,t,n){return b.get(e,t,n,"json")}});function _n(e,n,r){var i,o,a,s,u=e.contents,l=e.dataTypes,c=e.responseFields;for(s in c)s in r&&(n[c[s]]=r[s]);while("*"===l[0])l.shift(),o===t&&(o=e.mimeType||n.getResponseHeader("Content-Type"));if(o)for(s in u)if(u[s]&&u[s].test(o)){l.unshift(s);break}if(l[0]in r)a=l[0];else{for(s in r){if(!l[0]||e.converters[s+" "+l[0]]){a=s;break}i||(i=s)}a=a||i}return a?(a!==l[0]&&l.unshift(a),r[a]):t}function Fn(e,t){var n,r,i,o,a={},s=0,u=e.dataTypes.slice(),l=u[0];if(e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u[1])for(i in e.converters)a[i.toLowerCase()]=e.converters[i];for(;r=u[++s];)if("*"!==r){if("*"!==l&&l!==r){if(i=a[l+" "+r]||a["* "+r],!i)for(n in a)if(o=n.split(" "),o[1]===r&&(i=a[l+" "+o[0]]||a["* "+o[0]])){i===!0?i=a[n]:a[n]!==!0&&(r=o[0],u.splice(s--,0,r));break}if(i!==!0)if(i&&e["throws"])t=i(t);else try{t=i(t)}catch(c){return{state:"parsererror",error:i?c:"No conversion from "+l+" to "+r}}}l=r}return{state:"success",data:t}}b.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return b.globalEval(e),e}}}),b.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),b.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=o.head||b("head")[0]||o.documentElement;return{send:function(t,i){n=o.createElement("script"),n.async=!0,e.scriptCharset&&(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,t){(t||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),n=null,t||i(200,"success"))},r.insertBefore(n,r.firstChild)},abort:function(){n&&n.onload(t,!0)}}}});var On=[],Bn=/(=)\?(?=&|$)|\?\?/;b.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=On.pop()||b.expando+"_"+vn++;return this[e]=!0,e}}),b.ajaxPrefilter("json jsonp",function(n,r,i){var o,a,s,u=n.jsonp!==!1&&(Bn.test(n.url)?"url":"string"==typeof n.data&&!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&&Bn.test(n.data)&&"data");return u||"jsonp"===n.dataTypes[0]?(o=n.jsonpCallback=b.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,u?n[u]=n[u].replace(Bn,"$1"+o):n.jsonp!==!1&&(n.url+=(bn.test(n.url)?"&":"?")+n.jsonp+"="+o),n.converters["script json"]=function(){return s||b.error(o+" was not called"),s[0]},n.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},i.always(function(){e[o]=a,n[o]&&(n.jsonpCallback=r.jsonpCallback,On.push(o)),s&&b.isFunction(a)&&a(s[0]),s=a=t}),"script"):t});var Pn,Rn,Wn=0,$n=e.ActiveXObject&&function(){var e;for(e in Pn)Pn[e](t,!0)};function In(){try{return new e.XMLHttpRequest}catch(t){}}function zn(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}b.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&In()||zn()}:In,Rn=b.ajaxSettings.xhr(),b.support.cors=!!Rn&&"withCredentials"in Rn,Rn=b.support.ajax=!!Rn,Rn&&b.ajaxTransport(function(n){if(!n.crossDomain||b.support.cors){var r;return{send:function(i,o){var a,s,u=n.xhr();if(n.username?u.open(n.type,n.url,n.async,n.username,n.password):u.open(n.type,n.url,n.async),n.xhrFields)for(s in n.xhrFields)u[s]=n.xhrFields[s];n.mimeType&&u.overrideMimeType&&u.overrideMimeType(n.mimeType),n.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");try{for(s in i)u.setRequestHeader(s,i[s])}catch(l){}u.send(n.hasContent&&n.data||null),r=function(e,i){var s,l,c,p;try{if(r&&(i||4===u.readyState))if(r=t,a&&(u.onreadystatechange=b.noop,$n&&delete Pn[a]),i)4!==u.readyState&&u.abort();else{p={},s=u.status,l=u.getAllResponseHeaders(),"string"==typeof u.responseText&&(p.text=u.responseText);try{c=u.statusText}catch(f){c=""}s||!n.isLocal||n.crossDomain?1223===s&&(s=204):s=p.text?200:404}}catch(d){i||o(-1,d)}p&&o(s,c,p,l)},n.async?4===u.readyState?setTimeout(r):(a=++Wn,$n&&(Pn||(Pn={},b(e).unload($n)),Pn[a]=r),u.onreadystatechange=r):r()},abort:function(){r&&r(t,!0)}}}});var Xn,Un,Vn=/^(?:toggle|show|hide)$/,Yn=RegExp("^(?:([+-])=|)("+x+")([a-z%]*)$","i"),Jn=/queueHooks$/,Gn=[nr],Qn={"*":[function(e,t){var n,r,i=this.createTween(e,t),o=Yn.exec(t),a=i.cur(),s=+a||0,u=1,l=20;if(o){if(n=+o[2],r=o[3]||(b.cssNumber[e]?"":"px"),"px"!==r&&s){s=b.css(i.elem,e,!0)||n||1;do u=u||".5",s/=u,b.style(i.elem,e,s+r);while(u!==(u=i.cur()/a)&&1!==u&&--l)}i.unit=r,i.start=s,i.end=o[1]?s+(o[1]+1)*n:n}return i}]};function Kn(){return setTimeout(function(){Xn=t}),Xn=b.now()}function Zn(e,t){b.each(t,function(t,n){var r=(Qn[t]||[]).concat(Qn["*"]),i=0,o=r.length;for(;o>i;i++)if(r[i].call(e,t,n))return})}function er(e,t,n){var r,i,o=0,a=Gn.length,s=b.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;var t=Xn||Kn(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,o=1-r,a=0,u=l.tweens.length;for(;u>a;a++)l.tweens[a].run(o);return s.notifyWith(e,[l,o,n]),1>o&&u?n:(s.resolveWith(e,[l]),!1)},l=s.promise({elem:e,props:b.extend({},t),opts:b.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Xn||Kn(),duration:n.duration,tweens:[],createTween:function(t,n){var r=b.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)l.tweens[n].run(1);return t?s.resolveWith(e,[l,t]):s.rejectWith(e,[l,t]),this}}),c=l.props;for(tr(c,l.opts.specialEasing);a>o;o++)if(r=Gn[o].call(l,e,c,l.opts))return r;return Zn(l,c),b.isFunction(l.opts.start)&&l.opts.start.call(e,l),b.fx.timer(b.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function tr(e,t){var n,r,i,o,a;for(i in e)if(r=b.camelCase(i),o=t[r],n=e[i],b.isArray(n)&&(o=n[1],n=e[i]=n[0]),i!==r&&(e[r]=n,delete e[i]),a=b.cssHooks[r],a&&"expand"in a){n=a.expand(n),delete e[r];for(i in n)i in e||(e[i]=n[i],t[i]=o)}else t[r]=o}b.Animation=b.extend(er,{tweener:function(e,t){b.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;i>r;r++)n=e[r],Qn[n]=Qn[n]||[],Qn[n].unshift(t)},prefilter:function(e,t){t?Gn.unshift(e):Gn.push(e)}});function nr(e,t,n){var r,i,o,a,s,u,l,c,p,f=this,d=e.style,h={},g=[],m=e.nodeType&&nn(e);n.queue||(c=b._queueHooks(e,"fx"),null==c.unqueued&&(c.unqueued=0,p=c.empty.fire,c.empty.fire=function(){c.unqueued||p()}),c.unqueued++,f.always(function(){f.always(function(){c.unqueued--,b.queue(e,"fx").length||c.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[d.overflow,d.overflowX,d.overflowY],"inline"===b.css(e,"display")&&"none"===b.css(e,"float")&&(b.support.inlineBlockNeedsLayout&&"inline"!==un(e.nodeName)?d.zoom=1:d.display="inline-block")),n.overflow&&(d.overflow="hidden",b.support.shrinkWrapBlocks||f.always(function(){d.overflow=n.overflow[0],d.overflowX=n.overflow[1],d.overflowY=n.overflow[2]}));for(i in t)if(a=t[i],Vn.exec(a)){if(delete t[i],u=u||"toggle"===a,a===(m?"hide":"show"))continue;g.push(i)}if(o=g.length){s=b._data(e,"fxshow")||b._data(e,"fxshow",{}),"hidden"in s&&(m=s.hidden),u&&(s.hidden=!m),m?b(e).show():f.done(function(){b(e).hide()}),f.done(function(){var t;b._removeData(e,"fxshow");for(t in h)b.style(e,t,h[t])});for(i=0;o>i;i++)r=g[i],l=f.createTween(r,m?s[r]:0),h[r]=s[r]||b.style(e,r),r in s||(s[r]=l.start,m&&(l.end=l.start,l.start="width"===r||"height"===r?1:0))}}function rr(e,t,n,r,i){return new rr.prototype.init(e,t,n,r,i)}b.Tween=rr,rr.prototype={constructor:rr,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(b.cssNumber[n]?"":"px")},cur:function(){var e=rr.propHooks[this.prop];return e&&e.get?e.get(this):rr.propHooks._default.get(this)},run:function(e){var t,n=rr.propHooks[this.prop];return this.pos=t=this.options.duration?b.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):rr.propHooks._default.set(this),this}},rr.prototype.init.prototype=rr.prototype,rr.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=b.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){b.fx.step[e.prop]?b.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[b.cssProps[e.prop]]||b.cssHooks[e.prop])?b.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},rr.propHooks.scrollTop=rr.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},b.each(["toggle","show","hide"],function(e,t){var n=b.fn[t];b.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(ir(t,!0),e,r,i)}}),b.fn.extend({fadeTo:function(e,t,n,r){return this.filter(nn).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=b.isEmptyObject(e),o=b.speed(t,n,r),a=function(){var t=er(this,b.extend({},e),o);a.finish=function(){t.stop(!0)},(i||b._data(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=n,n=e,e=t),n&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,n=null!=e&&e+"queueHooks",o=b.timers,a=b._data(this);if(n)a[n]&&a[n].stop&&i(a[n]);else for(n in a)a[n]&&a[n].stop&&Jn.test(n)&&i(a[n]);for(n=o.length;n--;)o[n].elem!==this||null!=e&&o[n].queue!==e||(o[n].anim.stop(r),t=!1,o.splice(n,1));(t||!r)&&b.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=b._data(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=b.timers,a=r?r.length:0;for(n.finish=!0,b.queue(this,e,[]),i&&i.cur&&i.cur.finish&&i.cur.finish.call(this),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}});function ir(e,t){var n,r={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)n=Zt[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}b.each({slideDown:ir("show"),slideUp:ir("hide"),slideToggle:ir("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){b.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),b.speed=function(e,t,n){var r=e&&"object"==typeof e?b.extend({},e):{complete:n||!n&&t||b.isFunction(e)&&e,duration:e,easing:n&&t||t&&!b.isFunction(t)&&t};return r.duration=b.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in b.fx.speeds?b.fx.speeds[r.duration]:b.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){b.isFunction(r.old)&&r.old.call(this),r.queue&&b.dequeue(this,r.queue)},r},b.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},b.timers=[],b.fx=rr.prototype.init,b.fx.tick=function(){var e,n=b.timers,r=0;for(Xn=b.now();n.length>r;r++)e=n[r],e()||n[r]!==e||n.splice(r--,1);n.length||b.fx.stop(),Xn=t},b.fx.timer=function(e){e()&&b.timers.push(e)&&b.fx.start()},b.fx.interval=13,b.fx.start=function(){Un||(Un=setInterval(b.fx.tick,b.fx.interval))},b.fx.stop=function(){clearInterval(Un),Un=null},b.fx.speeds={slow:600,fast:200,_default:400},b.fx.step={},b.expr&&b.expr.filters&&(b.expr.filters.animated=function(e){return b.grep(b.timers,function(t){return e===t.elem}).length}),b.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){b.offset.setOffset(this,e,t)});var n,r,o={top:0,left:0},a=this[0],s=a&&a.ownerDocument;if(s)return n=s.documentElement,b.contains(n,a)?(typeof a.getBoundingClientRect!==i&&(o=a.getBoundingClientRect()),r=or(s),{top:o.top+(r.pageYOffset||n.scrollTop)-(n.clientTop||0),left:o.left+(r.pageXOffset||n.scrollLeft)-(n.clientLeft||0)}):o},b.offset={setOffset:function(e,t,n){var r=b.css(e,"position");"static"===r&&(e.style.position="relative");var i=b(e),o=i.offset(),a=b.css(e,"top"),s=b.css(e,"left"),u=("absolute"===r||"fixed"===r)&&b.inArray("auto",[a,s])>-1,l={},c={},p,f;u?(c=i.position(),p=c.top,f=c.left):(p=parseFloat(a)||0,f=parseFloat(s)||0),b.isFunction(t)&&(t=t.call(e,n,o)),null!=t.top&&(l.top=t.top-o.top+p),null!=t.left&&(l.left=t.left-o.left+f),"using"in t?t.using.call(e,l):i.css(l)}},b.fn.extend({position:function(){if(this[0]){var e,t,n={top:0,left:0},r=this[0];return"fixed"===b.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),b.nodeName(e[0],"html")||(n=e.offset()),n.top+=b.css(e[0],"borderTopWidth",!0),n.left+=b.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-b.css(r,"marginTop",!0),left:t.left-n.left-b.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||o.documentElement;while(e&&!b.nodeName(e,"html")&&"static"===b.css(e,"position"))e=e.offsetParent;return e||o.documentElement})}}),b.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);b.fn[e]=function(i){return b.access(this,function(e,i,o){var a=or(e);return o===t?a?n in a?a[n]:a.document.documentElement[i]:e[i]:(a?a.scrollTo(r?b(a).scrollLeft():o,r?o:b(a).scrollTop()):e[i]=o,t)},e,i,arguments.length,null)}});function or(e){return b.isWindow(e)?e:9===e.nodeType?e.defaultView||e.parentWindow:!1}b.each({Height:"height",Width:"width"},function(e,n){b.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){b.fn[i]=function(i,o){var a=arguments.length&&(r||"boolean"!=typeof i),s=r||(i===!0||o===!0?"margin":"border");return b.access(this,function(n,r,i){var o;return b.isWindow(n)?n.document.documentElement["client"+e]:9===n.nodeType?(o=n.documentElement,Math.max(n.body["scroll"+e],o["scroll"+e],n.body["offset"+e],o["offset"+e],o["client"+e])):i===t?b.css(n,r,s):b.style(n,r,i,s)},n,a?i:t,a,null)}})}),e.jQuery=e.$=b,"function"==typeof define&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return b})})(window);
//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);

//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
